<turbo-frame id="console-turbo-frame">


  <style>
    .loading-text {
      animation: loading 1.2s 1s linear infinite;
      font-size: 20px;
      line-height: 1em;
      color: white;
      text-align: center;

      i::before {
        content: '.';
        opacity: 0;
        animation: loading 0.3s linear infinite alternate;
      }

      i:nth-of-type(1)::before {
        animation-delay: 0s;
      }

      i:nth-of-type(2)::before {
        animation-delay: 0.3s;
      }

      i:nth-of-type(3)::before {
        animation-delay: 0.6s;
      }
    }

    @keyframes loading {
      0% {
        opacity: 0;
      }

      100% {
        opacity: 1;
      }
    }

    .hero .console {
      position: absolute;
      right: 0;
      bottom: 0;
      /* 控制台宽高 */
      width: 1350px;

      /* transform: scale(0.9); */
      display: flex;
      justify-content: flex-end;
      align-items: flex-end;
      /* background-color: gray; */
      /* box-sizing: border-box;
      border: 1px solid black; */
    }

    /* #region 提示信息 */

    .hero .info {
      position: absolute;
      right: calc(675px * 0.7);
      bottom: calc(500px * 0.7);
      width: calc(1094px * 0.7);
      color: white;
      font-size: calc(22px * 0.7);
      line-height: 1.2em;
      pointer-events: none;
      opacity: 0;
    }

    .hero .info p {
      height: 1em;
    }

    .hero .info.active {
      opacity: 1;
    }

    /* #endregion */

    /*  #region控制台提示信息 */
    .hero .console-info {
      position: absolute;
      right: calc(278px * 0.7);
      bottom: calc(270px * 0.7);
      width: calc(515px * 0.7);
      color: white;
      font-size: calc(22px * 0.7);
      line-height: 1.2em;
      ;
      background-color: #0d1b26;
      border: 2px solid #d2c075;
      border-radius: 5px;
      line-break: anywhere;
      padding: 10px;
      opacity: 1;
      visibility: hidden;
    }

    .hero .console-info p {
      min-height: 16px;
      /* word-wrap: break-word; */
    }

    .hero .console-info p:first-child {
      margin-bottom: 8px;
    }

    .hero .console-info.active {
      opacity: 1;
    }

    /* #endregion */

    /* #region物品栏 */
    .hero .console-item {
      width: calc(153px * .7);
      display: flex;
      flex-wrap: wrap;
      align-content: flex-end;
      justify-content: center;
      padding-bottom: 1px;
      /* background-color: red; */
    }

    .hero .console-item div[class^="console-item"] {
      width: calc(63px * .7);
      height: calc(61px * .7);
      /* background-color: #ccffff; */
      margin: 1px 2px;
    }

    .hero .console-item div[class^="console-item-"]:hover .console-info {
      visibility: visible;
    }

    /* #endregion */

    /* #region技能栏 */
    .hero .console-ability {
      width: calc(350px * 0.7);
      display: flex;
      flex-wrap: wrap;
      margin-right: calc(258px * 0.7);
      margin-bottom: 3px;
      justify-content: flex-end;
      align-content: flex-end;
      box-sizing: border-box;
      /* border: 1px solid green; */
      /* background-color: blue; */
    }

    .hero .console-ability div[class^="console-ability-"] {
      width: 55px;
      height: 52px;
      /* background-color: #ccffff; */
      /* margin: 1px; */
      /* border: 1px solid red; */
      box-sizing: border-box;
      padding: 1px 1px;
    }

    .hero .console-ability div[class="console-ability-1"] {
      padding-top: 2px;
    }

    .hero .console-ability div[class^="console-ability-"]:hover .console-info {
      visibility: visible;
    }

    .hero .console .console-ability a:before {
      content: '';
      display: block;
      height: 100%;
    }

    /* #endregion */

    /* #region 英雄基础面板 */

    .console-head {
      width: 106px;
      height: 140px;
      /* background-color: yellowgreen; */
      text-align: center;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      align-items: center;
    }

    .console-head .head-img {
      width: 95px;
      height: 95px;
      border-top-left-radius: 72px 45px;
      border-top-right-radius: 72px 45px;
    }

    .console-head .head-text {
      font-size: 12px;
      line-height: 17px;
      white-space: nowrap;
      user-select: none;
    }

    .console-head .head-text .left-text {
      text-align: right;
    }

    .console-head .head-text .split-text {
      display: inline-block;
      padding: 0 5px;
    }

    .console-head .head-text .right-text {
      text-align: left;
    }

    .console-head .head-text .red {
      color: red;
    }

    .console-head .head-text .blue {
      color: blue;
    }


    .console-base {
      width: 264px;
      height: 136px;
      padding: 0 15px;
      box-sizing: border-box;
      user-select: none;
      /* background-color: yellowgreen; */
    }

    .console-base .hero-propsname {
      color: white;
      font-size: 16px;
      text-align: center;
    }

    .console-base .hero-level-name {
      color: white;
      font-size: 12px;
      line-height: 1.5em;
      height: 1.5em;
      text-align: center;
      border: 1px solid orange;
      border-radius: 5px;
      transform: scale(0.96);
    }

    .hero-base {}

    .hero-prop {
      width: 110px;
      line-height: 1em;
      margin-bottom: -3px;
    }

    .hero-prop::nth-child(3) {
      margin-top: 5px;
    }

    .hero-prop-img {
      width: 35px;
      height: 35px;
      display: inline-block;
      vertical-align: middle;
      margin: 2px;
    }

    .hero-prop-text {
      width: 50px;
      font-size: 12px;
      display: inline-block;
      vertical-align: top;
      color: whitesmoke;
      white-space: nowrap;
      margin-left: -6px;
      transform: scale(0.95);
    }

    .hero-prop:first-child .hero-prop-img,
    .hero-prop:first-child .hero-prop-text {
      vertical-align: middle;
    }

    .hero-prop:not(:first-child) .hero-prop-text {
      padding-top: 5px;
    }

    .hero-prop-text p:nth-child(2n+3) {
      padding-top: 5px;
    }

    .hero-prop-text .green {
      color: green;
    }

    .hero-prop-text span[class]::before,
    .hero-status span[class]::before {
      content: '';
      display: inline-block;
      width: 5px;
    }

    .hero-status {
      color: whitesmoke;
      font-size: 12px;
    }

    .hero-prop:hover .console-info {
      visibility: visible;
    }

    /* #endregion */
  </style>
  <div class="info">
  </div>
  <div class="console-head">
    <!-- <div class="head-img" style="background: url('/bilibili/hero/headimg.png') no-repeat center center / cover;">
    </div>
    <div class="head-text">
      <p class="red"><span class="left-text">744</span><span class="split-text">/</span><span
          class="right-text">744</span></p>
      <p class="blue"><span class="left-text">456</span><span class="split-text">/</span><span
          class="right-text">456</span></p>
    </div> -->
  </div>
  <div class="console-base">
    <!-- <p class="hero-propsname">￥</p>
    <p class="hero-level-name"><span>等级 1 </span><span class="name">红翼天使</span></p>
    <div class="hero-base clearfix">
      <div class="hero-prop rightfix">
        <div class="hero-prop-img" style="background: url('/bilibili/hero/agi.png') no-repeat center center/contain;">
        </div>
        <div class="hero-prop-text">
          <p class="orange">力量：</p>
          <p><span class="white">32</span><span class="green"></span></p>
          <p class="orange">敏捷：</p>
          <p><span class="white">21</span><span class="green"></span></p>
          <p class="orange">智力：</p>
          <p><span class="white">14</span><span class="green"></span></p>
        </div>
      </div>
      <div class="hero-prop leftfix">
        <div class="hero-prop-img"
          style="background: url('/bilibili/hero/attack.png') no-repeat center center/contain;"></div>
        <div class="hero-prop-text">
          <p class="orange">攻击力：</p>
          <p><span class="white">81 - 103</span><span class="green"></span></p>
        </div>
      </div>
      <div class="hero-prop leftfix">
        <div class="hero-prop-img" style="background: url('/bilibili/hero/def.png') no-repeat center center/contain;">
          <div class="console-info">
          </div>
        </div>
        <div class="hero-prop-text">
          <p class="orange">护甲：</p>
          <p><span class="white">7</span><span class="green"></span></p>
        </div>
      </div>
    </div>
    <div class="hero-status">状态：</div> -->
  </div>
  <div class="console-item">
    <div class="console-item-1">
      <!-- <div class="console-info">
        <p><span style="color:#ccffff">类型：</span><span style="color:#ffcc99">物理伤害、分身<span></p>
          <p><span style="color:#ccffff">属性：</span><span style="color:#ffcc99">攻击力</span></p>
          <br>
          <p><span style="color:#ccffff">红翼天使在附近敌人身上创造</span><span style="color:#ffce00">分身</span><span style="color:#ccffff">进行攻击，分身拥有本体</span><span style="color:#ffce00">78%攻击力，</span><span style="color:#ccffff">额外</span><span style="color:#ffce00">60%攻击速度，</span><span style="color:#ccffff">且无法控制，但也不会受到伤害。最多制造</span><span style="color:#ffcc00">2个</span><span style="color:#ccffff">分身</span></p>
          <p><span style="color:#ffce00">持续5秒<span></p>
      </div> -->
    </div>
    <div class="console-item-2">
    </div>
    <div class="console-item-3">
    </div>
    <div class="console-item-4">
    </div>
    <div class="console-item-5">
    </div>
    <div class="console-item-6">
    </div>
  </div>
  <div class="console-ability">
    <div class="console-ability-1">
    </div>
    <div class="console-ability-2">
    </div>
    <div class="console-ability-3">
    </div>
    <div class="console-ability-4">
    </div>
    <div class="console-ability-5">
    </div>
    <div class="console-ability-6">
    </div>
    <div class="console-ability-7">
    </div>
    <div class="console-ability-8">
    </div>
    <div class="console-ability-9">
    </div>
    <div class="console-ability-10">
    </div>
    <div class="console-ability-11">
    </div>
    <div class="console-ability-12">
    </div>
  </div>
  <script>
    (function () {
      // 获取URL中的锚点
      const hash = window._self.type;
      if (hash === "#mp") {
        var datajs = "/mp/mp-data.js"
        var dataImg = "/mp/mp-imgs"
        var data = mpdata
        var skin = mpskin
      } else {
        var datajs = "/x7/x7-data.js"
        var dataImg = "/x7/x7-imgs"
        var data = x7data
        var skin = x7skin
      }
      class Dom {
        constructor() {
          this.hero = document.querySelector(".hero")
          this.heroul = document.querySelector(".hero ul")
          this.consoleAbility = document.querySelector(".hero .console .console-ability")
          this.consoleItem = document.querySelector(".hero .console .console-item")
          this.consoleBase = document.querySelector(".hero .console .console-base")
          this.consoleHead = document.querySelector(".hero .console .console-head")
        }
        get info() {
          return document.querySelector(".hero .info")
        }
      }
      var dom = new Dom()

      console.log("加载完成" + window._self.dataHeroId)
      console.log(data[window._self.dataHeroId])
      const hero = data[window._self.dataHeroId]

      // 计算英雄头像位置
      function calc(){
        for (let i = 0; i < skin.heroArr.length; i++) {
          for (let j = 0; j < skin.heroArr[i].length; j++) {
            if (skin.heroArr[i][j] === hero.baseUnitId) {
              console.log("定位头像位置：", { i, j })
              skin.i = i
              skin.j = j
              return;
            }
          }
        }
      }
      calc()

      // 英雄介绍
      if (hero.intro !== null && hero.intro !== undefined) {
        dom.info.innerHTML = formatHtmlString(hero.intro)
        dom.info.classList.add('active')
      }

      // 技能
      addPifu(dom.consoleAbility.children[0], hero.p1, hero.unitId, hero.p1, hero.p2, 0, 0)
      addPifu(dom.consoleAbility.children[1], hero.p2, hero.unitId, hero.p1, hero.p2, 1, 0)
      // 梦的第2排技能
      addAbility(dom.consoleAbility.children[4], hero.core, hero.unitId, hero.p1, hero.p2, 0, 1)
      addAbility(dom.consoleAbility.children[5], hero.d2, hero.unitId, hero.p1, hero.p2, 1, 1)
      addAbility(dom.consoleAbility.children[7], hero.t2, hero.unitId, hero.p1, hero.p2, 3, 1)

      // x7的第2排技能
      addAbility(dom.consoleAbility.children[6], hero.t, hero.unitId, hero.p1, hero.p2, 2, 1)
      addAbility(dom.consoleAbility.children[7], hero.d, hero.unitId, hero.p1, hero.p2, 3, 1)

      addAbility(dom.consoleAbility.children[8], hero.q, hero.unitId, hero.p1, hero.p2, 0, 2)
      addAbility(dom.consoleAbility.children[9], hero.w, hero.unitId, hero.p1, hero.p2, 1, 2)
      addAbility(dom.consoleAbility.children[10], hero.e, hero.unitId, hero.p1, hero.p2, 2, 2)
      addAbility(dom.consoleAbility.children[11], hero.r, hero.unitId, hero.p1, hero.p2, 3, 2)

      // 物品
      if (hero.items != null) {
        for (let i = 0; i < hero.items.length; i++) {
          addAbility(dom.consoleItem.children[i], hero.items[i], hero.unitId, hero.p1, hero.p2, i%2+4, Math.floor(i/2), 0.68)
        }
      }

      // 面板
      // "prop":"2,68,25,38",
      // "attack":"262 - 383,140,1.6",
      // "armor":"15,320",
      handlePanel(hero)
      handleHead(hero)
      function addAbility(ele, viewData, unitId, p1, p2, i , j, rate) {
        if (viewData) {
          ele.innerHTML += `<div class="console-info">${formatHtmlString(viewData.desc)}</div>`
          loadImg(ele, `${skin["heroPanelImg"]}`, (ele, src) => {
            ele.style = skin.calcAbility(unitId, p1, p2, i,j,rate)
          })
        }
      }
      function addPifu(ele, viewData, unitId, p1, p2, i , j) {
        if (viewData) {
          ele.innerHTML += `<a href="/bilibili/hero/hero-console.html" data-hero-id="${viewData.unitId}" data-turbo-frame="console-turbo-frame"></a><div class="console-info">${formatHtmlString(viewData.desc)}</div>`
          loadImg(ele, `${skin["heroPanelImg"]}`, (ele, src) => {
            ele.style = skin.calcAbility(unitId, p1, p2, i,j)
          })
        }
      }

      function loadImg(outer, src, callback) {
        const img = new Image()
        img.src = src
        var loadingText = document.createElement('div')
        loadingText.className = 'loading-text'
        loadingText.innerHTML = "<i></i><i></i><i></i>"
        outer.insertBefore(loadingText, outer.firstChild)
        img.onload = function () {
          console.log("图片加载完成移除loading-text")
          callback(outer, src)
          loadingText.remove()
        }
        img.onerror = function () {
          img.onerror = null
          img.onload = null
          loadingText.innerText = "图片加载失败"
          console.log('图片加载失败')
        }
      }

      function formatHtmlString(desc) {
        let strs = desc.split("|n")
        var obj = {
          str: '',
          buf: '',
          lastColor: '|cfffff'
        }
        for (const p of strs) {
          obj.str = p
          obj = handle(obj)
        }
        return obj.buf
      }


      function handle({ str, buf, lastColor }) {

        str = str.replaceAll("/\|r\|cff/gi", "|cff")
        str = str.replaceAll("|r", "|cfffff")
        str = str.replaceAll("|R", "|cfffff")

        if (!str.startsWith("|cff")) {
          str = lastColor + str
        }

        buf += "<p>"

        const pat = /(\|cff(\w{3,6}))(.*?)(?=((\|cff)|$))/gi
        const mat = str.matchAll(pat)
        for (const match of mat) {
          lastColor = match[1]
          const color = match[2]
          const text = match[3]
          buf += `<span style="color:#${color}">${text}</span>`
        }

        buf += "</p>"
        return { str, buf, lastColor }
      }

      function handlePanel({ prop, attack, armor, name, propernames }) {
        if (prop === null || prop === undefined) {
          return
        }

        const propArr = prop.split(",")
        const attackArr = attack.split(",")
        const armorArr = armor.split(",")

        console.log("1234", attackArr)
        const propIcon = skin["InfoPanelIconHeroIcon" + propArr[0]]
        const attackIcon = skin["InfoPanelIconDamage" + attackArr[0].substring(0, 1).toUpperCase() + attackArr[0].substring(1)]
        const armorIcon = skin["InfoPanelIconArmor" + armorArr[0].substring(0, 1).toUpperCase() + armorArr[0].substring(1)]

        propernames = formatHtmlString(propernames)
        const infopanel_level_class = formatHtmlString(skin["INFOPANEL_LEVEL_CLASS"].replace("%u", 1).replace("%s", name))
        const primary_attribute = formatHtmlString(skin["PRIMARY_ATTRIBUTE"])
        const colon_damage = formatHtmlString(skin["COLON_DAMAGE"])
        const colon_armor = formatHtmlString(skin["COLON_ARMOR"])
        const colon_hero_attributes = formatHtmlString(skin["COLON_HERO_ATTRIBUTES"])
        const colon_strength = formatHtmlString(skin["COLON_STRENGTH"])
        const colon_agility = formatHtmlString(skin["COLON_AGILITY"])
        const colon_intellect = formatHtmlString(skin["COLON_INTELLECT"])
        const colon_status = formatHtmlString(skin["COLON_STATUS"])

        // 拼接攻击护甲属性等描述字符串
        const propInfoDesc = `${skin["COLON_HERO_ATTRIBUTES"]}|n${skin["COLON_STRENGTH"]}|n${propArr[0] === '0' ? skin["PRIMARY_ATTRIBUTE"] : ""}${skin["str"]}|n${skin["COLON_AGILITY"]}|n ${propArr[0] === '1' ? skin["PRIMARY_ATTRIBUTE"] : ""}${skin["agi"]}|n${skin["COLON_INTELLECT"]}|n${propArr[0] === '2' ? skin["PRIMARY_ATTRIBUTE"] : ""}${skin["int"]}`
        const propInfo = formatHtmlString(propInfoDesc)
        const attackInfoDesc = `${skin["COLON_DAMAGE"]} ${attackArr[1]}|n${skin["DAMAGE_" + attackArr[0].toUpperCase()]}|r|n范围： ${attackArr[2]}|n速度： |cff00ff00${((100 + propArr[2] / 5) / (100 * attackArr[3])).toFixed(3)}/sec|r|n攻击间隔： |cff00ff00${attackArr[3]} |r|n|n${skin["DAMAGETIP_" + attackArr[0].toUpperCase()]}`
        const attackInfo = formatHtmlString(attackInfoDesc)
        const defInfoDesc = `${skin["COLON_ARMOR"]} ${armorArr[1]}|n${skin["ARMOR_" + armorArr[0].toUpperCase()]}|r|n伤害减少：${((armorArr[1] * skin["DefenseArmor"]) * 100 / (1 + armorArr[1] * skin["DefenseArmor"])).toFixed(0)}%|r|n移动速度：${armorArr[2]}|r|n视野：${skin["view"]}|r|n|n${skin["ARMORTIP_" + armorArr[0].toUpperCase()]}`
        const defInfo = formatHtmlString(defInfoDesc)
        let panelHtml = `
        <div class="hero-propsname">${propernames}</div>
        <div class="hero-level-name">${infopanel_level_class}</div>
        <div class="hero-base clearfix">
          <div class="hero-prop rightfix">
            <div class="hero-prop-img" style="${skin.calcProp(propArr[0])}">
              <div class="console-info">
                ${propInfo}
              </div>
            </div>
            <div class="hero-prop-text">
              <div>${colon_strength}</div>
              <div><span class="white">${propArr[1]}</span><span class="green"></span></div>
              <div>${colon_agility}</div>
              <div><span class="white">${propArr[2]}</span><span class="green"></span></div>
              <div>${colon_intellect}</div>
              <div><span class="white">${propArr[3]}</span><span class="green"></span></div>
            </div>
          </div>
          <div class="hero-prop leftfix">
            <div class="hero-prop-img"
              style="${skin.calcAttack(attackArr[0])}">
              <div class="console-info">
                ${attackInfo}
              </div>
            </div>
            <div class="hero-prop-text">
              <div>${colon_damage}</div>
              <div><span class="white">${attackArr[1]}</span><span class="green"></span></div>
            </div>
          </div>
          <div class="hero-prop leftfix">
            <div class="hero-prop-img" style="${skin.calcDef(armorArr[0])}">
              <div class="console-info">
                ${defInfo}
              </div>
            </div>
            <div class="hero-prop-text">
              <div>${colon_armor}</div>
              <div><span class="white">${armorArr[1]}</span><span class="green"></span></div>
            </div>
          </div>
        </div>
        <div class="hero-status">${colon_status}</div>
        `
        dom.consoleBase.innerHTML = panelHtml
      }

      function handleHead({ hp, baseUnitId, unitId, p1, p2 }) {
        if (hp === null || hp === undefined) {
          return
        }

        console.log("设置头像", { hp, baseUnitId, unitId, p1, p2 })
        const hpArr = hp.split(",")
        const html = `
          <div class="head-img" style = "${skin.calcHead(unitId, p1, p2)}" >
          </div >
          <div class="head-text">
            <p class="red"><span class="left-text">${hpArr[0]}</span><span class="split-text">/</span><span
              class="right-text">${hpArr[0]}</span></p>
            <p class="blue"><span class="left-text">${hpArr[1]}</span><span class="split-text">/</span><span
              class="right-text">${hpArr[1]}</span></p>
          </div>
        `
        console.log({ hp, baseUnitId, unitId, p1, p2 })
        dom.consoleHead.innerHTML = html
      }
    })()

  </script>

</turbo-frame>