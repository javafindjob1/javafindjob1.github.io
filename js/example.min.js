/*!
 * The MIT License (MIT)
 *
 * Copyright (c) 2013-2021 Chananya Freiman
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy of
 * this software and associated documentation files (the "Software"), to deal in
 * the Software without restriction, including without limitation the rights to
 * use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of
 * the Software, and to permit persons to whom the Software is furnished to do so,
 * subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS
 * FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR
 * COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER
 * IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
 * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 *
 */(()=>{var t={7:t=>{"use strict";var e,n="object"==typeof Reflect?Reflect:null,i=n&&"function"==typeof n.apply?n.apply:function(t,e,n){return Function.prototype.apply.call(t,e,n)};e=n&&"function"==typeof n.ownKeys?n.ownKeys:Object.getOwnPropertySymbols?function(t){return Object.getOwnPropertyNames(t).concat(Object.getOwnPropertySymbols(t))}:function(t){return Object.getOwnPropertyNames(t)};var r=Number.isNaN||function(t){return t!=t};function s(){s.init.call(this)}t.exports=s,t.exports.once=function(t,e){return new Promise((function(n,i){function r(n){t.removeListener(e,s),i(n)}function s(){"function"==typeof t.removeListener&&t.removeListener("error",r),n([].slice.call(arguments))}m(t,e,s,{once:!0}),"error"!==e&&function(t,e,n){"function"==typeof t.on&&m(t,"error",e,n)}(t,r,{once:!0})}))},s.EventEmitter=s,s.prototype._events=void 0,s.prototype._eventsCount=0,s.prototype._maxListeners=void 0;var a=10;function o(t){if("function"!=typeof t)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t)}function l(t){return void 0===t._maxListeners?s.defaultMaxListeners:t._maxListeners}function h(t,e,n,i){var r,s,a,h;if(o(n),void 0===(s=t._events)?(s=t._events=Object.create(null),t._eventsCount=0):(void 0!==s.newListener&&(t.emit("newListener",e,n.listener?n.listener:n),s=t._events),a=s[e]),void 0===a)a=s[e]=n,++t._eventsCount;else if("function"==typeof a?a=s[e]=i?[n,a]:[a,n]:i?a.unshift(n):a.push(n),(r=l(t))>0&&a.length>r&&!a.warned){a.warned=!0;var u=new Error("Possible EventEmitter memory leak detected. "+a.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");u.name="MaxListenersExceededWarning",u.emitter=t,u.type=e,u.count=a.length,h=u,console&&console.warn&&console.warn(h)}return t}function u(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function c(t,e,n){var i={fired:!1,wrapFn:void 0,target:t,type:e,listener:n},r=u.bind(i);return r.listener=n,i.wrapFn=r,r}function d(t,e,n){var i=t._events;if(void 0===i)return[];var r=i[e];return void 0===r?[]:"function"==typeof r?n?[r.listener||r]:[r]:n?function(t){for(var e=new Array(t.length),n=0;n<e.length;++n)e[n]=t[n].listener||t[n];return e}(r):p(r,r.length)}function f(t){var e=this._events;if(void 0!==e){var n=e[t];if("function"==typeof n)return 1;if(void 0!==n)return n.length}return 0}function p(t,e){for(var n=new Array(e),i=0;i<e;++i)n[i]=t[i];return n}function m(t,e,n,i){if("function"==typeof t.on)i.once?t.once(e,n):t.on(e,n);else{if("function"!=typeof t.addEventListener)throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof t);t.addEventListener(e,(function r(s){i.once&&t.removeEventListener(e,r),n(s)}))}}Object.defineProperty(s,"defaultMaxListeners",{enumerable:!0,get:function(){return a},set:function(t){if("number"!=typeof t||t<0||r(t))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+t+".");a=t}}),s.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},s.prototype.setMaxListeners=function(t){if("number"!=typeof t||t<0||r(t))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+t+".");return this._maxListeners=t,this},s.prototype.getMaxListeners=function(){return l(this)},s.prototype.emit=function(t){for(var e=[],n=1;n<arguments.length;n++)e.push(arguments[n]);var r="error"===t,s=this._events;if(void 0!==s)r=r&&void 0===s.error;else if(!r)return!1;if(r){var a;if(e.length>0&&(a=e[0]),a instanceof Error)throw a;var o=new Error("Unhandled error."+(a?" ("+a.message+")":""));throw o.context=a,o}var l=s[t];if(void 0===l)return!1;if("function"==typeof l)i(l,this,e);else{var h=l.length,u=p(l,h);for(n=0;n<h;++n)i(u[n],this,e)}return!0},s.prototype.addListener=function(t,e){return h(this,t,e,!1)},s.prototype.on=s.prototype.addListener,s.prototype.prependListener=function(t,e){return h(this,t,e,!0)},s.prototype.once=function(t,e){return o(e),this.on(t,c(this,t,e)),this},s.prototype.prependOnceListener=function(t,e){return o(e),this.prependListener(t,c(this,t,e)),this},s.prototype.removeListener=function(t,e){var n,i,r,s,a;if(o(e),void 0===(i=this._events))return this;if(void 0===(n=i[t]))return this;if(n===e||n.listener===e)0==--this._eventsCount?this._events=Object.create(null):(delete i[t],i.removeListener&&this.emit("removeListener",t,n.listener||e));else if("function"!=typeof n){for(r=-1,s=n.length-1;s>=0;s--)if(n[s]===e||n[s].listener===e){a=n[s].listener,r=s;break}if(r<0)return this;0===r?n.shift():function(t,e){for(;e+1<t.length;e++)t[e]=t[e+1];t.pop()}(n,r),1===n.length&&(i[t]=n[0]),void 0!==i.removeListener&&this.emit("removeListener",t,a||e)}return this},s.prototype.off=s.prototype.removeListener,s.prototype.removeAllListeners=function(t){var e,n,i;if(void 0===(n=this._events))return this;if(void 0===n.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==n[t]&&(0==--this._eventsCount?this._events=Object.create(null):delete n[t]),this;if(0===arguments.length){var r,s=Object.keys(n);for(i=0;i<s.length;++i)"removeListener"!==(r=s[i])&&this.removeAllListeners(r);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(e=n[t]))this.removeListener(t,e);else if(void 0!==e)for(i=e.length-1;i>=0;i--)this.removeListener(t,e[i]);return this},s.prototype.listeners=function(t){return d(this,t,!0)},s.prototype.rawListeners=function(t){return d(this,t,!1)},s.listenerCount=function(t,e){return"function"==typeof t.listenerCount?t.listenerCount(e):f.call(t,e)},s.prototype.listenerCount=f,s.prototype.eventNames=function(){return this._eventsCount>0?e(this._events):[]}},696:(t,e,n)=>{"use strict";let i,r,s;if(i="function"==typeof Uint8Array.from?Uint8Array.from.bind(Uint8Array):function(t){let e=0,n=t.length,i=new Uint8Array(n);for(;n>e;)i[e]=t[e++];return i},"function"==typeof(new Uint8Array).indexOf)r=function(t,e,n){return t.indexOf(e,n)};else{let t=[].indexOf;if(0!==t.call(new Uint8Array(1),0))throw Error("missing .indexOf");r=function(e,n,i){return t.call(e,n,i)}}s="function"==typeof Uint8Array.of?Uint8Array.of.bind(Uint8Array):function(){return i(arguments)};const a=function(t){return t instanceof Uint8Array},o="cannot convert invalid utf8 to javascript string",l=";,/?:@&=+$abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789,-_.!~*'()#".split("").reduce((function(t,e){return t[e.charCodeAt(0)]=!0,t}),{}),h={},u=function(t,e){if("string"!=typeof t)throw new TypeError("to_luastring expects a javascript string");if(e){let e=h[t];if(a(e))return e}let n=t.length,r=Array(n),s=0;for(let e=0;e<n;++e){let i=t.charCodeAt(e);if(i<=127)r[s++]=i;else if(i<=2047)r[s++]=192|i>>6,r[s++]=128|63&i;else{if(i>=55296&&i<=56319&&e+1<n){let n=t.charCodeAt(e+1);n>=56320&&n<=57343&&(e++,i=1024*(i-55296)+n+9216)}i<=65535?(r[s++]=224|i>>12,r[s++]=128|i>>6&63,r[s++]=128|63&i):(r[s++]=240|i>>18,r[s++]=128|i>>12&63,r[s++]=128|i>>6&63,r[s++]=128|63&i)}}return r=i(r),e&&(h[t]=r),r};t.exports.luastring_from=i,t.exports.luastring_indexOf=r,t.exports.luastring_of=s,t.exports.is_luastring=a,t.exports.luastring_eq=function(t,e){if(t!==e){let n=t.length;if(n!==e.length)return!1;for(let i=0;i<n;i++)if(t[i]!==e[i])return!1}return!0},t.exports.to_jsstring=function(t,e,n,i){if(!a(t))throw new TypeError("to_jsstring expects a Uint8Array");n=void 0===n?t.length:Math.min(t.length,n);let r="";for(let s=void 0!==e?e:0;s<n;){let e=t[s++];if(e<128)r+=String.fromCharCode(e);else if(e<194||e>244){if(!i)throw RangeError(o);r+="ï¿½"}else if(e<=223){if(s>=n){if(!i)throw RangeError(o);r+="ï¿½";continue}let a=t[s++];if(128!=(192&a)){if(!i)throw RangeError(o);r+="ï¿½";continue}r+=String.fromCharCode(((31&e)<<6)+(63&a))}else if(e<=239){if(s+1>=n){if(!i)throw RangeError(o);r+="ï¿½";continue}let a=t[s++];if(128!=(192&a)){if(!i)throw RangeError(o);r+="ï¿½";continue}let l=t[s++];if(128!=(192&l)){if(!i)throw RangeError(o);r+="ï¿½";continue}let h=((15&e)<<12)+((63&a)<<6)+(63&l);if(h<=65535)r+=String.fromCharCode(h);else{h-=65536;let t=55296+(h>>10),e=h%1024+56320;r+=String.fromCharCode(t,e)}}else{if(s+2>=n){if(!i)throw RangeError(o);r+="ï¿½";continue}let a=t[s++];if(128!=(192&a)){if(!i)throw RangeError(o);r+="ï¿½";continue}let l=t[s++];if(128!=(192&l)){if(!i)throw RangeError(o);r+="ï¿½";continue}let h=t[s++];if(128!=(192&h)){if(!i)throw RangeError(o);r+="ï¿½";continue}let u=((7&e)<<18)+((63&a)<<12)+((63&l)<<6)+(63&h);u-=65536;let c=55296+(u>>10),d=u%1024+56320;r+=String.fromCharCode(c,d)}}return r},t.exports.to_uristring=function(t){if(!a(t))throw new TypeError("to_uristring expects a Uint8Array");let e="";for(let n=0;n<t.length;n++){let i=t[n];l[i]?e+=String.fromCharCode(i):e+="%"+(i<16?"0":"")+i.toString(16)}return e},t.exports.to_luastring=u,t.exports.from_userstring=function(t){if(!a(t)){if("string"!=typeof t)throw new TypeError("expects an array of bytes or javascript string");t=u(t)}return t};const c=u("Lua"),d="Lua 5.3",f=d+".4",p=f+"  Copyright (C) 1994-2017 Lua.org, PUC-Rio";t.exports.LUA_SIGNATURE=c,t.exports.LUA_VERSION_MAJOR="5",t.exports.LUA_VERSION_MINOR="3",t.exports.LUA_VERSION_NUM=503,t.exports.LUA_VERSION_RELEASE="4",t.exports.LUA_VERSION=d,t.exports.LUA_RELEASE=f,t.exports.LUA_COPYRIGHT=p,t.exports.LUA_AUTHORS="R. Ierusalimschy, L. H. de Figueiredo, W. Celes";const m={LUA_TNONE:-1,LUA_TNIL:0,LUA_TBOOLEAN:1,LUA_TLIGHTUSERDATA:2,LUA_TNUMBER:3,LUA_TSTRING:4,LUA_TTABLE:5,LUA_TFUNCTION:6,LUA_TUSERDATA:7,LUA_TTHREAD:8,LUA_NUMTAGS:9};m.LUA_TSHRSTR=0|m.LUA_TSTRING,m.LUA_TLNGSTR=16|m.LUA_TSTRING,m.LUA_TNUMFLT=0|m.LUA_TNUMBER,m.LUA_TNUMINT=16|m.LUA_TNUMBER,m.LUA_TLCL=0|m.LUA_TFUNCTION,m.LUA_TLCF=16|m.LUA_TFUNCTION,m.LUA_TCCL=32|m.LUA_TFUNCTION;const{LUAI_MAXSTACK:_}=n(254),g=-_-1e3;t.exports.LUA_HOOKCALL=0,t.exports.LUA_HOOKCOUNT=3,t.exports.LUA_HOOKLINE=2,t.exports.LUA_HOOKRET=1,t.exports.LUA_HOOKTAILCALL=4,t.exports.LUA_MASKCALL=1,t.exports.LUA_MASKCOUNT=8,t.exports.LUA_MASKLINE=4,t.exports.LUA_MASKRET=2,t.exports.LUA_MINSTACK=20,t.exports.LUA_MULTRET=-1,t.exports.LUA_OPADD=0,t.exports.LUA_OPBAND=7,t.exports.LUA_OPBNOT=13,t.exports.LUA_OPBOR=8,t.exports.LUA_OPBXOR=9,t.exports.LUA_OPDIV=5,t.exports.LUA_OPEQ=0,t.exports.LUA_OPIDIV=6,t.exports.LUA_OPLE=2,t.exports.LUA_OPLT=1,t.exports.LUA_OPMOD=3,t.exports.LUA_OPMUL=2,t.exports.LUA_OPPOW=4,t.exports.LUA_OPSHL=10,t.exports.LUA_OPSHR=11,t.exports.LUA_OPSUB=1,t.exports.LUA_OPUNM=12,t.exports.LUA_REGISTRYINDEX=g,t.exports.LUA_RIDX_GLOBALS=2,t.exports.LUA_RIDX_LAST=2,t.exports.LUA_RIDX_MAINTHREAD=1,t.exports.constant_types=m,t.exports.lua_Debug=class{constructor(){this.event=NaN,this.name=null,this.namewhat=null,this.what=null,this.source=null,this.currentline=NaN,this.linedefined=NaN,this.lastlinedefined=NaN,this.nups=NaN,this.nparams=NaN,this.isvararg=NaN,this.istailcall=NaN,this.short_src=null,this.i_ci=null}},t.exports.lua_upvalueindex=function(t){return g-t},t.exports.thread_status={LUA_OK:0,LUA_YIELD:1,LUA_ERRRUN:2,LUA_ERRSYNTAX:3,LUA_ERRMEM:4,LUA_ERRGCMM:5,LUA_ERRERR:6}},125:(t,e,n)=>{const i=n(696),r="Fengari 0.1",s=r+".4",a="B. Giannangeli, Daurnimator",o=s+"  Copyright (C) 2017-2018 "+a+"\nBased on: "+i.LUA_COPYRIGHT;t.exports.FENGARI_AUTHORS=a,t.exports.FENGARI_COPYRIGHT=o,t.exports.FENGARI_RELEASE=s,t.exports.FENGARI_VERSION=r,t.exports.FENGARI_VERSION_MAJOR="0",t.exports.FENGARI_VERSION_MINOR="1",t.exports.FENGARI_VERSION_NUM=1,t.exports.FENGARI_VERSION_RELEASE="4",t.exports.is_luastring=i.is_luastring,t.exports.luastring_eq=i.luastring_eq,t.exports.luastring_from=i.luastring_from,t.exports.luastring_indexOf=i.luastring_indexOf,t.exports.luastring_of=i.luastring_of,t.exports.to_jsstring=i.to_jsstring,t.exports.to_luastring=i.to_luastring,t.exports.to_uristring=i.to_uristring,t.exports.from_userstring=i.from_userstring},660:(t,e,n)=>{"use strict";const{LUA_MULTRET:i,LUA_OPBNOT:r,LUA_OPEQ:s,LUA_OPLE:a,LUA_OPLT:o,LUA_OPUNM:l,LUA_REGISTRYINDEX:h,LUA_RIDX_GLOBALS:u,LUA_VERSION_NUM:c,constant_types:{LUA_NUMTAGS:d,LUA_TBOOLEAN:f,LUA_TCCL:p,LUA_TFUNCTION:m,LUA_TLCF:_,LUA_TLCL:g,LUA_TLIGHTUSERDATA:v,LUA_TLNGSTR:b,LUA_TNIL:w,LUA_TNONE:A,LUA_TNUMFLT:y,LUA_TNUMINT:x,LUA_TSHRSTR:T,LUA_TTABLE:L,LUA_TTHREAD:E,LUA_TUSERDATA:S},thread_status:{LUA_OK:M},from_userstring:k,to_luastring:R}=n(696),{api_check:I}=n(502),U=n(399),O=n(179),{luaU_dump:C}=n(940),B=n(196),P=n(853),N=n(809),{luaS_bless:D,luaS_new:F,luaS_newliteral:V}=n(415),G=n(917),{LUAI_MAXSTACK:K}=n(254),j=n(371),z=n(420),{ZIO:H}=n(498),X=P.TValue,q=P.CClosure,Y=function(t){t.top++,I(t,t.top<=t.ci.top,"stack overflow")},$=function(t,e){I(t,e<t.top-t.ci.funcOff,"not enough elements in the stack")},W=function(t){if(!t)throw TypeError("invalid argument")},Z=function(t){W("number"==typeof t&&(0|t)===t)},J=function(t){return t!==P.luaO_nilobject},Q=function(t,e){let n=t.ci;if(e>0){let i=n.funcOff+e;return I(t,e<=n.top-(n.funcOff+1),"unacceptable index"),i>=t.top?P.luaO_nilobject:t.stack[i]}return e>h?(I(t,0!==e&&-e<=t.top,"invalid index"),t.stack[t.top+e]):e===h?t.l_G.l_registry:(I(t,(e=h-e)<=B.MAXUPVAL+1,"upvalue index too large"),n.func.ttislcf()?P.luaO_nilobject:e<=n.func.value.nupvalues?n.func.value.upvalue[e-1]:P.luaO_nilobject)},tt=function(t,e){let n=t.ci;if(e>0){let i=n.funcOff+e;return I(t,e<=n.top-(n.funcOff+1),"unacceptable index"),i>=t.top?null:i}if(e>h)return I(t,0!==e&&-e<=t.top,"invalid index"),t.top+e;throw Error("attempt to use pseudo-index")},et=function(t,e){let n,i=t.ci.funcOff;e>=0?(I(t,e<=t.stack_last-(i+1),"new top too large"),n=i+1+e):(I(t,-(e+1)<=t.top-(i+1),"invalid new top"),n=t.top+e+1),O.adjust_top(t,n)},nt=function(t,e){et(t,-e-1)},it=function(t,e,n){for(;e<n;e++,n--){let i=t.stack[e],r=new X(i.type,i.value);P.setobjs2s(t,e,n),P.setobj2s(t,n,r)}},rt=function(t,e,n){let i=t.top-1,r=tt(t,e),s=t.stack[r];I(t,J(s)&&e>h,"index not in the stack"),I(t,(n>=0?n:-n)<=i-r+1,"invalid 'n'");let a=n>=0?i-n:r-n-1;it(t,r,a),it(t,a+1,t.top-1),it(t,r,t.top-1)},st=function(t,e,n){let i=Q(t,e);Q(t,n).setfrom(i)},at=function(t,e,n){if(W("function"==typeof e),Z(n),0===n)t.stack[t.top]=new X(_,e);else{$(t,n),I(t,n<=B.MAXUPVAL,"upvalue index too large");let i=new q(t,e,n);for(let e=0;e<n;e++)i.upvalue[e].setfrom(t.stack[t.top-n+e]);for(let e=1;e<n;e++)delete t.stack[--t.top];n>0&&--t.top,t.stack[t.top].setclCvalue(i)}Y(t)},ot=at,lt=function(t,e){at(t,e,0)},ht=lt,ut=function(t,e,n){let i=F(t,k(n));$(t,1),P.pushsvalue2s(t,i),I(t,t.top<=t.ci.top,"stack overflow"),j.settable(t,e,t.stack[t.top-1],t.stack[t.top-2]),delete t.stack[--t.top],delete t.stack[--t.top]},ct=function(t,e){ut(t,z.luaH_getint(t.l_G.l_registry.value,u),e)},dt=function(t,e,n){let i=F(t,k(n));return P.pushsvalue2s(t,i),I(t,t.top<=t.ci.top,"stack overflow"),j.luaV_gettable(t,e,t.stack[t.top-1],t.top-1),t.stack[t.top-1].ttnov()},ft=function(t,e,n){let i=Q(t,e);return Z(n),I(t,i.ttistable(),"table expected"),P.pushobj2s(t,z.luaH_getint(i.value,n)),I(t,t.top<=t.ci.top,"stack overflow"),t.stack[t.top-1].ttnov()},pt=function(t,e,n){let i=new P.TValue(L,z.luaH_new(t));t.stack[t.top]=i,Y(t)},mt=function(t,e,n){switch(Z(n),e.ttype()){case p:{let t=e.value;return 1<=n&&n<=t.nupvalues?{name:R("",!0),val:t.upvalue[n-1]}:null}case g:{let t=e.value,i=t.p;if(!(1<=n&&n<=i.upvalues.length))return null;let r=i.upvalues[n-1].name;return{name:r?r.getstr():R("(*no name)",!0),val:t.upvals[n-1]}}default:return null}},_t=function(t,e){let n=Q(t,e);if(!n.ttisstring()){if(!j.cvt2str(n))return null;P.luaO_tostring(t,n)}return n.svalue()},gt=_t,vt=function(t,e){return j.tointeger(Q(t,e))},bt=function(t,e){return j.tonumber(Q(t,e))},wt=new WeakMap,At=function(t,e){O.luaD_callnoyield(t,e.funcOff,e.nresults)},yt=function(t,e){let n=Q(t,e);return J(n)?n.ttnov():A},xt=R("?"),Tt=function(t,e,n){I(t,n===i||t.ci.top-t.top>=n-e,"results from function overflow current stack size")},Lt=function(t,e,n,r,s){I(t,null===s||!(t.ci.callstatus&N.CIST_LUA),"cannot use continuations inside hooks"),$(t,e+1),I(t,t.status===M,"cannot do calls on non-normal thread"),Tt(t,e,n);let a=t.top-(e+1);null!==s&&0===t.nny?(t.ci.c_k=s,t.ci.c_ctx=r,O.luaD_call(t,a,n)):O.luaD_callnoyield(t,a,n),n===i&&t.ci.top<t.top&&(t.ci.top=t.top)},Et=function(t,e,n,r,s,a){let o,l;I(t,null===a||!(t.ci.callstatus&N.CIST_LUA),"cannot use continuations inside hooks"),$(t,e+1),I(t,t.status===M,"cannot do calls on non-normal thread"),Tt(t,e,n),l=0===r?0:tt(t,r);let h=t.top-(e+1);if(null===a||t.nny>0){let e={funcOff:h,nresults:n};o=O.luaD_pcall(t,At,e,h,l)}else{let e=t.ci;e.c_k=a,e.c_ctx=s,e.extra=h,e.c_old_errfunc=t.errfunc,t.errfunc=l,e.callstatus&=~N.CIST_OAH|t.allowhook,e.callstatus|=N.CIST_YPCALL,O.luaD_call(t,h,n),e.callstatus&=~N.CIST_YPCALL,t.errfunc=e.c_old_errfunc,o=M}return n===i&&t.ci.top<t.top&&(t.ci.top=t.top),o},St=function(t,e,n){let i=Q(t,e);I(t,i.ttisLclosure(),"Lua function expected");let r=i.value;return Z(n),I(t,1<=n&&n<=r.p.upvalues.length,"invalid upvalue index"),{f:r,i:n-1}};t.exports.api_incr_top=Y,t.exports.api_checknelems=$,t.exports.lua_absindex=function(t,e){return e>0||e<=h?e:t.top-t.ci.funcOff+e},t.exports.lua_arith=function(t,e){e!==l&&e!==r?$(t,2):($(t,1),P.pushobj2s(t,t.stack[t.top-1]),I(t,t.top<=t.ci.top,"stack overflow")),P.luaO_arith(t,e,t.stack[t.top-2],t.stack[t.top-1],t.stack[t.top-2]),delete t.stack[--t.top]},t.exports.lua_atpanic=function(t,e){let n=t.l_G.panic;return t.l_G.panic=e,n},t.exports.lua_atnativeerror=function(t,e){let n=t.l_G.atnativeerror;return t.l_G.atnativeerror=e,n},t.exports.lua_call=function(t,e,n){Lt(t,e,n,0,null)},t.exports.lua_callk=Lt,t.exports.lua_checkstack=function(t,e){let n,i=t.ci;if(I(t,e>=0,"negative 'n'"),t.stack_last-t.top>e)n=!0;else{t.top+N.EXTRA_STACK>K-e?n=!1:(O.luaD_growstack(t,e),n=!0)}return n&&i.top<t.top+e&&(i.top=t.top+e),n},t.exports.lua_compare=function(t,e,n,i){let r=Q(t,e),l=Q(t,n),h=0;if(J(r)&&J(l))switch(i){case s:h=j.luaV_equalobj(t,r,l);break;case o:h=j.luaV_lessthan(t,r,l);break;case a:h=j.luaV_lessequal(t,r,l);break;default:I(t,!1,"invalid option")}return h},t.exports.lua_concat=function(t,e){$(t,e),e>=2?j.luaV_concat(t,e):0===e&&(P.pushsvalue2s(t,D(t,R("",!0))),I(t,t.top<=t.ci.top,"stack overflow"))},t.exports.lua_copy=st,t.exports.lua_createtable=pt,t.exports.lua_dump=function(t,e,n,i){$(t,1);let r=t.stack[t.top-1];return r.ttisLclosure()?C(t,r.value.p,e,n,i):1},t.exports.lua_error=function(t){$(t,1),U.luaG_errormsg(t)},t.exports.lua_gc=function(){},t.exports.lua_getallocf=function(){return console.warn("lua_getallocf is not available"),0},t.exports.lua_getextraspace=function(){return console.warn("lua_getextraspace is not available"),0},t.exports.lua_getfield=function(t,e,n){return dt(t,Q(t,e),n)},t.exports.lua_getglobal=function(t,e){return dt(t,z.luaH_getint(t.l_G.l_registry.value,u),e)},t.exports.lua_geti=function(t,e,n){let i=Q(t,e);return Z(n),t.stack[t.top]=new X(x,n),Y(t),j.luaV_gettable(t,i,t.stack[t.top-1],t.top-1),t.stack[t.top-1].ttnov()},t.exports.lua_getmetatable=function(t,e){let n,i=Q(t,e),r=!1;switch(i.ttnov()){case L:case S:n=i.value.metatable;break;default:n=t.l_G.mt[i.ttnov()]}return null!=n&&(t.stack[t.top]=new X(L,n),Y(t),r=!0),r},t.exports.lua_gettable=function(t,e){let n=Q(t,e);return j.luaV_gettable(t,n,t.stack[t.top-1],t.top-1),t.stack[t.top-1].ttnov()},t.exports.lua_gettop=function(t){return t.top-(t.ci.funcOff+1)},t.exports.lua_getupvalue=function(t,e,n){let i=mt(0,Q(t,e),n);if(i){let e=i.name,n=i.val;return P.pushobj2s(t,n),I(t,t.top<=t.ci.top,"stack overflow"),e}return null},t.exports.lua_getuservalue=function(t,e){let n=Q(t,e);I(t,n.ttisfulluserdata(),"full userdata expected");let i=n.value.uservalue;return t.stack[t.top]=new X(i.type,i.value),Y(t),t.stack[t.top-1].ttnov()},t.exports.lua_insert=function(t,e){rt(t,e,1)},t.exports.lua_isboolean=function(t,e){return yt(t,e)===f},t.exports.lua_iscfunction=function(t,e){let n=Q(t,e);return n.ttislcf(n)||n.ttisCclosure()},t.exports.lua_isfunction=function(t,e){return yt(t,e)===m},t.exports.lua_isinteger=function(t,e){return Q(t,e).ttisinteger()},t.exports.lua_islightuserdata=function(t,e){return yt(t,e)===v},t.exports.lua_isnil=function(t,e){return yt(t,e)===w},t.exports.lua_isnone=function(t,e){return yt(t,e)===A},t.exports.lua_isnoneornil=function(t,e){return yt(t,e)<=0},t.exports.lua_isnumber=function(t,e){return!1!==j.tonumber(Q(t,e))},t.exports.lua_isproxy=function(t,e){let n=wt.get(t);return!!n&&(null===e||e.l_G===n)},t.exports.lua_isstring=function(t,e){let n=Q(t,e);return n.ttisstring()||j.cvt2str(n)},t.exports.lua_istable=function(t,e){return Q(t,e).ttistable()},t.exports.lua_isthread=function(t,e){return yt(t,e)===E},t.exports.lua_isuserdata=function(t,e){let n=Q(t,e);return n.ttisfulluserdata(n)||n.ttislightuserdata()},t.exports.lua_len=function(t,e){let n=Q(t,e),i=new X;j.luaV_objlen(t,i,n),t.stack[t.top]=i,Y(t)},t.exports.lua_load=function(t,e,n,i,r){i=i?k(i):xt,null!==r&&(r=k(r));let s=new H(t,e,n),a=O.luaD_protectedparser(t,s,i,r);if(a===M){let e=t.stack[t.top-1].value;if(e.nupvalues>=1){let n=z.luaH_getint(t.l_G.l_registry.value,u);e.upvals[0].setfrom(n)}}return a},t.exports.lua_newtable=function(t){pt(t)},t.exports.lua_newuserdata=function(t,e){let n=function(t,e){return new P.Udata(t,e)}(t,e);return t.stack[t.top]=new P.TValue(S,n),Y(t),n.data},t.exports.lua_next=function(t,e){let n=Q(t,e);return I(t,n.ttistable(),"table expected"),t.stack[t.top]=new X,z.luaH_next(t,n.value,t.top-1)?(Y(t),1):(delete t.stack[t.top],delete t.stack[--t.top],0)},t.exports.lua_pcall=function(t,e,n,i){return Et(t,e,n,i,0,null)},t.exports.lua_pcallk=Et,t.exports.lua_pop=nt,t.exports.lua_pushboolean=function(t,e){t.stack[t.top]=new X(f,!!e),Y(t)},t.exports.lua_pushcclosure=at,t.exports.lua_pushcfunction=lt,t.exports.lua_pushfstring=function(t,e,...n){return e=k(e),P.luaO_pushvfstring(t,e,n)},t.exports.lua_pushglobaltable=function(t){ft(t,h,u)},t.exports.lua_pushinteger=function(t,e){Z(e),t.stack[t.top]=new X(x,e),Y(t)},t.exports.lua_pushjsclosure=ot,t.exports.lua_pushjsfunction=ht,t.exports.lua_pushlightuserdata=function(t,e){t.stack[t.top]=new X(v,e),Y(t)},t.exports.lua_pushliteral=function(t,e){if(null==e)t.stack[t.top]=new X(w,null),t.top++;else{W("string"==typeof e);let n=V(t,e);P.pushsvalue2s(t,n),e=n.getstr()}return I(t,t.top<=t.ci.top,"stack overflow"),e},t.exports.lua_pushlstring=function(t,e,n){let i;return Z(n),0===n?(e=R("",!0),i=D(t,e)):(e=k(e),I(t,e.length>=n,"invalid length to lua_pushlstring"),i=F(t,e.subarray(0,n))),P.pushsvalue2s(t,i),I(t,t.top<=t.ci.top,"stack overflow"),i.value},t.exports.lua_pushnil=function(t){t.stack[t.top]=new X(w,null),Y(t)},t.exports.lua_pushnumber=function(t,e){W("number"==typeof e),t.stack[t.top]=new X(y,e),Y(t)},t.exports.lua_pushstring=function(t,e){if(null==e)t.stack[t.top]=new X(w,null),t.top++;else{let n=F(t,k(e));P.pushsvalue2s(t,n),e=n.getstr()}return I(t,t.top<=t.ci.top,"stack overflow"),e},t.exports.lua_pushthread=function(t){return t.stack[t.top]=new X(E,t),Y(t),t.l_G.mainthread===t},t.exports.lua_pushvalue=function(t,e){P.pushobj2s(t,Q(t,e)),I(t,t.top<=t.ci.top,"stack overflow")},t.exports.lua_pushvfstring=function(t,e,n){return e=k(e),P.luaO_pushvfstring(t,e,n)},t.exports.lua_rawequal=function(t,e,n){let i=Q(t,e),r=Q(t,n);return J(i)&&J(r)?j.luaV_equalobj(null,i,r):0},t.exports.lua_rawget=function(t,e){let n=Q(t,e);return I(t,n.ttistable(n),"table expected"),P.setobj2s(t,t.top-1,z.luaH_get(t,n.value,t.stack[t.top-1])),t.stack[t.top-1].ttnov()},t.exports.lua_rawgeti=ft,t.exports.lua_rawgetp=function(t,e,n){let i=Q(t,e);I(t,i.ttistable(),"table expected");let r=new X(v,n);return P.pushobj2s(t,z.luaH_get(t,i.value,r)),I(t,t.top<=t.ci.top,"stack overflow"),t.stack[t.top-1].ttnov()},t.exports.lua_rawlen=function(t,e){let n=Q(t,e);switch(n.ttype()){case T:case b:return n.vslen();case S:return n.value.len;case L:return z.luaH_getn(n.value);default:return 0}},t.exports.lua_rawset=function(t,e){$(t,2);let n=Q(t,e);I(t,n.ttistable(),"table expected");let i=t.stack[t.top-2],r=t.stack[t.top-1];z.luaH_setfrom(t,n.value,i,r),z.invalidateTMcache(n.value),delete t.stack[--t.top],delete t.stack[--t.top]},t.exports.lua_rawseti=function(t,e,n){Z(n),$(t,1);let i=Q(t,e);I(t,i.ttistable(),"table expected"),z.luaH_setint(i.value,n,t.stack[t.top-1]),delete t.stack[--t.top]},t.exports.lua_rawsetp=function(t,e,n){$(t,1);let i=Q(t,e);I(t,i.ttistable(),"table expected");let r=new X(v,n),s=t.stack[t.top-1];z.luaH_setfrom(t,i.value,r,s),delete t.stack[--t.top]},t.exports.lua_register=function(t,e,n){lt(t,n),ct(t,e)},t.exports.lua_remove=function(t,e){rt(t,e,-1),nt(t,1)},t.exports.lua_replace=function(t,e){st(t,-1,e),nt(t,1)},t.exports.lua_rotate=rt,t.exports.lua_setallocf=function(){return console.warn("lua_setallocf is not available"),0},t.exports.lua_setfield=function(t,e,n){ut(t,Q(t,e),n)},t.exports.lua_setglobal=ct,t.exports.lua_seti=function(t,e,n){Z(n),$(t,1);let i=Q(t,e);t.stack[t.top]=new X(x,n),Y(t),j.settable(t,i,t.stack[t.top-1],t.stack[t.top-2]),delete t.stack[--t.top],delete t.stack[--t.top]},t.exports.lua_setmetatable=function(t,e){let n;$(t,1);let i=Q(t,e);switch(t.stack[t.top-1].ttisnil()?n=null:(I(t,t.stack[t.top-1].ttistable(),"table expected"),n=t.stack[t.top-1].value),i.ttnov()){case S:case L:i.value.metatable=n;break;default:t.l_G.mt[i.ttnov()]=n}return delete t.stack[--t.top],!0},t.exports.lua_settable=function(t,e){$(t,2);let n=Q(t,e);j.settable(t,n,t.stack[t.top-2],t.stack[t.top-1]),delete t.stack[--t.top],delete t.stack[--t.top]},t.exports.lua_settop=et,t.exports.lua_setupvalue=function(t,e,n){let i=Q(t,e);$(t,1);let r=mt(0,i,n);if(r){let e=r.name;return r.val.setfrom(t.stack[t.top-1]),delete t.stack[--t.top],e}return null},t.exports.lua_setuservalue=function(t,e){$(t,1);let n=Q(t,e);I(t,n.ttisfulluserdata(),"full userdata expected"),n.value.uservalue.setfrom(t.stack[t.top-1]),delete t.stack[--t.top]},t.exports.lua_status=function(t){return t.status},t.exports.lua_stringtonumber=function(t,e){let n=new X,i=P.luaO_str2num(e,n);return 0!==i&&(t.stack[t.top]=n,Y(t)),i},t.exports.lua_toboolean=function(t,e){return!Q(t,e).l_isfalse()},t.exports.lua_tocfunction=function(t,e){let n=Q(t,e);return n.ttislcf()||n.ttisCclosure()?n.value:null},t.exports.lua_todataview=function(t,e){let n=_t(t,e);return new DataView(n.buffer,n.byteOffset,n.byteLength)},t.exports.lua_tointeger=function(t,e){let n=vt(t,e);return!1===n?0:n},t.exports.lua_tointegerx=vt,t.exports.lua_tojsstring=function(t,e){let n=Q(t,e);if(!n.ttisstring()){if(!j.cvt2str(n))return null;P.luaO_tostring(t,n)}return n.jsstring()},t.exports.lua_tolstring=_t,t.exports.lua_tonumber=function(t,e){let n=bt(t,e);return!1===n?0:n},t.exports.lua_tonumberx=bt,t.exports.lua_topointer=function(t,e){let n=Q(t,e);switch(n.ttype()){case L:case g:case p:case _:case E:case S:case v:return n.value;default:return null}},t.exports.lua_toproxy=function(t,e){let n=Q(t,e);return function(t,e,n){let i=function(i){I(i,i instanceof N.lua_State&&t===i.l_G,"must be from same global state"),i.stack[i.top]=new X(e,n),Y(i)};return wt.set(i,t),i}(t.l_G,n.type,n.value)},t.exports.lua_tostring=gt,t.exports.lua_tothread=function(t,e){let n=Q(t,e);return n.ttisthread()?n.value:null},t.exports.lua_touserdata=function(t,e){let n=Q(t,e);switch(n.ttnov()){case S:return n.value.data;case v:return n.value;default:return null}},t.exports.lua_type=yt,t.exports.lua_typename=function(t,e){return I(t,A<=e&&e<d,"invalid tag"),G.ttypename(e)},t.exports.lua_upvalueid=function(t,e,n){let i=Q(t,e);switch(i.ttype()){case g:{let i=St(t,e,n);return i.f.upvals[i.i]}case p:{let e=i.value;return I(t,(0|n)===n&&n>0&&n<=e.nupvalues,"invalid upvalue index"),e.upvalue[n-1]}default:return I(t,!1,"closure expected"),null}},t.exports.lua_upvaluejoin=function(t,e,n,i,r){let s=St(t,e,n),a=St(t,i,r),o=a.f.upvals[a.i];s.f.upvals[s.i]=o},t.exports.lua_version=function(t){return null===t?c:t.l_G.version},t.exports.lua_xmove=function(t,e,n){if(t!==e){$(t,n),I(t,t.l_G===e.l_G,"moving among independent states"),I(t,e.ci.top-e.top>=n,"stack overflow"),t.top-=n;for(let i=0;i<n;i++)e.stack[e.top]=new P.TValue,P.setobj2s(e,e.top,t.stack[t.top+i]),delete t.stack[t.top+i],e.top++}}},447:(t,e,n)=>{"use strict";const{LUAL_BUFFERSIZE:i}=n(254),{LUA_ERRERR:r,LUA_MULTRET:s,LUA_REGISTRYINDEX:a,LUA_SIGNATURE:o,LUA_TBOOLEAN:l,LUA_TLIGHTUSERDATA:h,LUA_TNIL:u,LUA_TNONE:c,LUA_TNUMBER:d,LUA_TSTRING:f,LUA_TTABLE:p,LUA_VERSION_NUM:m,lua_Debug:_,lua_absindex:g,lua_atpanic:v,lua_call:b,lua_checkstack:w,lua_concat:A,lua_copy:y,lua_createtable:x,lua_error:T,lua_getfield:L,lua_getinfo:E,lua_getmetatable:S,lua_getstack:M,lua_gettop:k,lua_insert:R,lua_isinteger:I,lua_isnil:U,lua_isnumber:O,lua_isstring:C,lua_istable:B,lua_len:P,lua_load:N,lua_newstate:D,lua_newtable:F,lua_next:V,lua_pcall:G,lua_pop:K,lua_pushboolean:j,lua_pushcclosure:z,lua_pushcfunction:H,lua_pushfstring:X,lua_pushinteger:q,lua_pushliteral:Y,lua_pushlstring:$,lua_pushnil:W,lua_pushstring:Z,lua_pushvalue:J,lua_pushvfstring:Q,lua_rawequal:tt,lua_rawget:et,lua_rawgeti:nt,lua_rawlen:it,lua_rawseti:rt,lua_remove:st,lua_setfield:at,lua_setglobal:ot,lua_setmetatable:lt,lua_settop:ht,lua_toboolean:ut,lua_tointeger:ct,lua_tointegerx:dt,lua_tojsstring:ft,lua_tolstring:pt,lua_tonumber:mt,lua_tonumberx:_t,lua_topointer:gt,lua_tostring:vt,lua_touserdata:bt,lua_type:wt,lua_typename:At,lua_version:yt}=n(936),{from_userstring:xt,luastring_eq:Tt,to_luastring:Lt,to_uristring:Et}=n(125),St=r+1,Mt=Lt("_LOADED"),kt=Lt("_PRELOAD"),Rt=Lt("FILE*"),It=Lt("__name"),Ut=Lt("__tostring"),Ot=new Uint8Array(0);class Ct{constructor(){this.L=null,this.b=Ot,this.n=0}}const Bt=function(t,e,n){if(0===n||!B(t,-1))return 0;for(W(t);V(t,-2);){if(wt(t,-2)===f){if(tt(t,e,-1))return K(t,1),1;if(Bt(t,e,n-1))return st(t,-2),Y(t,"."),R(t,-2),A(t,3),1}K(t,1)}return 0},Pt=function(t,e){let n=k(t);if(E(t,Lt("f"),e),L(t,a,Mt),Bt(t,n+1,2)){let e=vt(t,-1);return 95===e[0]&&71===e[1]&&46===e[2]&&(Z(t,e.subarray(3)),st(t,-2)),y(t,-1,n+1),K(t,2),1}return ht(t,n),0},Nt=function(t,e){Pt(t,e)?(X(t,Lt("function '%s'"),vt(t,-1)),st(t,-2)):0!==e.namewhat.length?X(t,Lt("%s '%s'"),e.namewhat,e.name):e.what&&109===e.what[0]?Y(t,"main chunk"):e.what&&76===e.what[0]?X(t,Lt("function <%s:%d>"),e.short_src,e.linedefined):Y(t,"?")},Dt=function(t){let e="PANIC: unprotected error in call to Lua API ("+ft(t,-1)+")";throw new Error(e)},Ft=function(t,e,n){let i=new _;return M(t,0,i)?(E(t,Lt("n"),i),Tt(i.namewhat,Lt("method"))&&0===--e?Kt(t,Lt("calling '%s' on bad self (%s)"),i.name,n):(null===i.name&&(i.name=Pt(t,i)?vt(t,-1):Lt("?")),Kt(t,Lt("bad argument #%d to '%s' (%s)"),e,i.name,n))):Kt(t,Lt("bad argument #%d (%s)"),e,n)},Vt=function(t,e,n){let i;i=ce(t,e,It)===f?vt(t,-1):wt(t,e)===h?Lt("light userdata",!0):qt(t,e);let r=X(t,Lt("%s expected, got %s"),n,i);return Ft(t,e,r)},Gt=function(t,e){let n=new _;M(t,e,n)&&(E(t,Lt("Sl",!0),n),n.currentline>0)?X(t,Lt("%s:%d: "),n.short_src,n.currentline):Z(t,Lt(""))},Kt=function(t,e,...n){return Gt(t,1),Q(t,e,n),A(t,2),T(t)},jt=function(t,e,n,i){if(e)return j(t,1),1;{let e,r;return W(t),i?(e=i.message,r=-i.errno):(e="Success",r=0),n?X(t,Lt("%s: %s"),n,Lt(e)):Z(t,Lt(e)),q(t,r),3}},zt=function(t,e){return L(t,a,e)},Ht=function(t,e,n){let i=bt(t,e);return null!==i&&S(t,e)?(zt(t,n),tt(t,-1,-2)||(i=null),K(t,2),i):null},Xt=function(t,e,n){Vt(t,e,At(t,n))},qt=function(t,e){return At(t,wt(t,e))},Yt=function(t,e){let n=pt(t,e);return null==n&&Xt(t,e,f),n},$t=Yt,Wt=function(t,e,n){return wt(t,e)<=0?null===n?null:xt(n):Yt(t,e)},Zt=Wt,Jt=function(t,e){let n=_t(t,e);return!1===n&&Xt(t,e,d),n},Qt=function(t,e){let n=dt(t,e);return!1===n&&function(t,e){O(t,e)?Ft(t,e,Lt("number has no integer representation",!0)):Xt(t,e,d)}(t,e),n},te=function(t,e){let n=t.n+e;if(t.b.length<n){let e=Math.max(2*t.b.length,n),i=new Uint8Array(e);i.set(t.b),t.b=i}return t.b.subarray(t.n,n)},ee=function(t,e){e.L=t,e.b=Ot},ne=function(t,e,n){if(n>0){e=xt(e),te(t,n).set(e.subarray(0,n)),se(t,n)}},ie=function(t,e){e=xt(e),ne(t,e,e.length)},re=function(t){$(t.L,t.b,t.n),t.n=0,t.b=Ot},se=function(t,e){t.n+=e},ae=function(t,e,n,i){return wt(t,n)<=0?i:e(t,n)},oe=function(t,e){let n=e.string;return e.string=null,n},le=function(t,e,n,i,r){return N(t,oe,{string:e},i,r)},he=function(t,e,n,i){return le(t,e,0,i,null)},ue=function(t,e){return he(t,e,e.length,e)},ce=function(t,e,n){if(S(t,e)){Z(t,n);let e=et(t,-2);return e===u?K(t,2):st(t,-2),e}return u},de=function(t,e,n){return e=g(t,e),ce(t,e,n)!==u&&(J(t,e),b(t,1,1),!0)},fe=Lt("%I"),pe=Lt("%f"),me=function(t,e,n){var i=n>>>0,r=e.length,s=t.length+1-r;t:for(;i<s;i++){for(let n=0;n<r;n++)if(t[i+n]!==e[n])continue t;return i}return-1},_e=function(t,e,n){return L(t,e,n)===p||(K(t,1),e=g(t,e),F(t),J(t,-1),at(t,e,n),!1)},ge=function(t,e,n){ve(t,n,Lt("too many upvalues",!0));for(let i in e){for(let e=0;e<n;e++)J(t,-n);z(t,e[i],n),at(t,-(n+2),Lt(i))}K(t,n)},ve=function(t,e,n){w(t,e)||(n?Kt(t,Lt("stack overflow (%s)"),n):Kt(t,Lt("stack overflow",!0)))},be=function(t,e,n,i){let r=i.message,s=vt(t,n).subarray(1);return X(t,Lt("cannot %s %s: %s"),Lt(e),s,Lt(r)),st(t,n),St};let we;const Ae=[239,187,191],ye=function(t){let e=function(t){let e;t.n=0;let n=0;do{if(e=we(t),null===e||e!==Ae[n])return e;n++,t.buff[t.n++]=e}while(n<Ae.length);return t.n=0,we(t)}(t);if(35===e){do{e=we(t)}while(e&&10!==e);return{skipped:!0,c:we(t)}}return{skipped:!1,c:e}};let xe;{class t{constructor(){this.n=NaN,this.f=null,this.buff=new Uint8Array(1024),this.pos=0,this.err=void 0}}const e=function(t,e){let n=e;if(null!==n.f&&n.n>0){let t=n.n;return n.n=0,n.f=n.f.subarray(n.pos),n.buff.subarray(0,t)}let i=n.f;return n.f=null,i};we=function(t){return t.pos<t.f.length?t.f[t.pos++]:null},xe=function(n,i,r){let s=new t,a=k(n)+1;if(null===i)throw new Error("Can't read stdin in the browser");{X(n,Lt("@%s"),i);let t=Et(i),e=new XMLHttpRequest;if(e.open("GET",t,!1),"undefined"==typeof window&&(e.responseType="arraybuffer"),e.send(),!(e.status>=200&&e.status<=299))return s.err=e.status,be(n,"open",a,{message:`${e.status}: ${e.statusText}`});"string"==typeof e.response?s.f=Lt(e.response):s.f=new Uint8Array(e.response)}let l=ye(s);l.c===o[0]&&i||l.skipped&&(s.buff[s.n++]=10),null!==l.c&&(s.buff[s.n++]=l.c);let h=N(n,e,s,vt(n,-1),r),u=s.err;return u?(ht(n,a),be(n,"read",a,u)):(st(n,a),h)}}const Te=function(t,e){return xe(t,e,null)},Le=function(t,e,n){let i=yt(t);72!=n&&Kt(t,Lt("core and library have incompatible numeric types")),i!=yt(null)?Kt(t,Lt("multiple Lua VMs detected")):i!==e&&Kt(t,Lt("version mismatch: app. needs %f, Lua core provides %f"),e,i)};t.exports.eN=Qt,t.exports.hs=Jt,t.exports.dK=$t,t.exports.rf=ue,t.exports.Zf=function(){let t=D();return t&&v(t,Dt),t},t.exports.oL=function(t,e){let n;return U(t,-1)?(K(t,1),-1):(e=g(t,e),nt(t,e,0),n=ct(t,-1),K(t,1),0!==n?(nt(t,e,n),rt(t,e,0)):n=it(t,e)+1,rt(t,e,n),n)},t.exports.On=function(t,e){if(de(t,e,Ut))C(t,-1)||Kt(t,Lt("'__tostring' must return a string"));else{switch(wt(t,e)){case d:I(t,e)?X(t,fe,ct(t,e)):X(t,pe,mt(t,e));break;case f:J(t,e);break;case l:Y(t,ut(t,e)?"true":"false");break;case u:Y(t,"nil");break;default:{let n=ce(t,e,It),i=n===f?vt(t,-1):qt(t,e);X(t,Lt("%s: %p"),i,gt(t,e)),n!==u&&st(t,-2);break}}}return pt(t,-1)},t.exports.eK=function(t,e,n){n>=0&&(e=g(t,e),nt(t,e,0),rt(t,e,n),q(t,n),rt(t,e,0))}},459:(t,e,n)=>{"use strict";const{LUA_MULTRET:i,LUA_OPADD:r,LUA_OPBAND:s,LUA_OPBNOT:a,LUA_OPBOR:o,LUA_OPBXOR:l,LUA_OPDIV:h,LUA_OPIDIV:u,LUA_OPMOD:c,LUA_OPSHL:d,LUA_OPSHR:f,LUA_OPUNM:p,constant_types:{LUA_TBOOLEAN:m,LUA_TLIGHTUSERDATA:_,LUA_TLNGSTR:g,LUA_TNIL:v,LUA_TNUMFLT:b,LUA_TNUMINT:w,LUA_TTABLE:A},to_luastring:y}=n(696),{lua_assert:x}=n(502),T=n(641),L=n(853),E=n(451),S=n(517),M=n(420),k=n(371),R=E.OpCodesI,I=L.TValue,U=-1,O={OPR_ADD:0,OPR_SUB:1,OPR_MUL:2,OPR_MOD:3,OPR_POW:4,OPR_DIV:5,OPR_IDIV:6,OPR_BAND:7,OPR_BOR:8,OPR_BXOR:9,OPR_SHL:10,OPR_SHR:11,OPR_CONCAT:12,OPR_EQ:13,OPR_LT:14,OPR_LE:15,OPR_NE:16,OPR_GT:17,OPR_GE:18,OPR_AND:19,OPR_OR:20,OPR_NOBINOPR:21},C={OPR_MINUS:0,OPR_BNOT:1,OPR_NOT:2,OPR_LEN:3,OPR_NOUNOPR:4},B=function(t){return t.t!==t.f},P=function(t,e){let n=S.expkind;if(B(t))return!1;switch(t.k){case n.VKINT:return!e||new I(w,t.u.ival);case n.VKFLT:return!e||new I(b,t.u.nval);default:return!1}},N=function(t,e,n){let i,r=e+n-1;if(t.pc>t.lasttarget&&(i=t.f.code[t.pc-1],i.opcode===R.OP_LOADNIL)){let t=i.A,n=t+i.B;if(t<=e&&e<=n+1||e<=t&&t<=r+1)return t<e&&(e=t),n>r&&(r=n),E.SETARG_A(i,e),void E.SETARG_B(i,r-e)}Q(t,R.OP_LOADNIL,e,n-1,0)},D=function(t,e){return t.f.code[e.u.info]},F=function(t,e){let n=t.f.code[e].sBx;return n===U?U:e+1+n},V=function(t,e,n){let i=t.f.code[e],r=n-(e+1);x(n!==U),Math.abs(r)>E.MAXARG_sBx&&T.luaX_syntaxerror(t.ls,y("control structure too long",!0)),E.SETARG_sBx(i,r)},G=function(t,e,n){if(n===U)return e;if(e===U)e=n;else{let i=e,r=F(t,i);for(;r!==U;)i=r,r=F(t,i);V(t,i,n)}return e},K=function(t){let e=t.jpc;t.jpc=U;let n=et(t,R.OP_JMP,0,U);return n=G(t,n,e),n},j=function(t,e,n,i,r){return Q(t,e,n,i,r),K(t)},z=function(t){return t.lasttarget=t.pc,t.pc},H=function(t,e){return e>=1&&E.testTMode(t.f.code[e-1].opcode)?e-1:e},X=function(t,e){return t.f.code[H(t,e)]},q=function(t,e,n){let i=H(t,e),r=t.f.code[i];return r.opcode===R.OP_TESTSET&&(n!==E.NO_REG&&n!==r.B?E.SETARG_A(r,n):t.f.code[i]=E.CREATE_ABC(R.OP_TEST,r.B,0,r.C),!0)},Y=function(t,e){for(;e!==U;e=F(t,e))q(t,e,E.NO_REG)},$=function(t,e,n,i,r){for(;e!==U;){let s=F(t,e);q(t,e,i)?V(t,e,n):V(t,e,r),e=s}},W=function(t,e){z(t),t.jpc=G(t,t.jpc,e)},Z=function(t,e,n){n===t.pc?W(t,e):(x(n<t.pc),$(t,e,n,E.NO_REG,n))},J=function(t,e){let n=t.f;return function(t){$(t,t.jpc,t.pc,E.NO_REG,t.pc),t.jpc=U}(t),n.code[t.pc]=e,n.lineinfo[t.pc]=t.ls.lastline,t.pc++},Q=function(t,e,n,i,r){return x(E.getOpMode(e)===E.iABC),x(E.getBMode(e)!==E.OpArgN||0===i),x(E.getCMode(e)!==E.OpArgN||0===r),x(n<=E.MAXARG_A&&i<=E.MAXARG_B&&r<=E.MAXARG_C),J(t,E.CREATE_ABC(e,n,i,r))},tt=function(t,e,n,i){return x(E.getOpMode(e)===E.iABx||E.getOpMode(e)===E.iAsBx),x(E.getCMode(e)===E.OpArgN),x(n<=E.MAXARG_A&&i<=E.MAXARG_Bx),J(t,E.CREATE_ABx(e,n,i))},et=function(t,e,n,i){return tt(t,e,n,i+E.MAXARG_sBx)},nt=function(t,e){return x(e<=E.MAXARG_Ax),J(t,E.CREATE_Ax(R.OP_EXTRAARG,e))},it=function(t,e,n){if(n<=E.MAXARG_Bx)return tt(t,R.OP_LOADK,e,n);{let i=tt(t,R.OP_LOADKX,e,0);return nt(t,n),i}},rt=function(t,e){let n=t.freereg+e;n>t.f.maxstacksize&&(n>=255&&T.luaX_syntaxerror(t.ls,y("function or expression needs too many registers",!0)),t.f.maxstacksize=n)},st=function(t,e){rt(t,e),t.freereg+=e},at=function(t,e){!E.ISK(e)&&e>=t.nactvar&&(t.freereg--,x(e===t.freereg))},ot=function(t,e){e.k===S.expkind.VNONRELOC&&at(t,e.u.info)},lt=function(t,e,n){let i=e.k===S.expkind.VNONRELOC?e.u.info:-1,r=n.k===S.expkind.VNONRELOC?n.u.info:-1;i>r?(at(t,i),at(t,r)):(at(t,r),at(t,i))},ht=function(t,e,n){let i=t.f,r=M.luaH_get(t.L,t.ls.h,e);if(r.ttisinteger()){let e=r.value;if(e<t.nk&&i.k[e].ttype()===n.ttype()&&i.k[e].value===n.value)return e}let s=t.nk;return M.luaH_setfrom(t.L,t.ls.h,e,new L.TValue(w,s)),i.k[s]=n,t.nk++,s},ut=function(t,e){let n=new I(_,e),i=new I(w,e);return ht(t,n,i)},ct=function(t,e){let n=new I(b,e);return ht(t,n,n)},dt=function(t,e){let n=new I(m,e);return ht(t,n,n)},ft=function(t,e,n){let r=S.expkind;if(e.k===r.VCALL)E.SETARG_C(D(t,e),n+1);else if(e.k===r.VVARARG){let i=D(t,e);E.SETARG_B(i,n+1),E.SETARG_A(i,t.freereg),st(t,1)}else x(n===i)},pt=function(t,e){let n=S.expkind;e.k===n.VCALL?(x(2===D(t,e).C),e.k=n.VNONRELOC,e.u.info=D(t,e).A):e.k===n.VVARARG&&(E.SETARG_B(D(t,e),2),e.k=n.VRELOCABLE)},mt=function(t,e){let n=S.expkind;switch(e.k){case n.VLOCAL:e.k=n.VNONRELOC;break;case n.VUPVAL:e.u.info=Q(t,R.OP_GETUPVAL,0,e.u.info,0),e.k=n.VRELOCABLE;break;case n.VINDEXED:{let i;at(t,e.u.ind.idx),e.u.ind.vt===n.VLOCAL?(at(t,e.u.ind.t),i=R.OP_GETTABLE):(x(e.u.ind.vt===n.VUPVAL),i=R.OP_GETTABUP),e.u.info=Q(t,i,0,e.u.ind.t,e.u.ind.idx),e.k=n.VRELOCABLE;break}case n.VVARARG:case n.VCALL:pt(t,e)}},_t=function(t,e,n,i){return z(t),Q(t,R.OP_LOADBOOL,e,n,i)},gt=function(t,e,n){let i=S.expkind;switch(mt(t,e),e.k){case i.VNIL:N(t,n,1);break;case i.VFALSE:case i.VTRUE:Q(t,R.OP_LOADBOOL,n,e.k===i.VTRUE,0);break;case i.VK:it(t,n,e.u.info);break;case i.VKFLT:it(t,n,ct(t,e.u.nval));break;case i.VKINT:it(t,n,ut(t,e.u.ival));break;case i.VRELOCABLE:{let i=D(t,e);E.SETARG_A(i,n);break}case i.VNONRELOC:n!==e.u.info&&Q(t,R.OP_MOVE,n,e.u.info,0);break;default:return void x(e.k===i.VJMP)}e.u.info=n,e.k=i.VNONRELOC},vt=function(t,e){e.k!==S.expkind.VNONRELOC&&(st(t,1),gt(t,e,t.freereg-1))},bt=function(t,e){for(;e!==U;e=F(t,e)){if(X(t,e).opcode!==R.OP_TESTSET)return!0}return!1},wt=function(t,e,n){let i=S.expkind;if(gt(t,e,n),e.k===i.VJMP&&(e.t=G(t,e.t,e.u.info)),B(e)){let r,s=U,a=U;if(bt(t,e.t)||bt(t,e.f)){let r=e.k===i.VJMP?U:K(t);s=_t(t,n,0,1),a=_t(t,n,1,0),W(t,r)}r=z(t),$(t,e.f,r,n,s),$(t,e.t,r,n,a)}e.f=e.t=U,e.u.info=n,e.k=i.VNONRELOC},At=function(t,e){mt(t,e),ot(t,e),st(t,1),wt(t,e,t.freereg-1)},yt=function(t,e){if(mt(t,e),e.k===S.expkind.VNONRELOC){if(!B(e))return e.u.info;if(e.u.info>=t.nactvar)return wt(t,e,e.u.info),e.u.info}return At(t,e),e.u.info},xt=function(t,e){B(e)?yt(t,e):mt(t,e)},Tt=function(t,e){let n=S.expkind,i=!1;switch(xt(t,e),e.k){case n.VTRUE:e.u.info=dt(t,!0),i=!0;break;case n.VFALSE:e.u.info=dt(t,!1),i=!0;break;case n.VNIL:e.u.info=function(t){let e=new I(v,null),n=new I(A,t.ls.h);return ht(t,n,e)}(t),i=!0;break;case n.VKINT:e.u.info=ut(t,e.u.ival),i=!0;break;case n.VKFLT:e.u.info=ct(t,e.u.nval),i=!0;break;case n.VK:i=!0}return i&&(e.k=n.VK,e.u.info<=E.MAXINDEXRK)?E.RKASK(e.u.info):yt(t,e)},Lt=function(t,e){let n=X(t,e.u.info);x(E.testTMode(n.opcode)&&n.opcode!==R.OP_TESTSET&&n.opcode!==R.OP_TEST),E.SETARG_A(n,!n.A)},Et=function(t,e,n){if(e.k===S.expkind.VRELOCABLE){let i=D(t,e);if(i.opcode===R.OP_NOT)return t.pc--,j(t,R.OP_TEST,i.B,0,!n)}return vt(t,e),ot(t,e),j(t,R.OP_TESTSET,E.NO_REG,e.u.info,n)},St=function(t,e){let n,i=S.expkind;switch(mt(t,e),e.k){case i.VJMP:Lt(t,e),n=e.u.info;break;case i.VK:case i.VKFLT:case i.VKINT:case i.VTRUE:n=U;break;default:n=Et(t,e,0)}e.f=G(t,e.f,n),W(t,e.t),e.t=U},Mt=function(t,e){let n,i=S.expkind;switch(mt(t,e),e.k){case i.VJMP:n=e.u.info;break;case i.VNIL:case i.VFALSE:n=U;break;default:n=Et(t,e,1)}e.t=G(t,e.t,n),W(t,e.f),e.f=U},kt=function(t,e,n){let i,r,p=S.expkind;if(!(i=P(e,!0))||!(r=P(n,!0))||!function(t,e,n){switch(t){case s:case o:case l:case d:case f:case a:return!1!==k.tointeger(e)&&!1!==k.tointeger(n);case h:case u:case c:return 0!==n.value;default:return 1}}(t,i,r))return 0;let m=new I;if(L.luaO_arith(null,t,i,r,m),m.ttisinteger())e.k=p.VKINT,e.u.ival=m.value;else{let t=m.value;if(isNaN(t)||0===t)return!1;e.k=p.VKFLT,e.u.nval=t}return!0},Rt=function(t,e,n,i,r){let s=Tt(t,i),a=Tt(t,n);lt(t,n,i),n.u.info=Q(t,e,0,a,s),n.k=S.expkind.VRELOCABLE,It(t,r)},It=function(t,e){t.f.lineinfo[t.pc-1]=e};t.exports.BinOpr=O,t.exports.NO_JUMP=U,t.exports.UnOpr=C,t.exports.getinstruction=D,t.exports.luaK_checkstack=rt,t.exports.luaK_code=J,t.exports.luaK_codeABC=Q,t.exports.luaK_codeABx=tt,t.exports.luaK_codeAsBx=et,t.exports.luaK_codek=it,t.exports.luaK_concat=G,t.exports.luaK_dischargevars=mt,t.exports.luaK_exp2RK=Tt,t.exports.luaK_exp2anyreg=yt,t.exports.luaK_exp2anyregup=function(t,e){(e.k!==S.expkind.VUPVAL||B(e))&&yt(t,e)},t.exports.luaK_exp2nextreg=At,t.exports.luaK_exp2val=xt,t.exports.luaK_fixline=It,t.exports.luaK_getlabel=z,t.exports.luaK_goiffalse=Mt,t.exports.luaK_goiftrue=St,t.exports.luaK_indexed=function(t,e,n){let i=S.expkind;x(!B(e)&&(S.vkisinreg(e.k)||e.k===i.VUPVAL)),e.u.ind.t=e.u.info,e.u.ind.idx=Tt(t,n),e.u.ind.vt=e.k===i.VUPVAL?i.VUPVAL:i.VLOCAL,e.k=i.VINDEXED},t.exports.luaK_infix=function(t,e,n){switch(e){case O.OPR_AND:St(t,n);break;case O.OPR_OR:Mt(t,n);break;case O.OPR_CONCAT:At(t,n);break;case O.OPR_ADD:case O.OPR_SUB:case O.OPR_MUL:case O.OPR_DIV:case O.OPR_IDIV:case O.OPR_MOD:case O.OPR_POW:case O.OPR_BAND:case O.OPR_BOR:case O.OPR_BXOR:case O.OPR_SHL:case O.OPR_SHR:P(n,!1)||Tt(t,n);break;default:Tt(t,n)}},t.exports.luaK_intK=ut,t.exports.luaK_jump=K,t.exports.luaK_jumpto=function(t,e){return Z(t,K(t),e)},t.exports.luaK_nil=N,t.exports.luaK_numberK=ct,t.exports.luaK_patchclose=function(t,e,n){for(n++;e!==U;e=F(t,e)){let i=t.f.code[e];x(i.opcode===R.OP_JMP&&(0===i.A||i.A>=n)),E.SETARG_A(i,n)}},t.exports.luaK_patchlist=Z,t.exports.luaK_patchtohere=W,t.exports.luaK_posfix=function(t,e,n,i,s){let a=S.expkind;switch(e){case O.OPR_AND:x(n.t===U),mt(t,i),i.f=G(t,i.f,n.f),n.to(i);break;case O.OPR_OR:x(n.f===U),mt(t,i),i.t=G(t,i.t,n.t),n.to(i);break;case O.OPR_CONCAT:{xt(t,i);let e=D(t,i);i.k===a.VRELOCABLE&&e.opcode===R.OP_CONCAT?(x(n.u.info===e.B-1),ot(t,n),E.SETARG_B(e,n.u.info),n.k=a.VRELOCABLE,n.u.info=i.u.info):(At(t,i),Rt(t,R.OP_CONCAT,n,i,s));break}case O.OPR_ADD:case O.OPR_SUB:case O.OPR_MUL:case O.OPR_DIV:case O.OPR_IDIV:case O.OPR_MOD:case O.OPR_POW:case O.OPR_BAND:case O.OPR_BOR:case O.OPR_BXOR:case O.OPR_SHL:case O.OPR_SHR:kt(e+r,n,i)||Rt(t,e+R.OP_ADD,n,i,s);break;case O.OPR_EQ:case O.OPR_LT:case O.OPR_LE:case O.OPR_NE:case O.OPR_GT:case O.OPR_GE:!function(t,e,n,i){let r,s=S.expkind;n.k===s.VK?r=E.RKASK(n.u.info):(x(n.k===s.VNONRELOC),r=n.u.info);let a=Tt(t,i);switch(lt(t,n,i),e){case O.OPR_NE:n.u.info=j(t,R.OP_EQ,0,r,a);break;case O.OPR_GT:case O.OPR_GE:{let i=e-O.OPR_NE+R.OP_EQ;n.u.info=j(t,i,1,a,r);break}default:{let i=e-O.OPR_EQ+R.OP_EQ;n.u.info=j(t,i,1,r,a);break}}n.k=s.VJMP}(t,e,n,i)}return n},t.exports.luaK_prefix=function(t,e,n,i){let r=new S.expdesc;switch(r.k=S.expkind.VKINT,r.u.ival=r.u.nval=r.u.info=0,r.t=U,r.f=U,e){case C.OPR_MINUS:case C.OPR_BNOT:if(kt(e+p,n,r))break;case C.OPR_LEN:!function(t,e,n,i){let r=yt(t,n);ot(t,n),n.u.info=Q(t,e,0,r,0),n.k=S.expkind.VRELOCABLE,It(t,i)}(t,e+R.OP_UNM,n,i);break;case C.OPR_NOT:!function(t,e){let n=S.expkind;switch(mt(t,e),e.k){case n.VNIL:case n.VFALSE:e.k=n.VTRUE;break;case n.VK:case n.VKFLT:case n.VKINT:case n.VTRUE:e.k=n.VFALSE;break;case n.VJMP:Lt(t,e);break;case n.VRELOCABLE:case n.VNONRELOC:vt(t,e),ot(t,e),e.u.info=Q(t,R.OP_NOT,0,e.u.info,0),e.k=n.VRELOCABLE}{let t=e.f;e.f=e.t,e.t=t}Y(t,e.f),Y(t,e.t)}(t,n)}},t.exports.luaK_reserveregs=st,t.exports.luaK_ret=function(t,e,n){Q(t,R.OP_RETURN,e,n+1,0)},t.exports.luaK_self=function(t,e,n){yt(t,e);let i=e.u.info;ot(t,e),e.u.info=t.freereg,e.k=S.expkind.VNONRELOC,st(t,2),Q(t,R.OP_SELF,e.u.info,i,Tt(t,n)),ot(t,n)},t.exports.luaK_setlist=function(t,e,n,r){let s=(n-1)/E.LFIELDS_PER_FLUSH+1,a=r===i?0:r;x(0!==r&&r<=E.LFIELDS_PER_FLUSH),s<=E.MAXARG_C?Q(t,R.OP_SETLIST,e,a,s):s<=E.MAXARG_Ax?(Q(t,R.OP_SETLIST,e,a,0),nt(t,s)):T.luaX_syntaxerror(t.ls,y("constructor too long",!0)),t.freereg=e+1},t.exports.luaK_setmultret=function(t,e){ft(t,e,i)},t.exports.luaK_setoneret=pt,t.exports.luaK_setreturns=ft,t.exports.luaK_storevar=function(t,e,n){let i=S.expkind;switch(e.k){case i.VLOCAL:return ot(t,n),void wt(t,n,e.u.info);case i.VUPVAL:{let i=yt(t,n);Q(t,R.OP_SETUPVAL,i,e.u.info,0);break}case i.VINDEXED:{let r=e.u.ind.vt===i.VLOCAL?R.OP_SETTABLE:R.OP_SETTABUP,s=Tt(t,n);Q(t,r,e.u.ind.t,e.u.ind.idx,s);break}}ot(t,n)},t.exports.luaK_stringK=function(t,e){let n=new I(g,e);return ht(t,n,n)}},399:(t,e,n)=>{"use strict";const{LUA_HOOKCOUNT:i,LUA_HOOKLINE:r,LUA_MASKCOUNT:s,LUA_MASKLINE:a,constant_types:{LUA_TBOOLEAN:o,LUA_TNIL:l,LUA_TTABLE:h},thread_status:{LUA_ERRRUN:u,LUA_YIELD:c},from_userstring:d,luastring_eq:f,luastring_indexOf:p,to_luastring:m}=n(696),{api_check:_,lua_assert:g}=n(502),{LUA_IDSIZE:v}=n(254),b=n(660),w=n(179),A=n(196),y=n(641),x=n(853),T=n(451),L=n(809),E=n(420),S=n(917),M=n(371),k=function(t){return g(t.callstatus&L.CIST_LUA),t.l_savedpc-1},R=function(t){return 0!==t.func.value.p.lineinfo.length?t.func.value.p.lineinfo[k(t)]:-1},I=function(t){if(t.status===c){let e=t.ci,n=e.funcOff;e.func=t.stack[e.extra],e.funcOff=e.extra,e.extra=n}},U=function(t,e){g(e<t.upvalues.length);let n=t.upvalues[e].name;return null===n?m("?",!0):n.getstr()},O=function(t,e,n){let i,r=null;if(e.callstatus&L.CIST_LUA){if(n<0)return function(t,e){let n=t.func.value.p.numparams;return e>=t.l_base-t.funcOff-n?null:{pos:t.funcOff+n+e,name:m("(*vararg)",!0)}}(e,-n);i=e.l_base,r=A.luaF_getlocalname(e.func.value.p,n,k(e))}else i=e.funcOff+1;if(null===r){if(!((e===t.ci?t.top:e.next.funcOff)-i>=n&&n>0))return null;r=m("(*temporary)",!0)}return{pos:i+(n-1),name:r}},C=function(t,e){if(null===e||e instanceof x.CClosure)t.source=m("=[JS]",!0),t.linedefined=-1,t.lastlinedefined=-1,t.what=m("J",!0);else{let n=e.p;t.source=n.source?n.source.getstr():m("=?",!0),t.linedefined=n.linedefined,t.lastlinedefined=n.lastlinedefined,t.what=0===t.linedefined?m("main",!0):m("Lua",!0)}t.short_src=x.luaO_chunkid(t.source,v)},B=function(t,e){let n={name:null,funcname:null};return null===e?null:e.callstatus&L.CIST_FIN?(n.name=m("__gc",!0),n.funcname=m("metamethod",!0),n):!(e.callstatus&L.CIST_TAIL)&&e.previous.callstatus&L.CIST_LUA?F(t,e.previous):null},P=function(t,e,n){let i={name:null,funcname:null};if(T.ISK(n)){let e=t.k[T.INDEXK(n)];if(e.ttisstring())return i.name=e.svalue(),i}else{let i=D(t,e,n);if(i&&99===i.funcname[0])return i}return i.name=m("?",!0),i},N=function(t,e){return t<e?-1:t},D=function(t,e,n){let i={name:A.luaF_getlocalname(t,n+1,e),funcname:null};if(i.name)return i.funcname=m("local",!0),i;let r=function(t,e,n){let i=-1,r=0,s=T.OpCodesI;for(let a=0;a<e;a++){let o=t.code[a],l=o.A;switch(o.opcode){case s.OP_LOADNIL:{let t=o.B;l<=n&&n<=l+t&&(i=N(a,r));break}case s.OP_TFORCALL:n>=l+2&&(i=N(a,r));break;case s.OP_CALL:case s.OP_TAILCALL:n>=l&&(i=N(a,r));break;case s.OP_JMP:{let t=a+1+o.sBx;a<t&&t<=e&&t>r&&(r=t);break}default:T.testAMode(o.opcode)&&n===l&&(i=N(a,r))}}return i}(t,e,n),s=T.OpCodesI;if(-1!==r){let e=t.code[r];switch(e.opcode){case s.OP_MOVE:{let n=e.B;if(n<e.A)return D(t,r,n);break}case s.OP_GETTABUP:case s.OP_GETTABLE:{let n=e.C,a=e.B,o=e.opcode===s.OP_GETTABLE?A.luaF_getlocalname(t,a+1,r):U(t,a);return i.name=P(t,r,n).name,i.funcname=o&&f(o,y.LUA_ENV)?m("global",!0):m("field",!0),i}case s.OP_GETUPVAL:return i.name=U(t,e.B),i.funcname=m("upvalue",!0),i;case s.OP_LOADK:case s.OP_LOADKX:{let n=e.opcode===s.OP_LOADK?e.Bx:t.code[r+1].Ax;if(t.k[n].ttisstring())return i.name=t.k[n].svalue(),i.funcname=m("constant",!0),i;break}case s.OP_SELF:{let n=e.C;return i.name=P(t,r,n).name,i.funcname=m("method",!0),i}}}return null},F=function(t,e){let n={name:null,funcname:null},i=0,r=e.func.value.p,s=k(e),a=r.code[s],o=T.OpCodesI;if(e.callstatus&L.CIST_HOOKED)return n.name=m("?",!0),n.funcname=m("hook",!0),n;switch(a.opcode){case o.OP_CALL:case o.OP_TAILCALL:return D(r,s,a.A);case o.OP_TFORCALL:return n.name=m("for iterator",!0),n.funcname=m("for iterator",!0),n;case o.OP_SELF:case o.OP_GETTABUP:case o.OP_GETTABLE:i=S.TMS.TM_INDEX;break;case o.OP_SETTABUP:case o.OP_SETTABLE:i=S.TMS.TM_NEWINDEX;break;case o.OP_ADD:i=S.TMS.TM_ADD;break;case o.OP_SUB:i=S.TMS.TM_SUB;break;case o.OP_MUL:i=S.TMS.TM_MUL;break;case o.OP_MOD:i=S.TMS.TM_MOD;break;case o.OP_POW:i=S.TMS.TM_POW;break;case o.OP_DIV:i=S.TMS.TM_DIV;break;case o.OP_IDIV:i=S.TMS.TM_IDIV;break;case o.OP_BAND:i=S.TMS.TM_BAND;break;case o.OP_BOR:i=S.TMS.TM_BOR;break;case o.OP_BXOR:i=S.TMS.TM_BXOR;break;case o.OP_SHL:i=S.TMS.TM_SHL;break;case o.OP_SHR:i=S.TMS.TM_SHR;break;case o.OP_UNM:i=S.TMS.TM_UNM;break;case o.OP_BNOT:i=S.TMS.TM_BNOT;break;case o.OP_LEN:i=S.TMS.TM_LEN;break;case o.OP_CONCAT:i=S.TMS.TM_CONCAT;break;case o.OP_EQ:i=S.TMS.TM_EQ;break;case o.OP_LT:i=S.TMS.TM_LT;break;case o.OP_LE:i=S.TMS.TM_LE;break;default:return null}return n.name=t.l_G.tmname[i].getstr(),n.funcname=m("metamethod",!0),n},V=function(t,e){let n=t.ci,i=null;if(n.callstatus&L.CIST_LUA){i=function(t,e,n){let i=e.func.value;for(let t=0;t<i.nupvalues;t++)if(i.upvals[t]===n)return{name:U(i.p,t),funcname:m("upvalue",!0)};return null}(0,n,e);let r=function(t,e,n){for(let i=e.l_base;i<e.top;i++)if(t.stack[i]===n)return i;return!1}(t,n,e);!i&&r&&(i=D(n.func.value.p,k(n),r-n.l_base))}return i?x.luaO_pushfstring(t,m(" (%s '%s')",!0),i.funcname,i.name):m("",!0)},G=function(t,e,n){let i=S.luaT_objtypename(t,e);j(t,m("attempt to %s a %s value%s",!0),n,i,V(t,e))},K=function(t,e,n,i){let r;return r=n?x.luaO_chunkid(n.getstr(),v):m("?",!0),x.luaO_pushfstring(t,m("%s:%d: %s",!0),r,i,e)},j=function(t,e,...n){let i=t.ci,r=x.luaO_pushvfstring(t,e,n);i.callstatus&L.CIST_LUA&&K(t,r,i.func.value.p.source,R(i)),z(t)},z=function(t){if(0!==t.errfunc){let e=t.errfunc;x.pushobj2s(t,t.stack[t.top-1]),x.setobjs2s(t,t.top-2,e),w.luaD_callnoyield(t,t.top-2,1)}w.luaD_throw(t,u)};t.exports.luaG_addinfo=K,t.exports.luaG_concaterror=function(t,e,n){(e.ttisstring()||M.cvt2str(e))&&(e=n),G(t,e,m("concatenate",!0))},t.exports.luaG_errormsg=z,t.exports.luaG_opinterror=function(t,e,n,i){!1===M.tonumber(e)&&(n=e),G(t,n,i)},t.exports.luaG_ordererror=function(t,e,n){let i=S.luaT_objtypename(t,e),r=S.luaT_objtypename(t,n);f(i,r)?j(t,m("attempt to compare two %s values",!0),i):j(t,m("attempt to compare %s with %s",!0),i,r)},t.exports.luaG_runerror=j,t.exports.luaG_tointerror=function(t,e,n){!1===M.tointeger(e)&&(n=e),j(t,m("number%s has no integer representation",!0),V(t,n))},t.exports.luaG_traceexec=function(t){let e=t.ci,n=t.hookmask,o=0==--t.hookcount&&n&s;if(o)t.hookcount=t.basehookcount;else if(!(n&a))return;if(e.callstatus&L.CIST_HOOKYIELD)e.callstatus&=~L.CIST_HOOKYIELD;else{if(o&&w.luaD_hook(t,i,-1),n&a){let n=e.func.value.p,i=e.l_savedpc-1,s=0!==n.lineinfo.length?n.lineinfo[i]:-1;(0===i||e.l_savedpc<=t.oldpc||s!==(0!==n.lineinfo.length?n.lineinfo[t.oldpc-1]:-1))&&w.luaD_hook(t,r,s)}t.oldpc=e.l_savedpc,t.status===c&&(o&&(t.hookcount=1),e.l_savedpc--,e.callstatus|=L.CIST_HOOKYIELD,e.funcOff=t.top-1,e.func=t.stack[e.funcOff],w.luaD_throw(t,c))}},t.exports.luaG_typeerror=G,t.exports.lua_gethook=function(t){return t.hook},t.exports.lua_gethookcount=function(t){return t.basehookcount},t.exports.lua_gethookmask=function(t){return t.hookmask},t.exports.lua_getinfo=function(t,e,n){let i,r,s,a;return e=d(e),I(t),62===e[0]?(s=null,a=t.stack[t.top-1],_(t,a.ttisfunction(),"function expected"),e=e.subarray(1),t.top--):(s=n.i_ci,a=s.func,g(s.func.ttisfunction())),r=a.ttisclosure()?a.value:null,i=function(t,e,n,i,r){let s=1;for(;e.length>0;e=e.subarray(1))switch(e[0]){case 83:C(n,i);break;case 108:n.currentline=r&&r.callstatus&L.CIST_LUA?R(r):-1;break;case 117:n.nups=null===i?0:i.nupvalues,null===i||i instanceof x.CClosure?(n.isvararg=!0,n.nparams=0):(n.isvararg=i.p.is_vararg,n.nparams=i.p.numparams);break;case 116:n.istailcall=r?r.callstatus&L.CIST_TAIL:0;break;case 110:{let e=B(t,r);null===e?(n.namewhat=m("",!0),n.name=null):(n.namewhat=e.funcname,n.name=e.name);break}case 76:case 102:break;default:s=0}return s}(t,e,n,r,s),p(e,102)>=0&&(x.pushobj2s(t,a),_(t,t.top<=t.ci.top,"stack overflow")),I(t),p(e,76)>=0&&function(t,e){if(null===e||e instanceof x.CClosure)t.stack[t.top]=new x.TValue(l,null),b.api_incr_top(t);else{let n=e.p.lineinfo,i=E.luaH_new(t);t.stack[t.top]=new x.TValue(h,i),b.api_incr_top(t);let r=new x.TValue(o,!0);for(let t=0;t<n.length;t++)E.luaH_setint(i,n[t],r)}}(t,r),i},t.exports.lua_getlocal=function(t,e,n){let i;if(I(t),null===e)i=t.stack[t.top-1].ttisLclosure()?A.luaF_getlocalname(t.stack[t.top-1].value.p,n,0):null;else{let r=O(t,e.i_ci,n);r?(i=r.name,x.pushobj2s(t,t.stack[r.pos]),_(t,t.top<=t.ci.top,"stack overflow")):i=null}return I(t),i},t.exports.lua_getstack=function(t,e,n){let i,r;if(e<0)return 0;for(i=t.ci;e>0&&i!==t.base_ci;i=i.previous)e--;return 0===e&&i!==t.base_ci?(r=1,n.i_ci=i):r=0,r},t.exports.lua_sethook=function(t,e,n,i){null!==e&&0!==n||(n=0,e=null),t.ci.callstatus&L.CIST_LUA&&(t.oldpc=t.ci.l_savedpc),t.hook=e,t.basehookcount=i,t.hookcount=t.basehookcount,t.hookmask=n},t.exports.lua_setlocal=function(t,e,n){let i;I(t);let r=O(t,e.i_ci,n);return r?(i=r.name,x.setobjs2s(t,r.pos,t.top-1),delete t.stack[--t.top]):i=null,I(t),i}},179:(t,e,n)=>{"use strict";const{LUA_HOOKCALL:i,LUA_HOOKRET:r,LUA_HOOKTAILCALL:s,LUA_MASKCALL:a,LUA_MASKLINE:o,LUA_MASKRET:l,LUA_MINSTACK:h,LUA_MULTRET:u,LUA_SIGNATURE:c,constant_types:{LUA_TCCL:d,LUA_TLCF:f,LUA_TLCL:p,LUA_TNIL:m},thread_status:{LUA_ERRMEM:_,LUA_ERRERR:g,LUA_ERRRUN:v,LUA_ERRSYNTAX:b,LUA_OK:w,LUA_YIELD:A},lua_Debug:y,luastring_indexOf:x,to_luastring:T}=n(696),L=n(660),E=n(399),S=n(196),{api_check:M,lua_assert:k,LUAI_MAXCCALLS:R}=n(502),I=n(853),U=n(451),O=n(517),C=n(809),{luaS_newliteral:B}=n(415),P=n(917),{LUAI_MAXSTACK:N}=n(254),D=n(855),F=n(371),{MBuffer:V}=n(498),G=function(t,e){if(t.top<e)for(;t.top<e;)t.stack[t.top++]=new I.TValue(m,null);else for(;t.top>e;)delete t.stack[--t.top]},K=function(t,e,n){let i=t.top;for(;t.top<n+1;)t.stack[t.top++]=new I.TValue(m,null);switch(e){case _:I.setsvalue2s(t,n,B(t,"not enough memory"));break;case g:I.setsvalue2s(t,n,B(t,"error in error handling"));break;default:I.setobjs2s(t,n,i-1)}for(;t.top>n+1;)delete t.stack[--t.top]},j=N+200,z=function(t,e){k(e<=N||e==j),k(t.stack_last==t.stack.length-C.EXTRA_STACK),t.stack.length=e,t.stack_last=e-C.EXTRA_STACK},H=function(t,e){let n=t.stack.length;if(n>N)nt(t,g);else{let i=t.top+e+C.EXTRA_STACK,r=2*n;r>N&&(r=N),r<i&&(r=i),r>N?(z(t,j),E.luaG_runerror(t,T("stack overflow",!0))):z(t,r)}},X=function(t,e){t.stack_last-t.top<=e&&H(t,e)},q=function(t){let e=function(t){let e=t.top;for(let n=t.ci;null!==n;n=n.previous)e<n.top&&(e=n.top);return k(e<=t.stack_last),e+1}(t),n=e+Math.floor(e/8)+2*C.EXTRA_STACK;n>N&&(n=N),t.stack.length>N&&C.luaE_freeCI(t),e<=N-C.EXTRA_STACK&&n<t.stack.length&&z(t,n)},Y=function(t,e,n){let r=t.stack[e];switch(r.type){case d:case f:{let s=r.type===d?r.value.f:r.value;X(t,h);let o=C.luaE_extendCI(t);o.funcOff=e,o.nresults=n,o.func=r,o.top=t.top+h,k(o.top<=t.stack_last),o.callstatus=0,t.hookmask&a&&Z(t,i,-1);let l=s(t);if("number"!=typeof l||l<0||(0|l)!==l)throw Error("invalid return value from JS function (expected integer)");return L.api_checknelems(t,l),$(t,o,t.top-l,l),!0}case p:{let i,s=r.value.p,o=t.top-e-1,l=s.maxstacksize;if(X(t,l),s.is_vararg)i=Q(t,s,o);else{for(;o<s.numparams;o++)t.stack[t.top++]=new I.TValue(m,null);i=e+1}let h=C.luaE_extendCI(t);return h.funcOff=e,h.nresults=n,h.func=r,h.l_base=i,h.top=i+l,G(t,h.top),h.l_code=s.code,h.l_savedpc=0,h.callstatus=C.CIST_LUA,t.hookmask&a&&J(t,h),!1}default:return X(t,1),tt(t,e,r),Y(t,e,n)}},$=function(t,e,n,i){let s=e.nresults;t.hookmask&(l|o)&&(t.hookmask&l&&Z(t,r,-1),t.oldpc=e.previous.l_savedpc);let a=e.funcOff;return t.ci=e.previous,t.ci.next=null,W(t,n,a,i,s)},W=function(t,e,n,i,r){switch(r){case 0:break;case 1:0===i?t.stack[n].setnilvalue():I.setobjs2s(t,n,e);break;case u:for(let r=0;r<i;r++)I.setobjs2s(t,n+r,e+r);for(let e=t.top;e>=n+i;e--)delete t.stack[e];return t.top=n+i,!1;default:{let s;if(r<=i)for(s=0;s<r;s++)I.setobjs2s(t,n+s,e+s);else{for(s=0;s<i;s++)I.setobjs2s(t,n+s,e+s);for(;s<r;s++)n+s>=t.top?t.stack[n+s]=new I.TValue(m,null):t.stack[n+s].setnilvalue()}break}}let s=n+r;for(let e=t.top;e>=s;e--)delete t.stack[e];return t.top=s,!0},Z=function(t,e,n){let i=t.hook;if(i&&t.allowhook){let r=t.ci,s=t.top,a=r.top,o=new y;o.event=e,o.currentline=n,o.i_ci=r,X(t,h),r.top=t.top+h,k(r.top<=t.stack_last),t.allowhook=0,r.callstatus|=C.CIST_HOOKED,i(t,o),k(!t.allowhook),t.allowhook=1,r.top=a,G(t,s),r.callstatus&=~C.CIST_HOOKED}},J=function(t,e){let n=i;e.l_savedpc++,e.previous.callstatus&C.CIST_LUA&&e.previous.l_code[e.previous.l_savedpc-1].opcode==U.OpCodesI.OP_TAILCALL&&(e.callstatus|=C.CIST_TAIL,n=s),Z(t,n,-1),e.l_savedpc--},Q=function(t,e,n){let i,r=e.numparams,s=t.top-n,a=t.top;for(i=0;i<r&&i<n;i++)I.pushobj2s(t,t.stack[s+i]),t.stack[s+i].setnilvalue();for(;i<r;i++)t.stack[t.top++]=new I.TValue(m,null);return a},tt=function(t,e,n){let i=P.luaT_gettmbyobj(t,n,P.TMS.TM_CALL);i.ttisfunction(i)||E.luaG_typeerror(t,n,T("call",!0)),I.pushobj2s(t,t.stack[t.top-1]);for(let n=t.top-2;n>e;n--)I.setobjs2s(t,n,n-1);I.setobj2s(t,e,i)},et=function(t,e,n){++t.nCcalls>=R&&function(t){t.nCcalls===R?E.luaG_runerror(t,T("JS stack overflow",!0)):t.nCcalls>=R+(R>>3)&&nt(t,g)}(t),Y(t,e,n)||F.luaV_execute(t),t.nCcalls--},nt=function(t,e){if(t.errorJmp)throw t.errorJmp.status=e,t.errorJmp;{let n=t.l_G;if(t.status=e,!n.mainthread.errorJmp){let i=n.panic;throw i&&(K(t,e,t.top),t.ci.top<t.top&&(t.ci.top=t.top),i(t)),new Error(`Aborted ${e}`)}n.mainthread.stack[n.mainthread.top++]=t.stack[t.top-1],nt(n.mainthread,e)}},it=function(t,e,n){let i=t.nCcalls,r={status:w,previous:t.errorJmp};t.errorJmp=r;try{e(t,n)}catch(e){if(r.status===w){let n=t.l_G.atnativeerror;if(n)try{if(r.status=w,L.lua_pushcfunction(t,n),L.lua_pushlightuserdata(t,e),ct(t,t.top-2,1),0!==t.errfunc){let e=t.errfunc;I.pushobj2s(t,t.stack[t.top-1]),I.setobjs2s(t,t.top-2,e),ct(t,t.top-2,1)}r.status=v}catch(t){r.status===w&&(r.status=-1)}else r.status=-1}}return t.errorJmp=r.previous,t.nCcalls=i,r.status},rt=function(t,e){let n=t.ci;k(null!==n.c_k&&0===t.nny),k(n.callstatus&C.CIST_YPCALL||e===A),n.callstatus&C.CIST_YPCALL&&(n.callstatus&=~C.CIST_YPCALL,t.errfunc=n.c_old_errfunc),n.nresults===u&&t.ci.top<t.top&&(t.ci.top=t.top);let i=(0,n.c_k)(t,e,n.c_ctx);L.api_checknelems(t,i),$(t,n,t.top-i,i)},st=function(t,e){for(null!==e&&rt(t,e);t.ci!==t.base_ci;)t.ci.callstatus&C.CIST_LUA?(F.luaV_finishOp(t),F.luaV_execute(t)):rt(t,A)},at=function(t,e){let n=function(t){for(let e=t.ci;null!==e;e=e.previous)if(e.callstatus&C.CIST_YPCALL)return e;return null}(t);if(null===n)return 0;let i=n.extra;return S.luaF_close(t,i),K(t,e,i),t.ci=n,t.allowhook=n.callstatus&C.CIST_OAH,t.nny=0,q(t),t.errfunc=n.c_old_errfunc,1},ot=function(t,e,n){let i=B(t,e);if(0===n)I.pushsvalue2s(t,i),M(t,t.top<=t.ci.top,"stack overflow");else{for(let e=1;e<n;e++)delete t.stack[--t.top];I.setsvalue2s(t,t.top-1,i)}return v},lt=function(t,e){let n=t.top-e,i=t.ci;t.status===w?Y(t,n-1,u)||F.luaV_execute(t):(k(t.status===A),t.status=w,i.funcOff=i.extra,i.func=t.stack[i.funcOff],i.callstatus&C.CIST_LUA?F.luaV_execute(t):(null!==i.c_k&&(e=i.c_k(t,A,i.c_ctx),L.api_checknelems(t,e),n=t.top-e),$(t,i,n,e)),st(t,null))},ht=function(t,e,n,i){let r=t.ci;return L.api_checknelems(t,e),t.nny>0&&(t!==t.l_G.mainthread?E.luaG_runerror(t,T("attempt to yield across a JS-call boundary",!0)):E.luaG_runerror(t,T("attempt to yield from outside a coroutine",!0))),t.status=A,r.extra=r.funcOff,r.callstatus&C.CIST_LUA?M(t,null===i,"hooks cannot continue after yielding"):(r.c_k=i,null!==i&&(r.c_ctx=n),r.funcOff=t.top-e-1,r.func=t.stack[r.funcOff],nt(t,A)),k(r.callstatus&C.CIST_HOOKED),0},ut=function(t,e,n,i,r){let s=t.ci,a=t.allowhook,o=t.nny,l=t.errfunc;t.errfunc=r;let h=it(t,e,n);return h!==w&&(S.luaF_close(t,i),K(t,h,i),t.ci=s,t.allowhook=a,t.nny=o,q(t)),t.errfunc=l,h},ct=function(t,e,n){t.nny++,et(t,e,n),t.nny--};class dt{constructor(t,e,n){this.z=t,this.buff=new V,this.dyd=new O.Dyndata,this.mode=n,this.name=e}}const ft=function(t,e,n){e&&-1===x(e,n[0])&&(I.luaO_pushfstring(t,T("attempt to load a %s chunk (mode is '%s')"),n,e),nt(t,b))},pt=function(t,e){let n,i=e.z.zgetc();i===c[0]?(ft(t,e.mode,T("binary",!0)),n=D.luaU_undump(t,e.z,e.name)):(ft(t,e.mode,T("text",!0)),n=O.luaY_parser(t,e.z,e.buff,e.dyd,e.name,i)),k(n.nupvalues===n.p.upvalues.length),S.luaF_initupvals(t,n)};t.exports.adjust_top=G,t.exports.luaD_call=et,t.exports.luaD_callnoyield=ct,t.exports.luaD_checkstack=X,t.exports.luaD_growstack=H,t.exports.luaD_hook=Z,t.exports.luaD_inctop=function(t){X(t,1),t.stack[t.top++]=new I.TValue(m,null)},t.exports.luaD_pcall=ut,t.exports.luaD_poscall=$,t.exports.luaD_precall=Y,t.exports.luaD_protectedparser=function(t,e,n,i){let r=new dt(e,n,i);t.nny++;let s=ut(t,pt,r,t.top,t.errfunc);return t.nny--,s},t.exports.luaD_rawrunprotected=it,t.exports.luaD_reallocstack=z,t.exports.luaD_throw=nt,t.exports.lua_isyieldable=function(t){return 0===t.nny},t.exports.lua_resume=function(t,e,n){let i=t.nny;if(t.status===w){if(t.ci!==t.base_ci)return ot(t,"cannot resume non-suspended coroutine",n)}else if(t.status!==A)return ot(t,"cannot resume dead coroutine",n);if(t.nCcalls=e?e.nCcalls+1:1,t.nCcalls>=R)return ot(t,"JS stack overflow",n);t.nny=0,L.api_checknelems(t,t.status===w?n+1:n);let r=it(t,lt,n);if(-1===r)r=v;else{for(;r>A&&at(t,r);)r=it(t,st,r);r>A?(t.status=r,K(t,r,t.top),t.ci.top=t.top):k(r===t.status)}return t.nny=i,t.nCcalls--,k(t.nCcalls===(e?e.nCcalls:0)),r},t.exports.lua_yield=function(t,e){ht(t,e,0,null)},t.exports.lua_yieldk=ht},940:(t,e,n)=>{"use strict";const{LUA_SIGNATURE:i,LUA_VERSION_MAJOR:r,LUA_VERSION_MINOR:s,constant_types:{LUA_TBOOLEAN:a,LUA_TLNGSTR:o,LUA_TNIL:l,LUA_TNUMFLT:h,LUA_TNUMINT:u,LUA_TSHRSTR:c},luastring_of:d}=n(696),f=d(25,147,13,10,26,10),p=16*Number(r)+Number(s);class m{constructor(){this.L=null,this.write=null,this.data=null,this.strip=NaN,this.status=NaN}}const _=function(t,e,n){0===n.status&&e>0&&(n.status=n.writer(n.L,t,e,n.data))},g=function(t,e){_(d(t),1,e)},v=function(t,e){let n=new ArrayBuffer(4);new DataView(n).setInt32(0,t,!0);let i=new Uint8Array(n);_(i,4,e)},b=function(t,e){let n=new ArrayBuffer(4);new DataView(n).setInt32(0,t,!0);let i=new Uint8Array(n);_(i,4,e)},w=function(t,e){let n=new ArrayBuffer(8);new DataView(n).setFloat64(0,t,!0);let i=new Uint8Array(n);_(i,8,e)},A=function(t,e){if(null===t)g(0,e);else{let n=t.tsslen()+1,i=t.getstr();n<255?g(n,e):(g(255,e),b(n,e)),_(i,n-1,e)}},y=function(t,e,n){n.strip||t.source===e?A(null,n):A(t.source,n),v(t.linedefined,n),v(t.lastlinedefined,n),g(t.numparams,n),g(t.is_vararg?1:0,n),g(t.maxstacksize,n),function(t,e){let n=t.code.map((t=>t.code));v(n.length,e);for(let t=0;t<n.length;t++)v(n[t],e)}(t,n),function(t,e){let n=t.k.length;v(n,e);for(let i=0;i<n;i++){let n=t.k[i];switch(g(n.ttype(),e),n.ttype()){case l:break;case a:g(n.value?1:0,e);break;case h:w(n.value,e);break;case u:b(n.value,e);break;case c:case o:A(n.tsvalue(),e)}}}(t,n),function(t,e){let n=t.upvalues.length;v(n,e);for(let i=0;i<n;i++)g(t.upvalues[i].instack?1:0,e),g(t.upvalues[i].idx,e)}(t,n),function(t,e){let n=t.p.length;v(n,e);for(let i=0;i<n;i++)y(t.p[i],t.source,e)}(t,n),function(t,e){let n=e.strip?0:t.lineinfo.length;v(n,e);for(let i=0;i<n;i++)v(t.lineinfo[i],e);n=e.strip?0:t.locvars.length,v(n,e);for(let i=0;i<n;i++)A(t.locvars[i].varname,e),v(t.locvars[i].startpc,e),v(t.locvars[i].endpc,e);n=e.strip?0:t.upvalues.length,v(n,e);for(let i=0;i<n;i++)A(t.upvalues[i].name,e)}(t,n)};t.exports.luaU_dump=function(t,e,n,r,s){let a=new m;return a.L=t,a.writer=n,a.data=r,a.strip=s,a.status=0,function(t){_(i,i.length,t),g(p,t),g(0,t),_(f,f.length,t),g(4,t),g(4,t),g(4,t),g(4,t),g(8,t),b(22136,t),w(370.5,t)}(a),g(e.upvalues.length,a),y(e,null,a),a.status}},196:(t,e,n)=>{"use strict";const{constant_types:{LUA_TNIL:i}}=n(696),r=n(853);t.exports.MAXUPVAL=255,t.exports.Proto=class{constructor(t){this.id=t.l_G.id_counter++,this.k=[],this.p=[],this.code=[],this.cache=null,this.lineinfo=[],this.upvalues=[],this.numparams=0,this.is_vararg=!1,this.maxstacksize=0,this.locvars=[],this.linedefined=0,this.lastlinedefined=0,this.source=null}},t.exports.luaF_findupval=function(t,e){return t.stack[e]},t.exports.luaF_close=function(t,e){for(let n=e;n<t.top;n++){let e=t.stack[n];t.stack[n]=new r.TValue(e.type,e.value)}},t.exports.luaF_getlocalname=function(t,e,n){for(let i=0;i<t.locvars.length&&t.locvars[i].startpc<=n;i++)if(n<t.locvars[i].endpc&&0===--e)return t.locvars[i].varname.getstr();return null},t.exports.luaF_initupvals=function(t,e){for(let t=0;t<e.nupvalues;t++)e.upvals[t]=new r.TValue(i,null)},t.exports.luaF_newLclosure=function(t,e){return new r.LClosure(t,e)}},637:(t,e,n)=>{"use strict";const{luastring_of:i}=n(696),r=i(0,0,0,0,0,0,0,0,0,0,8,8,8,8,8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,12,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,22,22,22,22,22,22,22,22,22,22,4,4,4,4,4,4,4,21,21,21,21,21,21,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,4,4,4,4,5,4,21,21,21,21,21,21,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,4,4,4,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);t.exports.lisdigit=function(t){return!!(2&r[t+1])},t.exports.lislalnum=function(t){return!!(3&r[t+1])},t.exports.lislalpha=function(t){return!!(1&r[t+1])},t.exports.lisprint=function(t){return!!(4&r[t+1])},t.exports.lisspace=function(t){return!!(8&r[t+1])},t.exports.lisxdigit=function(t){return!!(16&r[t+1])}},641:(t,e,n)=>{"use strict";const{constant_types:{LUA_TBOOLEAN:i,LUA_TLNGSTR:r},thread_status:{LUA_ERRSYNTAX:s},to_luastring:a}=n(696),{LUA_MINBUFFER:o,MAX_INT:l,lua_assert:h}=n(502),u=n(399),c=n(179),{lisdigit:d,lislalnum:f,lislalpha:p,lisspace:m,lisxdigit:_}=n(637),g=n(853),{luaS_bless:v,luaS_hash:b,luaS_hashlongstr:w,luaS_new:A}=n(415),y=n(420),{EOZ:x,luaZ_buffer:T,luaZ_buffremove:L,luaZ_resetbuffer:E,luaZ_resizebuffer:S}=n(498),M=257,k=a("_ENV",!0),R=289,I=290,U=293,O={TK_AND:257,TK_BREAK:258,TK_DO:259,TK_ELSE:260,TK_ELSEIF:261,TK_END:262,TK_FALSE:263,TK_FOR:264,TK_FUNCTION:265,TK_GOTO:266,TK_IF:267,TK_IN:268,TK_LOCAL:269,TK_NIL:270,TK_NOT:271,TK_OR:272,TK_REPEAT:273,TK_RETURN:274,TK_THEN:275,TK_TRUE:276,TK_UNTIL:277,TK_WHILE:278,TK_IDIV:279,TK_CONCAT:280,TK_DOTS:281,TK_EQ:282,TK_GE:283,TK_LE:284,TK_NE:285,TK_SHL:286,TK_SHR:287,TK_DBCOLON:288,TK_EOS:R,TK_FLT:I,TK_INT:291,TK_NAME:292,TK_STRING:U},C=["and","break","do","else","elseif","end","false","for","function","goto","if","in","local","nil","not","or","repeat","return","then","true","until","while","//","..","...","==",">=","<=","~=","<<",">>","::","<eof>","<number>","<integer>","<name>","<string>"].map(((t,e)=>a(t)));class B{constructor(){this.r=NaN,this.i=NaN,this.ts=null}}class P{constructor(){this.token=NaN,this.seminfo=new B}}const N=function(t,e){let n=t.buff;if(n.n+1>n.buffer.length){n.buffer.length>=l/2&&Y(t,a("lexical element too long",!0),0);let e=2*n.buffer.length;S(t.L,n,e)}n.buffer[n.n++]=e<0?255+e+1:e},D=function(t,e){if(e<M)return g.luaO_pushfstring(t.L,a("'%c'",!0),e);{let n=C[e-M];return e<R?g.luaO_pushfstring(t.L,a("'%s'",!0),n):n}},F=function(t){return 10===t.current||13===t.current},V=function(t){t.current=t.z.zgetc()},G=function(t){N(t,t.current),V(t)},K=new g.TValue(i,!0),j=function(t,e){let n=t.L,i=A(n,e),s=t.h.strong.get(w(i));if(s)i=s.key.tsvalue();else{let e=new g.TValue(r,i);y.luaH_setfrom(n,t.h,e,K)}return i},z=function(t){let e=t.current;h(F(t)),V(t),F(t)&&t.current!==e&&V(t),++t.linenumber>=l&&Y(t,a("chunk has too many lines",!0),0)},H=function(t,e){return t.current===e&&(V(t),!0)},X=function(t,e){return(t.current===e[0].charCodeAt(0)||t.current===e[1].charCodeAt(0))&&(G(t),!0)},q=function(t,e){let n="Ee",i=t.current;for(h(d(t.current)),G(t),48===i&&X(t,"xX")&&(n="Pp");;)if(X(t,n)&&X(t,"-+"),_(t.current))G(t);else{if(46!==t.current)break;G(t)}let r=new g.TValue;return 0===g.luaO_str2num(T(t.buff),r)&&Y(t,a("malformed number",!0),I),r.ttisinteger()?(e.i=r.value,291):(h(r.ttisfloat()),e.r=r.value,I)},Y=function(t,e,n){e=u.luaG_addinfo(t.L,e,t.source,t.linenumber),n&&g.luaO_pushfstring(t.L,a("%s near %s"),e,function(t,e){switch(e){case 292:case U:case I:case 291:return g.luaO_pushfstring(t.L,a("'%s'",!0),T(t.buff));default:return D(t,e)}}(t,n)),c.luaD_throw(t.L,s)},$=function(t){let e=0,n=t.current;for(h(91===n||93===n),G(t);61===t.current;)G(t),e++;return t.current===n?e:-e-1},W=function(t,e,n){let i=t.linenumber;G(t),F(t)&&z(t);let r=!1;for(;!r;)switch(t.current){case x:Y(t,a(`unfinished long ${e?"string":"comment"} (starting at line ${i})`),R);break;case 93:$(t)===n&&(G(t),r=!0);break;case 10:case 13:N(t,10),z(t),e||E(t.buff);break;default:e?G(t):V(t)}e&&(e.ts=j(t,t.buff.buffer.subarray(2+n,t.buff.n-(2+n))))},Z=function(t,e,n){e||(t.current!==x&&G(t),Y(t,n,U))},J=function(t){return G(t),Z(t,_(t.current),a("hexadecimal digit expected",!0)),g.luaO_hexavalue(t.current)},Q=function(t){let e=J(t);return e=(e<<4)+J(t),L(t.buff,2),e},tt=function(t){let e=new Uint8Array(g.UTF8BUFFSZ),n=g.luaO_utf8esc(e,function(t){let e=4;G(t),Z(t,123===t.current,a("missing '{'",!0));let n=J(t);for(G(t);_(t.current);)e++,n=(n<<4)+g.luaO_hexavalue(t.current),Z(t,n<=1114111,a("UTF-8 value too large",!0)),G(t);return Z(t,125===t.current,a("missing '}'",!0)),V(t),L(t.buff,e),n}(t));for(;n>0;n--)N(t,e[g.UTF8BUFFSZ-n])},et=function(t){let e,n=0;for(e=0;e<3&&d(t.current);e++)n=10*n+t.current-48,G(t);return Z(t,n<=255,a("decimal escape too large",!0)),L(t.buff,e),n},nt=function(t,e,n){for(G(t);t.current!==e;)switch(t.current){case x:Y(t,a("unfinished string",!0),R);break;case 10:case 13:Y(t,a("unfinished string",!0),U);break;case 92:{let e,n;switch(G(t),t.current){case 97:n=7,e="read_save";break;case 98:n=8,e="read_save";break;case 102:n=12,e="read_save";break;case 110:n=10,e="read_save";break;case 114:n=13,e="read_save";break;case 116:n=9,e="read_save";break;case 118:n=11,e="read_save";break;case 120:n=Q(t),e="read_save";break;case 117:tt(t),e="no_save";break;case 10:case 13:z(t),n=10,e="only_save";break;case 92:case 34:case 39:n=t.current,e="read_save";break;case x:e="no_save";break;case 122:for(L(t.buff,1),V(t);m(t.current);)F(t)?z(t):V(t);e="no_save";break;default:Z(t,d(t.current),a("invalid escape sequence",!0)),n=et(t),e="only_save"}"read_save"===e&&V(t),"read_save"!==e&&"only_save"!==e||(L(t.buff,1),N(t,n));break}default:G(t)}G(t),n.ts=j(t,t.buff.buffer.subarray(1,t.buff.n-1))},it=Object.create(null);C.forEach(((t,e)=>it[b(t)]=e));const rt=function(t,e){for(E(t.buff);;)switch(h("number"==typeof t.current),t.current){case 10:case 13:z(t);break;case 32:case 12:case 9:case 11:V(t);break;case 45:if(V(t),45!==t.current)return 45;if(V(t),91===t.current){let e=$(t);if(E(t.buff),e>=0){W(t,null,e),E(t.buff);break}}for(;!F(t)&&t.current!==x;)V(t);break;case 91:{let n=$(t);return n>=0?(W(t,e,n),U):(-1!==n&&Y(t,a("invalid long string delimiter",!0),U),91)}case 61:return V(t),H(t,61)?282:61;case 60:return V(t),H(t,61)?284:H(t,60)?286:60;case 62:return V(t),H(t,61)?283:H(t,62)?287:62;case 47:return V(t),H(t,47)?279:47;case 126:return V(t),H(t,61)?285:126;case 58:return V(t),H(t,58)?288:58;case 34:case 39:return nt(t,t.current,e),U;case 46:return G(t),H(t,46)?H(t,46)?281:280:d(t.current)?q(t,e):46;case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:return q(t,e);case x:return R;default:if(p(t.current)){do{G(t)}while(f(t.current));let n=j(t,T(t.buff));e.ts=n;let i=it[w(n)];return void 0!==i&&i<=22?i+M:292}{let e=t.current;return V(t),e}}};t.exports.FIRST_RESERVED=M,t.exports.LUA_ENV=k,t.exports.LexState=class{constructor(){this.current=NaN,this.linenumber=NaN,this.lastline=NaN,this.t=new P,this.lookahead=new P,this.fs=null,this.L=null,this.z=null,this.buff=null,this.h=null,this.dyd=null,this.source=null,this.envn=null}},t.exports.RESERVED=O,t.exports.isreserved=function(t){let e=it[w(t)];return void 0!==e&&e<=22},t.exports.luaX_lookahead=function(t){return h(t.lookahead.token===R),t.lookahead.token=rt(t,t.lookahead.seminfo),t.lookahead.token},t.exports.luaX_newstring=j,t.exports.luaX_next=function(t){t.lastline=t.linenumber,t.lookahead.token!==R?(t.t.token=t.lookahead.token,t.t.seminfo.i=t.lookahead.seminfo.i,t.t.seminfo.r=t.lookahead.seminfo.r,t.t.seminfo.ts=t.lookahead.seminfo.ts,t.lookahead.token=R):t.t.token=rt(t,t.t.seminfo)},t.exports.luaX_setinput=function(t,e,n,i,r){e.t={token:0,seminfo:new B},e.L=t,e.current=r,e.lookahead={token:R,seminfo:new B},e.z=n,e.fs=null,e.linenumber=1,e.lastline=1,e.source=i,e.envn=v(t,k),S(t,e.buff,o)},t.exports.luaX_syntaxerror=function(t,e){Y(t,e,t.t.token)},t.exports.luaX_token2str=D,t.exports.luaX_tokens=C},502:(t,e,n)=>{"use strict";const{luai_apicheck:i}=n(254),r=function(t){if(!t)throw Error("assertion failed")};t.exports.lua_assert=r,t.exports.luai_apicheck=i||function(t,e){return r(e)};t.exports.api_check=function(t,e,n){return i(t,e&&n)};t.exports.LUAI_MAXCCALLS=200;t.exports.LUA_MINBUFFER=32;t.exports.luai_nummod=function(t,e,n){let i=e%n;return i*n<0&&(i+=n),i};t.exports.MAX_INT=2147483647;t.exports.MIN_INT=-2147483648},853:(t,e,n)=>{"use strict";const{LUA_OPADD:i,LUA_OPBAND:r,LUA_OPBNOT:s,LUA_OPBOR:a,LUA_OPBXOR:o,LUA_OPDIV:l,LUA_OPIDIV:h,LUA_OPMOD:u,LUA_OPMUL:c,LUA_OPPOW:d,LUA_OPSHL:f,LUA_OPSHR:p,LUA_OPSUB:m,LUA_OPUNM:_,constant_types:{LUA_NUMTAGS:g,LUA_TBOOLEAN:v,LUA_TCCL:b,LUA_TFUNCTION:w,LUA_TLCF:A,LUA_TLCL:y,LUA_TLIGHTUSERDATA:x,LUA_TLNGSTR:T,LUA_TNIL:L,LUA_TNUMBER:E,LUA_TNUMFLT:S,LUA_TNUMINT:M,LUA_TSHRSTR:k,LUA_TSTRING:R,LUA_TTABLE:I,LUA_TTHREAD:U,LUA_TUSERDATA:O},from_userstring:C,luastring_indexOf:B,luastring_of:P,to_jsstring:N,to_luastring:D}=n(696),{lisdigit:F,lisprint:V,lisspace:G,lisxdigit:K}=n(637),j=n(399),z=n(179),H=n(809),{luaS_bless:X,luaS_new:q}=n(415),Y=n(420),{LUA_COMPAT_FLOATSTRING:$,ldexp:W,lua_integer2str:Z,lua_number2str:J}=n(254),Q=n(371),{MAX_INT:tt,luai_nummod:et,lua_assert:nt}=n(502),it=n(917),rt=g,st=g+1;class at{constructor(t,e){this.type=t,this.value=e}ttype(){return 63&this.type}ttnov(){return 15&this.type}checktag(t){return this.type===t}checktype(t){return this.ttnov()===t}ttisnumber(){return this.checktype(E)}ttisfloat(){return this.checktag(S)}ttisinteger(){return this.checktag(M)}ttisnil(){return this.checktag(L)}ttisboolean(){return this.checktag(v)}ttislightuserdata(){return this.checktag(x)}ttisstring(){return this.checktype(R)}ttisshrstring(){return this.checktag(k)}ttislngstring(){return this.checktag(T)}ttistable(){return this.checktag(I)}ttisfunction(){return this.checktype(w)}ttisclosure(){return(31&this.type)===w}ttisCclosure(){return this.checktag(b)}ttisLclosure(){return this.checktag(y)}ttislcf(){return this.checktag(A)}ttisfulluserdata(){return this.checktag(O)}ttisthread(){return this.checktag(U)}ttisdeadkey(){return this.checktag(st)}l_isfalse(){return this.ttisnil()||this.ttisboolean()&&!1===this.value}setfltvalue(t){this.type=S,this.value=t}chgfltvalue(t){nt(this.type==S),this.value=t}setivalue(t){this.type=M,this.value=t}chgivalue(t){nt(this.type==M),this.value=t}setnilvalue(){this.type=L,this.value=null}setfvalue(t){this.type=A,this.value=t}setpvalue(t){this.type=x,this.value=t}setbvalue(t){this.type=v,this.value=t}setsvalue(t){this.type=T,this.value=t}setuvalue(t){this.type=O,this.value=t}setthvalue(t){this.type=U,this.value=t}setclLvalue(t){this.type=y,this.value=t}setclCvalue(t){this.type=b,this.value=t}sethvalue(t){this.type=I,this.value=t}setdeadvalue(){this.type=st,this.value=null}setfrom(t){this.type=t.type,this.value=t.value}tsvalue(){return nt(this.ttisstring()),this.value}svalue(){return this.tsvalue().getstr()}vslen(){return this.tsvalue().tsslen()}jsstring(t,e){return N(this.svalue(),t,e,!0)}}const ot=function(t,e,n){t.stack[e].setsvalue(n)},lt=new at(L,null);Object.freeze(lt),t.exports.luaO_nilobject=lt;class ht{constructor(t,e){this.id=t.l_G.id_counter++,this.p=null,this.nupvalues=e,this.upvals=new Array(e)}}class ut{constructor(t,e,n){for(this.id=t.l_G.id_counter++,this.f=e,this.nupvalues=n,this.upvalue=new Array(n);n--;)this.upvalue[n]=new at(L,null)}}class ct{constructor(t,e){this.id=t.l_G.id_counter++,this.metatable=null,this.uservalue=new at(L,null),this.len=e,this.data=Object.create(null)}}const dt=D("..."),ft=D('[string "'),pt=D('"]'),mt=function(t){return F(t)?t-48:(223&t)-55},_t=function(t,e){let n=1;if(nt(e<=1114111),e<128)t[7]=e;else{let i=63;do{t[8-n++]=128|63&e,e>>=6,i>>=1}while(e>i);t[8-n]=~i<<1|e}return n},gt=function(t,e){let n="x"===e?function(t){let e,n=0,i=0,r=0,s=0,a=0,o=!1;for(;G(t[n]);)n++;if(((e=45===t[n])||43===t[n])&&n++,48!==t[n]||120!==t[n+1]&&88!==t[n+1])return null;for(n+=2;;n++)if(46===t[n]){if(o)break;o=!0}else{if(!K(t[n]))break;0===r&&48===t[n]?s++:++r<=30?i=16*i+mt(t[n]):a++,o&&a--}if(s+r===0)return null;if(a*=4,112===t[n]||80===t[n]){let e,i=0;if(n++,((e=45===t[n])||43===t[n])&&n++,!F(t[n]))return null;for(;F(t[n]);)i=10*i+t[n++]-48;e&&(i=-i),a+=i}return e&&(i=-i),{n:W(i,a),i:n}}(t):function(t){try{t=N(t)}catch(t){return null}let e=/^[\t\v\f \n\r]*[+-]?(?:[0-9]+\.?[0-9]*|\.[0-9]*)(?:[eE][+-]?[0-9]+)?/.exec(t);if(!e)return null;let n=parseFloat(e[0]);return isNaN(n)?null:{n,i:e[0].length}}(t);if(null===n)return null;for(;G(t[n.i]);)n.i++;return n.i===t.length||0===t[n.i]?n:null},vt=[46,120,88,110,78],bt={46:".",120:"x",88:"x",110:"n",78:"n"},wt=Math.floor(tt/10),At=tt%10,yt=function(t,e){let n;if(e.ttisinteger())n=D(Z(e.value));else{let t=J(e.value);!$&&/^[-0123456789]+$/.test(t)&&(t+=".0"),n=D(t)}e.setsvalue(X(t,n))},xt=function(t,e){z.luaD_inctop(t),ot(t,t.top-1,q(t,e))},Tt=function(t,e,n){let i,r=0,s=0,a=0;for(;i=B(e,37,s),-1!=i;){switch(xt(t,e.subarray(s,i)),e[i+1]){case 115:{let e=n[a++];if(null===e)e=D("(null)",!0);else{e=C(e);let t=B(e,0);-1!==t&&(e=e.subarray(0,t))}xt(t,e);break}case 99:{let e=n[a++];V(e)?xt(t,P(e)):Lt(t,D("<\\%d>",!0),e);break}case 100:case 73:z.luaD_inctop(t),t.stack[t.top-1].setivalue(n[a++]),yt(t,t.stack[t.top-1]);break;case 102:z.luaD_inctop(t),t.stack[t.top-1].setfltvalue(n[a++]),yt(t,t.stack[t.top-1]);break;case 112:{let e=n[a++];if(e instanceof H.lua_State||e instanceof Y.Table||e instanceof ct||e instanceof ht||e instanceof ut)xt(t,D("0x"+e.id.toString(16)));else switch(typeof e){case"undefined":xt(t,D("undefined"));break;case"number":xt(t,D("Number("+e+")"));break;case"string":xt(t,D("String("+JSON.stringify(e)+")"));break;case"boolean":xt(t,D(e?"Boolean(true)":"Boolean(false)"));break;case"object":if(null===e){xt(t,D("null"));break}case"function":{let n=t.l_G.ids.get(e);n||(n=t.l_G.id_counter++,t.l_G.ids.set(e,n)),xt(t,D("0x"+n.toString(16)));break}default:xt(t,D("<id NYI>"))}break}case 85:{let e=new Uint8Array(8),i=_t(e,n[a++]);xt(t,e.subarray(8-i));break}case 37:xt(t,D("%",!0));break;default:j.luaG_runerror(t,D("invalid option '%%%c' to 'lua_pushfstring'"),e[i+1])}r+=2,s=i+2}return z.luaD_checkstack(t,1),xt(t,e.subarray(s)),r>0&&Q.luaV_concat(t,r+1),t.stack[t.top-1].svalue()},Lt=function(t,e,...n){return Tt(t,e,n)},Et=function(t,e,n,l){switch(e){case i:return n+l|0;case m:return n-l|0;case c:return Q.luaV_imul(n,l);case u:return Q.luaV_mod(t,n,l);case h:return Q.luaV_div(t,n,l);case r:return n&l;case a:return n|l;case o:return n^l;case f:return Q.luaV_shiftl(n,l);case p:return Q.luaV_shiftl(n,-l);case _:return 0-n|0;case s:return~n;default:nt(0)}},St=function(t,e,n,r){switch(e){case i:return n+r;case m:return n-r;case c:return n*r;case l:return n/r;case d:return Math.pow(n,r);case h:return Math.floor(n/r);case _:return-n;case u:return et(t,n,r);default:nt(0)}};t.exports.CClosure=ut,t.exports.LClosure=ht,t.exports.LUA_TDEADKEY=st,t.exports.LUA_TPROTO=rt,t.exports.LocVar=class{constructor(){this.varname=null,this.startpc=NaN,this.endpc=NaN}},t.exports.TValue=at,t.exports.Udata=ct,t.exports.UTF8BUFFSZ=8,t.exports.luaO_arith=function(t,e,n,h,u){let c="number"==typeof u?t.stack[u]:u;switch(e){case r:case a:case o:case f:case p:case s:{let i,r;if(!1!==(i=Q.tointeger(n))&&!1!==(r=Q.tointeger(h)))return void c.setivalue(Et(t,e,i,r));break}case l:case d:{let i,r;if(!1!==(i=Q.tonumber(n))&&!1!==(r=Q.tonumber(h)))return void c.setfltvalue(St(t,e,i,r));break}default:{let i,r;if(n.ttisinteger()&&h.ttisinteger())return void c.setivalue(Et(t,e,n.value,h.value));if(!1!==(i=Q.tonumber(n))&&!1!==(r=Q.tonumber(h)))return void c.setfltvalue(St(t,e,i,r));break}}nt(null!==t),it.luaT_trybinTM(t,n,h,u,e-i+it.TMS.TM_ADD)},t.exports.luaO_chunkid=function(t,e){let n,i=t.length;if(61===t[0])i<e?(n=new Uint8Array(i-1),n.set(t.subarray(1))):(n=new Uint8Array(e),n.set(t.subarray(1,e+1)));else if(64===t[0])i<=e?(n=new Uint8Array(i-1),n.set(t.subarray(1))):(n=new Uint8Array(e),n.set(dt),e-=dt.length,n.set(t.subarray(i-e),dt.length));else{n=new Uint8Array(e);let r=B(t,10);n.set(ft);let s=ft.length;i<(e-=ft.length+dt.length+pt.length)&&-1===r?(n.set(t,s),s+=t.length):(-1!==r&&(i=r),i>e&&(i=e),n.set(t.subarray(0,i),s),s+=i,n.set(dt,s),s+=dt.length),n.set(pt,s),s+=pt.length,n=n.subarray(0,s)}return n},t.exports.luaO_hexavalue=mt,t.exports.luaO_int2fb=function(t){let e=0;if(t<8)return t;for(;t>=128;)t=t+15>>4,e+=4;for(;t>=16;)t=t+1>>1,e++;return e+1<<3|t-8},t.exports.luaO_pushfstring=Lt,t.exports.luaO_pushvfstring=Tt,t.exports.luaO_str2num=function(t,e){let n=function(t){let e,n=0,i=0,r=!0;for(;G(t[n]);)n++;if(((e=45===t[n])||43===t[n])&&n++,48!==t[n]||120!==t[n+1]&&88!==t[n+1])for(;n<t.length&&F(t[n]);n++){let s=t[n]-48;if(i>=wt&&(i>wt||s>At+e))return null;i=10*i+s|0,r=!1}else for(n+=2;n<t.length&&K(t[n]);n++)i=16*i+mt(t[n])|0,r=!1;for(;n<t.length&&G(t[n]);)n++;return r||n!==t.length&&0!==t[n]?null:{n:0|(e?-i:i),i:n}}(t);return null!==n?(e.setivalue(n.n),n.i+1):(n=function(t){let e=t.length,n=0;for(let i=0;i<e;i++){let e=t[i];if(-1!==vt.indexOf(e)){n=e;break}}let i=bt[n];return"n"===i?null:gt(t,i)}(t),null!==n?(e.setfltvalue(n.n),n.i+1):0)},t.exports.luaO_tostring=yt,t.exports.luaO_utf8esc=_t,t.exports.numarith=St,t.exports.pushobj2s=function(t,e){t.stack[t.top++]=new at(e.type,e.value)},t.exports.pushsvalue2s=function(t,e){t.stack[t.top++]=new at(T,e)},t.exports.setobjs2s=function(t,e,n){t.stack[e].setfrom(t.stack[n])},t.exports.setobj2s=function(t,e,n){t.stack[e].setfrom(n)},t.exports.setsvalue2s=ot},451:t=>{"use strict";const e=[96,113,65,84,80,80,92,108,60,16,60,84,108,124,124,124,124,124,124,124,124,124,124,124,124,96,96,96,96,104,34,188,188,188,132,228,84,84,16,98,98,4,98,20,81,80,23],n=18,i=14,r=i,s=262143,a=131071,o=256,l=function(t,e){return~(-1<<t)<<e},h=function(t,e){return~l(t,e)},u=function(t,e,n,i){return t.code=t.code&h(i,n)|e<<n&l(i,n),d(t)},c=function(t,e){return u(t,e,r,n)},d=function(t){if("number"==typeof t)return{code:t,opcode:t&l(6,0),A:t>>6&l(8,0),B:t>>23&l(9,0),C:t>>i&l(9,0),Bx:t>>r&l(n,0),Ax:t>>6&l(26,0),sBx:(t>>r&l(n,0))-a};{let e=t.code;return t.opcode=e&l(6,0),t.A=e>>6&l(8,0),t.B=e>>23&l(9,0),t.C=e>>i&l(9,0),t.Bx=e>>r&l(n,0),t.Ax=e>>6&l(26,0),t.sBx=(e>>r&l(n,0))-a,t}};t.exports.BITRK=o,t.exports.CREATE_ABC=function(t,e,n,r){return d(t|e<<6|n<<23|r<<i)},t.exports.CREATE_ABx=function(t,e,n){return d(t|e<<6|n<<r)},t.exports.CREATE_Ax=function(t,e){return d(t|e<<6)},t.exports.GET_OPCODE=function(t){return t.opcode},t.exports.GETARG_A=function(t){return t.A},t.exports.GETARG_B=function(t){return t.B},t.exports.GETARG_C=function(t){return t.C},t.exports.GETARG_Bx=function(t){return t.Bx},t.exports.GETARG_Ax=function(t){return t.Ax},t.exports.GETARG_sBx=function(t){return t.sBx},t.exports.INDEXK=function(t){return-257&t},t.exports.ISK=function(t){return t&o},t.exports.LFIELDS_PER_FLUSH=50,t.exports.MAXARG_A=255,t.exports.MAXARG_Ax=67108863,t.exports.MAXARG_B=511,t.exports.MAXARG_Bx=s,t.exports.MAXARG_C=511,t.exports.MAXARG_sBx=a,t.exports.MAXINDEXRK=255,t.exports.NO_REG=255,t.exports.OpArgK=3,t.exports.OpArgN=0,t.exports.OpArgR=2,t.exports.OpArgU=1,t.exports.OpCodes=["MOVE","LOADK","LOADKX","LOADBOOL","LOADNIL","GETUPVAL","GETTABUP","GETTABLE","SETTABUP","SETUPVAL","SETTABLE","NEWTABLE","SELF","ADD","SUB","MUL","MOD","POW","DIV","IDIV","BAND","BOR","BXOR","SHL","SHR","UNM","BNOT","NOT","LEN","CONCAT","JMP","EQ","LT","LE","TEST","TESTSET","CALL","TAILCALL","RETURN","FORLOOP","FORPREP","TFORCALL","TFORLOOP","SETLIST","CLOSURE","VARARG","EXTRAARG"],t.exports.OpCodesI={OP_MOVE:0,OP_LOADK:1,OP_LOADKX:2,OP_LOADBOOL:3,OP_LOADNIL:4,OP_GETUPVAL:5,OP_GETTABUP:6,OP_GETTABLE:7,OP_SETTABUP:8,OP_SETUPVAL:9,OP_SETTABLE:10,OP_NEWTABLE:11,OP_SELF:12,OP_ADD:13,OP_SUB:14,OP_MUL:15,OP_MOD:16,OP_POW:17,OP_DIV:18,OP_IDIV:19,OP_BAND:20,OP_BOR:21,OP_BXOR:22,OP_SHL:23,OP_SHR:24,OP_UNM:25,OP_BNOT:26,OP_NOT:27,OP_LEN:28,OP_CONCAT:29,OP_JMP:30,OP_EQ:31,OP_LT:32,OP_LE:33,OP_TEST:34,OP_TESTSET:35,OP_CALL:36,OP_TAILCALL:37,OP_RETURN:38,OP_FORLOOP:39,OP_FORPREP:40,OP_TFORCALL:41,OP_TFORLOOP:42,OP_SETLIST:43,OP_CLOSURE:44,OP_VARARG:45,OP_EXTRAARG:46},t.exports.POS_A=6,t.exports.POS_Ax=6,t.exports.POS_B=23,t.exports.POS_Bx=r,t.exports.POS_C=i,t.exports.POS_OP=0,t.exports.RKASK=function(t){return t|o},t.exports.SETARG_A=function(t,e){return u(t,e,6,8)},t.exports.SETARG_Ax=function(t,e){return u(t,e,6,26)},t.exports.SETARG_B=function(t,e){return u(t,e,23,9)},t.exports.SETARG_Bx=c,t.exports.SETARG_C=function(t,e){return u(t,e,i,9)},t.exports.SETARG_sBx=function(t,e){return c(t,e+a)},t.exports.SET_OPCODE=function(t,e){return t.code=t.code&h(6,0)|e&l(6,0),d(t)},t.exports.SIZE_A=8,t.exports.SIZE_Ax=26,t.exports.SIZE_B=9,t.exports.SIZE_Bx=n,t.exports.SIZE_C=9,t.exports.SIZE_OP=6,t.exports.fullins=d,t.exports.getBMode=function(t){return e[t]>>4&3},t.exports.getCMode=function(t){return e[t]>>2&3},t.exports.getOpMode=function(t){return 3&e[t]},t.exports.iABC=0,t.exports.iABx=1,t.exports.iAsBx=2,t.exports.iAx=3,t.exports.testAMode=function(t){return 64&e[t]},t.exports.testTMode=function(t){return 128&e[t]}},517:(t,e,n)=>{"use strict";const{LUA_MULTRET:i,to_luastring:r}=n(696),{BinOpr:{OPR_ADD:s,OPR_AND:a,OPR_BAND:o,OPR_BOR:l,OPR_BXOR:h,OPR_CONCAT:u,OPR_DIV:c,OPR_EQ:d,OPR_GE:f,OPR_GT:p,OPR_IDIV:m,OPR_LE:_,OPR_LT:g,OPR_MOD:v,OPR_MUL:b,OPR_NE:w,OPR_NOBINOPR:A,OPR_OR:y,OPR_POW:x,OPR_SHL:T,OPR_SHR:L,OPR_SUB:E},UnOpr:{OPR_BNOT:S,OPR_LEN:M,OPR_MINUS:k,OPR_NOT:R,OPR_NOUNOPR:I},NO_JUMP:U,getinstruction:O,luaK_checkstack:C,luaK_codeABC:B,luaK_codeABx:P,luaK_codeAsBx:N,luaK_codek:D,luaK_concat:F,luaK_dischargevars:V,luaK_exp2RK:G,luaK_exp2anyreg:K,luaK_exp2anyregup:j,luaK_exp2nextreg:z,luaK_exp2val:H,luaK_fixline:X,luaK_getlabel:q,luaK_goiffalse:Y,luaK_goiftrue:$,luaK_indexed:W,luaK_infix:Z,luaK_intK:J,luaK_jump:Q,luaK_jumpto:tt,luaK_nil:et,luaK_patchclose:nt,luaK_patchlist:it,luaK_patchtohere:rt,luaK_posfix:st,luaK_prefix:at,luaK_reserveregs:ot,luaK_ret:lt,luaK_self:ht,luaK_setlist:ut,luaK_setmultret:ct,luaK_setoneret:dt,luaK_setreturns:ft,luaK_storevar:pt,luaK_stringK:mt}=n(459),_t=n(179),gt=n(196),vt=n(641),{LUAI_MAXCCALLS:bt,MAX_INT:wt,lua_assert:At}=n(502),yt=n(853),{OpCodesI:{OP_CALL:xt,OP_CLOSURE:Tt,OP_FORLOOP:Lt,OP_FORPREP:Et,OP_GETUPVAL:St,OP_MOVE:Mt,OP_NEWTABLE:kt,OP_SETTABLE:Rt,OP_TAILCALL:It,OP_TFORCALL:Ut,OP_TFORLOOP:Ot,OP_VARARG:Ct},LFIELDS_PER_FLUSH:Bt,SETARG_B:Pt,SETARG_C:Nt,SET_OPCODE:Dt}=n(451),{luaS_eqlngstr:Ft,luaS_new:Vt,luaS_newliteral:Gt}=n(415),Kt=n(420),jt=gt.Proto,zt=vt.RESERVED,Ht=function(t){return t===Yt.VCALL||t===Yt.VVARARG},Xt=function(t,e){return Ft(t,e)};class qt{constructor(){this.previous=null,this.firstlabel=NaN,this.firstgoto=NaN,this.nactvar=NaN,this.upval=NaN,this.isloop=NaN}}const Yt={VVOID:0,VNIL:1,VTRUE:2,VFALSE:3,VK:4,VKFLT:5,VKINT:6,VNONRELOC:7,VLOCAL:8,VUPVAL:9,VINDEXED:10,VJMP:11,VRELOCABLE:12,VCALL:13,VVARARG:14};class $t{constructor(){this.k=NaN,this.u={ival:NaN,nval:NaN,info:NaN,ind:{idx:NaN,t:NaN,vt:NaN}},this.t=NaN,this.f=NaN}to(t){this.k=t.k,this.u=t.u,this.t=t.t,this.f=t.f}}class Wt{constructor(){this.f=null,this.prev=null,this.ls=null,this.bl=null,this.pc=NaN,this.lasttarget=NaN,this.jpc=NaN,this.nk=NaN,this.np=NaN,this.firstlocal=NaN,this.nlocvars=NaN,this.nactvar=NaN,this.nups=NaN,this.freereg=NaN}}class Zt{constructor(){this.idx=NaN}}class Jt{constructor(){this.name=null,this.pc=NaN,this.line=NaN,this.nactvar=NaN}}class Qt{constructor(){this.arr=[],this.n=NaN,this.size=NaN}}const te=function(t,e){t.t.token=0,vt.luaX_syntaxerror(t,e)},ee=function(t,e){vt.luaX_syntaxerror(t,yt.luaO_pushfstring(t.L,r("%s expected",!0),vt.luaX_token2str(t,e)))},ne=function(t,e,n,i){e>n&&function(t,e,n){let i=t.ls.L,s=t.f.linedefined,a=0===s?r("main function",!0):yt.luaO_pushfstring(i,r("function at line %d",!0),s),o=yt.luaO_pushfstring(i,r("too many %s (limit is %d) in %s",!0),n,e,a);vt.luaX_syntaxerror(t.ls,o)}(t,n,i)},ie=function(t,e){return t.t.token===e&&(vt.luaX_next(t),!0)},re=function(t,e){t.t.token!==e&&ee(t,e)},se=function(t,e){re(t,e),vt.luaX_next(t)},ae=function(t,e,n){e||vt.luaX_syntaxerror(t,n)},oe=function(t,e,n,i){ie(t,e)||(i===t.linenumber?ee(t,e):vt.luaX_syntaxerror(t,yt.luaO_pushfstring(t.L,r("%s expected (to close %s at line %d)"),vt.luaX_token2str(t,e),vt.luaX_token2str(t,n),i)))},le=function(t){re(t,zt.TK_NAME);let e=t.t.seminfo.ts;return vt.luaX_next(t),e},he=function(t,e,n){t.f=t.t=U,t.k=e,t.u.info=n},ue=function(t,e,n){he(e,Yt.VK,mt(t.fs,n))},ce=function(t,e){ue(t,e,le(t))},de=function(t,e){let n=t.fs,i=t.dyd,s=function(t,e){let n=t.fs,i=n.f;return i.locvars[n.nlocvars]=new yt.LocVar,i.locvars[n.nlocvars].varname=e,n.nlocvars++}(t,e);ne(n,i.actvar.n+1-n.firstlocal,200,r("local variables",!0)),i.actvar.arr[i.actvar.n]=new Zt,i.actvar.arr[i.actvar.n].idx=s,i.actvar.n++},fe=function(t,e){de(t,vt.luaX_newstring(t,r(e,!0)))},pe=function(t,e){let n=t.ls.dyd.actvar.arr[t.firstlocal+e].idx;return At(n<t.nlocvars),t.f.locvars[n]},me=function(t,e){let n=t.fs;for(n.nactvar=n.nactvar+e;e;e--)pe(n,n.nactvar-e).startpc=n.pc},_e=function(t,e,n){let i=t.f;return ne(t,t.nups+1,gt.MAXUPVAL,r("upvalues",!0)),i.upvalues[t.nups]={instack:n.k===Yt.VLOCAL,idx:n.u.info,name:e},t.nups++},ge=function(t,e,n,i){if(null===t)he(n,Yt.VVOID,0);else{let r=function(t,e){for(let n=t.nactvar-1;n>=0;n--)if(Xt(e,pe(t,n).varname))return n;return-1}(t,e);if(r>=0)he(n,Yt.VLOCAL,r),i||function(t,e){let n=t.bl;for(;n.nactvar>e;)n=n.previous;n.upval=1}(t,r);else{let i=function(t,e){let n=t.f.upvalues;for(let i=0;i<t.nups;i++)if(Xt(n[i].name,e))return i;return-1}(t,e);if(i<0){if(ge(t.prev,e,n,0),n.k===Yt.VVOID)return;i=_e(t,e,n)}he(n,Yt.VUPVAL,i)}}},ve=function(t,e){let n=le(t),i=t.fs;if(ge(i,n,e,1),e.k===Yt.VVOID){let r=new $t;ge(i,t.envn,e,1),At(e.k!==Yt.VVOID),ue(t,r,n),W(i,e,r)}},be=function(t,e,n,i){let r=t.fs,s=e-n;if(Ht(i.k))s++,s<0&&(s=0),ft(r,i,s),s>1&&ot(r,s-1);else if(i.k!==Yt.VVOID&&z(r,i),s>0){let t=r.freereg;ot(r,s),et(r,t,s)}n>e&&(t.fs.freereg-=n-e)},we=function(t){let e=t.L;++e.nCcalls,ne(t.fs,e.nCcalls,bt,r("JS levels",!0))},Ae=function(t){return t.L.nCcalls--},ye=function(t,e,n){let i=t.fs,s=t.dyd.gt,a=s.arr[e];if(At(Xt(a.name,n.name)),a.nactvar<n.nactvar){let e=pe(i,a.nactvar).varname,n=yt.luaO_pushfstring(t.L,r("<goto %s> at line %d jumps into the scope of local '%s'"),a.name.getstr(),a.line,e.getstr());te(t,n)}it(i,a.pc,n.pc);for(let t=e;t<s.n-1;t++)s.arr[t]=s.arr[t+1];s.n--},xe=function(t,e){let n=t.fs.bl,i=t.dyd,r=i.gt.arr[e];for(let s=n.firstlabel;s<i.label.n;s++){let a=i.label.arr[s];if(Xt(a.name,r.name))return r.nactvar>a.nactvar&&(n.upval||i.label.n>n.firstlabel)&&nt(t.fs,r.pc,a.nactvar),ye(t,e,a),!0}return!1},Te=function(t,e,n,i,r){let s=e.n;return e.arr[s]=new Jt,e.arr[s].name=n,e.arr[s].line=i,e.arr[s].nactvar=t.fs.nactvar,e.arr[s].pc=r,e.n=s+1,s},Le=function(t,e){let n=t.dyd.gt,i=t.fs.bl.firstgoto;for(;i<n.n;)Xt(n.arr[i].name,e.name)?ye(t,i,e):i++},Ee=function(t,e,n){e.isloop=n,e.nactvar=t.nactvar,e.firstlabel=t.ls.dyd.label.n,e.firstgoto=t.ls.dyd.gt.n,e.upval=0,e.previous=t.bl,t.bl=e,At(t.freereg===t.nactvar)},Se=function(t,e,n){e.prev=t.fs,e.ls=t,t.fs=e,e.pc=0,e.lasttarget=0,e.jpc=U,e.freereg=0,e.nk=0,e.np=0,e.nups=0,e.nlocvars=0,e.nactvar=0,e.firstlocal=t.dyd.actvar.n,e.bl=null;let i=e.f;i.source=t.source,i.maxstacksize=2,Ee(e,n,!1)},Me=function(t){let e=t.bl,n=t.ls;if(e.previous&&e.upval){let n=Q(t);nt(t,n,e.nactvar),rt(t,n)}e.isloop&&function(t){let e=Gt(t.L,"break"),n=Te(t,t.dyd.label,e,0,t.fs.pc);Le(t,t.dyd.label.arr[n])}(n),t.bl=e.previous,function(t,e){for(t.ls.dyd.actvar.n-=t.nactvar-e;t.nactvar>e;)pe(t,--t.nactvar).endpc=t.pc}(t,e.nactvar),At(e.nactvar===t.nactvar),t.freereg=t.nactvar,n.dyd.label.n=e.firstlabel,e.previous?function(t,e){let n=e.firstgoto,i=t.ls.dyd.gt;for(;n<i.n;){let r=i.arr[n];r.nactvar>e.nactvar&&(e.upval&&nt(t,r.pc,e.nactvar),r.nactvar=e.nactvar),xe(t.ls,n)||n++}}(t,e):e.firstgoto<n.dyd.gt.n&&function(t,e){let n=vt.isreserved(e.name)?"<%s> at line %d not inside a loop":"no visible label '%s' for <goto> at line %d";n=yt.luaO_pushfstring(t.L,r(n),e.name.getstr(),e.line),te(t,n)}(n,n.dyd.gt.arr[e.firstgoto])},ke=function(t){let e=t.fs;lt(e,0,0),Me(e),At(null===e.bl),t.fs=e.prev},Re=function(t,e){switch(t.t.token){case zt.TK_ELSE:case zt.TK_ELSEIF:case zt.TK_END:case zt.TK_EOS:return!0;case zt.TK_UNTIL:return e;default:return!1}},Ie=function(t){for(;!Re(t,1);){if(t.t.token===zt.TK_RETURN)return void sn(t);sn(t)}},Ue=function(t,e){let n=t.fs,i=new $t;j(n,e),vt.luaX_next(t),ce(t,i),W(n,e,i)},Oe=function(t,e){vt.luaX_next(t),Xe(t,e),H(t.fs,e),se(t,93)};class Ce{constructor(){this.v=new $t,this.t=new $t,this.nh=NaN,this.na=NaN,this.tostore=NaN}}const Be=function(t,e){let n=t.fs,i=t.fs.freereg,s=new $t,a=new $t;t.t.token===zt.TK_NAME?(ne(n,e.nh,wt,r("items in a constructor",!0)),ce(t,s)):Oe(t,s),e.nh++,se(t,61);let o=G(n,s);Xe(t,a),B(n,Rt,e.t.u.info,o,G(n,a)),n.freereg=i},Pe=function(t,e){e.v.k!==Yt.VVOID&&(z(t,e.v),e.v.k=Yt.VVOID,e.tostore===Bt&&(ut(t,e.t.u.info,e.na,e.tostore),e.tostore=0))},Ne=function(t,e){Xe(t,e.v),ne(t.fs,e.na,wt,r("items in a constructor",!0)),e.na++,e.tostore++},De=function(t,e){switch(t.t.token){case zt.TK_NAME:61!==vt.luaX_lookahead(t)?Ne(t,e):Be(t,e);break;case 91:Be(t,e);break;default:Ne(t,e)}},Fe=function(t,e){let n=t.fs,r=t.linenumber,s=B(n,kt,0,0,0),a=new Ce;a.na=a.nh=a.tostore=0,a.t=e,he(e,Yt.VRELOCABLE,s),he(a.v,Yt.VVOID,0),z(t.fs,e),se(t,123);do{if(At(a.v.k===Yt.VVOID||a.tostore>0),125===t.t.token)break;Pe(n,a),De(t,a)}while(ie(t,44)||ie(t,59));oe(t,125,123,r),function(t,e){0!==e.tostore&&(Ht(e.v.k)?(ct(t,e.v),ut(t,e.t.u.info,e.na,i),e.na--):(e.v.k!==Yt.VVOID&&z(t,e.v),ut(t,e.t.u.info,e.na,e.tostore)))}(n,a),Pt(n.f.code[s],yt.luaO_int2fb(a.na)),Nt(n.f.code[s],yt.luaO_int2fb(a.nh))},Ve=function(t,e,n,i){let s=new Wt,a=new qt;s.f=function(t){let e=t.L,n=new jt(e),i=t.fs;return i.f.p[i.np++]=n,n}(t),s.f.linedefined=i,Se(t,s,a),se(t,40),n&&(fe(t,"self"),me(t,1)),function(t){let e=t.fs,n=e.f,i=0;if(n.is_vararg=!1,41!==t.t.token)do{switch(t.t.token){case zt.TK_NAME:de(t,le(t)),i++;break;case zt.TK_DOTS:vt.luaX_next(t),n.is_vararg=!0;break;default:vt.luaX_syntaxerror(t,r("<name> or '...' expected",!0))}}while(!n.is_vararg&&ie(t,44));me(t,i),n.numparams=e.nactvar,ot(e,e.nactvar)}(t),se(t,41),Ie(t),s.f.lastlinedefined=t.linenumber,oe(t,zt.TK_END,zt.TK_FUNCTION,i),function(t,e){let n=t.fs.prev;he(e,Yt.VRELOCABLE,P(n,Tt,0,n.np-1)),z(n,e)}(t,e),ke(t)},Ge=function(t,e){let n=1;for(Xe(t,e);ie(t,44);)z(t.fs,e),Xe(t,e),n++;return n},Ke=function(t,e,n){let s,a=t.fs,o=new $t;switch(t.t.token){case 40:vt.luaX_next(t),41===t.t.token?o.k=Yt.VVOID:(Ge(t,o),ct(a,o)),oe(t,41,40,n);break;case 123:Fe(t,o);break;case zt.TK_STRING:ue(t,o,t.t.seminfo.ts),vt.luaX_next(t);break;default:vt.luaX_syntaxerror(t,r("function arguments expected",!0))}At(e.k===Yt.VNONRELOC);let l=e.u.info;Ht(o.k)?s=i:(o.k!==Yt.VVOID&&z(a,o),s=a.freereg-(l+1)),he(e,Yt.VCALL,B(a,xt,l,s+1,2)),X(a,n),a.freereg=l+1},je=function(t,e){let n=t.fs,i=t.linenumber;for(!function(t,e){switch(t.t.token){case 40:{let n=t.linenumber;return vt.luaX_next(t),Xe(t,e),oe(t,41,40,n),void V(t.fs,e)}case zt.TK_NAME:return void ve(t,e);default:vt.luaX_syntaxerror(t,r("unexpected symbol",!0))}}(t,e);;)switch(t.t.token){case 46:Ue(t,e);break;case 91:{let i=new $t;j(n,e),Oe(t,i),W(n,e,i);break}case 58:{let r=new $t;vt.luaX_next(t),ce(t,r),ht(n,e,r),Ke(t,e,i);break}case 40:case zt.TK_STRING:case 123:z(n,e),Ke(t,e,i);break;default:return}},ze=[{left:10,right:10},{left:10,right:10},{left:11,right:11},{left:11,right:11},{left:14,right:13},{left:11,right:11},{left:11,right:11},{left:6,right:6},{left:4,right:4},{left:5,right:5},{left:7,right:7},{left:7,right:7},{left:9,right:8},{left:3,right:3},{left:3,right:3},{left:3,right:3},{left:3,right:3},{left:3,right:3},{left:3,right:3},{left:2,right:2},{left:1,right:1}],He=function(t,e,n){we(t);let i=function(t){switch(t){case zt.TK_NOT:return R;case 45:return k;case 126:return S;case 35:return M;default:return I}}(t.t.token);if(i!==I){let n=t.linenumber;vt.luaX_next(t),He(t,e,12),at(t.fs,i,e,n)}else!function(t,e){switch(t.t.token){case zt.TK_FLT:he(e,Yt.VKFLT,0),e.u.nval=t.t.seminfo.r;break;case zt.TK_INT:he(e,Yt.VKINT,0),e.u.ival=t.t.seminfo.i;break;case zt.TK_STRING:ue(t,e,t.t.seminfo.ts);break;case zt.TK_NIL:he(e,Yt.VNIL,0);break;case zt.TK_TRUE:he(e,Yt.VTRUE,0);break;case zt.TK_FALSE:he(e,Yt.VFALSE,0);break;case zt.TK_DOTS:{let n=t.fs;ae(t,n.f.is_vararg,r("cannot use '...' outside a vararg function",!0)),he(e,Yt.VVARARG,B(n,Ct,0,1,0));break}case 123:return void Fe(t,e);case zt.TK_FUNCTION:return vt.luaX_next(t),void Ve(t,e,0,t.linenumber);default:return void je(t,e)}vt.luaX_next(t)}(t,e);let U=function(t){switch(t){case 43:return s;case 45:return E;case 42:return b;case 37:return v;case 94:return x;case 47:return c;case zt.TK_IDIV:return m;case 38:return o;case 124:return l;case 126:return h;case zt.TK_SHL:return T;case zt.TK_SHR:return L;case zt.TK_CONCAT:return u;case zt.TK_NE:return w;case zt.TK_EQ:return d;case 60:return g;case zt.TK_LE:return _;case 62:return p;case zt.TK_GE:return f;case zt.TK_AND:return a;case zt.TK_OR:return y;default:return A}}(t.t.token);for(;U!==A&&ze[U].left>n;){let n=new $t,i=t.linenumber;vt.luaX_next(t),Z(t.fs,U,e);let r=He(t,n,ze[U].right);st(t.fs,U,e,n,i),U=r}return Ae(t),U},Xe=function(t,e){He(t,e,0)},qe=function(t){let e=t.fs,n=new qt;Ee(e,n,0),Ie(t),Me(e)};class Ye{constructor(){this.prev=null,this.v=new $t}}const $e=function(t,e,n){let i=new $t;var s;if(ae(t,(s=e.v.k,Yt.VLOCAL<=s&&s<=Yt.VINDEXED),r("syntax error",!0)),ie(t,44)){let i=new Ye;i.prev=e,je(t,i.v),i.v.k!==Yt.VINDEXED&&function(t,e,n){let i=t.fs,r=i.freereg,s=!1;for(;e;e=e.prev)e.v.k===Yt.VINDEXED&&(e.v.u.ind.vt===n.k&&e.v.u.ind.t===n.u.info&&(s=!0,e.v.u.ind.vt=Yt.VLOCAL,e.v.u.ind.t=r),n.k===Yt.VLOCAL&&e.v.u.ind.idx===n.u.info&&(s=!0,e.v.u.ind.idx=r));if(s){let t=n.k===Yt.VLOCAL?Mt:St;B(i,t,r,n.u.info,0),ot(i,1)}}(t,e,i.v),ne(t.fs,n+t.L.nCcalls,bt,r("JS levels",!0)),$e(t,i,n+1)}else{se(t,61);let r=Ge(t,i);if(r===n)return dt(t.fs,i),void pt(t.fs,e.v,i);be(t,n,r,i)}he(i,Yt.VNONRELOC,t.fs.freereg-1),pt(t.fs,e.v,i)},We=function(t){let e=new $t;return Xe(t,e),e.k===Yt.VNIL&&(e.k=Yt.VFALSE),$(t.fs,e),e.f},Ze=function(t,e){let n,i=t.linenumber;ie(t,zt.TK_GOTO)?n=le(t):(vt.luaX_next(t),n=Gt(t.L,"break"));let r=Te(t,t.dyd.gt,n,i,e);xe(t,r)},Je=function(t,e,n){let i,s=t.fs,a=t.dyd.label;!function(t,e,n){for(let i=t.bl.firstlabel;i<e.n;i++)if(Xt(n,e.arr[i].name)){let s=yt.luaO_pushfstring(t.ls.L,r("label '%s' already defined on line %d",!0),n.getstr(),e.arr[i].line);te(t.ls,s)}}(s,a,e),se(t,zt.TK_DBCOLON),i=Te(t,a,e,n,q(s)),function(t){for(;59===t.t.token||t.t.token===zt.TK_DBCOLON;)sn(t)}(t),Re(t,0)&&(a.arr[i].nactvar=s.bl.nactvar),Le(t,a.arr[i])},Qe=function(t){let e=new $t;return Xe(t,e),z(t.fs,e),At(e.k===Yt.VNONRELOC),e.u.info},tn=function(t,e,n,i,r){let s,a=new qt,o=t.fs;me(t,3),se(t,zt.TK_DO);let l=r?N(o,Et,e,U):Q(o);Ee(o,a,0),me(t,i),ot(o,i),qe(t),Me(o),rt(o,l),r?s=N(o,Lt,e,U):(B(o,Ut,e,0,i),X(o,n),s=N(o,Ot,e+2,U)),it(o,s,l+1),X(o,n)},en=function(t,e){let n=t.fs,i=new qt;Ee(n,i,1),vt.luaX_next(t);let s=le(t);switch(t.t.token){case 61:!function(t,e,n){let i=t.fs,r=i.freereg;fe(t,"(for index)"),fe(t,"(for limit)"),fe(t,"(for step)"),de(t,e),se(t,61),Qe(t),se(t,44),Qe(t),ie(t,44)?Qe(t):(D(i,i.freereg,J(i,1)),ot(i,1)),tn(t,r,n,1,1)}(t,s,e);break;case 44:case zt.TK_IN:!function(t,e){let n=t.fs,i=new $t,r=4,s=n.freereg;for(fe(t,"(for generator)"),fe(t,"(for state)"),fe(t,"(for control)"),de(t,e);ie(t,44);)de(t,le(t)),r++;se(t,zt.TK_IN);let a=t.linenumber;be(t,3,Ge(t,i),i),C(n,3),tn(t,s,a,r-3,0)}(t,s);break;default:vt.luaX_syntaxerror(t,r("'=' or 'in' expected",!0))}oe(t,zt.TK_END,zt.TK_FOR,e),Me(n)},nn=function(t,e){let n,i=new qt,r=t.fs,s=new $t;if(vt.luaX_next(t),Xe(t,s),se(t,zt.TK_THEN),t.t.token===zt.TK_GOTO||t.t.token===zt.TK_BREAK){for(Y(t.fs,s),Ee(r,i,!1),Ze(t,s.t);ie(t,59););if(Re(t,0))return Me(r),e;n=Q(r)}else $(t.fs,s),Ee(r,i,!1),n=s.f;return Ie(t),Me(r),t.t.token!==zt.TK_ELSE&&t.t.token!==zt.TK_ELSEIF||(e=F(r,e,Q(r))),rt(r,n),e},rn=function(t,e){let n=new $t,i=new $t;vt.luaX_next(t);let r=function(t,e){let n=0;for(ve(t,e);46===t.t.token;)Ue(t,e);return 58===t.t.token&&(n=1,Ue(t,e)),n}(t,n);Ve(t,i,r,e),pt(t.fs,n,i),X(t.fs,e)},sn=function(t){let e=t.linenumber;switch(we(t),t.t.token){case 59:vt.luaX_next(t);break;case zt.TK_IF:!function(t,e){let n=t.fs,i=U;for(i=nn(t,i);t.t.token===zt.TK_ELSEIF;)i=nn(t,i);ie(t,zt.TK_ELSE)&&qe(t),oe(t,zt.TK_END,zt.TK_IF,e),rt(n,i)}(t,e);break;case zt.TK_WHILE:!function(t,e){let n=t.fs,i=new qt;vt.luaX_next(t);let r=q(n),s=We(t);Ee(n,i,1),se(t,zt.TK_DO),qe(t),tt(n,r),oe(t,zt.TK_END,zt.TK_WHILE,e),Me(n),rt(n,s)}(t,e);break;case zt.TK_DO:vt.luaX_next(t),qe(t),oe(t,zt.TK_END,zt.TK_DO,e);break;case zt.TK_FOR:en(t,e);break;case zt.TK_REPEAT:!function(t,e){let n=t.fs,i=q(n),r=new qt,s=new qt;Ee(n,r,1),Ee(n,s,0),vt.luaX_next(t),Ie(t),oe(t,zt.TK_UNTIL,zt.TK_REPEAT,e);let a=We(t);s.upval&&nt(n,a,s.nactvar),Me(n),it(n,a,i),Me(n)}(t,e);break;case zt.TK_FUNCTION:rn(t,e);break;case zt.TK_LOCAL:vt.luaX_next(t),ie(t,zt.TK_FUNCTION)?function(t){let e=new $t,n=t.fs;de(t,le(t)),me(t,1),Ve(t,e,0,t.linenumber),pe(n,e.u.info).startpc=n.pc}(t):function(t){let e,n=0,i=new $t;do{de(t,le(t)),n++}while(ie(t,44));ie(t,61)?e=Ge(t,i):(i.k=Yt.VVOID,e=0),be(t,n,e,i),me(t,n)}(t);break;case zt.TK_DBCOLON:vt.luaX_next(t),Je(t,le(t),e);break;case zt.TK_RETURN:vt.luaX_next(t),function(t){let e,n,r=t.fs,s=new $t;Re(t,1)||59===t.t.token?e=n=0:(n=Ge(t,s),Ht(s.k)?(ct(r,s),s.k===Yt.VCALL&&1===n&&(Dt(O(r,s),It),At(O(r,s).A===r.nactvar)),e=r.nactvar,n=i):1===n?e=K(r,s):(z(r,s),e=r.nactvar,At(n===r.freereg-e))),lt(r,e,n),ie(t,59)}(t);break;case zt.TK_BREAK:case zt.TK_GOTO:Ze(t,Q(t.fs));break;default:!function(t){let e=t.fs,n=new Ye;je(t,n.v),61===t.t.token||44===t.t.token?(n.prev=null,$e(t,n,1)):(ae(t,n.v.k===Yt.VCALL,r("syntax error",!0)),Nt(O(e,n.v),1))}(t)}At(t.fs.f.maxstacksize>=t.fs.freereg&&t.fs.freereg>=t.fs.nactvar),t.fs.freereg=t.fs.nactvar,Ae(t)};t.exports.Dyndata=class{constructor(){this.actvar={arr:[],n:NaN,size:NaN},this.gt=new Qt,this.label=new Qt}},t.exports.expkind=Yt,t.exports.expdesc=$t,t.exports.luaY_parser=function(t,e,n,i,r,s){let a=new vt.LexState,o=new Wt,l=gt.luaF_newLclosure(t,1);return _t.luaD_inctop(t),t.stack[t.top-1].setclLvalue(l),a.h=Kt.luaH_new(t),_t.luaD_inctop(t),t.stack[t.top-1].sethvalue(a.h),o.f=l.p=new jt(t),o.f.source=Vt(t,r),a.buff=n,a.dyd=i,i.actvar.n=i.gt.n=i.label.n=0,vt.luaX_setinput(t,a,e,o.f.source,s),function(t,e){let n=new qt,i=new $t;Se(t,e,n),e.f.is_vararg=!0,he(i,Yt.VLOCAL,0),_e(e,t.envn,i),vt.luaX_next(t),Ie(t),re(t,zt.TK_EOS),ke(t)}(a,o),At(!o.prev&&1===o.nups&&!a.fs),At(0===i.actvar.n&&0===i.gt.n&&0===i.label.n),delete t.stack[--t.top],l},t.exports.vkisinreg=function(t){return t===Yt.VNONRELOC||t===Yt.VLOCAL}},809:(t,e,n)=>{"use strict";const{LUA_MINSTACK:i,LUA_RIDX_GLOBALS:r,LUA_RIDX_MAINTHREAD:s,constant_types:{LUA_NUMTAGS:a,LUA_TNIL:o,LUA_TTABLE:l,LUA_TTHREAD:h},thread_status:{LUA_OK:u}}=n(696),c=n(853),d=n(179),f=n(660),p=n(420),m=n(917),_=2*i;class g{constructor(){this.func=null,this.funcOff=NaN,this.top=NaN,this.previous=null,this.next=null,this.l_base=NaN,this.l_code=null,this.l_savedpc=NaN,this.c_k=null,this.c_old_errfunc=null,this.c_ctx=null,this.nresults=NaN,this.callstatus=NaN}}class v{constructor(t){this.id=t.id_counter++,this.base_ci=new g,this.top=NaN,this.stack_last=NaN,this.oldpc=NaN,this.l_G=t,this.stack=null,this.ci=null,this.errorJmp=null,this.nCcalls=0,this.hook=null,this.hookmask=0,this.basehookcount=0,this.allowhook=1,this.hookcount=this.basehookcount,this.nny=1,this.status=u,this.errfunc=0}}class b{constructor(){this.id_counter=1,this.ids=new WeakMap,this.mainthread=null,this.l_registry=new c.TValue(o,null),this.panic=null,this.atnativeerror=null,this.version=null,this.tmname=new Array(m.TMS.TM_N),this.mt=new Array(a)}}const w=function(t){t.ci.next=null},A=function(t,e){t.stack=new Array(_),t.top=0,t.stack_last=_-5;let n=t.base_ci;n.next=n.previous=null,n.callstatus=0,n.funcOff=t.top,n.func=t.stack[t.top],t.stack[t.top++]=new c.TValue(o,null),n.top=t.top+i,t.ci=n},y=function(t){t.ci=t.base_ci,w(t),t.stack=null},x=function(t){let e=t.l_G;A(t),function(t,e){let n=p.luaH_new(t);e.l_registry.sethvalue(n),p.luaH_setint(n,s,new c.TValue(h,t)),p.luaH_setint(n,r,new c.TValue(l,p.luaH_new(t)))}(t,e),m.luaT_init(t),e.version=f.lua_version(null)};t.exports.lua_State=v,t.exports.CallInfo=g,t.exports.CIST_OAH=1,t.exports.CIST_LUA=2,t.exports.CIST_HOOKED=4,t.exports.CIST_FRESH=8,t.exports.CIST_YPCALL=16,t.exports.CIST_TAIL=32,t.exports.CIST_HOOKYIELD=64,t.exports.CIST_LEQ=128,t.exports.CIST_FIN=256,t.exports.EXTRA_STACK=5,t.exports.lua_close=function(t){!function(t){y(t)}(t=t.l_G.mainthread)},t.exports.lua_newstate=function(){let t=new b,e=new v(t);return t.mainthread=e,d.luaD_rawrunprotected(e,x,null)!==u&&(e=null),e},t.exports.lua_newthread=function(t){let e=t.l_G,n=new v(e);return t.stack[t.top]=new c.TValue(h,n),f.api_incr_top(t),n.hookmask=t.hookmask,n.basehookcount=t.basehookcount,n.hook=t.hook,n.hookcount=n.basehookcount,A(n),n},t.exports.luaE_extendCI=function(t){let e=new g;return t.ci.next=e,e.previous=t.ci,e.next=null,t.ci=e,e},t.exports.luaE_freeCI=w,t.exports.luaE_freethread=function(t,e){y(e)}},415:(t,e,n)=>{"use strict";const{is_luastring:i,luastring_eq:r,luastring_from:s,to_luastring:a}=n(696),{lua_assert:o}=n(502);class l{constructor(t,e){this.hash=null,this.realstring=e}getstr(){return this.realstring}tsslen(){return this.realstring.length}}const h=function(t){o(i(t));let e=t.length,n="|";for(let i=0;i<e;i++)n+=t[i].toString(16);return n},u=function(t,e){return o(e instanceof Uint8Array),new l(t,e)};t.exports.luaS_eqlngstr=function(t,e){return o(t instanceof l),o(e instanceof l),t==e||r(t.realstring,e.realstring)},t.exports.luaS_hash=h,t.exports.luaS_hashlongstr=function(t){return o(t instanceof l),null===t.hash&&(t.hash=h(t.getstr())),t.hash},t.exports.luaS_bless=u,t.exports.luaS_new=function(t,e){return u(t,s(e))},t.exports.luaS_newliteral=function(t,e){return u(t,a(e))},t.exports.TString=l},420:(t,e,n)=>{"use strict";const{constant_types:{LUA_TBOOLEAN:i,LUA_TCCL:r,LUA_TLCF:s,LUA_TLCL:a,LUA_TLIGHTUSERDATA:o,LUA_TLNGSTR:l,LUA_TNIL:h,LUA_TNUMFLT:u,LUA_TNUMINT:c,LUA_TSHRSTR:d,LUA_TTABLE:f,LUA_TTHREAD:p,LUA_TUSERDATA:m},to_luastring:_}=n(696),{lua_assert:g}=n(502),v=n(399),b=n(853),{luaS_hashlongstr:w,TString:A}=n(415),y=n(809);let x=new WeakMap;const T=function(t){let e=x.get(t);return e||(e={},x.set(t,e)),e},L=function(t,e){switch(e.type){case h:return v.luaG_runerror(t,_("table index is nil",!0));case u:if(isNaN(e.value))return v.luaG_runerror(t,_("table index is NaN",!0));case c:case i:case f:case a:case s:case r:case m:case p:return e.value;case d:case l:return w(e.tsvalue());case o:{let n=e.value;switch(typeof n){case"string":return"*"+n;case"number":return"#"+n;case"boolean":return n?"?true":"?false";case"function":return T(n);case"object":if(n instanceof y.lua_State&&n.l_G===t.l_G||n instanceof E||n instanceof b.Udata||n instanceof b.LClosure||n instanceof b.CClosure)return T(n);default:return n}}default:throw new Error("unknown key type: "+e.type)}};class E{constructor(t){this.id=t.l_G.id_counter++,this.strong=new Map,this.dead_strong=new Map,this.dead_weak=void 0,this.f=void 0,this.l=void 0,this.metatable=null,this.flags=-1}}const S=function(t,e,n,i){t.dead_strong.clear(),t.dead_weak=void 0;let r=null,s={key:n,value:i,p:r=t.l,n:void 0};t.f||(t.f=s),r&&(r.n=s),t.strong.set(e,s),t.l=s},M=function(t,e){let n=t.strong.get(e);if(n){n.key.setdeadvalue(),n.value=void 0;let r=n.n,s=n.p;n.p=void 0,s&&(s.n=r),r&&(r.p=s),t.f===n&&(t.f=r),t.l===n&&(t.l=s),t.strong.delete(e),("object"==typeof(i=e)?null!==i:"function"==typeof i)?(t.dead_weak||(t.dead_weak=new WeakMap),t.dead_weak.set(e,n)):t.dead_strong.set(e,n)}var i},k=function(t,e){let n=t.strong.get(e);return n?n.value:b.luaO_nilobject},R=function(t,e){return g("number"==typeof e&&(0|e)===e),k(t,e)};t.exports.invalidateTMcache=function(t){t.flags=0},t.exports.luaH_get=function(t,e,n){return g(n instanceof b.TValue),n.ttisnil()||n.ttisfloat()&&isNaN(n.value)?b.luaO_nilobject:k(e,L(t,n))},t.exports.luaH_getint=R,t.exports.luaH_getn=function(t){let e=0,n=t.strong.size+1;for(;n-e>1;){let i=Math.floor((e+n)/2);R(t,i).ttisnil()?n=i:e=i}return e},t.exports.luaH_getstr=function(t,e){return g(e instanceof A),k(t,w(e))},t.exports.luaH_setfrom=function(t,e,n,i){g(n instanceof b.TValue);let r=L(t,n);if(i.ttisnil())return void M(e,r);let s=e.strong.get(r);if(s)s.value.setfrom(i);else{let t,s=n.value;t=n.ttisfloat()&&(0|s)===s?new b.TValue(c,s):new b.TValue(n.type,s);let a=new b.TValue(i.type,i.value);S(e,r,t,a)}},t.exports.luaH_setint=function(t,e,n){g("number"==typeof e&&(0|e)===e&&n instanceof b.TValue);let i=e;if(n.ttisnil())return void M(t,i);let r=t.strong.get(i);if(r){r.value.setfrom(n)}else{let r=new b.TValue(c,e),s=new b.TValue(n.type,n.value);S(t,i,r,s)}},t.exports.luaH_new=function(t){return new E(t)},t.exports.luaH_next=function(t,e,n){let i,r=t.stack[n];if(r.type===h){if(i=e.f,!i)return!1}else{let n=L(t,r);if(i=e.strong.get(n),i){if(i=i.n,!i)return!1}else{if(i=e.dead_weak&&e.dead_weak.get(n)||e.dead_strong.get(n),!i)return v.luaG_runerror(t,_("invalid key to 'next'"));do{if(i=i.n,!i)return!1}while(i.key.ttisdeadkey())}}return b.setobj2s(t,n,i.key),b.setobj2s(t,n+1,i.value),!0},t.exports.Table=E},917:(t,e,n)=>{"use strict";const{constant_types:{LUA_TTABLE:i,LUA_TUSERDATA:r},to_luastring:s}=n(696),{lua_assert:a}=n(502),o=n(853),l=n(179),h=n(809),{luaS_bless:u,luaS_new:c}=n(415),d=n(420),f=n(399),p=n(371),m=["no value","nil","boolean","userdata","number","string","table","function","userdata","thread","proto"].map((t=>s(t))),_=function(t){return m[t+1]},g={TM_INDEX:0,TM_NEWINDEX:1,TM_GC:2,TM_MODE:3,TM_LEN:4,TM_EQ:5,TM_ADD:6,TM_SUB:7,TM_MUL:8,TM_MOD:9,TM_POW:10,TM_DIV:11,TM_IDIV:12,TM_BAND:13,TM_BOR:14,TM_BXOR:15,TM_SHL:16,TM_SHR:17,TM_UNM:18,TM_BNOT:19,TM_LT:20,TM_LE:21,TM_CONCAT:22,TM_CALL:23,TM_N:24},v=s("__name",!0),b=function(t,e,n,i,r,s){let a=t.top;if(o.pushobj2s(t,e),o.pushobj2s(t,n),o.pushobj2s(t,i),s||o.pushobj2s(t,r),t.ci.callstatus&h.CIST_LUA?l.luaD_call(t,a,s):l.luaD_callnoyield(t,a,s),s){let e=t.stack[t.top-1];delete t.stack[--t.top],r.setfrom(e)}},w=function(t,e,n,i,r){let s=y(t,e,r);return s.ttisnil()&&(s=y(t,n,r)),!s.ttisnil()&&(b(t,s,e,n,i,1),!0)},A=function(t,e,n){const i=d.luaH_getstr(t,n);return a(e<=g.TM_EQ),i.ttisnil()?(t.flags|=1<<e,null):i},y=function(t,e,n){let s;switch(e.ttnov()){case i:case r:s=e.value.metatable;break;default:s=t.l_G.mt[e.ttnov()]}return s?d.luaH_getstr(s,t.l_G.tmname[n]):o.luaO_nilobject};t.exports.fasttm=function(t,e,n){return null===e||e.flags&1<<n?null:A(e,n,t.l_G.tmname[n])},t.exports.TMS=g,t.exports.luaT_callTM=b,t.exports.luaT_callbinTM=w,t.exports.luaT_trybinTM=function(t,e,n,i,r){if(!w(t,e,n,i,r))switch(r){case g.TM_CONCAT:return f.luaG_concaterror(t,e,n);case g.TM_BAND:case g.TM_BOR:case g.TM_BXOR:case g.TM_SHL:case g.TM_SHR:case g.TM_BNOT:{let i=p.tonumber(e),r=p.tonumber(n);return!1!==i&&!1!==r?f.luaG_tointerror(t,e,n):f.luaG_opinterror(t,e,n,s("perform bitwise operation on",!0))}default:return f.luaG_opinterror(t,e,n,s("perform arithmetic on",!0))}},t.exports.luaT_callorderTM=function(t,e,n,i){let r=new o.TValue;return w(t,e,n,r,i)?!r.l_isfalse():null},t.exports.luaT_gettm=A,t.exports.luaT_gettmbyobj=y,t.exports.luaT_init=function(t){t.l_G.tmname[g.TM_INDEX]=new c(t,s("__index",!0)),t.l_G.tmname[g.TM_NEWINDEX]=new c(t,s("__newindex",!0)),t.l_G.tmname[g.TM_GC]=new c(t,s("__gc",!0)),t.l_G.tmname[g.TM_MODE]=new c(t,s("__mode",!0)),t.l_G.tmname[g.TM_LEN]=new c(t,s("__len",!0)),t.l_G.tmname[g.TM_EQ]=new c(t,s("__eq",!0)),t.l_G.tmname[g.TM_ADD]=new c(t,s("__add",!0)),t.l_G.tmname[g.TM_SUB]=new c(t,s("__sub",!0)),t.l_G.tmname[g.TM_MUL]=new c(t,s("__mul",!0)),t.l_G.tmname[g.TM_MOD]=new c(t,s("__mod",!0)),t.l_G.tmname[g.TM_POW]=new c(t,s("__pow",!0)),t.l_G.tmname[g.TM_DIV]=new c(t,s("__div",!0)),t.l_G.tmname[g.TM_IDIV]=new c(t,s("__idiv",!0)),t.l_G.tmname[g.TM_BAND]=new c(t,s("__band",!0)),t.l_G.tmname[g.TM_BOR]=new c(t,s("__bor",!0)),t.l_G.tmname[g.TM_BXOR]=new c(t,s("__bxor",!0)),t.l_G.tmname[g.TM_SHL]=new c(t,s("__shl",!0)),t.l_G.tmname[g.TM_SHR]=new c(t,s("__shr",!0)),t.l_G.tmname[g.TM_UNM]=new c(t,s("__unm",!0)),t.l_G.tmname[g.TM_BNOT]=new c(t,s("__bnot",!0)),t.l_G.tmname[g.TM_LT]=new c(t,s("__lt",!0)),t.l_G.tmname[g.TM_LE]=new c(t,s("__le",!0)),t.l_G.tmname[g.TM_CONCAT]=new c(t,s("__concat",!0)),t.l_G.tmname[g.TM_CALL]=new c(t,s("__call",!0))},t.exports.luaT_objtypename=function(t,e){let n;if(e.ttistable()&&null!==(n=e.value.metatable)||e.ttisfulluserdata()&&null!==(n=e.value.metatable)){let e=d.luaH_getstr(n,u(t,v));if(e.ttisstring())return e.svalue()}return _(e.ttnov())},t.exports.ttypename=_},936:(t,e,n)=>{"use strict";const i=n(696),r=n(660),s=n(399),a=n(179),o=n(809);t.exports.LUA_AUTHORS=i.LUA_AUTHORS,t.exports.LUA_COPYRIGHT=i.LUA_COPYRIGHT,t.exports.LUA_ERRERR=i.thread_status.LUA_ERRERR,t.exports.LUA_ERRGCMM=i.thread_status.LUA_ERRGCMM,t.exports.LUA_ERRMEM=i.thread_status.LUA_ERRMEM,t.exports.LUA_ERRRUN=i.thread_status.LUA_ERRRUN,t.exports.LUA_ERRSYNTAX=i.thread_status.LUA_ERRSYNTAX,t.exports.LUA_HOOKCALL=i.LUA_HOOKCALL,t.exports.LUA_HOOKCOUNT=i.LUA_HOOKCOUNT,t.exports.LUA_HOOKLINE=i.LUA_HOOKLINE,t.exports.LUA_HOOKRET=i.LUA_HOOKRET,t.exports.LUA_HOOKTAILCALL=i.LUA_HOOKTAILCALL,t.exports.LUA_MASKCALL=i.LUA_MASKCALL,t.exports.LUA_MASKCOUNT=i.LUA_MASKCOUNT,t.exports.LUA_MASKLINE=i.LUA_MASKLINE,t.exports.LUA_MASKRET=i.LUA_MASKRET,t.exports.LUA_MINSTACK=i.LUA_MINSTACK,t.exports.LUA_MULTRET=i.LUA_MULTRET,t.exports.LUA_NUMTAGS=i.constant_types.LUA_NUMTAGS,t.exports.LUA_OK=i.thread_status.LUA_OK,t.exports.LUA_OPADD=i.LUA_OPADD,t.exports.LUA_OPBAND=i.LUA_OPBAND,t.exports.LUA_OPBNOT=i.LUA_OPBNOT,t.exports.LUA_OPBOR=i.LUA_OPBOR,t.exports.LUA_OPBXOR=i.LUA_OPBXOR,t.exports.LUA_OPDIV=i.LUA_OPDIV,t.exports.LUA_OPEQ=i.LUA_OPEQ,t.exports.LUA_OPIDIV=i.LUA_OPIDIV,t.exports.LUA_OPLE=i.LUA_OPLE,t.exports.LUA_OPLT=i.LUA_OPLT,t.exports.LUA_OPMOD=i.LUA_OPMOD,t.exports.LUA_OPMUL=i.LUA_OPMUL,t.exports.LUA_OPPOW=i.LUA_OPPOW,t.exports.LUA_OPSHL=i.LUA_OPSHL,t.exports.LUA_OPSHR=i.LUA_OPSHR,t.exports.LUA_OPSUB=i.LUA_OPSUB,t.exports.LUA_OPUNM=i.LUA_OPUNM,t.exports.LUA_REGISTRYINDEX=i.LUA_REGISTRYINDEX,t.exports.LUA_RELEASE=i.LUA_RELEASE,t.exports.LUA_RIDX_GLOBALS=i.LUA_RIDX_GLOBALS,t.exports.LUA_RIDX_LAST=i.LUA_RIDX_LAST,t.exports.LUA_RIDX_MAINTHREAD=i.LUA_RIDX_MAINTHREAD,t.exports.LUA_SIGNATURE=i.LUA_SIGNATURE,t.exports.LUA_TNONE=i.constant_types.LUA_TNONE,t.exports.LUA_TNIL=i.constant_types.LUA_TNIL,t.exports.LUA_TBOOLEAN=i.constant_types.LUA_TBOOLEAN,t.exports.LUA_TLIGHTUSERDATA=i.constant_types.LUA_TLIGHTUSERDATA,t.exports.LUA_TNUMBER=i.constant_types.LUA_TNUMBER,t.exports.LUA_TSTRING=i.constant_types.LUA_TSTRING,t.exports.LUA_TTABLE=i.constant_types.LUA_TTABLE,t.exports.LUA_TFUNCTION=i.constant_types.LUA_TFUNCTION,t.exports.LUA_TUSERDATA=i.constant_types.LUA_TUSERDATA,t.exports.LUA_TTHREAD=i.constant_types.LUA_TTHREAD,t.exports.LUA_VERSION=i.LUA_VERSION,t.exports.LUA_VERSION_MAJOR=i.LUA_VERSION_MAJOR,t.exports.LUA_VERSION_MINOR=i.LUA_VERSION_MINOR,t.exports.LUA_VERSION_NUM=i.LUA_VERSION_NUM,t.exports.LUA_VERSION_RELEASE=i.LUA_VERSION_RELEASE,t.exports.LUA_YIELD=i.thread_status.LUA_YIELD,t.exports.lua_Debug=i.lua_Debug,t.exports.lua_upvalueindex=i.lua_upvalueindex,t.exports.lua_absindex=r.lua_absindex,t.exports.lua_arith=r.lua_arith,t.exports.lua_atpanic=r.lua_atpanic,t.exports.lua_atnativeerror=r.lua_atnativeerror,t.exports.lua_call=r.lua_call,t.exports.lua_callk=r.lua_callk,t.exports.lua_checkstack=r.lua_checkstack,t.exports.lua_close=o.lua_close,t.exports.lua_compare=r.lua_compare,t.exports.lua_concat=r.lua_concat,t.exports.lua_copy=r.lua_copy,t.exports.lua_createtable=r.lua_createtable,t.exports.lua_dump=r.lua_dump,t.exports.lua_error=r.lua_error,t.exports.lua_gc=r.lua_gc,t.exports.lua_getallocf=r.lua_getallocf,t.exports.lua_getextraspace=r.lua_getextraspace,t.exports.lua_getfield=r.lua_getfield,t.exports.lua_getglobal=r.lua_getglobal,t.exports.lua_gethook=s.lua_gethook,t.exports.lua_gethookcount=s.lua_gethookcount,t.exports.lua_gethookmask=s.lua_gethookmask,t.exports.lua_geti=r.lua_geti,t.exports.lua_getinfo=s.lua_getinfo,t.exports.lua_getlocal=s.lua_getlocal,t.exports.lua_getmetatable=r.lua_getmetatable,t.exports.lua_getstack=s.lua_getstack,t.exports.lua_gettable=r.lua_gettable,t.exports.lua_gettop=r.lua_gettop,t.exports.lua_getupvalue=r.lua_getupvalue,t.exports.lua_getuservalue=r.lua_getuservalue,t.exports.lua_insert=r.lua_insert,t.exports.lua_isboolean=r.lua_isboolean,t.exports.lua_iscfunction=r.lua_iscfunction,t.exports.lua_isfunction=r.lua_isfunction,t.exports.lua_isinteger=r.lua_isinteger,t.exports.lua_islightuserdata=r.lua_islightuserdata,t.exports.lua_isnil=r.lua_isnil,t.exports.lua_isnone=r.lua_isnone,t.exports.lua_isnoneornil=r.lua_isnoneornil,t.exports.lua_isnumber=r.lua_isnumber,t.exports.lua_isproxy=r.lua_isproxy,t.exports.lua_isstring=r.lua_isstring,t.exports.lua_istable=r.lua_istable,t.exports.lua_isthread=r.lua_isthread,t.exports.lua_isuserdata=r.lua_isuserdata,t.exports.lua_isyieldable=a.lua_isyieldable,t.exports.lua_len=r.lua_len,t.exports.lua_load=r.lua_load,t.exports.lua_newstate=o.lua_newstate,t.exports.lua_newtable=r.lua_newtable,t.exports.lua_newthread=o.lua_newthread,t.exports.lua_newuserdata=r.lua_newuserdata,t.exports.lua_next=r.lua_next,t.exports.lua_pcall=r.lua_pcall,t.exports.lua_pcallk=r.lua_pcallk,t.exports.lua_pop=r.lua_pop,t.exports.lua_pushboolean=r.lua_pushboolean,t.exports.lua_pushcclosure=r.lua_pushcclosure,t.exports.lua_pushcfunction=r.lua_pushcfunction,t.exports.lua_pushfstring=r.lua_pushfstring,t.exports.lua_pushglobaltable=r.lua_pushglobaltable,t.exports.lua_pushinteger=r.lua_pushinteger,t.exports.lua_pushjsclosure=r.lua_pushjsclosure,t.exports.lua_pushjsfunction=r.lua_pushjsfunction,t.exports.lua_pushlightuserdata=r.lua_pushlightuserdata,t.exports.lua_pushliteral=r.lua_pushliteral,t.exports.lua_pushlstring=r.lua_pushlstring,t.exports.lua_pushnil=r.lua_pushnil,t.exports.lua_pushnumber=r.lua_pushnumber,t.exports.lua_pushstring=r.lua_pushstring,t.exports.lua_pushthread=r.lua_pushthread,t.exports.lua_pushvalue=r.lua_pushvalue,t.exports.lua_pushvfstring=r.lua_pushvfstring,t.exports.lua_rawequal=r.lua_rawequal,t.exports.lua_rawget=r.lua_rawget,t.exports.lua_rawgeti=r.lua_rawgeti,t.exports.lua_rawgetp=r.lua_rawgetp,t.exports.lua_rawlen=r.lua_rawlen,t.exports.lua_rawset=r.lua_rawset,t.exports.lua_rawseti=r.lua_rawseti,t.exports.lua_rawsetp=r.lua_rawsetp,t.exports.lua_register=r.lua_register,t.exports.lua_remove=r.lua_remove,t.exports.lua_replace=r.lua_replace,t.exports.lua_resume=a.lua_resume,t.exports.lua_rotate=r.lua_rotate,t.exports.lua_setallof=a.lua_setallof,t.exports.lua_setfield=r.lua_setfield,t.exports.lua_setglobal=r.lua_setglobal,t.exports.lua_sethook=s.lua_sethook,t.exports.lua_seti=r.lua_seti,t.exports.lua_setlocal=s.lua_setlocal,t.exports.lua_setmetatable=r.lua_setmetatable,t.exports.lua_settable=r.lua_settable,t.exports.lua_settop=r.lua_settop,t.exports.lua_setupvalue=r.lua_setupvalue,t.exports.lua_setuservalue=r.lua_setuservalue,t.exports.lua_status=r.lua_status,t.exports.lua_stringtonumber=r.lua_stringtonumber,t.exports.lua_toboolean=r.lua_toboolean,t.exports.lua_todataview=r.lua_todataview,t.exports.lua_tointeger=r.lua_tointeger,t.exports.lua_tointegerx=r.lua_tointegerx,t.exports.lua_tojsstring=r.lua_tojsstring,t.exports.lua_tolstring=r.lua_tolstring,t.exports.lua_tonumber=r.lua_tonumber,t.exports.lua_tonumberx=r.lua_tonumberx,t.exports.lua_topointer=r.lua_topointer,t.exports.lua_toproxy=r.lua_toproxy,t.exports.lua_tostring=r.lua_tostring,t.exports.lua_tothread=r.lua_tothread,t.exports.lua_touserdata=r.lua_touserdata,t.exports.lua_type=r.lua_type,t.exports.lua_typename=r.lua_typename,t.exports.lua_upvalueid=r.lua_upvalueid,t.exports.lua_upvaluejoin=r.lua_upvaluejoin,t.exports.lua_version=r.lua_version,t.exports.lua_xmove=r.lua_xmove,t.exports.lua_yield=a.lua_yield,t.exports.lua_yieldk=a.lua_yieldk,t.exports.lua_tocfunction=r.lua_tocfunction},254:(t,e,n)=>{"use strict";const i={},{LUA_VERSION_MAJOR:r,LUA_VERSION_MINOR:s,to_luastring:a}=n(696);t.exports.LUA_PATH_SEP=";";t.exports.LUA_PATH_MARK="?";t.exports.LUA_EXEC_DIR="!";const o=r+"."+s;t.exports.LUA_VDIR=o;{const e="/";t.exports.LUA_DIRSEP=e;const n="./lua/"+o+"/";t.exports.LUA_LDIR=n;const i=n;t.exports.LUA_JSDIR=i;const r=a(n+"?.lua;"+n+"?/init.lua;./?.lua;./?/init.lua");t.exports.LUA_PATH_DEFAULT=r;const s=a(i+"?.js;"+i+"loadall.js;./?.js");t.exports.LUA_JSPATH_DEFAULT=s}const l=i.LUA_COMPAT_FLOATSTRING||!1,h=-2147483648,u=i.LUAI_MAXSTACK||1e6,c=i.LUA_IDSIZE||59,d=i.LUAL_BUFFERSIZE||8192,f=function(t,e){for(var n=Math.min(3,Math.ceil(Math.abs(e)/1023)),i=t,r=0;r<n;r++)i*=Math.pow(2,Math.floor((e+r)/n));return i};t.exports.LUAI_MAXSTACK=u,t.exports.LUA_COMPAT_FLOATSTRING=l,t.exports.LUA_IDSIZE=c,t.exports.LUA_INTEGER_FMT="%d",t.exports.LUA_INTEGER_FRMLEN="",t.exports.LUA_MAXINTEGER=2147483647,t.exports.LUA_MININTEGER=h,t.exports.LUA_NUMBER_FMT="%.14g",t.exports.LUA_NUMBER_FRMLEN="",t.exports.LUAL_BUFFERSIZE=d,t.exports.frexp=function(t){if(0===t)return[t,0];var e=new DataView(new ArrayBuffer(8));e.setFloat64(0,t);var n=e.getUint32(0)>>>20&2047;0===n&&(e.setFloat64(0,t*Math.pow(2,64)),n=(e.getUint32(0)>>>20&2047)-64);var i=n-1022;return[f(t,-i),i]},t.exports.ldexp=f,t.exports.lua_getlocaledecpoint=function(){return 46},t.exports.lua_integer2str=function(t){return String(t)},t.exports.lua_number2str=function(t){return String(Number(t.toPrecision(14)))},t.exports.lua_numbertointeger=function(t){return t>=h&&t<2147483648&&t},t.exports.luai_apicheck=function(t,e){if(!e)throw Error(e)}},855:(t,e,n)=>{"use strict";const{LUA_SIGNATURE:i,constant_types:{LUA_TBOOLEAN:r,LUA_TLNGSTR:s,LUA_TNIL:a,LUA_TNUMFLT:o,LUA_TNUMINT:l,LUA_TSHRSTR:h},thread_status:{LUA_ERRSYNTAX:u},is_luastring:c,luastring_eq:d,to_luastring:f}=n(696),p=n(179),m=n(196),_=n(853),{MAXARG_sBx:g,POS_A:v,POS_Ax:b,POS_B:w,POS_Bx:A,POS_C:y,POS_OP:x,SIZE_A:T,SIZE_Ax:L,SIZE_B:E,SIZE_Bx:S,SIZE_C:M,SIZE_OP:k}=n(451),{lua_assert:R}=n(502),{luaS_bless:I}=n(415),{luaZ_read:U,ZIO:O}=n(498);let C=[25,147,13,10,26,10];class B{constructor(t,e,n){this.intSize=4,this.size_tSize=4,this.instructionSize=4,this.integerSize=4,this.numberSize=8,R(e instanceof O,"BytecodeParser only operates on a ZIO"),R(c(n)),64===n[0]||61===n[0]?this.name=n.subarray(1):n[0]==i[0]?this.name=f("binary string",!0):this.name=n,this.L=t,this.Z=e,this.arraybuffer=new ArrayBuffer(Math.max(this.intSize,this.size_tSize,this.instructionSize,this.integerSize,this.numberSize)),this.dv=new DataView(this.arraybuffer),this.u8=new Uint8Array(this.arraybuffer)}read(t){let e=new Uint8Array(t);return 0!==U(this.Z,e,0,t)&&this.error("truncated"),e}LoadByte(){return 0!==U(this.Z,this.u8,0,1)&&this.error("truncated"),this.u8[0]}LoadInt(){return 0!==U(this.Z,this.u8,0,this.intSize)&&this.error("truncated"),this.dv.getInt32(0,!0)}LoadNumber(){return 0!==U(this.Z,this.u8,0,this.numberSize)&&this.error("truncated"),this.dv.getFloat64(0,!0)}LoadInteger(){return 0!==U(this.Z,this.u8,0,this.integerSize)&&this.error("truncated"),this.dv.getInt32(0,!0)}LoadSize_t(){return this.LoadInteger()}LoadString(){let t=this.LoadByte();return 255===t&&(t=this.LoadSize_t()),0===t?null:I(this.L,this.read(t-1))}static MASK1(t,e){return~(-1<<t)<<e}LoadCode(t){let e=this.LoadInt(),n=B;for(let i=0;i<e;i++){0!==U(this.Z,this.u8,0,this.instructionSize)&&this.error("truncated");let e=this.dv.getUint32(0,!0);t.code[i]={code:e,opcode:e>>x&n.MASK1(k,0),A:e>>v&n.MASK1(T,0),B:e>>w&n.MASK1(E,0),C:e>>y&n.MASK1(M,0),Bx:e>>A&n.MASK1(S,0),Ax:e>>b&n.MASK1(L,0),sBx:(e>>A&n.MASK1(S,0))-g}}}LoadConstants(t){let e=this.LoadInt();for(let n=0;n<e;n++){let e=this.LoadByte();switch(e){case a:t.k.push(new _.TValue(a,null));break;case r:t.k.push(new _.TValue(r,0!==this.LoadByte()));break;case o:t.k.push(new _.TValue(o,this.LoadNumber()));break;case l:t.k.push(new _.TValue(l,this.LoadInteger()));break;case h:case s:t.k.push(new _.TValue(s,this.LoadString()));break;default:this.error(`unrecognized constant '${e}'`)}}}LoadProtos(t){let e=this.LoadInt();for(let n=0;n<e;n++)t.p[n]=new m.Proto(this.L),this.LoadFunction(t.p[n],t.source)}LoadUpvalues(t){let e=this.LoadInt();for(let n=0;n<e;n++)t.upvalues[n]={name:null,instack:this.LoadByte(),idx:this.LoadByte()}}LoadDebug(t){let e=this.LoadInt();for(let n=0;n<e;n++)t.lineinfo[n]=this.LoadInt();e=this.LoadInt();for(let n=0;n<e;n++)t.locvars[n]={varname:this.LoadString(),startpc:this.LoadInt(),endpc:this.LoadInt()};e=this.LoadInt();for(let n=0;n<e;n++)t.upvalues[n].name=this.LoadString()}LoadFunction(t,e){t.source=this.LoadString(),null===t.source&&(t.source=e),t.linedefined=this.LoadInt(),t.lastlinedefined=this.LoadInt(),t.numparams=this.LoadByte(),t.is_vararg=0!==this.LoadByte(),t.maxstacksize=this.LoadByte(),this.LoadCode(t),this.LoadConstants(t),this.LoadUpvalues(t),this.LoadProtos(t),this.LoadDebug(t)}checkliteral(t,e){let n=this.read(t.length);d(n,t)||this.error(e)}checkHeader(){this.checkliteral(i.subarray(1),"not a"),83!==this.LoadByte()&&this.error("version mismatch in"),0!==this.LoadByte()&&this.error("format mismatch in"),this.checkliteral(C,"corrupted"),this.intSize=this.LoadByte(),this.size_tSize=this.LoadByte(),this.instructionSize=this.LoadByte(),this.integerSize=this.LoadByte(),this.numberSize=this.LoadByte(),this.checksize(this.intSize,4,"int"),this.checksize(this.size_tSize,4,"size_t"),this.checksize(this.instructionSize,4,"instruction"),this.checksize(this.integerSize,4,"integer"),this.checksize(this.numberSize,8,"number"),22136!==this.LoadInteger()&&this.error("endianness mismatch in"),370.5!==this.LoadNumber()&&this.error("float format mismatch in")}error(t){_.luaO_pushfstring(this.L,f("%s: %s precompiled chunk"),this.name,f(t)),p.luaD_throw(this.L,u)}checksize(t,e,n){t!==e&&this.error(`${n} size mismatch in`)}}t.exports.luaU_undump=function(t,e,n){let i=new B(t,e,n);i.checkHeader();let r=m.luaF_newLclosure(t,i.LoadByte());return p.luaD_inctop(t),t.stack[t.top-1].setclLvalue(r),r.p=new m.Proto(t),i.LoadFunction(r.p,null),R(r.nupvalues===r.p.upvalues.length),r}},371:(t,e,n)=>{"use strict";const{LUA_MASKLINE:i,LUA_MASKCOUNT:r,LUA_MULTRET:s,constant_types:{LUA_TBOOLEAN:a,LUA_TLCF:o,LUA_TLIGHTUSERDATA:l,LUA_TLNGSTR:h,LUA_TNIL:u,LUA_TNUMBER:c,LUA_TNUMFLT:d,LUA_TNUMINT:f,LUA_TSHRSTR:p,LUA_TTABLE:m,LUA_TUSERDATA:_},to_luastring:g}=n(696),{INDEXK:v,ISK:b,LFIELDS_PER_FLUSH:w,OpCodesI:{OP_ADD:A,OP_BAND:y,OP_BNOT:x,OP_BOR:T,OP_BXOR:L,OP_CALL:E,OP_CLOSURE:S,OP_CONCAT:M,OP_DIV:k,OP_EQ:R,OP_EXTRAARG:I,OP_FORLOOP:U,OP_FORPREP:O,OP_GETTABLE:C,OP_GETTABUP:B,OP_GETUPVAL:P,OP_IDIV:N,OP_JMP:D,OP_LE:F,OP_LEN:V,OP_LOADBOOL:G,OP_LOADK:K,OP_LOADKX:j,OP_LOADNIL:z,OP_LT:H,OP_MOD:X,OP_MOVE:q,OP_MUL:Y,OP_NEWTABLE:$,OP_NOT:W,OP_POW:Z,OP_RETURN:J,OP_SELF:Q,OP_SETLIST:tt,OP_SETTABLE:et,OP_SETTABUP:nt,OP_SETUPVAL:it,OP_SHL:rt,OP_SHR:st,OP_SUB:at,OP_TAILCALL:ot,OP_TEST:lt,OP_TESTSET:ht,OP_TFORCALL:ut,OP_TFORLOOP:ct,OP_UNM:dt,OP_VARARG:ft}}=n(451),{LUA_MAXINTEGER:pt,LUA_MININTEGER:mt,lua_numbertointeger:_t}=n(254),{lua_assert:gt,luai_nummod:vt}=n(502),bt=n(853),wt=n(196),At=n(809),{luaS_bless:yt,luaS_eqlngstr:xt,luaS_hashlongstr:Tt}=n(415),Lt=n(179),Et=n(917),St=n(420),Mt=n(399),kt=function(t,e,n){return e+n.A},Rt=function(t,e,n){return e+n.B},It=function(t,e,n,i){return b(i.B)?n[v(i.B)]:t.stack[e+i.B]},Ut=function(t,e,n,i){return b(i.C)?n[v(i.C)]:t.stack[e+i.C]},Ot=function(t,e,n,i){let r=n.A;0!==r&&wt.luaF_close(t,e.l_base+r-1),e.l_savedpc+=n.sBx+i},Ct=function(t,e){Ot(t,e,e.l_code[e.l_savedpc],1)},Bt=function(t,e,n){if(e.ttisnumber()&&n.ttisnumber())return Kt(e,n)?1:0;if(e.ttisstring()&&n.ttisstring())return zt(e.tsvalue(),n.tsvalue())<0?1:0;{let i=Et.luaT_callorderTM(t,e,n,Et.TMS.TM_LT);return null===i&&Mt.luaG_ordererror(t,e,n),i?1:0}},Pt=function(t,e,n){let i;return e.ttisnumber()&&n.ttisnumber()?jt(e,n)?1:0:e.ttisstring()&&n.ttisstring()?zt(e.tsvalue(),n.tsvalue())<=0?1:0:(i=Et.luaT_callorderTM(t,e,n,Et.TMS.TM_LE),null!==i?i?1:0:(t.ci.callstatus|=At.CIST_LEQ,i=Et.luaT_callorderTM(t,n,e,Et.TMS.TM_LT),t.ci.callstatus^=At.CIST_LEQ,null===i&&Mt.luaG_ordererror(t,e,n),i?0:1))},Nt=function(t,e,n){if(e.ttype()!==n.ttype())return e.ttnov()!==n.ttnov()||e.ttnov()!==c?0:e.value===n.value?1:0;let i;switch(e.ttype()){case u:return 1;case a:return e.value==n.value?1:0;case l:case f:case d:case o:return e.value===n.value?1:0;case p:case h:return xt(e.tsvalue(),n.tsvalue())?1:0;case _:case m:if(e.value===n.value)return 1;if(null===t)return 0;i=Et.fasttm(t,e.value.metatable,Et.TMS.TM_EQ),null===i&&(i=Et.fasttm(t,n.value.metatable,Et.TMS.TM_EQ));break;default:return e.value===n.value?1:0}if(null===i)return 0;let r=new bt.TValue;return Et.luaT_callTM(t,i,e,n,r,1),r.l_isfalse()?0:1},Dt=function(t,e){let n=!1,i=Ft(t,e<0?2:1);if(!1===i){let r=Gt(t);if(!1===r)return!1;0<r?(i=pt,e<0&&(n=!0)):(i=mt,e>=0&&(n=!0))}return{stopnow:n,ilimit:i}},Ft=function(t,e){if(t.ttisfloat()){let n=t.value,i=Math.floor(n);if(n!==i){if(0===e)return!1;e>1&&(i+=1)}return _t(i)}if(t.ttisinteger())return t.value;if(Qt(t)){let n=new bt.TValue;if(bt.luaO_str2num(t.svalue(),n)===t.vslen()+1)return Ft(n,e)}return!1},Vt=function(t){return t.ttisinteger()?t.value:Ft(t,0)},Gt=function(t){if(t.ttnov()===c)return t.value;if(Qt(t)){let e=new bt.TValue;if(bt.luaO_str2num(t.svalue(),e)===t.vslen()+1)return e.value}return!1},Kt=function(t,e){return t.value<e.value},jt=function(t,e){return t.value<=e.value},zt=function(t,e){let n=Tt(t),i=Tt(e);return n===i?0:n<i?-1:1},Ht=function(t,e,n){let i;switch(n.ttype()){case m:{let r=n.value;if(i=Et.fasttm(t,r.metatable,Et.TMS.TM_LEN),null!==i)break;return void e.setivalue(St.luaH_getn(r))}case p:case h:return void e.setivalue(n.vslen());default:i=Et.luaT_gettmbyobj(t,n,Et.TMS.TM_LEN),i.ttisnil()&&Mt.luaG_typeerror(t,n,g("get length of",!0))}Et.luaT_callTM(t,i,n,n,e,1)},Xt=Math.imul||function(t,e){let n=65535&t,i=65535&e;return n*i+((t>>>16&65535)*i+n*(e>>>16&65535)<<16>>>0)|0},qt=function(t,e,n){return 0===n&&Mt.luaG_runerror(t,g("attempt to divide by zero")),0|Math.floor(e/n)},Yt=function(t,e,n){return 0===n&&Mt.luaG_runerror(t,g("attempt to perform 'n%%0'")),e-Math.floor(e/n)*n|0},$t=function(t,e){return e<0?e<=-32?0:t>>>-e:e>=32?0:t<<e},Wt=function(t,e,n,i){let r=t.cache;if(null!==r){let s=t.upvalues,a=s.length;for(let t=0;t<a;t++){let a=s[t].instack?n[i+s[t].idx]:e[s[t].idx];if(r.upvals[t]!==a)return null}}return r},Zt=function(t,e,n,i,r){let s=e.upvalues.length,a=e.upvalues,o=new bt.LClosure(t,s);o.p=e,t.stack[r].setclLvalue(o);for(let e=0;e<s;e++)a[e].instack?o.upvals[e]=wt.luaF_findupval(t,i+a[e].idx):o.upvals[e]=n[a[e].idx];e.cache=o},Jt=function(t){return t.ttisnumber()},Qt=function(t){return t.ttisstring()},te=function(t,e){let n=t.stack[e];return!!n.ttisstring()||!!Jt(n)&&(bt.luaO_tostring(t,n),!0)},ee=function(t){return t.ttisstring()&&0===t.vslen()},ne=function(t,e,n,i){let r=0;do{let s=t.stack[e-n],a=s.vslen(),o=s.svalue();i.set(o,r),r+=a}while(--n>0)},ie=function(t,e){gt(e>=2);do{let n=t.top,i=2;if((t.stack[n-2].ttisstring()||Jt(t.stack[n-2]))&&te(t,n-1))if(ee(t.stack[n-1]))te(t,n-2);else if(ee(t.stack[n-2]))bt.setobjs2s(t,n-2,n-1);else{let r=t.stack[n-1].vslen();for(i=1;i<e&&te(t,n-i-1);i++){r+=t.stack[n-i-1].vslen()}let s=new Uint8Array(r);ne(t,n,i,s);let a=yt(t,s);bt.setsvalue2s(t,n-i,a)}else Et.luaT_trybinTM(t,t.stack[n-2],t.stack[n-1],t.stack[n-2],Et.TMS.TM_CONCAT);for(e-=i-1;t.top>n-(i-1);)delete t.stack[--t.top]}while(e>1)},re=function(t,e,n,i){for(let r=0;r<2e3;r++){let r;if(e.ttistable()){let s=St.luaH_get(t,e.value,n);if(!s.ttisnil())return void bt.setobj2s(t,i,s);if(r=Et.fasttm(t,e.value.metatable,Et.TMS.TM_INDEX),null===r)return void t.stack[i].setnilvalue()}else r=Et.luaT_gettmbyobj(t,e,Et.TMS.TM_INDEX),r.ttisnil()&&Mt.luaG_typeerror(t,e,g("index",!0));if(r.ttisfunction())return void Et.luaT_callTM(t,r,e,n,t.stack[i],1);e=r}Mt.luaG_runerror(t,g("'__index' chain too long; possible loop",!0))},se=function(t,e,n,i){for(let r=0;r<2e3;r++){let r;if(e.ttistable()){let s=e.value;if(!St.luaH_get(t,s,n).ttisnil()||null===(r=Et.fasttm(t,s.metatable,Et.TMS.TM_NEWINDEX)))return St.luaH_setfrom(t,s,n,i),void St.invalidateTMcache(s)}else(r=Et.luaT_gettmbyobj(t,e,Et.TMS.TM_NEWINDEX)).ttisnil()&&Mt.luaG_typeerror(t,e,g("index",!0));if(r.ttisfunction())return void Et.luaT_callTM(t,r,e,n,i,0);e=r}Mt.luaG_runerror(t,g("'__newindex' chain too long; possible loop",!0))};t.exports.cvt2str=Jt,t.exports.cvt2num=Qt,t.exports.luaV_gettable=re,t.exports.luaV_concat=ie,t.exports.luaV_div=qt,t.exports.luaV_equalobj=Nt,t.exports.luaV_execute=function(t){let e=t.ci;e.callstatus|=At.CIST_FRESH;t:for(;;){gt(e===t.ci);let n=e.func.value,a=n.p.k,o=e.l_base,l=e.l_code[e.l_savedpc++];t.hookmask&(i|r)&&Mt.luaG_traceexec(t);let h=kt(0,o,l);switch(l.opcode){case q:bt.setobjs2s(t,h,Rt(0,o,l));break;case K:{let e=a[l.Bx];bt.setobj2s(t,h,e);break}case j:{gt(e.l_code[e.l_savedpc].opcode===I);let n=a[e.l_code[e.l_savedpc++].Ax];bt.setobj2s(t,h,n);break}case G:t.stack[h].setbvalue(0!==l.B),0!==l.C&&e.l_savedpc++;break;case z:for(let e=0;e<=l.B;e++)t.stack[h+e].setnilvalue();break;case P:{let e=l.B;bt.setobj2s(t,h,n.upvals[e]);break}case B:{let e=n.upvals[l.B],i=Ut(t,o,a,l);re(t,e,i,h);break}case C:{let e=t.stack[Rt(0,o,l)],n=Ut(t,o,a,l);re(t,e,n,h);break}case nt:{let e=n.upvals[l.A],i=It(t,o,a,l),r=Ut(t,o,a,l);se(t,e,i,r);break}case it:n.upvals[l.B].setfrom(t.stack[h]);break;case et:{let e=t.stack[h],n=It(t,o,a,l),i=Ut(t,o,a,l);se(t,e,n,i);break}case $:t.stack[h].sethvalue(St.luaH_new(t));break;case Q:{let e=Rt(0,o,l),n=Ut(t,o,a,l);bt.setobjs2s(t,h+1,e),re(t,t.stack[e],n,h);break}case A:{let e,n,i=It(t,o,a,l),r=Ut(t,o,a,l);i.ttisinteger()&&r.ttisinteger()?t.stack[h].setivalue(i.value+r.value|0):!1!==(e=Gt(i))&&!1!==(n=Gt(r))?t.stack[h].setfltvalue(e+n):Et.luaT_trybinTM(t,i,r,t.stack[h],Et.TMS.TM_ADD);break}case at:{let e,n,i=It(t,o,a,l),r=Ut(t,o,a,l);i.ttisinteger()&&r.ttisinteger()?t.stack[h].setivalue(i.value-r.value|0):!1!==(e=Gt(i))&&!1!==(n=Gt(r))?t.stack[h].setfltvalue(e-n):Et.luaT_trybinTM(t,i,r,t.stack[h],Et.TMS.TM_SUB);break}case Y:{let e,n,i=It(t,o,a,l),r=Ut(t,o,a,l);i.ttisinteger()&&r.ttisinteger()?t.stack[h].setivalue(Xt(i.value,r.value)):!1!==(e=Gt(i))&&!1!==(n=Gt(r))?t.stack[h].setfltvalue(e*n):Et.luaT_trybinTM(t,i,r,t.stack[h],Et.TMS.TM_MUL);break}case X:{let e,n,i=It(t,o,a,l),r=Ut(t,o,a,l);i.ttisinteger()&&r.ttisinteger()?t.stack[h].setivalue(Yt(t,i.value,r.value)):!1!==(e=Gt(i))&&!1!==(n=Gt(r))?t.stack[h].setfltvalue(vt(t,e,n)):Et.luaT_trybinTM(t,i,r,t.stack[h],Et.TMS.TM_MOD);break}case Z:{let e,n,i=It(t,o,a,l),r=Ut(t,o,a,l);!1!==(e=Gt(i))&&!1!==(n=Gt(r))?t.stack[h].setfltvalue(Math.pow(e,n)):Et.luaT_trybinTM(t,i,r,t.stack[h],Et.TMS.TM_POW);break}case k:{let e,n,i=It(t,o,a,l),r=Ut(t,o,a,l);!1!==(e=Gt(i))&&!1!==(n=Gt(r))?t.stack[h].setfltvalue(e/n):Et.luaT_trybinTM(t,i,r,t.stack[h],Et.TMS.TM_DIV);break}case N:{let e,n,i=It(t,o,a,l),r=Ut(t,o,a,l);i.ttisinteger()&&r.ttisinteger()?t.stack[h].setivalue(qt(t,i.value,r.value)):!1!==(e=Gt(i))&&!1!==(n=Gt(r))?t.stack[h].setfltvalue(Math.floor(e/n)):Et.luaT_trybinTM(t,i,r,t.stack[h],Et.TMS.TM_IDIV);break}case y:{let e,n,i=It(t,o,a,l),r=Ut(t,o,a,l);!1!==(e=Vt(i))&&!1!==(n=Vt(r))?t.stack[h].setivalue(e&n):Et.luaT_trybinTM(t,i,r,t.stack[h],Et.TMS.TM_BAND);break}case T:{let e,n,i=It(t,o,a,l),r=Ut(t,o,a,l);!1!==(e=Vt(i))&&!1!==(n=Vt(r))?t.stack[h].setivalue(e|n):Et.luaT_trybinTM(t,i,r,t.stack[h],Et.TMS.TM_BOR);break}case L:{let e,n,i=It(t,o,a,l),r=Ut(t,o,a,l);!1!==(e=Vt(i))&&!1!==(n=Vt(r))?t.stack[h].setivalue(e^n):Et.luaT_trybinTM(t,i,r,t.stack[h],Et.TMS.TM_BXOR);break}case rt:{let e,n,i=It(t,o,a,l),r=Ut(t,o,a,l);!1!==(e=Vt(i))&&!1!==(n=Vt(r))?t.stack[h].setivalue($t(e,n)):Et.luaT_trybinTM(t,i,r,t.stack[h],Et.TMS.TM_SHL);break}case st:{let e,n,i=It(t,o,a,l),r=Ut(t,o,a,l);!1!==(e=Vt(i))&&!1!==(n=Vt(r))?t.stack[h].setivalue($t(e,-n)):Et.luaT_trybinTM(t,i,r,t.stack[h],Et.TMS.TM_SHR);break}case dt:{let e,n=t.stack[Rt(0,o,l)];n.ttisinteger()?t.stack[h].setivalue(0|-n.value):!1!==(e=Gt(n))?t.stack[h].setfltvalue(-e):Et.luaT_trybinTM(t,n,n,t.stack[h],Et.TMS.TM_UNM);break}case x:{let e=t.stack[Rt(0,o,l)];e.ttisinteger()?t.stack[h].setivalue(~e.value):Et.luaT_trybinTM(t,e,e,t.stack[h],Et.TMS.TM_BNOT);break}case W:{let e=t.stack[Rt(0,o,l)];t.stack[h].setbvalue(e.l_isfalse());break}case V:Ht(t,t.stack[h],t.stack[Rt(0,o,l)]);break;case M:{let n=l.B,i=l.C;t.top=o+i+1,ie(t,i-n+1);let r=o+n;bt.setobjs2s(t,h,r),Lt.adjust_top(t,e.top);break}case D:Ot(t,e,l,0);break;case R:Nt(t,It(t,o,a,l),Ut(t,o,a,l))!==l.A?e.l_savedpc++:Ct(t,e);break;case H:Bt(t,It(t,o,a,l),Ut(t,o,a,l))!==l.A?e.l_savedpc++:Ct(t,e);break;case F:Pt(t,It(t,o,a,l),Ut(t,o,a,l))!==l.A?e.l_savedpc++:Ct(t,e);break;case lt:(l.C?t.stack[h].l_isfalse():!t.stack[h].l_isfalse())?e.l_savedpc++:Ct(t,e);break;case ht:{let n=Rt(0,o,l),i=t.stack[n];(l.C?i.l_isfalse():!i.l_isfalse())?e.l_savedpc++:(bt.setobjs2s(t,h,n),Ct(t,e));break}case E:{let n=l.B,i=l.C-1;if(0!==n&&Lt.adjust_top(t,h+n),!Lt.luaD_precall(t,h,i)){e=t.ci;continue t}i>=0&&Lt.adjust_top(t,e.top);break}case ot:{let i=l.B;if(0!==i&&Lt.adjust_top(t,h+i),!Lt.luaD_precall(t,h,s)){let i=t.ci,r=i.previous,s=i.func,a=i.funcOff,o=r.funcOff,l=i.l_base+s.value.p.numparams;n.p.p.length>0&&wt.luaF_close(t,r.l_base);for(let e=0;a+e<l;e++)bt.setobjs2s(t,o+e,a+e);r.l_base=o+(i.l_base-a),r.top=o+(t.top-a),Lt.adjust_top(t,r.top),r.l_code=i.l_code,r.l_savedpc=i.l_savedpc,r.callstatus|=At.CIST_TAIL,r.next=null,e=t.ci=r,gt(t.top===r.l_base+t.stack[o].value.p.maxstacksize);continue t}break}case J:{n.p.p.length>0&&wt.luaF_close(t,o);let i=Lt.luaD_poscall(t,e,h,0!==l.B?l.B-1:t.top-h);if(e.callstatus&At.CIST_FRESH)return;e=t.ci,i&&Lt.adjust_top(t,e.top),gt(e.callstatus&At.CIST_LUA),gt(e.l_code[e.l_savedpc-1].opcode===E);continue t}case U:if(t.stack[h].ttisinteger()){let n=t.stack[h+2].value,i=t.stack[h].value+n|0,r=t.stack[h+1].value;(0<n?i<=r:r<=i)&&(e.l_savedpc+=l.sBx,t.stack[h].chgivalue(i),t.stack[h+3].setivalue(i))}else{let n=t.stack[h+2].value,i=t.stack[h].value+n,r=t.stack[h+1].value;(0<n?i<=r:r<=i)&&(e.l_savedpc+=l.sBx,t.stack[h].chgfltvalue(i),t.stack[h+3].setfltvalue(i))}break;case O:{let n,i=t.stack[h],r=t.stack[h+1],s=t.stack[h+2];if(i.ttisinteger()&&s.ttisinteger()&&(n=Dt(r,s.value))){let t=n.stopnow?0:i.value;r.value=n.ilimit,i.value=t-s.value|0}else{let e,n,a;!1===(e=Gt(r))&&Mt.luaG_runerror(t,g("'for' limit must be a number",!0)),t.stack[h+1].setfltvalue(e),!1===(n=Gt(s))&&Mt.luaG_runerror(t,g("'for' step must be a number",!0)),t.stack[h+2].setfltvalue(n),!1===(a=Gt(i))&&Mt.luaG_runerror(t,g("'for' initial value must be a number",!0)),t.stack[h].setfltvalue(a-n)}e.l_savedpc+=l.sBx;break}case ut:{let n=h+3;bt.setobjs2s(t,n+2,h+2),bt.setobjs2s(t,n+1,h+1),bt.setobjs2s(t,n,h),Lt.adjust_top(t,n+3),Lt.luaD_call(t,n,l.C),Lt.adjust_top(t,e.top),l=e.l_code[e.l_savedpc++],h=kt(0,o,l),gt(l.opcode===ct)}case ct:t.stack[h+1].ttisnil()||(bt.setobjs2s(t,h,h+1),e.l_savedpc+=l.sBx);break;case tt:{let n=l.B,i=l.C;0===n&&(n=t.top-h-1),0===i&&(gt(e.l_code[e.l_savedpc].opcode===I),i=e.l_code[e.l_savedpc++].Ax);let r=t.stack[h].value,s=(i-1)*w+n;for(;n>0;n--)St.luaH_setint(r,s--,t.stack[h+n]);Lt.adjust_top(t,e.top);break}case S:{let e=n.p.p[l.Bx],i=Wt(e,n.upvals,t.stack,o);null===i?Zt(t,e,n.upvals,o,h):t.stack[h].setclLvalue(i);break}case ft:{let i,r=l.B-1,s=o-e.funcOff-n.p.numparams-1;for(s<0&&(s=0),r<0&&(r=s,Lt.luaD_checkstack(t,s),Lt.adjust_top(t,h+s)),i=0;i<r&&i<s;i++)bt.setobjs2s(t,h+i,o-s+i);for(;i<r;i++)t.stack[h+i].setnilvalue();break}case I:throw Error("invalid opcode")}}},t.exports.luaV_finishOp=function(t){let e=t.ci,n=e.l_base,i=e.l_code[e.l_savedpc-1],r=i.opcode;switch(r){case A:case at:case Y:case k:case N:case y:case T:case L:case rt:case st:case X:case Z:case dt:case x:case V:case B:case C:case Q:bt.setobjs2s(t,n+i.A,t.top-1),delete t.stack[--t.top];break;case F:case H:case R:{let n=!t.stack[t.top-1].l_isfalse();delete t.stack[--t.top],e.callstatus&At.CIST_LEQ&&(gt(r===F),e.callstatus^=At.CIST_LEQ,n=!n),gt(e.l_code[e.l_savedpc].opcode===D),n!==!!i.A&&e.l_savedpc++;break}case M:{let r=t.top-1,s=r-1-(n+i.B);bt.setobjs2s(t,r-2,r),s>1&&(t.top=r-1,ie(t,s)),bt.setobjs2s(t,e.l_base+i.A,t.top-1),Lt.adjust_top(t,e.top);break}case ut:gt(e.l_code[e.l_savedpc].opcode===ct),Lt.adjust_top(t,e.top);break;case E:i.C-1>=0&&Lt.adjust_top(t,e.top)}},t.exports.luaV_imul=Xt,t.exports.luaV_lessequal=Pt,t.exports.luaV_lessthan=Bt,t.exports.luaV_mod=Yt,t.exports.luaV_objlen=Ht,t.exports.luaV_rawequalobj=function(t,e){return Nt(null,t,e)},t.exports.luaV_shiftl=$t,t.exports.luaV_tointeger=Ft,t.exports.settable=se,t.exports.tointeger=Vt,t.exports.tonumber=Gt},498:(t,e,n)=>{"use strict";const{lua_assert:i}=n(502);const r=function(t){let e=t.reader(t.L,t.data);if(null===e)return-1;i(e instanceof Uint8Array,"Should only load binary of array of bytes");let n=e.length;return 0===n?-1:(t.buffer=e,t.off=0,t.n=n-1,t.buffer[t.off++])};t.exports.EOZ=-1,t.exports.luaZ_buffer=function(t){return t.buffer.subarray(0,t.n)},t.exports.luaZ_buffremove=function(t,e){t.n-=e},t.exports.luaZ_fill=r,t.exports.luaZ_read=function(t,e,n,i){for(;i;){if(0===t.n){if(-1===r(t))return i;t.n++,t.off--}let s=i<=t.n?i:t.n;for(let i=0;i<s;i++)e[n++]=t.buffer[t.off++];t.n-=s,0===t.n&&(t.buffer=null),i-=s}return 0},t.exports.luaZ_resetbuffer=function(t){t.n=0},t.exports.luaZ_resizebuffer=function(t,e,n){let i=new Uint8Array(n);e.buffer&&i.set(e.buffer),e.buffer=i},t.exports.MBuffer=class{constructor(){this.buffer=null,this.n=0}},t.exports.ZIO=class{constructor(t,e,n){this.L=t,i("function"==typeof e,"ZIO requires a reader"),this.reader=e,this.data=n,this.n=0,this.buffer=null,this.off=0}zgetc(){return this.n-- >0?this.buffer[this.off++]:r(this)}}}},e={};function n(i){var r=e[i];if(void 0!==r)return r.exports;var s=e[i]={exports:{}};return t[i](s,s.exports,n),s.exports}n.d=(t,e)=>{for(var i in e)n.o(e,i)&&!n.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:e[i]})},n.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),n.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},(()=>{"use strict";var t={};n.r(t),n.d(t,{ARRAY_TYPE:()=>b,EPSILON:()=>v,RANDOM:()=>w,equals:()=>T,setMatrixArrayType:()=>A,toRadian:()=>x});var e={};n.r(e),n.d(e,{LDU:()=>K,add:()=>j,adjoint:()=>O,clone:()=>E,copy:()=>S,create:()=>L,determinant:()=>C,equals:()=>X,exactEquals:()=>H,frob:()=>G,fromRotation:()=>D,fromScaling:()=>F,fromValues:()=>k,identity:()=>M,invert:()=>U,mul:()=>$,multiply:()=>B,multiplyScalar:()=>q,multiplyScalarAndAdd:()=>Y,rotate:()=>P,scale:()=>N,set:()=>R,str:()=>V,sub:()=>W,subtract:()=>z,transpose:()=>I});var i={};n.r(i),n.d(i,{add:()=>pt,clone:()=>J,copy:()=>Q,create:()=>Z,determinant:()=>rt,equals:()=>bt,exactEquals:()=>vt,frob:()=>ft,fromRotation:()=>ht,fromScaling:()=>ut,fromTranslation:()=>ct,fromValues:()=>et,identity:()=>tt,invert:()=>it,mul:()=>wt,multiply:()=>st,multiplyScalar:()=>_t,multiplyScalarAndAdd:()=>gt,rotate:()=>at,scale:()=>ot,set:()=>nt,str:()=>dt,sub:()=>At,subtract:()=>mt,translate:()=>lt});var r={};n.r(r),n.d(r,{add:()=>Xt,adjoint:()=>It,clone:()=>Tt,copy:()=>Lt,create:()=>yt,determinant:()=>Ut,equals:()=>Zt,exactEquals:()=>Wt,frob:()=>Ht,fromMat2d:()=>Vt,fromMat4:()=>xt,fromQuat:()=>Gt,fromRotation:()=>Dt,fromScaling:()=>Ft,fromTranslation:()=>Nt,fromValues:()=>Et,identity:()=>Mt,invert:()=>Rt,mul:()=>Jt,multiply:()=>Ot,multiplyScalar:()=>Yt,multiplyScalarAndAdd:()=>$t,normalFromMat4:()=>Kt,projection:()=>jt,rotate:()=>Bt,scale:()=>Pt,set:()=>St,str:()=>zt,sub:()=>Qt,subtract:()=>qt,translate:()=>Ct,transpose:()=>kt});var s={};n.r(s),n.d(s,{add:()=>Fe,adjoint:()=>le,clone:()=>ee,copy:()=>ne,create:()=>te,determinant:()=>he,equals:()=>ze,exactEquals:()=>je,frob:()=>De,fromQuat:()=>Re,fromQuat2:()=>Te,fromRotation:()=>be,fromRotationTranslation:()=>xe,fromRotationTranslationScale:()=>Me,fromRotationTranslationScaleOrigin:()=>ke,fromScaling:()=>ve,fromTranslation:()=>ge,fromValues:()=>ie,fromXRotation:()=>we,fromYRotation:()=>Ae,fromZRotation:()=>ye,frustum:()=>Ie,getRotation:()=>Se,getScaling:()=>Ee,getTranslation:()=>Le,identity:()=>se,invert:()=>oe,lookAt:()=>Be,mul:()=>He,multiply:()=>ue,multiplyScalar:()=>Ge,multiplyScalarAndAdd:()=>Ke,ortho:()=>Ce,perspective:()=>Ue,perspectiveFromFieldOfView:()=>Oe,rotate:()=>fe,rotateX:()=>pe,rotateY:()=>me,rotateZ:()=>_e,scale:()=>de,set:()=>re,str:()=>Ne,sub:()=>Xe,subtract:()=>Ve,targetTo:()=>Pe,translate:()=>ce,transpose:()=>ae});var a={};n.r(a),n.d(a,{add:()=>Qe,angle:()=>kn,bezier:()=>An,ceil:()=>rn,clone:()=>Ye,copy:()=>Ze,create:()=>qe,cross:()=>vn,dist:()=>Dn,distance:()=>cn,div:()=>Nn,divide:()=>nn,dot:()=>gn,equals:()=>On,exactEquals:()=>Un,floor:()=>sn,forEach:()=>Kn,fromValues:()=>We,hermite:()=>wn,inverse:()=>mn,len:()=>Vn,length:()=>$e,lerp:()=>bn,max:()=>on,min:()=>an,mul:()=>Pn,multiply:()=>en,negate:()=>pn,normalize:()=>_n,random:()=>yn,rotateX:()=>En,rotateY:()=>Sn,rotateZ:()=>Mn,round:()=>ln,scale:()=>hn,scaleAndAdd:()=>un,set:()=>Je,sqrDist:()=>Fn,sqrLen:()=>Gn,squaredDistance:()=>dn,squaredLength:()=>fn,str:()=>In,sub:()=>Bn,subtract:()=>tn,transformMat3:()=>Tn,transformMat4:()=>xn,transformQuat:()=>Ln,zero:()=>Rn});var o={};n.r(o),n.d(o,{add:()=>Yn,ceil:()=>Jn,clone:()=>zn,copy:()=>Xn,create:()=>jn,cross:()=>fi,dist:()=>Li,distance:()=>si,div:()=>Ti,divide:()=>Zn,dot:()=>di,equals:()=>Ai,exactEquals:()=>wi,floor:()=>Qn,forEach:()=>ki,fromValues:()=>Hn,inverse:()=>ui,len:()=>Si,length:()=>oi,lerp:()=>pi,max:()=>ei,min:()=>ti,mul:()=>xi,multiply:()=>Wn,negate:()=>hi,normalize:()=>ci,random:()=>mi,round:()=>ni,scale:()=>ii,scaleAndAdd:()=>ri,set:()=>qn,sqrDist:()=>Ei,sqrLen:()=>Mi,squaredDistance:()=>ai,squaredLength:()=>li,str:()=>bi,sub:()=>yi,subtract:()=>$n,transformMat4:()=>_i,transformQuat:()=>gi,zero:()=>vi});var l={};n.r(l),n.d(l,{add:()=>ar,calculateW:()=>Fi,clone:()=>nr,conjugate:()=>Xi,copy:()=>rr,create:()=>Ri,dot:()=>hr,equals:()=>gr,exactEquals:()=>_r,exp:()=>Vi,fromEuler:()=>Yi,fromMat3:()=>qi,fromValues:()=>ir,getAngle:()=>Ci,getAxisAngle:()=>Oi,identity:()=>Ii,invert:()=>Hi,len:()=>dr,length:()=>cr,lerp:()=>ur,ln:()=>Gi,mul:()=>or,multiply:()=>Bi,normalize:()=>mr,pow:()=>Ki,random:()=>zi,rotateX:()=>Pi,rotateY:()=>Ni,rotateZ:()=>Di,rotationTo:()=>vr,scale:()=>lr,set:()=>sr,setAxes:()=>wr,setAxisAngle:()=>Ui,slerp:()=>ji,sqlerp:()=>br,sqrLen:()=>pr,squaredLength:()=>fr,str:()=>$i});var h={};n.r(h),n.d(h,{add:()=>zr,clone:()=>yr,conjugate:()=>Zr,copy:()=>kr,create:()=>Ar,dot:()=>Yr,equals:()=>ss,exactEquals:()=>rs,fromMat4:()=>Mr,fromRotation:()=>Sr,fromRotationTranslation:()=>Lr,fromRotationTranslationValues:()=>Tr,fromTranslation:()=>Er,fromValues:()=>xr,getDual:()=>Or,getReal:()=>Ur,getTranslation:()=>Pr,identity:()=>Rr,invert:()=>Wr,len:()=>Qr,length:()=>Jr,lerp:()=>$r,mul:()=>Xr,multiply:()=>Hr,normalize:()=>ns,rotateAroundAxis:()=>jr,rotateByQuatAppend:()=>Gr,rotateByQuatPrepend:()=>Kr,rotateX:()=>Dr,rotateY:()=>Fr,rotateZ:()=>Vr,scale:()=>qr,set:()=>Ir,setDual:()=>Br,setReal:()=>Cr,sqrLen:()=>es,squaredLength:()=>ts,str:()=>is,translate:()=>Nr});var u={};n.r(u),n.d(u,{add:()=>cs,angle:()=>Ds,ceil:()=>ms,clone:()=>os,copy:()=>hs,create:()=>as,cross:()=>Rs,dist:()=>qs,distance:()=>ys,div:()=>Xs,divide:()=>ps,dot:()=>ks,equals:()=>Ks,exactEquals:()=>Gs,floor:()=>_s,forEach:()=>Ws,fromValues:()=>ls,inverse:()=>Ss,len:()=>js,length:()=>Ts,lerp:()=>Is,max:()=>vs,min:()=>gs,mul:()=>Hs,multiply:()=>fs,negate:()=>Es,normalize:()=>Ms,random:()=>Us,rotate:()=>Ns,round:()=>bs,scale:()=>ws,scaleAndAdd:()=>As,set:()=>us,sqrDist:()=>Ys,sqrLen:()=>$s,squaredDistance:()=>xs,squaredLength:()=>Ls,str:()=>Vs,sub:()=>zs,subtract:()=>ds,transformMat2:()=>Os,transformMat2d:()=>Cs,transformMat3:()=>Bs,transformMat4:()=>Ps,zero:()=>Fs});var c={};n.r(c),n.d(c,{glMatrix:()=>t,mat2:()=>e,mat2d:()=>i,mat3:()=>r,mat4:()=>s,quat:()=>l,quat2:()=>h,vec2:()=>u,vec3:()=>a,vec4:()=>o});var d={};n.r(d),n.d(d,{QUAT_DEFAULT:()=>ia,QUAT_ZERO:()=>na,VEC3_ONE:()=>ea,VEC3_UNIT_X:()=>Zs,VEC3_UNIT_Y:()=>Js,VEC3_UNIT_Z:()=>Qs,VEC3_ZERO:()=>ta,distanceToPlane:()=>aa,distanceToPlane2:()=>oa,distanceToPlane3:()=>la,normalizePlane:()=>da,planeLength:()=>ca,quatLookAt:()=>ga,testCell:()=>ua,testSphere:()=>ha,unpackPlanes:()=>fa,unproject:()=>sa});var f={};n.r(f),n.d(f,{bezier:()=>Ta,clamp:()=>Aa,copysign:()=>La,degToRad:()=>va,hermite:()=>xa,isPowerOfTwo:()=>Sa,lerp:()=>ya,powerOfTwo:()=>Ea,radToDeg:()=>ba,randomInRange:()=>wa});var p={};n.r(p),n.d(p,{blobToImage:()=>Ua,blobToImageData:()=>Oa,imageDataToBlob:()=>Ca,imageDataToDataUrl:()=>Ba,imageDataToImage:()=>Pa,imageToImageData:()=>Na,resizeImageData:()=>Da});var m={};n.r(m),n.d(m,{basename:()=>Ao,extname:()=>yo,filename:()=>xo});var _={};n.r(_),n.d(_,{JassAgent:()=>iv,JassAiDifficulty:()=>Lv,JassAllianceType:()=>_v,JassAttackType:()=>rb,JassBlendMode:()=>Zv,JassCameraField:()=>Hv,JassCameraSetup:()=>Xv,JassDamageType:()=>sb,JassDialogEvent:()=>Ov,JassEffectType:()=>Qv,JassEventId:()=>Ev,JassFGameState:()=>wv,JassFogState:()=>eb,JassForce:()=>ov,JassGameDifficulty:()=>Pv,JassGameEvent:()=>Sv,JassGameSpeed:()=>Bv,JassGameState:()=>vv,JassGameType:()=>Nv,JassGroup:()=>lv,JassHandle:()=>nv,JassHashtable:()=>hb,JassIGameState:()=>bv,JassItemType:()=>ib,JassLimitOp:()=>Iv,JassLocation:()=>cv,JassMapControl:()=>Kv,JassMapDensity:()=>Gv,JassMapFlag:()=>Dv,JassMapSetting:()=>Vv,JassMapVisibility:()=>Fv,JassPathingType:()=>lb,JassPlacement:()=>Yv,JassPlayer:()=>rv,JassPlayerColor:()=>qv,JassPlayerEvent:()=>Mv,JassPlayerGameResult:()=>xv,JassPlayerScore:()=>yv,JassPlayerSlotState:()=>jv,JassPlayerState:()=>Av,JassPlayerUnitEvent:()=>kv,JassRace:()=>mv,JassRacePreference:()=>gv,JassRarityControl:()=>Wv,JassRect:()=>fv,JassRegion:()=>dv,JassSoundType:()=>ob,JassStartLocPrio:()=>$v,JassTexMapFlags:()=>Jv,JassTimer:()=>uv,JassTrigger:()=>hv,JassUnit:()=>av,JassUnitEvent:()=>Rv,JassUnitState:()=>Tv,JassUnitType:()=>Cv,JassVersion:()=>nb,JassVolumeGroup:()=>zv,JassWeaponType:()=>ab,JassWeatherEffect:()=>tb,JassWidget:()=>sv,JassWidgetEvent:()=>Uv});var g={};n.r(g),n.d(g,{createCube:()=>db,createCylinder:()=>_b,createFrustum:()=>vb,createRectangle:()=>ub,createSphere:()=>pb,createUnitCube:()=>fb,createUnitCylinder:()=>gb,createUnitRectangle:()=>cb,createUnitSphere:()=>mb});var v=1e-6,b="undefined"!=typeof Float32Array?Float32Array:Array,w=Math.random;function A(t){b=t}var y=Math.PI/180;function x(t){return t*y}function T(t,e){return Math.abs(t-e)<=v*Math.max(1,Math.abs(t),Math.abs(e))}function L(){var t=new b(4);return b!=Float32Array&&(t[1]=0,t[2]=0),t[0]=1,t[3]=1,t}function E(t){var e=new b(4);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e}function S(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t}function M(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t}function k(t,e,n,i){var r=new b(4);return r[0]=t,r[1]=e,r[2]=n,r[3]=i,r}function R(t,e,n,i,r){return t[0]=e,t[1]=n,t[2]=i,t[3]=r,t}function I(t,e){if(t===e){var n=e[1];t[1]=e[2],t[2]=n}else t[0]=e[0],t[1]=e[2],t[2]=e[1],t[3]=e[3];return t}function U(t,e){var n=e[0],i=e[1],r=e[2],s=e[3],a=n*s-r*i;return a?(a=1/a,t[0]=s*a,t[1]=-i*a,t[2]=-r*a,t[3]=n*a,t):null}function O(t,e){var n=e[0];return t[0]=e[3],t[1]=-e[1],t[2]=-e[2],t[3]=n,t}function C(t){return t[0]*t[3]-t[2]*t[1]}function B(t,e,n){var i=e[0],r=e[1],s=e[2],a=e[3],o=n[0],l=n[1],h=n[2],u=n[3];return t[0]=i*o+s*l,t[1]=r*o+a*l,t[2]=i*h+s*u,t[3]=r*h+a*u,t}function P(t,e,n){var i=e[0],r=e[1],s=e[2],a=e[3],o=Math.sin(n),l=Math.cos(n);return t[0]=i*l+s*o,t[1]=r*l+a*o,t[2]=i*-o+s*l,t[3]=r*-o+a*l,t}function N(t,e,n){var i=e[0],r=e[1],s=e[2],a=e[3],o=n[0],l=n[1];return t[0]=i*o,t[1]=r*o,t[2]=s*l,t[3]=a*l,t}function D(t,e){var n=Math.sin(e),i=Math.cos(e);return t[0]=i,t[1]=n,t[2]=-n,t[3]=i,t}function F(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=e[1],t}function V(t){return"mat2("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"}function G(t){return Math.hypot(t[0],t[1],t[2],t[3])}function K(t,e,n,i){return t[2]=i[2]/i[0],n[0]=i[0],n[1]=i[1],n[3]=i[3]-t[2]*n[1],[t,e,n]}function j(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t[3]=e[3]+n[3],t}function z(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t[3]=e[3]-n[3],t}function H(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]}function X(t,e){var n=t[0],i=t[1],r=t[2],s=t[3],a=e[0],o=e[1],l=e[2],h=e[3];return Math.abs(n-a)<=v*Math.max(1,Math.abs(n),Math.abs(a))&&Math.abs(i-o)<=v*Math.max(1,Math.abs(i),Math.abs(o))&&Math.abs(r-l)<=v*Math.max(1,Math.abs(r),Math.abs(l))&&Math.abs(s-h)<=v*Math.max(1,Math.abs(s),Math.abs(h))}function q(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t}function Y(t,e,n,i){return t[0]=e[0]+n[0]*i,t[1]=e[1]+n[1]*i,t[2]=e[2]+n[2]*i,t[3]=e[3]+n[3]*i,t}Math.hypot||(Math.hypot=function(){for(var t=0,e=arguments.length;e--;)t+=arguments[e]*arguments[e];return Math.sqrt(t)});var $=B,W=z;function Z(){var t=new b(6);return b!=Float32Array&&(t[1]=0,t[2]=0,t[4]=0,t[5]=0),t[0]=1,t[3]=1,t}function J(t){var e=new b(6);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e}function Q(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t}function tt(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t[4]=0,t[5]=0,t}function et(t,e,n,i,r,s){var a=new b(6);return a[0]=t,a[1]=e,a[2]=n,a[3]=i,a[4]=r,a[5]=s,a}function nt(t,e,n,i,r,s,a){return t[0]=e,t[1]=n,t[2]=i,t[3]=r,t[4]=s,t[5]=a,t}function it(t,e){var n=e[0],i=e[1],r=e[2],s=e[3],a=e[4],o=e[5],l=n*s-i*r;return l?(l=1/l,t[0]=s*l,t[1]=-i*l,t[2]=-r*l,t[3]=n*l,t[4]=(r*o-s*a)*l,t[5]=(i*a-n*o)*l,t):null}function rt(t){return t[0]*t[3]-t[1]*t[2]}function st(t,e,n){var i=e[0],r=e[1],s=e[2],a=e[3],o=e[4],l=e[5],h=n[0],u=n[1],c=n[2],d=n[3],f=n[4],p=n[5];return t[0]=i*h+s*u,t[1]=r*h+a*u,t[2]=i*c+s*d,t[3]=r*c+a*d,t[4]=i*f+s*p+o,t[5]=r*f+a*p+l,t}function at(t,e,n){var i=e[0],r=e[1],s=e[2],a=e[3],o=e[4],l=e[5],h=Math.sin(n),u=Math.cos(n);return t[0]=i*u+s*h,t[1]=r*u+a*h,t[2]=i*-h+s*u,t[3]=r*-h+a*u,t[4]=o,t[5]=l,t}function ot(t,e,n){var i=e[0],r=e[1],s=e[2],a=e[3],o=e[4],l=e[5],h=n[0],u=n[1];return t[0]=i*h,t[1]=r*h,t[2]=s*u,t[3]=a*u,t[4]=o,t[5]=l,t}function lt(t,e,n){var i=e[0],r=e[1],s=e[2],a=e[3],o=e[4],l=e[5],h=n[0],u=n[1];return t[0]=i,t[1]=r,t[2]=s,t[3]=a,t[4]=i*h+s*u+o,t[5]=r*h+a*u+l,t}function ht(t,e){var n=Math.sin(e),i=Math.cos(e);return t[0]=i,t[1]=n,t[2]=-n,t[3]=i,t[4]=0,t[5]=0,t}function ut(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=e[1],t[4]=0,t[5]=0,t}function ct(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t[4]=e[0],t[5]=e[1],t}function dt(t){return"mat2d("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+")"}function ft(t){return Math.hypot(t[0],t[1],t[2],t[3],t[4],t[5],1)}function pt(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t[3]=e[3]+n[3],t[4]=e[4]+n[4],t[5]=e[5]+n[5],t}function mt(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t[3]=e[3]-n[3],t[4]=e[4]-n[4],t[5]=e[5]-n[5],t}function _t(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t[4]=e[4]*n,t[5]=e[5]*n,t}function gt(t,e,n,i){return t[0]=e[0]+n[0]*i,t[1]=e[1]+n[1]*i,t[2]=e[2]+n[2]*i,t[3]=e[3]+n[3]*i,t[4]=e[4]+n[4]*i,t[5]=e[5]+n[5]*i,t}function vt(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]}function bt(t,e){var n=t[0],i=t[1],r=t[2],s=t[3],a=t[4],o=t[5],l=e[0],h=e[1],u=e[2],c=e[3],d=e[4],f=e[5];return Math.abs(n-l)<=v*Math.max(1,Math.abs(n),Math.abs(l))&&Math.abs(i-h)<=v*Math.max(1,Math.abs(i),Math.abs(h))&&Math.abs(r-u)<=v*Math.max(1,Math.abs(r),Math.abs(u))&&Math.abs(s-c)<=v*Math.max(1,Math.abs(s),Math.abs(c))&&Math.abs(a-d)<=v*Math.max(1,Math.abs(a),Math.abs(d))&&Math.abs(o-f)<=v*Math.max(1,Math.abs(o),Math.abs(f))}var wt=st,At=mt;function yt(){var t=new b(9);return b!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[5]=0,t[6]=0,t[7]=0),t[0]=1,t[4]=1,t[8]=1,t}function xt(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10],t}function Tt(t){var e=new b(9);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e}function Lt(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t}function Et(t,e,n,i,r,s,a,o,l){var h=new b(9);return h[0]=t,h[1]=e,h[2]=n,h[3]=i,h[4]=r,h[5]=s,h[6]=a,h[7]=o,h[8]=l,h}function St(t,e,n,i,r,s,a,o,l,h){return t[0]=e,t[1]=n,t[2]=i,t[3]=r,t[4]=s,t[5]=a,t[6]=o,t[7]=l,t[8]=h,t}function Mt(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t}function kt(t,e){if(t===e){var n=e[1],i=e[2],r=e[5];t[1]=e[3],t[2]=e[6],t[3]=n,t[5]=e[7],t[6]=i,t[7]=r}else t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8];return t}function Rt(t,e){var n=e[0],i=e[1],r=e[2],s=e[3],a=e[4],o=e[5],l=e[6],h=e[7],u=e[8],c=u*a-o*h,d=-u*s+o*l,f=h*s-a*l,p=n*c+i*d+r*f;return p?(p=1/p,t[0]=c*p,t[1]=(-u*i+r*h)*p,t[2]=(o*i-r*a)*p,t[3]=d*p,t[4]=(u*n-r*l)*p,t[5]=(-o*n+r*s)*p,t[6]=f*p,t[7]=(-h*n+i*l)*p,t[8]=(a*n-i*s)*p,t):null}function It(t,e){var n=e[0],i=e[1],r=e[2],s=e[3],a=e[4],o=e[5],l=e[6],h=e[7],u=e[8];return t[0]=a*u-o*h,t[1]=r*h-i*u,t[2]=i*o-r*a,t[3]=o*l-s*u,t[4]=n*u-r*l,t[5]=r*s-n*o,t[6]=s*h-a*l,t[7]=i*l-n*h,t[8]=n*a-i*s,t}function Ut(t){var e=t[0],n=t[1],i=t[2],r=t[3],s=t[4],a=t[5],o=t[6],l=t[7],h=t[8];return e*(h*s-a*l)+n*(-h*r+a*o)+i*(l*r-s*o)}function Ot(t,e,n){var i=e[0],r=e[1],s=e[2],a=e[3],o=e[4],l=e[5],h=e[6],u=e[7],c=e[8],d=n[0],f=n[1],p=n[2],m=n[3],_=n[4],g=n[5],v=n[6],b=n[7],w=n[8];return t[0]=d*i+f*a+p*h,t[1]=d*r+f*o+p*u,t[2]=d*s+f*l+p*c,t[3]=m*i+_*a+g*h,t[4]=m*r+_*o+g*u,t[5]=m*s+_*l+g*c,t[6]=v*i+b*a+w*h,t[7]=v*r+b*o+w*u,t[8]=v*s+b*l+w*c,t}function Ct(t,e,n){var i=e[0],r=e[1],s=e[2],a=e[3],o=e[4],l=e[5],h=e[6],u=e[7],c=e[8],d=n[0],f=n[1];return t[0]=i,t[1]=r,t[2]=s,t[3]=a,t[4]=o,t[5]=l,t[6]=d*i+f*a+h,t[7]=d*r+f*o+u,t[8]=d*s+f*l+c,t}function Bt(t,e,n){var i=e[0],r=e[1],s=e[2],a=e[3],o=e[4],l=e[5],h=e[6],u=e[7],c=e[8],d=Math.sin(n),f=Math.cos(n);return t[0]=f*i+d*a,t[1]=f*r+d*o,t[2]=f*s+d*l,t[3]=f*a-d*i,t[4]=f*o-d*r,t[5]=f*l-d*s,t[6]=h,t[7]=u,t[8]=c,t}function Pt(t,e,n){var i=n[0],r=n[1];return t[0]=i*e[0],t[1]=i*e[1],t[2]=i*e[2],t[3]=r*e[3],t[4]=r*e[4],t[5]=r*e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t}function Nt(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=e[0],t[7]=e[1],t[8]=1,t}function Dt(t,e){var n=Math.sin(e),i=Math.cos(e);return t[0]=i,t[1]=n,t[2]=0,t[3]=-n,t[4]=i,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t}function Ft(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=e[1],t[5]=0,t[6]=0,t[7]=0,t[8]=1,t}function Vt(t,e){return t[0]=e[0],t[1]=e[1],t[2]=0,t[3]=e[2],t[4]=e[3],t[5]=0,t[6]=e[4],t[7]=e[5],t[8]=1,t}function Gt(t,e){var n=e[0],i=e[1],r=e[2],s=e[3],a=n+n,o=i+i,l=r+r,h=n*a,u=i*a,c=i*o,d=r*a,f=r*o,p=r*l,m=s*a,_=s*o,g=s*l;return t[0]=1-c-p,t[3]=u-g,t[6]=d+_,t[1]=u+g,t[4]=1-h-p,t[7]=f-m,t[2]=d-_,t[5]=f+m,t[8]=1-h-c,t}function Kt(t,e){var n=e[0],i=e[1],r=e[2],s=e[3],a=e[4],o=e[5],l=e[6],h=e[7],u=e[8],c=e[9],d=e[10],f=e[11],p=e[12],m=e[13],_=e[14],g=e[15],v=n*o-i*a,b=n*l-r*a,w=n*h-s*a,A=i*l-r*o,y=i*h-s*o,x=r*h-s*l,T=u*m-c*p,L=u*_-d*p,E=u*g-f*p,S=c*_-d*m,M=c*g-f*m,k=d*g-f*_,R=v*k-b*M+w*S+A*E-y*L+x*T;return R?(R=1/R,t[0]=(o*k-l*M+h*S)*R,t[1]=(l*E-a*k-h*L)*R,t[2]=(a*M-o*E+h*T)*R,t[3]=(r*M-i*k-s*S)*R,t[4]=(n*k-r*E+s*L)*R,t[5]=(i*E-n*M-s*T)*R,t[6]=(m*x-_*y+g*A)*R,t[7]=(_*w-p*x-g*b)*R,t[8]=(p*y-m*w+g*v)*R,t):null}function jt(t,e,n){return t[0]=2/e,t[1]=0,t[2]=0,t[3]=0,t[4]=-2/n,t[5]=0,t[6]=-1,t[7]=1,t[8]=1,t}function zt(t){return"mat3("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+")"}function Ht(t){return Math.hypot(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8])}function Xt(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t[3]=e[3]+n[3],t[4]=e[4]+n[4],t[5]=e[5]+n[5],t[6]=e[6]+n[6],t[7]=e[7]+n[7],t[8]=e[8]+n[8],t}function qt(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t[3]=e[3]-n[3],t[4]=e[4]-n[4],t[5]=e[5]-n[5],t[6]=e[6]-n[6],t[7]=e[7]-n[7],t[8]=e[8]-n[8],t}function Yt(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t[4]=e[4]*n,t[5]=e[5]*n,t[6]=e[6]*n,t[7]=e[7]*n,t[8]=e[8]*n,t}function $t(t,e,n,i){return t[0]=e[0]+n[0]*i,t[1]=e[1]+n[1]*i,t[2]=e[2]+n[2]*i,t[3]=e[3]+n[3]*i,t[4]=e[4]+n[4]*i,t[5]=e[5]+n[5]*i,t[6]=e[6]+n[6]*i,t[7]=e[7]+n[7]*i,t[8]=e[8]+n[8]*i,t}function Wt(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]}function Zt(t,e){var n=t[0],i=t[1],r=t[2],s=t[3],a=t[4],o=t[5],l=t[6],h=t[7],u=t[8],c=e[0],d=e[1],f=e[2],p=e[3],m=e[4],_=e[5],g=e[6],b=e[7],w=e[8];return Math.abs(n-c)<=v*Math.max(1,Math.abs(n),Math.abs(c))&&Math.abs(i-d)<=v*Math.max(1,Math.abs(i),Math.abs(d))&&Math.abs(r-f)<=v*Math.max(1,Math.abs(r),Math.abs(f))&&Math.abs(s-p)<=v*Math.max(1,Math.abs(s),Math.abs(p))&&Math.abs(a-m)<=v*Math.max(1,Math.abs(a),Math.abs(m))&&Math.abs(o-_)<=v*Math.max(1,Math.abs(o),Math.abs(_))&&Math.abs(l-g)<=v*Math.max(1,Math.abs(l),Math.abs(g))&&Math.abs(h-b)<=v*Math.max(1,Math.abs(h),Math.abs(b))&&Math.abs(u-w)<=v*Math.max(1,Math.abs(u),Math.abs(w))}var Jt=Ot,Qt=qt;function te(){var t=new b(16);return b!=Float32Array&&(t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0),t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}function ee(t){var e=new b(16);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function ne(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function ie(t,e,n,i,r,s,a,o,l,h,u,c,d,f,p,m){var _=new b(16);return _[0]=t,_[1]=e,_[2]=n,_[3]=i,_[4]=r,_[5]=s,_[6]=a,_[7]=o,_[8]=l,_[9]=h,_[10]=u,_[11]=c,_[12]=d,_[13]=f,_[14]=p,_[15]=m,_}function re(t,e,n,i,r,s,a,o,l,h,u,c,d,f,p,m,_){return t[0]=e,t[1]=n,t[2]=i,t[3]=r,t[4]=s,t[5]=a,t[6]=o,t[7]=l,t[8]=h,t[9]=u,t[10]=c,t[11]=d,t[12]=f,t[13]=p,t[14]=m,t[15]=_,t}function se(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function ae(t,e){if(t===e){var n=e[1],i=e[2],r=e[3],s=e[6],a=e[7],o=e[11];t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=n,t[6]=e[9],t[7]=e[13],t[8]=i,t[9]=s,t[11]=e[14],t[12]=r,t[13]=a,t[14]=o}else t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15];return t}function oe(t,e){var n=e[0],i=e[1],r=e[2],s=e[3],a=e[4],o=e[5],l=e[6],h=e[7],u=e[8],c=e[9],d=e[10],f=e[11],p=e[12],m=e[13],_=e[14],g=e[15],v=n*o-i*a,b=n*l-r*a,w=n*h-s*a,A=i*l-r*o,y=i*h-s*o,x=r*h-s*l,T=u*m-c*p,L=u*_-d*p,E=u*g-f*p,S=c*_-d*m,M=c*g-f*m,k=d*g-f*_,R=v*k-b*M+w*S+A*E-y*L+x*T;return R?(R=1/R,t[0]=(o*k-l*M+h*S)*R,t[1]=(r*M-i*k-s*S)*R,t[2]=(m*x-_*y+g*A)*R,t[3]=(d*y-c*x-f*A)*R,t[4]=(l*E-a*k-h*L)*R,t[5]=(n*k-r*E+s*L)*R,t[6]=(_*w-p*x-g*b)*R,t[7]=(u*x-d*w+f*b)*R,t[8]=(a*M-o*E+h*T)*R,t[9]=(i*E-n*M-s*T)*R,t[10]=(p*y-m*w+g*v)*R,t[11]=(c*w-u*y-f*v)*R,t[12]=(o*L-a*S-l*T)*R,t[13]=(n*S-i*L+r*T)*R,t[14]=(m*b-p*A-_*v)*R,t[15]=(u*A-c*b+d*v)*R,t):null}function le(t,e){var n=e[0],i=e[1],r=e[2],s=e[3],a=e[4],o=e[5],l=e[6],h=e[7],u=e[8],c=e[9],d=e[10],f=e[11],p=e[12],m=e[13],_=e[14],g=e[15];return t[0]=o*(d*g-f*_)-c*(l*g-h*_)+m*(l*f-h*d),t[1]=-(i*(d*g-f*_)-c*(r*g-s*_)+m*(r*f-s*d)),t[2]=i*(l*g-h*_)-o*(r*g-s*_)+m*(r*h-s*l),t[3]=-(i*(l*f-h*d)-o*(r*f-s*d)+c*(r*h-s*l)),t[4]=-(a*(d*g-f*_)-u*(l*g-h*_)+p*(l*f-h*d)),t[5]=n*(d*g-f*_)-u*(r*g-s*_)+p*(r*f-s*d),t[6]=-(n*(l*g-h*_)-a*(r*g-s*_)+p*(r*h-s*l)),t[7]=n*(l*f-h*d)-a*(r*f-s*d)+u*(r*h-s*l),t[8]=a*(c*g-f*m)-u*(o*g-h*m)+p*(o*f-h*c),t[9]=-(n*(c*g-f*m)-u*(i*g-s*m)+p*(i*f-s*c)),t[10]=n*(o*g-h*m)-a*(i*g-s*m)+p*(i*h-s*o),t[11]=-(n*(o*f-h*c)-a*(i*f-s*c)+u*(i*h-s*o)),t[12]=-(a*(c*_-d*m)-u*(o*_-l*m)+p*(o*d-l*c)),t[13]=n*(c*_-d*m)-u*(i*_-r*m)+p*(i*d-r*c),t[14]=-(n*(o*_-l*m)-a*(i*_-r*m)+p*(i*l-r*o)),t[15]=n*(o*d-l*c)-a*(i*d-r*c)+u*(i*l-r*o),t}function he(t){var e=t[0],n=t[1],i=t[2],r=t[3],s=t[4],a=t[5],o=t[6],l=t[7],h=t[8],u=t[9],c=t[10],d=t[11],f=t[12],p=t[13],m=t[14],_=t[15];return(e*a-n*s)*(c*_-d*m)-(e*o-i*s)*(u*_-d*p)+(e*l-r*s)*(u*m-c*p)+(n*o-i*a)*(h*_-d*f)-(n*l-r*a)*(h*m-c*f)+(i*l-r*o)*(h*p-u*f)}function ue(t,e,n){var i=e[0],r=e[1],s=e[2],a=e[3],o=e[4],l=e[5],h=e[6],u=e[7],c=e[8],d=e[9],f=e[10],p=e[11],m=e[12],_=e[13],g=e[14],v=e[15],b=n[0],w=n[1],A=n[2],y=n[3];return t[0]=b*i+w*o+A*c+y*m,t[1]=b*r+w*l+A*d+y*_,t[2]=b*s+w*h+A*f+y*g,t[3]=b*a+w*u+A*p+y*v,b=n[4],w=n[5],A=n[6],y=n[7],t[4]=b*i+w*o+A*c+y*m,t[5]=b*r+w*l+A*d+y*_,t[6]=b*s+w*h+A*f+y*g,t[7]=b*a+w*u+A*p+y*v,b=n[8],w=n[9],A=n[10],y=n[11],t[8]=b*i+w*o+A*c+y*m,t[9]=b*r+w*l+A*d+y*_,t[10]=b*s+w*h+A*f+y*g,t[11]=b*a+w*u+A*p+y*v,b=n[12],w=n[13],A=n[14],y=n[15],t[12]=b*i+w*o+A*c+y*m,t[13]=b*r+w*l+A*d+y*_,t[14]=b*s+w*h+A*f+y*g,t[15]=b*a+w*u+A*p+y*v,t}function ce(t,e,n){var i,r,s,a,o,l,h,u,c,d,f,p,m=n[0],_=n[1],g=n[2];return e===t?(t[12]=e[0]*m+e[4]*_+e[8]*g+e[12],t[13]=e[1]*m+e[5]*_+e[9]*g+e[13],t[14]=e[2]*m+e[6]*_+e[10]*g+e[14],t[15]=e[3]*m+e[7]*_+e[11]*g+e[15]):(i=e[0],r=e[1],s=e[2],a=e[3],o=e[4],l=e[5],h=e[6],u=e[7],c=e[8],d=e[9],f=e[10],p=e[11],t[0]=i,t[1]=r,t[2]=s,t[3]=a,t[4]=o,t[5]=l,t[6]=h,t[7]=u,t[8]=c,t[9]=d,t[10]=f,t[11]=p,t[12]=i*m+o*_+c*g+e[12],t[13]=r*m+l*_+d*g+e[13],t[14]=s*m+h*_+f*g+e[14],t[15]=a*m+u*_+p*g+e[15]),t}function de(t,e,n){var i=n[0],r=n[1],s=n[2];return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t[3]=e[3]*i,t[4]=e[4]*r,t[5]=e[5]*r,t[6]=e[6]*r,t[7]=e[7]*r,t[8]=e[8]*s,t[9]=e[9]*s,t[10]=e[10]*s,t[11]=e[11]*s,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function fe(t,e,n,i){var r,s,a,o,l,h,u,c,d,f,p,m,_,g,b,w,A,y,x,T,L,E,S,M,k=i[0],R=i[1],I=i[2],U=Math.hypot(k,R,I);return U<v?null:(k*=U=1/U,R*=U,I*=U,r=Math.sin(n),a=1-(s=Math.cos(n)),o=e[0],l=e[1],h=e[2],u=e[3],c=e[4],d=e[5],f=e[6],p=e[7],m=e[8],_=e[9],g=e[10],b=e[11],w=k*k*a+s,A=R*k*a+I*r,y=I*k*a-R*r,x=k*R*a-I*r,T=R*R*a+s,L=I*R*a+k*r,E=k*I*a+R*r,S=R*I*a-k*r,M=I*I*a+s,t[0]=o*w+c*A+m*y,t[1]=l*w+d*A+_*y,t[2]=h*w+f*A+g*y,t[3]=u*w+p*A+b*y,t[4]=o*x+c*T+m*L,t[5]=l*x+d*T+_*L,t[6]=h*x+f*T+g*L,t[7]=u*x+p*T+b*L,t[8]=o*E+c*S+m*M,t[9]=l*E+d*S+_*M,t[10]=h*E+f*S+g*M,t[11]=u*E+p*S+b*M,e!==t&&(t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t)}function pe(t,e,n){var i=Math.sin(n),r=Math.cos(n),s=e[4],a=e[5],o=e[6],l=e[7],h=e[8],u=e[9],c=e[10],d=e[11];return e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=s*r+h*i,t[5]=a*r+u*i,t[6]=o*r+c*i,t[7]=l*r+d*i,t[8]=h*r-s*i,t[9]=u*r-a*i,t[10]=c*r-o*i,t[11]=d*r-l*i,t}function me(t,e,n){var i=Math.sin(n),r=Math.cos(n),s=e[0],a=e[1],o=e[2],l=e[3],h=e[8],u=e[9],c=e[10],d=e[11];return e!==t&&(t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=s*r-h*i,t[1]=a*r-u*i,t[2]=o*r-c*i,t[3]=l*r-d*i,t[8]=s*i+h*r,t[9]=a*i+u*r,t[10]=o*i+c*r,t[11]=l*i+d*r,t}function _e(t,e,n){var i=Math.sin(n),r=Math.cos(n),s=e[0],a=e[1],o=e[2],l=e[3],h=e[4],u=e[5],c=e[6],d=e[7];return e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=s*r+h*i,t[1]=a*r+u*i,t[2]=o*r+c*i,t[3]=l*r+d*i,t[4]=h*r-s*i,t[5]=u*r-a*i,t[6]=c*r-o*i,t[7]=d*r-l*i,t}function ge(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=e[0],t[13]=e[1],t[14]=e[2],t[15]=1,t}function ve(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=e[1],t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=e[2],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function be(t,e,n){var i,r,s,a=n[0],o=n[1],l=n[2],h=Math.hypot(a,o,l);return h<v?null:(a*=h=1/h,o*=h,l*=h,i=Math.sin(e),s=1-(r=Math.cos(e)),t[0]=a*a*s+r,t[1]=o*a*s+l*i,t[2]=l*a*s-o*i,t[3]=0,t[4]=a*o*s-l*i,t[5]=o*o*s+r,t[6]=l*o*s+a*i,t[7]=0,t[8]=a*l*s+o*i,t[9]=o*l*s-a*i,t[10]=l*l*s+r,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t)}function we(t,e){var n=Math.sin(e),i=Math.cos(e);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=i,t[6]=n,t[7]=0,t[8]=0,t[9]=-n,t[10]=i,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function Ae(t,e){var n=Math.sin(e),i=Math.cos(e);return t[0]=i,t[1]=0,t[2]=-n,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=n,t[9]=0,t[10]=i,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function ye(t,e){var n=Math.sin(e),i=Math.cos(e);return t[0]=i,t[1]=n,t[2]=0,t[3]=0,t[4]=-n,t[5]=i,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function xe(t,e,n){var i=e[0],r=e[1],s=e[2],a=e[3],o=i+i,l=r+r,h=s+s,u=i*o,c=i*l,d=i*h,f=r*l,p=r*h,m=s*h,_=a*o,g=a*l,v=a*h;return t[0]=1-(f+m),t[1]=c+v,t[2]=d-g,t[3]=0,t[4]=c-v,t[5]=1-(u+m),t[6]=p+_,t[7]=0,t[8]=d+g,t[9]=p-_,t[10]=1-(u+f),t[11]=0,t[12]=n[0],t[13]=n[1],t[14]=n[2],t[15]=1,t}function Te(t,e){var n=new b(3),i=-e[0],r=-e[1],s=-e[2],a=e[3],o=e[4],l=e[5],h=e[6],u=e[7],c=i*i+r*r+s*s+a*a;return c>0?(n[0]=2*(o*a+u*i+l*s-h*r)/c,n[1]=2*(l*a+u*r+h*i-o*s)/c,n[2]=2*(h*a+u*s+o*r-l*i)/c):(n[0]=2*(o*a+u*i+l*s-h*r),n[1]=2*(l*a+u*r+h*i-o*s),n[2]=2*(h*a+u*s+o*r-l*i)),xe(t,e,n),t}function Le(t,e){return t[0]=e[12],t[1]=e[13],t[2]=e[14],t}function Ee(t,e){var n=e[0],i=e[1],r=e[2],s=e[4],a=e[5],o=e[6],l=e[8],h=e[9],u=e[10];return t[0]=Math.hypot(n,i,r),t[1]=Math.hypot(s,a,o),t[2]=Math.hypot(l,h,u),t}function Se(t,e){var n=new b(3);Ee(n,e);var i=1/n[0],r=1/n[1],s=1/n[2],a=e[0]*i,o=e[1]*r,l=e[2]*s,h=e[4]*i,u=e[5]*r,c=e[6]*s,d=e[8]*i,f=e[9]*r,p=e[10]*s,m=a+u+p,_=0;return m>0?(_=2*Math.sqrt(m+1),t[3]=.25*_,t[0]=(c-f)/_,t[1]=(d-l)/_,t[2]=(o-h)/_):a>u&&a>p?(_=2*Math.sqrt(1+a-u-p),t[3]=(c-f)/_,t[0]=.25*_,t[1]=(o+h)/_,t[2]=(d+l)/_):u>p?(_=2*Math.sqrt(1+u-a-p),t[3]=(d-l)/_,t[0]=(o+h)/_,t[1]=.25*_,t[2]=(c+f)/_):(_=2*Math.sqrt(1+p-a-u),t[3]=(o-h)/_,t[0]=(d+l)/_,t[1]=(c+f)/_,t[2]=.25*_),t}function Me(t,e,n,i){var r=e[0],s=e[1],a=e[2],o=e[3],l=r+r,h=s+s,u=a+a,c=r*l,d=r*h,f=r*u,p=s*h,m=s*u,_=a*u,g=o*l,v=o*h,b=o*u,w=i[0],A=i[1],y=i[2];return t[0]=(1-(p+_))*w,t[1]=(d+b)*w,t[2]=(f-v)*w,t[3]=0,t[4]=(d-b)*A,t[5]=(1-(c+_))*A,t[6]=(m+g)*A,t[7]=0,t[8]=(f+v)*y,t[9]=(m-g)*y,t[10]=(1-(c+p))*y,t[11]=0,t[12]=n[0],t[13]=n[1],t[14]=n[2],t[15]=1,t}function ke(t,e,n,i,r){var s=e[0],a=e[1],o=e[2],l=e[3],h=s+s,u=a+a,c=o+o,d=s*h,f=s*u,p=s*c,m=a*u,_=a*c,g=o*c,v=l*h,b=l*u,w=l*c,A=i[0],y=i[1],x=i[2],T=r[0],L=r[1],E=r[2],S=(1-(m+g))*A,M=(f+w)*A,k=(p-b)*A,R=(f-w)*y,I=(1-(d+g))*y,U=(_+v)*y,O=(p+b)*x,C=(_-v)*x,B=(1-(d+m))*x;return t[0]=S,t[1]=M,t[2]=k,t[3]=0,t[4]=R,t[5]=I,t[6]=U,t[7]=0,t[8]=O,t[9]=C,t[10]=B,t[11]=0,t[12]=n[0]+T-(S*T+R*L+O*E),t[13]=n[1]+L-(M*T+I*L+C*E),t[14]=n[2]+E-(k*T+U*L+B*E),t[15]=1,t}function Re(t,e){var n=e[0],i=e[1],r=e[2],s=e[3],a=n+n,o=i+i,l=r+r,h=n*a,u=i*a,c=i*o,d=r*a,f=r*o,p=r*l,m=s*a,_=s*o,g=s*l;return t[0]=1-c-p,t[1]=u+g,t[2]=d-_,t[3]=0,t[4]=u-g,t[5]=1-h-p,t[6]=f+m,t[7]=0,t[8]=d+_,t[9]=f-m,t[10]=1-h-c,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function Ie(t,e,n,i,r,s,a){var o=1/(n-e),l=1/(r-i),h=1/(s-a);return t[0]=2*s*o,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=2*s*l,t[6]=0,t[7]=0,t[8]=(n+e)*o,t[9]=(r+i)*l,t[10]=(a+s)*h,t[11]=-1,t[12]=0,t[13]=0,t[14]=a*s*2*h,t[15]=0,t}function Ue(t,e,n,i,r){var s,a=1/Math.tan(e/2);return t[0]=a/n,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=a,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,null!=r&&r!==1/0?(s=1/(i-r),t[10]=(r+i)*s,t[14]=2*r*i*s):(t[10]=-1,t[14]=-2*i),t}function Oe(t,e,n,i){var r=Math.tan(e.upDegrees*Math.PI/180),s=Math.tan(e.downDegrees*Math.PI/180),a=Math.tan(e.leftDegrees*Math.PI/180),o=Math.tan(e.rightDegrees*Math.PI/180),l=2/(a+o),h=2/(r+s);return t[0]=l,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=h,t[6]=0,t[7]=0,t[8]=-(a-o)*l*.5,t[9]=(r-s)*h*.5,t[10]=i/(n-i),t[11]=-1,t[12]=0,t[13]=0,t[14]=i*n/(n-i),t[15]=0,t}function Ce(t,e,n,i,r,s,a){var o=1/(e-n),l=1/(i-r),h=1/(s-a);return t[0]=-2*o,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*l,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*h,t[11]=0,t[12]=(e+n)*o,t[13]=(r+i)*l,t[14]=(a+s)*h,t[15]=1,t}function Be(t,e,n,i){var r,s,a,o,l,h,u,c,d,f,p=e[0],m=e[1],_=e[2],g=i[0],b=i[1],w=i[2],A=n[0],y=n[1],x=n[2];return Math.abs(p-A)<v&&Math.abs(m-y)<v&&Math.abs(_-x)<v?se(t):(u=p-A,c=m-y,d=_-x,r=b*(d*=f=1/Math.hypot(u,c,d))-w*(c*=f),s=w*(u*=f)-g*d,a=g*c-b*u,(f=Math.hypot(r,s,a))?(r*=f=1/f,s*=f,a*=f):(r=0,s=0,a=0),o=c*a-d*s,l=d*r-u*a,h=u*s-c*r,(f=Math.hypot(o,l,h))?(o*=f=1/f,l*=f,h*=f):(o=0,l=0,h=0),t[0]=r,t[1]=o,t[2]=u,t[3]=0,t[4]=s,t[5]=l,t[6]=c,t[7]=0,t[8]=a,t[9]=h,t[10]=d,t[11]=0,t[12]=-(r*p+s*m+a*_),t[13]=-(o*p+l*m+h*_),t[14]=-(u*p+c*m+d*_),t[15]=1,t)}function Pe(t,e,n,i){var r=e[0],s=e[1],a=e[2],o=i[0],l=i[1],h=i[2],u=r-n[0],c=s-n[1],d=a-n[2],f=u*u+c*c+d*d;f>0&&(u*=f=1/Math.sqrt(f),c*=f,d*=f);var p=l*d-h*c,m=h*u-o*d,_=o*c-l*u;return(f=p*p+m*m+_*_)>0&&(p*=f=1/Math.sqrt(f),m*=f,_*=f),t[0]=p,t[1]=m,t[2]=_,t[3]=0,t[4]=c*_-d*m,t[5]=d*p-u*_,t[6]=u*m-c*p,t[7]=0,t[8]=u,t[9]=c,t[10]=d,t[11]=0,t[12]=r,t[13]=s,t[14]=a,t[15]=1,t}function Ne(t){return"mat4("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+", "+t[9]+", "+t[10]+", "+t[11]+", "+t[12]+", "+t[13]+", "+t[14]+", "+t[15]+")"}function De(t){return Math.hypot(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15])}function Fe(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t[3]=e[3]+n[3],t[4]=e[4]+n[4],t[5]=e[5]+n[5],t[6]=e[6]+n[6],t[7]=e[7]+n[7],t[8]=e[8]+n[8],t[9]=e[9]+n[9],t[10]=e[10]+n[10],t[11]=e[11]+n[11],t[12]=e[12]+n[12],t[13]=e[13]+n[13],t[14]=e[14]+n[14],t[15]=e[15]+n[15],t}function Ve(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t[3]=e[3]-n[3],t[4]=e[4]-n[4],t[5]=e[5]-n[5],t[6]=e[6]-n[6],t[7]=e[7]-n[7],t[8]=e[8]-n[8],t[9]=e[9]-n[9],t[10]=e[10]-n[10],t[11]=e[11]-n[11],t[12]=e[12]-n[12],t[13]=e[13]-n[13],t[14]=e[14]-n[14],t[15]=e[15]-n[15],t}function Ge(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t[4]=e[4]*n,t[5]=e[5]*n,t[6]=e[6]*n,t[7]=e[7]*n,t[8]=e[8]*n,t[9]=e[9]*n,t[10]=e[10]*n,t[11]=e[11]*n,t[12]=e[12]*n,t[13]=e[13]*n,t[14]=e[14]*n,t[15]=e[15]*n,t}function Ke(t,e,n,i){return t[0]=e[0]+n[0]*i,t[1]=e[1]+n[1]*i,t[2]=e[2]+n[2]*i,t[3]=e[3]+n[3]*i,t[4]=e[4]+n[4]*i,t[5]=e[5]+n[5]*i,t[6]=e[6]+n[6]*i,t[7]=e[7]+n[7]*i,t[8]=e[8]+n[8]*i,t[9]=e[9]+n[9]*i,t[10]=e[10]+n[10]*i,t[11]=e[11]+n[11]*i,t[12]=e[12]+n[12]*i,t[13]=e[13]+n[13]*i,t[14]=e[14]+n[14]*i,t[15]=e[15]+n[15]*i,t}function je(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]&&t[9]===e[9]&&t[10]===e[10]&&t[11]===e[11]&&t[12]===e[12]&&t[13]===e[13]&&t[14]===e[14]&&t[15]===e[15]}function ze(t,e){var n=t[0],i=t[1],r=t[2],s=t[3],a=t[4],o=t[5],l=t[6],h=t[7],u=t[8],c=t[9],d=t[10],f=t[11],p=t[12],m=t[13],_=t[14],g=t[15],b=e[0],w=e[1],A=e[2],y=e[3],x=e[4],T=e[5],L=e[6],E=e[7],S=e[8],M=e[9],k=e[10],R=e[11],I=e[12],U=e[13],O=e[14],C=e[15];return Math.abs(n-b)<=v*Math.max(1,Math.abs(n),Math.abs(b))&&Math.abs(i-w)<=v*Math.max(1,Math.abs(i),Math.abs(w))&&Math.abs(r-A)<=v*Math.max(1,Math.abs(r),Math.abs(A))&&Math.abs(s-y)<=v*Math.max(1,Math.abs(s),Math.abs(y))&&Math.abs(a-x)<=v*Math.max(1,Math.abs(a),Math.abs(x))&&Math.abs(o-T)<=v*Math.max(1,Math.abs(o),Math.abs(T))&&Math.abs(l-L)<=v*Math.max(1,Math.abs(l),Math.abs(L))&&Math.abs(h-E)<=v*Math.max(1,Math.abs(h),Math.abs(E))&&Math.abs(u-S)<=v*Math.max(1,Math.abs(u),Math.abs(S))&&Math.abs(c-M)<=v*Math.max(1,Math.abs(c),Math.abs(M))&&Math.abs(d-k)<=v*Math.max(1,Math.abs(d),Math.abs(k))&&Math.abs(f-R)<=v*Math.max(1,Math.abs(f),Math.abs(R))&&Math.abs(p-I)<=v*Math.max(1,Math.abs(p),Math.abs(I))&&Math.abs(m-U)<=v*Math.max(1,Math.abs(m),Math.abs(U))&&Math.abs(_-O)<=v*Math.max(1,Math.abs(_),Math.abs(O))&&Math.abs(g-C)<=v*Math.max(1,Math.abs(g),Math.abs(C))}var He=ue,Xe=Ve;function qe(){var t=new b(3);return b!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t}function Ye(t){var e=new b(3);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}function $e(t){var e=t[0],n=t[1],i=t[2];return Math.hypot(e,n,i)}function We(t,e,n){var i=new b(3);return i[0]=t,i[1]=e,i[2]=n,i}function Ze(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function Je(t,e,n,i){return t[0]=e,t[1]=n,t[2]=i,t}function Qe(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t}function tn(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t}function en(t,e,n){return t[0]=e[0]*n[0],t[1]=e[1]*n[1],t[2]=e[2]*n[2],t}function nn(t,e,n){return t[0]=e[0]/n[0],t[1]=e[1]/n[1],t[2]=e[2]/n[2],t}function rn(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t[2]=Math.ceil(e[2]),t}function sn(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t[2]=Math.floor(e[2]),t}function an(t,e,n){return t[0]=Math.min(e[0],n[0]),t[1]=Math.min(e[1],n[1]),t[2]=Math.min(e[2],n[2]),t}function on(t,e,n){return t[0]=Math.max(e[0],n[0]),t[1]=Math.max(e[1],n[1]),t[2]=Math.max(e[2],n[2]),t}function ln(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t[2]=Math.round(e[2]),t}function hn(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t}function un(t,e,n,i){return t[0]=e[0]+n[0]*i,t[1]=e[1]+n[1]*i,t[2]=e[2]+n[2]*i,t}function cn(t,e){var n=e[0]-t[0],i=e[1]-t[1],r=e[2]-t[2];return Math.hypot(n,i,r)}function dn(t,e){var n=e[0]-t[0],i=e[1]-t[1],r=e[2]-t[2];return n*n+i*i+r*r}function fn(t){var e=t[0],n=t[1],i=t[2];return e*e+n*n+i*i}function pn(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t}function mn(t,e){return t[0]=1/e[0],t[1]=1/e[1],t[2]=1/e[2],t}function _n(t,e){var n=e[0],i=e[1],r=e[2],s=n*n+i*i+r*r;return s>0&&(s=1/Math.sqrt(s)),t[0]=e[0]*s,t[1]=e[1]*s,t[2]=e[2]*s,t}function gn(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function vn(t,e,n){var i=e[0],r=e[1],s=e[2],a=n[0],o=n[1],l=n[2];return t[0]=r*l-s*o,t[1]=s*a-i*l,t[2]=i*o-r*a,t}function bn(t,e,n,i){var r=e[0],s=e[1],a=e[2];return t[0]=r+i*(n[0]-r),t[1]=s+i*(n[1]-s),t[2]=a+i*(n[2]-a),t}function wn(t,e,n,i,r,s){var a=s*s,o=a*(2*s-3)+1,l=a*(s-2)+s,h=a*(s-1),u=a*(3-2*s);return t[0]=e[0]*o+n[0]*l+i[0]*h+r[0]*u,t[1]=e[1]*o+n[1]*l+i[1]*h+r[1]*u,t[2]=e[2]*o+n[2]*l+i[2]*h+r[2]*u,t}function An(t,e,n,i,r,s){var a=1-s,o=a*a,l=s*s,h=o*a,u=3*s*o,c=3*l*a,d=l*s;return t[0]=e[0]*h+n[0]*u+i[0]*c+r[0]*d,t[1]=e[1]*h+n[1]*u+i[1]*c+r[1]*d,t[2]=e[2]*h+n[2]*u+i[2]*c+r[2]*d,t}function yn(t,e){e=e||1;var n=2*w()*Math.PI,i=2*w()-1,r=Math.sqrt(1-i*i)*e;return t[0]=Math.cos(n)*r,t[1]=Math.sin(n)*r,t[2]=i*e,t}function xn(t,e,n){var i=e[0],r=e[1],s=e[2],a=n[3]*i+n[7]*r+n[11]*s+n[15];return a=a||1,t[0]=(n[0]*i+n[4]*r+n[8]*s+n[12])/a,t[1]=(n[1]*i+n[5]*r+n[9]*s+n[13])/a,t[2]=(n[2]*i+n[6]*r+n[10]*s+n[14])/a,t}function Tn(t,e,n){var i=e[0],r=e[1],s=e[2];return t[0]=i*n[0]+r*n[3]+s*n[6],t[1]=i*n[1]+r*n[4]+s*n[7],t[2]=i*n[2]+r*n[5]+s*n[8],t}function Ln(t,e,n){var i=n[0],r=n[1],s=n[2],a=n[3],o=e[0],l=e[1],h=e[2],u=r*h-s*l,c=s*o-i*h,d=i*l-r*o,f=r*d-s*c,p=s*u-i*d,m=i*c-r*u,_=2*a;return u*=_,c*=_,d*=_,f*=2,p*=2,m*=2,t[0]=o+u+f,t[1]=l+c+p,t[2]=h+d+m,t}function En(t,e,n,i){var r=[],s=[];return r[0]=e[0]-n[0],r[1]=e[1]-n[1],r[2]=e[2]-n[2],s[0]=r[0],s[1]=r[1]*Math.cos(i)-r[2]*Math.sin(i),s[2]=r[1]*Math.sin(i)+r[2]*Math.cos(i),t[0]=s[0]+n[0],t[1]=s[1]+n[1],t[2]=s[2]+n[2],t}function Sn(t,e,n,i){var r=[],s=[];return r[0]=e[0]-n[0],r[1]=e[1]-n[1],r[2]=e[2]-n[2],s[0]=r[2]*Math.sin(i)+r[0]*Math.cos(i),s[1]=r[1],s[2]=r[2]*Math.cos(i)-r[0]*Math.sin(i),t[0]=s[0]+n[0],t[1]=s[1]+n[1],t[2]=s[2]+n[2],t}function Mn(t,e,n,i){var r=[],s=[];return r[0]=e[0]-n[0],r[1]=e[1]-n[1],r[2]=e[2]-n[2],s[0]=r[0]*Math.cos(i)-r[1]*Math.sin(i),s[1]=r[0]*Math.sin(i)+r[1]*Math.cos(i),s[2]=r[2],t[0]=s[0]+n[0],t[1]=s[1]+n[1],t[2]=s[2]+n[2],t}function kn(t,e){var n=t[0],i=t[1],r=t[2],s=e[0],a=e[1],o=e[2],l=Math.sqrt(n*n+i*i+r*r)*Math.sqrt(s*s+a*a+o*o),h=l&&gn(t,e)/l;return Math.acos(Math.min(Math.max(h,-1),1))}function Rn(t){return t[0]=0,t[1]=0,t[2]=0,t}function In(t){return"vec3("+t[0]+", "+t[1]+", "+t[2]+")"}function Un(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]}function On(t,e){var n=t[0],i=t[1],r=t[2],s=e[0],a=e[1],o=e[2];return Math.abs(n-s)<=v*Math.max(1,Math.abs(n),Math.abs(s))&&Math.abs(i-a)<=v*Math.max(1,Math.abs(i),Math.abs(a))&&Math.abs(r-o)<=v*Math.max(1,Math.abs(r),Math.abs(o))}var Cn,Bn=tn,Pn=en,Nn=nn,Dn=cn,Fn=dn,Vn=$e,Gn=fn,Kn=(Cn=qe(),function(t,e,n,i,r,s){var a,o;for(e||(e=3),n||(n=0),o=i?Math.min(i*e+n,t.length):t.length,a=n;a<o;a+=e)Cn[0]=t[a],Cn[1]=t[a+1],Cn[2]=t[a+2],r(Cn,Cn,s),t[a]=Cn[0],t[a+1]=Cn[1],t[a+2]=Cn[2];return t});function jn(){var t=new b(4);return b!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[3]=0),t}function zn(t){var e=new b(4);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e}function Hn(t,e,n,i){var r=new b(4);return r[0]=t,r[1]=e,r[2]=n,r[3]=i,r}function Xn(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t}function qn(t,e,n,i,r){return t[0]=e,t[1]=n,t[2]=i,t[3]=r,t}function Yn(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t[3]=e[3]+n[3],t}function $n(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t[3]=e[3]-n[3],t}function Wn(t,e,n){return t[0]=e[0]*n[0],t[1]=e[1]*n[1],t[2]=e[2]*n[2],t[3]=e[3]*n[3],t}function Zn(t,e,n){return t[0]=e[0]/n[0],t[1]=e[1]/n[1],t[2]=e[2]/n[2],t[3]=e[3]/n[3],t}function Jn(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t[2]=Math.ceil(e[2]),t[3]=Math.ceil(e[3]),t}function Qn(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t[2]=Math.floor(e[2]),t[3]=Math.floor(e[3]),t}function ti(t,e,n){return t[0]=Math.min(e[0],n[0]),t[1]=Math.min(e[1],n[1]),t[2]=Math.min(e[2],n[2]),t[3]=Math.min(e[3],n[3]),t}function ei(t,e,n){return t[0]=Math.max(e[0],n[0]),t[1]=Math.max(e[1],n[1]),t[2]=Math.max(e[2],n[2]),t[3]=Math.max(e[3],n[3]),t}function ni(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t[2]=Math.round(e[2]),t[3]=Math.round(e[3]),t}function ii(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t}function ri(t,e,n,i){return t[0]=e[0]+n[0]*i,t[1]=e[1]+n[1]*i,t[2]=e[2]+n[2]*i,t[3]=e[3]+n[3]*i,t}function si(t,e){var n=e[0]-t[0],i=e[1]-t[1],r=e[2]-t[2],s=e[3]-t[3];return Math.hypot(n,i,r,s)}function ai(t,e){var n=e[0]-t[0],i=e[1]-t[1],r=e[2]-t[2],s=e[3]-t[3];return n*n+i*i+r*r+s*s}function oi(t){var e=t[0],n=t[1],i=t[2],r=t[3];return Math.hypot(e,n,i,r)}function li(t){var e=t[0],n=t[1],i=t[2],r=t[3];return e*e+n*n+i*i+r*r}function hi(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=-e[3],t}function ui(t,e){return t[0]=1/e[0],t[1]=1/e[1],t[2]=1/e[2],t[3]=1/e[3],t}function ci(t,e){var n=e[0],i=e[1],r=e[2],s=e[3],a=n*n+i*i+r*r+s*s;return a>0&&(a=1/Math.sqrt(a)),t[0]=n*a,t[1]=i*a,t[2]=r*a,t[3]=s*a,t}function di(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]}function fi(t,e,n,i){var r=n[0]*i[1]-n[1]*i[0],s=n[0]*i[2]-n[2]*i[0],a=n[0]*i[3]-n[3]*i[0],o=n[1]*i[2]-n[2]*i[1],l=n[1]*i[3]-n[3]*i[1],h=n[2]*i[3]-n[3]*i[2],u=e[0],c=e[1],d=e[2],f=e[3];return t[0]=c*h-d*l+f*o,t[1]=-u*h+d*a-f*s,t[2]=u*l-c*a+f*r,t[3]=-u*o+c*s-d*r,t}function pi(t,e,n,i){var r=e[0],s=e[1],a=e[2],o=e[3];return t[0]=r+i*(n[0]-r),t[1]=s+i*(n[1]-s),t[2]=a+i*(n[2]-a),t[3]=o+i*(n[3]-o),t}function mi(t,e){var n,i,r,s,a,o;e=e||1;do{a=(n=2*w()-1)*n+(i=2*w()-1)*i}while(a>=1);do{o=(r=2*w()-1)*r+(s=2*w()-1)*s}while(o>=1);var l=Math.sqrt((1-a)/o);return t[0]=e*n,t[1]=e*i,t[2]=e*r*l,t[3]=e*s*l,t}function _i(t,e,n){var i=e[0],r=e[1],s=e[2],a=e[3];return t[0]=n[0]*i+n[4]*r+n[8]*s+n[12]*a,t[1]=n[1]*i+n[5]*r+n[9]*s+n[13]*a,t[2]=n[2]*i+n[6]*r+n[10]*s+n[14]*a,t[3]=n[3]*i+n[7]*r+n[11]*s+n[15]*a,t}function gi(t,e,n){var i=e[0],r=e[1],s=e[2],a=n[0],o=n[1],l=n[2],h=n[3],u=h*i+o*s-l*r,c=h*r+l*i-a*s,d=h*s+a*r-o*i,f=-a*i-o*r-l*s;return t[0]=u*h+f*-a+c*-l-d*-o,t[1]=c*h+f*-o+d*-a-u*-l,t[2]=d*h+f*-l+u*-o-c*-a,t[3]=e[3],t}function vi(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=0,t}function bi(t){return"vec4("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"}function wi(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]}function Ai(t,e){var n=t[0],i=t[1],r=t[2],s=t[3],a=e[0],o=e[1],l=e[2],h=e[3];return Math.abs(n-a)<=v*Math.max(1,Math.abs(n),Math.abs(a))&&Math.abs(i-o)<=v*Math.max(1,Math.abs(i),Math.abs(o))&&Math.abs(r-l)<=v*Math.max(1,Math.abs(r),Math.abs(l))&&Math.abs(s-h)<=v*Math.max(1,Math.abs(s),Math.abs(h))}var yi=$n,xi=Wn,Ti=Zn,Li=si,Ei=ai,Si=oi,Mi=li,ki=function(){var t=jn();return function(e,n,i,r,s,a){var o,l;for(n||(n=4),i||(i=0),l=r?Math.min(r*n+i,e.length):e.length,o=i;o<l;o+=n)t[0]=e[o],t[1]=e[o+1],t[2]=e[o+2],t[3]=e[o+3],s(t,t,a),e[o]=t[0],e[o+1]=t[1],e[o+2]=t[2],e[o+3]=t[3];return e}}();function Ri(){var t=new b(4);return b!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0),t[3]=1,t}function Ii(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t}function Ui(t,e,n){n*=.5;var i=Math.sin(n);return t[0]=i*e[0],t[1]=i*e[1],t[2]=i*e[2],t[3]=Math.cos(n),t}function Oi(t,e){var n=2*Math.acos(e[3]),i=Math.sin(n/2);return i>v?(t[0]=e[0]/i,t[1]=e[1]/i,t[2]=e[2]/i):(t[0]=1,t[1]=0,t[2]=0),n}function Ci(t,e){var n=hr(t,e);return Math.acos(2*n*n-1)}function Bi(t,e,n){var i=e[0],r=e[1],s=e[2],a=e[3],o=n[0],l=n[1],h=n[2],u=n[3];return t[0]=i*u+a*o+r*h-s*l,t[1]=r*u+a*l+s*o-i*h,t[2]=s*u+a*h+i*l-r*o,t[3]=a*u-i*o-r*l-s*h,t}function Pi(t,e,n){n*=.5;var i=e[0],r=e[1],s=e[2],a=e[3],o=Math.sin(n),l=Math.cos(n);return t[0]=i*l+a*o,t[1]=r*l+s*o,t[2]=s*l-r*o,t[3]=a*l-i*o,t}function Ni(t,e,n){n*=.5;var i=e[0],r=e[1],s=e[2],a=e[3],o=Math.sin(n),l=Math.cos(n);return t[0]=i*l-s*o,t[1]=r*l+a*o,t[2]=s*l+i*o,t[3]=a*l-r*o,t}function Di(t,e,n){n*=.5;var i=e[0],r=e[1],s=e[2],a=e[3],o=Math.sin(n),l=Math.cos(n);return t[0]=i*l+r*o,t[1]=r*l-i*o,t[2]=s*l+a*o,t[3]=a*l-s*o,t}function Fi(t,e){var n=e[0],i=e[1],r=e[2];return t[0]=n,t[1]=i,t[2]=r,t[3]=Math.sqrt(Math.abs(1-n*n-i*i-r*r)),t}function Vi(t,e){var n=e[0],i=e[1],r=e[2],s=e[3],a=Math.sqrt(n*n+i*i+r*r),o=Math.exp(s),l=a>0?o*Math.sin(a)/a:0;return t[0]=n*l,t[1]=i*l,t[2]=r*l,t[3]=o*Math.cos(a),t}function Gi(t,e){var n=e[0],i=e[1],r=e[2],s=e[3],a=Math.sqrt(n*n+i*i+r*r),o=a>0?Math.atan2(a,s)/a:0;return t[0]=n*o,t[1]=i*o,t[2]=r*o,t[3]=.5*Math.log(n*n+i*i+r*r+s*s),t}function Ki(t,e,n){return Gi(t,e),lr(t,t,n),Vi(t,t),t}function ji(t,e,n,i){var r,s,a,o,l,h=e[0],u=e[1],c=e[2],d=e[3],f=n[0],p=n[1],m=n[2],_=n[3];return(s=h*f+u*p+c*m+d*_)<0&&(s=-s,f=-f,p=-p,m=-m,_=-_),1-s>v?(r=Math.acos(s),a=Math.sin(r),o=Math.sin((1-i)*r)/a,l=Math.sin(i*r)/a):(o=1-i,l=i),t[0]=o*h+l*f,t[1]=o*u+l*p,t[2]=o*c+l*m,t[3]=o*d+l*_,t}function zi(t){var e=w(),n=w(),i=w(),r=Math.sqrt(1-e),s=Math.sqrt(e);return t[0]=r*Math.sin(2*Math.PI*n),t[1]=r*Math.cos(2*Math.PI*n),t[2]=s*Math.sin(2*Math.PI*i),t[3]=s*Math.cos(2*Math.PI*i),t}function Hi(t,e){var n=e[0],i=e[1],r=e[2],s=e[3],a=n*n+i*i+r*r+s*s,o=a?1/a:0;return t[0]=-n*o,t[1]=-i*o,t[2]=-r*o,t[3]=s*o,t}function Xi(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=e[3],t}function qi(t,e){var n,i=e[0]+e[4]+e[8];if(i>0)n=Math.sqrt(i+1),t[3]=.5*n,n=.5/n,t[0]=(e[5]-e[7])*n,t[1]=(e[6]-e[2])*n,t[2]=(e[1]-e[3])*n;else{var r=0;e[4]>e[0]&&(r=1),e[8]>e[3*r+r]&&(r=2);var s=(r+1)%3,a=(r+2)%3;n=Math.sqrt(e[3*r+r]-e[3*s+s]-e[3*a+a]+1),t[r]=.5*n,n=.5/n,t[3]=(e[3*s+a]-e[3*a+s])*n,t[s]=(e[3*s+r]+e[3*r+s])*n,t[a]=(e[3*a+r]+e[3*r+a])*n}return t}function Yi(t,e,n,i){var r=.5*Math.PI/180;e*=r,n*=r,i*=r;var s=Math.sin(e),a=Math.cos(e),o=Math.sin(n),l=Math.cos(n),h=Math.sin(i),u=Math.cos(i);return t[0]=s*l*u-a*o*h,t[1]=a*o*u+s*l*h,t[2]=a*l*h-s*o*u,t[3]=a*l*u+s*o*h,t}function $i(t){return"quat("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"}var Wi,Zi,Ji,Qi,tr,er,nr=zn,ir=Hn,rr=Xn,sr=qn,ar=Yn,or=Bi,lr=ii,hr=di,ur=pi,cr=oi,dr=cr,fr=li,pr=fr,mr=ci,_r=wi,gr=Ai,vr=(Wi=qe(),Zi=We(1,0,0),Ji=We(0,1,0),function(t,e,n){var i=gn(e,n);return i<-.999999?(vn(Wi,Zi,e),Vn(Wi)<1e-6&&vn(Wi,Ji,e),_n(Wi,Wi),Ui(t,Wi,Math.PI),t):i>.999999?(t[0]=0,t[1]=0,t[2]=0,t[3]=1,t):(vn(Wi,e,n),t[0]=Wi[0],t[1]=Wi[1],t[2]=Wi[2],t[3]=1+i,mr(t,t))}),br=(Qi=Ri(),tr=Ri(),function(t,e,n,i,r,s){return ji(Qi,e,r,s),ji(tr,n,i,s),ji(t,Qi,tr,2*s*(1-s)),t}),wr=(er=yt(),function(t,e,n,i){return er[0]=n[0],er[3]=n[1],er[6]=n[2],er[1]=i[0],er[4]=i[1],er[7]=i[2],er[2]=-e[0],er[5]=-e[1],er[8]=-e[2],mr(t,qi(t,er))});function Ar(){var t=new b(8);return b!=Float32Array&&(t[0]=0,t[1]=0,t[2]=0,t[4]=0,t[5]=0,t[6]=0,t[7]=0),t[3]=1,t}function yr(t){var e=new b(8);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e}function xr(t,e,n,i,r,s,a,o){var l=new b(8);return l[0]=t,l[1]=e,l[2]=n,l[3]=i,l[4]=r,l[5]=s,l[6]=a,l[7]=o,l}function Tr(t,e,n,i,r,s,a){var o=new b(8);o[0]=t,o[1]=e,o[2]=n,o[3]=i;var l=.5*r,h=.5*s,u=.5*a;return o[4]=l*i+h*n-u*e,o[5]=h*i+u*t-l*n,o[6]=u*i+l*e-h*t,o[7]=-l*t-h*e-u*n,o}function Lr(t,e,n){var i=.5*n[0],r=.5*n[1],s=.5*n[2],a=e[0],o=e[1],l=e[2],h=e[3];return t[0]=a,t[1]=o,t[2]=l,t[3]=h,t[4]=i*h+r*l-s*o,t[5]=r*h+s*a-i*l,t[6]=s*h+i*o-r*a,t[7]=-i*a-r*o-s*l,t}function Er(t,e){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t[4]=.5*e[0],t[5]=.5*e[1],t[6]=.5*e[2],t[7]=0,t}function Sr(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=0,t[5]=0,t[6]=0,t[7]=0,t}function Mr(t,e){var n=Ri();Se(n,e);var i=new b(3);return Le(i,e),Lr(t,n,i),t}function kr(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t}function Rr(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t[4]=0,t[5]=0,t[6]=0,t[7]=0,t}function Ir(t,e,n,i,r,s,a,o,l){return t[0]=e,t[1]=n,t[2]=i,t[3]=r,t[4]=s,t[5]=a,t[6]=o,t[7]=l,t}var Ur=rr;function Or(t,e){return t[0]=e[4],t[1]=e[5],t[2]=e[6],t[3]=e[7],t}var Cr=rr;function Br(t,e){return t[4]=e[0],t[5]=e[1],t[6]=e[2],t[7]=e[3],t}function Pr(t,e){var n=e[4],i=e[5],r=e[6],s=e[7],a=-e[0],o=-e[1],l=-e[2],h=e[3];return t[0]=2*(n*h+s*a+i*l-r*o),t[1]=2*(i*h+s*o+r*a-n*l),t[2]=2*(r*h+s*l+n*o-i*a),t}function Nr(t,e,n){var i=e[0],r=e[1],s=e[2],a=e[3],o=.5*n[0],l=.5*n[1],h=.5*n[2],u=e[4],c=e[5],d=e[6],f=e[7];return t[0]=i,t[1]=r,t[2]=s,t[3]=a,t[4]=a*o+r*h-s*l+u,t[5]=a*l+s*o-i*h+c,t[6]=a*h+i*l-r*o+d,t[7]=-i*o-r*l-s*h+f,t}function Dr(t,e,n){var i=-e[0],r=-e[1],s=-e[2],a=e[3],o=e[4],l=e[5],h=e[6],u=e[7],c=o*a+u*i+l*s-h*r,d=l*a+u*r+h*i-o*s,f=h*a+u*s+o*r-l*i,p=u*a-o*i-l*r-h*s;return Pi(t,e,n),i=t[0],r=t[1],s=t[2],a=t[3],t[4]=c*a+p*i+d*s-f*r,t[5]=d*a+p*r+f*i-c*s,t[6]=f*a+p*s+c*r-d*i,t[7]=p*a-c*i-d*r-f*s,t}function Fr(t,e,n){var i=-e[0],r=-e[1],s=-e[2],a=e[3],o=e[4],l=e[5],h=e[6],u=e[7],c=o*a+u*i+l*s-h*r,d=l*a+u*r+h*i-o*s,f=h*a+u*s+o*r-l*i,p=u*a-o*i-l*r-h*s;return Ni(t,e,n),i=t[0],r=t[1],s=t[2],a=t[3],t[4]=c*a+p*i+d*s-f*r,t[5]=d*a+p*r+f*i-c*s,t[6]=f*a+p*s+c*r-d*i,t[7]=p*a-c*i-d*r-f*s,t}function Vr(t,e,n){var i=-e[0],r=-e[1],s=-e[2],a=e[3],o=e[4],l=e[5],h=e[6],u=e[7],c=o*a+u*i+l*s-h*r,d=l*a+u*r+h*i-o*s,f=h*a+u*s+o*r-l*i,p=u*a-o*i-l*r-h*s;return Di(t,e,n),i=t[0],r=t[1],s=t[2],a=t[3],t[4]=c*a+p*i+d*s-f*r,t[5]=d*a+p*r+f*i-c*s,t[6]=f*a+p*s+c*r-d*i,t[7]=p*a-c*i-d*r-f*s,t}function Gr(t,e,n){var i=n[0],r=n[1],s=n[2],a=n[3],o=e[0],l=e[1],h=e[2],u=e[3];return t[0]=o*a+u*i+l*s-h*r,t[1]=l*a+u*r+h*i-o*s,t[2]=h*a+u*s+o*r-l*i,t[3]=u*a-o*i-l*r-h*s,o=e[4],l=e[5],h=e[6],u=e[7],t[4]=o*a+u*i+l*s-h*r,t[5]=l*a+u*r+h*i-o*s,t[6]=h*a+u*s+o*r-l*i,t[7]=u*a-o*i-l*r-h*s,t}function Kr(t,e,n){var i=e[0],r=e[1],s=e[2],a=e[3],o=n[0],l=n[1],h=n[2],u=n[3];return t[0]=i*u+a*o+r*h-s*l,t[1]=r*u+a*l+s*o-i*h,t[2]=s*u+a*h+i*l-r*o,t[3]=a*u-i*o-r*l-s*h,o=n[4],l=n[5],h=n[6],u=n[7],t[4]=i*u+a*o+r*h-s*l,t[5]=r*u+a*l+s*o-i*h,t[6]=s*u+a*h+i*l-r*o,t[7]=a*u-i*o-r*l-s*h,t}function jr(t,e,n,i){if(Math.abs(i)<v)return kr(t,e);var r=Math.hypot(n[0],n[1],n[2]);i*=.5;var s=Math.sin(i),a=s*n[0]/r,o=s*n[1]/r,l=s*n[2]/r,h=Math.cos(i),u=e[0],c=e[1],d=e[2],f=e[3];t[0]=u*h+f*a+c*l-d*o,t[1]=c*h+f*o+d*a-u*l,t[2]=d*h+f*l+u*o-c*a,t[3]=f*h-u*a-c*o-d*l;var p=e[4],m=e[5],_=e[6],g=e[7];return t[4]=p*h+g*a+m*l-_*o,t[5]=m*h+g*o+_*a-p*l,t[6]=_*h+g*l+p*o-m*a,t[7]=g*h-p*a-m*o-_*l,t}function zr(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t[3]=e[3]+n[3],t[4]=e[4]+n[4],t[5]=e[5]+n[5],t[6]=e[6]+n[6],t[7]=e[7]+n[7],t}function Hr(t,e,n){var i=e[0],r=e[1],s=e[2],a=e[3],o=n[4],l=n[5],h=n[6],u=n[7],c=e[4],d=e[5],f=e[6],p=e[7],m=n[0],_=n[1],g=n[2],v=n[3];return t[0]=i*v+a*m+r*g-s*_,t[1]=r*v+a*_+s*m-i*g,t[2]=s*v+a*g+i*_-r*m,t[3]=a*v-i*m-r*_-s*g,t[4]=i*u+a*o+r*h-s*l+c*v+p*m+d*g-f*_,t[5]=r*u+a*l+s*o-i*h+d*v+p*_+f*m-c*g,t[6]=s*u+a*h+i*l-r*o+f*v+p*g+c*_-d*m,t[7]=a*u-i*o-r*l-s*h+p*v-c*m-d*_-f*g,t}var Xr=Hr;function qr(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t[4]=e[4]*n,t[5]=e[5]*n,t[6]=e[6]*n,t[7]=e[7]*n,t}var Yr=hr;function $r(t,e,n,i){var r=1-i;return Yr(e,n)<0&&(i=-i),t[0]=e[0]*r+n[0]*i,t[1]=e[1]*r+n[1]*i,t[2]=e[2]*r+n[2]*i,t[3]=e[3]*r+n[3]*i,t[4]=e[4]*r+n[4]*i,t[5]=e[5]*r+n[5]*i,t[6]=e[6]*r+n[6]*i,t[7]=e[7]*r+n[7]*i,t}function Wr(t,e){var n=ts(e);return t[0]=-e[0]/n,t[1]=-e[1]/n,t[2]=-e[2]/n,t[3]=e[3]/n,t[4]=-e[4]/n,t[5]=-e[5]/n,t[6]=-e[6]/n,t[7]=e[7]/n,t}function Zr(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=e[3],t[4]=-e[4],t[5]=-e[5],t[6]=-e[6],t[7]=e[7],t}var Jr=cr,Qr=Jr,ts=fr,es=ts;function ns(t,e){var n=ts(e);if(n>0){n=Math.sqrt(n);var i=e[0]/n,r=e[1]/n,s=e[2]/n,a=e[3]/n,o=e[4],l=e[5],h=e[6],u=e[7],c=i*o+r*l+s*h+a*u;t[0]=i,t[1]=r,t[2]=s,t[3]=a,t[4]=(o-i*c)/n,t[5]=(l-r*c)/n,t[6]=(h-s*c)/n,t[7]=(u-a*c)/n}return t}function is(t){return"quat2("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+")"}function rs(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]}function ss(t,e){var n=t[0],i=t[1],r=t[2],s=t[3],a=t[4],o=t[5],l=t[6],h=t[7],u=e[0],c=e[1],d=e[2],f=e[3],p=e[4],m=e[5],_=e[6],g=e[7];return Math.abs(n-u)<=v*Math.max(1,Math.abs(n),Math.abs(u))&&Math.abs(i-c)<=v*Math.max(1,Math.abs(i),Math.abs(c))&&Math.abs(r-d)<=v*Math.max(1,Math.abs(r),Math.abs(d))&&Math.abs(s-f)<=v*Math.max(1,Math.abs(s),Math.abs(f))&&Math.abs(a-p)<=v*Math.max(1,Math.abs(a),Math.abs(p))&&Math.abs(o-m)<=v*Math.max(1,Math.abs(o),Math.abs(m))&&Math.abs(l-_)<=v*Math.max(1,Math.abs(l),Math.abs(_))&&Math.abs(h-g)<=v*Math.max(1,Math.abs(h),Math.abs(g))}function as(){var t=new b(2);return b!=Float32Array&&(t[0]=0,t[1]=0),t}function os(t){var e=new b(2);return e[0]=t[0],e[1]=t[1],e}function ls(t,e){var n=new b(2);return n[0]=t,n[1]=e,n}function hs(t,e){return t[0]=e[0],t[1]=e[1],t}function us(t,e,n){return t[0]=e,t[1]=n,t}function cs(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t}function ds(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t}function fs(t,e,n){return t[0]=e[0]*n[0],t[1]=e[1]*n[1],t}function ps(t,e,n){return t[0]=e[0]/n[0],t[1]=e[1]/n[1],t}function ms(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t}function _s(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t}function gs(t,e,n){return t[0]=Math.min(e[0],n[0]),t[1]=Math.min(e[1],n[1]),t}function vs(t,e,n){return t[0]=Math.max(e[0],n[0]),t[1]=Math.max(e[1],n[1]),t}function bs(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t}function ws(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t}function As(t,e,n,i){return t[0]=e[0]+n[0]*i,t[1]=e[1]+n[1]*i,t}function ys(t,e){var n=e[0]-t[0],i=e[1]-t[1];return Math.hypot(n,i)}function xs(t,e){var n=e[0]-t[0],i=e[1]-t[1];return n*n+i*i}function Ts(t){var e=t[0],n=t[1];return Math.hypot(e,n)}function Ls(t){var e=t[0],n=t[1];return e*e+n*n}function Es(t,e){return t[0]=-e[0],t[1]=-e[1],t}function Ss(t,e){return t[0]=1/e[0],t[1]=1/e[1],t}function Ms(t,e){var n=e[0],i=e[1],r=n*n+i*i;return r>0&&(r=1/Math.sqrt(r)),t[0]=e[0]*r,t[1]=e[1]*r,t}function ks(t,e){return t[0]*e[0]+t[1]*e[1]}function Rs(t,e,n){var i=e[0]*n[1]-e[1]*n[0];return t[0]=t[1]=0,t[2]=i,t}function Is(t,e,n,i){var r=e[0],s=e[1];return t[0]=r+i*(n[0]-r),t[1]=s+i*(n[1]-s),t}function Us(t,e){e=e||1;var n=2*w()*Math.PI;return t[0]=Math.cos(n)*e,t[1]=Math.sin(n)*e,t}function Os(t,e,n){var i=e[0],r=e[1];return t[0]=n[0]*i+n[2]*r,t[1]=n[1]*i+n[3]*r,t}function Cs(t,e,n){var i=e[0],r=e[1];return t[0]=n[0]*i+n[2]*r+n[4],t[1]=n[1]*i+n[3]*r+n[5],t}function Bs(t,e,n){var i=e[0],r=e[1];return t[0]=n[0]*i+n[3]*r+n[6],t[1]=n[1]*i+n[4]*r+n[7],t}function Ps(t,e,n){var i=e[0],r=e[1];return t[0]=n[0]*i+n[4]*r+n[12],t[1]=n[1]*i+n[5]*r+n[13],t}function Ns(t,e,n,i){var r=e[0]-n[0],s=e[1]-n[1],a=Math.sin(i),o=Math.cos(i);return t[0]=r*o-s*a+n[0],t[1]=r*a+s*o+n[1],t}function Ds(t,e){var n=t[0],i=t[1],r=e[0],s=e[1],a=Math.sqrt(n*n+i*i)*Math.sqrt(r*r+s*s),o=a&&(n*r+i*s)/a;return Math.acos(Math.min(Math.max(o,-1),1))}function Fs(t){return t[0]=0,t[1]=0,t}function Vs(t){return"vec2("+t[0]+", "+t[1]+")"}function Gs(t,e){return t[0]===e[0]&&t[1]===e[1]}function Ks(t,e){var n=t[0],i=t[1],r=e[0],s=e[1];return Math.abs(n-r)<=v*Math.max(1,Math.abs(n),Math.abs(r))&&Math.abs(i-s)<=v*Math.max(1,Math.abs(i),Math.abs(s))}var js=Ts,zs=ds,Hs=fs,Xs=ps,qs=ys,Ys=xs,$s=Ls,Ws=function(){var t=as();return function(e,n,i,r,s,a){var o,l;for(n||(n=2),i||(i=0),l=r?Math.min(r*n+i,e.length):e.length,o=i;o<l;o+=n)t[0]=e[o],t[1]=e[o+1],s(t,t,a),e[o]=t[0],e[o+1]=t[1];return e}}();const Zs=We(1,0,0),Js=We(0,1,0),Qs=We(0,0,1),ta=qe(),ea=We(1,1,1),na=ir(0,0,0,0),ia=Ri(),ra=jn();function sa(t,e,n,i){const r=2*(e[0]-i[0])/i[2]-1,s=1-2*(e[1]-i[1])/i[3],a=2*e[2]-1;return qn(ra,r,s,a,1),_i(ra,ra,n),Je(t,ra[0]/ra[3],ra[1]/ra[3],ra[2]/ra[3]),t}function aa(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]}function oa(t,e,n){return t[0]*e+t[1]*n+t[3]}function la(t,e,n,i){return t[0]*e+t[1]*n+t[2]*i+t[3]}function ha(t,e,n,i,r,s){-1===s&&(s=0);for(let a=0;a<6;a++){const o=(s+a)%6;if(la(t[o],e,n,i)<=-r)return o}return-1}function ua(t,e,n,i,r,s){-1===s&&(s=0);for(let a=0;a<6;a++){const o=(s+a)%6,l=t[o];if(oa(l,e,i)<0&&oa(l,e,r)<0&&oa(l,n,r)<0&&oa(l,n,i)<0)return o}return-1}function ca(t){return Math.hypot(t[0],t[1],t[2])}function da(t,e){const n=ca(e);t[0]=e[0]/n,t[1]=e[1]/n,t[2]=e[2]/n,t[3]=e[3]/n}function fa(t,e){const n=e[0],i=e[4],r=e[8],s=e[12],a=e[1],o=e[5],l=e[9],h=e[13],u=e[2],c=e[6],d=e[10],f=e[14],p=e[3],m=e[7],_=e[11],g=e[15];let v;v=t[0],v[0]=p+n,v[1]=m+i,v[2]=_+r,v[3]=g+s,v=t[1],v[0]=p-n,v[1]=m-i,v[2]=_-r,v[3]=g-s,v=t[2],v[0]=p-a,v[1]=m-o,v[2]=_-l,v[3]=g-h,v=t[3],v[0]=p+a,v[1]=m+o,v[2]=_+l,v[3]=g+h,v=t[4],v[0]=p+u,v[1]=m+c,v[2]=_+d,v[3]=g+f,v=t[5],v[0]=p-u,v[1]=m-c,v[2]=_-d,v[3]=g-f,da(t[0],t[0]),da(t[1],t[1]),da(t[2],t[2]),da(t[3],t[3]),da(t[4],t[4]),da(t[5],t[5])}const pa=qe(),ma=qe(),_a=qe();function ga(t,e,n,i){_n(pa,Bn(pa,n,e)),_n(ma,vn(ma,i,pa)),vn(_a,ma,pa);const r=ma[0]+_a[2]+pa[1];if(r>0){const e=.5/Math.sqrt(r+1);t[3]=.25/e,t[0]=(_a[1]-pa[2])*e,t[2]=(pa[0]-ma[1])*e,t[1]=(ma[2]-_a[0])*e}else if(ma[0]>_a[2]&&ma[0]>pa[1]){const e=2*Math.sqrt(1+ma[0]-_a[2]-pa[1]);t[3]=(_a[1]-pa[2])/e,t[0]=.25*e,t[2]=(_a[0]+ma[2])/e,t[1]=(pa[0]+ma[1])/e}else if(_a[2]>pa[1]){const e=2*Math.sqrt(1+_a[2]-ma[0]-pa[1]);t[3]=(pa[0]-ma[1])/e,t[0]=(_a[0]+ma[2])/e,t[2]=.25*e,t[1]=(pa[2]+_a[1])/e}else{const e=2*Math.sqrt(1+pa[1]-ma[0]-_a[2]);t[3]=(ma[2]-_a[0])/e,t[0]=(pa[0]+ma[1])/e,t[2]=(pa[2]+_a[1])/e,t[1]=.25*e}return t}function va(t){return t*(Math.PI/180)}function ba(t){return t*(180/Math.PI)}function wa(t,e){return t+Math.random()*(e-t)}function Aa(t,e,n){return Math.min(Math.max(t,e),n)}function ya(t,e,n){return t+n*(e-t)}function xa(t,e,n,i,r){const s=r*r;return t*(s*(2*r-3)+1)+e*(s*(r-2)+r)+n*(s*(r-1))+i*(s*(3-2*r))}function Ta(t,e,n,i,r){const s=1-r,a=r*r,o=s*s;return t*(o*s)+e*(3*r*o)+n*(3*a*s)+i*(a*r)}function La(t,e){const n=Math.sign(e);if(0===n)return 0;return Math.sign(t)!==n?-t:t}function Ea(t){return t--,t|=t>>1,t|=t>>2,t|=t>>4,t|=t>>8,t|=t>>16,++t}function Sa(t){return 0!==t&&!(t&t-1)}let Ma,ka,Ra,Ia;function Ua(t){return new Promise(((e,n)=>{const i=URL.createObjectURL(t),r=new Image;r.onload=()=>{e(r)},r.onerror=t=>{n(t)},r.src=i}))}function Oa(t){return new Promise(((e,n)=>{const i=URL.createObjectURL(t),r=new Image;r.onload=()=>{URL.revokeObjectURL(i),Ma.width=r.width,Ma.height=r.height,ka.drawImage(r,0,0),e(ka.getImageData(0,0,r.width,r.height))},r.onerror=t=>{n(t)},r.src=i}))}function Ca(t){return new Promise((e=>{Ma.width=t.width,Ma.height=t.height,ka.putImageData(t,0,0),Ma.toBlob((t=>{e(t)}))}))}function Ba(t){return Ma.width=t.width,Ma.height=t.height,ka.putImageData(t,0,0),Ma.toDataURL()}function Pa(t){const e=new Image;return e.src=Ba(t),e}function Na(t){const e=t.width,n=t.height;return Ma.width=e,Ma.height=n,ka.drawImage(t,0,0),ka.getImageData(0,0,e,n)}function Da(t,e,n){return t instanceof ImageData?(Ma.width=t.width,Ma.height=t.height,ka.putImageData(t,0,0),Ra.width=e,Ra.height=n,Ia.drawImage(Ma,0,0,e,n),Ia.getImageData(0,0,e,n)):(Ma.width=e,Ma.height=n,ka.drawImage(t,0,0,e,n),ka.getImageData(0,0,e,n))}"object"==typeof window&&(Ma=document.createElement("canvas"),ka=Ma.getContext("2d"),Ra=document.createElement("canvas"),Ia=Ra.getContext("2d"));const Fa=new TextDecoder,Va=new TextEncoder;function Ga(t){return Fa.decode(t)}function Ka(t){return Va.encode(t)}function ja(t){let e=t.length;for(let n=t.length-1;n>=0;n--){const i=t.charCodeAt(n);i>127&&i<=2047?e++:i>2047&&i<=65535&&(e+=2),i>=56320&&i<=57343&&n--}return e}function za(t){return t instanceof Uint8Array?t:"string"==typeof t?Ka(t):new Uint8Array(t)}function Ha(t,e,n=0,i=1/0){const r=Math.max(n,0),s=Math.min(r+i,t.length);let a=0,o=e.charCodeAt(0);for(let n=r;n<s;n++){if(t[n]===o){if(a+=1,a===e.length)return!0;o=e.charCodeAt(a)}else a>0&&(a=0,o=e.charCodeAt(0))}return!1}const Xa=new ArrayBuffer(8),qa=new Int8Array(Xa),Ya=new Int16Array(Xa),$a=new Int32Array(Xa),Wa=new Uint8Array(Xa),Za=new Uint16Array(Xa),Ja=new Uint32Array(Xa),Qa=new Float32Array(Xa),to=new Float64Array(Xa);function eo(t){return Wa[0]=t,qa[0]}function no(t,e){return Wa[0]=t,Wa[1]=e,Ya[0]}function io(t,e,n,i){return Wa[0]=t,Wa[1]=e,Wa[2]=n,Wa[3]=i,$a[0]}function ro(t,e){return Wa[0]=t,Wa[1]=e,Za[0]}function so(t,e,n,i){return Wa[0]=t,Wa[1]=e,Wa[2]=n,Wa[3]=i,Ja[0]}function ao(t,e,n,i){return Wa[0]=t,Wa[1]=e,Wa[2]=n,Wa[3]=i,Qa[0]}function oo(t,e,n,i,r,s,a,o){return Wa[0]=t,Wa[1]=e,Wa[2]=n,Wa[3]=i,Wa[4]=r,Wa[5]=s,Wa[6]=a,Wa[7]=o,to[0]}function lo(t){return Wa[0]=t,qa[0]}function ho(t,e){return Ya[0]=e,t[0]=Wa[0],t[1]=Wa[1],t}function uo(t,e){return $a[0]=e,t[0]=Wa[0],t[1]=Wa[1],t[2]=Wa[2],t[3]=Wa[3],t}function co(t,e){return Za[0]=e,t[0]=Wa[0],t[1]=Wa[1],t}function fo(t,e){return Ja[0]=e,t[0]=Wa[0],t[1]=Wa[1],t[2]=Wa[2],t[3]=Wa[3],t}function po(t,e){return Qa[0]=e,t[0]=Wa[0],t[1]=Wa[1],t[2]=Wa[2],t[3]=Wa[3],t}function mo(t,e){return to[0]=e,t[0]=Wa[0],t[1]=Wa[1],t[2]=Wa[2],t[3]=Wa[3],t[4]=Wa[4],t[5]=Wa[5],t[6]=Wa[6],t[7]=Wa[7],t}function _o(t){return Ja[0]=t,Ja[0]}function go(t){const e=[];for(;t>0;)e.push(String.fromCharCode(t%256)),t=Math.floor(t/256);return e.reverse().join("")}const vo=new Uint8Array(8);class bo{constructor(t,e,n){this.index=0;const i=za(t);e=e||0,n=n||i.length,this.buffer=t,this.uint8array=i.subarray(e,e+n),this.byteLength=n,this.remaining=n}substream(t){if(this.remaining<t)throw new Error(`ByteStream: substream: want ${t} bytes but have ${this.remaining}`);const e=this.index;return this.index+=t,new bo(this.uint8array.subarray(e,e+t))}skip(t){if(this.remaining<t)throw new Error(`ByteStream: skip: premature end - want ${t} bytes but have ${this.remaining}`);this.index+=t,this.remaining-=t}seek(t){this.index=t,this.remaining=this.byteLength-t}read(t){if(this.remaining<t)throw new Error(`ByteStream: read: premature end - want ${t} bytes but have ${this.remaining}`);const e=this.uint8array,n=this.index;let i=function(t,e,n=0,i=1/0){const r=Math.max(n,0),s=Math.min(r+i,t.length);for(let n=r;n<s;n++)if(t[n]===e)return n;return-1}(e,0,n,t);return-1===i&&(i=n+t),this.index+=t,this.remaining-=t,Ga(e.subarray(n,i))}readNull(){if(this.remaining<1)throw new Error("ByteStream: readNull: premature end - want at least 1 byte but have 0");const t=this.uint8array,e=this.index;let n=t.indexOf(0,e);-1===n&&(n=t.length-1);const i=n-e+1;return this.index+=i,this.remaining-=i,Ga(t.subarray(e,n))}readBinary(t){if(this.remaining<t)throw new Error(`ByteStream: readBinary: premature end - want ${t} bytes but have ${this.remaining}`);const e=this.uint8array,n=this.index;let i="";for(let r=0;r<t;r++)i+=String.fromCharCode(e[n+r]);return this.index+=t,this.remaining-=t,i}readInt8(){if(this.remaining<1)throw new Error(`ByteStream: readInt8: premature end - want 1 byte but have ${this.remaining}`);const t=this.index,e=eo(this.uint8array[t]);return this.index+=1,this.remaining-=1,e}readInt16(){if(this.remaining<2)throw new Error(`ByteStream: readInt16: premature end - want 2 bytes but have ${this.remaining}`);const t=this.index,e=this.uint8array,n=no(e[t],e[t+1]);return this.index+=2,this.remaining-=2,n}readInt32(){if(this.remaining<4)throw new Error(`ByteStream: readInt32: premature end - want 4 bytes but have ${this.remaining}`);const t=this.index,e=this.uint8array,n=io(e[t],e[t+1],e[t+2],e[t+3]);return this.index+=4,this.remaining-=4,n}readUint8(){if(this.remaining<1)throw new Error(`ByteStream: readUint8: premature end - want 1 byte but have ${this.remaining}`);const t=this.uint8array[this.index];return this.index+=1,this.remaining-=1,t}readUint16(){if(this.remaining<2)throw new Error(`ByteStream: readUint16: premature end - want 2 bytes but have ${this.remaining}`);const t=this.index,e=this.uint8array,n=ro(e[t],e[t+1]);return this.index+=2,this.remaining-=2,n}readUint32(){if(this.remaining<4)throw new Error(`ByteStream: readUint32: premature end - want 4 bytes but have ${this.remaining}`);const t=this.index,e=this.uint8array,n=so(e[t],e[t+1],e[t+2],e[t+3]);return this.index+=4,this.remaining-=4,n}readFloat32(){if(this.remaining<4)throw new Error(`ByteStream: readFloat32: premature end - want 4 bytes but have ${this.remaining}`);const t=this.index,e=this.uint8array,n=ao(e[t],e[t+1],e[t+2],e[t+3]);return this.index+=4,this.remaining-=4,n}readFloat64(){if(this.remaining<8)throw new Error(`ByteStream: readFloat64: premature end - want 8 bytes but have ${this.remaining}`);const t=this.index,e=this.uint8array,n=oo(e[t],e[t+1],e[t+2],e[t+3],e[t+4],e[t+5],e[t+6],e[t+7]);return this.index+=8,this.remaining-=8,n}readInt8Array(t){if(ArrayBuffer.isView(t)||(t=new Int8Array(t)),this.remaining<t.byteLength)throw new Error(`ByteStream: readInt8Array: premature end - want ${t.byteLength} bytes but have ${this.remaining}`);const e=this.index,n=this.uint8array;for(let i=0,r=t.length;i<r;i++)t[i]=eo(n[e+i]);return this.index+=t.byteLength,this.remaining-=t.byteLength,t}readInt16Array(t){if(ArrayBuffer.isView(t)||(t=new Int16Array(t)),this.remaining<t.byteLength)throw new Error(`ByteStream: readInt16Array: premature end - want ${t.byteLength} bytes but have ${this.remaining}`);const e=this.index,n=this.uint8array;for(let i=0,r=t.length;i<r;i++){const r=e+2*i;t[i]=no(n[r],n[r+1])}return this.index+=t.byteLength,this.remaining-=t.byteLength,t}readInt32Array(t){if(ArrayBuffer.isView(t)||(t=new Int32Array(t)),this.remaining<t.byteLength)throw new Error(`ByteStream: readInt32Array: premature end - want ${t.byteLength} bytes but have ${this.remaining}`);const e=this.index,n=this.uint8array;for(let i=0,r=t.length;i<r;i++){const r=e+4*i;t[i]=io(n[r],n[r+1],n[r+2],n[r+3])}return this.index+=t.byteLength,this.remaining-=t.byteLength,t}readUint8Array(t){if(ArrayBuffer.isView(t)||(t=new Uint8Array(t)),this.remaining<t.byteLength)throw new Error(`ByteStream: readUint8Array: premature end - want ${t.byteLength} bytes but have ${this.remaining}`);const e=this.index,n=this.uint8array;for(let i=0,r=t.length;i<r;i++)t[i]=n[e+i];return this.index+=t.byteLength,this.remaining-=t.byteLength,t}readUint16Array(t){if(ArrayBuffer.isView(t)||(t=new Uint16Array(t)),this.remaining<t.byteLength)throw new Error(`ByteStream: readUint16Array: premature end - want ${t.byteLength} bytes but have ${this.remaining}`);const e=this.index,n=this.uint8array;for(let i=0,r=t.length;i<r;i++){const r=e+2*i;t[i]=ro(n[r],n[r+1])}return this.index+=t.byteLength,this.remaining-=t.byteLength,t}readUint32Array(t){if(ArrayBuffer.isView(t)||(t=new Uint32Array(t)),this.remaining<t.byteLength)throw new Error(`ByteStream: readUint32Array: premature end - want ${t.byteLength} bytes but have ${this.remaining}`);const e=this.index,n=this.uint8array;for(let i=0,r=t.length;i<r;i++){const r=e+4*i;t[i]=so(n[r],n[r+1],n[r+2],n[r+3])}return this.index+=t.byteLength,this.remaining-=t.byteLength,t}readFloat32Array(t){if(ArrayBuffer.isView(t)||(t=new Float32Array(t)),this.remaining<t.byteLength)throw new Error(`ByteStream: readFloat32Array: premature end - want ${t.byteLength} bytes but have ${this.remaining}`);const e=this.index,n=this.uint8array;for(let i=0,r=t.length;i<r;i++){const r=e+4*i;t[i]=ao(n[r],n[r+1],n[r+2],n[r+3])}return this.index+=t.byteLength,this.remaining-=t.byteLength,t}readFloat64Array(t){if(ArrayBuffer.isView(t)||(t=new Float64Array(t)),this.remaining<t.byteLength)throw new Error(`ByteStream: readFloat64Array: premature end - want ${t.byteLength} bytes but have ${this.remaining}`);const e=this.index,n=this.uint8array;for(let i=0,r=t.length;i<r;i++){const r=e+8*i;t[i]=oo(n[r],n[r+1],n[r+2],n[r+3],n[r+4],n[r+5],n[r+6],n[r+7])}return this.index+=t.byteLength,this.remaining-=t.byteLength,t}write(t){const e=Ka(t);return this.writeUint8Array(e),e.length}writeNull(t){const e=this.write(t);return this.index++,this.remaining--,e+1}writeBinary(t){const e=this.index,n=this.uint8array,i=t.length;for(let r=0;r<i;r++)n[e+r]=t.charCodeAt(r);this.index+=i}writeInt8(t){this.uint8array[this.index]=lo(t),this.index+=1}writeInt16(t){const e=this.index,n=this.uint8array;ho(vo,t),n[e]=vo[0],n[e+1]=vo[1],this.index+=2}writeInt32(t){const e=this.index,n=this.uint8array;uo(vo,t),n[e]=vo[0],n[e+1]=vo[1],n[e+2]=vo[2],n[e+3]=vo[3],this.index+=4}writeUint8(t){this.uint8array[this.index]=t,this.index+=1}writeUint16(t){const e=this.index,n=this.uint8array;co(vo,t),n[e]=vo[0],n[e+1]=vo[1],this.index+=2}writeUint32(t){const e=this.index,n=this.uint8array;fo(vo,t),n[e]=vo[0],n[e+1]=vo[1],n[e+2]=vo[2],n[e+3]=vo[3],this.index+=4}writeFloat32(t){const e=this.index,n=this.uint8array;po(vo,t),n[e]=vo[0],n[e+1]=vo[1],n[e+2]=vo[2],n[e+3]=vo[3],this.index+=4}writeFloat64(t){const e=this.index,n=this.uint8array;mo(vo,t),n[e]=vo[0],n[e+1]=vo[1],n[e+2]=vo[2],n[e+3]=vo[3],n[e+4]=vo[4],n[e+5]=vo[5],n[e+6]=vo[6],n[e+7]=vo[7],this.index+=8}writeInt8Array(t){const e=this.index,n=this.uint8array;for(let i=0,r=t.length;i<r;i++)n[e+i]=lo(t[i]);this.index+=t.byteLength}writeInt16Array(t){const e=this.index,n=this.uint8array;for(let i=0,r=t.length;i<r;i++){const r=e+2*i;ho(vo,t[i]),n[r]=vo[0],n[r+1]=vo[1]}this.index+=t.byteLength}writeInt32Array(t){const e=this.index,n=this.uint8array;for(let i=0,r=t.length;i<r;i++){const r=e+4*i;uo(vo,t[i]),n[r]=vo[0],n[r+1]=vo[1],n[r+2]=vo[2],n[r+3]=vo[3]}this.index+=t.byteLength}writeUint8Array(t){const e=this.index,n=this.uint8array;for(let i=0,r=t.length;i<r;i++)n[e+i]=t[i];this.index+=t.byteLength}writeUint16Array(t){const e=this.index,n=this.uint8array;for(let i=0,r=t.length;i<r;i++){const r=e+2*i;co(vo,t[i]),n[r]=vo[0],n[r+1]=vo[1]}this.index+=t.byteLength}writeUint32Array(t){const e=this.index,n=this.uint8array;for(let i=0,r=t.length;i<r;i++){const r=e+4*i;fo(vo,t[i]),n[r]=vo[0],n[r+1]=vo[1],n[r+2]=vo[2],n[r+3]=vo[3]}this.index+=t.byteLength}writeFloat32Array(t){const e=this.index,n=this.uint8array;for(let i=0,r=t.length;i<r;i++){const r=e+4*i;po(vo,t[i]),n[r]=vo[0],n[r+1]=vo[1],n[r+2]=vo[2],n[r+3]=vo[3]}this.index+=t.byteLength}writeFloat64Array(t){const e=this.index,n=this.uint8array;for(let i=0,r=t.length;i<r;i++){const r=e+8*i;mo(vo,t[i]),n[r]=vo[0],n[r+1]=vo[1],n[r+2]=vo[2],n[r+3]=vo[3],n[r+4]=vo[4],n[r+5]=vo[5],n[r+6]=vo[6],n[r+7]=vo[7]}this.index+=t.byteLength}}class wo{constructor(t,e,n){this.index=0,this.bitBuffer=0,this.bits=0;const i=za(t);e=e||0,n=n||i.length,this.buffer=t,this.uint8array=i.subarray(e,e+n),this.byteLength=t.byteLength}peekBits(t){return this.loadBits(t),this.bitBuffer&(1<<t)-1}readBits(t){const e=this.peekBits(t);return this.bitBuffer>>>=t,this.bits-=t,e}skipBits(t){this.loadBits(t),this.bitBuffer>>>=t,this.bits-=t}loadBits(t){for(;this.bits<t;)this.bitBuffer+=this.uint8array[this.index]<<this.bits,this.bits+=8,this.index+=1}}function Ao(t){if(t&&t.length){let e=t.lastIndexOf("/");return-1!==e&&(t=t.slice(e+1)),e=t.lastIndexOf("\\"),-1!==e&&(t=t.slice(e+1)),t}return""}function yo(t){if(t&&t.length){const e=t.lastIndexOf(".");return-1!==e&&(t=t.slice(e).toLowerCase()),t}return""}function xo(t){const e=(t=Ao(t)).lastIndexOf(".");return-1!==e&&(t=t.slice(0,e)),t}function To(t){return t instanceof ArrayBuffer&&(t=new Uint8Array(t)),t instanceof Uint8Array&&137===t[0]&&80===t[1]&&78===t[2]&&71===t[3]&&13===t[4]&&10===t[5]&&26===t[6]&&10===t[7]}function Lo(t){return t instanceof ArrayBuffer&&(t=new Uint8Array(t)),t instanceof Uint8Array&&255===t[0]&&216===t[1]&&255===t[t.length-2]&&217===t[t.length-1]}function Eo(t){return t instanceof ArrayBuffer&&(t=new Uint8Array(t)),t instanceof Uint8Array&&71===t[0]&&73===t[1]&&70===t[2]&&56===t[3]&&(55===t[4]||57===t[4])&&97===t[5]}function So(t){return t instanceof ArrayBuffer&&(t=new Uint8Array(t)),t instanceof Uint8Array&&82===t[0]&&73===t[1]&&70===t[2]&&70===t[3]&&87===t[8]&&69===t[9]&&66===t[10]&&80===t[11]}class Mo{constructor(){this.properties=new Map,this.sections=new Map}load(t){let e=this.properties;const n=this.sections;for(const i of t.split("\r\n"))if(i.length&&!i.startsWith("//")&&!i.startsWith(";")){let t=i.match(/^\[(.+?)\]/);if(t){const i=t[1].trim();e=n.get(i),e||(e=new Map,n.set(i,e))}else if(t=i.match(/^(.+?)=(.*?)$/),t){let n=t[2];'"'===n[0]&&(n=n.slice(1,-1)),e.set(t[1],n)}}}save(){const t=[];for(const[e,n]of this.properties)t.push(`${e}=${n}`);for(const[e,n]of this.sections){t.push(`[${e}]`);for(const[e,i]of n)t.push(`${e}=${i}`)}return t.join("\r\n")}getSection(t){return this.sections.get(t)}}class ko{constructor(){this.rows=[]}load(t){if(!t.startsWith("ID"))throw new Error("WrongMagicNumber");const e=this.rows;let n=0,i=0;for(const r of t.split("\n"))if("B"!==r[0])for(const t of r.split(";")){const r=t[0],s=t.substring(1).trim();let a;"X"===r?n=parseInt(s,10)-1:"Y"===r?i=parseInt(s,10)-1:"K"===r&&(e[i]||(e[i]=[]),a='"'===s[0]?s.slice(1,-1):s,e[i][n]=a)}}save(){const t=this.rows,e=t.length,n=[];let i=0;for(let r=0;r<e;r++){const e=t[r],s=e.length;s>i&&(i=s);let a=!0;for(let t=0;t<s;t++){const i=e[t];if(void 0!==i){let e;e="string"==typeof i?`"${i}"`:"boolean"==typeof i?i?"TRUE":"FALSE":`${i}`,a?(a=!1,n.push(`C;X${t+1};Y${r+1};K${e}`)):n.push(`C;X${t+1};K${e}`)}}}return`ID;P\r\nB;X${i};Y${e}\r\n${n.join("\r\n")}\r\nE`}}function Ro(t){return[...t].reverse().join("")}class Io{constructor(){this.index=null,this.entries=0,this.id=0,this.flags=0}load(t,e){this.index=e,this.entries=t.readUint32(),this.id=t.readUint32(),this.flags=t.readUint32()}get(){if(this.index&&0!==this.id&&0!==this.entries)return this.index[this.id].entries}first(){const t=this.get();if(t)return t[0]}}class Uo{constructor(){this.version=-1,this.tag="",this.offset=0,this.entries=0,this.model=new Io}load(t,e,n){this.version=e,this.tag=Ro(t.readBinary(4)),this.offset=t.readUint32(),this.entries=t.readUint32(),this.model.load(t,n)}}class Oo{constructor(){this.min=new Float32Array(3),this.max=new Float32Array(3),this.radius=0}load(t){t.readFloat32Array(this.min),t.readFloat32Array(this.max),this.radius=t.readFloat32()}}class Co{constructor(){this.shape=-1,this.bone=-1,this.unknown0=0,this.matrix=new Float32Array(16),this.unknown1=0,this.unknown2=0,this.unknown3=0,this.unknown4=0,this.unknown5=0,this.unknown6=0,this.size=new Float32Array(3)}load(t){this.shape=t.readUint32(),this.bone=t.readInt16(),this.unknown0=t.readUint16(),t.readFloat32Array(this.matrix),this.unknown1=t.readUint32(),this.unknown2=t.readUint32(),this.unknown3=t.readUint32(),this.unknown4=t.readUint32(),this.unknown5=t.readUint32(),this.unknown6=t.readUint32(),t.readFloat32Array(this.size)}}class Bo{constructor(){this.interpolationType=0,this.animFlags=0,this.animId=-1,this.initValue=null,this.nullValue=null}load(t){this.interpolationType=t.readUint16(),this.animFlags=t.readUint16(),this.animId=t.readUint32(),this.readInitNullValues(t),t.skip(4)}}class Po extends Bo{readInitNullValues(t){this.initValue=t.readUint8Array(4),this.nullValue=t.readUint8Array(4)}}class No extends Bo{readInitNullValues(t){this.initValue=t.readUint16(),this.nullValue=t.readUint16()}}class Do extends Bo{readInitNullValues(t){this.initValue=t.readUint32(),this.nullValue=t.readUint32()}}class Fo extends Bo{readInitNullValues(t){this.initValue=t.readFloat32(),this.nullValue=t.readFloat32()}}class Vo extends Bo{readInitNullValues(t){this.initValue=t.readFloat32Array(2),this.nullValue=t.readFloat32Array(2)}}class Go extends Bo{readInitNullValues(t){this.initValue=t.readFloat32Array(3),this.nullValue=t.readFloat32Array(3)}}class Ko extends Bo{readInitNullValues(t){this.initValue=t.readFloat32Array(4),this.nullValue=t.readFloat32Array(4)}}class jo{constructor(){this.version=-1,this.keys=new Io,this.flags=0,this.biggestKey=-1,this.values=new Io}load(t,e,n){this.version=e,this.keys.load(t,n),this.flags=t.readUint32(),this.biggestKey=t.readUint32(),this.values.load(t,n)}}class zo{constructor(t,e,n){this.stream=t,this.version=e,this.index=n}}const Ho={MD34:[Uo,{11:24}],MODL:[class{constructor(){this.version=-1,this.modelName=new Io,this.flags=0,this.sequences=new Io,this.stc=new Io,this.stg=new Io,this.unknown0=0,this.unknown1=0,this.unknown2=0,this.unknown3=0,this.sts=new Io,this.bones=new Io,this.numberOfBonesToCheckForSkin=0,this.vertexFlags=0,this.vertices=new Io,this.divisions=new Io,this.boneLookup=new Io,this.boundings=new Oo,this.unknown4To20=new Uint32Array(16),this.attachmentPoints=new Io,this.attachmentPointAddons=new Io,this.ligts=new Io,this.shbxData=new Io,this.cameras=new Io,this.unknown21=new Io,this.materialReferences=new Io,this.materials=[],this.particleEmitters=new Io,this.particleEmitterCopies=new Io,this.ribbonEmitters=new Io,this.projections=new Io,this.forces=new Io,this.warps=new Io,this.unknown22=new Io,this.rigidBodies=new Io,this.unknown23=new Io,this.physicsJoints=new Io,this.clothBehavior=new Io,this.unknown24=new Io,this.ikjtData=new Io,this.unknown25=new Io,this.unknown26=new Io,this.partsOfTurrentBehaviors=new Io,this.turrentBehaviors=new Io,this.absoluteInverseBoneRestPositions=new Io,this.tightHitTest=new Co,this.fuzzyHitTestObjects=new Io,this.attachmentVolumes=new Io,this.attachmentVolumesAddon0=new Io,this.attachmentVolumesAddon1=new Io,this.billboardBehaviors=new Io,this.tmdData=new Io,this.unknown27=0,this.unknown28=new Io;for(let t=0;t<11;t++)this.materials[t]=new Io}load(t,e,n){this.version=e,this.modelName.load(t,n),this.flags=t.readUint32(),this.sequences.load(t,n),this.stc.load(t,n),this.stg.load(t,n),this.unknown0=t.readFloat32(),this.unknown1=t.readFloat32(),this.unknown2=t.readFloat32(),this.unknown3=t.readFloat32(),this.sts.load(t,n),this.bones.load(t,n),this.numberOfBonesToCheckForSkin=t.readUint32(),this.vertexFlags=t.readUint32(),this.vertices.load(t,n),this.divisions.load(t,n),this.boneLookup.load(t,n),this.boundings.load(t),t.readUint32Array(this.unknown4To20),this.attachmentPoints.load(t,n),this.attachmentPointAddons.load(t,n),this.ligts.load(t,n),this.shbxData.load(t,n),this.cameras.load(t,n),this.unknown21.load(t,n),this.materialReferences.load(t,n);for(let e=0;e<7;e++)this.materials[e].load(t,n);e>24&&this.materials[7].load(t,n),e>25&&this.materials[8].load(t,n),e>27&&this.materials[9].load(t,n),e>28&&this.materials[10].load(t,n),this.particleEmitters.load(t,n),this.particleEmitterCopies.load(t,n),this.ribbonEmitters.load(t,n),this.projections.load(t,n),this.forces.load(t,n),this.warps.load(t,n),this.unknown22.load(t,n),this.rigidBodies.load(t,n),this.unknown23.load(t,n),this.physicsJoints.load(t,n),e>27&&this.clothBehavior.load(t,n),this.unknown24.load(t,n),this.ikjtData.load(t,n),this.unknown25.load(t,n),e>24&&this.unknown26.load(t,n),this.partsOfTurrentBehaviors.load(t,n),this.turrentBehaviors.load(t,n),this.absoluteInverseBoneRestPositions.load(t,n),this.tightHitTest.load(t),this.fuzzyHitTestObjects.load(t,n),this.attachmentVolumes.load(t,n),this.attachmentVolumesAddon0.load(t,n),this.attachmentVolumesAddon1.load(t,n),this.billboardBehaviors.load(t,n),this.tmdData.load(t,n),this.unknown27=t.readUint32(),this.unknown28.load(t,n)}},{23:784,25:808,26:820,28:844,29:856}],SEQS:[class{constructor(){this.version=-1,this.name=new Io,this.interval=new Uint32Array(2),this.movementSpeed=0,this.flags=0,this.frequency=0,this.boundingSphere=new Oo}load(t,e,n){this.version=e,t.skip(8),this.name.load(t,n),t.readUint32Array(this.interval),this.movementSpeed=t.readFloat32(),this.flags=t.readUint32(),this.frequency=t.readUint32(),t.skip(12),e<2&&t.skip(4),this.boundingSphere.load(t),t.skip(12)}},{1:96,2:92}],STC_:[class{constructor(){this.version=-1,this.name=new Io,this.runsConcurrent=0,this.priority=0,this.stsIndex=-1,this.stsIndexCopy=-1,this.animIds=new Io,this.animRefs=new Io,this.sd=[];for(let t=0;t<13;t++)this.sd[t]=new Io}load(t,e,n){this.version=e,this.name.load(t,n),this.runsConcurrent=t.readUint16(),this.priority=t.readUint16(),this.stsIndex=t.readUint16(),this.stsIndexCopy=t.readUint16(),this.animIds.load(t,n),this.animRefs.load(t,n),t.skip(4);for(let e=0;e<13;e++)this.sd[e].load(t,n)}},{4:204}],STG_:[class{constructor(){this.version=-1,this.name=new Io,this.stcIndices=new Io}load(t,e,n){this.version=e,this.name.load(t,n),this.stcIndices.load(t,n)}},{0:24}],STS_:[class{constructor(){this.version=-1,this.animIds=new Io}load(t,e,n){this.version=e,this.animIds.load(t,n),t.skip(16)}},{0:28}],BONE:[class{constructor(){this.version=-1,this.unknown0=0,this.name=new Io,this.flags=0,this.parent=-1,this.unknown1=0,this.location=new Go,this.rotation=new Ko,this.scale=new Go,this.visibility=new Do}load(t,e,n){this.version=e,this.unknown0=t.readInt32(),this.name.load(t,n),this.flags=t.readUint32(),this.parent=t.readInt16(),this.unknown1=t.readUint16(),this.location.load(t),this.rotation.load(t),this.scale.load(t),this.visibility.load(t)}},{1:160}],DIV_:[class{constructor(){this.version=-1,this.triangles=new Io,this.regions=new Io,this.batches=new Io,this.MSEC=new Io,this.unknown0=0}load(t,e,n){this.version=e,this.triangles.load(t,n),this.regions.load(t,n),this.batches.load(t,n),this.MSEC.load(t,n),this.unknown0=t.readUint32()}},{2:52}],REGN:[class{constructor(){this.version=-1,this.unknown0=0,this.unknown1=0,this.firstVertexIndex=-1,this.verticesCount=0,this.firstTriangleIndex=-1,this.triangleIndicesCount=0,this.bonesCount=0,this.firstBoneLookupIndex=-1,this.boneLookupIndicesCount=0,this.unknown2=0,this.boneWeightPairsCount=0,this.unknown3=0,this.rootBoneIndex=-1,this.unknown4=0,this.unknown5=new Uint8Array(8)}load(t,e,n){this.version=e,this.unknown0=t.readUint32(),this.unknown1=t.readUint32(),this.firstVertexIndex=t.readUint32(),this.verticesCount=t.readUint32(),this.firstTriangleIndex=t.readUint32(),this.triangleIndicesCount=t.readUint32(),this.bonesCount=t.readUint16(),this.firstBoneLookupIndex=t.readUint16(),this.boneLookupIndicesCount=t.readUint16(),this.unknown2=t.readUint16(),this.boneWeightPairsCount=t.readUint8(),this.unknown3=t.readUint8(),this.rootBoneIndex=t.readUint16(),e>3&&(this.unknown4=t.readUint32()),e>4&&t.readUint8Array(this.unknown5)}},{3:36,4:40,5:48}],BAT_:[class{constructor(){this.version=-1,this.unknown0=0,this.regionIndex=-1,this.unknown1=0,this.materialReferenceIndex=-1,this.unknown2=0}load(t,e,n){this.version=e,this.unknown0=t.readUint32(),this.regionIndex=t.readUint16(),this.unknown1=t.readUint32(),this.materialReferenceIndex=t.readUint16(),this.unknown2=t.readUint16()}},{1:14}],MATM:[class{constructor(){this.version=-1,this.materialType=0,this.materialIndex=-1}load(t,e,n){this.version=e,this.materialType=t.readUint32(),this.materialIndex=t.readUint32()}},{0:8}],MAT_:[class{constructor(){this.version=-1,this.name=new Io,this.additionalFlags=0,this.flags=0,this.blendMode=0,this.priority=0,this.usedRTTChannels=0,this.specularity=0,this.depthBlendFalloff=0,this.cutoutThreshold=0,this.unknown1=0,this.unknown2=0,this.unknown3=0,this.specMult=0,this.emisMult=0,this.diffuseLayer=new Io,this.decalLayer=new Io,this.specularLayer=new Io,this.glossLayer=new Io,this.emissiveLayer=new Io,this.emissive2Layer=new Io,this.evioLayer=new Io,this.evioMaskLayer=new Io,this.alphaMaskLayer=new Io,this.alphaMask2Layer=new Io,this.normalLayer=new Io,this.heightLayer=new Io,this.lightMapLayer=new Io,this.ambientOcclusionLayer=new Io,this.unknown4=new Io,this.unknown5=new Io,this.unknown6=new Io,this.unknown7=new Io,this.unknown8=0,this.layerBlendType=0,this.emisBlendType=0,this.emisMode=0,this.specType=0,this.unknown9=new Fo,this.unknown10=new Do,this.unknown11=new Uint8Array(12)}load(t,e,n){this.version=e,this.name.load(t,n),this.additionalFlags=t.readUint32(),this.flags=t.readUint32(),this.blendMode=t.readUint32(),this.priority=t.readInt32(),this.usedRTTChannels=t.readUint32(),this.specularity=t.readFloat32(),this.depthBlendFalloff=t.readFloat32(),this.cutoutThreshold=t.readUint8(),this.unknown1=t.readUint8(),this.unknown2=t.readUint8(),this.unknown3=t.readUint8(),this.specMult=t.readFloat32(),this.emisMult=t.readFloat32(),this.diffuseLayer.load(t,n),this.decalLayer.load(t,n),this.specularLayer.load(t,n),e>15&&this.glossLayer.load(t,n),this.emissiveLayer.load(t,n),this.emissive2Layer.load(t,n),this.evioLayer.load(t,n),this.evioMaskLayer.load(t,n),this.alphaMaskLayer.load(t,n),this.alphaMask2Layer.load(t,n),this.normalLayer.load(t,n),this.heightLayer.load(t,n),this.lightMapLayer.load(t,n),this.ambientOcclusionLayer.load(t,n),e>18&&(this.unknown4.load(t,n),this.unknown5.load(t,n),this.unknown6.load(t,n),this.unknown7.load(t,n)),this.unknown8=t.readUint32(),this.layerBlendType=t.readUint32(),this.emisBlendType=t.readUint32(),this.emisMode=t.readUint32(),this.specType=t.readUint32(),this.unknown9.load(t),this.unknown10.load(t),e>18&&(this.unknown11=t.readUint8Array(this.unknown11))}},{15:268,16:280,17:280,18:280,19:340}],LAYR:[class{constructor(){this.version=-1,this.unknown0=0,this.imagePath=new Io,this.color=new Po,this.flags=0,this.uvSource=-1,this.colorChannelSetting=0,this.brightMult=new Fo,this.midtoneOffset=new Fo,this.unknown1=0,this.noiseAmp=0,this.noiseFreq=0,this.rttChannel=0,this.videoFrameRate=0,this.videoStartFrame=0,this.videoEndFrame=0,this.videoMode=0,this.videoSyncTiming=0,this.videoPlay=new Do,this.videoRestart=new Do,this.flipBookRows=0,this.flipBookColumns=0,this.flipBookFrame=new No,this.uvOffset=new Vo,this.uvAngle=new Go,this.uvTiling=new Vo,this.unknown2=new Do,this.unknown3=new Fo,this.brightness=new Fo,this.triPlanarOffset=new Go,this.triPlanarScale=new Go,this.unknown4=0,this.fresnelType=0,this.fresnelExponent=0,this.fresnelMin=0,this.fresnelMaxOffset=0,this.unknown5=0,this.unknown6=new Uint8Array(8),this.fresnelInvertedMaskX=0,this.fresnelInvertedMaskY=0,this.fresnelInvertedMaskZ=0,this.fresnelRotationYaw=0,this.fresnelRotationPitch=0,this.unknown7=0}load(t,e,n){this.version=e,this.unknown0=t.readUint32(),this.imagePath.load(t,n),this.color.load(t),this.flags=t.readUint32(),this.uvSource=t.readUint32(),this.colorChannelSetting=t.readUint32(),this.brightMult.load(t),this.midtoneOffset.load(t),this.unknown1=t.readUint32(),e>23&&(this.noiseAmp=t.readFloat32(),this.noiseFreq=t.readFloat32()),this.rttChannel=t.readInt32(),this.videoFrameRate=t.readUint32(),this.videoStartFrame=t.readUint32(),this.videoEndFrame=t.readInt32(),this.videoMode=t.readUint32(),this.videoSyncTiming=t.readUint32(),this.videoPlay.load(t),this.videoRestart.load(t),this.flipBookRows=t.readUint32(),this.flipBookColumns=t.readUint32(),this.flipBookFrame.load(t),this.uvOffset.load(t),this.uvAngle.load(t),this.uvTiling.load(t),this.unknown2.load(t),this.unknown3.load(t),this.brightness.load(t),e>23&&(this.triPlanarOffset.load(t),this.triPlanarScale.load(t)),this.unknown4=t.readInt32(),this.fresnelType=t.readUint32(),this.fresnelExponent=t.readFloat32(),this.fresnelMin=t.readFloat32(),this.fresnelMaxOffset=t.readFloat32(),this.unknown5=t.readFloat32(),e>24&&(this.unknown6=t.readUint8Array(8),this.fresnelInvertedMaskX=t.readFloat32(),this.fresnelInvertedMaskY=t.readFloat32(),this.fresnelInvertedMaskZ=t.readFloat32(),this.fresnelRotationYaw=t.readFloat32(),this.fresnelRotationPitch=t.readFloat32(),this.unknown7=t.readUint32())}},{22:356,24:436,25:468,26:464}],EVNT:[class{constructor(){this.version=-1,this.name=new Io,this.unknown0=0,this.unknown1=0,this.unknown2=0,this.matrix=new Float32Array(16),this.unknown3=0,this.unknown4=0,this.unknown5=0,this.unknown6=0,this.unknown7=0,this.unknown8=0}load(t,e,n){this.version=e,this.name.load(t,n),this.unknown0=t.readInt32(),this.unknown1=t.readInt16(),this.unknown2=t.readUint16(),t.readFloat32Array(this.matrix),this.unknown3=t.readInt32(),this.unknown4=t.readInt32(),this.unknown5=t.readInt32(),e>0&&(this.unknown6=t.readInt32(),this.unknown7=t.readInt32()),e>1&&(this.unknown8=t.readInt32())}},{0:96,1:104,2:108}],BNDS:[Oo,{0:28}],ATT_:[class{constructor(){this.version=-1,this.unknown=0,this.name=new Io,this.bone=-1}load(t,e,n){this.version=e,this.unknown=t.readInt32(),this.name.load(t,n),this.bone=t.readUint32()}},{1:20}],CAM_:[class{constructor(){this.version=-1,this.bone=-1,this.name=new Io,this.fieldOfView=new Fo,this.unknown0=0,this.farClip=new Fo,this.nearClip=new Fo,this.clip2=new Fo,this.focalDepth=new Fo,this.falloffStart=new Fo,this.falloffEnd=new Fo,this.depthOfField=new Fo}load(t,e,n){this.version=e,this.bone=t.readUint32(),this.name.load(t,n),this.fieldOfView.load(t),this.unknown0=t.readUint32(),this.farClip.load(t),this.nearClip.load(t),this.clip2.load(t),this.focalDepth.load(t),this.falloffStart.load(t),this.falloffEnd.load(t),this.depthOfField.load(t)}},{3:180,5:264}],SDEV:[jo,{0:32}],SDU6:[jo,{0:32}],SDFG:[jo,{0:32}],SDS6:[jo,{0:32}],SDR3:[jo,{0:32}],SD2V:[jo,{0:32}],SD3V:[jo,{0:32}],SD4Q:[jo,{0:32}],SDCC:[jo,{0:32}],SDMB:[jo,{0:32}],FLAG:[jo,{0:32}],MSEC:[zo,{1:72}],LITE:[zo,{7:212}],ATVL:[zo,{0:116}],PATU:[zo,{4:152}],TRGD:[zo,{0:24}],DIS_:[zo,{4:68}],CMS_:[zo,{0:24}],CMP_:[zo,{2:28}],TER_:[zo,{0:24,1:28}],VOL_:[zo,{0:84}],VON_:[zo,{0:268}],CREP:[zo,{0:24,1:28}],STBM:[zo,{0:48}],LFSB:[zo,{2:56}],LFLR:[zo,{2:80,3:152}],PAR_:[zo,{12:1316,17:1460,18:1464,19:1464,21:1464,22:1484,23:1492,24:1496}],PARC:[zo,{0:40}],PROJ:[zo,{4:388,5:382}],PHYJ:[zo,{0:180}],PHCC:[zo,{0:76}],PHAC:[zo,{0:32}],PHCL:[zo,{2:128}],FOR_:[zo,{1:104,2:104}],DMSE:[zo,{0:4}],PHSH:[zo,{1:132,3:300}],PHRB:[zo,{2:104,4:80}],SSGS:[zo,{1:108}],BBSC:[zo,{0:48}],SRIB:[zo,{0:272}],RIB_:[zo,{6:748,8:756,9:760}],IKJT:[zo,{0:32}],SHBX:[zo,{0:64}],WRP_:[zo,{1:132}]};class Xo{constructor(t,e){const n=Ro(t.readBinary(4)),i=t.readUint32(),r=t.readUint32(),s=t.readUint32();this.index=e,this.tag=n,this.offset=i,this.version=s;const a=Ho[n],o=t.index;if(t.seek(i),a){const i=a[0],o=a[1][s];if(!o)throw new Error(": Unsupported object version - tag "+n+" and version "+s);this.entries=[];for(let n=0,a=r;n<a;n++)if(i===zo)this.entries[n]=new zo(t.substream(o),s,e);else{const r=new i;r.load(t.substream(o),s,e),this.entries[n]=r}}else if("CHAR"===n||"SCHR"===n)this.entries=t.read(r);else if("U8__"===n)this.entries=t.readUint8Array(r);else if("U16_"===n)this.entries=t.readUint16Array(r);else if("U32_"===n)this.entries=t.readUint32Array(r);else if("I16_"===n)this.entries=t.readInt16Array(r);else if("I32_"===n)this.entries=t.readInt32Array(r);else if("REAL"===n)this.entries=t.readFloat32Array(r);else if("VEC2"===n){this.entries=[];for(let e=0;e<r;e++)this.entries[e]=t.readFloat32Array(2)}else if("VEC3"===n||"SVC3"===n){this.entries=[];for(let e=0;e<r;e++)this.entries[e]=t.readFloat32Array(3)}else if("VEC4"===n||"QUAT"===n){this.entries=[];for(let e=0;e<r;e++)this.entries[e]=t.readFloat32Array(4)}else{if("IREF"!==n)throw this.entries=[],new Error(": Unsupported object tag - tag "+n+" and version "+s);this.entries=[];for(let e=0;e<r;e++)this.entries[e]=t.readFloat32Array(16)}t.seek(o)}}class qo{constructor(){this.index=[],this.model=null}load(t){const e=new bo(t),n=new Uo;if(n.load(e,11,this.index),"MD34"!==n.tag)throw new Error("WrongMagicNumber");e.seek(n.offset);for(let t=0,i=n.entries;t<i;t++)this.index[t]=new Xo(e,this.index);const i=this.index[n.model.id].entries;i&&(this.model=i[0])}}function Yo(t){return t instanceof ArrayBuffer&&(t=new Uint8Array(t)),t instanceof Uint8Array&&52===t[0]&&51===t[1]&&68===t[2]&&77===t[3]}class $o{constructor(t){this.index=0,this.ident=0,this.indentSpaces=4,this.precision=1e6,this.buffer=t||""}clear(){this.buffer="",this.index=0,this.ident=0}readToken(){const t=this.buffer,e=t.length;let n=!1,i=!1,r="";for(;this.index<e;){const e=t[this.index++];if(n)"\n"===e&&(n=!1);else if(i)if("\\"===e)r+=e+t[this.index++];else if("\n"===e)r+="\\n";else if("\r"===e)r+="\\r";else{if('"'===e)return r;r+=e}else if(" "===e||","===e||"\t"===e||"\n"===e||":"===e||"\r"===e){if(r.length)return r}else{if("{"===e||"}"===e)return r.length?(this.index--,r):e;if("/"===e&&"/"===t[this.index]){if(r.length)return this.index--,r;n=!0}else if('"'===e){if(r.length)return this.index--,r;i=!0}else r+=e}}}read(){const t=this.readToken();if(void 0===t)throw new Error("End of stream reached prematurely");return t}peek(){const t=this.index,e=this.read();return this.index=t,e}readInt(){return parseInt(this.read())}readFloat(){return parseFloat(this.read())}readVector(t){this.read();for(let e=0,n=t.length;e<n;e++)t[e]=this.readFloat();return this.read(),t}readVectorsBlock(t,e){this.read();for(let n=0,i=t.length;n<i;n+=e)this.readVector(t.subarray(n,n+e));return this.read(),t}readColor(t){return this.read(),t[2]=this.readFloat(),t[1]=this.readFloat(),t[0]=this.readFloat(),this.read(),t}*readBlock(){this.read();let t=this.read();for(;"}"!==t;)yield t,t=this.read()}writeLine(t){this.buffer+=`${" ".repeat(this.ident*this.indentSpaces)}${t}\n`}writeFlag(t){this.writeLine(`${t},`)}writeFlagAttrib(t,e){this.writeLine(`${t} ${e},`)}writeNumberAttrib(t,e){this.writeLine(`${t} ${this.floatDecimals(e)},`)}writeStringAttrib(t,e){this.writeLine(`${t} "${e}",`)}writeVectorAttrib(t,e){this.writeLine(`${t} { ${this.floatArrayDecimals(e)} },`)}writeColor(t,e){const n=this.floatDecimals(e[0]),i=this.floatDecimals(e[1]),r=this.floatDecimals(e[2]);this.writeLine(`${t} { ${r}, ${i}, ${n} },`)}writeVector(t){this.writeLine(`{ ${this.floatArrayDecimals(t)} },`)}writeVectorArrayBlock(t,e,n){this.startBlock(t,e.length/n);for(let t=0,i=e.length;t<i;t+=n)this.writeVector(e.subarray(t,t+n));this.endBlock()}startBlock(t,...e){e.length&&(t=`${t} ${e.join(" ")}`),this.writeLine(`${t} {`),this.ident+=1}startObjectBlock(t,e){this.writeLine(`${t} "${e.replace(/"/g,'\\"')}" {`),this.ident+=1}endBlock(){this.ident-=1,this.writeLine("}")}endBlockComma(){this.ident-=1,this.writeLine("},")}indent(){this.ident+=1}unindent(){this.ident-=1}floatDecimals(t){return""+Math.trunc(t*this.precision)/this.precision}floatArrayDecimals(t){if(t instanceof Float32Array){const e=[];for(let n=0,i=t.length;n<i;n++)e[n]=this.floatDecimals(t[n]);return e.join(", ")}return t.join(", ")}}class Wo{constructor(){this.boundsRadius=0,this.min=new Float32Array(3),this.max=new Float32Array(3)}readMdx(t){this.boundsRadius=t.readFloat32(),t.readFloat32Array(this.min),t.readFloat32Array(this.max)}writeMdx(t){t.writeFloat32(this.boundsRadius),t.writeFloat32Array(this.min),t.writeFloat32Array(this.max)}writeMdl(t){0===this.min[0]&&0===this.min[1]&&0===this.min[2]||t.writeVectorAttrib("MinimumExtent",this.min),0===this.max[0]&&0===this.max[1]&&0===this.max[2]||t.writeVectorAttrib("MaximumExtent",this.max),0!==this.boundsRadius&&t.writeNumberAttrib("BoundsRadius",this.boundsRadius)}}class Zo{constructor(){this.name="",this.interval=new Uint32Array(2),this.moveSpeed=0,this.nonLooping=0,this.rarity=0,this.syncPoint=0,this.extent=new Wo}readMdx(t){this.name=t.read(80),t.readUint32Array(this.interval),this.moveSpeed=t.readFloat32(),this.nonLooping=t.readUint32(),this.rarity=t.readFloat32(),this.syncPoint=t.readUint32(),this.extent.readMdx(t)}writeMdx(t){t.skip(80-t.write(this.name)),t.writeUint32Array(this.interval),t.writeFloat32(this.moveSpeed),t.writeUint32(this.nonLooping),t.writeFloat32(this.rarity),t.writeUint32(this.syncPoint),this.extent.writeMdx(t)}readMdl(t){this.name=t.read();for(const e of t.readBlock())if("Interval"===e)t.readVector(this.interval);else if("NonLooping"===e)this.nonLooping=1;else if("MoveSpeed"===e)this.moveSpeed=t.readFloat();else if("Rarity"===e)this.rarity=t.readFloat();else if("MinimumExtent"===e)t.readVector(this.extent.min);else if("MaximumExtent"===e)t.readVector(this.extent.max);else{if("BoundsRadius"!==e)throw new Error(`Unknown token in Sequence: "${e}"`);this.extent.boundsRadius=t.readFloat()}}writeMdl(t){t.startObjectBlock("Anim",this.name),t.writeVectorAttrib("Interval",this.interval),1===this.nonLooping&&t.writeFlag("NonLooping"),0!==this.moveSpeed&&t.writeNumberAttrib("MoveSpeed",this.moveSpeed),0!==this.rarity&&t.writeNumberAttrib("Rarity",this.rarity),this.extent.writeMdl(t),t.endBlock()}}class Jo{constructor(){this.name="",this.interpolationType=0,this.globalSequenceId=-1,this.frames=[],this.values=[],this.inTans=[],this.outTans=[]}readMdx(t,e){const n=this.frames,i=this.values,r=this.inTans,s=this.outTans,a=t.readUint32(),o=t.readUint32();this.name=e,this.interpolationType=o,this.globalSequenceId=t.readInt32();for(let e=0;e<a;e++)n.push(t.readInt32()),i.push(this.readMdxValue(t)),o>1&&(r.push(this.readMdxValue(t)),s.push(this.readMdxValue(t)))}writeMdx(t){const e=this.interpolationType,n=this.frames,i=this.values,r=this.inTans,s=this.outTans,a=n.length;t.writeBinary(this.name),t.writeUint32(a),t.writeUint32(e),t.writeInt32(this.globalSequenceId);for(let o=0;o<a;o++)t.writeInt32(n[o]),this.writeMdxValue(t,i[o]),e>1&&(this.writeMdxValue(t,r[o]),this.writeMdxValue(t,s[o]))}readMdl(t,e){const n=this.frames,i=this.values,r=this.inTans,s=this.outTans;this.name=e;const a=t.readInt();t.read();let o=0;const l=t.read();"DontInterp"===l?o=0:"Linear"===l?o=1:"Hermite"===l?o=2:"Bezier"===l&&(o=3),this.interpolationType=o,"GlobalSeqId"===t.peek()&&(t.read(),this.globalSequenceId=t.readInt());for(let e=0;e<a;e++)n[e]=t.readInt(),i[e]=this.readMdlValue(t),o>1&&(t.read(),r[e]=this.readMdlValue(t),t.read(),s[e]=this.readMdlValue(t));t.read()}writeMdl(t,e){const n=this.interpolationType,i=this.frames,r=this.values,s=this.inTans,a=this.outTans,o=i.length;t.startBlock(e,this.frames.length);let l="";0===this.interpolationType?l="DontInterp":1===this.interpolationType?l="Linear":2===this.interpolationType?l="Hermite":3===this.interpolationType&&(l="Bezier"),t.writeFlag(l),-1!==this.globalSequenceId&&t.writeNumberAttrib("GlobalSeqId",this.globalSequenceId);for(let e=0;e<o;e++)this.writeMdlValue(t,`${i[e]}:`,r[e]),n>1&&(t.indent(),this.writeMdlValue(t,"InTan",s[e]),this.writeMdlValue(t,"OutTan",a[e]),t.unindent());t.endBlock()}getByteLength(){const t=this.frames.length;let e=16;if(t){const n=this.values[0].byteLength;let i=1;this.interpolationType>1&&(i=3),e+=(4+i*n)*t}return e}}class Qo extends Jo{readMdxValue(t){return t.readUint32Array(1)}writeMdxValue(t,e){t.writeUint32(e[0])}readMdlValue(t){return new Uint32Array([t.readInt()])}writeMdlValue(t,e,n){t.writeNumberAttrib(e,n[0])}}class tl extends Jo{readMdxValue(t){return t.readFloat32Array(1)}writeMdxValue(t,e){t.writeFloat32(e[0])}readMdlValue(t){return new Float32Array([t.readFloat()])}writeMdlValue(t,e,n){t.writeNumberAttrib(e,n[0])}}class el extends Jo{readMdxValue(t){return t.readFloat32Array(3)}writeMdxValue(t,e){t.writeFloat32Array(e)}readMdlValue(t){return t.readVector(new Float32Array(3))}writeMdlValue(t,e,n){t.writeVectorAttrib(e,n)}}class nl extends Jo{readMdxValue(t){return t.readFloat32Array(4)}writeMdxValue(t,e){t.writeFloat32Array(e)}readMdlValue(t){return t.readVector(new Float32Array(4))}writeMdlValue(t,e,n){t.writeVectorAttrib(e,n)}}const il={KMTF:["TextureID",Qo],KMTA:["Alpha",tl],KMTE:["EmissiveGain",tl],KFC3:["FresnelColor",el],KFCA:["FresnelOpacity",tl],KFTC:["FresnelTeamColor",Qo],KTAT:["Translation",el],KTAR:["Rotation",nl],KTAS:["Scaling",el],KGAO:["Alpha",tl],KGAC:["Color",el],KGTR:["Translation",el],KGRT:["Rotation",nl],KGSC:["Scaling",el],KLAS:["AttenuationStart",tl],KLAE:["AttenuationEnd",tl],KLAC:["Color",el],KLAI:["Intensity",tl],KLBI:["AmbIntensity",tl],KLBC:["AmbColor",el],KLAV:["Visibility",tl],KATV:["Visibility",tl],KPEE:["EmissionRate",tl],KPEG:["Gravity",tl],KPLN:["Longitude",tl],KPLT:["Latitude",tl],KPEL:["LifeSpan",tl],KPES:["InitVelocity",tl],KPEV:["Visibility",tl],KP2S:["Speed",tl],KP2R:["Variation",tl],KP2L:["Latitude",tl],KP2G:["Gravity",tl],KP2E:["EmissionRate",tl],KP2N:["Width",tl],KP2W:["Length",tl],KP2V:["Visibility",tl],KPPA:["Alpha",tl],KPPC:["Color",el],KPPE:["EmissionRate",tl],KPPL:["LifeSpan",tl],KPPS:["Speed",tl],KPPV:["Visibility",tl],KRHA:["HeightAbove",tl],KRHB:["HeightBelow",tl],KRAL:["Alpha",tl],KRCO:["Color",el],KRTX:["TextureSlot",Qo],KRVS:["Visibility",tl],KCTR:["Translation",el],KTTR:["Translation",el],KCRL:["Rotation",tl]};class rl{constructor(){this.animations=[]}readAnimations(t,e){const n=t.index+e;for(;t.index<n;){const e=t.readBinary(4),n=new il[e][1];n.readMdx(t,e),this.animations.push(n)}}writeAnimations(t){for(const e of this.animations)e.writeMdx(t)}*readAnimatedBlock(t){for(const e of t.readBlock())"static"===e?yield`static ${t.read()}`:yield e}readAnimation(t,e){const n=new il[e][1];n.readMdl(t,e),this.animations.push(n)}writeAnimation(t,e){for(const n of this.animations)if(n.name===e)return n.writeMdl(t,il[e][0]),!0;return!1}getByteLength(t=0){let e=0;for(const t of this.animations)e+=t.getByteLength();return e}}function sl(t){return"None"===t?0:"Transparent"===t?1:"Blend"===t?2:"Additive"===t?3:"AddAlpha"===t?4:"Modulate"===t?5:"Modulate2x"===t?6:0}class al extends rl{constructor(){super(...arguments),this.filterMode=0,this.flags=0,this.textureId=-1,this.textureAnimationId=-1,this.coordId=0,this.alpha=1,this.emissiveGain=1,this.fresnelColor=new Float32Array([1,1,1]),this.fresnelOpacity=0,this.fresnelTeamColor=0}readMdx(t,e){const n=t.index,i=t.readUint32();this.filterMode=t.readUint32(),this.flags=t.readUint32(),this.textureId=t.readInt32(),this.textureAnimationId=t.readInt32(),this.coordId=t.readUint32(),this.alpha=t.readFloat32(),e>800&&(this.emissiveGain=t.readFloat32(),t.readFloat32Array(this.fresnelColor),this.fresnelOpacity=t.readFloat32(),this.fresnelTeamColor=t.readFloat32()),this.readAnimations(t,i-(t.index-n))}writeMdx(t,e){t.writeUint32(this.getByteLength(e)),t.writeUint32(this.filterMode),t.writeUint32(this.flags),t.writeInt32(this.textureId),t.writeInt32(this.textureAnimationId),t.writeUint32(this.coordId),t.writeFloat32(this.alpha),e>800&&(t.writeFloat32(this.emissiveGain),t.writeFloat32Array(this.fresnelColor),t.writeFloat32(this.fresnelOpacity),t.writeFloat32(this.fresnelTeamColor)),this.writeAnimations(t)}readMdl(t){for(const e of super.readAnimatedBlock(t))if("FilterMode"===e)this.filterMode=sl(t.read());else if("Unshaded"===e)this.flags|=1;else if("SphereEnvMap"===e)this.flags|=2;else if("TwoSided"===e)this.flags|=16;else if("Unfogged"===e)this.flags|=32;else if("NoDepthTest"===e)this.flags|=64;else if("NoDepthSet"===e)this.flags|=128;else if("Unlit"===e)this.flags|=256;else if("static TextureID"===e)this.textureId=t.readInt();else if("TextureID"===e)this.readAnimation(t,"KMTF");else if("TVertexAnimId"===e)this.textureAnimationId=t.readInt();else if("CoordId"===e)this.coordId=t.readInt();else if("static Alpha"===e)this.alpha=t.readFloat();else if("Alpha"===e)this.readAnimation(t,"KMTA");else if("static EmissiveGain"===e)this.emissiveGain=t.readFloat();else if("EmissiveGain"===e)this.readAnimation(t,"KMTE");else if("static FresnelColor"===e)t.readVector(this.fresnelColor);else if("FresnelColor"===e)this.readAnimation(t,"KFC3");else if("static FresnelOpacity"===e)this.fresnelOpacity=t.readFloat();else if("FresnelOpacity"===e)this.readAnimation(t,"KFCA");else if("static FresnelTeamColor"===e)this.fresnelTeamColor=t.readFloat();else{if("FresnelTeamColor"!==e)throw new Error(`Unknown token in Layer: "${e}"`);this.readAnimation(t,"KFTC")}}writeMdl(t,e){var n;t.startBlock("Layer"),t.writeFlagAttrib("FilterMode",0===(n=this.filterMode)?"None":1===n?"Transparent":2===n?"Blend":3===n?"Additive":4===n?"AddAlpha":5===n?"Modulate":6===n?"Modulate2x":"None"),1&this.flags&&t.writeFlag("Unshaded"),2&this.flags&&t.writeFlag("SphereEnvMap"),16&this.flags&&t.writeFlag("TwoSided"),32&this.flags&&t.writeFlag("Unfogged"),64&this.flags&&t.writeFlag("NoDepthTest"),128&this.flags&&t.writeFlag("NoDepthSet"),e>800&&256&this.flags&&t.writeFlag("Unlit"),this.writeAnimation(t,"KMTF")||t.writeNumberAttrib("static TextureID",this.textureId),-1!==this.textureAnimationId&&t.writeNumberAttrib("TVertexAnimId",this.textureAnimationId),0!==this.coordId&&t.writeNumberAttrib("CoordId",this.coordId),this.writeAnimation(t,"KMTA")||1===this.alpha||t.writeNumberAttrib("static Alpha",this.alpha),e>800&&(this.writeAnimation(t,"KMTE")||1===this.emissiveGain||t.writeNumberAttrib("static EmissiveGain",this.emissiveGain),this.writeAnimation(t,"KFC3")||1===this.fresnelColor[0]&&1===this.fresnelColor[1]&&1===this.fresnelColor[2]||t.writeVectorAttrib("static FresnelColor",this.fresnelColor),this.writeAnimation(t,"KFCA")||0===this.fresnelOpacity||t.writeNumberAttrib("static FresnelOpacity",this.fresnelOpacity),this.writeAnimation(t,"KFTC")||0===this.fresnelTeamColor||t.writeNumberAttrib("static FresnelTeamColor",this.fresnelTeamColor)),t.endBlock()}getByteLength(t){let e=28+super.getByteLength();return t>800&&(e+=24),e}}class ol{constructor(){this.priorityPlane=0,this.flags=0,this.shader="",this.layers=[]}readMdx(t,e){t.readUint32(),this.priorityPlane=t.readInt32(),this.flags=t.readUint32(),e>800&&(this.shader=t.read(80)),t.skip(4);for(let n=0,i=t.readUint32();n<i;n++){const n=new al;n.readMdx(t,e),this.layers.push(n)}}writeMdx(t,e){t.writeUint32(this.getByteLength(e)),t.writeInt32(this.priorityPlane),t.writeUint32(this.flags),e>800&&t.skip(80-t.write(this.shader)),t.writeBinary("LAYS"),t.writeUint32(this.layers.length);for(const n of this.layers)n.writeMdx(t,e)}readMdl(t){for(const e of t.readBlock())if("ConstantColor"===e)this.flags|=1;else if("TwoSided"===e)this.flags|=2;else if("SortPrimsNearZ"===e)this.flags|=8;else if("SortPrimsFarZ"===e)this.flags|=16;else if("FullResolution"===e)this.flags|=32;else if("PriorityPlane"===e)this.priorityPlane=t.readInt();else if("Shader"===e)this.shader=t.read();else{if("Layer"!==e)throw new Error(`Unknown token in Material: "${e}"`);{const e=new al;e.readMdl(t),this.layers.push(e)}}}writeMdl(t,e){t.startBlock("Material"),1&this.flags&&t.writeFlag("ConstantColor"),e>800&&2&this.flags&&t.writeFlag("TwoSided"),8&this.flags&&t.writeFlag("SortPrimsNearZ"),16&this.flags&&t.writeFlag("SortPrimsFarZ"),32&this.flags&&t.writeFlag("FullResolution"),0!==this.priorityPlane&&t.writeNumberAttrib("PriorityPlane",this.priorityPlane),e>800&&t.writeStringAttrib("Shader",this.shader);for(const n of this.layers)n.writeMdl(t,e);t.endBlock()}getByteLength(t){let e=20;t>800&&(e+=80);for(const n of this.layers)e+=n.getByteLength(t);return e}}class ll{constructor(){this.replaceableId=0,this.path="",this.wrapMode=0}readMdx(t){this.replaceableId=t.readUint32(),this.path=t.read(260),this.wrapMode=t.readUint32()}writeMdx(t){t.writeUint32(this.replaceableId),t.skip(260-t.write(this.path)),t.writeUint32(this.wrapMode)}readMdl(t){for(const e of t.readBlock())if("Image"===e)this.path=t.read();else if("ReplaceableId"===e)this.replaceableId=t.readInt();else if("WrapWidth"===e)this.wrapMode|=1;else{if("WrapHeight"!==e)throw new Error(`Unknown token in Texture: "${e}"`);this.wrapMode|=2}}writeMdl(t){t.startBlock("Bitmap"),this.path.length&&t.writeStringAttrib("Image",this.path),0!==this.replaceableId&&t.writeNumberAttrib("ReplaceableId",this.replaceableId),1&this.wrapMode&&t.writeFlag("WrapWidth"),2&this.wrapMode&&t.writeFlag("WrapHeight"),t.endBlock()}}class hl extends rl{readMdx(t){const e=t.readUint32();this.readAnimations(t,e-4)}writeMdx(t){t.writeUint32(this.getByteLength()),this.writeAnimations(t)}readMdl(t){for(const e of t.readBlock())if("Translation"===e)this.readAnimation(t,"KTAT");else if("Rotation"===e)this.readAnimation(t,"KTAR");else{if("Scaling"!==e)throw new Error(`Unknown token in TextureAnimation: "${e}"`);this.readAnimation(t,"KTAS")}}writeMdl(t){t.startBlock("TVertexAnim "),this.writeAnimation(t,"KTAT"),this.writeAnimation(t,"KTAR"),this.writeAnimation(t,"KTAS"),t.endBlock()}getByteLength(){return 4+super.getByteLength()}}class ul{constructor(){this.vertices=new Float32Array(0),this.normals=new Float32Array(0),this.faceTypeGroups=new Uint32Array(0),this.faceGroups=new Uint32Array(0),this.faces=new Uint16Array(0),this.vertexGroups=new Uint8Array(0),this.matrixGroups=new Uint32Array(0),this.matrixIndices=new Uint32Array(0),this.materialId=0,this.selectionGroup=0,this.selectionFlags=0,this.lod=-1,this.lodName="",this.extent=new Wo,this.sequenceExtents=[],this.tangents=new Float32Array(0),this.skin=new Uint8Array(0),this.uvSets=[]}readMdx(t,e){t.readUint32(),t.skip(4),this.vertices=t.readFloat32Array(3*t.readUint32()),t.skip(4),this.normals=t.readFloat32Array(3*t.readUint32()),t.skip(4),this.faceTypeGroups=t.readUint32Array(t.readUint32()),t.skip(4),this.faceGroups=t.readUint32Array(t.readUint32()),t.skip(4),this.faces=t.readUint16Array(t.readUint32()),t.skip(4),this.vertexGroups=t.readUint8Array(t.readUint32()),t.skip(4),this.matrixGroups=t.readUint32Array(t.readUint32()),t.skip(4),this.matrixIndices=t.readUint32Array(t.readUint32()),this.materialId=t.readUint32(),this.selectionGroup=t.readUint32(),this.selectionFlags=t.readUint32(),e>800&&(this.lod=t.readInt32(),this.lodName=t.read(80)),this.extent.readMdx(t);for(let e=0,n=t.readUint32();e<n;e++){const e=new Wo;e.readMdx(t),this.sequenceExtents.push(e)}e>800&&("TANG"===t.readBinary(4)?this.tangents=t.readFloat32Array(4*t.readUint32()):t.skip(-4),"SKIN"===t.readBinary(4)?this.skin=t.readUint8Array(t.readUint32()):t.skip(-4)),t.skip(4);for(let e=0,n=t.readUint32();e<n;e++)t.skip(4),this.uvSets.push(t.readFloat32Array(2*t.readUint32()))}writeMdx(t,e){t.writeUint32(this.getByteLength(e)),t.writeBinary("VRTX"),t.writeUint32(this.vertices.length/3),t.writeFloat32Array(this.vertices),t.writeBinary("NRMS"),t.writeUint32(this.normals.length/3),t.writeFloat32Array(this.normals),t.writeBinary("PTYP"),t.writeUint32(this.faceTypeGroups.length),t.writeUint32Array(this.faceTypeGroups),t.writeBinary("PCNT"),t.writeUint32(this.faceGroups.length),t.writeUint32Array(this.faceGroups),t.writeBinary("PVTX"),t.writeUint32(this.faces.length),t.writeUint16Array(this.faces),t.writeBinary("GNDX"),t.writeUint32(this.vertexGroups.length),t.writeUint8Array(this.vertexGroups),t.writeBinary("MTGC"),t.writeUint32(this.matrixGroups.length),t.writeUint32Array(this.matrixGroups),t.writeBinary("MATS"),t.writeUint32(this.matrixIndices.length),t.writeUint32Array(this.matrixIndices),t.writeUint32(this.materialId),t.writeUint32(this.selectionGroup),t.writeUint32(this.selectionFlags),e>800&&(t.writeInt32(this.lod),t.skip(80-t.write(this.lodName))),this.extent.writeMdx(t),t.writeUint32(this.sequenceExtents.length);for(const e of this.sequenceExtents)e.writeMdx(t);e>800&&(this.tangents.length&&(t.writeBinary("TANG"),t.writeUint32(this.tangents.length/4),t.writeFloat32Array(this.tangents)),this.skin.length&&(t.writeBinary("SKIN"),t.writeUint32(this.skin.length),t.writeUint8Array(this.skin))),t.writeBinary("UVAS"),t.writeUint32(this.uvSets.length);for(const e of this.uvSets)t.writeBinary("UVBS"),t.writeUint32(e.length/2),t.writeFloat32Array(e)}readMdl(t){for(let e of t.readBlock())if("Vertices"===e)this.vertices=t.readVectorsBlock(new Float32Array(3*t.readInt()),3);else if("Normals"===e)this.normals=t.readVectorsBlock(new Float32Array(3*t.readInt()),3);else if("TVertices"===e)this.uvSets.push(t.readVectorsBlock(new Float32Array(2*t.readInt()),2));else if("VertexGroup"===e){const e=[];for(const n of t.readBlock())e.push(parseInt(n));this.vertexGroups=new Uint8Array(e)}else if("Tangents"===e)this.tangents=t.readVectorsBlock(new Float32Array(4*t.readInt()),4);else if("SkinWeights"===e)this.skin=t.readVector(new Uint8Array(8*t.readInt()));else if("Faces"===e){this.faceTypeGroups=new Uint32Array([4]);const e=t.readInt(),n=t.readInt();t.read(),t.read(),this.faces=t.readVectorsBlock(new Uint16Array(n),n/e),this.faceGroups=new Uint32Array([n]),t.read()}else if("Groups"===e){const e=[],n=[];t.readInt(),t.readInt();for(const i of t.readBlock()){let i=0;for(const n of t.readBlock())e.push(parseInt(n)),i+=1;n.push(i)}this.matrixIndices=new Uint32Array(e),this.matrixGroups=new Uint32Array(n)}else if("MinimumExtent"===e)t.readVector(this.extent.min);else if("MaximumExtent"===e)t.readVector(this.extent.max);else if("BoundsRadius"===e)this.extent.boundsRadius=t.readFloat();else if("Anim"===e){const n=new Wo;for(e of t.readBlock())"MinimumExtent"===e?t.readVector(n.min):"MaximumExtent"===e?t.readVector(n.max):"BoundsRadius"===e&&(n.boundsRadius=t.readFloat());this.sequenceExtents.push(n)}else if("MaterialID"===e)this.materialId=t.readInt();else if("SelectionGroup"===e)this.selectionGroup=t.readInt();else if("Unselectable"===e)this.selectionFlags=4;else if("LevelOfDetail"===e)this.lod=t.readInt();else{if("Name"!==e)throw new Error(`Unknown token in Geoset: "${e}"`);this.lodName=t.read()}}writeMdl(t,e){t.startBlock("Geoset"),t.writeVectorArrayBlock("Vertices",this.vertices,3),t.writeVectorArrayBlock("Normals",this.normals,3);for(const e of this.uvSets)t.writeVectorArrayBlock("TVertices",e,2);if(e>800&&this.tangents.length&&t.writeVectorArrayBlock("Tangents",this.tangents,4),this.vertexGroups.length){t.startBlock("VertexGroup");for(let e=0,n=this.vertexGroups.length;e<n;e++)t.writeLine(`${this.vertexGroups[e]},`);t.endBlock()}if(e>800&&this.skin.length){t.startBlock("SkinWeights",this.skin.length/8);for(let e=0,n=this.skin.length;e<n;e+=8)t.writeLine(`${this.skin.subarray(e,e+8).join(", ")},`);t.endBlock()}t.startBlock("Faces",1,this.faces.length),t.startBlock("Triangles"),t.writeVector(this.faces),t.endBlock(),t.endBlock(),t.startBlock("Groups",this.matrixGroups.length,this.matrixIndices.length);let n=0;for(const e of this.matrixGroups)t.writeVectorAttrib("Matrices",this.matrixIndices.subarray(n,n+e)),n+=e;t.endBlock(),this.extent.writeMdl(t);for(const e of this.sequenceExtents)t.startBlock("Anim"),e.writeMdl(t),t.endBlock();t.writeNumberAttrib("MaterialID",this.materialId),t.writeNumberAttrib("SelectionGroup",this.selectionGroup),4===this.selectionFlags&&t.writeFlag("Unselectable"),e>800&&(t.writeNumberAttrib("LevelOfDetail",this.lod),this.lodName.length&&t.writeStringAttrib("Name",this.lodName)),t.endBlock()}getByteLength(t){let e=120+this.vertices.byteLength+this.normals.byteLength+this.faceTypeGroups.byteLength+this.faceGroups.byteLength+this.faces.byteLength+this.vertexGroups.byteLength+this.matrixGroups.byteLength+this.matrixIndices.byteLength+28*this.sequenceExtents.length;t>800&&(e+=84,this.tangents.length&&(e+=8+this.tangents.byteLength),this.skin.length&&(e+=8+this.skin.byteLength));for(const t of this.uvSets)e+=8+t.byteLength;return e}}class cl extends rl{constructor(){super(...arguments),this.alpha=1,this.flags=0,this.color=new Float32Array([1,1,1]),this.geosetId=-1}readMdx(t){const e=t.readUint32();this.alpha=t.readFloat32(),this.flags=t.readUint32(),t.readFloat32Array(this.color),this.geosetId=t.readInt32(),this.readAnimations(t,e-28)}writeMdx(t){t.writeUint32(this.getByteLength()),t.writeFloat32(this.alpha),t.writeUint32(this.flags),t.writeFloat32Array(this.color),t.writeInt32(this.geosetId),this.writeAnimations(t)}readMdl(t){for(const e of super.readAnimatedBlock(t))if("DropShadow"===e)this.flags|=1;else if("static Alpha"===e)this.alpha=t.readFloat();else if("Alpha"===e)this.readAnimation(t,"KGAO");else if("static Color"===e)this.flags|=2,t.readColor(this.color);else if("Color"===e)this.flags|=2,this.readAnimation(t,"KGAC");else{if("GeosetId"!==e)throw new Error(`Unknown token in GeosetAnimation: "${e}"`);this.geosetId=t.readInt()}}writeMdl(t){t.startBlock("GeosetAnim"),1&this.flags&&t.writeFlag("DropShadow"),this.writeAnimation(t,"KGAO")||t.writeNumberAttrib("static Alpha",this.alpha),2&this.flags&&(this.writeAnimation(t,"KGAC")||1===this.color[0]&&1===this.color[1]&&1===this.color[2]||t.writeColor("static Color ",this.color)),t.writeNumberAttrib("GeosetId",this.geosetId),t.endBlock()}getByteLength(){return 28+super.getByteLength()}}class dl extends rl{constructor(t=0){super(),this.name="",this.objectId=-1,this.parentId=-1,this.flags=t}readMdx(t){const e=t.readUint32();this.name=t.read(80),this.objectId=t.readInt32(),this.parentId=t.readInt32(),this.flags=t.readUint32(),this.readAnimations(t,e-96)}writeMdx(t){t.writeUint32(this.getGenericByteLength()),t.skip(80-t.write(this.name)),t.writeInt32(this.objectId),t.writeInt32(this.parentId),t.writeUint32(this.flags);for(const e of this.eachAnimation(!0))e.writeMdx(t)}writeNonGenericAnimationChunks(t){for(const e of this.eachAnimation(!1))e.writeMdx(t)}*readGenericBlock(t){this.name=t.read();for(let e of this.readAnimatedBlock(t))if("ObjectId"===e)this.objectId=t.readInt();else if("Parent"===e)this.parentId=t.readInt();else if("BillboardedLockZ"===e)this.flags|=64;else if("BillboardedLockY"===e)this.flags|=32;else if("BillboardedLockX"===e)this.flags|=16;else if("Billboarded"===e)this.flags|=8;else if("CameraAnchored"===e)this.flags|=128;else if("DontInherit"===e)for(e of t.readBlock())"Rotation"===e?this.flags|=4:"Translation"===e?this.flags|=1:"Scaling"===e&&(this.flags|=2);else"Translation"===e?this.readAnimation(t,"KGTR"):"Rotation"===e?this.readAnimation(t,"KGRT"):"Scaling"===e?this.readAnimation(t,"KGSC"):yield e}writeGenericHeader(t){t.writeNumberAttrib("ObjectId",this.objectId),-1!==this.parentId&&t.writeNumberAttrib("Parent",this.parentId),64&this.flags&&t.writeFlag("BillboardedLockZ"),32&this.flags&&t.writeFlag("BillboardedLockY"),16&this.flags&&t.writeFlag("BillboardedLockX"),8&this.flags&&t.writeFlag("Billboarded"),128&this.flags&&t.writeFlag("CameraAnchored"),4&this.flags&&t.writeFlag("DontInherit { Rotation }"),1&this.flags&&t.writeFlag("DontInherit { Translation }"),2&this.flags&&t.writeFlag("DontInherit { Scaling }")}writeGenericAnimations(t){this.writeAnimation(t,"KGTR"),this.writeAnimation(t,"KGRT"),this.writeAnimation(t,"KGSC")}*eachAnimation(t){for(const e of this.animations){const n=e.name,i="KGTR"===n||"KGRT"===n||"KGSC"===n;(t&&i||!t&&!i)&&(yield e)}}getGenericByteLength(){let t=96;for(const e of this.eachAnimation(!0))t+=e.getByteLength();return t}getByteLength(){return 96+super.getByteLength()}}class fl extends dl{constructor(){super(256),this.geosetId=-1,this.geosetAnimationId=-1}readMdx(t){super.readMdx(t),this.geosetId=t.readInt32(),this.geosetAnimationId=t.readInt32()}writeMdx(t){super.writeMdx(t),t.writeInt32(this.geosetId),t.writeInt32(this.geosetAnimationId)}readMdl(t){for(let e of super.readGenericBlock(t))if("GeosetId"===e)e=t.read(),this.geosetId="Multiple"===e?-1:parseInt(e);else{if("GeosetAnimId"!==e)throw new Error(`Unknown token in Bone ${this.name}: "${e}"`);e=t.read(),this.geosetAnimationId="None"===e?-1:parseInt(e)}}writeMdl(t){t.startObjectBlock("Bone",this.name),this.writeGenericHeader(t),-1===this.geosetId?t.writeFlagAttrib("GeosetId","Multiple"):t.writeNumberAttrib("GeosetId",this.geosetId),-1===this.geosetAnimationId?t.writeFlagAttrib("GeosetAnimId","None"):t.writeNumberAttrib("GeosetAnimId",this.geosetAnimationId),this.writeGenericAnimations(t),t.endBlock()}getByteLength(){return 8+super.getByteLength()}}class pl extends dl{constructor(){super(512),this.type=-1,this.attenuation=new Float32Array(2),this.color=new Float32Array(3),this.intensity=0,this.ambientColor=new Float32Array(3),this.ambientIntensity=0}readMdx(t){const e=t.index,n=t.readUint32();super.readMdx(t),this.type=t.readUint32(),t.readFloat32Array(this.attenuation),t.readFloat32Array(this.color),this.intensity=t.readFloat32(),t.readFloat32Array(this.ambientColor),this.ambientIntensity=t.readFloat32(),this.readAnimations(t,n-(t.index-e))}writeMdx(t){t.writeUint32(this.getByteLength()),super.writeMdx(t),t.writeUint32(this.type),t.writeFloat32Array(this.attenuation),t.writeFloat32Array(this.color),t.writeFloat32(this.intensity),t.writeFloat32Array(this.ambientColor),t.writeFloat32(this.ambientIntensity),this.writeNonGenericAnimationChunks(t)}readMdl(t){for(const e of super.readGenericBlock(t))if("Omnidirectional"===e)this.type=0;else if("Directional"===e)this.type=1;else if("Ambient"===e)this.type=2;else if("static AttenuationStart"===e)this.attenuation[0]=t.readFloat();else if("AttenuationStart"===e)this.readAnimation(t,"KLAS");else if("static AttenuationEnd"===e)this.attenuation[1]=t.readFloat();else if("AttenuationEnd"===e)this.readAnimation(t,"KLAE");else if("static Intensity"===e)this.intensity=t.readFloat();else if("Intensity"===e)this.readAnimation(t,"KLAI");else if("static Color"===e)t.readColor(this.color);else if("Color"===e)this.readAnimation(t,"KLAC");else if("static AmbIntensity"===e)this.ambientIntensity=t.readFloat();else if("AmbIntensity"===e)this.readAnimation(t,"KLBI");else if("static AmbColor"===e)t.readColor(this.ambientColor);else if("AmbColor"===e)this.readAnimation(t,"KLBC");else{if("Visibility"!==e)throw new Error(`Unknown token in Light: "${e}"`);this.readAnimation(t,"KLAV")}}writeMdl(t){t.startObjectBlock("Light",this.name),this.writeGenericHeader(t),0===this.type?t.writeFlag("Omnidirectional"):1===this.type?t.writeFlag("Directional"):2===this.type&&t.writeFlag("Ambient"),this.writeAnimation(t,"KLAS")||t.writeNumberAttrib("static AttenuationStart",this.attenuation[0]),this.writeAnimation(t,"KLAE")||t.writeNumberAttrib("static AttenuationEnd",this.attenuation[1]),this.writeAnimation(t,"KLAI")||t.writeNumberAttrib("static Intensity",this.intensity),this.writeAnimation(t,"KLAC")||t.writeColor("static Color",this.color),this.writeAnimation(t,"KLBI")||t.writeNumberAttrib("static AmbIntensity",this.ambientIntensity),this.writeAnimation(t,"KLBC")||t.writeColor("static AmbColor",this.ambientColor),this.writeAnimation(t,"KLAV"),this.writeGenericAnimations(t),t.endBlock()}getByteLength(){return 48+super.getByteLength()}}class ml extends dl{readMdl(t){for(const e of super.readGenericBlock(t))throw new Error(`Unknown token in Helper: "${e}"`)}writeMdl(t){t.startObjectBlock("Helper",this.name),this.writeGenericHeader(t),this.writeGenericAnimations(t),t.endBlock()}}class _l extends dl{constructor(){super(2048),this.path="",this.attachmentId=0}readMdx(t){const e=t.index,n=t.readUint32();super.readMdx(t),this.path=t.read(260),this.attachmentId=t.readInt32(),this.readAnimations(t,n-(t.index-e))}writeMdx(t){t.writeUint32(this.getByteLength()),super.writeMdx(t),t.skip(260-t.write(this.path)),t.writeInt32(this.attachmentId),this.writeNonGenericAnimationChunks(t)}readMdl(t){for(const e of super.readGenericBlock(t))if("AttachmentID"===e)this.attachmentId=t.readInt();else if("Path"===e)this.path=t.read();else{if("Visibility"!==e)throw new Error(`Unknown token in Attachment ${this.name}: "${e}"`);this.readAnimation(t,"KATV")}}writeMdl(t){t.startObjectBlock("Attachment",this.name),this.writeGenericHeader(t),t.writeNumberAttrib("AttachmentID",this.attachmentId),this.path.length&&t.writeStringAttrib("Path",this.path),this.writeAnimation(t,"KATV"),this.writeGenericAnimations(t),t.endBlock()}getByteLength(){return 268+super.getByteLength()}}class gl extends dl{constructor(){super(4096),this.emissionRate=0,this.gravity=0,this.longitude=0,this.latitude=0,this.path="",this.lifeSpan=0,this.speed=0}readMdx(t){const e=t.index,n=t.readUint32();super.readMdx(t),this.emissionRate=t.readFloat32(),this.gravity=t.readFloat32(),this.longitude=t.readFloat32(),this.latitude=t.readFloat32(),this.path=t.read(260),this.lifeSpan=t.readFloat32(),this.speed=t.readFloat32(),this.readAnimations(t,n-(t.index-e))}writeMdx(t){t.writeUint32(this.getByteLength()),super.writeMdx(t),t.writeFloat32(this.emissionRate),t.writeFloat32(this.gravity),t.writeFloat32(this.longitude),t.writeFloat32(this.latitude),t.skip(260-t.write(this.path)),t.writeFloat32(this.lifeSpan),t.writeFloat32(this.speed),this.writeNonGenericAnimationChunks(t)}readMdl(t){for(let e of super.readGenericBlock(t))if("EmitterUsesMDL"===e)this.flags|=32768;else if("EmitterUsesTGA"===e)this.flags|=65536;else if("static EmissionRate"===e)this.emissionRate=t.readFloat();else if("EmissionRate"===e)this.readAnimation(t,"KPEE");else if("static Gravity"===e)this.gravity=t.readFloat();else if("Gravity"===e)this.readAnimation(t,"KPEG");else if("static Longitude"===e)this.longitude=t.readFloat();else if("Longitude"===e)this.readAnimation(t,"KPLN");else if("static Latitude"===e)this.latitude=t.readFloat();else if("Latitude"===e)this.readAnimation(t,"KPLT");else if("Visibility"===e)this.readAnimation(t,"KPEV");else{if("Particle"!==e)throw new Error(`Unknown token in ParticleEmitter: "${e}"`);for(e of this.readAnimatedBlock(t))"static LifeSpan"===e?this.lifeSpan=t.readFloat():"LifeSpan"===e?this.readAnimation(t,"KPEL"):"static InitVelocity"===e?this.speed=t.readFloat():"InitVelocity"===e?this.readAnimation(t,"KPES"):"Path"===e&&(this.path=t.read())}}writeMdl(t){t.startObjectBlock("ParticleEmitter",this.name),this.writeGenericHeader(t),32768&this.flags&&t.writeFlag("EmitterUsesMDL"),65536&this.flags&&t.writeFlag("EmitterUsesTGA"),this.writeAnimation(t,"KPEE")||t.writeNumberAttrib("static EmissionRate",this.emissionRate),this.writeAnimation(t,"KPEG")||t.writeNumberAttrib("static Gravity",this.gravity),this.writeAnimation(t,"KPLN")||t.writeNumberAttrib("static Longitude",this.longitude),this.writeAnimation(t,"KPLT")||t.writeNumberAttrib("static Latitude",this.latitude),this.writeAnimation(t,"KPEV"),t.startBlock("Particle"),this.writeAnimation(t,"KPEL")||t.writeNumberAttrib("static LifeSpan",this.lifeSpan),this.writeAnimation(t,"KPES")||t.writeNumberAttrib("static InitVelocity",this.speed),(32768&this.flags||65536&this.flags)&&t.writeStringAttrib("Path",this.path),t.endBlock(),this.writeGenericAnimations(t),t.endBlock()}getByteLength(){return 288+super.getByteLength()}}class vl extends dl{constructor(){super(...arguments),this.speed=0,this.variation=0,this.latitude=0,this.gravity=0,this.lifeSpan=0,this.emissionRate=0,this.width=0,this.length=0,this.filterMode=0,this.rows=0,this.columns=0,this.headOrTail=0,this.tailLength=0,this.timeMiddle=0,this.segmentColors=[new Float32Array(3),new Float32Array(3),new Float32Array(3)],this.segmentAlphas=new Uint8Array(3),this.segmentScaling=new Float32Array(3),this.headIntervals=[new Uint32Array(3),new Uint32Array(3)],this.tailIntervals=[new Uint32Array(3),new Uint32Array(3)],this.textureId=-1,this.squirt=0,this.priorityPlane=0,this.replaceableId=0}readMdx(t){const e=t.index,n=t.readUint32();super.readMdx(t),this.speed=t.readFloat32(),this.variation=t.readFloat32(),this.latitude=t.readFloat32(),this.gravity=t.readFloat32(),this.lifeSpan=t.readFloat32(),this.emissionRate=t.readFloat32(),this.width=t.readFloat32(),this.length=t.readFloat32(),this.filterMode=t.readUint32(),this.rows=t.readUint32(),this.columns=t.readUint32(),this.headOrTail=t.readUint32(),this.tailLength=t.readFloat32(),this.timeMiddle=t.readFloat32(),t.readFloat32Array(this.segmentColors[0]),t.readFloat32Array(this.segmentColors[1]),t.readFloat32Array(this.segmentColors[2]),t.readUint8Array(this.segmentAlphas),t.readFloat32Array(this.segmentScaling),t.readUint32Array(this.headIntervals[0]),t.readUint32Array(this.headIntervals[1]),t.readUint32Array(this.tailIntervals[0]),t.readUint32Array(this.tailIntervals[1]),this.textureId=t.readInt32(),this.squirt=t.readUint32(),this.priorityPlane=t.readInt32(),this.replaceableId=t.readUint32(),this.readAnimations(t,n-(t.index-e))}writeMdx(t){t.writeUint32(this.getByteLength()),super.writeMdx(t),t.writeFloat32(this.speed),t.writeFloat32(this.variation),t.writeFloat32(this.latitude),t.writeFloat32(this.gravity),t.writeFloat32(this.lifeSpan),t.writeFloat32(this.emissionRate),t.writeFloat32(this.width),t.writeFloat32(this.length),t.writeUint32(this.filterMode),t.writeUint32(this.rows),t.writeUint32(this.columns),t.writeUint32(this.headOrTail),t.writeFloat32(this.tailLength),t.writeFloat32(this.timeMiddle),t.writeFloat32Array(this.segmentColors[0]),t.writeFloat32Array(this.segmentColors[1]),t.writeFloat32Array(this.segmentColors[2]),t.writeUint8Array(this.segmentAlphas),t.writeFloat32Array(this.segmentScaling),t.writeUint32Array(this.headIntervals[0]),t.writeUint32Array(this.headIntervals[1]),t.writeUint32Array(this.tailIntervals[0]),t.writeUint32Array(this.tailIntervals[1]),t.writeInt32(this.textureId),t.writeUint32(this.squirt),t.writeInt32(this.priorityPlane),t.writeUint32(this.replaceableId),this.writeNonGenericAnimationChunks(t)}readMdl(t){for(const e of super.readGenericBlock(t))if("SortPrimsFarZ"===e)this.flags|=65536;else if("Unshaded"===e)this.flags|=32768;else if("LineEmitter"===e)this.flags|=131072;else if("Unfogged"===e)this.flags|=262144;else if("ModelSpace"===e)this.flags|=524288;else if("XYQuad"===e)this.flags|=1048576;else if("static Speed"===e)this.speed=t.readFloat();else if("Speed"===e)this.readAnimation(t,"KP2S");else if("static Variation"===e)this.variation=t.readFloat();else if("Variation"===e)this.readAnimation(t,"KP2R");else if("static Latitude"===e)this.latitude=t.readFloat();else if("Latitude"===e)this.readAnimation(t,"KP2L");else if("static Gravity"===e)this.gravity=t.readFloat();else if("Gravity"===e)this.readAnimation(t,"KP2G");else if("Visibility"===e)this.readAnimation(t,"KP2V");else if("Squirt"===e)this.squirt=1;else if("LifeSpan"===e)this.lifeSpan=t.readFloat();else if("static EmissionRate"===e)this.emissionRate=t.readFloat();else if("EmissionRate"===e)this.readAnimation(t,"KP2E");else if("static Width"===e)this.width=t.readFloat();else if("Width"===e)this.readAnimation(t,"KP2N");else if("static Length"===e)this.length=t.readFloat();else if("Length"===e)this.readAnimation(t,"KP2W");else if("Blend"===e)this.filterMode=0;else if("Additive"===e)this.filterMode=1;else if("Modulate"===e)this.filterMode=2;else if("Modulate2x"===e)this.filterMode=3;else if("AlphaKey"===e)this.filterMode=4;else if("Rows"===e)this.rows=t.readInt();else if("Columns"===e)this.columns=t.readInt();else if("Head"===e)this.headOrTail=0;else if("Tail"===e)this.headOrTail=1;else if("Both"===e)this.headOrTail=2;else if("TailLength"===e)this.tailLength=t.readFloat();else if("Time"===e)this.timeMiddle=t.readFloat();else if("SegmentColor"===e){t.read();for(let e=0;e<3;e++)t.read(),t.readColor(this.segmentColors[e]);t.read()}else if("Alpha"===e)t.readVector(this.segmentAlphas);else if("ParticleScaling"===e)t.readVector(this.segmentScaling);else if("LifeSpanUVAnim"===e)t.readVector(this.headIntervals[0]);else if("DecayUVAnim"===e)t.readVector(this.headIntervals[1]);else if("TailUVAnim"===e)t.readVector(this.tailIntervals[0]);else if("TailDecayUVAnim"===e)t.readVector(this.tailIntervals[1]);else if("TextureID"===e)this.textureId=t.readInt();else if("ReplaceableId"===e)this.replaceableId=t.readInt();else{if("PriorityPlane"!==e)throw new Error(`Unknown token in ParticleEmitter2: "${e}"`);this.priorityPlane=t.readInt()}}writeMdl(t){t.startObjectBlock("ParticleEmitter2",this.name),this.writeGenericHeader(t),65536&this.flags&&t.writeFlag("SortPrimsFarZ"),32768&this.flags&&t.writeFlag("Unshaded"),131072&this.flags&&t.writeFlag("LineEmitter"),262144&this.flags&&t.writeFlag("Unfogged"),524288&this.flags&&t.writeFlag("ModelSpace"),1048576&this.flags&&t.writeFlag("XYQuad"),this.writeAnimation(t,"KP2S")||t.writeNumberAttrib("static Speed",this.speed),this.writeAnimation(t,"KP2R")||t.writeNumberAttrib("static Variation",this.variation),this.writeAnimation(t,"KP2L")||t.writeNumberAttrib("static Latitude",this.latitude),this.writeAnimation(t,"KP2G")||t.writeNumberAttrib("static Gravity",this.gravity),this.writeAnimation(t,"KP2V"),this.squirt&&t.writeFlag("Squirt"),t.writeNumberAttrib("LifeSpan",this.lifeSpan),this.writeAnimation(t,"KP2E")||t.writeNumberAttrib("static EmissionRate",this.emissionRate),this.writeAnimation(t,"KP2N")||t.writeNumberAttrib("static Width",this.width),this.writeAnimation(t,"KP2W")||t.writeNumberAttrib("static Length",this.length),0===this.filterMode?t.writeFlag("Blend"):1===this.filterMode?t.writeFlag("Additive"):2===this.filterMode?t.writeFlag("Modulate"):3===this.filterMode?t.writeFlag("Modulate2x"):4===this.filterMode&&t.writeFlag("AlphaKey"),t.writeNumberAttrib("Rows",this.rows),t.writeNumberAttrib("Columns",this.columns),0===this.headOrTail?t.writeFlag("Head"):1===this.headOrTail?t.writeFlag("Tail"):2===this.headOrTail&&t.writeFlag("Both"),t.writeNumberAttrib("TailLength",this.tailLength),t.writeNumberAttrib("Time",this.timeMiddle),t.startBlock("SegmentColor"),t.writeColor("Color",this.segmentColors[0]),t.writeColor("Color",this.segmentColors[1]),t.writeColor("Color",this.segmentColors[2]),t.endBlockComma(),t.writeVectorAttrib("Alpha",this.segmentAlphas),t.writeVectorAttrib("ParticleScaling",this.segmentScaling),t.writeVectorAttrib("LifeSpanUVAnim",this.headIntervals[0]),t.writeVectorAttrib("DecayUVAnim",this.headIntervals[1]),t.writeVectorAttrib("TailUVAnim",this.tailIntervals[0]),t.writeVectorAttrib("TailDecayUVAnim",this.tailIntervals[1]),t.writeNumberAttrib("TextureID",this.textureId),0!==this.replaceableId&&t.writeNumberAttrib("ReplaceableId",this.replaceableId),0!==this.priorityPlane&&t.writeNumberAttrib("PriorityPlane",this.priorityPlane),this.writeGenericAnimations(t),t.endBlock()}getByteLength(){return 175+super.getByteLength()}}class bl extends dl{constructor(){super(...arguments),this.lifeSpan=0,this.emissionRate=0,this.speed=0,this.color=new Float32Array(3),this.alpha=1,this.replaceableId=0,this.path="",this.animationVisiblityGuide=""}readMdx(t){const e=t.index,n=t.readUint32();super.readMdx(t),this.lifeSpan=t.readFloat32(),this.emissionRate=t.readFloat32(),this.speed=t.readFloat32(),t.readFloat32Array(this.color),this.alpha=t.readFloat32(),this.replaceableId=t.readUint32(),this.path=t.read(260),this.animationVisiblityGuide=t.read(260),this.readAnimations(t,n-(t.index-e))}writeMdx(t){t.writeUint32(this.getByteLength()),super.writeMdx(t),t.writeFloat32(this.lifeSpan),t.writeFloat32(this.emissionRate),t.writeFloat32(this.speed),t.writeFloat32Array(this.color),t.writeFloat32(this.alpha),t.writeUint32(this.replaceableId),t.skip(260-t.write(this.path)),t.skip(260-t.write(this.animationVisiblityGuide)),this.writeNonGenericAnimationChunks(t)}readMdl(t){for(const e of super.readGenericBlock(t))if("SortPrimsFarZ"===e)this.flags|=65536;else if("Unshaded"===e)this.flags|=32768;else if("Unfogged"===e)this.flags|=262144;else if("static LifeSpan"===e)this.lifeSpan=t.readFloat();else if("LifeSpan"===e)this.readAnimation(t,"KPPL");else if("static EmissionRate"===e)this.emissionRate=t.readFloat();else if("EmissionRate"===e)this.readAnimation(t,"KPPE");else if("static Speed"===e)this.speed=t.readFloat();else if("Speed"===e)this.readAnimation(t,"KPPS");else if("static Color"===e)t.readVector(this.color);else if("Color"===e)this.readAnimation(t,"KPPC");else if("static Alpha"===e)this.alpha=t.readFloat();else if("Alpha"===e)this.readAnimation(t,"KPPA");else if("Visibility"===e)this.readAnimation(t,"KPPV");else if("ReplaceableId"===e)this.replaceableId=t.readInt();else if("Path"===e)this.path=t.read();else{if("AnimVisibilityGuide"!==e)throw new Error(`Unknown token in ParticleEmitterPopcorn: "${e}"`);this.animationVisiblityGuide=t.read()}}writeMdl(t){t.startObjectBlock("ParticleEmitterPopcorn",this.name),this.writeGenericHeader(t),65536&this.flags&&t.writeFlag("SortPrimsFarZ"),32768&this.flags&&t.writeFlag("Unshaded"),262144&this.flags&&t.writeFlag("Unfogged"),this.writeAnimation(t,"KPPL")||t.writeNumberAttrib("static LifeSpan",this.lifeSpan),this.writeAnimation(t,"KPPE")||t.writeNumberAttrib("static EmissionRate",this.emissionRate),this.writeAnimation(t,"KPPS")||t.writeNumberAttrib("static Speed",this.speed),this.writeAnimation(t,"KPPC")||t.writeVectorAttrib("static Color",this.color),this.writeAnimation(t,"KPPA")||t.writeNumberAttrib("static Alpha",this.alpha),this.writeAnimation(t,"KPPV"),0!==this.replaceableId&&t.writeNumberAttrib("ReplaceableId",this.replaceableId),this.path.length&&t.writeStringAttrib("Path",this.path),this.animationVisiblityGuide.length&&t.writeStringAttrib("AnimVisibilityGuide",this.animationVisiblityGuide),this.writeGenericAnimations(t),t.endBlock()}getByteLength(){return 556+super.getByteLength()}}class wl extends dl{constructor(){super(16384),this.heightAbove=0,this.heightBelow=0,this.alpha=0,this.color=new Float32Array(3),this.lifeSpan=0,this.textureSlot=0,this.emissionRate=0,this.rows=0,this.columns=0,this.materialId=0,this.gravity=0}readMdx(t){const e=t.index,n=t.readUint32();super.readMdx(t),this.heightAbove=t.readFloat32(),this.heightBelow=t.readFloat32(),this.alpha=t.readFloat32(),t.readFloat32Array(this.color),this.lifeSpan=t.readFloat32(),this.textureSlot=t.readUint32(),this.emissionRate=t.readUint32(),this.rows=t.readUint32(),this.columns=t.readUint32(),this.materialId=t.readInt32(),this.gravity=t.readFloat32(),this.readAnimations(t,n-(t.index-e))}writeMdx(t){t.writeUint32(this.getByteLength()),super.writeMdx(t),t.writeFloat32(this.heightAbove),t.writeFloat32(this.heightBelow),t.writeFloat32(this.alpha),t.writeFloat32Array(this.color),t.writeFloat32(this.lifeSpan),t.writeUint32(this.textureSlot),t.writeUint32(this.emissionRate),t.writeUint32(this.rows),t.writeUint32(this.columns),t.writeInt32(this.materialId),t.writeFloat32(this.gravity),this.writeNonGenericAnimationChunks(t)}readMdl(t){for(const e of super.readGenericBlock(t))if("static HeightAbove"===e)this.heightAbove=t.readFloat();else if("HeightAbove"===e)this.readAnimation(t,"KRHA");else if("static HeightBelow"===e)this.heightBelow=t.readFloat();else if("HeightBelow"===e)this.readAnimation(t,"KRHB");else if("static Alpha"===e)this.alpha=t.readFloat();else if("Alpha"===e)this.readAnimation(t,"KRAL");else if("static Color"===e)t.readColor(this.color);else if("Color"===e)this.readAnimation(t,"KRCO");else if("static TextureSlot"===e)this.textureSlot=t.readInt();else if("TextureSlot"===e)this.readAnimation(t,"KRTX");else if("Visibility"===e)this.readAnimation(t,"KRVS");else if("EmissionRate"===e)this.emissionRate=t.readInt();else if("LifeSpan"===e)this.lifeSpan=t.readFloat();else if("Gravity"===e)this.gravity=t.readFloat();else if("Rows"===e)this.rows=t.readInt();else if("Columns"===e)this.columns=t.readInt();else{if("MaterialID"!==e)throw new Error(`Unknown token in RibbonEmitter: "${e}"`);this.materialId=t.readInt()}}writeMdl(t){t.startObjectBlock("RibbonEmitter",this.name),this.writeGenericHeader(t),this.writeAnimation(t,"KRHA")||t.writeNumberAttrib("static HeightAbove",this.heightAbove),this.writeAnimation(t,"KRHB")||t.writeNumberAttrib("static HeightBelow",this.heightBelow),this.writeAnimation(t,"KRAL")||t.writeNumberAttrib("static Alpha",this.alpha),this.writeAnimation(t,"KRCO")||t.writeColor("static Color",this.color),this.writeAnimation(t,"KRTX")||t.writeNumberAttrib("static TextureSlot",this.textureSlot),this.writeAnimation(t,"KRVS"),t.writeNumberAttrib("EmissionRate",this.emissionRate),t.writeNumberAttrib("LifeSpan",this.lifeSpan),0!==this.gravity&&t.writeNumberAttrib("Gravity",this.gravity),t.writeNumberAttrib("Rows",this.rows),t.writeNumberAttrib("Columns",this.columns),t.writeNumberAttrib("MaterialID",this.materialId),this.writeGenericAnimations(t),t.endBlock()}getByteLength(){return 56+super.getByteLength()}}class Al extends rl{constructor(){super(...arguments),this.name="",this.position=new Float32Array(3),this.fieldOfView=0,this.farClippingPlane=0,this.nearClippingPlane=0,this.targetPosition=new Float32Array(3)}readMdx(t){const e=t.readUint32();this.name=t.read(80),t.readFloat32Array(this.position),this.fieldOfView=t.readFloat32(),this.farClippingPlane=t.readFloat32(),this.nearClippingPlane=t.readFloat32(),t.readFloat32Array(this.targetPosition),this.readAnimations(t,e-120)}writeMdx(t){t.writeUint32(this.getByteLength()),t.skip(80-t.write(this.name)),t.writeFloat32Array(this.position),t.writeFloat32(this.fieldOfView),t.writeFloat32(this.farClippingPlane),t.writeFloat32(this.nearClippingPlane),t.writeFloat32Array(this.targetPosition),this.writeAnimations(t)}readMdl(t){this.name=t.read();for(let e of t.readBlock())if("Position"===e)t.readVector(this.position);else if("Translation"===e)this.readAnimation(t,"KCTR");else if("Rotation"===e)this.readAnimation(t,"KCRL");else if("FieldOfView"===e)this.fieldOfView=t.readFloat();else if("FarClip"===e)this.farClippingPlane=t.readFloat();else if("NearClip"===e)this.nearClippingPlane=t.readFloat();else{if("Target"!==e)throw new Error(`Unknown token in Camera ${this.name}: "${e}"`);for(e of t.readBlock())if("Position"===e)t.readVector(this.targetPosition);else{if("Translation"!==e)throw new Error(`Unknown token in Camera ${this.name}'s Target: "${e}"`);this.readAnimation(t,"KTTR")}}}writeMdl(t){t.startObjectBlock("Camera",this.name),t.writeVectorAttrib("Position",this.position),this.writeAnimation(t,"KCTR"),this.writeAnimation(t,"KCRL"),t.writeNumberAttrib("FieldOfView",this.fieldOfView),t.writeNumberAttrib("FarClip",this.farClippingPlane),t.writeNumberAttrib("NearClip",this.nearClippingPlane),t.startBlock("Target"),t.writeVectorAttrib("Position",this.targetPosition),this.writeAnimation(t,"KTTR"),t.endBlock(),t.endBlock()}getByteLength(){return 120+super.getByteLength()}}class yl extends dl{constructor(){super(1024),this.globalSequenceId=-1,this.tracks=new Uint32Array(0)}readMdx(t){super.readMdx(t),t.skip(4);const e=t.readUint32();this.globalSequenceId=t.readInt32(),this.tracks=t.readUint32Array(e)}writeMdx(t){super.writeMdx(t),t.writeBinary("KEVT"),t.writeUint32(this.tracks.length),t.writeInt32(this.globalSequenceId),t.writeUint32Array(this.tracks)}readMdl(t){for(const e of super.readGenericBlock(t)){if("EventTrack"!==e)throw new Error(`Unknown token in EventObject: "${e}"`);{const e=t.readInt();this.tracks=new Uint32Array(e),t.read(),"GlobalSeqId"===t.peek()&&(t.read(),this.globalSequenceId=t.readInt());for(let n=0;n<e;n++)this.tracks[n]=t.readInt();t.read()}}}writeMdl(t){t.startObjectBlock("EventObject",this.name),this.writeGenericHeader(t),t.startBlock("EventTrack",this.tracks.length),-1!==this.globalSequenceId&&t.writeNumberAttrib("GlobalSeqId",this.globalSequenceId);for(const e of this.tracks)t.writeFlag(`${e}`);t.endBlock(),this.writeGenericAnimations(t),t.endBlock()}getByteLength(){return 12+this.tracks.byteLength+super.getByteLength()}}class xl extends dl{constructor(){super(8192),this.type=0,this.vertices=[new Float32Array(3),new Float32Array(3)],this.boundsRadius=0}readMdx(t){super.readMdx(t),this.type=t.readUint32(),t.readFloat32Array(this.vertices[0]),2!==this.type&&t.readFloat32Array(this.vertices[1]),2!==this.type&&3!==this.type||(this.boundsRadius=t.readFloat32())}writeMdx(t){super.writeMdx(t),t.writeUint32(this.type),t.writeFloat32Array(this.vertices[0]),2!==this.type&&t.writeFloat32Array(this.vertices[1]),2!==this.type&&3!==this.type||t.writeFloat32(this.boundsRadius)}readMdl(t){for(const e of super.readGenericBlock(t))if("Box"===e)this.type=0;else if("Plane"===e)this.type=1;else if("Sphere"===e)this.type=2;else if("Cylinder"===e)this.type=3;else if("Vertices"===e){const e=t.readInt();t.read(),t.readVector(this.vertices[0]),2===e&&t.readVector(this.vertices[1]),t.read()}else{if("BoundsRadius"!==e)throw new Error(`Unknown token in CollisionShape: "${e}"`);this.boundsRadius=t.readFloat()}}writeMdl(t){t.startObjectBlock("CollisionShape",this.name),this.writeGenericHeader(t);let e="",n=2,i=!1;0===this.type?e="Box":1===this.type?e="Plane":2===this.type?(e="Sphere",n=1,i=!0):3===this.type&&(e="Cylinder",i=!0),t.writeFlag(e),t.startBlock("Vertices",n),t.writeVector(this.vertices[0]),2===n&&t.writeVector(this.vertices[1]),t.endBlock(),i&&t.writeNumberAttrib("BoundsRadius",this.boundsRadius),this.writeGenericAnimations(t),t.endBlock()}getByteLength(){let t=16+super.getByteLength();return 2!==this.type&&(t+=12),2!==this.type&&3!==this.type||(t+=4),t}}class Tl{constructor(){this.type="",this.path=""}readMdx(t){this.type=t.read(80),this.path=t.read(260)}writeMdx(t){t.skip(80-t.write(this.type)),t.skip(260-t.write(this.path))}readMdl(t){this.type=t.read();for(const e of t.readBlock()){if("Path"!==e)throw new Error(`Unknown token in FaceEffect: "${e}"`);this.path=t.read()}}writeMdl(t){t.startObjectBlock("FaceFX",this.type),t.writeStringAttrib("Path",this.path),t.endBlock()}}class Ll{constructor(t,e,n){this.tag=n,this.chunk=t.readUint8Array(new Uint8Array(e))}writeMdx(t){t.writeBinary(this.tag),t.writeUint32(this.chunk.byteLength),t.writeUint8Array(this.chunk)}getByteLength(){return 8+this.chunk.byteLength}}function El(t){return t instanceof ArrayBuffer&&(t=new Uint8Array(t)),t instanceof Uint8Array&&77===t[0]&&68===t[1]&&76===t[2]&&88===t[3]||!("string"!=typeof t||!t.startsWith("MDLX"))}function Sl(t){return t instanceof ArrayBuffer&&(t=new Uint8Array(t)),!!(t instanceof Uint8Array&&Ha(t,"FormatVersion",0,4096))||!("string"!=typeof t||!function(t,e,n=0,i=1/0){const r=Math.max(n,0),s=Math.min(r+i,t.length);let a=0,o=e[0];for(let n=r;n<s;n++)if(t[n]===o){if(a+=1,a===e.length)return!0;o=e[a]}else a>0&&(a=0,o=e[0]);return!1}(t,"FormatVersion",0,4096))}class Ml{constructor(){this.version=800,this.name="",this.animationFile="",this.extent=new Wo,this.blendTime=0,this.sequences=[],this.globalSequences=[],this.materials=[],this.textures=[],this.textureAnimations=[],this.geosets=[],this.geosetAnimations=[],this.bones=[],this.lights=[],this.helpers=[],this.attachments=[],this.pivotPoints=[],this.particleEmitters=[],this.particleEmitters2=[],this.particleEmittersPopcorn=[],this.ribbonEmitters=[],this.cameras=[],this.eventObjects=[],this.collisionShapes=[],this.faceEffects=[],this.bindPose=[],this.unknownChunks=[]}load(t){if(El(t))"string"==typeof t&&(t=Ka(t)),this.loadMdx(t);else{if(!Sl(t))throw new Error("Not a valid MDX/MDL buffer");"string"!=typeof t&&(t=Ga(t)),this.loadMdl(t)}}loadMdx(t){const e=new bo(t);let n,i;for(e.skip(4);e.remaining>0;)n=e.readBinary(4),i=e.readUint32(),"VERS"===n?this.loadVersionChunk(e):"MODL"===n?this.loadModelChunk(e):"SEQS"===n?this.loadStaticObjects(this.sequences,Zo,e,i/132):"GLBS"===n?this.loadGlobalSequenceChunk(e,i):"MTLS"===n?this.loadDynamicObjects(this.materials,ol,e,i):"TEXS"===n?this.loadStaticObjects(this.textures,ll,e,i/268):"TXAN"===n?this.loadDynamicObjects(this.textureAnimations,hl,e,i):"GEOS"===n?this.loadDynamicObjects(this.geosets,ul,e,i):"GEOA"===n?this.loadDynamicObjects(this.geosetAnimations,cl,e,i):"BONE"===n?this.loadDynamicObjects(this.bones,fl,e,i):"LITE"===n?this.loadDynamicObjects(this.lights,pl,e,i):"HELP"===n?this.loadDynamicObjects(this.helpers,ml,e,i):"ATCH"===n?this.loadDynamicObjects(this.attachments,_l,e,i):"PIVT"===n?this.loadPivotPointChunk(e,i):"PREM"===n?this.loadDynamicObjects(this.particleEmitters,gl,e,i):"PRE2"===n?this.loadDynamicObjects(this.particleEmitters2,vl,e,i):"CORN"===n?this.loadDynamicObjects(this.particleEmittersPopcorn,bl,e,i):"RIBB"===n?this.loadDynamicObjects(this.ribbonEmitters,wl,e,i):"CAMS"===n?this.loadDynamicObjects(this.cameras,Al,e,i):"EVTS"===n?this.loadDynamicObjects(this.eventObjects,yl,e,i):"CLID"===n?this.loadDynamicObjects(this.collisionShapes,xl,e,i):"FAFX"===n?this.loadStaticObjects(this.faceEffects,Tl,e,i/340):"BPOS"===n?this.loadBindPoseChunk(e,i):this.unknownChunks.push(new Ll(e,i,n))}loadVersionChunk(t){this.version=t.readUint32()}loadModelChunk(t){this.name=t.read(80),this.animationFile=t.read(260),this.extent.readMdx(t),this.blendTime=t.readUint32()}loadStaticObjects(t,e,n,i){for(let r=0;r<i;r++){const i=new e;i.readMdx(n),t.push(i)}}loadGlobalSequenceChunk(t,e){for(let n=0,i=e/4;n<i;n++)this.globalSequences.push(t.readUint32())}loadDynamicObjects(t,e,n,i){const r=n.index+i;for(;n.index<r;){const i=new e;i.readMdx(n,this.version),t.push(i)}}loadPivotPointChunk(t,e){for(let n=0,i=e/12;n<i;n++)this.pivotPoints.push(t.readFloat32Array(3))}loadBindPoseChunk(t,e){for(let e=0,n=t.readUint32();e<n;e++)this.bindPose[e]=t.readFloat32Array(12)}saveMdx(){const t=new bo(new ArrayBuffer(this.getByteLength()));t.writeBinary("MDLX"),this.saveVersionChunk(t),this.saveModelChunk(t),this.saveStaticObjectChunk(t,"SEQS",this.sequences,132),this.saveGlobalSequenceChunk(t),this.saveDynamicObjectChunk(t,"MTLS",this.materials),this.saveStaticObjectChunk(t,"TEXS",this.textures,268),this.saveDynamicObjectChunk(t,"TXAN",this.textureAnimations),this.saveDynamicObjectChunk(t,"GEOS",this.geosets),this.saveDynamicObjectChunk(t,"GEOA",this.geosetAnimations),this.saveDynamicObjectChunk(t,"BONE",this.bones),this.saveDynamicObjectChunk(t,"LITE",this.lights),this.saveDynamicObjectChunk(t,"HELP",this.helpers),this.saveDynamicObjectChunk(t,"ATCH",this.attachments),this.savePivotPointChunk(t),this.saveDynamicObjectChunk(t,"PREM",this.particleEmitters),this.saveDynamicObjectChunk(t,"PRE2",this.particleEmitters2),this.version>800&&this.saveDynamicObjectChunk(t,"CORN",this.particleEmittersPopcorn),this.saveDynamicObjectChunk(t,"RIBB",this.ribbonEmitters),this.saveDynamicObjectChunk(t,"CAMS",this.cameras),this.saveDynamicObjectChunk(t,"EVTS",this.eventObjects),this.saveDynamicObjectChunk(t,"CLID",this.collisionShapes),this.version>800&&(this.saveStaticObjectChunk(t,"FAFX",this.faceEffects,340),this.saveBindPoseChunk(t));for(const e of this.unknownChunks)e.writeMdx(t);return t.uint8array}saveVersionChunk(t){t.writeBinary("VERS"),t.writeUint32(4),t.writeUint32(this.version)}saveModelChunk(t){t.writeBinary("MODL"),t.writeUint32(372),t.skip(80-t.write(this.name)),t.skip(260-t.write(this.animationFile)),this.extent.writeMdx(t),t.writeUint32(this.blendTime)}saveStaticObjectChunk(t,e,n,i){if(n.length){t.writeBinary(e),t.writeUint32(n.length*i);for(const e of n)e.writeMdx(t)}}saveGlobalSequenceChunk(t){if(this.globalSequences.length){t.writeBinary("GLBS"),t.writeUint32(4*this.globalSequences.length);for(const e of this.globalSequences)t.writeUint32(e)}}saveDynamicObjectChunk(t,e,n){if(n.length){t.writeBinary(e),t.writeUint32(this.getObjectsByteLength(n));for(const e of n)e.writeMdx(t,this.version)}}savePivotPointChunk(t){if(this.pivotPoints.length){t.writeBinary("PIVT"),t.writeUint32(12*this.pivotPoints.length);for(const e of this.pivotPoints)t.writeFloat32Array(e)}}saveBindPoseChunk(t){if(this.bindPose.length){t.writeBinary("BPOS"),t.writeUint32(4+48*this.bindPose.length),t.writeUint32(this.bindPose.length);for(const e of this.bindPose)t.writeFloat32Array(e)}}loadMdl(t){let e;const n=new $o(t);for(;e=n.readToken();)if("Version"===e)this.loadVersionBlock(n);else if("Model"===e)this.loadModelBlock(n);else if("Sequences"===e)this.loadNumberedObjectBlock(this.sequences,Zo,"Anim",n);else if("GlobalSequences"===e)this.loadGlobalSequenceBlock(n);else if("Textures"===e)this.loadNumberedObjectBlock(this.textures,ll,"Bitmap",n);else if("Materials"===e)this.loadNumberedObjectBlock(this.materials,ol,"Material",n);else if("TextureAnims"===e)this.loadNumberedObjectBlock(this.textureAnimations,hl,"TVertexAnim",n);else if("Geoset"===e)this.loadObject(this.geosets,ul,n);else if("GeosetAnim"===e)this.loadObject(this.geosetAnimations,cl,n);else if("Bone"===e)this.loadObject(this.bones,fl,n);else if("Light"===e)this.loadObject(this.lights,pl,n);else if("Helper"===e)this.loadObject(this.helpers,ml,n);else if("Attachment"===e)this.loadObject(this.attachments,_l,n);else if("PivotPoints"===e)this.loadPivotPointBlock(n);else if("ParticleEmitter"===e)this.loadObject(this.particleEmitters,gl,n);else if("ParticleEmitter2"===e)this.loadObject(this.particleEmitters2,vl,n);else if("ParticleEmitterPopcorn"===e)this.loadObject(this.particleEmittersPopcorn,bl,n);else if("RibbonEmitter"===e)this.loadObject(this.ribbonEmitters,wl,n);else if("Camera"===e)this.loadObject(this.cameras,Al,n);else if("EventObject"===e)this.loadObject(this.eventObjects,yl,n);else if("CollisionShape"===e)this.loadObject(this.collisionShapes,xl,n);else if("FaceFX"===e)this.loadObject(this.faceEffects,Tl,n);else{if("BindPose"!==e)throw new Error(`Unsupported block: ${e}`);this.loadBindPoseBlock(n)}}loadVersionBlock(t){for(const e of t.readBlock()){if("FormatVersion"!==e)throw new Error(`Unknown token in Version: "${e}"`);this.version=t.readInt()}}loadModelBlock(t){this.name=t.read();for(const e of t.readBlock())if(e.startsWith("Num"))t.read();else if("BlendTime"===e)this.blendTime=t.readInt();else if("MinimumExtent"===e)t.readVector(this.extent.min);else if("MaximumExtent"===e)t.readVector(this.extent.max);else if("BoundsRadius"===e)this.extent.boundsRadius=t.readFloat();else{if("AnimationFile"!==e)throw new Error(`Unknown token in Model: "${e}"`);this.animationFile=t.read()}}loadNumberedObjectBlock(t,e,n,i){i.read();for(const r of i.readBlock()){if(r!==n)throw new Error(`Unknown token in ${n}: "${r}"`);{const n=new e;n.readMdl(i),t.push(n)}}}loadGlobalSequenceBlock(t){t.read();for(const e of t.readBlock()){if("Duration"!==e)throw new Error(`Unknown token in GlobalSequences: "${e}"`);this.globalSequences.push(t.readInt())}}loadObject(t,e,n){const i=new e;i.readMdl(n),t.push(i)}loadPivotPointBlock(t){const e=t.readInt();t.read();for(let n=0;n<e;n++)this.pivotPoints.push(t.readVector(new Float32Array(3)));t.read()}loadBindPoseBlock(t){for(const e of t.readBlock()){if("Matrices"!==e)throw new Error(`Unknown token in BindPose: "${e}"`);{const e=t.readInt();t.read();for(let n=0;n<e;n++)this.bindPose[n]=t.readVector(new Float32Array(12));t.read()}}}saveMdl(){const t=new $o;return this.saveVersionBlock(t),this.saveModelBlock(t),this.saveStaticObjectsBlock(t,"Sequences",this.sequences),this.saveGlobalSequenceBlock(t),this.saveStaticObjectsBlock(t,"Textures",this.textures),this.saveStaticObjectsBlock(t,"Materials",this.materials),this.saveStaticObjectsBlock(t,"TextureAnims",this.textureAnimations),this.saveObjects(t,this.geosets),this.saveObjects(t,this.geosetAnimations),this.saveObjects(t,this.bones),this.saveObjects(t,this.lights),this.saveObjects(t,this.helpers),this.saveObjects(t,this.attachments),this.savePivotPointBlock(t),this.saveObjects(t,this.particleEmitters),this.saveObjects(t,this.particleEmitters2),this.version>800&&this.saveObjects(t,this.particleEmittersPopcorn),this.saveObjects(t,this.ribbonEmitters),this.saveObjects(t,this.cameras),this.saveObjects(t,this.eventObjects),this.saveObjects(t,this.collisionShapes),this.version>800&&(this.saveObjects(t,this.faceEffects),this.saveBindPoseBlock(t)),t.buffer}saveVersionBlock(t){t.startBlock("Version"),t.writeNumberAttrib("FormatVersion",this.version),t.endBlock()}saveModelBlock(t){t.startObjectBlock("Model",this.name),t.writeNumberAttrib("BlendTime",this.blendTime),this.extent.writeMdl(t),this.animationFile.length&&t.writeStringAttrib("AnimationFile",this.animationFile),t.endBlock()}saveStaticObjectsBlock(t,e,n){if(n.length){t.startBlock(e,n.length);for(const e of n)e.writeMdl(t,this.version);t.endBlock()}}saveGlobalSequenceBlock(t){if(this.globalSequences.length){t.startBlock("GlobalSequences",this.globalSequences.length);for(const e of this.globalSequences)t.writeNumberAttrib("Duration",e);t.endBlock()}}saveObjects(t,e){for(const n of e)n.writeMdl(t,this.version)}savePivotPointBlock(t){if(this.pivotPoints.length){t.startBlock("PivotPoints",this.pivotPoints.length);for(const e of this.pivotPoints)t.writeVector(e);t.endBlock()}}saveBindPoseBlock(t){if(this.bindPose.length){t.startBlock("BindPose"),t.startBlock("Matrices",this.bindPose.length);for(const e of this.bindPose)t.writeVector(e);t.endBlock(),t.endBlock()}}getByteLength(){let t=396;return t+=this.getStaticObjectsChunkByteLength(this.sequences,132),t+=this.getStaticObjectsChunkByteLength(this.globalSequences,4),t+=this.getDynamicObjectsChunkByteLength(this.materials),t+=this.getStaticObjectsChunkByteLength(this.textures,268),t+=this.getDynamicObjectsChunkByteLength(this.textureAnimations),t+=this.getDynamicObjectsChunkByteLength(this.geosets),t+=this.getDynamicObjectsChunkByteLength(this.geosetAnimations),t+=this.getDynamicObjectsChunkByteLength(this.bones),t+=this.getDynamicObjectsChunkByteLength(this.lights),t+=this.getDynamicObjectsChunkByteLength(this.helpers),t+=this.getDynamicObjectsChunkByteLength(this.attachments),t+=this.getStaticObjectsChunkByteLength(this.pivotPoints,12),t+=this.getDynamicObjectsChunkByteLength(this.particleEmitters),t+=this.getDynamicObjectsChunkByteLength(this.particleEmitters2),this.version>800&&(t+=this.getDynamicObjectsChunkByteLength(this.particleEmittersPopcorn)),t+=this.getDynamicObjectsChunkByteLength(this.ribbonEmitters),t+=this.getDynamicObjectsChunkByteLength(this.cameras),t+=this.getDynamicObjectsChunkByteLength(this.eventObjects),t+=this.getDynamicObjectsChunkByteLength(this.collisionShapes),this.version>800&&(t+=this.getStaticObjectsChunkByteLength(this.faceEffects,340),t+=this.getBindPoseChunkByteLength()),t+=this.getObjectsByteLength(this.unknownChunks),t}getObjectsByteLength(t){let e=0;for(const n of t)e+=n.getByteLength(this.version);return e}getDynamicObjectsChunkByteLength(t){return t.length?8+this.getObjectsByteLength(t):0}getStaticObjectsChunkByteLength(t,e){return t.length?8+t.length*e:0}getBindPoseChunkByteLength(){return this.bindPose.length?12+48*this.bindPose.length:0}}class kl{constructor(){this.offset=0,this.compressedSize=0,this.normalSize=0,this.flags=0}load(t){this.offset=t[0],this.compressedSize=t[1],this.normalSize=t[2],this.flags=t[3]}save(t){t[0]=this.offset,t[1]=this.compressedSize,t[2]=this.normalSize,t[3]=this.flags}}const Rl=3283040112,Il=4294967294,Ul=4294967295,Ol=3968054179,Cl=65536,Bl=131072,Pl=16777216,Nl=2147483648;class Dl{constructor(t){this.c=t,this.entries=[]}add(t){const e=new kl;return e.normalSize=t.byteLength,this.entries.push(e),e}clear(){this.entries.length=0}addEmpties(t){for(let e=0;e<t;e++)this.entries.push(new kl)}load(t){const e=t.byteLength/16,n=new Uint32Array(this.c.decryptBlock(t,Ol).buffer);let i=0;this.clear(),this.addEmpties(e);for(const t of this.entries)t.load(n.subarray(i,i+4)),i+=4}save(t){const e=new Uint32Array(4*this.entries.length);let n=0;for(const t of this.entries)t.save(e.subarray(n,n+4)),n+=4;const i=new Uint8Array(e.buffer);this.c.encryptBlock(i,Ol),t.set(i)}}const Fl=new Uint8Array(4),Vl=new Uint32Array(Fl.buffer);class Gl{constructor(){this.cryptTable=new Uint32Array(1280);let t=1048577,e=0,n=0;for(let i=0;i<256;i++)for(let r=i,s=0;s<5;s+=1,r+=256)t=(125*t+3)%2796203,e=(65535&t)<<16,t=(125*t+3)%2796203,n=65535&t,this.cryptTable[r]=e|n}hash(t,e){const n=this.cryptTable;let i=2146271213,r=4008636142;t=t.toUpperCase();for(let s=0;s<t.length;s++){const a=t.charCodeAt(s);i=n[(e<<8)+a]^i+r,r=a+i+r+(r<<5)+3}return i>>>0}decryptBlock(t,e){const n=this.cryptTable;let i=4008636142;const r=new Uint8Array(t.buffer,t.byteOffset,t.byteLength);for(let s=0,a=t.byteLength>>>2;s<a;s++)i+=n[1024+(255&e)],Fl[0]=r[4*s],Fl[1]=r[4*s+1],Fl[2]=r[4*s+2],Fl[3]=r[4*s+3],Vl[0]^=e+i,e=286331153+(~e<<21)|e>>>11,i=Vl[0]+i+(i<<5)+3,r[4*s]=Fl[0],r[4*s+1]=Fl[1],r[4*s+2]=Fl[2],r[4*s+3]=Fl[3];return t}encryptBlock(t,e){const n=this.cryptTable;let i=4008636142;const r=new Uint8Array(t.buffer,t.byteOffset,t.byteLength);for(let s=0,a=t.byteLength>>>2;s<a;s++){i+=n[1024+(255&e)],Fl[0]=r[4*s],Fl[1]=r[4*s+1],Fl[2]=r[4*s+2],Fl[3]=r[4*s+3];const t=Vl[0];Vl[0]^=e+i,e=286331153+(~e<<21)|e>>>11,i=t+i+(i<<5)+3,r[4*s]=Fl[0],r[4*s+1]=Fl[1],r[4*s+2]=Fl[2],r[4*s+3]=Fl[3]}return t}computeFileKey(t,e){const n=t.lastIndexOf("\\"),i=t.substring(n+1);let r=this.hash(i,3);return e.flags&Bl&&(r=r+e.offset^e.normalSize),r}}function Kl(t){let e=t.length;for(;--e>=0;)t[e]=0}const jl=256,zl=286,Hl=30,Xl=15,ql=new Uint8Array([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0]),Yl=new Uint8Array([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13]),$l=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7]),Wl=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Zl=new Array(576);Kl(Zl);const Jl=new Array(60);Kl(Jl);const Ql=new Array(512);Kl(Ql);const th=new Array(256);Kl(th);const eh=new Array(29);Kl(eh);const nh=new Array(Hl);function ih(t,e,n,i,r){this.static_tree=t,this.extra_bits=e,this.extra_base=n,this.elems=i,this.max_length=r,this.has_stree=t&&t.length}let rh,sh,ah;function oh(t,e){this.dyn_tree=t,this.max_code=0,this.stat_desc=e}Kl(nh);const lh=t=>t<256?Ql[t]:Ql[256+(t>>>7)],hh=(t,e)=>{t.pending_buf[t.pending++]=255&e,t.pending_buf[t.pending++]=e>>>8&255},uh=(t,e,n)=>{t.bi_valid>16-n?(t.bi_buf|=e<<t.bi_valid&65535,hh(t,t.bi_buf),t.bi_buf=e>>16-t.bi_valid,t.bi_valid+=n-16):(t.bi_buf|=e<<t.bi_valid&65535,t.bi_valid+=n)},ch=(t,e,n)=>{uh(t,n[2*e],n[2*e+1])},dh=(t,e)=>{let n=0;do{n|=1&t,t>>>=1,n<<=1}while(--e>0);return n>>>1},fh=(t,e,n)=>{const i=new Array(16);let r,s,a=0;for(r=1;r<=Xl;r++)a=a+n[r-1]<<1,i[r]=a;for(s=0;s<=e;s++){let e=t[2*s+1];0!==e&&(t[2*s]=dh(i[e]++,e))}},ph=t=>{let e;for(e=0;e<zl;e++)t.dyn_ltree[2*e]=0;for(e=0;e<Hl;e++)t.dyn_dtree[2*e]=0;for(e=0;e<19;e++)t.bl_tree[2*e]=0;t.dyn_ltree[512]=1,t.opt_len=t.static_len=0,t.sym_next=t.matches=0},mh=t=>{t.bi_valid>8?hh(t,t.bi_buf):t.bi_valid>0&&(t.pending_buf[t.pending++]=t.bi_buf),t.bi_buf=0,t.bi_valid=0},_h=(t,e,n,i)=>{const r=2*e,s=2*n;return t[r]<t[s]||t[r]===t[s]&&i[e]<=i[n]},gh=(t,e,n)=>{const i=t.heap[n];let r=n<<1;for(;r<=t.heap_len&&(r<t.heap_len&&_h(e,t.heap[r+1],t.heap[r],t.depth)&&r++,!_h(e,i,t.heap[r],t.depth));)t.heap[n]=t.heap[r],n=r,r<<=1;t.heap[n]=i},vh=(t,e,n)=>{let i,r,s,a,o=0;if(0!==t.sym_next)do{i=255&t.pending_buf[t.sym_buf+o++],i+=(255&t.pending_buf[t.sym_buf+o++])<<8,r=t.pending_buf[t.sym_buf+o++],0===i?ch(t,r,e):(s=th[r],ch(t,s+jl+1,e),a=ql[s],0!==a&&(r-=eh[s],uh(t,r,a)),i--,s=lh(i),ch(t,s,n),a=Yl[s],0!==a&&(i-=nh[s],uh(t,i,a)))}while(o<t.sym_next);ch(t,256,e)},bh=(t,e)=>{const n=e.dyn_tree,i=e.stat_desc.static_tree,r=e.stat_desc.has_stree,s=e.stat_desc.elems;let a,o,l,h=-1;for(t.heap_len=0,t.heap_max=573,a=0;a<s;a++)0!==n[2*a]?(t.heap[++t.heap_len]=h=a,t.depth[a]=0):n[2*a+1]=0;for(;t.heap_len<2;)l=t.heap[++t.heap_len]=h<2?++h:0,n[2*l]=1,t.depth[l]=0,t.opt_len--,r&&(t.static_len-=i[2*l+1]);for(e.max_code=h,a=t.heap_len>>1;a>=1;a--)gh(t,n,a);l=s;do{a=t.heap[1],t.heap[1]=t.heap[t.heap_len--],gh(t,n,1),o=t.heap[1],t.heap[--t.heap_max]=a,t.heap[--t.heap_max]=o,n[2*l]=n[2*a]+n[2*o],t.depth[l]=(t.depth[a]>=t.depth[o]?t.depth[a]:t.depth[o])+1,n[2*a+1]=n[2*o+1]=l,t.heap[1]=l++,gh(t,n,1)}while(t.heap_len>=2);t.heap[--t.heap_max]=t.heap[1],((t,e)=>{const n=e.dyn_tree,i=e.max_code,r=e.stat_desc.static_tree,s=e.stat_desc.has_stree,a=e.stat_desc.extra_bits,o=e.stat_desc.extra_base,l=e.stat_desc.max_length;let h,u,c,d,f,p,m=0;for(d=0;d<=Xl;d++)t.bl_count[d]=0;for(n[2*t.heap[t.heap_max]+1]=0,h=t.heap_max+1;h<573;h++)u=t.heap[h],d=n[2*n[2*u+1]+1]+1,d>l&&(d=l,m++),n[2*u+1]=d,u>i||(t.bl_count[d]++,f=0,u>=o&&(f=a[u-o]),p=n[2*u],t.opt_len+=p*(d+f),s&&(t.static_len+=p*(r[2*u+1]+f)));if(0!==m){do{for(d=l-1;0===t.bl_count[d];)d--;t.bl_count[d]--,t.bl_count[d+1]+=2,t.bl_count[l]--,m-=2}while(m>0);for(d=l;0!==d;d--)for(u=t.bl_count[d];0!==u;)c=t.heap[--h],c>i||(n[2*c+1]!==d&&(t.opt_len+=(d-n[2*c+1])*n[2*c],n[2*c+1]=d),u--)}})(t,e),fh(n,h,t.bl_count)},wh=(t,e,n)=>{let i,r,s=-1,a=e[1],o=0,l=7,h=4;for(0===a&&(l=138,h=3),e[2*(n+1)+1]=65535,i=0;i<=n;i++)r=a,a=e[2*(i+1)+1],++o<l&&r===a||(o<h?t.bl_tree[2*r]+=o:0!==r?(r!==s&&t.bl_tree[2*r]++,t.bl_tree[32]++):o<=10?t.bl_tree[34]++:t.bl_tree[36]++,o=0,s=r,0===a?(l=138,h=3):r===a?(l=6,h=3):(l=7,h=4))},Ah=(t,e,n)=>{let i,r,s=-1,a=e[1],o=0,l=7,h=4;for(0===a&&(l=138,h=3),i=0;i<=n;i++)if(r=a,a=e[2*(i+1)+1],!(++o<l&&r===a)){if(o<h)do{ch(t,r,t.bl_tree)}while(0!=--o);else 0!==r?(r!==s&&(ch(t,r,t.bl_tree),o--),ch(t,16,t.bl_tree),uh(t,o-3,2)):o<=10?(ch(t,17,t.bl_tree),uh(t,o-3,3)):(ch(t,18,t.bl_tree),uh(t,o-11,7));o=0,s=r,0===a?(l=138,h=3):r===a?(l=6,h=3):(l=7,h=4)}};let yh=!1;const xh=(t,e,n,i)=>{uh(t,0+(i?1:0),3),mh(t),hh(t,n),hh(t,~n),n&&t.pending_buf.set(t.window.subarray(e,e+n),t.pending),t.pending+=n};var Th=t=>{yh||((()=>{let t,e,n,i,r;const s=new Array(16);for(n=0,i=0;i<28;i++)for(eh[i]=n,t=0;t<1<<ql[i];t++)th[n++]=i;for(th[n-1]=i,r=0,i=0;i<16;i++)for(nh[i]=r,t=0;t<1<<Yl[i];t++)Ql[r++]=i;for(r>>=7;i<Hl;i++)for(nh[i]=r<<7,t=0;t<1<<Yl[i]-7;t++)Ql[256+r++]=i;for(e=0;e<=Xl;e++)s[e]=0;for(t=0;t<=143;)Zl[2*t+1]=8,t++,s[8]++;for(;t<=255;)Zl[2*t+1]=9,t++,s[9]++;for(;t<=279;)Zl[2*t+1]=7,t++,s[7]++;for(;t<=287;)Zl[2*t+1]=8,t++,s[8]++;for(fh(Zl,287,s),t=0;t<Hl;t++)Jl[2*t+1]=5,Jl[2*t]=dh(t,5);rh=new ih(Zl,ql,257,zl,Xl),sh=new ih(Jl,Yl,0,Hl,Xl),ah=new ih(new Array(0),$l,0,19,7)})(),yh=!0),t.l_desc=new oh(t.dyn_ltree,rh),t.d_desc=new oh(t.dyn_dtree,sh),t.bl_desc=new oh(t.bl_tree,ah),t.bi_buf=0,t.bi_valid=0,ph(t)},Lh=(t,e,n,i)=>{let r,s,a=0;t.level>0?(2===t.strm.data_type&&(t.strm.data_type=(t=>{let e,n=4093624447;for(e=0;e<=31;e++,n>>>=1)if(1&n&&0!==t.dyn_ltree[2*e])return 0;if(0!==t.dyn_ltree[18]||0!==t.dyn_ltree[20]||0!==t.dyn_ltree[26])return 1;for(e=32;e<jl;e++)if(0!==t.dyn_ltree[2*e])return 1;return 0})(t)),bh(t,t.l_desc),bh(t,t.d_desc),a=(t=>{let e;for(wh(t,t.dyn_ltree,t.l_desc.max_code),wh(t,t.dyn_dtree,t.d_desc.max_code),bh(t,t.bl_desc),e=18;e>=3&&0===t.bl_tree[2*Wl[e]+1];e--);return t.opt_len+=3*(e+1)+5+5+4,e})(t),r=t.opt_len+3+7>>>3,s=t.static_len+3+7>>>3,s<=r&&(r=s)):r=s=n+5,n+4<=r&&-1!==e?xh(t,e,n,i):4===t.strategy||s===r?(uh(t,2+(i?1:0),3),vh(t,Zl,Jl)):(uh(t,4+(i?1:0),3),((t,e,n,i)=>{let r;for(uh(t,e-257,5),uh(t,n-1,5),uh(t,i-4,4),r=0;r<i;r++)uh(t,t.bl_tree[2*Wl[r]+1],3);Ah(t,t.dyn_ltree,e-1),Ah(t,t.dyn_dtree,n-1)})(t,t.l_desc.max_code+1,t.d_desc.max_code+1,a+1),vh(t,t.dyn_ltree,t.dyn_dtree)),ph(t),i&&mh(t)},Eh=(t,e,n)=>(t.pending_buf[t.sym_buf+t.sym_next++]=e,t.pending_buf[t.sym_buf+t.sym_next++]=e>>8,t.pending_buf[t.sym_buf+t.sym_next++]=n,0===e?t.dyn_ltree[2*n]++:(t.matches++,e--,t.dyn_ltree[2*(th[n]+jl+1)]++,t.dyn_dtree[2*lh(e)]++),t.sym_next===t.sym_end),Sh=t=>{uh(t,2,3),ch(t,256,Zl),(t=>{16===t.bi_valid?(hh(t,t.bi_buf),t.bi_buf=0,t.bi_valid=0):t.bi_valid>=8&&(t.pending_buf[t.pending++]=255&t.bi_buf,t.bi_buf>>=8,t.bi_valid-=8)})(t)},Mh={_tr_init:Th,_tr_stored_block:xh,_tr_flush_block:Lh,_tr_tally:Eh,_tr_align:Sh};var kh=(t,e,n,i)=>{let r=65535&t,s=t>>>16&65535,a=0;for(;0!==n;){a=n>2e3?2e3:n,n-=a;do{r=r+e[i++]|0,s=s+r|0}while(--a);r%=65521,s%=65521}return r|s<<16};const Rh=new Uint32Array((()=>{let t,e=[];for(var n=0;n<256;n++){t=n;for(var i=0;i<8;i++)t=1&t?3988292384^t>>>1:t>>>1;e[n]=t}return e})());var Ih=(t,e,n,i)=>{const r=Rh,s=i+n;t^=-1;for(let n=i;n<s;n++)t=t>>>8^r[255&(t^e[n])];return~t},Uh={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},Oh={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8};const{_tr_init:Ch,_tr_stored_block:Bh,_tr_flush_block:Ph,_tr_tally:Nh,_tr_align:Dh}=Mh,{Z_NO_FLUSH:Fh,Z_PARTIAL_FLUSH:Vh,Z_FULL_FLUSH:Gh,Z_FINISH:Kh,Z_BLOCK:jh,Z_OK:zh,Z_STREAM_END:Hh,Z_STREAM_ERROR:Xh,Z_DATA_ERROR:qh,Z_BUF_ERROR:Yh,Z_DEFAULT_COMPRESSION:$h,Z_FILTERED:Wh,Z_HUFFMAN_ONLY:Zh,Z_RLE:Jh,Z_FIXED:Qh,Z_DEFAULT_STRATEGY:tu,Z_UNKNOWN:eu,Z_DEFLATED:nu}=Oh,iu=258,ru=262,su=42,au=113,ou=666,lu=(t,e)=>(t.msg=Uh[e],e),hu=t=>2*t-(t>4?9:0),uu=t=>{let e=t.length;for(;--e>=0;)t[e]=0},cu=t=>{let e,n,i,r=t.w_size;e=t.hash_size,i=e;do{n=t.head[--i],t.head[i]=n>=r?n-r:0}while(--e);e=r,i=e;do{n=t.prev[--i],t.prev[i]=n>=r?n-r:0}while(--e)};let du=(t,e,n)=>(e<<t.hash_shift^n)&t.hash_mask;const fu=t=>{const e=t.state;let n=e.pending;n>t.avail_out&&(n=t.avail_out),0!==n&&(t.output.set(e.pending_buf.subarray(e.pending_out,e.pending_out+n),t.next_out),t.next_out+=n,e.pending_out+=n,t.total_out+=n,t.avail_out-=n,e.pending-=n,0===e.pending&&(e.pending_out=0))},pu=(t,e)=>{Ph(t,t.block_start>=0?t.block_start:-1,t.strstart-t.block_start,e),t.block_start=t.strstart,fu(t.strm)},mu=(t,e)=>{t.pending_buf[t.pending++]=e},_u=(t,e)=>{t.pending_buf[t.pending++]=e>>>8&255,t.pending_buf[t.pending++]=255&e},gu=(t,e,n,i)=>{let r=t.avail_in;return r>i&&(r=i),0===r?0:(t.avail_in-=r,e.set(t.input.subarray(t.next_in,t.next_in+r),n),1===t.state.wrap?t.adler=kh(t.adler,e,r,n):2===t.state.wrap&&(t.adler=Ih(t.adler,e,r,n)),t.next_in+=r,t.total_in+=r,r)},vu=(t,e)=>{let n,i,r=t.max_chain_length,s=t.strstart,a=t.prev_length,o=t.nice_match;const l=t.strstart>t.w_size-ru?t.strstart-(t.w_size-ru):0,h=t.window,u=t.w_mask,c=t.prev,d=t.strstart+iu;let f=h[s+a-1],p=h[s+a];t.prev_length>=t.good_match&&(r>>=2),o>t.lookahead&&(o=t.lookahead);do{if(n=e,h[n+a]===p&&h[n+a-1]===f&&h[n]===h[s]&&h[++n]===h[s+1]){s+=2,n++;do{}while(h[++s]===h[++n]&&h[++s]===h[++n]&&h[++s]===h[++n]&&h[++s]===h[++n]&&h[++s]===h[++n]&&h[++s]===h[++n]&&h[++s]===h[++n]&&h[++s]===h[++n]&&s<d);if(i=iu-(d-s),s=d-iu,i>a){if(t.match_start=e,a=i,i>=o)break;f=h[s+a-1],p=h[s+a]}}}while((e=c[e&u])>l&&0!=--r);return a<=t.lookahead?a:t.lookahead},bu=t=>{const e=t.w_size;let n,i,r;do{if(i=t.window_size-t.lookahead-t.strstart,t.strstart>=e+(e-ru)&&(t.window.set(t.window.subarray(e,e+e-i),0),t.match_start-=e,t.strstart-=e,t.block_start-=e,t.insert>t.strstart&&(t.insert=t.strstart),cu(t),i+=e),0===t.strm.avail_in)break;if(n=gu(t.strm,t.window,t.strstart+t.lookahead,i),t.lookahead+=n,t.lookahead+t.insert>=3)for(r=t.strstart-t.insert,t.ins_h=t.window[r],t.ins_h=du(t,t.ins_h,t.window[r+1]);t.insert&&(t.ins_h=du(t,t.ins_h,t.window[r+3-1]),t.prev[r&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=r,r++,t.insert--,!(t.lookahead+t.insert<3)););}while(t.lookahead<ru&&0!==t.strm.avail_in)},wu=(t,e)=>{let n,i,r,s=t.pending_buf_size-5>t.w_size?t.w_size:t.pending_buf_size-5,a=0,o=t.strm.avail_in;do{if(n=65535,r=t.bi_valid+42>>3,t.strm.avail_out<r)break;if(r=t.strm.avail_out-r,i=t.strstart-t.block_start,n>i+t.strm.avail_in&&(n=i+t.strm.avail_in),n>r&&(n=r),n<s&&(0===n&&e!==Kh||e===Fh||n!==i+t.strm.avail_in))break;a=e===Kh&&n===i+t.strm.avail_in?1:0,Bh(t,0,0,a),t.pending_buf[t.pending-4]=n,t.pending_buf[t.pending-3]=n>>8,t.pending_buf[t.pending-2]=~n,t.pending_buf[t.pending-1]=~n>>8,fu(t.strm),i&&(i>n&&(i=n),t.strm.output.set(t.window.subarray(t.block_start,t.block_start+i),t.strm.next_out),t.strm.next_out+=i,t.strm.avail_out-=i,t.strm.total_out+=i,t.block_start+=i,n-=i),n&&(gu(t.strm,t.strm.output,t.strm.next_out,n),t.strm.next_out+=n,t.strm.avail_out-=n,t.strm.total_out+=n)}while(0===a);return o-=t.strm.avail_in,o&&(o>=t.w_size?(t.matches=2,t.window.set(t.strm.input.subarray(t.strm.next_in-t.w_size,t.strm.next_in),0),t.strstart=t.w_size,t.insert=t.strstart):(t.window_size-t.strstart<=o&&(t.strstart-=t.w_size,t.window.set(t.window.subarray(t.w_size,t.w_size+t.strstart),0),t.matches<2&&t.matches++,t.insert>t.strstart&&(t.insert=t.strstart)),t.window.set(t.strm.input.subarray(t.strm.next_in-o,t.strm.next_in),t.strstart),t.strstart+=o,t.insert+=o>t.w_size-t.insert?t.w_size-t.insert:o),t.block_start=t.strstart),t.high_water<t.strstart&&(t.high_water=t.strstart),a?4:e!==Fh&&e!==Kh&&0===t.strm.avail_in&&t.strstart===t.block_start?2:(r=t.window_size-t.strstart,t.strm.avail_in>r&&t.block_start>=t.w_size&&(t.block_start-=t.w_size,t.strstart-=t.w_size,t.window.set(t.window.subarray(t.w_size,t.w_size+t.strstart),0),t.matches<2&&t.matches++,r+=t.w_size,t.insert>t.strstart&&(t.insert=t.strstart)),r>t.strm.avail_in&&(r=t.strm.avail_in),r&&(gu(t.strm,t.window,t.strstart,r),t.strstart+=r,t.insert+=r>t.w_size-t.insert?t.w_size-t.insert:r),t.high_water<t.strstart&&(t.high_water=t.strstart),r=t.bi_valid+42>>3,r=t.pending_buf_size-r>65535?65535:t.pending_buf_size-r,s=r>t.w_size?t.w_size:r,i=t.strstart-t.block_start,(i>=s||(i||e===Kh)&&e!==Fh&&0===t.strm.avail_in&&i<=r)&&(n=i>r?r:i,a=e===Kh&&0===t.strm.avail_in&&n===i?1:0,Bh(t,t.block_start,n,a),t.block_start+=n,fu(t.strm)),a?3:1)},Au=(t,e)=>{let n,i;for(;;){if(t.lookahead<ru){if(bu(t),t.lookahead<ru&&e===Fh)return 1;if(0===t.lookahead)break}if(n=0,t.lookahead>=3&&(t.ins_h=du(t,t.ins_h,t.window[t.strstart+3-1]),n=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart),0!==n&&t.strstart-n<=t.w_size-ru&&(t.match_length=vu(t,n)),t.match_length>=3)if(i=Nh(t,t.strstart-t.match_start,t.match_length-3),t.lookahead-=t.match_length,t.match_length<=t.max_lazy_match&&t.lookahead>=3){t.match_length--;do{t.strstart++,t.ins_h=du(t,t.ins_h,t.window[t.strstart+3-1]),n=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart}while(0!=--t.match_length);t.strstart++}else t.strstart+=t.match_length,t.match_length=0,t.ins_h=t.window[t.strstart],t.ins_h=du(t,t.ins_h,t.window[t.strstart+1]);else i=Nh(t,0,t.window[t.strstart]),t.lookahead--,t.strstart++;if(i&&(pu(t,!1),0===t.strm.avail_out))return 1}return t.insert=t.strstart<2?t.strstart:2,e===Kh?(pu(t,!0),0===t.strm.avail_out?3:4):t.sym_next&&(pu(t,!1),0===t.strm.avail_out)?1:2},yu=(t,e)=>{let n,i,r;for(;;){if(t.lookahead<ru){if(bu(t),t.lookahead<ru&&e===Fh)return 1;if(0===t.lookahead)break}if(n=0,t.lookahead>=3&&(t.ins_h=du(t,t.ins_h,t.window[t.strstart+3-1]),n=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart),t.prev_length=t.match_length,t.prev_match=t.match_start,t.match_length=2,0!==n&&t.prev_length<t.max_lazy_match&&t.strstart-n<=t.w_size-ru&&(t.match_length=vu(t,n),t.match_length<=5&&(t.strategy===Wh||3===t.match_length&&t.strstart-t.match_start>4096)&&(t.match_length=2)),t.prev_length>=3&&t.match_length<=t.prev_length){r=t.strstart+t.lookahead-3,i=Nh(t,t.strstart-1-t.prev_match,t.prev_length-3),t.lookahead-=t.prev_length-1,t.prev_length-=2;do{++t.strstart<=r&&(t.ins_h=du(t,t.ins_h,t.window[t.strstart+3-1]),n=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart)}while(0!=--t.prev_length);if(t.match_available=0,t.match_length=2,t.strstart++,i&&(pu(t,!1),0===t.strm.avail_out))return 1}else if(t.match_available){if(i=Nh(t,0,t.window[t.strstart-1]),i&&pu(t,!1),t.strstart++,t.lookahead--,0===t.strm.avail_out)return 1}else t.match_available=1,t.strstart++,t.lookahead--}return t.match_available&&(i=Nh(t,0,t.window[t.strstart-1]),t.match_available=0),t.insert=t.strstart<2?t.strstart:2,e===Kh?(pu(t,!0),0===t.strm.avail_out?3:4):t.sym_next&&(pu(t,!1),0===t.strm.avail_out)?1:2};function xu(t,e,n,i,r){this.good_length=t,this.max_lazy=e,this.nice_length=n,this.max_chain=i,this.func=r}const Tu=[new xu(0,0,0,0,wu),new xu(4,4,8,4,Au),new xu(4,5,16,8,Au),new xu(4,6,32,32,Au),new xu(4,4,16,16,yu),new xu(8,16,32,32,yu),new xu(8,16,128,128,yu),new xu(8,32,128,256,yu),new xu(32,128,258,1024,yu),new xu(32,258,258,4096,yu)];function Lu(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=nu,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new Uint16Array(1146),this.dyn_dtree=new Uint16Array(122),this.bl_tree=new Uint16Array(78),uu(this.dyn_ltree),uu(this.dyn_dtree),uu(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new Uint16Array(16),this.heap=new Uint16Array(573),uu(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new Uint16Array(573),uu(this.depth),this.sym_buf=0,this.lit_bufsize=0,this.sym_next=0,this.sym_end=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}const Eu=t=>{if(!t)return 1;const e=t.state;return!e||e.strm!==t||e.status!==su&&57!==e.status&&69!==e.status&&73!==e.status&&91!==e.status&&103!==e.status&&e.status!==au&&e.status!==ou?1:0},Su=t=>{if(Eu(t))return lu(t,Xh);t.total_in=t.total_out=0,t.data_type=eu;const e=t.state;return e.pending=0,e.pending_out=0,e.wrap<0&&(e.wrap=-e.wrap),e.status=2===e.wrap?57:e.wrap?su:au,t.adler=2===e.wrap?0:1,e.last_flush=-2,Ch(e),zh},Mu=t=>{const e=Su(t);return e===zh&&(t=>{t.window_size=2*t.w_size,uu(t.head),t.max_lazy_match=Tu[t.level].max_lazy,t.good_match=Tu[t.level].good_length,t.nice_match=Tu[t.level].nice_length,t.max_chain_length=Tu[t.level].max_chain,t.strstart=0,t.block_start=0,t.lookahead=0,t.insert=0,t.match_length=t.prev_length=2,t.match_available=0,t.ins_h=0})(t.state),e},ku=(t,e,n,i,r,s)=>{if(!t)return Xh;let a=1;if(e===$h&&(e=6),i<0?(a=0,i=-i):i>15&&(a=2,i-=16),r<1||r>9||n!==nu||i<8||i>15||e<0||e>9||s<0||s>Qh||8===i&&1!==a)return lu(t,Xh);8===i&&(i=9);const o=new Lu;return t.state=o,o.strm=t,o.status=su,o.wrap=a,o.gzhead=null,o.w_bits=i,o.w_size=1<<o.w_bits,o.w_mask=o.w_size-1,o.hash_bits=r+7,o.hash_size=1<<o.hash_bits,o.hash_mask=o.hash_size-1,o.hash_shift=~~((o.hash_bits+3-1)/3),o.window=new Uint8Array(2*o.w_size),o.head=new Uint16Array(o.hash_size),o.prev=new Uint16Array(o.w_size),o.lit_bufsize=1<<r+6,o.pending_buf_size=4*o.lit_bufsize,o.pending_buf=new Uint8Array(o.pending_buf_size),o.sym_buf=o.lit_bufsize,o.sym_end=3*(o.lit_bufsize-1),o.level=e,o.strategy=s,o.method=n,Mu(t)};var Ru=(t,e)=>{if(Eu(t)||e>jh||e<0)return t?lu(t,Xh):Xh;const n=t.state;if(!t.output||0!==t.avail_in&&!t.input||n.status===ou&&e!==Kh)return lu(t,0===t.avail_out?Yh:Xh);const i=n.last_flush;if(n.last_flush=e,0!==n.pending){if(fu(t),0===t.avail_out)return n.last_flush=-1,zh}else if(0===t.avail_in&&hu(e)<=hu(i)&&e!==Kh)return lu(t,Yh);if(n.status===ou&&0!==t.avail_in)return lu(t,Yh);if(n.status===su&&0===n.wrap&&(n.status=au),n.status===su){let e=nu+(n.w_bits-8<<4)<<8,i=-1;if(i=n.strategy>=Zh||n.level<2?0:n.level<6?1:6===n.level?2:3,e|=i<<6,0!==n.strstart&&(e|=32),e+=31-e%31,_u(n,e),0!==n.strstart&&(_u(n,t.adler>>>16),_u(n,65535&t.adler)),t.adler=1,n.status=au,fu(t),0!==n.pending)return n.last_flush=-1,zh}if(57===n.status)if(t.adler=0,mu(n,31),mu(n,139),mu(n,8),n.gzhead)mu(n,(n.gzhead.text?1:0)+(n.gzhead.hcrc?2:0)+(n.gzhead.extra?4:0)+(n.gzhead.name?8:0)+(n.gzhead.comment?16:0)),mu(n,255&n.gzhead.time),mu(n,n.gzhead.time>>8&255),mu(n,n.gzhead.time>>16&255),mu(n,n.gzhead.time>>24&255),mu(n,9===n.level?2:n.strategy>=Zh||n.level<2?4:0),mu(n,255&n.gzhead.os),n.gzhead.extra&&n.gzhead.extra.length&&(mu(n,255&n.gzhead.extra.length),mu(n,n.gzhead.extra.length>>8&255)),n.gzhead.hcrc&&(t.adler=Ih(t.adler,n.pending_buf,n.pending,0)),n.gzindex=0,n.status=69;else if(mu(n,0),mu(n,0),mu(n,0),mu(n,0),mu(n,0),mu(n,9===n.level?2:n.strategy>=Zh||n.level<2?4:0),mu(n,3),n.status=au,fu(t),0!==n.pending)return n.last_flush=-1,zh;if(69===n.status){if(n.gzhead.extra){let e=n.pending,i=(65535&n.gzhead.extra.length)-n.gzindex;for(;n.pending+i>n.pending_buf_size;){let r=n.pending_buf_size-n.pending;if(n.pending_buf.set(n.gzhead.extra.subarray(n.gzindex,n.gzindex+r),n.pending),n.pending=n.pending_buf_size,n.gzhead.hcrc&&n.pending>e&&(t.adler=Ih(t.adler,n.pending_buf,n.pending-e,e)),n.gzindex+=r,fu(t),0!==n.pending)return n.last_flush=-1,zh;e=0,i-=r}let r=new Uint8Array(n.gzhead.extra);n.pending_buf.set(r.subarray(n.gzindex,n.gzindex+i),n.pending),n.pending+=i,n.gzhead.hcrc&&n.pending>e&&(t.adler=Ih(t.adler,n.pending_buf,n.pending-e,e)),n.gzindex=0}n.status=73}if(73===n.status){if(n.gzhead.name){let e,i=n.pending;do{if(n.pending===n.pending_buf_size){if(n.gzhead.hcrc&&n.pending>i&&(t.adler=Ih(t.adler,n.pending_buf,n.pending-i,i)),fu(t),0!==n.pending)return n.last_flush=-1,zh;i=0}e=n.gzindex<n.gzhead.name.length?255&n.gzhead.name.charCodeAt(n.gzindex++):0,mu(n,e)}while(0!==e);n.gzhead.hcrc&&n.pending>i&&(t.adler=Ih(t.adler,n.pending_buf,n.pending-i,i)),n.gzindex=0}n.status=91}if(91===n.status){if(n.gzhead.comment){let e,i=n.pending;do{if(n.pending===n.pending_buf_size){if(n.gzhead.hcrc&&n.pending>i&&(t.adler=Ih(t.adler,n.pending_buf,n.pending-i,i)),fu(t),0!==n.pending)return n.last_flush=-1,zh;i=0}e=n.gzindex<n.gzhead.comment.length?255&n.gzhead.comment.charCodeAt(n.gzindex++):0,mu(n,e)}while(0!==e);n.gzhead.hcrc&&n.pending>i&&(t.adler=Ih(t.adler,n.pending_buf,n.pending-i,i))}n.status=103}if(103===n.status){if(n.gzhead.hcrc){if(n.pending+2>n.pending_buf_size&&(fu(t),0!==n.pending))return n.last_flush=-1,zh;mu(n,255&t.adler),mu(n,t.adler>>8&255),t.adler=0}if(n.status=au,fu(t),0!==n.pending)return n.last_flush=-1,zh}if(0!==t.avail_in||0!==n.lookahead||e!==Fh&&n.status!==ou){let i=0===n.level?wu(n,e):n.strategy===Zh?((t,e)=>{let n;for(;;){if(0===t.lookahead&&(bu(t),0===t.lookahead)){if(e===Fh)return 1;break}if(t.match_length=0,n=Nh(t,0,t.window[t.strstart]),t.lookahead--,t.strstart++,n&&(pu(t,!1),0===t.strm.avail_out))return 1}return t.insert=0,e===Kh?(pu(t,!0),0===t.strm.avail_out?3:4):t.sym_next&&(pu(t,!1),0===t.strm.avail_out)?1:2})(n,e):n.strategy===Jh?((t,e)=>{let n,i,r,s;const a=t.window;for(;;){if(t.lookahead<=iu){if(bu(t),t.lookahead<=iu&&e===Fh)return 1;if(0===t.lookahead)break}if(t.match_length=0,t.lookahead>=3&&t.strstart>0&&(r=t.strstart-1,i=a[r],i===a[++r]&&i===a[++r]&&i===a[++r])){s=t.strstart+iu;do{}while(i===a[++r]&&i===a[++r]&&i===a[++r]&&i===a[++r]&&i===a[++r]&&i===a[++r]&&i===a[++r]&&i===a[++r]&&r<s);t.match_length=iu-(s-r),t.match_length>t.lookahead&&(t.match_length=t.lookahead)}if(t.match_length>=3?(n=Nh(t,1,t.match_length-3),t.lookahead-=t.match_length,t.strstart+=t.match_length,t.match_length=0):(n=Nh(t,0,t.window[t.strstart]),t.lookahead--,t.strstart++),n&&(pu(t,!1),0===t.strm.avail_out))return 1}return t.insert=0,e===Kh?(pu(t,!0),0===t.strm.avail_out?3:4):t.sym_next&&(pu(t,!1),0===t.strm.avail_out)?1:2})(n,e):Tu[n.level].func(n,e);if(3!==i&&4!==i||(n.status=ou),1===i||3===i)return 0===t.avail_out&&(n.last_flush=-1),zh;if(2===i&&(e===Vh?Dh(n):e!==jh&&(Bh(n,0,0,!1),e===Gh&&(uu(n.head),0===n.lookahead&&(n.strstart=0,n.block_start=0,n.insert=0))),fu(t),0===t.avail_out))return n.last_flush=-1,zh}return e!==Kh?zh:n.wrap<=0?Hh:(2===n.wrap?(mu(n,255&t.adler),mu(n,t.adler>>8&255),mu(n,t.adler>>16&255),mu(n,t.adler>>24&255),mu(n,255&t.total_in),mu(n,t.total_in>>8&255),mu(n,t.total_in>>16&255),mu(n,t.total_in>>24&255)):(_u(n,t.adler>>>16),_u(n,65535&t.adler)),fu(t),n.wrap>0&&(n.wrap=-n.wrap),0!==n.pending?zh:Hh)},Iu=(t,e)=>{let n=e.length;if(Eu(t))return Xh;const i=t.state,r=i.wrap;if(2===r||1===r&&i.status!==su||i.lookahead)return Xh;if(1===r&&(t.adler=kh(t.adler,e,n,0)),i.wrap=0,n>=i.w_size){0===r&&(uu(i.head),i.strstart=0,i.block_start=0,i.insert=0);let t=new Uint8Array(i.w_size);t.set(e.subarray(n-i.w_size,n),0),e=t,n=i.w_size}const s=t.avail_in,a=t.next_in,o=t.input;for(t.avail_in=n,t.next_in=0,t.input=e,bu(i);i.lookahead>=3;){let t=i.strstart,e=i.lookahead-2;do{i.ins_h=du(i,i.ins_h,i.window[t+3-1]),i.prev[t&i.w_mask]=i.head[i.ins_h],i.head[i.ins_h]=t,t++}while(--e);i.strstart=t,i.lookahead=2,bu(i)}return i.strstart+=i.lookahead,i.block_start=i.strstart,i.insert=i.lookahead,i.lookahead=0,i.match_length=i.prev_length=2,i.match_available=0,t.next_in=a,t.input=o,t.avail_in=s,i.wrap=r,zh},Uu={deflateInit:(t,e)=>ku(t,e,nu,15,8,tu),deflateInit2:ku,deflateReset:Mu,deflateResetKeep:Su,deflateSetHeader:(t,e)=>Eu(t)||2!==t.state.wrap?Xh:(t.state.gzhead=e,zh),deflate:Ru,deflateEnd:t=>{if(Eu(t))return Xh;const e=t.state.status;return t.state=null,e===au?lu(t,qh):zh},deflateSetDictionary:Iu,deflateInfo:"pako deflate (from Nodeca project)"};const Ou=(t,e)=>Object.prototype.hasOwnProperty.call(t,e);var Cu=function(t){const e=Array.prototype.slice.call(arguments,1);for(;e.length;){const n=e.shift();if(n){if("object"!=typeof n)throw new TypeError(n+"must be non-object");for(const e in n)Ou(n,e)&&(t[e]=n[e])}}return t},Bu=t=>{let e=0;for(let n=0,i=t.length;n<i;n++)e+=t[n].length;const n=new Uint8Array(e);for(let e=0,i=0,r=t.length;e<r;e++){let r=t[e];n.set(r,i),i+=r.length}return n};let Pu=!0;try{String.fromCharCode.apply(null,new Uint8Array(1))}catch(t){Pu=!1}const Nu=new Uint8Array(256);for(let t=0;t<256;t++)Nu[t]=t>=252?6:t>=248?5:t>=240?4:t>=224?3:t>=192?2:1;Nu[254]=Nu[254]=1;var Du=t=>{if("function"==typeof TextEncoder&&TextEncoder.prototype.encode)return(new TextEncoder).encode(t);let e,n,i,r,s,a=t.length,o=0;for(r=0;r<a;r++)n=t.charCodeAt(r),55296==(64512&n)&&r+1<a&&(i=t.charCodeAt(r+1),56320==(64512&i)&&(n=65536+(n-55296<<10)+(i-56320),r++)),o+=n<128?1:n<2048?2:n<65536?3:4;for(e=new Uint8Array(o),s=0,r=0;s<o;r++)n=t.charCodeAt(r),55296==(64512&n)&&r+1<a&&(i=t.charCodeAt(r+1),56320==(64512&i)&&(n=65536+(n-55296<<10)+(i-56320),r++)),n<128?e[s++]=n:n<2048?(e[s++]=192|n>>>6,e[s++]=128|63&n):n<65536?(e[s++]=224|n>>>12,e[s++]=128|n>>>6&63,e[s++]=128|63&n):(e[s++]=240|n>>>18,e[s++]=128|n>>>12&63,e[s++]=128|n>>>6&63,e[s++]=128|63&n);return e},Fu=(t,e)=>{const n=e||t.length;if("function"==typeof TextDecoder&&TextDecoder.prototype.decode)return(new TextDecoder).decode(t.subarray(0,e));let i,r;const s=new Array(2*n);for(r=0,i=0;i<n;){let e=t[i++];if(e<128){s[r++]=e;continue}let a=Nu[e];if(a>4)s[r++]=65533,i+=a-1;else{for(e&=2===a?31:3===a?15:7;a>1&&i<n;)e=e<<6|63&t[i++],a--;a>1?s[r++]=65533:e<65536?s[r++]=e:(e-=65536,s[r++]=55296|e>>10&1023,s[r++]=56320|1023&e)}}return((t,e)=>{if(e<65534&&t.subarray&&Pu)return String.fromCharCode.apply(null,t.length===e?t:t.subarray(0,e));let n="";for(let i=0;i<e;i++)n+=String.fromCharCode(t[i]);return n})(s,r)},Vu=(t,e)=>{(e=e||t.length)>t.length&&(e=t.length);let n=e-1;for(;n>=0&&128==(192&t[n]);)n--;return n<0||0===n?e:n+Nu[t[n]]>e?n:e};var Gu=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0};const Ku=Object.prototype.toString,{Z_NO_FLUSH:ju,Z_SYNC_FLUSH:zu,Z_FULL_FLUSH:Hu,Z_FINISH:Xu,Z_OK:qu,Z_STREAM_END:Yu,Z_DEFAULT_COMPRESSION:$u,Z_DEFAULT_STRATEGY:Wu,Z_DEFLATED:Zu}=Oh;function Ju(t){this.options=Cu({level:$u,method:Zu,chunkSize:16384,windowBits:15,memLevel:8,strategy:Wu},t||{});let e=this.options;e.raw&&e.windowBits>0?e.windowBits=-e.windowBits:e.gzip&&e.windowBits>0&&e.windowBits<16&&(e.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new Gu,this.strm.avail_out=0;let n=Uu.deflateInit2(this.strm,e.level,e.method,e.windowBits,e.memLevel,e.strategy);if(n!==qu)throw new Error(Uh[n]);if(e.header&&Uu.deflateSetHeader(this.strm,e.header),e.dictionary){let t;if(t="string"==typeof e.dictionary?Du(e.dictionary):"[object ArrayBuffer]"===Ku.call(e.dictionary)?new Uint8Array(e.dictionary):e.dictionary,n=Uu.deflateSetDictionary(this.strm,t),n!==qu)throw new Error(Uh[n]);this._dict_set=!0}}function Qu(t,e){const n=new Ju(e);if(n.push(t,!0),n.err)throw n.msg||Uh[n.err];return n.result}Ju.prototype.push=function(t,e){const n=this.strm,i=this.options.chunkSize;let r,s;if(this.ended)return!1;for(s=e===~~e?e:!0===e?Xu:ju,"string"==typeof t?n.input=Du(t):"[object ArrayBuffer]"===Ku.call(t)?n.input=new Uint8Array(t):n.input=t,n.next_in=0,n.avail_in=n.input.length;;)if(0===n.avail_out&&(n.output=new Uint8Array(i),n.next_out=0,n.avail_out=i),(s===zu||s===Hu)&&n.avail_out<=6)this.onData(n.output.subarray(0,n.next_out)),n.avail_out=0;else{if(r=Uu.deflate(n,s),r===Yu)return n.next_out>0&&this.onData(n.output.subarray(0,n.next_out)),r=Uu.deflateEnd(this.strm),this.onEnd(r),this.ended=!0,r===qu;if(0!==n.avail_out){if(s>0&&n.next_out>0)this.onData(n.output.subarray(0,n.next_out)),n.avail_out=0;else if(0===n.avail_in)break}else this.onData(n.output)}return!0},Ju.prototype.onData=function(t){this.chunks.push(t)},Ju.prototype.onEnd=function(t){t===qu&&(this.result=Bu(this.chunks)),this.chunks=[],this.err=t,this.msg=this.strm.msg};var tc={Deflate:Ju,deflate:Qu,deflateRaw:function(t,e){return(e=e||{}).raw=!0,Qu(t,e)},gzip:function(t,e){return(e=e||{}).gzip=!0,Qu(t,e)},constants:Oh};const ec=16209;var nc=function(t,e){let n,i,r,s,a,o,l,h,u,c,d,f,p,m,_,g,v,b,w,A,y,x,T,L;const E=t.state;n=t.next_in,T=t.input,i=n+(t.avail_in-5),r=t.next_out,L=t.output,s=r-(e-t.avail_out),a=r+(t.avail_out-257),o=E.dmax,l=E.wsize,h=E.whave,u=E.wnext,c=E.window,d=E.hold,f=E.bits,p=E.lencode,m=E.distcode,_=(1<<E.lenbits)-1,g=(1<<E.distbits)-1;t:do{f<15&&(d+=T[n++]<<f,f+=8,d+=T[n++]<<f,f+=8),v=p[d&_];e:for(;;){if(b=v>>>24,d>>>=b,f-=b,b=v>>>16&255,0===b)L[r++]=65535&v;else{if(!(16&b)){if(64&b){if(32&b){E.mode=16191;break t}t.msg="invalid literal/length code",E.mode=ec;break t}v=p[(65535&v)+(d&(1<<b)-1)];continue e}for(w=65535&v,b&=15,b&&(f<b&&(d+=T[n++]<<f,f+=8),w+=d&(1<<b)-1,d>>>=b,f-=b),f<15&&(d+=T[n++]<<f,f+=8,d+=T[n++]<<f,f+=8),v=m[d&g];;){if(b=v>>>24,d>>>=b,f-=b,b=v>>>16&255,16&b){if(A=65535&v,b&=15,f<b&&(d+=T[n++]<<f,f+=8,f<b&&(d+=T[n++]<<f,f+=8)),A+=d&(1<<b)-1,A>o){t.msg="invalid distance too far back",E.mode=ec;break t}if(d>>>=b,f-=b,b=r-s,A>b){if(b=A-b,b>h&&E.sane){t.msg="invalid distance too far back",E.mode=ec;break t}if(y=0,x=c,0===u){if(y+=l-b,b<w){w-=b;do{L[r++]=c[y++]}while(--b);y=r-A,x=L}}else if(u<b){if(y+=l+u-b,b-=u,b<w){w-=b;do{L[r++]=c[y++]}while(--b);if(y=0,u<w){b=u,w-=b;do{L[r++]=c[y++]}while(--b);y=r-A,x=L}}}else if(y+=u-b,b<w){w-=b;do{L[r++]=c[y++]}while(--b);y=r-A,x=L}for(;w>2;)L[r++]=x[y++],L[r++]=x[y++],L[r++]=x[y++],w-=3;w&&(L[r++]=x[y++],w>1&&(L[r++]=x[y++]))}else{y=r-A;do{L[r++]=L[y++],L[r++]=L[y++],L[r++]=L[y++],w-=3}while(w>2);w&&(L[r++]=L[y++],w>1&&(L[r++]=L[y++]))}break}if(64&b){t.msg="invalid distance code",E.mode=ec;break t}v=m[(65535&v)+(d&(1<<b)-1)]}}break}}while(n<i&&r<a);w=f>>3,n-=w,f-=w<<3,d&=(1<<f)-1,t.next_in=n,t.next_out=r,t.avail_in=n<i?i-n+5:5-(n-i),t.avail_out=r<a?a-r+257:257-(r-a),E.hold=d,E.bits=f};const ic=15,rc=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),sc=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),ac=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),oc=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]);var lc=(t,e,n,i,r,s,a,o)=>{const l=o.bits;let h,u,c,d,f,p,m=0,_=0,g=0,v=0,b=0,w=0,A=0,y=0,x=0,T=0,L=null;const E=new Uint16Array(16),S=new Uint16Array(16);let M,k,R,I=null;for(m=0;m<=ic;m++)E[m]=0;for(_=0;_<i;_++)E[e[n+_]]++;for(b=l,v=ic;v>=1&&0===E[v];v--);if(b>v&&(b=v),0===v)return r[s++]=20971520,r[s++]=20971520,o.bits=1,0;for(g=1;g<v&&0===E[g];g++);for(b<g&&(b=g),y=1,m=1;m<=ic;m++)if(y<<=1,y-=E[m],y<0)return-1;if(y>0&&(0===t||1!==v))return-1;for(S[1]=0,m=1;m<ic;m++)S[m+1]=S[m]+E[m];for(_=0;_<i;_++)0!==e[n+_]&&(a[S[e[n+_]]++]=_);if(0===t?(L=I=a,p=20):1===t?(L=rc,I=sc,p=257):(L=ac,I=oc,p=0),T=0,_=0,m=g,f=s,w=b,A=0,c=-1,x=1<<b,d=x-1,1===t&&x>852||2===t&&x>592)return 1;for(;;){M=m-A,a[_]+1<p?(k=0,R=a[_]):a[_]>=p?(k=I[a[_]-p],R=L[a[_]-p]):(k=96,R=0),h=1<<m-A,u=1<<w,g=u;do{u-=h,r[f+(T>>A)+u]=M<<24|k<<16|R}while(0!==u);for(h=1<<m-1;T&h;)h>>=1;if(0!==h?(T&=h-1,T+=h):T=0,_++,0==--E[m]){if(m===v)break;m=e[n+a[_]]}if(m>b&&(T&d)!==c){for(0===A&&(A=b),f+=g,w=m-A,y=1<<w;w+A<v&&(y-=E[w+A],!(y<=0));)w++,y<<=1;if(x+=1<<w,1===t&&x>852||2===t&&x>592)return 1;c=T&d,r[c]=b<<24|w<<16|f-s}}return 0!==T&&(r[f+T]=m-A<<24|64<<16),o.bits=b,0};const{Z_FINISH:hc,Z_BLOCK:uc,Z_TREES:cc,Z_OK:dc,Z_STREAM_END:fc,Z_NEED_DICT:pc,Z_STREAM_ERROR:mc,Z_DATA_ERROR:_c,Z_MEM_ERROR:gc,Z_BUF_ERROR:vc,Z_DEFLATED:bc}=Oh,wc=16180,Ac=16190,yc=16191,xc=16192,Tc=16194,Lc=16199,Ec=16200,Sc=16206,Mc=16209,kc=t=>(t>>>24&255)+(t>>>8&65280)+((65280&t)<<8)+((255&t)<<24);function Rc(){this.strm=null,this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}const Ic=t=>{if(!t)return 1;const e=t.state;return!e||e.strm!==t||e.mode<wc||e.mode>16211?1:0},Uc=t=>{if(Ic(t))return mc;const e=t.state;return t.total_in=t.total_out=e.total=0,t.msg="",e.wrap&&(t.adler=1&e.wrap),e.mode=wc,e.last=0,e.havedict=0,e.flags=-1,e.dmax=32768,e.head=null,e.hold=0,e.bits=0,e.lencode=e.lendyn=new Int32Array(852),e.distcode=e.distdyn=new Int32Array(592),e.sane=1,e.back=-1,dc},Oc=t=>{if(Ic(t))return mc;const e=t.state;return e.wsize=0,e.whave=0,e.wnext=0,Uc(t)},Cc=(t,e)=>{let n;if(Ic(t))return mc;const i=t.state;return e<0?(n=0,e=-e):(n=5+(e>>4),e<48&&(e&=15)),e&&(e<8||e>15)?mc:(null!==i.window&&i.wbits!==e&&(i.window=null),i.wrap=n,i.wbits=e,Oc(t))},Bc=(t,e)=>{if(!t)return mc;const n=new Rc;t.state=n,n.strm=t,n.window=null,n.mode=wc;const i=Cc(t,e);return i!==dc&&(t.state=null),i};let Pc,Nc,Dc=!0;const Fc=t=>{if(Dc){Pc=new Int32Array(512),Nc=new Int32Array(32);let e=0;for(;e<144;)t.lens[e++]=8;for(;e<256;)t.lens[e++]=9;for(;e<280;)t.lens[e++]=7;for(;e<288;)t.lens[e++]=8;for(lc(1,t.lens,0,288,Pc,0,t.work,{bits:9}),e=0;e<32;)t.lens[e++]=5;lc(2,t.lens,0,32,Nc,0,t.work,{bits:5}),Dc=!1}t.lencode=Pc,t.lenbits=9,t.distcode=Nc,t.distbits=5},Vc=(t,e,n,i)=>{let r;const s=t.state;return null===s.window&&(s.wsize=1<<s.wbits,s.wnext=0,s.whave=0,s.window=new Uint8Array(s.wsize)),i>=s.wsize?(s.window.set(e.subarray(n-s.wsize,n),0),s.wnext=0,s.whave=s.wsize):(r=s.wsize-s.wnext,r>i&&(r=i),s.window.set(e.subarray(n-i,n-i+r),s.wnext),(i-=r)?(s.window.set(e.subarray(n-i,n),0),s.wnext=i,s.whave=s.wsize):(s.wnext+=r,s.wnext===s.wsize&&(s.wnext=0),s.whave<s.wsize&&(s.whave+=r))),0};var Gc=(t,e)=>{let n,i,r,s,a,o,l,h,u,c,d,f,p,m,_,g,v,b,w,A,y,x,T=0;const L=new Uint8Array(4);let E,S;const M=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(Ic(t)||!t.output||!t.input&&0!==t.avail_in)return mc;n=t.state,n.mode===yc&&(n.mode=xc),a=t.next_out,r=t.output,l=t.avail_out,s=t.next_in,i=t.input,o=t.avail_in,h=n.hold,u=n.bits,c=o,d=l,x=dc;t:for(;;)switch(n.mode){case wc:if(0===n.wrap){n.mode=xc;break}for(;u<16;){if(0===o)break t;o--,h+=i[s++]<<u,u+=8}if(2&n.wrap&&35615===h){0===n.wbits&&(n.wbits=15),n.check=0,L[0]=255&h,L[1]=h>>>8&255,n.check=Ih(n.check,L,2,0),h=0,u=0,n.mode=16181;break}if(n.head&&(n.head.done=!1),!(1&n.wrap)||(((255&h)<<8)+(h>>8))%31){t.msg="incorrect header check",n.mode=Mc;break}if((15&h)!==bc){t.msg="unknown compression method",n.mode=Mc;break}if(h>>>=4,u-=4,y=8+(15&h),0===n.wbits&&(n.wbits=y),y>15||y>n.wbits){t.msg="invalid window size",n.mode=Mc;break}n.dmax=1<<n.wbits,n.flags=0,t.adler=n.check=1,n.mode=512&h?16189:yc,h=0,u=0;break;case 16181:for(;u<16;){if(0===o)break t;o--,h+=i[s++]<<u,u+=8}if(n.flags=h,(255&n.flags)!==bc){t.msg="unknown compression method",n.mode=Mc;break}if(57344&n.flags){t.msg="unknown header flags set",n.mode=Mc;break}n.head&&(n.head.text=h>>8&1),512&n.flags&&4&n.wrap&&(L[0]=255&h,L[1]=h>>>8&255,n.check=Ih(n.check,L,2,0)),h=0,u=0,n.mode=16182;case 16182:for(;u<32;){if(0===o)break t;o--,h+=i[s++]<<u,u+=8}n.head&&(n.head.time=h),512&n.flags&&4&n.wrap&&(L[0]=255&h,L[1]=h>>>8&255,L[2]=h>>>16&255,L[3]=h>>>24&255,n.check=Ih(n.check,L,4,0)),h=0,u=0,n.mode=16183;case 16183:for(;u<16;){if(0===o)break t;o--,h+=i[s++]<<u,u+=8}n.head&&(n.head.xflags=255&h,n.head.os=h>>8),512&n.flags&&4&n.wrap&&(L[0]=255&h,L[1]=h>>>8&255,n.check=Ih(n.check,L,2,0)),h=0,u=0,n.mode=16184;case 16184:if(1024&n.flags){for(;u<16;){if(0===o)break t;o--,h+=i[s++]<<u,u+=8}n.length=h,n.head&&(n.head.extra_len=h),512&n.flags&&4&n.wrap&&(L[0]=255&h,L[1]=h>>>8&255,n.check=Ih(n.check,L,2,0)),h=0,u=0}else n.head&&(n.head.extra=null);n.mode=16185;case 16185:if(1024&n.flags&&(f=n.length,f>o&&(f=o),f&&(n.head&&(y=n.head.extra_len-n.length,n.head.extra||(n.head.extra=new Uint8Array(n.head.extra_len)),n.head.extra.set(i.subarray(s,s+f),y)),512&n.flags&&4&n.wrap&&(n.check=Ih(n.check,i,f,s)),o-=f,s+=f,n.length-=f),n.length))break t;n.length=0,n.mode=16186;case 16186:if(2048&n.flags){if(0===o)break t;f=0;do{y=i[s+f++],n.head&&y&&n.length<65536&&(n.head.name+=String.fromCharCode(y))}while(y&&f<o);if(512&n.flags&&4&n.wrap&&(n.check=Ih(n.check,i,f,s)),o-=f,s+=f,y)break t}else n.head&&(n.head.name=null);n.length=0,n.mode=16187;case 16187:if(4096&n.flags){if(0===o)break t;f=0;do{y=i[s+f++],n.head&&y&&n.length<65536&&(n.head.comment+=String.fromCharCode(y))}while(y&&f<o);if(512&n.flags&&4&n.wrap&&(n.check=Ih(n.check,i,f,s)),o-=f,s+=f,y)break t}else n.head&&(n.head.comment=null);n.mode=16188;case 16188:if(512&n.flags){for(;u<16;){if(0===o)break t;o--,h+=i[s++]<<u,u+=8}if(4&n.wrap&&h!==(65535&n.check)){t.msg="header crc mismatch",n.mode=Mc;break}h=0,u=0}n.head&&(n.head.hcrc=n.flags>>9&1,n.head.done=!0),t.adler=n.check=0,n.mode=yc;break;case 16189:for(;u<32;){if(0===o)break t;o--,h+=i[s++]<<u,u+=8}t.adler=n.check=kc(h),h=0,u=0,n.mode=Ac;case Ac:if(0===n.havedict)return t.next_out=a,t.avail_out=l,t.next_in=s,t.avail_in=o,n.hold=h,n.bits=u,pc;t.adler=n.check=1,n.mode=yc;case yc:if(e===uc||e===cc)break t;case xc:if(n.last){h>>>=7&u,u-=7&u,n.mode=Sc;break}for(;u<3;){if(0===o)break t;o--,h+=i[s++]<<u,u+=8}switch(n.last=1&h,h>>>=1,u-=1,3&h){case 0:n.mode=16193;break;case 1:if(Fc(n),n.mode=Lc,e===cc){h>>>=2,u-=2;break t}break;case 2:n.mode=16196;break;case 3:t.msg="invalid block type",n.mode=Mc}h>>>=2,u-=2;break;case 16193:for(h>>>=7&u,u-=7&u;u<32;){if(0===o)break t;o--,h+=i[s++]<<u,u+=8}if((65535&h)!=(h>>>16^65535)){t.msg="invalid stored block lengths",n.mode=Mc;break}if(n.length=65535&h,h=0,u=0,n.mode=Tc,e===cc)break t;case Tc:n.mode=16195;case 16195:if(f=n.length,f){if(f>o&&(f=o),f>l&&(f=l),0===f)break t;r.set(i.subarray(s,s+f),a),o-=f,s+=f,l-=f,a+=f,n.length-=f;break}n.mode=yc;break;case 16196:for(;u<14;){if(0===o)break t;o--,h+=i[s++]<<u,u+=8}if(n.nlen=257+(31&h),h>>>=5,u-=5,n.ndist=1+(31&h),h>>>=5,u-=5,n.ncode=4+(15&h),h>>>=4,u-=4,n.nlen>286||n.ndist>30){t.msg="too many length or distance symbols",n.mode=Mc;break}n.have=0,n.mode=16197;case 16197:for(;n.have<n.ncode;){for(;u<3;){if(0===o)break t;o--,h+=i[s++]<<u,u+=8}n.lens[M[n.have++]]=7&h,h>>>=3,u-=3}for(;n.have<19;)n.lens[M[n.have++]]=0;if(n.lencode=n.lendyn,n.lenbits=7,E={bits:n.lenbits},x=lc(0,n.lens,0,19,n.lencode,0,n.work,E),n.lenbits=E.bits,x){t.msg="invalid code lengths set",n.mode=Mc;break}n.have=0,n.mode=16198;case 16198:for(;n.have<n.nlen+n.ndist;){for(;T=n.lencode[h&(1<<n.lenbits)-1],_=T>>>24,g=T>>>16&255,v=65535&T,!(_<=u);){if(0===o)break t;o--,h+=i[s++]<<u,u+=8}if(v<16)h>>>=_,u-=_,n.lens[n.have++]=v;else{if(16===v){for(S=_+2;u<S;){if(0===o)break t;o--,h+=i[s++]<<u,u+=8}if(h>>>=_,u-=_,0===n.have){t.msg="invalid bit length repeat",n.mode=Mc;break}y=n.lens[n.have-1],f=3+(3&h),h>>>=2,u-=2}else if(17===v){for(S=_+3;u<S;){if(0===o)break t;o--,h+=i[s++]<<u,u+=8}h>>>=_,u-=_,y=0,f=3+(7&h),h>>>=3,u-=3}else{for(S=_+7;u<S;){if(0===o)break t;o--,h+=i[s++]<<u,u+=8}h>>>=_,u-=_,y=0,f=11+(127&h),h>>>=7,u-=7}if(n.have+f>n.nlen+n.ndist){t.msg="invalid bit length repeat",n.mode=Mc;break}for(;f--;)n.lens[n.have++]=y}}if(n.mode===Mc)break;if(0===n.lens[256]){t.msg="invalid code -- missing end-of-block",n.mode=Mc;break}if(n.lenbits=9,E={bits:n.lenbits},x=lc(1,n.lens,0,n.nlen,n.lencode,0,n.work,E),n.lenbits=E.bits,x){t.msg="invalid literal/lengths set",n.mode=Mc;break}if(n.distbits=6,n.distcode=n.distdyn,E={bits:n.distbits},x=lc(2,n.lens,n.nlen,n.ndist,n.distcode,0,n.work,E),n.distbits=E.bits,x){t.msg="invalid distances set",n.mode=Mc;break}if(n.mode=Lc,e===cc)break t;case Lc:n.mode=Ec;case Ec:if(o>=6&&l>=258){t.next_out=a,t.avail_out=l,t.next_in=s,t.avail_in=o,n.hold=h,n.bits=u,nc(t,d),a=t.next_out,r=t.output,l=t.avail_out,s=t.next_in,i=t.input,o=t.avail_in,h=n.hold,u=n.bits,n.mode===yc&&(n.back=-1);break}for(n.back=0;T=n.lencode[h&(1<<n.lenbits)-1],_=T>>>24,g=T>>>16&255,v=65535&T,!(_<=u);){if(0===o)break t;o--,h+=i[s++]<<u,u+=8}if(g&&!(240&g)){for(b=_,w=g,A=v;T=n.lencode[A+((h&(1<<b+w)-1)>>b)],_=T>>>24,g=T>>>16&255,v=65535&T,!(b+_<=u);){if(0===o)break t;o--,h+=i[s++]<<u,u+=8}h>>>=b,u-=b,n.back+=b}if(h>>>=_,u-=_,n.back+=_,n.length=v,0===g){n.mode=16205;break}if(32&g){n.back=-1,n.mode=yc;break}if(64&g){t.msg="invalid literal/length code",n.mode=Mc;break}n.extra=15&g,n.mode=16201;case 16201:if(n.extra){for(S=n.extra;u<S;){if(0===o)break t;o--,h+=i[s++]<<u,u+=8}n.length+=h&(1<<n.extra)-1,h>>>=n.extra,u-=n.extra,n.back+=n.extra}n.was=n.length,n.mode=16202;case 16202:for(;T=n.distcode[h&(1<<n.distbits)-1],_=T>>>24,g=T>>>16&255,v=65535&T,!(_<=u);){if(0===o)break t;o--,h+=i[s++]<<u,u+=8}if(!(240&g)){for(b=_,w=g,A=v;T=n.distcode[A+((h&(1<<b+w)-1)>>b)],_=T>>>24,g=T>>>16&255,v=65535&T,!(b+_<=u);){if(0===o)break t;o--,h+=i[s++]<<u,u+=8}h>>>=b,u-=b,n.back+=b}if(h>>>=_,u-=_,n.back+=_,64&g){t.msg="invalid distance code",n.mode=Mc;break}n.offset=v,n.extra=15&g,n.mode=16203;case 16203:if(n.extra){for(S=n.extra;u<S;){if(0===o)break t;o--,h+=i[s++]<<u,u+=8}n.offset+=h&(1<<n.extra)-1,h>>>=n.extra,u-=n.extra,n.back+=n.extra}if(n.offset>n.dmax){t.msg="invalid distance too far back",n.mode=Mc;break}n.mode=16204;case 16204:if(0===l)break t;if(f=d-l,n.offset>f){if(f=n.offset-f,f>n.whave&&n.sane){t.msg="invalid distance too far back",n.mode=Mc;break}f>n.wnext?(f-=n.wnext,p=n.wsize-f):p=n.wnext-f,f>n.length&&(f=n.length),m=n.window}else m=r,p=a-n.offset,f=n.length;f>l&&(f=l),l-=f,n.length-=f;do{r[a++]=m[p++]}while(--f);0===n.length&&(n.mode=Ec);break;case 16205:if(0===l)break t;r[a++]=n.length,l--,n.mode=Ec;break;case Sc:if(n.wrap){for(;u<32;){if(0===o)break t;o--,h|=i[s++]<<u,u+=8}if(d-=l,t.total_out+=d,n.total+=d,4&n.wrap&&d&&(t.adler=n.check=n.flags?Ih(n.check,r,d,a-d):kh(n.check,r,d,a-d)),d=l,4&n.wrap&&(n.flags?h:kc(h))!==n.check){t.msg="incorrect data check",n.mode=Mc;break}h=0,u=0}n.mode=16207;case 16207:if(n.wrap&&n.flags){for(;u<32;){if(0===o)break t;o--,h+=i[s++]<<u,u+=8}if(4&n.wrap&&h!==(4294967295&n.total)){t.msg="incorrect length check",n.mode=Mc;break}h=0,u=0}n.mode=16208;case 16208:x=fc;break t;case Mc:x=_c;break t;case 16210:return gc;default:return mc}return t.next_out=a,t.avail_out=l,t.next_in=s,t.avail_in=o,n.hold=h,n.bits=u,(n.wsize||d!==t.avail_out&&n.mode<Mc&&(n.mode<Sc||e!==hc))&&Vc(t,t.output,t.next_out,d-t.avail_out),c-=t.avail_in,d-=t.avail_out,t.total_in+=c,t.total_out+=d,n.total+=d,4&n.wrap&&d&&(t.adler=n.check=n.flags?Ih(n.check,r,d,t.next_out-d):kh(n.check,r,d,t.next_out-d)),t.data_type=n.bits+(n.last?64:0)+(n.mode===yc?128:0)+(n.mode===Lc||n.mode===Tc?256:0),(0===c&&0===d||e===hc)&&x===dc&&(x=vc),x},Kc={inflateReset:Oc,inflateReset2:Cc,inflateResetKeep:Uc,inflateInit:t=>Bc(t,15),inflateInit2:Bc,inflate:Gc,inflateEnd:t=>{if(Ic(t))return mc;let e=t.state;return e.window&&(e.window=null),t.state=null,dc},inflateGetHeader:(t,e)=>{if(Ic(t))return mc;const n=t.state;return 2&n.wrap?(n.head=e,e.done=!1,dc):mc},inflateSetDictionary:(t,e)=>{const n=e.length;let i,r,s;return Ic(t)?mc:(i=t.state,0!==i.wrap&&i.mode!==Ac?mc:i.mode===Ac&&(r=1,r=kh(r,e,n,0),r!==i.check)?_c:(s=Vc(t,e,n,n),s?(i.mode=16210,gc):(i.havedict=1,dc)))},inflateInfo:"pako inflate (from Nodeca project)"};var jc=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1};const zc=Object.prototype.toString,{Z_NO_FLUSH:Hc,Z_FINISH:Xc,Z_OK:qc,Z_STREAM_END:Yc,Z_NEED_DICT:$c,Z_STREAM_ERROR:Wc,Z_DATA_ERROR:Zc,Z_MEM_ERROR:Jc}=Oh;function Qc(t){this.options=Cu({chunkSize:65536,windowBits:15,to:""},t||{});const e=this.options;e.raw&&e.windowBits>=0&&e.windowBits<16&&(e.windowBits=-e.windowBits,0===e.windowBits&&(e.windowBits=-15)),!(e.windowBits>=0&&e.windowBits<16)||t&&t.windowBits||(e.windowBits+=32),e.windowBits>15&&e.windowBits<48&&(15&e.windowBits||(e.windowBits|=15)),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new Gu,this.strm.avail_out=0;let n=Kc.inflateInit2(this.strm,e.windowBits);if(n!==qc)throw new Error(Uh[n]);if(this.header=new jc,Kc.inflateGetHeader(this.strm,this.header),e.dictionary&&("string"==typeof e.dictionary?e.dictionary=Du(e.dictionary):"[object ArrayBuffer]"===zc.call(e.dictionary)&&(e.dictionary=new Uint8Array(e.dictionary)),e.raw&&(n=Kc.inflateSetDictionary(this.strm,e.dictionary),n!==qc)))throw new Error(Uh[n])}function td(t,e){const n=new Qc(e);if(n.push(t),n.err)throw n.msg||Uh[n.err];return n.result}Qc.prototype.push=function(t,e){const n=this.strm,i=this.options.chunkSize,r=this.options.dictionary;let s,a,o;if(this.ended)return!1;for(a=e===~~e?e:!0===e?Xc:Hc,"[object ArrayBuffer]"===zc.call(t)?n.input=new Uint8Array(t):n.input=t,n.next_in=0,n.avail_in=n.input.length;;){for(0===n.avail_out&&(n.output=new Uint8Array(i),n.next_out=0,n.avail_out=i),s=Kc.inflate(n,a),s===$c&&r&&(s=Kc.inflateSetDictionary(n,r),s===qc?s=Kc.inflate(n,a):s===Zc&&(s=$c));n.avail_in>0&&s===Yc&&n.state.wrap>0&&0!==t[n.next_in];)Kc.inflateReset(n),s=Kc.inflate(n,a);switch(s){case Wc:case Zc:case $c:case Jc:return this.onEnd(s),this.ended=!0,!1}if(o=n.avail_out,n.next_out&&(0===n.avail_out||s===Yc))if("string"===this.options.to){let t=Vu(n.output,n.next_out),e=n.next_out-t,r=Fu(n.output,t);n.next_out=e,n.avail_out=i-e,e&&n.output.set(n.output.subarray(t,t+e),0),this.onData(r)}else this.onData(n.output.length===n.next_out?n.output:n.output.subarray(0,n.next_out));if(s!==qc||0!==o){if(s===Yc)return s=Kc.inflateEnd(this.strm),this.onEnd(s),this.ended=!0,!0;if(0===n.avail_in)break}}return!0},Qc.prototype.onData=function(t){this.chunks.push(t)},Qc.prototype.onEnd=function(t){t===qc&&("string"===this.options.to?this.result=this.chunks.join(""):this.result=Bu(this.chunks)),this.chunks=[],this.err=t,this.msg=this.strm.msg};var ed={Inflate:Qc,inflate:td,inflateRaw:function(t,e){return(e=e||{}).raw=!0,td(t,e)},ungzip:td,constants:Oh};const{Deflate:nd,deflate:id,deflateRaw:rd,gzip:sd}=tc,{Inflate:ad,inflate:od,inflateRaw:ld,ungzip:hd}=ed;var ud=id,cd=od;class dd{constructor(t){this.ctype=0,this.outputPos=0,this.dsize_bits=0,this.dsize_mask=0,this.bit_buff=0,this.extra_bits=0,this.in_pos=0,this.out_buff=[],this.in_buff=t}}const fd=new Uint8Array([2,4,4,5,5,5,5,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8,8]),pd=new Uint8Array([3,13,5,25,9,17,1,62,30,46,14,54,22,38,6,58,26,42,10,50,18,34,66,2,124,60,92,28,108,44,76,12,116,52,84,20,100,36,68,4,120,56,88,24,104,40,72,8,240,112,176,48,208,80,144,16,224,96,160,32,192,64,128,0]),md=new Uint8Array([0,0,0,0,0,0,0,0,1,2,3,4,5,6,7,8]),_d=new Uint16Array([0,1,2,3,4,5,6,7,8,10,14,22,38,70,134,262]),gd=new Uint8Array([3,2,3,3,4,4,4,5,5,5,5,6,6,6,7,7]),vd=new Uint8Array([5,3,1,6,10,2,12,20,4,24,8,48,16,32,64,0]),bd=new Uint8Array([11,12,12,12,12,12,12,12,12,8,7,12,12,7,12,12,12,12,12,12,12,12,12,12,12,12,13,12,12,12,12,12,4,10,8,12,10,12,10,8,7,7,8,9,7,6,7,8,7,6,7,7,7,7,8,7,7,8,8,12,11,7,9,11,12,6,7,6,6,5,7,8,8,6,11,9,6,7,6,6,7,11,6,6,6,7,9,8,9,9,11,8,11,9,12,8,12,5,6,6,6,5,6,6,6,5,11,7,5,6,5,5,6,10,5,5,5,5,8,7,8,8,10,11,11,12,12,12,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,12,13,12,13,13,13,12,13,13,13,12,13,13,13,13,12,13,13,13,12,12,12,13,13,13,13,13,13,13,13,13,13,13]),wd=new Uint16Array([1168,4064,2016,3040,992,3552,1504,2528,480,184,98,3808,1760,34,2784,736,3296,1248,2272,224,3936,1888,2912,864,3424,1376,4672,2400,352,3680,1632,2656,15,592,56,608,80,3168,912,216,66,2,88,432,124,41,60,152,92,9,28,108,44,76,24,12,116,232,104,1120,144,52,176,1808,2144,49,84,17,33,23,20,168,40,1,784,304,62,100,30,46,36,1296,14,54,22,68,48,200,464,208,272,72,1552,336,96,136,4e3,7,38,6,58,27,26,42,10,11,528,4,19,50,3,29,18,400,13,21,5,25,8,120,240,112,656,1040,16,1952,2976,928,576,7232,3136,5184,1088,6208,2112,4160,64,8064,3968,6016,1920,7040,2944,4992,896,7552,3456,5504,1408,6528,2432,4480,384,7808,3712,5760,1664,6784,2688,4736,640,7296,3200,5248,1152,6272,2176,4224,128,7936,3840,5888,1792,6912,2816,4864,3488,1440,2464,416,3744,1696,2720,672,3232,1184,2208,160,3872,1824,2848,800,3360,1312,2336,288,3616,1568,2592,544,3104,1056,2080,32,4032,1984,3008,960,3520,1472,2496,448,3776,1728,2752,704,3264,1216,2240,192,3904,1856,2880,832,768,3392,7424,3328,5376,1344,1280,6400,2304,2368,4352,256,7680,3584,320,5632,1536,6656,3648,1600,2624,2560,4608,512,7168,3072,5120,1024,6144,2048,4096,0]);let Ad=!1;const yd=new Uint8Array(256),xd=new Uint8Array(256);let Td=!1;const Ld=new Uint8Array(256),Ed=new Uint8Array(256),Sd=new Uint8Array(128),Md=new Uint8Array(256);function kd(t,e,n){for(let i=0,r=e.length;i<r;i++){const r=1<<n[i];for(let n=e[i];n<256;n+=r)t[n]=i}}function Rd(t,e){return e<=t.extra_bits?(t.extra_bits-=e,t.bit_buff>>=e,0):(t.bit_buff>>=t.extra_bits,t.in_pos===t.in_buff.byteLength?1:(t.bit_buff|=t.in_buff[t.in_pos++]<<8,t.bit_buff>>=e-t.extra_bits,t.extra_bits=t.extra_bits-e+8,0))}function Id(t){if(1&t.bit_buff){if(Rd(t,1))return 774;let e,n=xd[255&t.bit_buff];if(Rd(t,gd[n]))return 774;if(0!=(e=md[n])){const i=t.bit_buff&(1<<e)-1;if(Rd(t,e)&&n+i!=270)return 774;n=_d[n]+i}return n+256}if(Rd(t,1))return 774;if(0==t.ctype){const e=255&t.bit_buff;return Rd(t,8)?774:e}let e;if(255&t.bit_buff){if(e=Ld[255&t.bit_buff],255==e)if(63&t.bit_buff){if(Rd(t,4))return 774;e=Ed[255&t.bit_buff]}else{if(Rd(t,6))return 774;e=Sd[127&t.bit_buff]}}else{if(Rd(t,8))return 774;e=Md[255&t.bit_buff]}return Rd(t,bd[e])?774:e}function Ud(t,e){const n=yd[255&t.bit_buff];if(Rd(t,fd[n]))return 0;let i;if(2==e){if(i=n<<2|3&t.bit_buff,Rd(t,2))return 0}else if(i=n<<t.dsize_bits|t.bit_buff&t.dsize_mask,Rd(t,t.dsize_bits))return 0;return i+1}function Od(t){const e=new dd(t);if(e.in_buff.byteLength<=4)throw new Error("Bad data");if(e.ctype=e.in_buff[0],e.dsize_bits=e.in_buff[1],e.bit_buff=e.in_buff[2],e.extra_bits=0,e.in_pos=3,4>e.dsize_bits||e.dsize_bits>6)throw new Error("Invalid dictionary size");if(e.dsize_mask=65535>>16-e.dsize_bits,0!==e.ctype){if(1!==e.ctype)throw new Error("Invalid mode");Td||(!function(){let t,e,n=255;for(let i=255;n>=0;n--,i--){const r=i;let s=bd[r];if(s<=8){e=1<<s,t=wd[n];do{Ld[t]=i,t+=e}while(t<256)}else if(0!=(t=255&wd[n]))if(Ld[t]=255,63&wd[n]){s-=4,bd[r]=s,e=1<<s,t=wd[n]>>4;do{Ed[t]=i,t+=e}while(t<256)}else{s-=6,bd[r]=s,e=1<<s,t=wd[n]>>6;do{Sd[t]=i,t+=e}while(t<128)}else{s-=8,bd[r]=s,e=1<<s,t=wd[n]>>8;do{Md[t]=i,t+=e}while(t<256)}}}(),Td=!0)}if(Ad||(kd(xd,vd,gd),kd(yd,pd,fd),Ad=!0),774===function(t){let e;for(;(e=Id(t))<773;)if(e>=256){let n,i=e-254;if(0==(n=Ud(t,i)))return 774;let r=t.outputPos,s=r-n;for(t.outputPos+=i;i-- >0;)t.out_buff[r++]=t.out_buff[s++]}else t.out_buff[t.outputPos++]=e;return e}(e))throw new Error("Error while expanding");return new Uint8Array(e.out_buff)}function Cd(t){let e=-1;for(let n=0,i=Math.ceil(t.byteLength/512);n<i;n++){const i=512*n;77===t[i]&&80===t[i+1]&&81===t[i+2]&&26===t[i+3]&&(e=i)}return e}function Bd(t){return 72===t[0]&&77===t[1]&&51===t[2]&&87===t[3]||-1!==Cd(t)}class Pd{constructor(t,e,n,i,r){this.rawBuffer=null,this.buffer=null;const s=t.headerOffset;this.archive=t,this.c=t.c,this.name=`File${`${e.blockIndex}`.padStart(8,"0")}`,this.nameResolved=!1,this.hash=e,this.block=n,i&&(this.rawBuffer=i.slice(s+n.offset,s+n.offset+n.compressedSize)),r&&(this.buffer=r)}bytes(){return null===this.buffer&&this.decode(),this.buffer}arrayBuffer(){return this.bytes().buffer}text(){return Ga(this.bytes())}set(t){if(this.archive.readonly)return!1;const e=this.hash,n=this.block;return e.locale=0,e.platform=0,n.compressedSize=0,n.normalSize=t.byteLength,n.flags=0,this.buffer=t,this.rawBuffer=null,!0}delete(){if(this.archive.readonly)return!1;const t=this.archive,e=this.hash,n=e.blockIndex;e.delete();for(const e of t.hashTable.entries)e.blockIndex<Il&&e.blockIndex>n&&(e.blockIndex-=1);return t.blockTable.entries.splice(n,1),t.files.splice(n,1),!0}rename(t){if(this.archive.readonly)return!1;const e=this.hash,n=e.locale,i=e.platform,r=e.blockIndex;e.delete();const s=this.archive.hashTable.add(t,r);return s.locale=n,s.platform=i,this.name=t,this.nameResolved=!0,this.hash=s,!0}decode(){if(!this.rawBuffer)throw new Error(`File ${this.name}: Nothing to decode`);const t=this.archive,e=this.block,n=t.c,i=n.computeFileKey(this.name,e),r=this.rawBuffer,s=e.flags;if(s===Nl)this.buffer=r.slice(0,e.normalSize);else if(s&Pl){let t;t=s&Cl?n.decryptBlock(r.slice(0,e.compressedSize),i):r.subarray(0,e.compressedSize),t=512&s?this.decompressSector(t,e.normalSize):t.slice(),this.buffer=t}else{const a=Math.ceil(e.normalSize/t.sectorSize),o=new Uint8Array(e.normalSize);let l=new Uint32Array(r.buffer,0,a+1);s&Cl&&(l=n.decryptBlock(l.slice(),i-1));let h=l[0],u=l[1],c=0;for(let d=0;d<a;d++){let f;if(f=s&Cl?n.decryptBlock(r.slice(h,u),i+d):r.subarray(h,u),512&s){let n=t.sectorSize;e.normalSize-c<n&&(n=e.normalSize-c),f=this.decompressSector(f,n)}256&s&&(f=Od(f)),o.set(f,c),c+=f.byteLength,d<a&&(h=u,u=l[d+2])}this.buffer=o}t.readonly&&(this.rawBuffer=null)}decompressSector(t,e){if(t.byteLength===e)return t;{const e=t[0];if(16&e)throw new Error(`File ${this.name}: compression type 'bzip2' not supported`);if(8&e)try{t=Od(t.subarray(1))}catch(t){throw new Error(`File ${this.name}: failed to decompress with 'explode': ${t}`)}if(2&e)try{t=cd(t.subarray(1))}catch(t){throw new Error(`File ${this.name}: failed to decompress with 'zlib': ${t}`)}if(1&e)throw new Error(`File ${this.name}: compression type 'huffman' not supported`);if(128&e)throw new Error(`File ${this.name}: compression type 'adpcm stereo' not supported`);if(64&e)throw new Error(`File ${this.name}: compression type 'adpcm mono' not supported`);return t}}encode(){if(null!==this.buffer&&null===this.rawBuffer){const t=this.buffer;if(Bd(t))this.rawBuffer=this.buffer,this.block.compressedSize=this.buffer.byteLength,this.block.flags=Nl;else{const e=this.archive.sectorSize,n=Math.ceil(t.byteLength/e),i=new Uint32Array(n+1);let r=i.byteLength;const s=[],a=[];i[0]=r;for(let o=0;o<n;o++){const n=o*e;let l=t.subarray(n,n+e),h=l.byteLength;const u=ud(l);let c=!1;u.byteLength+1<h&&(l=u,h=u.byteLength+1,c=!0),r+=h,i[o+1]=r,s[o]=l,a[o]=c}if(r<t.byteLength){const t=new Uint8Array(r);t.set(new Uint8Array(i.buffer)),r=i.byteLength;for(let e=0;e<n;e++){a[e]&&(t[r]=2,r+=1);const n=s[e];t.set(n,r),r+=n.byteLength}this.rawBuffer=t,this.block.compressedSize=t.byteLength,this.block.flags=2147484160}else this.rawBuffer=this.buffer,this.block.compressedSize=this.buffer.byteLength,this.block.flags=Nl}}}reEncrypt(t){if(!this.rawBuffer)return!1;const e=this.archive,n=this.block,i=e.c,r=this.rawBuffer,s=n.flags,a=i.computeFileKey(this.name,n);n.offset=t;const o=i.computeFileKey(this.name,n);if(s&Pl)i.decryptBlock(r,a),i.encryptBlock(r,o);else{const t=Math.ceil(n.normalSize/e.sectorSize),s=new Uint32Array(r.buffer,0,t+1);i.decryptBlock(s,a-1);let l=s[0],h=s[1];for(let e=0;e<t;e++){const n=r.subarray(l,h);i.decryptBlock(n,a+e),i.encryptBlock(n,o+e),e<t&&(l=h,h=s[e+2])}i.encryptBlock(s,o-1)}return!0}offsetChanged(t){const e=this.block;return e.offset!==t&&e.flags&Bl?!!this.nameResolved&&this.reEncrypt(t):(e.offset=t,!0)}}class Nd{constructor(){this.nameA=4294967295,this.nameB=4294967295,this.locale=65535,this.platform=65535,this.blockIndex=Ul}load(t){const e=t[2];this.nameA=t[0],this.nameB=t[1],this.locale=65535&e,this.platform=e>>>16,this.blockIndex=t[3]}copy(t){this.nameA=t.nameA,this.nameB=t.nameB,this.locale=t.locale,this.platform=t.platform,this.blockIndex=t.blockIndex}save(t){t[0]=this.nameA,t[1]=this.nameB,t[2]=this.locale<<16|this.platform,t[3]=this.blockIndex}delete(){this.nameA=4294967295,this.nameB=4294967295,this.locale=65535,this.platform=65535,this.blockIndex=Il}}class Dd{constructor(t){this.c=t,this.entries=[],this.addEmpties(4)}clear(){this.entries.length=0}addEmpties(t){for(let e=0;e<t;e++)this.entries.push(new Nd)}getInsertionIndex(t){const e=this.entries,n=this.c.hash(t,0)&e.length-1;for(let t=0,i=e.length;t<i;t++){const r=(t+n)%i;if(65535===e[r].platform)return r}return-1}add(t,e){const n=this.getInsertionIndex(t);if(-1!==n){const i=this.entries[n];return i.nameA=this.c.hash(t,1),i.nameB=this.c.hash(t,2),i.locale=0,i.platform=0,i.blockIndex=e,i}}load(t){const e=t.byteLength/16,n=new Uint32Array(this.c.decryptBlock(t,Rl).buffer);let i=0;this.clear(),this.addEmpties(e);for(const t of this.entries)t.load(n.subarray(i,i+4)),i+=4}save(t){const e=new Uint32Array(4*this.entries.length);let n=0;for(const t of this.entries)t.save(e.subarray(n,n+4)),n+=4;const i=new Uint8Array(e.buffer);this.c.encryptBlock(i,Rl),t.set(i)}get(t){const e=this.c,n=this.entries,i=e.hash(t,0)&n.length-1,r=e.hash(t,1),s=e.hash(t,2);for(let t=0,e=n.length;t<e;t++){const a=n[(t+i)%e];if(r===a.nameA&&s===a.nameB)return a;if(4294967295===a.blockIndex)return null}return null}}class Fd{constructor(){this.readonly=!1,this.headerOffset=0,this.sectorSize=4096,this.c=new Gl,this.hashTable=new Dd(this.c),this.blockTable=new Dl(this.c),this.files=[]}load(t,e=!1){const n=za(t);this.readonly=e;const i=Cd(n);if(-1===i)throw new Error("No MPQ header");const r=new Uint32Array(n.buffer,i,8),s=r[3],a=_o(r[4]+i),o=_o(r[5]+i),l=r[6];let h=r[7];h>l&&(h=l),this.headerOffset=i,this.sectorSize=512*(1<<(s>>>16)),this.hashTable.load(n.slice(a,a+16*l)),this.blockTable.load(n.slice(o,o+16*h)),this.files.length=0;for(const t of this.hashTable.entries){const e=t.blockIndex;e<this.blockTable.entries.length&&(this.files[e]=new Pd(this,t,this.blockTable.entries[e],n,null))}const u=this.get("(listfile)");if(u){const t=u.text();if(t)for(const e of t.split("\r\n"))this.get(e)}}save(){if(this.readonly)return null;const t=32;this.delete("(attributes)"),this.saveMemory(),this.set("(listfile)",this.getFileNames().join("\r\n"));let e=t;for(const t of this.files)if(t){if(!t.offsetChanged(e))return null;t.encode(),e+=t.block.compressedSize}const n=this.hashTable,i=this.blockTable,r=n.entries.length,s=i.entries.length,a=e-t,o=t+a+16*r+16*s,l=t+a,h=l+16*r,u=new Uint8Array(o),c=new Uint32Array(u.buffer,0,8);c[0]=441536589,c[1]=t,c[2]=o,c[3]=Math.log2(this.sectorSize/512)<<16,c[4]=l,c[5]=h,c[6]=r,c[7]=s,e=t;for(const t of this.files)t&&(t.rawBuffer&&u.set(t.rawBuffer,e),e+=t.block.compressedSize);return n.save(u.subarray(e,e+16*n.entries.length)),e+=16*n.entries.length,i.save(u.subarray(e,e+16*i.entries.length)),u}saveMemory(){if(this.readonly)return 0;const t=this.blockTable.entries,e=this.hashTable.entries;let n=t.length,i=0;for(;n--;){const r=t[n];if(0===r.normalSize)this.removeBlock(n),i+=r.compressedSize;else{let t=!1;for(const i of e)if(i.blockIndex===n){t=!0;break}t||(this.removeBlock(n),i+=r.compressedSize)}}return i}removeBlock(t){for(const e of this.hashTable.entries)e.blockIndex<Il&&e.blockIndex>t&&(e.blockIndex-=1);this.blockTable.entries.splice(t,1)}getFileNames(){const t=[];for(const e of this.files)e&&""!==e.name&&t.push(e.name);return t}countUnresolved(){let t=0;for(const e of this.files)e.nameResolved||t++;return t}applyListfile(t){for(const e of t)this.get(e)}set(t,e){if(this.readonly)return!1;const n=za(e);let i=this.get(t);if(i)i.set(n);else{const e=this.blockTable.entries.length,r=this.hashTable.add(t,e);if(!r)return!1;const s=this.blockTable.add(n);i=new Pd(this,r,s,null,n),i.name=t,i.nameResolved=!0,this.files[e]=i}return!0}get(t){const e=this.hashTable.get(t);if(e){const n=e.blockIndex;if(n<Il){const e=this.files[n];if(e)return e.name=t,e.nameResolved=!0,e}}return null}has(t){return!!this.get(t)}delete(t){if(this.readonly)return!1;const e=this.get(t);return!!e&&(e.delete(),!0)}rename(t,e){if(this.readonly)return!1;const n=this.get(t);return!!n&&(n.rename(e),!0)}resizeHashtable(t){if(this.readonly)return!1;t=Math.max(4,Ea(t));const e=this.files;if(e.length>t)return!1;for(const t of e)if(!t.nameResolved)return!1;const n=this.hashTable,i=n.entries,r=i.slice();n.clear(),n.addEmpties(t);for(const t of r)if(t.blockIndex!==Ul){const r=e[t.blockIndex];i[n.getInsertionIndex(r.name)].copy(t)}return!0}}class Vd{constructor(){this.isCustom=0,this.path=""}load(t){this.isCustom=t.readUint8(),this.path=t.readNull()}save(t){t.writeUint8(this.isCustom),t.writeNull(this.path)}getByteLength(){return 2+ja(this.path)}}class Gd{constructor(){this.version=1,this.entries=new Map}load(t){const e=new bo(t);this.version=e.readUint32();for(let t=0,n=e.readUint32();t<n;t++){const t=new Vd;t.load(e),t.isCustom?this.entries.set(t.path,t):this.entries.set(`war3mapimported\\${t.path}`,t)}}save(){const t=new bo(new ArrayBuffer(this.getByteLength()));t.writeUint32(this.version),t.writeUint32(this.entries.size);for(const e of this.entries.values())e.save(t);return t.uint8array}getByteLength(){let t=8;for(const e of this.entries.values())t+=e.getByteLength();return t}set(t){if(!this.entries.has(t)){const e=new Vd;return e.isCustom=10,e.path=t,this.entries.set(t,e),!0}return!1}has(t){return this.entries.has(t)}delete(t){return this.entries.delete(t)}rename(t,e){const n=this.entries.get(t);return!!n&&(n.isCustom=10,n.path=e,!0)}}class Kd{constructor(){this.id="\0\0\0\0",this.variableType=0,this.levelOrVariation=0,this.dataPointer=0,this.value=0,this.u1=0}load(t,e){if(this.id=t.readBinary(4),this.variableType=t.readInt32(),e&&(this.levelOrVariation=t.readInt32(),this.dataPointer=t.readInt32()),0===this.variableType)this.value=t.readInt32();else if(1===this.variableType||2===this.variableType)this.value=t.readFloat32();else{if(3!==this.variableType)throw new Error(`Modification: unknown variable type ${this.variableType}`);this.value=t.readNull()}this.u1=t.readInt32()}save(t,e){if(t.writeBinary(this.id),t.writeInt32(this.variableType),e&&(t.writeInt32(this.levelOrVariation),t.writeInt32(this.dataPointer)),0===this.variableType)t.writeInt32(this.value);else if(1===this.variableType||2===this.variableType)t.writeFloat32(this.value);else{if(3!==this.variableType)throw new Error(`Modification: unknown variable type ${this.variableType}`);t.writeNull(this.value)}t.writeInt32(this.u1)}getByteLength(t){let e=12;return t&&(e+=8),3===this.variableType?e+=ja(this.value)+1:e+=4,e}}class jd{constructor(){this.oldId="\0\0\0\0",this.newId="\0\0\0\0",this.modifications=[]}load(t,e){this.oldId=t.readBinary(4),this.newId=t.readBinary(4);for(let n=0,i=t.readUint32();n<i;n++){const i=new Kd;i.load(t,e),this.modifications[n]=i}}save(t,e){"\0\0\0\0"!==this.oldId?t.writeBinary(this.oldId):t.writeUint32(0),"\0\0\0\0"!==this.newId?t.writeBinary(this.newId):t.writeUint32(0),t.writeUint32(this.modifications.length);for(const n of this.modifications)n.save(t,e)}getByteLength(t){let e=12;for(const n of this.modifications)e+=n.getByteLength(t);return e}}class zd{constructor(){this.objects=[]}load(t,e){for(let n=0,i=t.readUint32();n<i;n++){const i=new jd;i.load(t,e),this.objects[n]=i}}save(t,e){t.writeUint32(this.objects.length);for(const n of this.objects)n.save(t,e)}getByteLength(t){let e=4;for(const n of this.objects)e+=n.getByteLength(t);return e}}class Hd{constructor(){this.version=0,this.originalTable=new zd,this.customTable=new zd}load(t){let e;e=t instanceof bo?t:new bo(t),this.version=e.readInt32(),this.originalTable.load(e,!0),this.customTable.load(e,!0)}save(){const t=new bo(new ArrayBuffer(this.getByteLength()));return t.writeInt32(this.version),this.originalTable.save(t,!0),this.customTable.save(t,!0),t.uint8array}getByteLength(){return 4+this.originalTable.getByteLength(!0)+this.customTable.getByteLength(!0)}}class Xd{constructor(){this.version=0,this.originalTable=new zd,this.customTable=new zd}load(t){let e;e=t instanceof bo?t:new bo(t),this.version=e.readInt32(),this.originalTable.load(e,!1),this.customTable.load(e,!1)}save(){const t=new bo(new ArrayBuffer(this.getByteLength()));return t.writeInt32(this.version),this.originalTable.save(t,!1),this.customTable.save(t,!1),t.uint8array}getByteLength(){return 4+this.originalTable.getByteLength(!1)+this.customTable.getByteLength(!1)}}class qd{constructor(){this.text=""}load(t){const e=t.readInt32();e&&(this.text=t.read(e-1),t.skip(1))}save(t){this.text.length?(t.writeInt32(ja(this.text)+1),t.write(this.text),t.skip(1)):t.writeInt32(0)}getByteLength(){let t=4;return this.text.length&&(t+=ja(this.text)+1),t}}class Yd{constructor(){this.version=0,this.comment="",this.trigger=new qd,this.triggers=[]}load(t){const e=new bo(t);this.version=e.readInt32(),1===this.version&&(this.comment=e.readNull(),this.trigger.load(e));for(let t=0,n=e.readUint32();t<n;t++){const n=new qd;n.load(e),this.triggers[t]=n}}save(){const t=new bo(new ArrayBuffer(this.getByteLength()));t.writeInt32(this.version),1===this.version&&(t.writeNull(this.comment),this.trigger.save(t)),t.writeUint32(this.triggers.length);for(const e of this.triggers)e.save(t);return t.uint8array}getByteLength(){let t=8;1===this.version&&(t+=ja(this.comment)+1+this.trigger.getByteLength());for(const e of this.triggers)t+=e.getByteLength();return t}}class $d{constructor(){this.id=0,this.name="",this.isComment=0}load(t,e){this.id=t.readInt32(),this.name=t.readNull(),7===e&&(this.isComment=t.readInt32())}save(t,e){t.writeInt32(this.id),t.writeNull(this.name),7===e&&t.writeInt32(this.isComment)}getByteLength(t){let e=5+ja(this.name);return 7===t&&(e+=4),e}}class Wd{constructor(){this.name="",this.type="",this.u1=0,this.isArray=0,this.arraySize=0,this.isInitialized=0,this.initialValue=""}load(t,e){this.name=t.readNull(),this.type=t.readNull(),this.u1=t.readInt32(),this.isArray=t.readInt32(),7===e&&(this.arraySize=t.readInt32()),this.isInitialized=t.readInt32(),this.initialValue=t.readNull()}save(t,e){t.writeNull(this.name),t.writeNull(this.type),t.writeInt32(this.u1),t.writeInt32(this.isArray),7===e&&t.writeInt32(this.arraySize),t.writeInt32(this.isInitialized),t.writeNull(this.initialValue)}getByteLength(t){let e=15+ja(this.name)+ja(this.type)+ja(this.initialValue);return 7===t&&(e+=4),e}}class Zd{constructor(){this.type=0,this.name="",this.beginParameters=0,this.parameters=[]}load(t,e,n){if(this.type=t.readInt32(),this.type<0||this.type>3)throw new Error(`SubParameters: Bad type: ${this.type}`);if(this.name=t.readNull(),0===this.name.length)throw new Error("SubParameters: Empty name");if(this.beginParameters=t.readInt32(),this.beginParameters){const i=n.getFunction(this.type,this.name);if(!i)throw new Error(`SubParameters "${this.name}:${this.type}": Unknown signature`);for(let r=0,s=i.args.length;r<s;r++){const i=new Jd;try{i.load(t,e,n)}catch(t){throw new Error(`SubParameters "${this.name}": Parameter ${r}: ${t}`)}this.parameters[r]=i}}}save(t,e){t.writeInt32(this.type),t.writeNull(this.name),t.writeInt32(this.beginParameters);for(const n of this.parameters)n.save(t,e)}getByteLength(t){let e=9+ja(this.name);if(this.parameters.length)for(const n of this.parameters)e+=n.getByteLength(t);return e}}class Jd{constructor(){this.type=0,this.value="",this.subParameters=null,this.u1=0,this.isArray=0,this.arrayIndex=null}load(t,e,n){if(this.type=t.readInt32(),this.type<-1||this.type>3)throw new Error(`Parameter: Bad type: ${this.type}`);if(this.value=t.readNull(),t.readInt32()){const i=new Zd;try{i.load(t,e,n)}catch(t){throw new Error(`Parameter "${this.value}": SubParameters ${t}`)}this.subParameters=i}if((4===e&&2===this.type||7===e&&this.subParameters)&&(this.u1=t.readInt32()),(4===e&&2!==this.type||7===e)&&(this.isArray=t.readInt32()),this.isArray){const i=new Jd;try{i.load(t,e,n)}catch(t){throw new Error(`Parameter "${this.value}": ArrayIndex: ${t}`)}this.arrayIndex=i}}save(t,e){t.writeInt32(this.type),t.writeNull(this.value),this.subParameters?(t.writeInt32(1),this.subParameters.save(t,e)):t.writeInt32(0),(4===e&&2===this.type||7===e&&this.subParameters)&&t.writeInt32(this.u1),(4===e&&2!==this.type||7===e)&&t.writeInt32(this.isArray),this.isArray&&this.arrayIndex&&this.arrayIndex.save(t,e)}getByteLength(t){let e=9+ja(this.value);return this.subParameters&&(e+=this.subParameters.getByteLength(t)),(4===t&&2===this.type||7===t&&this.subParameters)&&(e+=4),(4===t&&2!==this.type||7===t)&&(e+=4),this.isArray&&this.arrayIndex&&(e+=this.arrayIndex.getByteLength(t)),e}}class Qd{constructor(){this.type=-1,this.group=-1,this.name="",this.isEnabled=0,this.parameters=[],this.ecas=[]}load(t,e,n,i){if(this.type=t.readInt32(),this.type<0||this.type>3)throw new Error(`ECA: Bad type: ${this.type}`);if(n&&(this.group=t.readUint32()),this.name=t.readNull(),0===this.name.length)throw new Error("ECA: Empty name");this.isEnabled=t.readInt32();const r=i.getFunction(this.type,this.name);if(!r)throw new Error(`ECA "${this.name}:${this.type}": Unknown signature`);for(let n=0,s=r.args.length;n<s;n++){const r=new Jd;try{r.load(t,e,i)}catch(t){throw new Error(`ECA "${this.name}": Parameter ${n}: ${t}`)}this.parameters[n]=r}if(7===e)for(let n=0,r=t.readUint32();n<r;n++){const r=new Qd;try{r.load(t,e,!0,i)}catch(t){throw new Error(`ECA "${this.name}": Child ECA ${n} ${t}`)}this.ecas[n]=r}}save(t,e){t.writeInt32(this.type),-1!==this.group&&t.writeInt32(this.group),t.writeNull(this.name),t.writeInt32(this.isEnabled);for(const n of this.parameters)n.save(t,e);if(7===e){t.writeUint32(this.ecas.length);for(const n of this.ecas)n.save(t,e)}}getByteLength(t){let e=9+ja(this.name);-1!==this.group&&(e+=4);for(const n of this.parameters)e+=n.getByteLength(t);if(7===t){e+=4;for(const n of this.ecas)e+=n.getByteLength(t)}return e}}class tf{constructor(){this.name="",this.description="",this.isComment=0,this.isEnabled=0,this.isCustom=0,this.isInitiallyOff=0,this.runOnInitialization=0,this.category=0,this.ecas=[]}load(t,e,n){this.name=t.readNull(),this.description=t.readNull(),7===e&&(this.isComment=t.readInt32()),this.isEnabled=t.readInt32(),this.isCustom=t.readInt32(),this.isInitiallyOff=t.readInt32(),this.runOnInitialization=t.readInt32(),this.category=t.readInt32();for(let i=0,r=t.readUint32();i<r;i++){const r=new Qd;try{r.load(t,e,!1,n)}catch(t){throw new Error(`Trigger "${this.name}": ECA ${i}: ${t}`)}this.ecas[i]=r}}save(t,e){t.writeNull(this.name),t.writeNull(this.description),7===e&&t.writeInt32(this.isComment),t.writeInt32(this.isEnabled),t.writeInt32(this.isCustom),t.writeInt32(this.isInitiallyOff),t.writeInt32(this.runOnInitialization),t.writeInt32(this.category),t.writeUint32(this.ecas.length);for(const n of this.ecas)n.save(t,e)}getByteLength(t){let e=26+ja(this.name)+ja(this.description);7===t&&(e+=4);for(const n of this.ecas)e+=n.getByteLength(t);return e}}class ef{constructor(){this.version=0,this.categories=[],this.u1=0,this.variables=[],this.triggers=[]}load(t,e){const n=new bo(t);if("WTG!"!==n.readBinary(4))throw new Error("Not a WTG file");this.version=n.readInt32();for(let t=0,e=n.readUint32();t<e;t++){const e=new $d;e.load(n,this.version),this.categories[t]=e}this.u1=n.readInt32();for(let t=0,e=n.readUint32();t<e;t++){const e=new Wd;e.load(n,this.version),this.variables[t]=e}for(let t=0,i=n.readUint32();t<i;t++){const i=new tf;try{i.load(n,this.version,e)}catch(e){throw new Error(`Trigger ${t}: ${e}`)}this.triggers[t]=i}}save(){const t=new bo(new ArrayBuffer(this.getByteLength()));t.writeBinary("WTG!"),t.writeInt32(this.version),t.writeUint32(this.categories.length);for(const e of this.categories)e.save(t,this.version);t.writeInt32(this.u1),t.writeUint32(this.variables.length);for(const e of this.variables)e.save(t,this.version);t.writeUint32(this.triggers.length);for(const e of this.triggers)e.save(t,this.version);return t.uint8array}getByteLength(){let t=24;const e=this.version;for(const n of this.categories)t+=n.getByteLength(e);for(const n of this.variables)t+=n.getByteLength(e);for(const n of this.triggers)t+=n.getByteLength(e);return t}}class nf{constructor(){this.stringMap=new Map}load(t){const e=new $o(t);let n;const i=t.indexOf("STRING");if(-1===i)throw new Error("Not a valid war3map.wts buffer");for(e.index=i;n=e.readToken();)if("STRING"===n){const n=e.readInt();e.read();const i=t.indexOf("}",e.index);if(-1===i)throw this.stringMap.set(n,t.slice(e.index,t.length).trim()),new Error(`WTS: missing data in string ${this.stringMap.size} (and maybe more)`);this.stringMap.set(n,t.slice(e.index,i).trim()),e.index=i}}save(){let t="";for(const[e,n]of this.stringMap)t+=`STRING ${e}\r\n{\r\n${n}\r\n}\r\n\r\n`;return t}getString(t){return"string"!=typeof t?this.stringMap.get(t):t.startsWith("TRIGSTR_")?this.stringMap.get(parseInt(t.slice(8))):void 0}setString(t,e){"string"==typeof t?t.startsWith("TRIGSTR_")&&this.stringMap.set(parseInt(t.slice(8)),e):this.stringMap.set(t,e)}}class rf{constructor(){this.flags=0,this.playerMasks=0,this.name=""}load(t){this.flags=t.readUint32(),this.playerMasks=t.readUint32(),this.name=t.readNull()}save(t){t.writeUint32(this.flags),t.writeUint32(this.playerMasks),t.writeNull(this.name)}getByteLength(){return 9+ja(this.name)}}class sf{constructor(){this.id=0,this.type=0,this.race=0,this.isFixedStartPosition=0,this.name="",this.startLocation=new Float32Array(2),this.allyLowPriorities=0,this.allyHighPriorities=0,this.unknown1=new Uint8Array(8)}load(t,e){this.id=t.readInt32(),this.type=t.readInt32(),this.race=t.readInt32(),this.isFixedStartPosition=t.readInt32(),this.name=t.readNull(),t.readFloat32Array(this.startLocation),this.allyLowPriorities=t.readUint32(),this.allyHighPriorities=t.readUint32(),e>30&&t.readUint8Array(this.unknown1)}save(t,e){t.writeInt32(this.id),t.writeInt32(this.type),t.writeInt32(this.race),t.writeInt32(this.isFixedStartPosition),t.writeNull(this.name),t.writeFloat32Array(this.startLocation),t.writeUint32(this.allyLowPriorities),t.writeUint32(this.allyHighPriorities),e>30&&t.writeUint8Array(this.unknown1)}getByteLength(t){let e=33+ja(this.name);return t>30&&(e+=8),e}}class af{constructor(){this.chance=0,this.id="\0\0\0\0"}load(t){this.chance=t.readInt32(),this.id=t.readBinary(4)}save(t){t.writeInt32(this.chance),t.writeBinary(this.id)}}class of{constructor(){this.items=[]}load(t){for(let e=0,n=t.readUint32();e<n;e++){const n=new af;n.load(t),this.items[e]=n}}save(t){t.writeUint32(this.items.length);for(const e of this.items)e.save(t)}getByteLength(){return 4+8*this.items.length}}class lf{constructor(){this.id=0,this.name="",this.sets=[]}load(t){this.id=t.readInt32(),this.name=t.readNull();for(let e=0,n=t.readUint32();e<n;e++){const n=new of;n.load(t),this.sets[e]=n}}save(t){t.writeInt32(this.id),t.writeNull(this.name),t.writeUint32(this.sets.length);for(const e of this.sets)e.save(t)}getByteLength(){let t=9+ja(this.name);for(const e of this.sets)t+=e.getByteLength();return t}}class hf{constructor(){this.chance=0,this.ids=[]}load(t,e){this.chance=t.readInt32();for(let n=0;n<e;n++)this.ids[n]=t.readBinary(4)}save(t){t.writeInt32(this.chance);for(const e of this.ids)t.writeBinary(e)}}class uf{constructor(){this.id=0,this.name="",this.positions=0,this.columnTypes=new Int32Array(0),this.units=[]}load(t){this.id=t.readInt32(),this.name=t.readNull(),this.positions=t.readInt32(),this.columnTypes=t.readInt32Array(this.positions);for(let e=0,n=t.readUint32();e<n;e++){const n=new hf;n.load(t,this.positions),this.units[e]=n}}save(t){t.writeInt32(this.id),t.writeNull(this.name),t.writeInt32(this.positions),t.writeInt32Array(this.columnTypes),t.writeUint32(this.units.length);for(const e of this.units)e.save(t)}getByteLength(){return 13+ja(this.name)+this.columnTypes.byteLength+this.units.length*(4+4*this.positions)}}class cf{constructor(){this.playerFlags=0,this.id="\0\0\0\0"}load(t){this.playerFlags=t.readUint32(),this.id=t.readBinary(4)}save(t){t.writeUint32(this.playerFlags),t.writeBinary(this.id)}}class df{constructor(){this.playerFlags=0,this.id="\0\0\0\0",this.levelAffected=0,this.availability=0}load(t){this.playerFlags=t.readUint32(),this.id=t.readBinary(4),this.levelAffected=t.readInt32(),this.availability=t.readInt32()}save(t){t.writeUint32(this.playerFlags),t.writeBinary(this.id),t.writeInt32(this.levelAffected),t.writeInt32(this.availability)}}class ff{constructor(){this.version=0,this.saves=0,this.editorVersion=0,this.buildVersion=new Uint32Array(4),this.name="",this.author="",this.description="",this.recommendedPlayers="",this.cameraBounds=new Float32Array(8),this.cameraBoundsComplements=new Int32Array(4),this.playableSize=new Int32Array(2),this.flags=0,this.tileset="A",this.campaignBackground=0,this.loadingScreenModel="",this.loadingScreenText="",this.loadingScreenTitle="",this.loadingScreenSubtitle="",this.loadingScreen=0,this.prologueScreenModel="",this.prologueScreenText="",this.prologueScreenTitle="",this.prologueScreenSubtitle="",this.useTerrainFog=0,this.fogHeight=new Float32Array(2),this.fogDensity=0,this.fogColor=new Uint8Array(4),this.globalWeather=0,this.soundEnvironment="",this.lightEnvironmentTileset="\0",this.waterVertexColor=new Uint8Array(4),this.scriptMode=0,this.graphicsMode=0,this.players=[],this.forces=[],this.upgradeAvailabilityChanges=[],this.techAvailabilityChanges=[],this.randomUnitTables=[],this.randomItemTables=[],this.unknown1=0}load(t){const e=new bo(t);this.version=e.readInt32(),this.saves=e.readInt32(),this.editorVersion=e.readInt32(),this.version>27&&e.readUint32Array(this.buildVersion),this.name=e.readNull(),this.author=e.readNull(),this.description=e.readNull(),this.recommendedPlayers=e.readNull(),e.readFloat32Array(this.cameraBounds),e.readInt32Array(this.cameraBoundsComplements),e.readInt32Array(this.playableSize),this.flags=e.readUint32(),this.tileset=e.readBinary(1),this.campaignBackground=e.readInt32(),this.version>24&&(this.loadingScreenModel=e.readNull()),this.loadingScreenText=e.readNull(),this.loadingScreenTitle=e.readNull(),this.loadingScreenSubtitle=e.readNull(),this.loadingScreen=e.readInt32(),this.version>24&&(this.prologueScreenModel=e.readNull()),this.prologueScreenText=e.readNull(),this.prologueScreenTitle=e.readNull(),this.prologueScreenSubtitle=e.readNull(),this.version>24&&(this.useTerrainFog=e.readInt32(),e.readFloat32Array(this.fogHeight),this.fogDensity=e.readFloat32(),e.readUint8Array(this.fogColor),this.globalWeather=e.readInt32(),this.soundEnvironment=e.readNull(),this.lightEnvironmentTileset=e.readBinary(1),e.readUint8Array(this.waterVertexColor)),this.version>27&&(this.scriptMode=e.readUint32()),this.version>30&&(this.graphicsMode=e.readUint32(),this.unknown1=e.readUint32());for(let t=0,n=e.readInt32();t<n;t++){const n=new sf;n.load(e,this.version),this.players[t]=n}for(let t=0,n=e.readInt32();t<n;t++){const n=new rf;n.load(e),this.forces[t]=n}for(let t=0,n=e.readInt32();t<n;t++){const n=new df;n.load(e),this.upgradeAvailabilityChanges[t]=n}for(let t=0,n=e.readInt32();t<n;t++){const n=new cf;n.load(e),this.techAvailabilityChanges[t]=n}for(let t=0,n=e.readInt32();t<n;t++){const n=new uf;n.load(e),this.randomUnitTables[t]=n}if(this.version>24)for(let t=0,n=e.readInt32();t<n;t++){const n=new lf;n.load(e),this.randomItemTables[t]=n}}save(){const t=new bo(new ArrayBuffer(this.getByteLength()));t.writeInt32(this.version),t.writeInt32(this.saves),t.writeInt32(this.editorVersion),this.version>27&&t.writeUint32Array(this.buildVersion),t.writeNull(this.name),t.writeNull(this.author),t.writeNull(this.description),t.writeNull(this.recommendedPlayers),t.writeFloat32Array(this.cameraBounds),t.writeInt32Array(this.cameraBoundsComplements),t.writeInt32Array(this.playableSize),t.writeUint32(this.flags),t.writeBinary(this.tileset),t.writeInt32(this.campaignBackground),this.version>24&&t.writeNull(this.loadingScreenModel),t.writeNull(this.loadingScreenText),t.writeNull(this.loadingScreenTitle),t.writeNull(this.loadingScreenSubtitle),t.writeInt32(this.loadingScreen),this.version>24&&t.writeNull(this.prologueScreenModel),t.writeNull(this.prologueScreenText),t.writeNull(this.prologueScreenTitle),t.writeNull(this.prologueScreenSubtitle),this.version>24&&(t.writeInt32(this.useTerrainFog),t.writeFloat32Array(this.fogHeight),t.writeFloat32(this.fogDensity),t.writeUint8Array(this.fogColor),t.writeInt32(this.globalWeather),t.writeNull(this.soundEnvironment),t.writeBinary(this.lightEnvironmentTileset),t.writeUint8Array(this.waterVertexColor)),this.version>27&&t.writeUint32(this.scriptMode),this.version>30&&(t.writeUint32(this.graphicsMode),t.writeUint32(this.unknown1)),t.writeUint32(this.players.length);for(const e of this.players)e.save(t,this.version);t.writeUint32(this.forces.length);for(const e of this.forces)e.save(t);t.writeUint32(this.upgradeAvailabilityChanges.length);for(const e of this.upgradeAvailabilityChanges)e.save(t);t.writeUint32(this.techAvailabilityChanges.length);for(const e of this.techAvailabilityChanges)e.save(t);t.writeUint32(this.randomUnitTables.length);for(const e of this.randomUnitTables)e.save(t);if(this.version>24){t.writeUint32(this.randomItemTables.length);for(const e of this.randomItemTables)e.save(t)}return t.uint8array}getByteLength(){let t=111+ja(this.name)+ja(this.author)+ja(this.description)+ja(this.recommendedPlayers)+ja(this.loadingScreenText)+ja(this.loadingScreenTitle)+ja(this.loadingScreenSubtitle)+ja(this.prologueScreenText)+ja(this.prologueScreenTitle)+ja(this.prologueScreenSubtitle);for(const e of this.players)t+=e.getByteLength(this.version);for(const e of this.forces)t+=e.getByteLength();t+=16*this.upgradeAvailabilityChanges.length,t+=8*this.techAvailabilityChanges.length;for(const e of this.randomUnitTables)t+=e.getByteLength();if(this.version>24){t+=36+ja(this.loadingScreenModel)+ja(this.prologueScreenModel)+ja(this.soundEnvironment);for(const e of this.randomItemTables)t+=e.getByteLength()}return this.version>27&&(t+=20),this.version>30&&(t+=8),t}getBuildVersion(){return 100*this.buildVersion[0]+this.buildVersion[1]}}class pf{constructor(){this.u1=0,this.name="",this.flags=0,this.maxPlayers=0,this.archive=new Fd,this.imports=new Gd,this.readonly=!1}load(t,e=!1){const n=new bo(t);"HM3W"===n.readBinary(4)&&(this.u1=n.readUint32(),this.name=n.readNull(),this.flags=n.readUint32(),this.maxPlayers=n.readUint32()),this.readonly=e,this.archive.load(t,e),this.readImports()}save(){this.setImportsFile();const t=this.archive.save();if(!t)throw Error("Failed to save the map MPQ archive");const e=this.getMapInformation();if(!e||e.getBuildVersion()<131){const e=new Uint8Array(512+t.byteLength),n=new bo(e);return n.writeBinary("HM3W"),n.writeUint32(this.u1),n.writeNull(this.name),n.writeUint32(this.flags),n.writeUint32(this.maxPlayers),e.set(t,512),e}return t}getFileNames(){return this.archive.getFileNames()}getImportNames(){const t=[];for(const e of this.imports.entries.values()){const n=e.isCustom;10===n||13===n?t.push(e.path):t.push(`war3mapImported\\${e.path}`)}return t}setImportsFile(){return!this.readonly&&(this.imports.entries.size>0&&this.set("war3map.imp",this.imports.save()))}import(t,e){return!this.readonly&&(!!this.archive.set(t,e)&&(this.imports.set(t),!0))}set(t,e){return!this.readonly&&this.archive.set(t,e)}get(t){return this.archive.get(t)}getScriptFile(){return this.get("war3map.j")||this.get("scripts\\war3map.j")||this.get("war3map.lua")||this.get("scripts\\war3map.lua")}has(t){return this.archive.has(t)}delete(t){return!this.readonly&&(this.imports.delete(t),this.archive.delete(t))}rename(t,e){return!this.readonly&&(!!this.archive.rename(t,e)&&(this.imports.rename(t,e),!0))}getMapInformation(){const t=this.archive.get("war3map.w3i");if(!t)throw new Error("File does not exist");const e=new ff;return e.load(t.bytes()),e}readImports(){const t=this.archive.get("war3map.imp");if(t){const e=t.arrayBuffer();e&&this.imports.load(e)}}readTriggers(t){const e=this.archive.get("war3map.wtg");if(e){const n=e.arrayBuffer();if(n){const e=new ef;return e.load(n,t),e}}}readCustomTextTriggers(){const t=this.archive.get("war3map.wct");if(t){const e=t.arrayBuffer();if(e){const t=new Yd;return t.load(e),t}}}readStringTable(){const t=this.archive.get("war3map.wts");if(t){const e=t.text();if(e){const t=new nf;return t.load(e),t}}}readModifications(){const t={},e=["w3u","w3t","w3b","w3d","w3a","w3h","w3q"],n=[!1,!1,!1,!0,!0,!1,!0];for(let i=0,r=e.length;i<r;i++){const r=this.archive.get(`war3map.${e[i]}`);if(r){const s=r.arrayBuffer();if(s){let r;r=n[i]?new Hd:new Xd,r.load(s),t[e[i]]=r}}}return t}}class mf{constructor(){this.id="\0\0\0\0",this.chance=0}load(t){this.id=t.readBinary(4),this.chance=t.readInt32()}save(t){t.writeBinary(this.id),t.writeInt32(this.chance)}}class _f{constructor(){this.items=[]}load(t){for(let e=0,n=t.readUint32();e<n;e++){const e=new mf;e.load(t),this.items.push(e)}}save(t){t.writeUint32(this.items.length);for(const e of this.items)e.save(t)}getByteLength(){return 4+8*this.items.length}}class gf{constructor(){this.id="\0\0\0\0",this.variation=0,this.location=new Float32Array(3),this.angle=0,this.scale=new Float32Array([1,1,1]),this.skin="\0\0\0\0",this.flags=0,this.life=0,this.itemTable=-1,this.itemSets=[],this.editorId=0,this.u1=new Uint8Array(8)}load(t,e,n){if(this.id=t.readBinary(4),this.variation=t.readInt32(),t.readFloat32Array(this.location),this.angle=t.readFloat32(),t.readFloat32Array(this.scale),n>131&&(this.skin=t.readBinary(4)),this.flags=t.readUint8(),this.life=t.readUint8(),e>7){this.itemTable=t.readUint32();for(let e=0,n=t.readUint32();e<n;e++){const e=new _f;e.load(t),this.itemSets.push(e)}}this.editorId=t.readInt32()}save(t,e,n){if(t.writeBinary(this.id),t.writeInt32(this.variation),t.writeFloat32Array(this.location),t.writeFloat32(this.angle),t.writeFloat32Array(this.scale),n>131&&t.writeBinary(this.skin),t.writeUint8(this.flags),t.writeUint8(this.life),e>7){t.writeUint32(this.itemTable),t.writeUint32(this.itemSets.length);for(const e of this.itemSets)e.save(t)}t.writeInt32(this.editorId)}getByteLength(t,e){let n=42;if(e>131&&(n+=4),t>7){n+=8;for(const t of this.itemSets)n+=t.getByteLength()}return n}}class vf{constructor(){this.id="\0\0\0\0",this.u1=0,this.location=new Uint32Array(2)}load(t,e){this.id=t.readBinary(4),this.u1=t.readUint32(),t.readUint32Array(this.location)}save(t,e){t.writeBinary(this.id),t.writeUint32(this.u1),t.writeUint32Array(this.location)}}class bf{constructor(){this.version=0,this.u1=new Uint8Array(4),this.doodads=[],this.u2=new Uint8Array(4),this.terrainDoodads=[]}load(t,e){const n=new bo(t);if("W3do"!==n.readBinary(4))throw new Error("Not a valid war3map.doo buffer");this.version=n.readInt32(),n.readUint8Array(this.u1);for(let t=0,i=n.readInt32();t<i;t++){const t=new gf;t.load(n,this.version,e),this.doodads.push(t)}n.readUint8Array(this.u2);for(let t=0,e=n.readInt32();t<e;t++){const t=new vf;t.load(n,this.version),this.terrainDoodads.push(t)}}save(t){const e=new bo(new ArrayBuffer(this.getByteLength(t)));e.writeBinary("W3do"),e.writeInt32(this.version),e.writeUint8Array(this.u1),e.writeUint32(this.doodads.length);for(const n of this.doodads)n.save(e,this.version,t);e.writeUint8Array(this.u2),e.writeUint32(this.terrainDoodads.length);for(const t of this.terrainDoodads)t.save(e,this.version);return e.uint8array}getByteLength(t){let e=24+16*this.terrainDoodads.length;for(const n of this.doodads)e+=n.getByteLength(this.version,t);return e}}class wf{constructor(){this.groundHeight=0,this.waterHeight=0,this.mapEdge=0,this.ramp=0,this.blight=0,this.water=0,this.boundary=0,this.groundTexture=0,this.cliffVariation=0,this.groundVariation=0,this.cliffTexture=0,this.layerHeight=0}load(t){this.groundHeight=(t.readInt16()-8192)/512;const e=t.readInt16();this.waterHeight=((16383&e)-8192)/512,this.mapEdge=16384&e;const n=t.readUint8();this.ramp=16&n,this.blight=32&n,this.water=64&n,this.boundary=128&n,this.groundTexture=15&n;const i=t.readUint8();this.cliffVariation=(224&i)>>>5,this.groundVariation=31&i;const r=t.readUint8();this.cliffTexture=(240&r)>>>4,this.layerHeight=15&r}save(t){t.writeInt16(512*this.groundHeight+8192),t.writeInt16(512*this.waterHeight+8192+this.mapEdge<<14),t.writeUint8(this.ramp<<4|this.blight<<5|this.water<<6|this.boundary<<7|this.groundTexture),t.writeUint8(this.cliffVariation<<5|this.groundVariation),t.writeUint8((this.cliffTexture<<4)+this.layerHeight)}}class Af{constructor(){this.version=0,this.tileset="A",this.haveCustomTileset=0,this.groundTilesets=[],this.cliffTilesets=[],this.mapSize=new Int32Array(2),this.centerOffset=new Float32Array(2),this.corners=[]}load(t){const e=new bo(t);if("W3E!"===e.readBinary(4)){this.version=e.readInt32(),this.tileset=e.readBinary(1),this.haveCustomTileset=e.readInt32();for(let t=0,n=e.readInt32();t<n;t++)this.groundTilesets[t]=e.readBinary(4);for(let t=0,n=e.readInt32();t<n;t++)this.cliffTilesets[t]=e.readBinary(4);e.readInt32Array(this.mapSize),e.readFloat32Array(this.centerOffset);for(let t=0,n=this.mapSize[1];t<n;t++){this.corners[t]=[];for(let n=0,i=this.mapSize[0];n<i;n++){const i=new wf;i.load(e),this.corners[t][n]=i}}}}save(){const t=new bo(new ArrayBuffer(this.getByteLength()));t.writeBinary("W3E!"),t.writeInt32(this.version),t.writeBinary(this.tileset),t.writeInt32(this.haveCustomTileset),t.writeUint32(this.groundTilesets.length);for(const e of this.groundTilesets)t.writeBinary(e);t.writeUint32(this.cliffTilesets.length);for(const e of this.cliffTilesets)t.writeBinary(e);t.writeInt32Array(this.mapSize),t.writeFloat32Array(this.centerOffset);for(const e of this.corners)for(const n of e)n.save(t);return t.uint8array}getByteLength(){return 37+4*this.groundTilesets.length+4*this.cliffTilesets.length+this.mapSize[0]*this.mapSize[1]*7}}class yf{constructor(){this.id="\0\0\0\0",this.chance=0}load(t){this.id=t.readBinary(4),this.chance=t.readInt32()}save(t){t.writeBinary(this.id),t.writeInt32(this.chance)}}class xf{constructor(){this.items=[]}load(t){for(let e=0,n=t.readInt32();e<n;e++){const n=new yf;n.load(t),this.items[e]=n}}save(t){t.writeInt32(this.items.length);for(const e of this.items)e.save(t)}getByteLength(){return 4+8*this.items.length}}class Tf{constructor(){this.slot=0,this.id="\0\0\0\0"}load(t){this.slot=t.readInt32(),this.id=t.readBinary(4)}save(t){t.writeInt32(this.slot),t.writeBinary(this.id)}}class Lf{constructor(){this.id="\0\0\0\0",this.activeForAutocast=0,this.heroLevel=1}load(t){this.id=t.readBinary(4),this.activeForAutocast=t.readInt32(),this.heroLevel=t.readInt32()}save(t){t.writeBinary(this.id),t.writeInt32(this.activeForAutocast),t.writeInt32(this.heroLevel)}}class Ef{constructor(){this.id="\0\0\0\0",this.chance=0}load(t){this.id=t.readBinary(4),this.chance=t.readInt32()}save(t){t.writeBinary(this.id),t.writeInt32(this.chance)}}class Sf{constructor(){this.id="\0\0\0\0",this.variation=0,this.location=new Float32Array(3),this.angle=0,this.scale=new Float32Array([1,1,1]),this.skin="\0\0\0\0",this.flags=0,this.player=0,this.unknown=0,this.hitpoints=-1,this.mana=-1,this.droppedItemTable=0,this.droppedItemSets=[],this.goldAmount=0,this.targetAcquisition=0,this.heroLevel=0,this.heroStrength=0,this.heroAgility=0,this.heroIntelligence=0,this.itemsInInventory=[],this.modifiedAbilities=[],this.randomFlag=0,this.level=new Uint8Array(3),this.itemClass=0,this.unitGroup=0,this.positionInGroup=0,this.randomUnitTables=[],this.customTeamColor=0,this.waygate=0,this.creationNumber=0}load(t,e,n,i){this.id=t.readBinary(4),this.variation=t.readInt32(),t.readFloat32Array(this.location),this.angle=t.readFloat32(),t.readFloat32Array(this.scale),i>131&&(this.skin=t.readBinary(4)),this.flags=t.readUint8(),this.player=t.readInt32(),this.unknown=t.readUint16(),this.hitpoints=t.readInt32(),this.mana=t.readInt32(),n>10&&(this.droppedItemTable=t.readInt32());for(let e=0,n=t.readInt32();e<n;e++){const n=new xf;n.load(t),this.droppedItemSets[e]=n}this.goldAmount=t.readInt32(),this.targetAcquisition=t.readFloat32(),this.heroLevel=t.readInt32(),n>10&&(this.heroStrength=t.readInt32(),this.heroAgility=t.readInt32(),this.heroIntelligence=t.readInt32());for(let e=0,n=t.readInt32();e<n;e++){const n=new Tf;n.load(t),this.itemsInInventory[e]=n}for(let e=0,n=t.readInt32();e<n;e++){const n=new Lf;n.load(t),this.modifiedAbilities[e]=n}if(this.randomFlag=t.readInt32(),0===this.randomFlag)t.readUint8Array(this.level),this.itemClass=t.readUint8();else if(1===this.randomFlag)this.unitGroup=t.readUint32(),this.positionInGroup=t.readUint32();else if(2===this.randomFlag)for(let e=0,n=t.readInt32();e<n;e++){const n=new Ef;n.load(t),this.randomUnitTables[e]=n}this.customTeamColor=t.readInt32(),this.waygate=t.readInt32(),this.creationNumber=t.readInt32()}save(t,e,n,i){t.writeBinary(this.id),t.writeInt32(this.variation),t.writeFloat32Array(this.location),t.writeFloat32(this.angle),t.writeFloat32Array(this.scale),i>131&&t.writeBinary(this.skin),t.writeUint8(this.flags),t.writeInt32(this.player),t.writeUint16(this.unknown),t.writeInt32(this.hitpoints),t.writeInt32(this.mana),n>10&&t.writeInt32(this.droppedItemTable),t.writeInt32(this.droppedItemSets.length);for(const e of this.droppedItemSets)e.save(t);t.writeInt32(this.goldAmount),t.writeFloat32(this.targetAcquisition),t.writeInt32(this.heroLevel),n>10&&(t.writeInt32(this.heroStrength),t.writeInt32(this.heroAgility),t.writeInt32(this.heroIntelligence)),t.writeInt32(this.itemsInInventory.length);for(const e of this.itemsInInventory)e.save(t);t.writeInt32(this.modifiedAbilities.length);for(const e of this.modifiedAbilities)e.save(t);if(t.writeInt32(this.randomFlag),0===this.randomFlag)t.writeUint8Array(this.level),t.writeUint8(this.itemClass);else if(1===this.randomFlag)t.writeUint32(this.unitGroup),t.writeUint32(this.positionInGroup);else if(2===this.randomFlag){t.writeInt32(this.randomUnitTables.length);for(const e of this.randomUnitTables)e.save(t)}t.writeInt32(this.customTeamColor),t.writeInt32(this.waygate),t.writeInt32(this.creationNumber)}getByteLength(t,e,n){let i=91;n>131&&(i+=4),e>10&&(i+=16);for(const t of this.droppedItemSets)i+=t.getByteLength();return i+=8*this.itemsInInventory.length,i+=12*this.modifiedAbilities.length,0===this.randomFlag?i+=4:1===this.randomFlag?i+=8:2===this.randomFlag&&(i+=4+8*this.randomUnitTables.length),i}}class Mf{constructor(){this.version=8,this.subversion=11,this.units=[]}load(t,e){const n=new bo(t);if("W3do"!==n.readBinary(4))throw new Error("Not a valid war3mapUnits.doo buffer");this.version=n.readInt32(),this.subversion=n.readUint32();for(let t=0,i=n.readInt32();t<i;t++){const i=new Sf;i.load(n,this.version,this.subversion,e),this.units[t]=i}}save(t){const e=new bo(new ArrayBuffer(this.getByteLength(t)));e.writeBinary("W3do"),e.writeInt32(this.version),e.writeUint32(this.subversion),e.writeInt32(this.units.length);for(const n of this.units)n.save(e,this.version,this.subversion,t);return e.uint8array}getByteLength(t){let e=16;for(const n of this.units)e+=n.getByteLength(this.version,this.subversion,t);return e}}function kf(t,e){return((1<<e)-1)/((1<<t)-1)}const Rf="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},If=function(){function t(t){this.message="JPEG error: "+t}return t.prototype=new Error,t.prototype.name="JpegError",t.constructor=t,t}(),Uf=new Uint8Array([0,1,8,16,9,2,3,10,17,24,32,25,18,11,4,5,12,19,26,33,40,48,41,34,27,20,13,6,7,14,21,28,35,42,49,56,57,50,43,36,29,22,15,23,30,37,44,51,58,59,52,45,38,31,39,46,53,60,61,54,47,55,62,63]),Of=4017,Cf=799,Bf=3406,Pf=2276,Nf=1567,Df=3784,Ff=5793,Vf=2896;function Gf(t,e){let n,i,r=0,s=[],a=16;for(;a>0&&!t[a-1];)a--;s.push({children:[],index:0});let o,l=s[0];for(n=0;n<a;n++){for(i=0;i<t[n];i++){for(l=s.pop(),l.children[l.index]=e[r];l.index>0;)l=s.pop();for(l.index++,s.push(l);s.length<=n;)s.push(o={children:[],index:0}),l.children[l.index]=o.children,l=o;r++}n+1<a&&(s.push(o={children:[],index:0}),l.children[l.index]=o.children,l=o)}return s[0].children}function Kf(t,e,n){return 64*((t.blocksPerLine+1)*e+n)}function jf(t,e,n,i,r,s,a,o,l){const h=n.mcusPerLine,u=n.progressive;let c=e,d=0,f=0;function p(){if(f>0)return f--,d>>f&1;if(d=t[e++],255===d){const n=t[e++];if(n)throw new If("unexpected marker "+(d<<8|n).toString(16))}return f=7,d>>>7}function m(t){let e=t;for(;;){if(e=e[p()],"number"==typeof e)return e;if("object"!==(void 0===e?"undefined":Rf(e)))throw new If("invalid huffman sequence")}}function _(t){let e=0;for(;t>0;)e=e<<1|p(),t--;return e}function g(t){if(1===t)return 1===p()?1:-1;const e=_(t);return e>=1<<t-1?e:e+(-1<<t)+1}let v=0;let b,w=0;function A(t,e,n,i,r){const s=n%h;e(t,Kf(t,(n/h|0)*t.v+i,s*t.h+r))}function y(t,e,n){e(t,Kf(t,n/t.blocksPerLine|0,n%t.blocksPerLine))}const x=i.length;let T,L,E,S,M,k;k=u?0===s?0===o?function(t,e){const n=m(t.huffmanTableDC),i=0===n?0:g(n)<<l;t.blockData[e]=t.pred+=i}:function(t,e){t.blockData[e]|=p()<<l}:0===o?function(t,e){if(v>0)return void v--;let n=s,i=a;for(;n<=i;){const i=m(t.huffmanTableAC),r=15&i,s=i>>4;if(0===r){if(s<15){v=_(s)+(1<<s)-1;break}n+=16;continue}n+=s;const a=Uf[n];t.blockData[e+a]=g(r)*(1<<l),n++}}:function(t,e){let n=s;const i=a;let r,o,h=0;for(;n<=i;){const i=Uf[n];switch(w){case 0:if(o=m(t.huffmanTableAC),r=15&o,h=o>>4,0===r)h<15?(v=_(h)+(1<<h),w=4):(h=16,w=1);else{if(1!==r)throw new If("invalid ACn encoding");b=g(r),w=h?2:3}continue;case 1:case 2:t.blockData[e+i]?t.blockData[e+i]+=p()<<l:(h--,0===h&&(w=2===w?3:0));break;case 3:t.blockData[e+i]?t.blockData[e+i]+=p()<<l:(t.blockData[e+i]=b<<l,w=0);break;case 4:t.blockData[e+i]&&(t.blockData[e+i]+=p()<<l)}n++}4===w&&(v--,0===v&&(w=0))}:function(t,e){const n=m(t.huffmanTableDC),i=0===n?0:g(n);t.blockData[e]=t.pred+=i;let r=1;for(;r<64;){const n=m(t.huffmanTableAC),i=15&n,s=n>>4;if(0===i){if(s<15)break;r+=16;continue}r+=s;const a=Uf[r];t.blockData[e+a]=g(i),r++}};let R,I,U,O,C=0;for(I=1===x?i[0].blocksPerLine*i[0].blocksPerColumn:h*n.mcusPerColumn;C<I;){const n=r?Math.min(I-C,r):I;for(L=0;L<x;L++)i[L].pred=0;if(v=0,1===x)for(T=i[0],M=0;M<n;M++)y(T,k,C),C++;else for(M=0;M<n;M++){for(L=0;L<x;L++)for(T=i[L],U=T.h,O=T.v,E=0;E<O;E++)for(S=0;S<U;S++)A(T,k,C,E,S);C++}f=0,R=Xf(t,e),R&&R.invalid&&(e=R.offset);const s=R&&R.marker;if(!s||s<=65280)throw new If("marker was not found");if(!(s>=65488&&s<=65495))break;e+=2}return R=Xf(t,e),R&&R.invalid&&(e=R.offset),e-c}function zf(t,e,n){const i=t.quantizationTable,r=t.blockData;let s,a,o,l,h,u,c,d,f,p,m,_,g,v,b,w,A;if(!i)throw new If("missing required Quantization Table.");for(let t=0;t<64;t+=8)f=r[e+t],p=r[e+t+1],m=r[e+t+2],_=r[e+t+3],g=r[e+t+4],v=r[e+t+5],b=r[e+t+6],w=r[e+t+7],f*=i[t],p|m|_|g|v|b|w?(p*=i[t+1],m*=i[t+2],_*=i[t+3],g*=i[t+4],v*=i[t+5],b*=i[t+6],w*=i[t+7],s=Ff*f+128>>8,a=Ff*g+128>>8,o=m,l=b,h=Vf*(p-w)+128>>8,d=Vf*(p+w)+128>>8,u=_<<4,c=v<<4,s=s+a+1>>1,a=s-a,A=o*Df+l*Nf+128>>8,o=o*Nf-l*Df+128>>8,l=A,h=h+c+1>>1,c=h-c,d=d+u+1>>1,u=d-u,s=s+l+1>>1,l=s-l,a=a+o+1>>1,o=a-o,A=h*Pf+d*Bf+2048>>12,h=h*Bf-d*Pf+2048>>12,d=A,A=u*Cf+c*Of+2048>>12,u=u*Of-c*Cf+2048>>12,c=A,n[t]=s+d,n[t+7]=s-d,n[t+1]=a+c,n[t+6]=a-c,n[t+2]=o+u,n[t+5]=o-u,n[t+3]=l+h,n[t+4]=l-h):(A=Ff*f+512>>10,n[t]=A,n[t+1]=A,n[t+2]=A,n[t+3]=A,n[t+4]=A,n[t+5]=A,n[t+6]=A,n[t+7]=A);for(let t=0;t<8;++t)f=n[t],p=n[t+8],m=n[t+16],_=n[t+24],g=n[t+32],v=n[t+40],b=n[t+48],w=n[t+56],p|m|_|g|v|b|w?(s=Ff*f+2048>>12,a=Ff*g+2048>>12,o=m,l=b,h=Vf*(p-w)+2048>>12,d=Vf*(p+w)+2048>>12,u=_,c=v,s=4112+(s+a+1>>1),a=s-a,A=o*Df+l*Nf+2048>>12,o=o*Nf-l*Df+2048>>12,l=A,h=h+c+1>>1,c=h-c,d=d+u+1>>1,u=d-u,s=s+l+1>>1,l=s-l,a=a+o+1>>1,o=a-o,A=h*Pf+d*Bf+2048>>12,h=h*Bf-d*Pf+2048>>12,d=A,A=u*Cf+c*Of+2048>>12,u=u*Of-c*Cf+2048>>12,c=A,f=s+d,w=s-d,p=a+c,b=a-c,m=o+u,v=o-u,_=l+h,g=l-h,f=f<16?0:f>=4080?255:f>>4,p=p<16?0:p>=4080?255:p>>4,m=m<16?0:m>=4080?255:m>>4,_=_<16?0:_>=4080?255:_>>4,g=g<16?0:g>=4080?255:g>>4,v=v<16?0:v>=4080?255:v>>4,b=b<16?0:b>=4080?255:b>>4,w=w<16?0:w>=4080?255:w>>4,r[e+t]=f,r[e+t+8]=p,r[e+t+16]=m,r[e+t+24]=_,r[e+t+32]=g,r[e+t+40]=v,r[e+t+48]=b,r[e+t+56]=w):(A=Ff*f+8192>>14,A=A<-2040?0:A>=2024?255:A+2056>>4,r[e+t]=A,r[e+t+8]=A,r[e+t+16]=A,r[e+t+24]=A,r[e+t+32]=A,r[e+t+40]=A,r[e+t+48]=A,r[e+t+56]=A)}function Hf(t,e){const n=e.blocksPerLine,i=e.blocksPerColumn,r=new Int16Array(64);for(let t=0;t<i;t++)for(let i=0;i<n;i++){zf(e,Kf(e,t,i),r)}return e.blockData}function Xf(t,e,n){function i(e){return t[e]<<8|t[e+1]}const r=t.length-1;let s=n<e?n:e;if(e>=r)return null;const a=i(e);if(a>=65472&&a<=65534)return{invalid:null,marker:a,offset:e};let o=i(s);for(;!(o>=65472&&o<=65534);){if(++s>=r)return null;o=i(s)}return{invalid:a.toString(16),marker:o,offset:s}}class qf{constructor(){this.decodeTransform=null,this.colorTransform=-1,this.width=0,this.height=0}parse(t){function e(){const e=t[r]<<8|t[r+1];return r+=2,e}function n(){const n=e();let i=r+n-2;const s=Xf(t,i,r);s&&s.invalid&&(i=s.offset);const a=t.subarray(r,i);return r+=a.length,a}function i(t){const e=Math.ceil(t.samplesPerLine/8/t.maxH),n=Math.ceil(t.scanLines/8/t.maxV);for(let i=0;i<t.components.length;i++){x=t.components[i];const r=Math.ceil(Math.ceil(t.samplesPerLine/8)*x.h/t.maxH),s=Math.ceil(Math.ceil(t.scanLines/8)*x.v/t.maxV),a=e*x.h,o=64*(n*x.v)*(a+1);x.blockData=new Int16Array(o),x.blocksPerLine=r,x.blocksPerColumn=s}t.mcusPerLine=e,t.mcusPerColumn=n}var r=0;let s,a,o=null,l=null;const h=[],u=[],c=[];let d=e();if(65496!==d)throw new If("SOI not found");for(d=e();65497!==d;){var f,p,m;switch(d){case 65504:case 65505:case 65506:case 65507:case 65508:case 65509:case 65510:case 65511:case 65512:case 65513:case 65514:case 65515:case 65516:case 65517:case 65518:case 65519:case 65534:var _=n();65504===d&&74===_[0]&&70===_[1]&&73===_[2]&&70===_[3]&&0===_[4]&&(o={version:{major:_[5],minor:_[6]},densityUnits:_[7],xDensity:_[8]<<8|_[9],yDensity:_[10]<<8|_[11],thumbWidth:_[12],thumbHeight:_[13],thumbData:_.subarray(14,14+3*_[12]*_[13])}),65518===d&&65===_[0]&&100===_[1]&&111===_[2]&&98===_[3]&&101===_[4]&&(l={version:_[5]<<8|_[6],flags0:_[7]<<8|_[8],flags1:_[9]<<8|_[10],transformCode:_[11]});break;case 65499:for(var g=e()+r-2;r<g;){const n=t[r++],i=new Uint16Array(64);if(n>>4){if(n>>4!=1)throw new If("DQT - invalid table spec");for(p=0;p<64;p++)i[Uf[p]]=e()}else for(p=0;p<64;p++)i[Uf[p]]=t[r++];h[15&n]=i}break;case 65472:case 65473:case 65474:if(s)throw new If("Only single frame JPEGs supported");e(),s={},s.extended=65473===d,s.progressive=65474===d,s.precision=t[r++],s.scanLines=e(),s.samplesPerLine=e(),s.components=[],s.componentIds={};var v,b=t[r++],w=0,A=0;for(f=0;f<b;f++){v=t[r];const e=t[r+1]>>4,n=15&t[r+1];w<e&&(w=e),A<n&&(A=n);const i=t[r+2];m=s.components.push({h:e,v:n,quantizationId:i,quantizationTable:null}),s.componentIds[v]=m-1,r+=3}s.maxH=w,s.maxV=A,i(s);break;case 65476:var y=e();for(f=2;f<y;){const e=t[r++],n=new Uint8Array(16);let i=0;for(p=0;p<16;p++,r++)i+=n[p]=t[r];const s=new Uint8Array(i);for(p=0;p<i;p++,r++)s[p]=t[r];f+=17+i,(e>>4?u:c)[15&e]=Gf(n,s)}break;case 65501:e(),a=e();break;case 65498:e();var x,T=t[r++],L=[];for(f=0;f<T;f++){const e=s.componentIds[t[r++]];x=s.components[e];const n=t[r++];x.huffmanTableDC=c[n>>4],x.huffmanTableAC=u[15&n],L.push(x)}var E=t[r++],S=t[r++],M=t[r++],k=jf(t,r,s,L,a,E,S,M>>4,15&M);r+=k;break;case 65535:255!==t[r]&&r--;break;default:if(255===t[r-3]&&t[r-2]>=192&&t[r-2]<=254){r-=3;break}throw new If("unknown marker "+d.toString(16))}d=e()}for(this.width=s.samplesPerLine,this.height=s.scanLines,this.jfif=o,this.adobe=l,this.components=[],f=0;f<s.components.length;f++){const t=h[(x=s.components[f]).quantizationId];t&&(x.quantizationTable=t),this.components.push({output:Hf(0,x),scaleX:x.h/s.maxH,scaleY:x.v/s.maxV,blocksPerLine:x.blocksPerLine,blocksPerColumn:x.blocksPerColumn})}this.numComponents=this.components.length}getData(t){const e=t.data,n=this.components,i=new Uint8Array((n[0].blocksPerLine<<3)*n[0].blocksPerColumn*8);[n[0],n[2]]=[n[2],n[0]];for(let t=0,o=n.length;t<o;t++){const l=n[t],h=l.blocksPerLine,u=l.blocksPerColumn,c=h<<3;var r,s,a=0;for(let t=0;t<u;t++){const e=t<<3;for(let n=0;n<h;n++){const o=Kf(l,t,n);let h=0,u=n<<3;for(r=0;r<8;r++){a=(e+r)*c;for(s=0;s<8;s++)i[a+u+s]=l.output[o+h++]}}}let d=t;for(let t=0;t<this.height;t++)for(let n=0;n<this.width;n++)e[d]=i[t*c+n],d+=o}return e}}class Yf{constructor(){this.content=0,this.alphaBits=0,this.width=0,this.height=0,this.type=0,this.hasMipmaps=!1,this.mipmapOffsets=new Uint32Array(16),this.mipmapSizes=new Uint32Array(16),this.uint8array=null,this.jpgHeader=null,this.pallete=null}load(t){const e=za(t),n=new Int32Array(e.buffer,0,40);if(827345986!==n[0])throw new Error("WrongMagicNumber");this.content=n[1],this.alphaBits=n[2],this.width=n[3],this.height=n[4],this.type=n[5],this.hasMipmaps=0!==n[6];for(let t=0;t<16;t++)this.mipmapOffsets[t]=n[7+t],this.mipmapSizes[t]=n[23+t];this.uint8array=e,0===this.content?this.jpgHeader=e.subarray(160,160+n[39]):this.pallete=e.subarray(156,1180)}getMipmap(t){const e=this.uint8array,n=this.mipmapOffsets[t],i=this.mipmapSizes[t];let r;if(0===this.content){const t=this.jpgHeader,s=new Uint8Array(t.length+i),a=new qf;s.set(t),s.set(e.subarray(n,n+i),t.length),a.parse(s),r=new ImageData(a.width,a.height),a.getData(r)}else{const i=this.pallete,s=Math.max(this.width/(1<<t),1),a=Math.max(this.height/(1<<t),1),o=s*a;let l,h=this.alphaBits,u=0;r=new ImageData(s,a),h>0&&(h>8&&(h=8),l=new wo(e.buffer,n+o,Math.ceil(o*h/8)),u=kf(h,8));const c=r.data;for(let t=0;t<o;t++){const r=4*t,s=4*e[n+t];c[r]=i[s+2],c[r+1]=i[s+1],c[r+2]=i[s],c[r+3]=h>0?l.readBits(h)*u:255}}return r}mipmaps(){let t=0;for(const e of this.mipmapSizes)e>0&&(t+=1);return t}fakeMipmaps(){const t=this.mipmapOffsets;let e=0;for(let n=0;n<16;n++){const i=t[n];if(i>0)for(let r=n+1;r<16;r++)if(i===t[r]){e+=1;break}}return e}}const $f=kf(4,8),Wf=kf(5,8),Zf=kf(6,8),Jf=new Uint8Array(16),Qf=new Uint8Array(12),tp=new Uint8Array(8),ep=new Uint8Array(8),np=new Uint8Array(8);function ip(t,e,n){const i=(e>>11&31)*Wf,r=(e>>5&63)*Zf,s=(31&e)*Wf,a=(n>>11&31)*Wf,o=(n>>5&63)*Zf,l=(31&n)*Wf;t[0]=i,t[1]=r,t[2]=s,t[3]=255,t[4]=a,t[5]=o,t[6]=l,t[7]=255,e>n?(t[8]=5*i+3*a>>3,t[9]=5*r+3*o>>3,t[10]=5*s+3*l>>3,t[11]=255,t[12]=5*a+3*i>>3,t[13]=5*o+3*r>>3,t[14]=5*l+3*s>>3,t[15]=255):(t[8]=i+a>>1,t[9]=r+o>>1,t[10]=s+l>>1,t[11]=255,t[12]=0,t[13]=0,t[14]=0,t[15]=0)}function rp(t,e,n){const i=(e>>11&31)*Wf,r=(e>>5&63)*Zf,s=(31&e)*Wf,a=(n>>11&31)*Wf,o=(n>>5&63)*Zf,l=(31&n)*Wf;t[0]=i,t[1]=r,t[2]=s,t[3]=a,t[4]=o,t[5]=l,t[6]=5*i+3*a>>3,t[7]=5*r+3*o>>3,t[8]=5*s+3*l>>3,t[9]=5*a+3*i>>3,t[10]=5*o+3*r>>3,t[11]=5*l+3*s>>3}function sp(t,e,n){t[0]=e,t[1]=n,e>n?(t[2]=(6*e+1*n)/7,t[3]=(5*e+2*n)/7,t[4]=(4*e+3*n)/7,t[5]=(3*e+4*n)/7,t[6]=(2*e+5*n)/7,t[7]=(1*e+6*n)/7):(t[2]=(4*e+1*n)/5,t[3]=(3*e+2*n)/5,t[4]=(2*e+3*n)/5,t[5]=(1*e+4*n)/5,t[6]=0,t[7]=1)}const ap=827611204,op=861165636,lp=894720068,hp=843666497;class up{constructor(){this.width=0,this.height=0,this.format=0,this.mipmapWidths=[],this.mipmapHeights=[],this.mipmapDatas=[]}load(t){const e=za(t),n=new Int32Array(e.buffer,0,31);let i=128;if(542327876!==n[0])throw new Error("Wrong magic number");if(!(4&n[20]))throw new Error("Not FourCC");let r=n[21];if(r!==ap&&r!==op&&r!==lp&&r!==hp){if(808540228!==r)throw new Error(`Unsupported FourCC: ${go(r)}`);{i+=20;const t=new Int32Array(e.buffer,128,5),n=t[0];if(71===n)r=ap;else if(74===n)r=op;else if(77===n)r=lp;else{if(83!==n)throw new Error(`Unsupported DXGI format: ${n}`);r=hp}console.log(t)}}this.format=r;let s=1;131072&n[2]&&(s=Math.max(1,n[7]));let a=n[4],o=n[3],l=16;r===ap&&(l=8),this.width=a,this.height=o;for(let t=0;t<s;t++){const n=Math.max(4,a)/4*Math.max(4,o)/4*l;this.mipmapWidths[t]=a,this.mipmapHeights[t]=o,this.mipmapDatas[t]=e.subarray(i,i+n),i+=n,a=Math.max(a/2,1),o=Math.max(o/2,1)}}mipmaps(){return this.mipmapDatas.length}getMipmap(t,e=!1){const n=this.mipmapWidths[t],i=this.mipmapHeights[t],r=this.mipmapDatas[t];let s;return s=e?r:this.format===ap?function(t,e,n){const i=new Uint8Array(e*n*4);for(let r=0,s=n/4;r<s;r++)for(let n=0,s=e/4;n<s;n++){const a=8*(r*s+n);ip(Jf,t[a]+256*t[a+1],t[a+2]+256*t[a+3]);const o=16*r*e+16*n,l=t[a+4]|t[a+5]<<8|t[a+6]<<16|t[a+7]<<24;for(let t=0;t<4;t++){const n=8*t,r=o+t*e*4;for(let t=0;t<4;t++){const e=r+4*t,s=4*(l>>n+2*t&3);i[e+0]=Jf[s+0],i[e+1]=Jf[s+1],i[e+2]=Jf[s+2],i[e+3]=Jf[s+3]}}}return i}(r,n,i):this.format===op?function(t,e,n){const i=new Uint8Array(e*n*4),r=4*e;for(let s=0,a=n/4;s<a;s++)for(let n=0,a=e/4;n<a;n++){const o=16*(s*a+n);rp(Qf,t[o+8]+256*t[o+9],t[o+10]+256*t[o+11]);let l=16*s*e+16*n;for(let e=0;e<4;e++){const n=t[o+2*e]+256*t[o+1+2*e],s=t[o+12+e];for(let t=0;t<4;t++){const e=l+4*t,r=3*(s>>2*t&3);i[e+0]=Qf[r+0],i[e+1]=Qf[r+1],i[e+2]=Qf[r+2],i[e+3]=(n>>4*t&15)*$f}l+=r}}return i}(r,n,i):this.format===lp?function(t,e,n){const i=new Uint8Array(e*n*4),r=4*e;for(let l=0,h=n/4;l<h;l++)for(let n=0,h=e/4;n<h;n++){const u=16*(l*h+n);s=tp,a=t[u],o=t[u+1],s[0]=a,s[1]=o,a>o?(s[2]=54*a+9*o>>6,s[3]=45*a+18*o>>6,s[4]=36*a+27*o>>6,s[5]=27*a+36*o>>6,s[6]=18*a+45*o>>6,s[7]=9*a+54*o>>6):(s[2]=12*a+3*o>>4,s[3]=9*a+6*o>>4,s[4]=6*a+9*o>>4,s[5]=3*a+12*o>>4,s[6]=0,s[7]=255),rp(Qf,t[u+8]+256*t[u+9],t[u+10]+256*t[u+11]);let c=16*l*e+16*n;for(let e=0;e<2;e++){const n=u+2+3*e,s=u+12+2*e,a=t[n]+256*(t[n+1]+256*t[n+2]);for(let e=0;e<2;e++){const n=t[s+e];for(let t=0;t<4;t++){const r=c+4*t,s=3*(n>>2*t&3),o=a>>12*e+3*t&7;i[r+0]=Qf[s+0],i[r+1]=Qf[s+1],i[r+2]=Qf[s+2],i[r+3]=tp[o]}c+=r}}}var s,a,o;return i}(r,n,i):function(t,e,n){const i=new Uint8Array(e*n*2),r=2*e;for(let s=0,a=n/4;s<a;s++)for(let n=0,a=e/4;n<a;n++){const o=16*(s*a+n);sp(ep,t[o],t[o+1]),sp(np,t[o+8],t[o+9]);let l=8*s*e+8*n;for(let e=0;e<2;e++){const n=o+3*e,s=t[n+2]+256*(t[n+3]+256*t[n+4]),a=t[n+10]+256*(t[n+11]+256*t[n+12]);for(let t=0;t<2;t++){const e=4*t;for(let t=0;t<4;t++){const n=l+2*t,r=3*(e+t);i[n+1]=ep[s>>r&7],i[n+2]=np[a>>r&7]}l+=r}}}return i}(r,n,i),{width:n,height:i,data:s}}}function cp(t){return t instanceof ArrayBuffer&&(t=new Uint8Array(t)),t instanceof Uint8Array&&68===t[0]&&68===t[1]&&83===t[2]&&32===t[3]}const dp=class{_checkHeader(){const t=this.header;if(0===t.imageType)throw Error("No data");if(t.hasColorMap){if(t.colorMapLength>256||24!==t.colorMapDepth||1!==t.colorMapType)throw Error("Invalid colormap for indexed type")}else if(t.colorMapType)throw Error("Why does the image contain a palette ?");if(!t.width||!t.height)throw Error("Invalid image size");if(8!==t.pixelDepth&&16!==t.pixelDepth&&24!==t.pixelDepth&&32!==t.pixelDepth)throw Error('Invalid pixel size "'+t.pixelDepth+'"')}_decodeRLE(t,e,n,i){const r=new Uint8Array(i),s=new Uint8Array(n);let a=0;for(;a<i;){const i=t[e++];let o=1+(127&i);if(128&i){for(let i=0;i<n;++i)s[i]=t[e+i];e+=n;for(let t=0;t<o;++t)r.set(s,a),a+=n}else{o*=n;for(let n=0;n<o;++n)r[a+n]=t[e+n];a+=o,e+=o}}return r}_getImageData8bits(t,e,n,i,r,s,a,o,l,h){for(let u=0,c=r;c!==a;c+=s)for(let r=o;r!==h;r+=l,u++){const s=e[u];t[4*(r+i*c)+3]=255,t[4*(r+i*c)+2]=n[3*s+0],t[4*(r+i*c)+1]=n[3*s+1],t[4*(r+i*c)+0]=n[3*s+2]}return t}_getImageData16bits(t,e,n,i,r,s,a,o,l,h){for(let n=0,u=r;u!==a;u+=s)for(let r=o;r!==h;r+=l,n+=2){const s=e[n+0]|e[n+1]<<8;t[4*(r+i*u)+0]=(31744&s)>>7,t[4*(r+i*u)+1]=(992&s)>>2,t[4*(r+i*u)+2]=(31&s)>>3,t[4*(r+i*u)+3]=32768&s?0:255}return t}_getImageData24bits(t,e,n,i,r,s,a,o,l,h){for(let n=0,u=r;u!==a;u+=s)for(let r=o;r!==h;r+=l,n+=3)t[4*(r+i*u)+3]=255,t[4*(r+i*u)+2]=e[n+0],t[4*(r+i*u)+1]=e[n+1],t[4*(r+i*u)+0]=e[n+2];return t}_getImageData32bits(t,e,n,i,r,s,a,o,l,h){for(let n=0,u=r;u!==a;u+=s)for(let r=o;r!==h;r+=l,n+=4)t[4*(r+i*u)+2]=e[n+0],t[4*(r+i*u)+1]=e[n+1],t[4*(r+i*u)+0]=e[n+2],t[4*(r+i*u)+3]=e[n+3];return t}_getImageDataGrey8bits(t,e,n,i,r,s,a,o,l,h){for(let n=0,u=r;u!==a;u+=s)for(let r=o;r!==h;r+=l,n++){const s=e[n];t[4*(r+i*u)+0]=s,t[4*(r+i*u)+1]=s,t[4*(r+i*u)+2]=s,t[4*(r+i*u)+3]=255}return t}_getImageDataGrey16bits(t,e,n,i,r,s,a,o,l,h){for(let n=0,u=r;u!==a;u+=s)for(let r=o;r!==h;r+=l,n+=2)t[4*(r+i*u)+0]=e[n+0],t[4*(r+i*u)+1]=e[n+0],t[4*(r+i*u)+2]=e[n+0],t[4*(r+i*u)+3]=e[n+1];return t}open(t,e){const n=new XMLHttpRequest;n.responseType="arraybuffer",n.open("GET",t,!0),n.onload=()=>{200===n.status&&(this.load(new Uint8Array(n.response)),e&&e())},n.send(null)}load(t){let e=0;if(t.length<18)throw Error("Not enough data to contain header");const n={idLength:t[e++],colorMapType:t[e++],imageType:t[e++],colorMapIndex:t[e++]|t[e++]<<8,colorMapLength:t[e++]|t[e++]<<8,colorMapDepth:t[e++],offsetX:t[e++]|t[e++]<<8,offsetY:t[e++]|t[e++]<<8,width:t[e++]|t[e++]<<8,height:t[e++]|t[e++]<<8,pixelDepth:t[e++],flags:t[e++]};if(n.hasEncoding=9===n.imageType||10===n.imageType||11===n.imageType,n.hasColorMap=9===n.imageType||1===n.imageType,n.isGreyColor=11===n.imageType||3===n.imageType,this.header=n,this._checkHeader(),(e+=n.idLength)>=t.length)throw Error("No data");if(n.hasColorMap){const i=n.colorMapLength*(n.colorMapDepth>>3);this.palette=t.subarray(e,e+i),e+=i}const i=n.pixelDepth>>3,r=n.width*n.height,s=r*i;n.hasEncoding?this.imageData=this._decodeRLE(t,e,i,s):this.imageData=t.subarray(e,e+(n.hasColorMap?r:s))}getImageData(t){const{width:e,height:n,flags:i,pixelDepth:r,isGreyColor:s}=this.header,a=(48&i)>>4;let o,l,h,u,c,d,f;switch(t||(t=document?document.createElement("canvas").getContext("2d").createImageData(e,n):{width:e,height:n,data:new Uint8ClampedArray(e*n*4)}),2===a||3===a?(u=0,c=1,d=n):(u=n-1,c=-1,d=-1),2===a||0===a?(o=0,l=1,h=e):(o=e-1,l=-1,h=-1),r){case 8:f=s?this._getImageDataGrey8bits:this._getImageData8bits;break;case 16:f=s?this._getImageDataGrey16bits:this._getImageData16bits;break;case 24:f=this._getImageData24bits;break;case 32:f=this._getImageData32bits}return f.call(this,t.data,this.imageData,this.palette,e,u,c,d,o,l,h),t}getCanvas(){const{width:t,height:e}=this.header,n=document.createElement("canvas"),i=n.getContext("2d"),r=i.createImageData(t,e);return n.width=t,n.height=e,i.putImageData(this.getImageData(r),0,0),n}getDataURL(t){return this.getCanvas().toDataURL(t||"image/png")}};class fp{constructor(){this.width=0,this.height=0,this.data=null}load(t){const e=za(t),n=new dp;n.load(e);const i=n.header;this.width=i.width,this.height=i.height,this.data=new ImageData(i.width,i.height),n.getImageData(this.data)}}function pp(t){return t instanceof ArrayBuffer&&(t=new Uint8Array(t)),!!(t instanceof Uint8Array&&Ha(t,"TRUEVISION-XFILE.\0",t.length-18))}var mp=n(7);async function _p(t,e){if("image"===e)return new Promise((e=>{const n=new Image;n.onload=()=>{e({ok:!0,data:n})},n.onerror=t=>{e({ok:!1,error:"Image Error",data:t})},n.src=t}));{let n;try{n=await fetch(t)}catch(t){return{ok:!1,error:"Network Error",data:t}}if(!n.ok)return{ok:!1,error:"Http Error",data:n};try{let t=null;return"text"===e?t=await n.text():"arrayBuffer"===e||"bytes"===e?t=await n.arrayBuffer():"blob"===e&&(t=await n.blob()),"bytes"===e&&(t=new Uint8Array(t)),{ok:!0,data:t}}catch(t){return{ok:!1,error:"Data Error",data:t}}}}class gp{constructor(t,e=4){this.size=0,this.arrayBuffer=null,this.byteView=null,this.floatView=null,this.gl=t,this.buffer=t.createBuffer(),this.reserve(e)}reserve(t){if(this.size<t){const e=this.gl;this.size=4*Math.ceil(t/4),e.bindBuffer(e.ARRAY_BUFFER,this.buffer),e.bufferData(e.ARRAY_BUFFER,this.size,e.DYNAMIC_DRAW),this.arrayBuffer=new ArrayBuffer(this.size),this.byteView=new Uint8Array(this.arrayBuffer),this.floatView=new Float32Array(this.arrayBuffer)}}bindAndUpdate(t=this.size){const e=this.gl,n=this.byteView;e.bindBuffer(e.ARRAY_BUFFER,this.buffer),e.bufferSubData(e.ARRAY_BUFFER,0,n.subarray(0,t))}}class vp{constructor(t,e=1,n=1){this.width=0,this.height=0,this.arrayBuffer=new ArrayBuffer(0),this.byteView=null,this.floatView=null,this.gl=t,this.texture=t.createTexture(),t.bindTexture(t.TEXTURE_2D,this.texture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),this.reserve(e,n)}reserve(t,e){if(this.width<t||this.height<e){const n=this.gl;this.width=Math.max(this.width,t),this.height=Math.max(this.height,e),n.bindTexture(n.TEXTURE_2D,this.texture),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,this.width,this.height,0,n.RGBA,n.FLOAT,null),this.arrayBuffer=new ArrayBuffer(this.width*this.height*16),this.byteView=new Uint8Array(this.arrayBuffer),this.floatView=new Float32Array(this.arrayBuffer)}}bindAndUpdate(t=this.width,e=this.height){const n=this.gl;n.bindTexture(n.TEXTURE_2D,this.texture),n.texSubImage2D(n.TEXTURE_2D,0,0,0,t,e,n.RGBA,n.FLOAT,this.byteView)}}class bp{constructor(t,e=4,n=1,i=1){this.width=0,this.height=0,this.gl=t,this.texture=t.createTexture(),this.format=3===e?t.RGB:t.RGBA,t.bindTexture(t.TEXTURE_2D,this.texture),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),this.reserve(n,i)}reserve(t,e){if(this.width<t||this.height<e){const n=this.gl;this.width=Math.max(this.width,t),this.height=Math.max(this.height,e),n.bindTexture(n.TEXTURE_2D,this.texture),n.texImage2D(n.TEXTURE_2D,0,this.format,this.width,this.height,0,this.format,n.FLOAT,null)}}bindAndUpdate(t,e=this.width,n=this.height){const i=this.gl;i.bindTexture(i.TEXTURE_2D,this.texture),i.texSubImage2D(i.TEXTURE_2D,0,0,0,e,n,this.format,i.FLOAT,t)}bind(t){const e=this.gl;e.activeTexture(e.TEXTURE0+t),e.bindTexture(e.TEXTURE_2D,this.texture)}}class wp{constructor(t,e){this.uniforms={},this.attribs={},this.attribsCount=0,this.webgl=t,this.program=e;const n=t.gl;for(let t=0,i=n.getProgramParameter(e,n.ACTIVE_UNIFORMS);t<i;t++){const i=n.getActiveUniform(e,t);if(i)if(1===i.size)this.uniforms[i.name]=n.getUniformLocation(e,i.name);else{const t=i.name.substr(0,i.name.length-3);for(let r=0;r<i.size;r++){const i=t+"["+r+"]";this.uniforms[i]=n.getUniformLocation(e,i)}}}for(let t=0,i=n.getProgramParameter(e,n.ACTIVE_ATTRIBUTES);t<i;t++){const i=n.getActiveAttrib(e,t);if(i)if(this.attribsCount+=i.size,1===i.size)this.attribs[i.name]=n.getAttribLocation(e,i.name);else{const t=i.name.substr(0,i.name.length-3);for(let r=0;r<i.size;r++){const i=t+"["+r+"]";this.attribs[i]=n.getAttribLocation(e,i)}}}}use(){this.webgl.useShader(this)}}class Ap{constructor(t,e={alpha:!1}){this.currentShader=null,this.extensions={};let n=t.getContext("webgl",e);if(n||(n=t.getContext("experimental-webgl",e)),!n)throw new Error("WebGL: Failed to create a WebGL context!");const i=new Uint8ClampedArray(16).fill(255),r=n.createTexture();n.bindTexture(n.TEXTURE_2D,r),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.NEAREST),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.NEAREST),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,2,2,0,n.RGBA,n.UNSIGNED_BYTE,i),this.gl=n,this.emptyTexture=r}ensureExtension(t){const e=this.gl.getExtension(t);return!!e&&(this.extensions[t]=e,!0)}createShader(t,e){const n=this.gl,i=n.createShader(n.VERTEX_SHADER);n.shaderSource(i,t),n.compileShader(i);const r=n.createShader(n.FRAGMENT_SHADER);n.shaderSource(r,e),n.compileShader(r);const s=n.createProgram();if(n.attachShader(s,i),n.attachShader(s,r),n.linkProgram(s),!n.getProgramParameter(s,n.LINK_STATUS)){let t="Shader failed to link:";const e=n.getShaderInfoLog(i);e&&e.length&&(t+=` Vertex shader: ${e}`);const s=n.getShaderInfoLog(r);throw s&&s.length&&(t+=` Fragment shader: ${s}`),new Error(t)}return new wp(this,s)}enableVertexAttribs(t,e){const n=this.gl;for(let i=t;i<e;i++)n.enableVertexAttribArray(i)}disableVertexAttribs(t,e){const n=this.gl;for(let i=t;i<e;i++)n.disableVertexAttribArray(i)}useShader(t){if(t&&t!==this.currentShader){let e=0;const n=t.attribsCount;this.currentShader&&(e=this.currentShader.attribsCount),this.gl.useProgram(t.program),n>e?this.enableVertexAttribs(e,n):n<e&&this.disableVertexAttribs(n,e),this.currentShader=t}}bindTexture(t,e){const n=this.gl;n.activeTexture(n.TEXTURE0+e),t?n.bindTexture(n.TEXTURE_2D,t.webglResource):n.bindTexture(n.TEXTURE_2D,this.emptyTexture)}bindTextureAndWrap(t,e,n,i){const r=this.gl;r.activeTexture(r.TEXTURE0+e),t?r.bindTexture(r.TEXTURE_2D,t.webglResource):r.bindTexture(r.TEXTURE_2D,this.emptyTexture),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,n),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,i)}setTextureMode(t,e,n,i){const r=this.gl;r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,t),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,e),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,n),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,i)}createClientBuffer(t=4){return new gp(this.gl,t)}createDataTexture(t=4,e=1,n=1){return new bp(this.gl,t,e,n)}createClientDataTexture(t=1,e=1){return new vp(this.gl,t,e)}}const yp=qe(),xp=qe(),Tp=qe(),Lp=Ri(),Ep=Ui(Ri(),Zs,Math.PI/2);class Sp{constructor(){this.isPerspective=!0,this.fov=0,this.aspect=0,this.isOrtho=!1,this.leftClipPlane=0,this.rightClipPlane=0,this.bottomClipPlane=0,this.topClipPlane=0,this.nearClipPlane=0,this.farClipPlane=0,this.location=qe(),this.rotation=Ri(),this.inverseRotation=Ri(),this.viewMatrix=te(),this.projectionMatrix=te(),this.viewProjectionMatrix=te(),this.inverseViewMatrix=te(),this.inverseViewProjectionMatrix=te(),this.directionX=qe(),this.directionY=qe(),this.directionZ=qe(),this.vectors=[We(-1,-1,0),We(-1,1,0),We(1,1,0),We(1,-1,0),We(1,0,0),We(0,1,0),We(0,0,1)],this.billboardedVectors=[qe(),qe(),qe(),qe(),qe(),qe(),qe()],this.planes=[jn(),jn(),jn(),jn(),jn(),jn()]}perspective(t,e,n,i){this.isPerspective=!0,this.isOrtho=!1,this.fov=t,this.aspect=e,this.nearClipPlane=n,this.farClipPlane=i,this.update()}ortho(t,e,n,i,r,s){this.isPerspective=!1,this.isOrtho=!0,this.leftClipPlane=t,this.rightClipPlane=e,this.bottomClipPlane=n,this.topClipPlane=i,this.nearClipPlane=r,this.farClipPlane=s,this.update()}setLocation(t){Ze(this.location,t),this.update()}move(t){Qe(this.location,this.location,t),this.update()}setRotation(t){rr(this.rotation,t),this.update()}rotate(t){or(this.rotation,this.rotation,t),this.update()}face(t,e){or(this.rotation,Ep,ga(Lp,t,this.location,e)),this.update()}moveToAndFace(t,e,n){Ze(this.location,t),this.face(e,n)}reset(){Je(this.location,0,0,0),Ii(this.rotation),this.update()}update(){const t=this.location,e=this.rotation,n=this.inverseRotation,i=this.viewMatrix,r=this.projectionMatrix,s=this.viewProjectionMatrix,a=this.vectors,o=this.billboardedVectors;this.isPerspective?Ue(r,this.fov,this.aspect,this.nearClipPlane,this.farClipPlane):Ce(r,this.leftClipPlane,this.rightClipPlane,this.bottomClipPlane,this.topClipPlane,this.nearClipPlane,this.farClipPlane),Re(i,e),ce(i,i,pn(yp,t)),He(s,r,i),oe(this.inverseViewMatrix,i),oe(this.inverseViewProjectionMatrix,s),fa(this.planes,s),Xi(n,e),Ln(this.directionX,Zs,n),Ln(this.directionY,Js,n),Ln(this.directionZ,Qs,n);for(let t=0;t<7;t++)Ln(o[t],a[t],n)}cameraToWorld(t,e){return xn(t,e,this.inverseViewMatrix)}worldToCamera(t,e){return xn(t,e,this.viewMatrix)}worldToScreen(t,e,n){return xn(yp,e,this.viewProjectionMatrix),t[0]=Math.round((yp[0]+1)/2*n[2]),t[1]=Math.round((yp[1]+1)/2*n[3]),t}screenToWorldRay(t,e,n){const i=yp,r=xp,s=Tp,a=e[0],o=e[1],l=this.inverseViewProjectionMatrix;return sa(i,Je(s,a,o,0),l,n),sa(r,Je(s,a,o,1),l,n),t.set(i,0),t.set(r,3),t}}class Mp{constructor(t,e,n,i){this.plane=-1,this.instances=[],this.visible=!1,this.left=t,this.right=e,this.bottom=n,this.top=i}add(t){this.instances.push(t)}remove(t){const e=this.instances.indexOf(t);this.instances.splice(e,1)}clear(){this.instances.length=0}isVisible(t){return this.plane=ua(t.planes,this.left,this.right,this.bottom,this.top,this.plane),-1===this.plane}}class kp{constructor(t,e,n,i,r,s){this.cells=[];const a=n/r,o=i/s;this.x=t,this.y=e,this.width=n,this.depth=i,this.cellWidth=r,this.cellDepth=s,this.columns=a,this.rows=o;for(let n=0;n<o;n++)for(let i=0;i<a;i++){const o=t+i*r,l=o+r,h=e+n*s,u=h+s;this.cells[n*a+i]=new Mp(o,l,h,u)}}add(t){const e=this.cells,n=this.columns,i=t.left,r=t.right+1,s=t.bottom,a=t.top+1;if(-1!==i)for(let o=s;o<a;o++)for(let s=i;s<r;s++)e[o*n+s].add(t)}remove(t){const e=this.cells,n=this.columns,i=t.left,r=t.right+1,s=t.bottom,a=t.top+1;if(-1!==i){t.left=-1;for(let o=s;o<a;o++)for(let s=i;s<r;s++)e[o*n+s].remove(t)}}moved(t){const e=this.cellWidth,n=this.cellDepth,i=t.model.bounds,r=t.worldLocation[0]+i.x-this.x,s=t.worldLocation[1]+i.y-this.y,a=i.r,o=t.worldScale;let l=Math.floor((r-a*o[0])/e),h=Math.floor((r+a*o[0])/e),u=Math.floor((s-a*o[1])/n),c=Math.floor((s+a*o[1])/n);h<0||l>this.columns-1||c<0||u>this.rows-1?this.remove(t):(l=Math.max(l,0),h=Math.min(h,this.columns-1),u=Math.max(u,0),c=Math.min(c,this.rows-1),l===t.left&&h===t.right&&u===t.bottom&&c===t.top||(this.remove(t),t.left=l,t.right=h,t.bottom=u,t.top=c,this.add(t)))}clear(){for(const t of this.cells)t.clear()}}class Rp{constructor(){this.objects=[],this.alive=0}add(t){this.objects[this.alive++]=t}update(t){const e=this.objects;for(let n=0;n<this.alive;n++){const i=e[n];i.update(t*i.emitter.instance.timeScale),i.health<=0&&(this.alive-=1,i.emitter.kill(i),n!==this.alive&&(e[n]=e[this.alive],n-=1))}}}class Ip{constructor(t){this.camera=new Sp,this.grid=new kp(-1e5,-1e5,2e5,2e5,2e5,2e5),this.visibleCells=0,this.visibleInstances=0,this.updatedParticles=0,this.audioEnabled=!1,this.audioContext=null,this.instances=[],this.emittedObjectUpdater=new Rp,this.alpha=!1,this.color=qe(),this.viewport=jn(),this.lightPosition=We(0,0,1e4),this.viewer=t;const e=t.canvas,n=e.width,i=e.height;this.viewport[2]=n,this.viewport[3]=i,this.camera.perspective(Math.PI/4,n/i,8,1e4)}async enableAudio(){return"function"==typeof AudioContext&&(this.audioContext||(this.audioContext=new AudioContext),"suspended"!==this.audioContext.state&&await this.audioContext.resume(),this.audioEnabled="running"===this.audioContext.state,this.audioEnabled)}disableAudio(){this.audioContext&&this.audioContext.suspend(),this.audioEnabled=!1}addInstance(t){return t.scene!==this&&(t.scene&&t.scene.removeInstance(t),t.scene=this,this.grid.moved(t),!0)}removeInstance(t){return t.scene===this&&(this.grid.remove(t),t.scene=null,!0)}clear(){for(const t of this.grid.cells)for(const e of t.instances)e.scene=null;this.grid.clear()}detach(){return!!this.viewer&&this.viewer.removeScene(this)}update(t){const e=this.camera;if(this.audioContext){const t=this.audioContext.listener,n=e.location,i=e.directionY,r=e.directionZ;t.positionX.value=-n[0],t.positionY.value=-n[1],t.positionZ.value=-n[2],t.forwardX.value=i[0],t.forwardY.value=i[1],t.forwardZ.value=i[2],t.upX.value=r[0],t.upY.value=r[1],t.upZ.value=r[2]}const n=this.viewer.frame,i=this.instances;this.visibleCells=0,this.visibleInstances=0;for(const i of this.grid.cells)if(i.isVisible(e)){this.visibleCells+=1;for(const e of i.instances)e.rendered&&e.updateFrame<n&&!e.parent&&(e.updateFrame=n,e.update(t))}i.length=this.visibleInstances,i.sort(((t,e)=>t.depth-e.depth)),this.emittedObjectUpdater.update(t),this.updatedParticles=this.emittedObjectUpdater.alive}renderInstance(t){this.instances[this.visibleInstances++]=t}startFrame(){const t=this.viewer.gl,e=this.viewport;if(t.viewport(e[0],e[1],e[2],e[3]),t.scissor(e[0],e[1],e[2],e[3]),!this.alpha){const e=this.color;t.depthMask(!0),t.clearColor(e[0],e[1],e[2],1),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT)}}renderOpaque(){const t=this.instances;for(let e=0,n=t.length;e<n;e++)t[e].renderOpaque()}renderTranslucent(){const t=this.instances;for(let e=t.length-1;e>=0;e--)t[e].renderTranslucent()}render(){this.startFrame(),this.renderOpaque(),this.renderTranslucent()}clearEmittedObjects(){for(const t of this.emittedObjectUpdater.objects)t.health=0}}class Up{constructor(t){this.blockers=[],this.viewer=t.viewer,this.fetchUrl=t.fetchUrl}detach(){return this.viewer.unload(this)}}class Op extends Up{constructor(t,e){super(e),this.data=null,this.data=t}}class Cp extends Up{constructor(t){super(t),this.pathSolver=t.pathSolver}}class Bp extends Cp{constructor(){super(...arguments),this.webglResource=null,this.width=0,this.height=0}}class Pp extends Bp{constructor(t,e){super(e);const n=this.viewer.gl;this.webglResource=n.createTexture(),n.bindTexture(n.TEXTURE_2D,this.webglResource),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,t),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.LINEAR),Sa(t.width)&&Sa(t.height)?(n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR_MIPMAP_LINEAR),n.generateMipmap(n.TEXTURE_2D)):(n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE)),this.width=t.width,this.height=t.height}}var Np;!function(t){t[t.None=0]="None",t[t.Diffuse=1]="Diffuse",t[t.NormalMap=2]="NormalMap",t[t.Occlusion=3]="Occlusion",t[t.Roughness=4]="Roughness",t[t.Metallic=5]="Metallic",t[t.TCFactor=6]="TCFactor",t[t.Emissive=7]="Emissive",t[t.TexCoords=8]="TexCoords",t[t.Normals=9]="Normals",t[t.Tangents=10]="Tangents"}(Np||(Np={}));class Dp extends mp.EventEmitter{constructor(t,e){super(),this.resources=[],this.resourceMap=new Map,this.promiseMap=new Map,this.handlers=new Set,this.scenes=[],this.frame=0,this.visibleCells=0,this.visibleInstances=0,this.updatedParticles=0,this.audioEnabled=!1,this.sharedCache=new Map,this.debugRenderMode=Np.None,this.directLoadId=0;const n=new Ap(t,e),i=n.gl;this.canvas=t,this.gl=i,this.webgl=n,this.buffer=n.createClientBuffer(),i.depthFunc(i.LEQUAL),i.enable(i.DEPTH_TEST),i.enable(i.SCISSOR_TEST)}enableAudio(){return"function"==typeof AudioContext&&(this.audioEnabled=!0,!0)}addHandler(t,...e){if(t){const n=this.handlers;if(!n.has(t)){if(!t.isValidSource)return this.emit("error",{viewer:this,error:"Handler missing the isValidSource function",handler:t}),!1;if(t.load)try{t.load(this,...e)}catch(e){return this.emit("error",{viewer:this,error:"Handler failed to load",handler:t,reason:e}),!1}return n.add(t),!0}}return!1}addScene(){const t=new Ip(this);return this.scenes.push(t),t}removeScene(t){const e=this.scenes,n=e.indexOf(t);return-1!==n&&(e.splice(n,1),!0)}clear(){this.scenes.length=0}async load(t,e,n){let i,r,s="";if(e)try{i=e(t,n)}catch(i){return void this.emit("error",{viewer:this,error:"Path solver failed",src:t,reason:i,pathSolver:e,solverParams:n})}else i=t;if(i){if(i instanceof Promise&&(i=await i),i instanceof Up)return i;if("string"!=typeof i||this.detectFormat(i))s="__DIRECT_LOAD_"+this.directLoadId++,r=Promise.resolve(i);else{if(s=i,r=this.promiseMap.get(s),r)return r;const t=this.resourceMap.get(s);if(t)return t;r=_p(s,"arrayBuffer").then((t=>t.ok?t.data:void this.emit("error",{viewer:this,error:`Failed to fetch a resource: ${t.error}`,fetchUrl:s,reason:t.data})))}return r=r.then((async n=>{if(n){if(n instanceof ArrayBuffer&&(n=new Uint8Array(n)),function(t){return t instanceof ImageData||t instanceof HTMLImageElement||t instanceof HTMLCanvasElement||t instanceof HTMLVideoElement}(n))return new Pp(n,{viewer:this,fetchUrl:s,pathSolver:e});if(n instanceof Uint8Array){const t=function(t){return To(t)?"image/png":Lo(t)?"image/jpeg":Eo(t)?"image/gif":So(t)?"image/webp":""}(n);if(t.length)return new Pp(await Ua(new Blob([n.buffer],{type:t})),{viewer:this,fetchUrl:s,pathSolver:e})}const i=this.detectFormat(n);if(i)try{const t=new i.resource(n,{viewer:this,fetchUrl:s,pathSolver:e});return await Promise.all(t.blockers),t.blockers.length=0,t}catch(e){this.emit("error",{viewer:this,error:"Failed to create a resource",fetchUrl:s,src:t,reason:e})}else this.emit("error",{viewer:this,error:"Source has no matching handler",fetchUrl:s,src:t})}})).then((t=>(this.promiseMap.delete(s),t&&(this.resourceMap.set(s,t),this.resources.push(t),this.emit("load",{viewer:this,fetchUrl:s,resource:t})),this.emit("loadend",{viewer:this,fetchUrl:s,resource:t}),this.checkLoadingStatus(),t))),this.promiseMap.set(s,r),this.emit("loadstart",{viewer:this,fetchUrl:s,promise:r}),r}}detectFormat(t){for(const e of this.handlers)if(e.isValidSource(t))return e}has(t){return this.resourceMap.has(t)}get(t){return this.resourceMap.get(t)}async loadGeneric(t,e,n){const i=this.promiseMap.get(t);if(i)return i;const r=this.resourceMap.get(t);if(r)return r;const s=_p(t,e).then((async e=>{let i;if(this.promiseMap.delete(t),e.ok){let r=e.data;n&&(r=await n(r)),i=new Op(r,{viewer:this,fetchUrl:t}),this.resourceMap.set(t,i),this.resources.push(i),this.emit("load",{viewer:this,fetchUrl:t,resource:i})}else this.emit("error",{viewer:this,error:"Failed to fetch a generic resource",fetchUrl:t});return this.emit("loadend",{viewer:this,fetchUrl:t,resource:i}),this.checkLoadingStatus(),i}));return this.promiseMap.set(t,s),this.emit("loadstart",{viewer:this,fetchUrl:t}),s}unload(t){const e=t.fetchUrl;""!==e&&this.resourceMap.delete(e);const n=this.resources,i=n.indexOf(t);return-1!==i&&(n.splice(i,1),!0)}promise(){const t=Promise.resolve(void 0),e=`${performance.now()}`;return this.promiseMap.set(e,t),()=>{this.promiseMap.delete(e),this.checkLoadingStatus()}}checkLoadingStatus(){0===this.promiseMap.size&&setTimeout((()=>this.emit("idle")),0)}whenAllLoaded(t){const e=new Promise((t=>{0===this.promiseMap.size?t(this):this.once("idle",(()=>t(this)))}));if(!t)return e;e.then((()=>t(this)))}toBlob(t){const e=new Promise((t=>this.canvas.toBlob((e=>t(e)))));if(!t)return e;e.then((e=>t(e)))}updateAndRender(t=1e3/60){this.update(t),this.startFrame(),this.render()}update(t=1e3/60){t*=.001,this.frame+=1,this.visibleCells=0,this.visibleInstances=0,this.updatedParticles=0;for(const e of this.scenes)e.update(t),this.visibleCells+=e.visibleCells,this.visibleInstances+=e.visibleInstances,this.updatedParticles+=e.updatedParticles}startFrame(){const t=this.gl;t.depthMask(!0),t.clearColor(0,0,0,1),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT)}render(){for(const t of this.scenes)t.render()}clearEmittedObjects(){for(const t of this.scenes)t.clearEmittedObjects()}}const Fp=qe(),Vp=Ri(),Gp=qe();class Kp{constructor(){this.pivot=qe(),this.localLocation=qe(),this.localRotation=Ri(),this.localScale=We(1,1,1),this.worldLocation=qe(),this.worldRotation=Ri(),this.worldScale=We(1,1,1),this.inverseWorldLocation=qe(),this.inverseWorldRotation=Ri(),this.inverseWorldScale=We(1,1,1),this.localMatrix=te(),this.worldMatrix=te(),this.dontInheritTranslation=!1,this.dontInheritRotation=!1,this.dontInheritScaling=!0,this.parent=null,this.children=[]}setPivot(t){return Ze(this.pivot,t),this.recalculateTransformation(),this}setLocation(t){return Ze(this.localLocation,t),this.recalculateTransformation(),this}setRotation(t){return rr(this.localRotation,t),this.recalculateTransformation(),this}setScale(t){return Ze(this.localScale,t),this.recalculateTransformation(),this}setUniformScale(t){return Je(this.localScale,t,t,t),this.recalculateTransformation(),this}setTransformation(t,e,n){const i=this.localLocation,r=this.localRotation,s=this.localScale;return i[0]=t[0],i[1]=t[1],i[2]=t[2],r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[3],s[0]=n[0],s[1]=n[1],s[2]=n[2],this.recalculateTransformation(),this}resetTransformation(){return Ze(this.pivot,ta),Ze(this.localLocation,ta),rr(this.localRotation,ia),Ze(this.localScale,ea),this.recalculateTransformation(),this}movePivot(t){return Qe(this.pivot,this.pivot,t),this.recalculateTransformation(),this}move(t){return Qe(this.localLocation,this.localLocation,t),this.recalculateTransformation(),this}rotate(t){return or(this.localRotation,this.localRotation,t),this.recalculateTransformation(),this}rotateLocal(t){return or(this.localRotation,t,this.localRotation),this.recalculateTransformation(),this}scale(t){return Pn(this.localScale,this.localScale,t),this.recalculateTransformation(),this}uniformScale(t){return hn(this.localScale,this.localScale,t),this.recalculateTransformation(),this}face(t,e){return Xi(this.localRotation,ga(this.localRotation,this.localLocation,t,e)),this.recalculateTransformation(),this}setParent(t){if(this.parent){const t=this.parent.children,e=t.indexOf(this);-1!==e&&t.splice(e,1)}return this.parent=t||null,t&&t.children.push(this),this.recalculateTransformation(),this}recalculateTransformation(){const t=this.parent,e=this.localMatrix,n=this.localLocation,i=this.localRotation,r=this.localScale,s=this.worldMatrix,a=this.worldLocation,o=this.worldRotation,l=this.worldScale,h=this.inverseWorldLocation,u=this.inverseWorldRotation,c=this.inverseWorldScale;if(t){const a=Fp,h=t.pivot;let u,c;if(a[0]=n[0]+h[0],a[1]=n[1]+h[1],a[2]=n[2]+h[2],this.dontInheritRotation?(u=Vp,or(u,i,t.inverseWorldRotation)):u=i,this.dontInheritScaling){c=Gp;const e=t.inverseWorldScale;c[0]=e[0]*r[0],c[1]=e[1]*r[1],c[2]=e[2]*r[2],l[0]=r[0],l[1]=r[1],l[2]=r[2]}else{c=r;const e=t.worldScale;l[0]=e[0]*r[0],l[1]=e[1]*r[1],l[2]=e[2]*r[2]}Me(e,u,a,c),He(s,t.worldMatrix,e),or(o,t.worldRotation,u)}else Me(e,i,n,r),s[0]=e[0],s[1]=e[1],s[2]=e[2],s[3]=e[3],s[4]=e[4],s[5]=e[5],s[6]=e[6],s[7]=e[7],s[8]=e[8],s[9]=e[9],s[10]=e[10],s[11]=e[11],s[12]=e[12],s[13]=e[13],s[14]=e[14],s[15]=e[15],o[0]=i[0],o[1]=i[1],o[2]=i[2],o[3]=i[3],l[0]=r[0],l[1]=r[1],l[2]=r[2];u[0]=-o[0],u[1]=-o[1],u[2]=-o[2],u[3]=o[3],c[0]=1/l[0],c[1]=1/l[1],c[2]=1/l[2],a[0]=s[12],a[1]=s[13],a[2]=s[14],h[0]=-a[0],h[1]=-a[1],h[2]=-a[2];for(const t of this.children)t.recalculateTransformation()}update(t){for(const e of this.children)e.update(t)}}class jp{constructor(){this.x=0,this.y=0,this.z=0,this.r=0}fromExtents(t,e){const n=t[0],i=t[1],r=t[2],s=e[0]-n,a=e[1]-i,o=e[2]-r;this.x=n+s/2,this.y=i+a/2,this.z=r+o/2,this.r=Math.max(0,Math.max(s,a,o)/2)}}class zp extends Cp{constructor(){super(...arguments),this.bounds=new jp}}class Hp extends Kp{constructor(t){super(),this.scene=null,this.left=-1,this.right=-1,this.bottom=-1,this.top=-1,this.plane=-1,this.depth=0,this.updateFrame=0,this.timeScale=1,this.rendered=!0,this.textureOverrides=new Map,this.model=t}show(){this.rendered=!0}hide(){this.rendered=!1}shown(){return this.rendered}hidden(){return!this.rendered}detach(){return!!this.scene&&this.scene.removeInstance(this)}overrideTexture(t,e){e?this.textureOverrides.set(t,e):this.textureOverrides.delete(t)}getBounds(){return this.model.bounds}clearEmittedObjects(){}setScene(t){return t.addInstance(this)}recalculateTransformation(){super.recalculateTransformation(),this.scene&&this.scene.grid.moved(this)}update(t){const e=this.scene;e&&this.rendered&&this.isVisible(e.camera)&&(e.renderInstance(this),this.updateAnimations(t*this.timeScale),super.update(t))}updateAnimations(t){}renderOpaque(){}renderTranslucent(){}isVisible(t){const[e,n,i]=this.worldLocation,[r,s,a]=this.worldScale,o=this.getBounds(),l=t.planes;let h=r;return s>h&&(h=s),a>h&&(h=a),this.plane=ha(l,e+o.x,n+o.y,i+o.z,o.r*h,this.plane),-1===this.plane&&(this.depth=la(l[4],e,n,i),!0)}}const Xp={WebGL:Ap,Shader:wp,ClientBuffer:gp,DataTexture:bp,ClientDataTexture:vp};const qp={isValidSource(t){return t instanceof Yf||((e=t)instanceof ArrayBuffer&&(e=new Uint8Array(e)),e instanceof Uint8Array&&66===e[0]&&76===e[1]&&80===e[2]&&49===e[3]);var e},resource:class extends Bp{constructor(t,e){let n;super(e),t instanceof Yf?n=t:(n=new Yf,n.load(t));const i=this.viewer.gl,r=i.createTexture();i.bindTexture(i.TEXTURE_2D,r),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR);const s=Sa(n.width)&&Sa(n.height);s||(i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE));const a=n.mipmaps();if(1===a||n.fakeMipmaps()||!s){const t=n.getMipmap(0);i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,i.RGBA,i.UNSIGNED_BYTE,t)}else{i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR_MIPMAP_LINEAR);let t=n.width,e=n.height;for(let r=0;r<a;r++){const s=n.getMipmap(r);i.texImage2D(i.TEXTURE_2D,r,i.RGBA,t,e,0,i.RGBA,i.UNSIGNED_BYTE,s.data),t=Math.ceil(t/2),e=Math.ceil(e/2)}}this.width=n.width,this.height=n.height,this.webglResource=r}}};const Yp={load(t){t.webgl.ensureExtension("WEBGL_compressed_texture_s3tc")||console.warn("DDS: No compressed textures support! This might reduce performance.")},isValidSource:t=>t instanceof up||cp(t),resource:class extends Bp{constructor(t,e){let n;super(e),t instanceof up?n=t:(n=new up,n.load(t));const i=this.viewer,r=i.gl,s=i.webgl.extensions.WEBGL_compressed_texture_s3tc,a=n.format;let o=0;s&&(a===ap?o=s.COMPRESSED_RGB_S3TC_DXT1_EXT:a===op?o=s.COMPRESSED_RGBA_S3TC_DXT3_EXT:a===lp&&(o=s.COMPRESSED_RGBA_S3TC_DXT5_EXT));const l=r.createTexture();this.width=n.width,this.height=n.height,this.webglResource=l,r.bindTexture(r.TEXTURE_2D,l);const h=n.mipmaps();a!==ap&&a!==hp||r.pixelStorei(r.UNPACK_ALIGNMENT,2);for(let t=0;t<h;t++){const{width:e,height:i,data:s}=n.getMipmap(t,0!==o);o?r.compressedTexImage2D(r.TEXTURE_2D,t,o,e,i,0,s):a===ap||a===op||a===lp?r.texImage2D(r.TEXTURE_2D,t,r.RGBA,e,i,0,r.RGBA,r.UNSIGNED_BYTE,s):r.texImage2D(r.TEXTURE_2D,t,r.LUMINANCE_ALPHA,e,i,0,r.LUMINANCE_ALPHA,r.UNSIGNED_BYTE,s)}r.pixelStorei(r.UNPACK_ALIGNMENT,4),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.LINEAR),h>1?r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR_MIPMAP_LINEAR):r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR)}}};class $p{constructor(t,e){this.texture=null,this.wrapS=33071,this.wrapT=33071,t&&(this.wrapS=10497),e&&(this.wrapT=10497)}}const Wp={diffuse:1,decal:2,specular:3,gloss:4,emissive:5,emissive2:6,evio:7,evioMask:8,alphaMask:9,alphaMask2:10,normal:11,heightMap:12,lightMap:13,ao:14};class Zp{constructor(t,e,n,i,r){this.active=0,this.layer=null,this.source="",this.texture=null,this.flags=0,this.colorChannels=0,this.type="",this.op=0,this.uvCoordinate=0,this.textureUnit=0,this.invert=0,this.clampResult=0,this.teamColorMode=0;const s=t.model;this.model=s,this.material=t,this.gl=t.gl,this.index=e;const a="u_"+i,o=a+"LayerSettings.";if(this.uniformMap={map:a+"Map",enabled:o+"enabled",op:o+"op",channels:o+"channels",teamColorMode:o+"teamColorMode",invert:o+"invert",clampResult:o+"clampResult",uvCoordinate:o+"uvCoordinate"},n.entries){const t=n.first();this.layer=t;const e=s.pathSolver,a=t.imagePath.get();if(a){const n=a.toLowerCase();if(n.length){this.source=n,this.active=1;const a=t.uvSource,o=t.flags;this.flags=o,this.colorChannels=t.colorChannelSetting,this.model=s,this.type=i,this.op=r;let l=0;1===a?l=1:9===a?l=2:10===a&&(l=3),this.uvCoordinate=l,this.textureUnit=Wp[i],this.invert=16&o,this.clampResult=32&o,"diffuse"===i&&(this.teamColorMode=1);const h=new $p(!!(4&o),!!(8&o));s.viewer.load(n,e).then((t=>{t&&(h.texture=t)})),this.texture=h}}}}bind(t,e){const n=this.gl,i=this.uniformMap,r=t.uniforms,s=this.active;if(n.uniform1f(r[i.enabled],s),s){const t=this.texture,s=e.get(this.material.index*Jp+this.index)||t.texture,a=this.textureUnit;n.uniform1i(r[i.map],a),this.model.viewer.webgl.bindTextureAndWrap(s,a,t.wrapS,t.wrapT),n.uniform1f(r[i.op],this.op),n.uniform1f(r[i.channels],this.colorChannels),n.uniform1f(r[i.teamColorMode],this.teamColorMode),n.uniform1f(r[i.invert],this.invert),n.uniform1f(r[i.clampResult],this.clampResult),n.uniform1f(r[i.uvCoordinate],this.uvCoordinate)}}unbind(t){this.active&&this.gl.uniform1f(t.uniforms[this.uniformMap.enabled],0)}}const Jp=100;class Qp{constructor(t,e,n){this.model=t,this.gl=t.viewer.gl,this.index=e,this.name=n.name.get(),this.flags=n.flags,this.blendMode=n.blendMode,this.priority=n.priority,this.specularity=n.specularity,this.specMult=n.specMult,this.emisMult=n.emisMult,this.layerBlendType=n.layerBlendType,this.emisBlendType=n.emisBlendType,this.emisMode=n.emisMode,this.doubleSided=8&n.flags,this.layers=[new Zp(this,0,n.diffuseLayer,"diffuse",2),new Zp(this,1,n.decalLayer,"decal",2),new Zp(this,2,n.specularLayer,"specular",2),new Zp(this,3,n.glossLayer,"gloss",2),new Zp(this,4,n.emissiveLayer,"emissive",n.emisBlendType),new Zp(this,5,n.emissive2Layer,"emissive2",n.emisMode),new Zp(this,6,n.evioLayer,"evio",2),new Zp(this,7,n.evioMaskLayer,"evioMask",2),new Zp(this,8,n.alphaMaskLayer,"alphaMask",2),new Zp(this,9,n.alphaMask2Layer,"alphaMask2",2),new Zp(this,10,n.normalLayer,"normal",2),new Zp(this,11,n.heightLayer,"heightMap",2),new Zp(this,12,n.lightMapLayer,"lightMap",2),new Zp(this,13,n.ambientOcclusionLayer,"ao",2)]}bindCommon(){const t=this.gl;1===this.blendMode||2===this.blendMode?(t.enable(t.BLEND),t.blendFunc(t.ONE,t.ONE)):t.disable(t.BLEND),this.doubleSided?t.disable(t.CULL_FACE):t.enable(t.CULL_FACE),t.enable(t.DEPTH_TEST),t.depthMask(!0)}bind(t,e){const n=this.gl;this.bindCommon(),n.uniform1f(t.uniforms.u_specularity,this.specularity),n.uniform1f(t.uniforms.u_specMult,this.specMult),n.uniform1f(t.uniforms.u_emisMult,this.emisMult),n.uniform4f(t.uniforms.u_lightAmbient,.02,.02,.02,0);const i=this.layers;i[0].bind(t,e),i[1].bind(t,e),i[2].bind(t,e),i[4].bind(t,e),i[5].bind(t,e),i[10].bind(t,e),i[12].bind(t,e)}unbind(t){const e=this.gl;e.disable(e.BLEND),e.enable(e.CULL_FACE);const n=this.layers;n[0].unbind(t),n[1].unbind(t),n[2].unbind(t),n[4].unbind(t),n[5].unbind(t),n[10].unbind(t),n[12].unbind(t)}}class tm{constructor(t){const e=t.flags;this.name=t.name.get(),this.parent=t.parent,this.location=t.location,this.rotation=t.rotation,this.scale=t.scale,this.visibility=t.visibility,this.inhertTranslation=1&e,this.inheritScale=2&e,this.inheritRotation=4&e,this.billboard1=16&e,this.billboard2=64&e,this.twoDProjection=256&e,this.animated=512&e,this.inverseKinematics=1024&e,this.skinned=2048&e,this.real=8192&e}}class em{constructor(t){this.name=t.name.get(),this.interval=t.interval,this.movementSpeed=t.movementSpeed,this.frequency=t.frequency,this.boundingSphere=t.boundingSphere,this.flags=t.flags}}class nm{constructor(t){this.animIds=new Map;const e=t.animIds.get();for(let t=0,n=e.length;t<n;t++)this.animIds.set(e[t],t)}hasData(t){return this.animIds.has(t.animId)}}const im=qe(),rm=Ri();class sm{constructor(t){this.keys=t.keys.get(),this.values=t.values.get(),this.biggestKey=t.biggestKey}}class am{constructor(){this.sd=[]}addSds(t){for(const e of t)this.sd.push(new sm(e))}getValueUnsafe(t,e,n,i){const r=this.sd[t];i&&(n%=r.biggestKey);const s=r.keys,a=r.values;let o=s.length,l=0;for(;l!==s.length&&n>s[l];)o=l,l++;const h=s.length;if(o===h)return l===h?e.initValue:a[l];if(l===h||o>=l)return a[o];const u=Aa((n-s[o])/(s[l]-s[o]),0,1),c=a[o],d=a[l],f=e.interpolationType,p=c;return 4===p.length?0===f?rr(rm,c):ji(rm,c,d,u):3===p.length?0===f?Ze(im,c):bn(im,c,d,u):0===f?c:ya(c,d,u)}}class om{constructor(t){this.animRefs=[],this.sd=[];const e=t.animIds.get();this.name=t.name.get(),this.runsConcurrent=t.runsConcurrent,this.priority=t.priority,this.stsIndex=t.stsIndex;const n=t.animRefs.get(),i=new Uint16Array(n.buffer);for(let t=0,n=e.length;t<n;t++)this.animRefs[e[t]]=[i[2*t+1],i[2*t]];for(const e of t.sd){const t=new am,n=e.get();n&&t.addSds(n),this.sd.push(t)}}getValueUnsafe(t,e){const n=this.animRefs[t.animId];return n?this.sd[n[0]].getValueUnsafe(n[1],t,e.frame,this.runsConcurrent):t.initValue}}class lm{constructor(t,e,n){this.name=t.name.get(),this.stcIndices=t.stcIndices.get(),this.sts=e,this.stc=n}getValueUnsafe(t,e){const n=this.stcIndices,i=this.stc,r=this.sts;for(let s=0,a=n.length;s<a;s++){const a=i[n[s]];if(r[a.stsIndex].hasData(t))return a.getValueUnsafe(t,e)}return t.initValue}}class hm{constructor(t){this.name=t.name.get(),this.bone=t.bone}}class um{constructor(t){this.bone=t.bone,this.name=t.name.get()}}class cm{constructor(t,e,n,i,r){const s=e.firstVertexIndex,a=e.triangleIndicesCount,o=e.firstTriangleIndex;for(let t=0;t<a;t++)i[r+t]=n[o+t]+s;this.gl=t.viewer.gl,this.firstBoneLookupIndex=e.firstBoneLookupIndex,this.boneWeightPairsCount=e.boneWeightPairsCount,this.offset=2*r,this.verticesCount=e.verticesCount,this.elements=a}render(t){const e=this.gl;e.uniform1f(t.uniforms.u_firstBoneLookupIndex,this.firstBoneLookupIndex),e.uniform1f(t.uniforms.u_boneWeightPairsCount,this.boneWeightPairsCount),e.drawElements(e.TRIANGLES,this.elements,e.UNSIGNED_SHORT,this.offset)}}const dm=qe(),fm=Ri(),pm=qe(),mm=qe(),_m=Ri();class gm{constructor(t,e,n,i,r,s,a,o,l,h,u,c){this.dontInheritTranslation=!1,this.dontInheritRotation=!1,this.dontInheritScaling=!1,this.billboarded=!1,this.billboardedX=!1,this.billboardedY=!1,this.billboardedZ=!1,this.dirty=!0,this.wasDirty=!1,this.parent=null,this.children=[],this.object=null,this.pivot=t,this.localLocation=e,this.localRotation=n,this.localScale=i,this.worldLocation=r,this.worldRotation=s,this.worldScale=a,this.inverseWorldLocation=o,this.inverseWorldRotation=l,this.inverseWorldScale=h,this.localMatrix=u,this.worldMatrix=c,this.localRotation[3]=1,this.localScale.fill(1),this.localMatrix[0]=1,this.localMatrix[5]=1,this.localMatrix[10]=1,this.localMatrix[15]=1}recalculateTransformation(t){const e=t.scene,n=this.localMatrix,i=this.localLocation,r=this.localRotation,s=this.localScale,a=this.worldMatrix,o=this.worldLocation,l=this.worldRotation,h=this.worldScale,u=this.pivot,c=this.inverseWorldLocation,d=this.inverseWorldRotation,f=this.inverseWorldScale,p=this.parent;let m,_,g;if(this.dontInheritTranslation?(Qe(dm,p.inverseWorldLocation,o),m=Qe(dm,dm,i)):m=i,this.dontInheritScaling?(Pn(dm,p.inverseWorldScale,t.worldScale),g=Pn(dm,dm,s)):g=s,this.billboarded)_=fm,rr(_,p.inverseWorldRotation),or(_,_,e.camera.inverseRotation),this.convertBasis(_),or(_,_,r);else{const{billboardedX:t,billboardedY:n,billboardedZ:i}=this;t||n||i?(t&&(g===s&&(g=pm,Ze(g,s)),g[2]*=-1),_m[0]=-r[0],_m[1]=-r[1],_m[2]=-r[2],or(_m,_m,p.inverseWorldRotation),Ln(mm,e.camera.billboardedVectors[6],_m),t?Ui(_m,Zs,Math.atan2(mm[2],mm[1])):n?Ui(_m,Js,Math.atan2(-mm[2],mm[0])):Ui(_m,Qs,Math.atan2(mm[1],mm[0])),_=fm,or(_,r,_m)):_=r}this.dontInheritRotation&&(or(_m,p.inverseWorldRotation,t.worldRotation),_=or(fm,_m,_)),ke(n,_,m,g,u),He(a,p.worldMatrix,n);const v=u[0],b=u[1],w=u[2];o[0]=a[0]*v+a[4]*b+a[8]*w+a[12],o[1]=a[1]*v+a[5]*b+a[9]*w+a[13],o[2]=a[2]*v+a[6]*b+a[10]*w+a[14],c[0]=-o[0],c[1]=-o[1],c[2]=-o[2],or(l,p.worldRotation,_),d[0]=-l[0],d[1]=-l[1],d[2]=-l[2],d[3]=l[3];const A=p.worldScale;h[0]=A[0]*g[0],h[1]=A[1]*g[1],h[2]=A[2]*g[2],f[0]=1/h[0],f[1]=1/h[1],f[2]=1/h[2]}convertBasis(t){}}function vm(t,e=gm){const n=new Float32Array(65*t),i=[];let r=0;const s=3*t,a=4*t,o=16*t,l=n.subarray(r,r+s);r+=s;const h=n.subarray(r,r+s);r+=s;const u=n.subarray(r,r+a);r+=a;const c=n.subarray(r,r+s);r+=s;const d=n.subarray(r,r+s);r+=s;const f=n.subarray(r,r+a);r+=a;const p=n.subarray(r,r+s);r+=s;const m=n.subarray(r,r+s);r+=s;const _=n.subarray(r,r+a);r+=a;const g=n.subarray(r,r+s);r+=s;const v=n.subarray(r,r+o);r+=o;const b=n.subarray(r,r+o);for(let n=0;n<t;n++){const t=3*n,r=t+3,s=4*n,a=s+4,o=16*n,w=o+16;i[n]=new e(l.subarray(t,r),h.subarray(t,r),u.subarray(s,a),c.subarray(t,r),d.subarray(t,r),f.subarray(s,a),p.subarray(t,r),m.subarray(t,r),_.subarray(s,a),g.subarray(t,r),v.subarray(o,w),b.subarray(o,w))}return{data:n,nodes:i,pivots:l,localLocations:h,localRotations:u,localScales:c,worldLocations:d,worldRotations:f,worldScales:p,inverseWorldLocations:m,invereseWorldRotations:_,inverseWorldScales:g,localMatrices:v,worldMatrices:b}}class bm extends gm{convertBasis(t){const e=Math.PI/2;Di(t,t,e),Ni(t,t,-e)}}class wm{constructor(t){const e=t.model,n=e.bones,i=e.boneLookup,r=vm(n.length,bm),s=r.nodes;this.nodes=s,this.worldMatrices=r.worldMatrices,this.instance=t,this.modelNodes=n,this.initialReference=e.initialReference,this.sts=e.sts,this.stc=e.stc,this.stg=e.stg,this.boneLookup=i;for(let e=0,i=n.length;e<i;e++){const i=n[e];-1===i.parent?s[e].parent=t:s[e].parent=s[i.parent],i.billboard1&&(s[e].billboarded=!0)}}update(t){const e=this.instance,n=this.nodes,i=this.modelNodes;for(let r=0,s=n.length;r<s;r++){const s=n[r],a=i[r];this.getValue4(s.localRotation,a.rotation,e),this.getValue3(s.localLocation,a.location,e),this.getValue3(s.localScale,a.scale,e),s.recalculateTransformation(e);for(const e of s.children)e.recalculateTransformation(),e.update(t)}}getValueUnsafe(t,e){const n=e.sequence;return-1!==n?this.stg[n].getValueUnsafe(t,e):t.initValue}getValue(t,e){return this.getValueUnsafe(t,e)}getValue2(t,e,n){const i=this.getValueUnsafe(e,n);return t[0]=i[0],t[1]=i[1],t}getValue3(t,e,n){const i=this.getValueUnsafe(e,n);return t[0]=i[0],t[1]=i[1],t[2]=i[2],t}getValue4(t,e,n){const i=this.getValueUnsafe(e,n);return t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=i[3],t}}const Am=te();class ym extends Hp{constructor(t){super(t),this.skeleton=null,this.teamColor=0,this.vertexColor=new Float32Array([1,1,1,1]),this.sequence=-1,this.frame=0,this.sequenceLoopMode=0,this.sequenceEnded=!1,this.forced=!0,this.boneTexture=null,this.skeleton=new wm(this),-1!==this.sequence&&this.setSequence(this.sequence),this.boneTexture=new bp(t.viewer.gl,3,4*t.boneLookup.length,1)}setTexture(t,e,n){this.overrideTexture(t*Jp+e,n)}updateSkeletonAndBoneTexture(t){const e=this.model,n=e.viewer.buffer,i=e.boneLookup,r=this.skeleton,s=r.nodes,a=e.initialReference,o=i.length,l=-1!==this.sequence,h=this.boneTexture;r.update(t),n.reserve(48*o);const u=n.floatView;let c;c=l?Am:this.worldMatrix;for(let t=0;t<o;t++){const e=12*t;if(l){const e=i[t];c=He(Am,s[e].worldMatrix,a[e])}u[e+0]=c[0],u[e+1]=c[1],u[e+2]=c[2],u[e+3]=c[4],u[e+4]=c[5],u[e+5]=c[6],u[e+6]=c[8],u[e+7]=c[9],u[e+8]=c[10],u[e+9]=c[12],u[e+10]=c[13],u[e+11]=c[14]}h.bindAndUpdate(u,h.width,1)}renderOpaque(){const t=this.model,e=t.batches;if(e.length){const n=t.viewer,i=n.sharedCache.get("m3"),r=n.gl,s=t.vertexSize,a=t.uvSetCount,o=i.standardShaders[a-1],l=o.attribs,h=o.uniforms,u=this.scene,c=u.camera,d=this.textureOverrides,f=this.boneTexture;o.use(),r.uniform1f(h.u_teamColor,this.teamColor),r.uniform4fv(h.u_vertexColor,this.vertexColor),r.uniformMatrix4fv(h.u_VP,!1,c.viewProjectionMatrix),r.uniformMatrix4fv(h.u_MV,!1,c.viewMatrix),r.uniform3fv(h.u_eyePos,c.location),r.uniform3fv(h.u_lightPos,u.lightPosition),f.bind(15),r.uniform1i(h.u_boneMap,15),r.uniform1f(h.u_vectorSize,1/f.width),r.uniform1f(h.u_rowSize,1),r.bindBuffer(r.ARRAY_BUFFER,t.arrayBuffer),r.vertexAttribPointer(l.a_position,3,r.FLOAT,!1,s,0),r.vertexAttribPointer(l.a_weights,4,r.UNSIGNED_BYTE,!1,s,12),r.vertexAttribPointer(l.a_bones,4,r.UNSIGNED_BYTE,!1,s,16),r.vertexAttribPointer(l.a_normal,4,r.UNSIGNED_BYTE,!1,s,20);for(let t=0;t<a;t++)r.vertexAttribPointer(l[`a_uv${t}`],2,r.SHORT,!1,s,24+4*t);r.vertexAttribPointer(l.a_tangent,4,r.UNSIGNED_BYTE,!1,s,24+4*a),r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,t.elementBuffer);for(const t of e){const e=t.material,n=t.region;e.bind(o,d),n.render(o),e.unbind(o)}}}updateAnimations(t){const e=this.sequence;if(-1!==e){const n=this.model.sequences[e],i=n.interval;this.frame+=1e3*t,this.frame>i[1]?((0!==this.sequenceLoopMode||1&n.flags)&&2!==this.sequenceLoopMode?this.frame=i[1]:this.frame=i[0],this.sequenceEnded=!0):this.sequenceEnded=!1}(this.forced||-1!==e)&&(this.forced=!1,this.updateSkeletonAndBoneTexture(t))}setTeamColor(t){return this.teamColor=t,this}setVertexColor(t){return this.vertexColor.set(t),this}setSequence(t){const e=this.model;return this.sequence=t,this.frame=0,(t<-1||t>e.sequences.length-1)&&(t=-1,this.sequence=t),this.forced=!0,this}setSequenceLoopMode(t){return this.sequenceLoopMode=t,this}getAttachment(t){const e=this.model.attachments[t];if(e)return this.skeleton.nodes[e.bone]}}class xm{constructor(t,e){this.region=t,this.material=e}}const Tm="\nuniform sampler2D u_boneMap;\nuniform float u_vectorSize;\nuniform float u_rowSize;\n\nmat4 fetchMatrix(float column, float row) {\n  column *= u_vectorSize * 4.0;\n  row *= u_rowSize;\n  // Add in half a texel, to sample in the middle of the texel.\n  // Otherwise, since the sample is directly on the boundary, floating point errors can cause the sample to get the wrong pixel.\n  // This is most noticeable with NPOT textures, which the bone maps are.\n  column += 0.5 * u_vectorSize;\n  row += 0.5 * u_rowSize;\n\n  return mat4(texture2D(u_boneMap, vec2(column, row)),\n              texture2D(u_boneMap, vec2(column + u_vectorSize, row)),\n              texture2D(u_boneMap, vec2(column + u_vectorSize * 2.0, row)),\n              texture2D(u_boneMap, vec2(column + u_vectorSize * 3.0, row)));\n}\n",Lm=`\nuniform mat4 u_VP;\nuniform mat4 u_MV;\nuniform vec3 u_eyePos;\nuniform vec3 u_lightPos;\nuniform float u_firstBoneLookupIndex;\nuniform float u_boneWeightPairsCount;\nuniform vec3 u_teamColors[14];\nuniform float u_teamColor;\nuniform vec4 u_vertexColor;\n\nattribute vec3 a_position;\nattribute vec4 a_normal;\nattribute vec2 a_uv0;\n\n#ifdef EXPLICITUV1\nattribute vec2 a_uv1;\n#endif\n#ifdef EXPLICITUV2\nattribute vec2 a_uv1, a_uv2;\n#endif\n#ifdef EXPLICITUV3\nattribute vec2 a_uv1, a_uv2, a_uv3;\n#endif\n\nattribute vec4 a_tangent;\nattribute vec4 a_bones;\nattribute vec4 a_weights;\n\nvarying vec3 v_normal;\nvarying vec4 v_uv[2]; // Pack 4 vec2 in 2 vec4, to reduce the varyings count\nvarying vec3 v_lightDir;\n// varying vec3 v_eyeVec;\nvarying vec3 v_halfVec;\nvarying vec3 v_teamColor;\nvarying vec4 v_vertexColor;\n\n${Tm}\n\nvec3 TBN(vec3 vector, vec3 tangent, vec3 binormal, vec3 normal) {\n  return vec3(dot(vector, tangent), dot(vector, binormal), dot(vector, normal));\n}\n\nvec4 decodeVector(vec4 v) {\n  return ((v / 255.0) * 2.0) - 1.0;\n}\n\nvoid transform(inout vec3 position, inout vec3 normal, inout vec3 tangent, inout vec3 binormal, vec4 bones, vec4 weights) {\n  if (u_boneWeightPairsCount > 0.0) {\n    mat4 bone;\n\n    if (u_boneWeightPairsCount == 1.0) {\n      bone = fetchMatrix(bones[0], 0.0);\n    } else {\n      bone += fetchMatrix(bones[0], 0.0) * weights[0];\n      bone += fetchMatrix(bones[1], 0.0) * weights[1];\n      bone += fetchMatrix(bones[2], 0.0) * weights[2];\n      bone += fetchMatrix(bones[3], 0.0) * weights[3];\n    }\n\n    position = vec3(bone * vec4(position, 1.0));\n    normal = mat3(bone) * normal;\n    tangent = vec3(bone * vec4(tangent, 0.0));\n    binormal = vec3(bone * vec4(binormal, 0.0));\n  }\n}\n\nvoid main() {\n  vec4 decodedNormal = decodeVector(a_normal);\n\n  vec3 position = a_position;\n  vec3 normal = decodedNormal.xyz;\n  vec3 tangent = vec3(decodeVector(a_tangent));\n  vec3 binormal = cross(normal, tangent) * decodedNormal.w;\n\n  transform(position, normal, tangent, binormal, a_bones + u_firstBoneLookupIndex, a_weights / 255.0);\n\n  vec3 position_mv = vec3(u_MV * vec4(position, 1));\n\n  mat3 mv = mat3(u_MV);\n  vec3 t = normalize(mv * tangent);\n  vec3 b = normalize(mv * binormal);\n  vec3 n = normalize(mv * normal);\n\n  vec3 lightDir = normalize(u_lightPos - position_mv);\n\n  v_lightDir = normalize(TBN(lightDir, t, b, n));\n\n  vec3 eyeVec = normalize(u_eyePos - position_mv);\n  vec3 halfVec = normalize(eyeVec - u_lightPos);\n\n  // v_eyeVec = TBN(eyeVec, t, b, n);\n  v_halfVec = TBN(halfVec, t, b, n);\n\n  v_normal = n;\n\n  vec4 uv0, uv1;\n\n  uv0.xy = a_uv0 / 2048.0;\n\n  #ifdef EXPLICITUV1\n  uv0.zw = a_uv1 / 2048.0;\n  #endif\n\n  #ifdef EXPLICITUV2\n  uv0.zw = a_uv1 / 2048.0;\n  uv1.xy = a_uv2 / 2048.0;\n  #endif\n\n  #ifdef EXPLICITUV3\n  uv0.zw = a_uv1 / 2048.0;\n  uv1.xy = a_uv2 / 2048.0;\n  uv1.zw = a_uv3 / 2048.0;\n  #endif\n\n  v_uv[0] = uv0;\n  v_uv[1] = uv1;\n\n  v_teamColor = u_teamColors[int(u_teamColor)];\n  v_vertexColor = u_vertexColor;\n\n  gl_Position = u_VP * vec4(position, 1.0);\n}\n`,Em="\n#ifdef GL_FRAGMENT_PRECISION_HIGH\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n",Sm=`\n${Em}\n\n\nvarying vec3 v_normal;\nvarying vec4 v_uv[2];\nvarying vec3 v_lightDir;\n// varying vec3 v_eyeVec;\nvarying vec3 v_halfVec;\nvarying vec3 v_teamColor;\nvarying vec4 v_vertexColor;\n\nstruct LayerSettings {\n  bool enabled;\n  float op;\n  float channels;\n  float teamColorMode;\n  // vec3 multAddAlpha;\n  // bool useAlphaFactor;\n  bool invert;\n  // bool multColor;\n  // bool addColor;\n  bool clampResult;\n  // bool useConstantColor;\n  // vec4 constantColor;\n  // float uvSource;\n  float uvCoordinate;\n  // float fresnelMode;\n  // float fresnelTransformMode;\n  // mat4 fresnelTransform;\n  // bool fresnelClamp;\n  // vec3 fresnelExponentBiasScale;\n};\n\nuniform float u_specularity;\nuniform float u_specMult;\nuniform float u_emisMult;\nuniform vec4 u_lightAmbient;\n\nuniform LayerSettings u_diffuseLayerSettings;\nuniform sampler2D u_diffuseMap;\nuniform LayerSettings u_decalLayerSettings;\nuniform sampler2D u_decalMap;\nuniform LayerSettings u_specularLayerSettings;\nuniform sampler2D u_specularMap;\nuniform LayerSettings u_glossLayerSettings;\nuniform sampler2D u_glossMap;\nuniform LayerSettings u_emissiveLayerSettings;\nuniform sampler2D u_emissiveMap;\nuniform LayerSettings u_emissive2LayerSettings;\nuniform sampler2D u_emissive2Map;\nuniform LayerSettings u_evioLayerSettings;\nuniform sampler2D u_evioMap;\nuniform LayerSettings u_evioMaskLayerSettings;\nuniform sampler2D u_evioMaskMap;\nuniform LayerSettings u_alphaLayerSettings;\nuniform sampler2D u_alphaMap;\nuniform LayerSettings u_alphaMaskLayerSettings;\nuniform sampler2D u_alphaMaskMap;\nuniform LayerSettings u_normalLayerSettings;\nuniform sampler2D u_normalMap;\nuniform LayerSettings u_heightLayerSettings;\nuniform sampler2D u_heightMap;\nuniform LayerSettings u_lightMapLayerSettings;\nuniform sampler2D u_lightMapMap;\nuniform LayerSettings u_aoLayerSettings;\nuniform sampler2D u_aoMap;\n\n#define SPECULAR_RGB 0.0\n#define SPECULAR_A_ONLY 1.0\n\n#define FRESNELMODE_NONE 0.0\n#define FRESNELMODE_STANDARD 1.0\n#define FRESNELMODE_INVERTED 2.0\n\n#define FRESNELTRANSFORM_NONE 0.0\n#define FRESNELTRANSFORM_SIMPLE 1.0\n#define FRESNELTRANSFORM_NORMALIZED 2.0\n\n#define UVMAP_EXPLICITUV0 0.0\n#define UVMAP_EXPLICITUV1 1.0\n#define UVMAP_REFLECT_CUBICENVIO 2.0\n#define UVMAP_REFLECT_SPHERICALENVIO 3.0\n#define UVMAP_PLANARLOCALZ 4.0\n#define UVMAP_PLANARWORLDZ 5.0\n#define UVMAP_PARTICLE_FLIPBOOK 6.0\n#define UVMAP_CUBICENVIO 7.0\n#define UVMAP_SPHERICALENVIO 8.0\n#define UVMAP_EXPLICITUV2 9.0\n#define UVMAP_EXPLICITUV3 10.0\n#define UVMAP_PLANARLOCALX 11.0\n#define UVMAP_PLANARLOCALY 12.0\n#define UVMAP_PLANARWORLDX 13.0\n#define UVMAP_PLANARWORLDY 14.0\n#define UVMAP_SCREENSPACE 15.0\n#define UVMAP_TRIPLANAR_LOCAL 16.0\n#define UVMAP_TRIPLANAR_WORLD 17.0\n#define UVMAP_TRIPLANAR_WORLD_LOCAL_Z 18.0\n\n#define CHANNELSELECT_RGB 0.0\n#define CHANNELSELECT_RGBA 1.0\n#define CHANNELSELECT_A 2.0\n#define CHANNELSELECT_R 3.0\n#define CHANNELSELECT_G 4.0\n#define CHANNELSELECT_B 5.0\n\n#define TEAMCOLOR_NONE 0.0\n#define TEAMCOLOR_DIFFUSE 1.0\n#define TEAMCOLOR_EMISSIVE 2.0\n\n#define LAYEROP_MOD 0.0\n#define LAYEROP_MOD2X 1.0\n#define LAYEROP_ADD 2.0\n#define LAYEROP_LERP 3.0\n#define LAYEROP_TEAMCOLOR_EMISSIVE_ADD 4.0\n#define LAYEROP_TEAMCOLOR_DIFFUSE_ADD 5.0\n#define LAYEROP_ADD_NO_ALPHA 6.0\n\n// float calculateFresnelTerm(vec3 normal, vec3 eyeToVertex, float exponent, mat4 fresnelTransform, float fresnelTransformMode, bool fresnelClamp) {\n//   vec3 fresnelDir = eyeToVertex;\n//   float result;\n\n//   if (fresnelTransformMode != FRESNELTRANSFORM_NONE) {\n//     fresnelDir = (fresnelTransform * vec4(fresnelDir, 1.0)).xyz;\n\n//     if (fresnelTransformMode == FRESNELTRANSFORM_NORMALIZED) {\n//       fresnelDir = normalize(fresnelDir);\n//     }\n//   }\n\n//   if (fresnelClamp) {\n//     result = 1.0 - clamp(-dot(normal, fresnelDir), 0.0, 1.0);\n//   } else {\n//     result = 1.0 - abs(dot(normal, fresnelDir));\n//   }\n\n//   result = max(result, 0.0000001);\n\n//   return pow(result, exponent);\n// }\n\nvec3 combineLayerColor(vec4 color, vec3 result, LayerSettings layerSettings) {\n  if (layerSettings.op == LAYEROP_MOD) {\n    result *= color.rgb;\n  } else if (layerSettings.op == LAYEROP_MOD2X) {\n    result *= color.rgb * 2.0;\n  } else if (layerSettings.op == LAYEROP_ADD) {\n    result += color.rgb * color.a;\n  } else if (layerSettings.op == LAYEROP_ADD_NO_ALPHA) {\n    result += color.rgb;\n  } else if (layerSettings.op == LAYEROP_LERP) {\n    result = mix(result, color.rgb, color.a);\n  } else if (layerSettings.op == LAYEROP_TEAMCOLOR_EMISSIVE_ADD) {\n    result += color.a * v_teamColor;\n  } else if (layerSettings.op == LAYEROP_TEAMCOLOR_DIFFUSE_ADD) {\n    result += color.a * v_teamColor;\n  }\n\n  return result;\n}\n\nvec4 chooseChannel(float channel, vec4 texel) {\n  if (channel == CHANNELSELECT_R) {\n    texel = texel.rrrr;\n  } else if (channel == CHANNELSELECT_G) {\n    texel = texel.gggg;\n  } else if (channel == CHANNELSELECT_B) {\n    texel = texel.bbbb;\n  } else if (channel == CHANNELSELECT_A) {\n    texel = texel.aaaa;\n  } else if (channel == CHANNELSELECT_RGB) {\n    texel.a = 1.0;\n  }\n\n  return texel;\n}\n\nvec2 getUV(LayerSettings layerSettings) {\n  if (layerSettings.uvCoordinate == 1.0) {\n    return v_uv[0].zw;\n  } else if (layerSettings.uvCoordinate == 2.0) {\n    return v_uv[1].xy;\n  } else if (layerSettings.uvCoordinate == 3.0) {\n    return v_uv[1].zw;\n  }\n\n  return v_uv[0].xy;\n}\n\nvec4 sampleLayer(sampler2D layer, LayerSettings layerSettings) {\n  // if (layerSettings.useConstantColor) {\n  //   return layerSettings.constantColor;\n  // }\n\n  return texture2D(layer, getUV(layerSettings));\n}\n\nvec4 computeLayerColor(sampler2D layer, LayerSettings layerSettings) {\n  vec4 color = sampleLayer(layer, layerSettings);\n\n  // if (layerSettings.useMask) {\n  //   result *= mask;\n  // }\n\n  vec4 result = chooseChannel(layerSettings.channels, color);\n\n  // if (layerSettings.useAlphaFactor) {\n  //   result.a *= layerSettings.multiplyAddAlpha.z;\n  // }\n\n  if (layerSettings.teamColorMode == TEAMCOLOR_DIFFUSE) {\n    result = vec4(mix(v_teamColor, result.rgb, color.a), 1.0);\n  } else if (layerSettings.teamColorMode == TEAMCOLOR_EMISSIVE) {\n    result = vec4(mix(v_teamColor, result.rgb, color.a), 1.0);\n  }\n\n  if (layerSettings.invert) {\n    result = vec4(1.0) - result;\n  }\n\n  // if (layerSettings.multiplyEnable) {\n  //   result *= layerSettings.multiplyAddAlpha.x;\n  // }\n\n  // if (layerSettings.addEnable) {\n  //   result += layerSettings.multiplyAddAlpha.y;\n  // }\n\n  if (layerSettings.clampResult) {\n    result = clamp(result, 0.0, 1.0);\n  }\n\n  // if (layerSettings.fresnelMode != FRESNELMODE_NONE) {\n  //   float fresnelTerm = calculateFresnelTerm(v_normal, v_eyeVec, layerSettings.fresnelExponentBiasScale.x, layerSettings.fresnelTransform, layerSettings.fresnelTransformMode, layerSettings.fresnelClamp);\n    \n  //   if (layerSettings.fresnelMode == FRESNELMODE_INVERTED) {\n  //     fresnelTerm = 1.0 - fresnelTerm;\n  //   }\n    \n  //   fresnelTerm = clamp(fresnelTerm * layerSettings.fresnelExponentBiasScale.z + layerSettings.fresnelExponentBiasScale.y, 0.0, 1.0);\n    \n  //   result *= fresnelTerm;\n  // }\n\n  return result;\n}\n\nvec3 decodeNormal(sampler2D map) {\n  vec4 texel = texture2D(map, v_uv[0].xy);\n  vec3 normal;\n\n  normal.xy = 2.0 * texel.wy - 1.0;\n  normal.z = sqrt(max(0.0, 1.0 - dot(normal.xy, normal.xy)));\n\n  return normal;\n}\n\nvec4 computeSpecular(sampler2D specularMap, LayerSettings layerSettings, float specularity, float specMult, vec3 normal) {\n  vec4 color;\n\n  if (layerSettings.enabled) {\n    color = computeLayerColor(specularMap, layerSettings);\n  } else {\n    color = vec4(0);\n  }\n\n  float factor = pow(max(-dot(v_halfVec, normal), 0.0), specularity) * specMult;\n\n  return color * factor;\n}\n\n\nvoid main() {\n  vec3 color;\n  vec4 final = u_lightAmbient;\n  vec3 normal;\n  vec3 lightMapDiffuse;\n\n  if (u_normalLayerSettings.enabled) {\n    normal = decodeNormal(u_normalMap);\n  } else {\n    normal = v_normal;\n  }\n\n  float lambertFactor = max(dot(normal, v_lightDir), 0.0);\n\n  if (lambertFactor > 0.0) {\n    if (u_diffuseLayerSettings.enabled) {\n      vec4 diffuseColor = computeLayerColor(u_diffuseMap, u_diffuseLayerSettings);\n\n      color = combineLayerColor(diffuseColor, color, u_diffuseLayerSettings);\n    }\n\n    if (u_decalLayerSettings.enabled) {\n      vec4 decalColor = computeLayerColor(u_decalMap, u_decalLayerSettings);\n\n      color = combineLayerColor(decalColor, color, u_decalLayerSettings);\n    }\n\n    vec4 specularColor = computeSpecular(u_specularMap, u_specularLayerSettings, u_specularity, u_specMult, normal);\n\n    if (u_lightMapLayerSettings.enabled) {\n      vec4 lightMapColor = computeLayerColor(u_lightMapMap, u_lightMapLayerSettings) * 2.0;\n\n      lightMapDiffuse = lightMapColor.rgb;\n    }\n\n    // final.rgb = color * lightMapDiffuse + specularColor.rgb;\n    final.rgb = (color + specularColor.rgb) * lambertFactor;\n\n    bool addEmissive = false;\n    vec3 emissiveColor;\n    vec4 tempColor;\n\n    if (u_emissiveLayerSettings.enabled) {\n      tempColor = computeLayerColor(u_emissiveMap, u_emissiveLayerSettings);\n\n      if (u_emissiveLayerSettings.op == LAYEROP_MOD || u_emissiveLayerSettings.op == LAYEROP_MOD2X || u_emissiveLayerSettings.op == LAYEROP_LERP) {\n        final.rgb = combineLayerColor(tempColor, final.rgb, u_emissiveLayerSettings);\n      } else {\n        emissiveColor = combineLayerColor(tempColor, emissiveColor, u_emissiveLayerSettings);\n        addEmissive = true;\n      }\n    }\n\n    if (u_emissive2LayerSettings.enabled) {\n      tempColor = computeLayerColor(u_emissive2Map, u_emissive2LayerSettings);\n\n      if (!addEmissive && (u_emissive2LayerSettings.op == LAYEROP_MOD || u_emissive2LayerSettings.op == LAYEROP_MOD2X || u_emissive2LayerSettings.op == LAYEROP_LERP)) {\n        final.rgb = combineLayerColor(tempColor, final.rgb, u_emissive2LayerSettings);\n      } else {\n        emissiveColor = combineLayerColor(tempColor, emissiveColor, u_emissive2LayerSettings);\n        addEmissive = true;\n      }\n    }\n\n    if (addEmissive) {\n      final.rgb += emissiveColor * u_emisMult;\n    }\n  }\n\n  gl_FragColor = final * v_vertexColor;\n}\n`,Mm={load(t){const e=t.gl,n=t.webgl,i=[[255,3,3],[0,66,255],[28,230,185],[84,0,129],[255,252,1],[254,138,14],[32,192,0],[229,91,176],[149,150,151],[126,191,241],[16,98,70],[78,42,4],[40,40,40],[0,0,0]];if(!n.ensureExtension("OES_texture_float"))throw new Error("M3: No float texture support!");const r=[];for(let t=0;t<4;t++){const s=n.createShader(`#define EXPLICITUV${t}\n${Lm}`,Sm);s.use();for(let t=0;t<14;t++){const n=i[t];e.uniform3f(s.uniforms["u_teamColors["+t+"]"],n[0]/255,n[1]/255,n[2]/255)}r[t]=s}const s={standardShaders:r};t.sharedCache.set("m3",s)},isValidSource:t=>t instanceof qo||Yo(t),resource:class extends zp{constructor(t,e){let n;super(e),this.name="",this.batches=[],this.materials=[[],[]],this.materialMaps=[],this.bones=[],this.sequences=[],this.sts=[],this.stc=[],this.stg=[],this.attachments=[],this.cameras=[],this.regions=[],this.initialReference=[],this.elementBuffer=null,this.arrayBuffer=null,this.vertexSize=0,this.uvSetCount=0,t instanceof qo?n=t:(n=new qo,n.load(t));const i=n.model,r=i.divisions.first();this.name=i.modelName.get(),this.setupGeometry(i,r);const s=i.materialReferences.get();this.materialMaps=s;const a=i.materials[0].get();for(let t=0,e=a.length;t<e;t++)this.materials[1].push(new Qp(this,t,a[t]));for(const t of r.batches.get()){const e=t.regionIndex,n=s[t.materialReferenceIndex];1===n.materialType&&this.batches.push(new xm(this.regions[e],this.materials[1][n.materialIndex]))}this.initialReference=i.absoluteInverseBoneRestPositions.get();for(const t of i.bones.get())this.bones.push(new tm(t));this.boneLookup=i.boneLookup.get();const o=i.sequences.get();if(o)for(const t of o)this.sequences.push(new em(t));const l=i.sts.get();if(l)for(const t of l)this.sts.push(new nm(t));const h=i.stc.get();if(h)for(const t of h)this.stc.push(new om(t));const u=i.stg.get();if(u)for(const t of u)this.stg.push(new lm(t,this.sts,this.stc));this.addGlobalAnims();const c=i.attachmentPoints.get();if(c)for(const t of c)this.attachments.push(new hm(t));const d=i.cameras.get();if(d)for(const t of d)this.cameras.push(new um(t))}addInstance(){return new ym(this)}setupGeometry(t,e){const n=this.viewer.gl;let i=1;const r=t.vertexFlags;262144&r?i=2:524288&r?i=3:1048576&r&&(i=4);const s=e.regions.get();let a=0;const o=[];for(let t=0,e=s.length;t<e;t++)o[t]=a,a+=s[t].triangleIndicesCount;const l=new Uint16Array(a),h=e.triangles.get();for(let t=0,e=s.length;t<e;t++)this.regions.push(new cm(this,s[t],h,l,o[t]));const u=t.vertices.get();this.elementBuffer=n.createBuffer(),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,this.elementBuffer),n.bufferData(n.ELEMENT_ARRAY_BUFFER,l,n.STATIC_DRAW);const c=n.createBuffer();n.bindBuffer(n.ARRAY_BUFFER,c),n.bufferData(n.ARRAY_BUFFER,u,n.STATIC_DRAW),this.arrayBuffer=c,this.vertexSize=4*(7+i),this.uvSetCount=i}mapMaterial(t){const e=this.materialMaps[t];return this.materials[1][e.materialIndex]}addGlobalAnims(){}}};let km;"function"==typeof OfflineAudioContext&&(km=new OfflineAudioContext(1,1,48e3));class Rm{constructor(){this.map={}}set(t,e){"string"!=typeof e&&(e=e.toString()),this.map[t.toLowerCase()]=e}string(t){return this.map[t.toLowerCase()]}number(t){const e=this.string(t);return e?parseFloat(e):0}}class Im{constructor(t){this.map={},t&&this.load(t)}load(t){if(t.startsWith("ID;")){const e=new ko;e.load(t);const n=e.rows,i=n[0],r=this.map;for(let t=1,e=n.length;t<e;t++){const e=n[t];if(e){const t=e[0];if(t&&"_"!==t){r[t]||(r[t]=new Rm);const n=r[t];for(let t=0,r=i.length;t<r;t++){let r=i[t];void 0===r&&(r=`column${t}`),n.map[r.toLowerCase()]=e[t]}}}}}else{const e=new Mo;e.load(t);const n=e.sections,i=this.map;for(const[t,e]of n.entries()){i[t]||(i[t]=new Rm);const n=i[t];for(const[t,i]of e)n.map[t.toLowerCase()]=i}}}getRow(t){return this.map[t]}getProperty(t,e){return this.map[t].map[e]}setRow(t,e){this.map[t]=e}findRow(t,e){for(const n of Object.values(this.map))if(n.string(t)===e)return n}}class Um{constructor(t){this.name=t.name,this.interval=t.interval,this.nonLooping=t.nonLooping,this.rarity=t.rarity,this.bounds=new jp;const e=t.extent;this.bounds.fromExtents(e.min,e.max)}}class Om{constructor(t,e,n,i,r){this.frames=[],this.values=[],this.inTans=[],this.outTans=[],this.constant=!1,this.sd=t,this.start=e,this.end=n;const s=t.interpolationType,a=i.frames,o=i.values,l=i.inTans,h=i.outTans,u=t.defval;r&&a[0]>n&&(this.frames[0]=a[0],this.values[0]=o[0]);for(let t=0,i=a.length;t<i;t++){const i=a[t];i>=e&&i<=n&&(this.frames.push(i),this.values.push(o[t]),s>1&&(this.inTans.push(l[t]),this.outTans.push(h[t])))}const c=this.frames.length;if(0===c)this.constant=!0,this.frames[0]=e,this.values[0]=u;else if(1===c)this.constant=!0;else{const t=this.values[0];this.constant=this.values.every((e=>t.every(((t,n)=>t===e[n]))))}}getValue(t,e){const n=this.frames.length;if(this.constant||e<this.start)return this.sd.copy(t,this.values[0]),-1;{let i=-1,r=-1;const s=n-1;if(e<this.frames[0]||e>=this.frames[s])i=s,r=0;else for(let t=1;t<n;t++)if(this.frames[t]>e){i=t-1,r=t;break}let a=this.frames[i];const o=this.frames[r];let l=o-a;l<0&&(l+=this.end-this.start,e<a&&(a=o));const h=0==l?0:(e-a)/l;return this.sd.interpolate(t,this.values,this.inTans,this.outTans,i,r,h),i}}}const Cm={KLAV:0,KATV:0,KPEV:0,KP2V:0,KRVS:0},Bm=new Float32Array(1),Pm=new Uint32Array(1),Nm=new Float32Array([1]),Dm=qe(),Fm=Ri(),Vm=We(1,1,1),Gm=Dm,Km={KMTF:Bm,KMTA:Nm,KTAT:Dm,KTAR:Fm,KTAS:Vm,KGAO:Nm,KGAC:Gm,KLAS:Bm,KLAE:Bm,KLAC:Gm,KLAI:Bm,KLBI:Bm,KLBC:Gm,KLAV:Nm,KATV:Nm,KPEE:Bm,KPEG:Bm,KPLN:Bm,KPLT:Bm,KPEL:Bm,KPES:Bm,KPEV:Nm,KP2S:Bm,KP2R:Bm,KP2L:Bm,KP2G:Bm,KP2E:Bm,KP2N:Bm,KP2W:Bm,KP2V:Nm,KRHA:Bm,KRHB:Bm,KRAL:new Float32Array([0]),KRCO:Gm,KRTX:Bm,KRVS:Nm,KCTR:Dm,KTTR:Dm,KCRL:Pm,KGTR:Dm,KGRT:Fm,KGSC:Vm};class jm{constructor(t,e){this.globalSequence=null,this.sequences=[];const n=t.globalSequences,i=e.globalSequenceId,r=Cm[e.name];if(this.model=t,this.name=e.name,this.defval=Km[e.name],this.interpolationType=void 0!==r?r:e.interpolationType,-1!==i&&n)this.globalSequence=new Om(this,0,n[i],e,!0);else for(const n of t.sequences){const t=n.interval;this.sequences.push(new Om(this,t[0],t[1],e,!1))}}getValue(t,e,n,i){return this.globalSequence?this.globalSequence.getValue(t,i%this.globalSequence.end):this.sequences[e].getValue(t,n)}isVariant(t){return this.globalSequence?!this.globalSequence.constant:!this.sequences[t].constant}}class zm extends jm{copy(t,e){t[0]=e[0]}interpolate(t,e,n,i,r,s,a){const o=this.interpolationType,l=e[r][0];0===o?t[0]=l:1===o?t[0]=ya(l,e[s][0],a):2===o?t[0]=xa(l,i[r][0],n[s][0],e[s][0],a):3===o&&(t[0]=Ta(l,i[r][0],n[s][0],e[s][0],a))}}class Hm extends jm{copy(t,e){Ze(t,e)}interpolate(t,e,n,i,r,s,a){const o=this.interpolationType;0===o?Ze(t,e[r]):1===o?bn(t,e[r],e[s],a):2===o?wn(t,e[r],i[r],n[s],e[s],a):3===o&&An(t,e[r],i[r],n[s],e[s],a)}}class Xm extends jm{copy(t,e){rr(t,e)}interpolate(t,e,n,i,r,s,a){const o=this.interpolationType;0===o?rr(t,e[r]):1===o?ji(t,e[r],e[s],a):2!==o&&3!==o||br(t,e[r],i[r],n[s],e[s],a)}}function qm(t,e){return e instanceof Qo||e instanceof tl?new zm(t,e):e instanceof el?new Hm(t,e):new Xm(t,e)}class Ym{constructor(t,e){this.animations=new Map,this.variants={},this.model=t;for(const n of e.animations)this.animations.set(n.name,qm(t,n))}getScalarValue(t,e,n,i,r,s){if(-1!==n){const s=this.animations.get(e);if(s)return s.getValue(t,n,i,r)}return t[0]=s,-1}getVectorValue(t,e,n,i,r,s){if(-1!==n){const s=this.animations.get(e);if(s)return s.getValue(t,n,i,r)}return t[0]=s[0],t[1]=s[1],t[2]=s[2],-1}getQuatValue(t,e,n,i,r,s){if(-1!==n){const s=this.animations.get(e);if(s)return s.getValue(t,n,i,r)}return t[0]=s[0],t[1]=s[1],t[2]=s[2],t[3]=s[3],-1}addVariants(t,e){const n=this.animations.get(t),i=this.model.sequences.length,r=new Uint8Array(i);if(n)for(let t=0;t<i;t++)n.isVariant(t)&&(r[t]=1);this.variants[e]=r}addVariantIntersection(t,e){const n=this.model.sequences.length,i=new Uint8Array(n);for(let e=0;e<n;e++)for(const n of t)this.variants[n][e]&&(i[e]=1);this.variants[e]=i}}class $m extends Ym{constructor(t,e){super(t,e),this.addVariants("KTAT","translation"),this.addVariants("KTAR","rotation"),this.addVariants("KTAS","scale")}getTranslation(t,e,n,i){return this.getVectorValue(t,"KTAT",e,n,i,ta)}getRotation(t,e,n,i){return this.getQuatValue(t,"KTAR",e,n,i,ia)}getScale(t,e,n,i){return this.getVectorValue(t,"KTAS",e,n,i,ea)}}function Wm(t,e){return 0===t?[e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA]:1===t?[e.SRC_ALPHA,e.ONE]:2===t?[e.ZERO,e.SRC_COLOR]:3===t?[e.DST_COLOR,e.SRC_COLOR]:4===t?[e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA]:[0,0]}class Zm extends Ym{constructor(t,e,n,i){super(t,e),this.textureId=0,this.blendSrc=0,this.blendDst=0,this.blended=!1,this.textureAnimation=null;let r=e.filterMode;const s=e.textureAnimationId,a=t.viewer.gl;this.index=n,this.priorityPlane=i,r>6&&(r=2),this.filterMode=r,-1!==e.textureId&&(this.textureId=e.textureId),this.coordId=e.coordId,this.alpha=e.alpha;const o=e.flags;if(this.unshaded=1&o,this.sphereEnvironmentMap=2&o,this.twoSided=16&o,this.unfogged=32&o,this.noDepthTest=64&o,this.noDepthSet=128&o,this.depthMaskValue=0===r||1===r,r>1&&(this.blended=!0,[this.blendSrc,this.blendDst]=function(t,e){return 2===t?[e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA]:3===t||4===t?[e.SRC_ALPHA,e.ONE]:5===t?[e.ZERO,e.SRC_COLOR]:6===t?[e.DST_COLOR,e.SRC_COLOR]:[0,0]}(r,a)),-1!==s){const e=t.textureAnimations[s];e&&(this.textureAnimation=e)}this.addVariants("KMTA","alpha"),this.addVariants("KMTF","textureId")}bind(t){const e=this.model.viewer.gl;e.uniform1f(t.uniforms.u_filterMode,this.filterMode),this.blended?(e.enable(e.BLEND),e.blendFunc(this.blendSrc,this.blendDst)):e.disable(e.BLEND),this.twoSided?e.disable(e.CULL_FACE):e.enable(e.CULL_FACE),this.noDepthTest?e.disable(e.DEPTH_TEST):e.enable(e.DEPTH_TEST),this.noDepthSet?e.depthMask(!1):e.depthMask(this.depthMaskValue)}getAlpha(t,e,n,i){return this.getScalarValue(t,"KMTA",e,n,i,this.alpha)}getTextureId(t,e,n,i){return this.getScalarValue(t,"KMTF",e,n,i,this.textureId)}}class Jm{constructor(t,e,n){this.model=t,this.shader=e,this.layers=n}}class Qm extends Ym{constructor(t,e){super(t,e);const n=e.color;this.alpha=e.alpha,this.color=We(n[2],n[1],n[0]),this.geosetId=e.geosetId,this.addVariants("KGAO","alpha"),this.addVariants("KGAC","color")}getAlpha(t,e,n,i){return this.getScalarValue(t,"KGAO",e,n,i,this.alpha)}getColor(t,e,n,i){return this.getVectorValue(t,"KGAC",e,n,i,this.color)}}const t_={1:"TeamColor/TeamColor00",2:"TeamGlow/TeamGlow00",11:"Cliff/Cliff0",21:"",31:"LordaeronTree/LordaeronSummerTree",32:"AshenvaleTree/AshenTree",33:"BarrensTree/BarrensTree",34:"NorthrendTree/NorthTree",35:"Mushroom/MushroomTree",36:"RuinsTree/RuinsTree",37:"OutlandMushroomTree/MushroomTree"};class e_ extends Ym{constructor(t,e,n){super(t,e),this.index=n,this.name=e.name,this.objectId=e.objectId,this.parentId=e.parentId,this.pivot=t.pivotPoints[e.objectId]||qe();const i=e.flags;this.dontInheritTranslation=(1&i)>0,this.dontInheritRotation=(4&i)>0,this.dontInheritScaling=(2&i)>0,this.billboarded=(8&i)>0,this.billboardedX=(16&i)>0,this.billboardedY=(32&i)>0,this.billboardedZ=(64&i)>0,this.cameraAnchored=(128&i)>0,this.anyBillboarding=this.billboarded||this.billboardedX||this.billboardedY||this.billboardedZ,e.objectId===e.parentId&&(this.parentId=-1),this.addVariants("KGTR","translation"),this.addVariants("KGRT","rotation"),this.addVariants("KGSC","scale"),this.addVariantIntersection(["translation","rotation","scale"],"generic")}getVisibility(t,e,n,i){return t[0]=1,-1}getTranslation(t,e,n,i){return this.getVectorValue(t,"KGTR",e,n,i,ta)}getRotation(t,e,n,i){return this.getQuatValue(t,"KGRT",e,n,i,ia)}getScale(t,e,n,i){return this.getVectorValue(t,"KGSC",e,n,i,ea)}}class n_ extends e_{constructor(t,e,n){super(t,e,n),this.geosetAnimation=t.geosetAnimations[e.geosetAnimationId]}getVisibility(t,e,n,i){return this.geosetAnimation?this.geosetAnimation.getAlpha(t,e,n,i):(t[0]=1,-1)}}class i_ extends e_{constructor(t,e,n){super(t,e,n),this.type=e.type,this.attenuation=e.attenuation,this.color=e.color,this.intensity=e.intensity,this.ambientColor=e.ambientColor,this.ambientIntensity=e.ambientIntensity}getAttenuationStart(t,e,n,i){return this.getScalarValue(t,"KLAS",e,n,i,this.attenuation[0])}getAttenuationEnd(t,e,n,i){return this.getScalarValue(t,"KLAE",e,n,i,this.attenuation[1])}getIntensity(t,e,n,i){return this.getScalarValue(t,"KLAI",e,n,i,this.intensity)}getColor(t,e,n,i){return this.getVectorValue(t,"KLAC",e,n,i,this.color)}getAmbientIntensity(t,e,n,i){return this.getScalarValue(t,"KLBI",e,n,i,this.ambientIntensity)}getAmbientColor(t,e,n,i){return this.getVectorValue(t,"KLBC",e,n,i,this.ambientColor)}}class r_ extends e_{}class s_ extends e_{constructor(t,e,n){super(t,e,n),this.internalModel=null;const i=e.path.replace(/\\/g,"/").toLowerCase().replace(".mdl",".mdx");if(this.path=i,this.attachmentId=e.attachmentId,""!==i&&-1!=i.indexOf(".mdx")){const e=t.viewer.load(i,t.pathSolver,t.solverParams);e.then((t=>{t&&(this.internalModel=t)})),t.blockers.push(e)}}getVisibility(t,e,n,i){return this.getScalarValue(t,"KATV",e,n,i,1)}}class a_ extends e_{constructor(t,e,n){super(t,e,n),this.internalModel=null,this.ok=!1,this.speed=e.speed,this.latitude=e.latitude,this.longitude=e.longitude,this.lifeSpan=e.lifeSpan,this.gravity=e.gravity,this.emissionRate=e.emissionRate,t.viewer.load(e.path.replace(/\\/g,"/").toLowerCase().replace(".mdl",".mdx"),t.pathSolver,t.solverParams).then((t=>{t&&(this.internalModel=t,this.ok=!0)}))}getSpeed(t,e,n,i){return this.getScalarValue(t,"KPES",e,n,i,this.speed)}getLatitude(t,e,n,i){return this.getScalarValue(t,"KPLTV",e,n,i,this.latitude)}getLongitude(t,e,n,i){return this.getScalarValue(t,"KPLN",e,n,i,this.longitude)}getLifeSpan(t,e,n,i){return this.getScalarValue(t,"KPEL",e,n,i,this.lifeSpan)}getGravity(t,e,n,i){return this.getScalarValue(t,"KPEG",e,n,i,this.gravity)}getEmissionRate(t,e,n,i){return this.getScalarValue(t,"KPEE",e,n,i,this.emissionRate)}getVisibility(t,e,n,i){return this.getScalarValue(t,"KPEV",e,n,i,1)}}const o_=qe(),l_=qe(),h_=qe(),u_=60,c_=1e4;function d_(t,e){const n=t.objects,i=e.floatView;let r=0;for(const t of n){const e=15*r,n=e+0,s=t.vertices;i[n+0]=s[0],i[n+1]=s[1],i[n+2]=s[2],i[n+3]=s[3],i[n+4]=s[4],i[n+5]=s[5],i[n+6]=s[6],i[n+7]=s[7],i[n+8]=s[8],i[n+9]=s[9],i[n+10]=s[10],i[n+11]=s[11],i[e+12]=t.health,r+=1}}function f_(t,e){let n=t.alive;const i=t.emitterObject.geometryEmitterType;if(1===i&&(n-=1),n>0){const r=t.instance.model.viewer,s=r.buffer,a=r.gl,o=r.webgl.extensions.ANGLE_instanced_arrays,l=n*u_,h=e.attribs;s.reserve(l),0===i?(function(t,e){const n=t.instance,i=t.objects,r=e.byteView,s=e.floatView,a=t.emitterObject,o=a.modelSpace,l=a.tailLength,h=t.node,u=n.teamColor;let c=0;for(const t of i){const e=c*u_,n=15*c,i=n+0;let a=t.location;const d=t.scale,f=t.tail;if(0===f)o&&(a=xn(o_,a,h.worldMatrix)),s[i+0]=a[0],s[i+1]=a[1],s[i+2]=a[2],s[i+3]=t.facing;else{const e=t.velocity;let n=l_,r=a;n[0]=r[0]-l*e[0],n[1]=r[1]-l*e[1],n[2]=r[2]-l*e[2],o&&(n=xn(n,n,h.worldMatrix),r=xn(h_,r,h.worldMatrix)),s[i+0]=n[0],s[i+1]=n[1],s[i+2]=n[2],s[i+3]=r[0],s[i+4]=r[1],s[i+5]=r[2]}s[i+6]=d[0],s[i+7]=d[0],s[i+8]=d[0],s[n+12]=t.health,r[e+56]=f,r[e+57]=u,c+=1}}(t,s),function(t,e){const n=t.instance,i=n.textureOverrides,r=n.scene.camera,s=t.emitterObject,a=s.model,o=a.viewer,l=o.gl,h=o.sharedCache.get("mdx"),u=e.uniforms,c=s.colors,d=s.intervals,f=s.replaceableId;let p,m=s.internalTexture;l.blendFunc(s.blendSrc,s.blendDst),l.uniform1f(u.u_filterMode,s.filterMode),m=s.internalTexture?s.internalTexture:1===f?h.teamColors[n.teamColor]:2===f?h.teamGlows[n.teamColor]:a.textures[s.textureId];let _=i.get(1e3+s.index);_||(0===f&&(_=i.get(s.textureId)),_||(_=m.texture)),o.webgl.bindTextureAndWrap(_,0,m.wrapS,m.wrapT),p=s.xYQuad?r.vectors:r.billboardedVectors,l.uniform1f(u.u_lifeSpan,s.lifeSpan),l.uniform1f(u.u_timeMiddle,s.timeMiddle),l.uniform1f(u.u_columns,s.columns),l.uniform1f(u.u_rows,s.rows),l.uniform1f(u.u_teamColored,s.teamColored),l.uniform3fv(u["u_intervals[0]"],d[0]),l.uniform3fv(u["u_intervals[1]"],d[1]),l.uniform3fv(u["u_intervals[2]"],d[2]),l.uniform3fv(u["u_intervals[3]"],d[3]),l.uniform4fv(u["u_colors[0]"],c[0]),l.uniform4fv(u["u_colors[1]"],c[1]),l.uniform4fv(u["u_colors[2]"],c[2]),l.uniform3fv(u.u_scaling,s.scaling),s.head&&(l.uniform3fv(u["u_vertices[0]"],p[0]),l.uniform3fv(u["u_vertices[1]"],p[1]),l.uniform3fv(u["u_vertices[2]"],p[2]),l.uniform3fv(u["u_vertices[3]"],p[3])),s.tail&&l.uniform3fv(u.u_cameraZ,r.directionZ)}(t,e)):1===i?(function(t,e){let n=t.first;const i=e.byteView,r=e.floatView,s=t.emitterObject.columns,a=1/(t.alive-1);let o=0;for(;n.next;){const t=n.next.vertices,e=o*u_,l=15*o+0,h=e+52,u=e+57,c=(n.slot%s+(1-o*a-a))/s,d=n.slot/s,f=c+a,p=n.vertices,m=n.color;r[l+0]=p[0],r[l+1]=p[1],r[l+2]=p[2],r[l+3]=p[3],r[l+4]=p[4],r[l+5]=p[5],r[l+6]=t[3],r[l+7]=t[4],r[l+8]=t[5],r[l+9]=t[0],r[l+10]=t[1],r[l+11]=t[2],i[h+0]=m[0],i[h+1]=m[1],i[h+2]=m[2],i[h+3]=m[3],i[u+0]=255*c,i[u+1]=255*f,i[u+2]=255*d,n=n.next,o+=1}}(t,s),function(t,e){const n=t.instance.textureOverrides,i=t.emitterObject,r=i.layer,s=i.model,a=s.viewer.gl,o=e.uniforms,l=s.textures[r.textureId],h=n.get(r.textureId)||l.texture;r.bind(e),a.uniform1f(o.u_filterMode,r.filterMode),s.viewer.webgl.bindTextureAndWrap(h,0,l.wrapS,l.wrapT),a.uniform1f(o.u_columns,i.columns),a.uniform1f(o.u_rows,i.rows)}(t,e)):2===i?(d_(t,s),function(t,e){const n=t.instance.textureOverrides,i=t.emitterObject,r=i.intervalTimes,s=i.intervals,a=i.colors,o=i.model,l=o.viewer.gl,h=e.uniforms,u=i.internalTexture,c=n.get(c_+i.index)||u.texture;l.blendFunc(i.blendSrc,i.blendDst),o.viewer.webgl.bindTextureAndWrap(c,0,u.wrapS,u.wrapT),l.uniform1f(h.u_lifeSpan,i.lifeSpan),l.uniform1f(h.u_columns,i.columns),l.uniform1f(h.u_rows,i.rows),l.uniform3f(h.u_intervalTimes,r[0],r[1],0),l.uniform3fv(h["u_intervals[0]"],s[0]),l.uniform3fv(h["u_intervals[1]"],s[1]),l.uniform4fv(h["u_colors[0]"],a[0]),l.uniform4fv(h["u_colors[1]"],a[1]),l.uniform4fv(h["u_colors[2]"],a[2])}(t,e)):(d_(t,s),function(t,e){const n=t.instance.textureOverrides,i=t.emitterObject,r=i.intervalTimes,s=i.colors,a=i.model,o=a.viewer.gl,l=e.uniforms,h=i.internalTexture,u=n.get(c_+i.index)||h.texture;o.blendFunc(i.blendSrc,i.blendDst),a.viewer.webgl.bindTextureAndWrap(u,0,h.wrapS,h.wrapT),o.uniform1f(l.u_lifeSpan,i.lifeSpan),o.uniform1f(l.u_columns,i.columns),o.uniform1f(l.u_rows,i.rows),o.uniform3fv(l.u_intervalTimes,r),o.uniform4fv(l["u_colors[0]"],s[0]),o.uniform4fv(l["u_colors[1]"],s[1]),o.uniform4fv(l["u_colors[2]"],s[2])}(t,e)),s.bindAndUpdate(l),a.uniform1i(e.uniforms.u_emitter,i),a.vertexAttribPointer(h.a_p0,3,a.FLOAT,!1,u_,0),a.vertexAttribPointer(h.a_p1,3,a.FLOAT,!1,u_,12),a.vertexAttribPointer(h.a_p2,3,a.FLOAT,!1,u_,24),a.vertexAttribPointer(h.a_p3,3,a.FLOAT,!1,u_,36),a.vertexAttribPointer(h.a_health,1,a.FLOAT,!1,u_,48),a.vertexAttribPointer(h.a_color,4,a.UNSIGNED_BYTE,!0,u_,52),a.vertexAttribPointer(h.a_tail,1,a.UNSIGNED_BYTE,!1,u_,56),a.vertexAttribPointer(h.a_leftRightTop,3,a.UNSIGNED_BYTE,!1,u_,57),o.drawArraysInstancedANGLE(a.TRIANGLES,0,6,n)}}class p_{constructor(t,e){this.texture=null,this.wrapS=33071,this.wrapT=33071,this.replaceableId=t,1&e&&(this.wrapS=10497),2&e&&(this.wrapT=10497)}}class m_ extends e_{constructor(t,e,n){super(t,e,n),this.geometryEmitterType=0,this.teamColored=0,this.internalTexture=null,this.colors=[],this.ok=!0,this.width=e.width,this.length=e.length,this.speed=e.speed,this.latitude=e.latitude,this.gravity=e.gravity,this.emissionRate=2*e.emissionRate,this.squirt=e.squirt,this.lifeSpan=e.lifeSpan,this.variation=e.variation,this.tailLength=e.tailLength,this.timeMiddle=e.timeMiddle;const i=e.flags;this.lineEmitter=131072&i,this.unfogged=262144&i,this.modelSpace=524288&i,this.xYQuad=1048576&i;const r=e.replaceableId;if(this.columns=e.columns,this.rows=e.rows,1===r||2===r)this.teamColored=1;else if(r>2){const e=t.reforged?".dds":".blp";this.internalTexture=new p_(r,0),t.viewer.load(`ReplaceableTextures\\${t_[r]}${e}`,t.pathSolver,t.solverParams).then((t=>{t&&(this.internalTexture.texture=t)}))}this.replaceableId=e.replaceableId,this.textureId=e.textureId;const s=e.headOrTail;this.head=0===s||2===s,this.tail=1===s||2===s,this.cellWidth=1/e.columns,this.cellHeight=1/e.rows;const a=e.segmentColors,o=e.segmentAlphas;for(let t=0;t<3;t++){const e=a[t];this.colors[t]=new Float32Array([e[0],e[1],e[2],o[t]/255])}this.scaling=e.segmentScaling;const l=e.headIntervals,h=e.tailIntervals;this.intervals=[new Float32Array(l[0]),new Float32Array(l[1]),new Float32Array(h[0]),new Float32Array(h[1])];const u=Wm(e.filterMode,this.model.viewer.gl);this.filterMode=e.filterMode,this.blendSrc=u[0],this.blendDst=u[1],this.priorityPlane=e.priorityPlane}getWidth(t,e,n,i){return this.getScalarValue(t,"KP2N",e,n,i,this.width)}getLength(t,e,n,i){return this.getScalarValue(t,"KP2W",e,n,i,this.length)}getSpeed(t,e,n,i){return this.getScalarValue(t,"KP2S",e,n,i,this.speed)}getLatitude(t,e,n,i){return this.getScalarValue(t,"KP2L",e,n,i,this.latitude)}getGravity(t,e,n,i){return this.getScalarValue(t,"KP2G",e,n,i,this.gravity)}getEmissionRate(t,e,n,i){return this.getScalarValue(t,"KP2E",e,n,i,this.emissionRate)}getVariation(t,e,n,i){return this.getScalarValue(t,"KP2R",e,n,i,this.variation)}getVisibility(t,e,n,i){return this.getScalarValue(t,"KP2V",e,n,i,1)}}class __ extends e_{constructor(t,e,n){super(t,e,n),this.geometryEmitterType=1,this.ok=!0,this.layer=t.materials[e.materialId].layers[0],this.heightAbove=e.heightAbove,this.heightBelow=e.heightBelow,this.alpha=e.alpha,this.color=e.color,this.lifeSpan=e.lifeSpan,this.textureSlot=e.textureSlot,this.emissionRate=2*e.emissionRate,this.gravity=e.gravity,this.columns=e.columns,this.rows=e.rows}getHeightBelow(t,e,n,i){return this.getScalarValue(t,"KRHB",e,n,i,this.heightBelow)}getHeightAbove(t,e,n,i){return this.getScalarValue(t,"KRHA",e,n,i,this.heightAbove)}getTextureSlot(t,e,n,i){return this.getScalarValue(t,"KRTX",e,n,i,0)}getColor(t,e,n,i){return this.getVectorValue(t,"KRCO",e,n,i,this.color)}getAlpha(t,e,n,i){return this.getScalarValue(t,"KRAL",e,n,i,this.alpha)}getVisibility(t,e,n,i){const r=this.getAlpha(t,e,n,i);return 0===t[0]?r:this.getScalarValue(t,"KRVS",e,n,i,1)}}class g_ extends Ym{constructor(t,e){super(t,e),this.name=e.name,this.position=e.position,this.fieldOfView=e.fieldOfView,this.farClippingPlane=e.farClippingPlane,this.nearClippingPlane=e.nearClippingPlane,this.targetPosition=e.targetPosition}getTranslation(t,e,n,i){return this.getVectorValue(t,"KCTR",e,n,i,ta)}getTargetTranslation(t,e,n,i){return this.getVectorValue(t,"KTTR",e,n,i,ta)}getRotation(t,e,n,i){return this.getScalarValue(t,"KCRL",e,n,i,0)}}class v_ extends e_{constructor(t,e,n){super(t,e,n),this.geometryEmitterType=-1,this.globalSequence=-1,this.defval=new Uint32Array(1),this.internalModel=null,this.internalTexture=null,this.colors=[],this.intervalTimes=new Float32Array(3),this.scale=0,this.columns=0,this.rows=0,this.lifeSpan=0,this.blendSrc=0,this.blendDst=0,this.intervals=[],this.distanceCutoff=0,this.maxDistance=0,this.minDistance=0,this.pitch=0,this.pitchVariance=0,this.volume=0,this.decodedBuffers=[],this.ok=!1;const i=t.viewer,r=e.name;let s=r.substring(0,3);const a=r.substring(4);"FPT"===s&&(s="SPL"),"SPL"===s?this.geometryEmitterType=2:"UBR"===s&&(this.geometryEmitterType=3),this.type=s,this.id=a,this.tracks=e.tracks;const o=e.globalSequenceId;if(-1!==o&&(this.globalSequence=t.globalSequences[o]),"SND"===s&&!i.audioEnabled)return;const l=i.promise();Ug.getEventObjectData(i,s,a,t.hd).then((t=>{if(l(),t){const{row:e,resources:n}=t;if(this.ok=!0,"SPN"===s)this.internalModel=n[0];else if("SPL"===s||"UBR"===s){this.internalTexture=new p_(0,3),this.internalTexture.texture=n[0],this.scale=e.number("Scale"),this.colors[0]=new Float32Array([e.number("StartR"),e.number("StartG"),e.number("StartB"),e.number("StartA")]),this.colors[1]=new Float32Array([e.number("MiddleR"),e.number("MiddleG"),e.number("MiddleB"),e.number("MiddleA")]),this.colors[2]=new Float32Array([e.number("EndR"),e.number("EndG"),e.number("EndB"),e.number("EndA")]),"SPL"===s?(this.columns=e.number("Columns"),this.rows=e.number("Rows"),this.lifeSpan=e.number("Lifespan")+e.number("Decay"),this.intervalTimes[0]=e.number("Lifespan"),this.intervalTimes[1]=e.number("Decay"),this.intervals[0]=new Float32Array([e.number("UVLifespanStart"),e.number("UVLifespanEnd"),e.number("LifespanRepeat")]),this.intervals[1]=new Float32Array([e.number("UVDecayStart"),e.number("UVDecayEnd"),e.number("DecayRepeat")])):(this.columns=1,this.rows=1,this.lifeSpan=e.number("BirthTime")+e.number("PauseTime")+e.number("Decay"),this.intervalTimes[0]=e.number("BirthTime"),this.intervalTimes[1]=e.number("PauseTime"),this.intervalTimes[2]=e.number("Decay"));const t=Wm(e.number("BlendMode"),i.gl);this.blendSrc=t[0],this.blendDst=t[1]}else{this.distanceCutoff=e.number("DistanceCutoff"),this.maxDistance=e.number("MaxDistance"),this.minDistance=e.number("MinDistance"),this.pitch=e.number("Pitch"),this.pitchVariance=e.number("PitchVariance"),this.volume=e.number("Volume");for(const t of n)this.decodedBuffers.push(t.data)}}}))}getValue(t,e){if(-1!==this.globalSequence){const n=this.globalSequence;return this.getValueAtTime(t,e.counter%n,0,n)}if(-1!==e.sequence){const n=this.model.sequences[e.sequence].interval;return this.getValueAtTime(t,e.frame,n[0],n[1])}return t[0]=this.defval[0],-1}getValueAtTime(t,e,n,i){const r=this.tracks;if(e>=n&&e<=i)for(let i=r.length-1;i>-1;i--){if(r[i]<n)return t[0]=0,i;if(r[i]<=e)return t[0]=1,i}return t[0]=0,-1}}class b_ extends e_{constructor(t,e,n){super(t,e,n),this.type=e.type,this.vertices=e.vertices,this.boundsRadius=e.boundsRadius}}var w_;!function(t){t[t.VertexGroups=0]="VertexGroups",t[t.ExtendedVertexGroups=1]="ExtendedVertexGroups",t[t.Skin=2]="Skin"}(w_||(w_={}));class A_{constructor(t,e,n,i,r){let s,a;r?(s=n,a=s.layers[0]):(s=null,a=n),this.index=t,this.geoset=e,this.skinningType=i,this.isHd=r,this.layer=a,this.material=s}}class y_{constructor(t,e,n,i,r,s,a,o,l,h,u){this.geosetAnimation=null,this.model=t,this.index=e,this.positionOffset=n,this.normalOffset=i,this.uvOffset=r,this.tangentOffset=s,this.skinOffset=a,this.faceOffset=o,this.vertices=l,this.elements=h,this.faceType=u;for(const n of t.geosetAnimations)n.geosetId===e&&(this.geosetAnimation=n)}bindShared(t,e,n){t.vertexAttribPointer(e.a_position,3,t.FLOAT,!1,0,this.positionOffset),t.vertexAttribPointer(e.a_normal,3,t.FLOAT,!1,0,this.normalOffset),t.vertexAttribPointer(e.a_uv,2,t.FLOAT,!1,0,this.uvOffset+n*this.vertices*8)}bindVertexGroups(t,e){const n=this.model,i=n.skinDataType,r=n.bytesPerSkinElement;t.vertexAttribPointer(e.a_bones,4,i,!1,5*r,this.skinOffset),t.vertexAttribPointer(e.a_boneNumber,1,i,!1,5*r,this.skinOffset+4*r)}bindVertexGroupsExtended(t,e){const n=this.model,i=n.skinDataType,r=n.bytesPerSkinElement;t.vertexAttribPointer(e.a_bones,4,i,!1,9*r,this.skinOffset),t.vertexAttribPointer(e.a_extendedBones,4,i,!1,9*r,this.skinOffset+4*r),t.vertexAttribPointer(e.a_boneNumber,1,i,!1,9*r,this.skinOffset+8*r)}bindSkin(t,e){t.vertexAttribPointer(e.a_bones,4,t.UNSIGNED_BYTE,!1,8,this.skinOffset),t.vertexAttribPointer(e.a_weights,4,t.UNSIGNED_BYTE,!0,8,this.skinOffset+4)}bind(t,e){const n=this.model.viewer.gl,i=t.attribs;this.bindShared(n,i,e),this.bindVertexGroups(n,i)}bindExtended(t,e){const n=this.model.viewer.gl,i=t.attribs;this.bindShared(n,i,e),this.bindVertexGroupsExtended(n,i)}bindHd(t,e,n){const i=this.model.viewer.gl,r=t.attribs;this.bindShared(i,r,n),i.vertexAttribPointer(r.a_tangent,4,i.FLOAT,!1,0,this.tangentOffset),e===w_.Skin?this.bindSkin(i,r):e===w_.ExtendedVertexGroups?this.bindVertexGroupsExtended(i,r):this.bindVertexGroups(i,r)}render(){const t=this.model.viewer.gl;t.drawElements(this.faceType,this.elements,t.UNSIGNED_SHORT,this.faceOffset)}}class x_{constructor(t,e,n){this.objects=[],this.model=t,this.skinningType=e,this.isHd=n}render(t){const e=t.scene,n=e.camera,i=t.textureOverrides,r=t.layerAlphas,s=this.model,a=s.textures,o=s.batches,l=s.viewer,h=l.sharedCache.get("mdx"),u=l.gl,c=l.webgl,d=this.skinningType,f=this.isHd,p=h.teamColors,m=h.teamGlows,_=Ug.getBatchShader(l,d,f);_.use();const g=_.uniforms;u.uniformMatrix4fv(g.u_VP,!1,n.viewProjectionMatrix);const v=t.boneTexture;if(v?(v.bind(15),u.uniform1f(g.u_hasBones,1),u.uniform1i(g.u_boneMap,15),u.uniform1f(g.u_vectorSize,1/v.width),u.uniform1f(g.u_rowSize,1)):u.uniform1f(g.u_hasBones,0),u.uniform3fv(g.u_lightPos,e.lightPosition),u.bindBuffer(u.ARRAY_BUFFER,s.arrayBuffer),u.bindBuffer(u.ELEMENT_ARRAY_BUFFER,s.elementBuffer),f){u.uniform1i(g.u_diffuseMap,0),u.uniform1i(g.u_normalsMap,1),u.uniform1i(g.u_ormMap,2),u.uniform1i(g.u_emissiveMap,3),u.uniform1i(g.u_teamColorMap,4),u.uniform1i(g.u_environmentMap,5),u.disable(u.BLEND),u.enable(u.DEPTH_TEST),u.depthMask(!0),u.uniformMatrix4fv(g.u_MV,!1,n.viewMatrix),u.uniform3fv(g.u_eyePos,n.location);for(const e of this.objects){const n=o[e],s=n.geoset,l=n.material,[h,d,f,m,v,b]=l.layers,w=r[h.index];if(w>0){u.uniform1f(g.u_layerAlpha,w),u.uniform1f(g.u_filterMode,h.filterMode);const e=h.textureId,r=d.textureId,o=f.textureId,l=m.textureId,A=v.textureId,y=b.textureId,x=a[e],T=a[r],L=a[o],E=a[l];let S=a[A];const M=a[y];0!==S.replaceableId&&1!==S.replaceableId||(S=p[t.teamColor]);const k=i.get(e)||x.texture,R=i.get(r)||T.texture,I=i.get(o)||L.texture,U=i.get(l)||E.texture,O=i.get(A)||S.texture,C=i.get(y)||M.texture;c.bindTextureAndWrap(k,0,x.wrapS,x.wrapT),c.bindTextureAndWrap(R,1,T.wrapS,T.wrapT),c.bindTextureAndWrap(I,2,L.wrapS,L.wrapT),c.bindTextureAndWrap(U,3,E.wrapS,E.wrapT),c.bindTextureAndWrap(O,4,S.wrapS,S.wrapT),c.bindTextureAndWrap(C,5,M.wrapS,M.wrapT),s.bindHd(_,n.skinningType,h.coordId),s.render()}}}else{const e=t.geosetColors,n=t.layerTextures,s=t.uvAnims;u.uniform4fv(g.u_vertexColor,t.vertexColor),u.uniform1i(g.u_texture,0);for(const l of this.objects){const h=o[l],f=h.geoset,v=h.layer,b=f.index,w=v.index,A=e[b],y=r[w];if(A[3]>.01&&y>.01){const e=n[w],r=a[e],o=s[w];u.uniform4fv(g.u_geosetColor,A),u.uniform1f(g.u_layerAlpha,y),u.uniform1f(g.u_unshaded,v.unshaded),u.uniform2f(g.u_uvTrans,o[0],o[1]),u.uniform2f(g.u_uvRot,o[2],o[3]),u.uniform1f(g.u_uvScale,o[4]),v.bind(_);let l=i.get(e);if(!l){const e=r.replaceableId;let n;n=1===e?p[t.teamColor]:2===e?m[t.teamColor]:r,n&&(l=n.texture)}c.bindTextureAndWrap(l,0,r.wrapS,r.wrapT),d===w_.ExtendedVertexGroups?f.bindExtended(_,v.coordId):f.bind(_,v.coordId),f.render()}}}}}class T_{constructor(t){this.objects=[],this.model=t}render(t){const e=t.scene,n=t.nodes,i=t.model.viewer,r=i.gl,s=i.webgl.extensions.ANGLE_instanced_arrays,a=i.sharedCache.get("mdx"),o=a.particlesShader,l=o.uniforms,h=o.attribs,u=a.rectBuffer;r.depthMask(!1),r.enable(r.BLEND),r.disable(r.CULL_FACE),r.enable(r.DEPTH_TEST),o.use(),r.uniformMatrix4fv(l.u_VP,!1,e.camera.viewProjectionMatrix),r.uniform1i(l.u_texture,0),s.vertexAttribDivisorANGLE(h.a_position,0),r.bindBuffer(r.ARRAY_BUFFER,u),r.vertexAttribPointer(h.a_position,1,r.UNSIGNED_BYTE,!1,0,0),s.vertexAttribDivisorANGLE(h.a_p0,1),s.vertexAttribDivisorANGLE(h.a_p1,1),s.vertexAttribDivisorANGLE(h.a_p2,1),s.vertexAttribDivisorANGLE(h.a_p3,1),s.vertexAttribDivisorANGLE(h.a_health,1),s.vertexAttribDivisorANGLE(h.a_color,1),s.vertexAttribDivisorANGLE(h.a_tail,1),s.vertexAttribDivisorANGLE(h.a_leftRightTop,1);for(const t of this.objects)f_(n[t].object,o);s.vertexAttribDivisorANGLE(h.a_leftRightTop,0),s.vertexAttribDivisorANGLE(h.a_tail,0),s.vertexAttribDivisorANGLE(h.a_color,0),s.vertexAttribDivisorANGLE(h.a_health,0),s.vertexAttribDivisorANGLE(h.a_p3,0),s.vertexAttribDivisorANGLE(h.a_p2,0),s.vertexAttribDivisorANGLE(h.a_p1,0),s.vertexAttribDivisorANGLE(h.a_p0,0)}}function L_(t){return t instanceof A_||t instanceof __?t.layer.priorityPlane:t instanceof m_?t.priorityPlane:0}function E_(t,e){return t instanceof x_?e instanceof A_&&e.skinningType===t.skinningType&&e.isHd===t.isHd:e instanceof e_}function S_(t,e){return e instanceof A_?new x_(t,e.skinningType,e.isHd):new T_(t)}class M_ extends gm{convertBasis(t){Ni(t,t,-Math.PI/2),Pi(t,t,-Math.PI/2)}}const k_=new Float32Array(1);class R_{constructor(t,e){const n=e.internalModel.addInstance();n.setSequenceLoopMode(2),n.dontInheritScaling=!1,n.hide(),n.setParent(t.nodes[e.objectId]),this.instance=t,this.attachment=e,this.internalInstance=n}update(){const t=this.instance,e=this.internalInstance;t.scene&&-1!==t.sequence&&(this.attachment.getVisibility(k_,t.sequence,t.frame,t.counter),k_[0]>.1?(t.scene.addInstance(e),e.hidden()&&(e.show(),e.setSequence(0))):e.hide())}}class I_{constructor(t){this.objects=[],this.alive=0,this.currentEmission=0,this.instance=t}update(t){this.updateEmission(t);const e=this.currentEmission;if(e>=1)for(let t=0;t<e;t+=1)this.emit()}clear(){const t=this.objects;for(let e=0,n=this.alive;e<n;e++){t[e].health=0}this.currentEmission=0}emitObject(t){const e=this.objects;this.alive===e.length&&e.push(this.createObject());const n=e[this.alive];n.index=this.alive,n.bind(t),this.alive+=1,this.currentEmission-=1;return this.instance.scene.emittedObjectUpdater.add(n),n}kill(t){const e=this.objects;this.alive-=1;const n=e[this.alive];e[t.index]=n,e[this.alive]=t,n.index=t.index,t.index=-1}}class U_ extends I_{constructor(t,e){super(t),this.emitterObject=e}update(t){this.emitterObject.ok&&super.update(t)}}class O_{constructor(t){this.index=-1,this.health=0,this.emitter=t}}const C_=Ri(),B_=qe(),P_=new Float32Array(1),N_=new Float32Array(1),D_=new Float32Array(1),F_=new Float32Array(1);class V_ extends O_{constructor(t){super(t),this.velocity=qe(),this.gravity=0;const e=t.emitterObject.internalModel;this.internalInstance=e.addInstance()}bind(){const t=this.emitter,e=t.instance,n=e.sequence,i=e.frame,r=e.counter,s=e.scene,a=t.emitterObject,o=e.nodes[a.index],l=this.internalInstance,h=o.worldScale,u=this.velocity;a.getLatitude(P_,n,i,r),a.getLifeSpan(N_,n,i,r),a.getGravity(D_,n,i,r),a.getSpeed(F_,n,i,r),this.health=N_[0],this.gravity=D_[0]*h[2],Ii(C_),Di(C_,C_,wa(-Math.PI,Math.PI)),Ni(C_,C_,wa(-P_[0],P_[0])),Ln(u,Qs,C_),Ln(u,u,o.worldRotation),hn(u,u,F_[0]),Pn(u,u,h),l.setScene(s),l.setSequence(0),l.setTransformation(o.worldLocation,Ui(C_,Qs,wa(0,2*Math.PI)),o.worldScale),l.show()}update(t){const e=this.internalInstance;if(this.health-=t,this.health>0){const n=this.velocity;n[2]-=this.gravity*t,e.move(hn(B_,n,t))}else e.hide()}}const G_=new Float32Array(1);class K_ extends U_{updateEmission(t){const e=this.instance;if(e.allowParticleSpawn){this.emitterObject.getEmissionRate(G_,e.sequence,e.frame,e.counter),this.currentEmission+=G_[0]*t}}emit(){this.emitObject()}createObject(){return new V_(this)}}const j_=Ri(),z_=new Float32Array(1),H_=new Float32Array(1),X_=new Float32Array(1),q_=new Float32Array(1),Y_=new Float32Array(1),$_=new Float32Array(1);class W_ extends O_{constructor(){super(...arguments),this.tail=0,this.gravity=0,this.location=qe(),this.velocity=qe(),this.scale=qe(),this.facing=0}bind(t){const e=this.emitter,n=e.instance,i=n.sequence,r=n.frame,s=n.counter,a=e.emitterObject;a.getWidth(z_,i,r,s),a.getLength(H_,i,r,s),a.getLatitude(X_,i,r,s),a.getVariation(q_,i,r,s),a.getSpeed(Y_,i,r,s),a.getGravity($_,i,r,s);const o=e.node,l=o.pivot,h=o.worldScale,u=.5*z_[0],c=.5*H_[0],d=va(X_[0]),f=q_[0],p=Y_[0],m=this.location,_=this.velocity;this.health=a.lifeSpan,this.tail=t,this.gravity=$_[0]*h[2],Ze(this.scale,h),m[0]=l[0]+wa(-u,u),m[1]=l[1]+wa(-c,c),m[2]=l[2],a.modelSpace||xn(m,m,o.worldMatrix),Ii(j_),Di(j_,j_,Math.PI/2),Ni(j_,j_,wa(-d,d)),a.lineEmitter||Pi(j_,j_,wa(-d,d)),a.modelSpace||or(j_,o.worldRotation,j_),Ln(_,Qs,j_),hn(_,_,p*(1+wa(-f,f))),a.modelSpace||Pn(_,_,h),a.xYQuad&&(this.facing=Math.atan2(_[1],_[0])-Math.PI+Math.PI/8)}update(t){if(this.health-=t,this.health>0){const e=this.location,n=this.velocity;n[2]-=this.gravity*t,e[0]+=n[0]*t,e[1]+=n[1]*t,e[2]+=n[2]*t}}}const Z_=new Float32Array(1);class J_ extends U_{constructor(t,e){super(t,e),this.lastEmissionKey=-1,this.node=t.nodes[e.index]}updateEmission(t){const e=this.instance;if(e.allowParticleSpawn){const n=this.emitterObject,i=n.getEmissionRate(Z_,e.sequence,e.frame,e.counter);n.squirt?(i!==this.lastEmissionKey&&(this.currentEmission+=Z_[0]),this.lastEmissionKey=i):this.currentEmission+=Z_[0]*t}}emit(){const t=this.emitterObject;t.head&&this.emitObject(0),t.tail&&this.emitObject(1)}createObject(){return new W_(this)}}const Q_=qe(),tg=qe(),eg=new Float32Array(3),ng=new Float32Array(1),ig=new Uint32Array(1);class rg extends O_{constructor(){super(...arguments),this.vertices=new Float32Array(6),this.color=new Uint8Array(4),this.slot=0,this.prev=null,this.next=null}bind(){const t=this.emitter,e=t.instance,n=e.sequence,i=e.frame,r=e.counter,s=t.emitterObject,a=e.nodes[s.index],[o,l,h]=a.pivot,u=a.worldMatrix,c=this.vertices;this.health=t.emitterObject.lifeSpan,s.getHeightBelow(Q_,n,i,r),s.getHeightAbove(tg,n,i,r),Q_[1]=l-Q_[0],Q_[0]=o,Q_[2]=h,tg[1]=l+tg[0],tg[0]=o,tg[2]=h,xn(Q_,Q_,u),xn(tg,tg,u),c[0]=tg[0],c[1]=tg[1],c[2]=tg[2],c[3]=Q_[0],c[4]=Q_[1],c[5]=Q_[2]}update(t){if(this.health-=t,this.health>0){const e=this.emitter,n=e.instance,i=n.sequence,r=n.frame,s=n.counter,a=e.emitterObject,o=this.color,l=this.vertices,h=a.gravity*t*t;a.getColor(eg,i,r,s),a.getAlpha(ng,i,r,s),a.getTextureSlot(ig,i,r,s),l[1]-=h,l[4]-=h,o[0]=255*eg[0],o[1]=255*eg[1],o[2]=255*eg[2],o[3]=255*ng[0],this.slot=ig[0]}}}class sg extends U_{constructor(){super(...arguments),this.first=null,this.last=null}updateEmission(t){if(this.instance.allowParticleSpawn){const e=this.emitterObject;this.currentEmission+=e.emissionRate*t}}emit(){const t=this.emitObject(),e=this.last;e?(e.next=t,t.prev=e):this.first=t,this.last=t}kill(t){super.kill(t);const e=t.prev,n=t.next;t===this.first&&(this.first=n),t===this.last&&(this.first=null,this.last=null),e&&(e.next=n),n&&(n.prev=e),t.prev=null,t.next=null}createObject(){return new rg(this)}}const ag=new Uint32Array(1);class og extends U_{constructor(){super(...arguments),this.lastValue=0}updateEmission(t){const e=this.instance;if(e.allowParticleSpawn){this.emitterObject.getValue(ag,e);const t=ag[0];1===t&&t!==this.lastValue&&(this.currentEmission+=1),this.lastValue=t}}emit(){this.emitObject()}}class lg extends O_{constructor(t){super(t);const e=t.emitterObject.internalModel;this.internalInstance=e.addInstance()}bind(){const t=this.emitter,e=t.instance,n=e.scene,i=e.nodes[t.emitterObject.index],r=this.internalInstance;r.setScene(n),r.setSequence(0),r.setTransformation(i.worldLocation,i.worldRotation,i.worldScale),r.show(),this.health=1}update(t){const e=this.internalInstance,n=e.model;e.frame>=n.sequences[0].interval[1]&&(this.health=0,e.hide())}}class hg extends og{createObject(){return new lg(this)}}const ug=qe();class cg extends O_{constructor(){super(...arguments),this.vertices=new Float32Array(12)}bind(){const t=this.emitter,e=t.instance,n=t.emitterObject,i=this.vertices,r=n.scale,{worldLocation:s,worldRotation:a}=e.nodes[n.index];this.health=n.lifeSpan,Je(ug,r,r,0),Ln(ug,ug,a),Qe(i.subarray(0,2),ug,s),Je(ug,-r,r,0),Ln(ug,ug,a),Qe(i.subarray(3,5),ug,s),Je(ug,-r,-r,0),Ln(ug,ug,a),Qe(i.subarray(6,8),ug,s),Je(ug,r,-r,0),Ln(ug,ug,a),Qe(i.subarray(9,11),ug,s)}update(t){this.health-=t}}class dg extends og{createObject(){return new cg(this)}}class fg extends og{createObject(){return new cg(this)}}class pg extends O_{bind(){const t=this.emitter,e=t.instance,n=e.model.viewer,i=e.scene;if(n.audioEnabled&&i.audioEnabled){const n=t.emitterObject,r=e.nodes[n.index],s=i.audioContext,a=n.decodedBuffers,o=s.createPanner(),l=s.createBufferSource(),h=r.worldLocation;o.positionX.value=h[0],o.positionY.value=h[1],o.positionZ.value=h[2],o.maxDistance=n.distanceCutoff,o.refDistance=n.minDistance,o.connect(s.destination),l.buffer=a[Math.random()*a.length|0],l.connect(o),l.start(0)}}update(t){}}class mg extends og{createObject(){return new pg(this)}}const _g=new Float32Array(1),gg=qe(),vg=Ri(),bg=qe(),wg=new Float32Array(3),Ag=new Float32Array(1),yg=new Uint32Array(1);class xg extends Hp{constructor(t){super(t),this.attachments=[],this.particleEmitters=[],this.particleEmitters2=[],this.ribbonEmitters=[],this.eventObjectEmitters=[],this.nodes=[],this.sortedNodes=[],this.frame=0,this.counter=0,this.sequence=-1,this.sequenceLoopMode=0,this.sequenceEnded=!1,this.teamColor=0,this.vertexColor=new Float32Array([1,1,1,1]),this.allowParticleSpawn=!1,this.forced=!0,this.geosetColors=[],this.layerAlphas=[],this.layerTextures=[],this.uvAnims=[],this.worldMatrices=null,this.boneTexture=null;for(let e=0,n=t.geosets.length;e<n;e++)this.geosetColors[e]=new Float32Array(4);for(let e=0,n=t.layers.length;e<n;e++)this.layerAlphas[e]=0,this.layerTextures[e]=0,this.uvAnims[e]=new Float32Array(5);const e=vm(t.genericObjects.length,M_),n=e.nodes;let i=0;this.nodes.push(...n),this.worldMatrices=e.worldMatrices;for(const e of t.bones)this.initNode(n,n[i++],e);for(const e of t.lights)this.initNode(n,n[i++],e);for(const e of t.helpers)this.initNode(n,n[i++],e);for(const e of t.attachments){let t;e.internalModel&&(t=new R_(this,e),this.attachments.push(t)),this.initNode(n,n[i++],e,t)}for(const e of t.particleEmitters){const t=new K_(this,e);this.particleEmitters.push(t),this.initNode(n,n[i++],e,t)}for(const e of t.particleEmitters2){const t=new J_(this,e);this.particleEmitters2.push(t),this.initNode(n,n[i++],e,t)}for(const e of t.ribbonEmitters){const t=new sg(this,e);this.ribbonEmitters.push(t),this.initNode(n,n[i++],e,t)}for(const e of t.eventObjects){const t=e.type;let r;r="SPN"===t?new hg(this,e):"SPL"===t?new dg(this,e):"UBR"===t?new fg(this,e):new mg(this,e),this.eventObjectEmitters.push(r),this.initNode(n,n[i++],e,r)}for(const e of t.collisionShapes)this.initNode(n,n[i++],e);const r=t.hierarchy;for(let t=0,e=n.length;t<e;t++)this.sortedNodes[t]=n[r[t]];t.bones.length&&(this.boneTexture=new bp(t.viewer.gl,4,4*t.bones.length,1))}setTexture(t,e){this.overrideTexture(t,e)}setParticle2Texture(t,e){this.overrideTexture(1e3+t,e)}setEventTexture(t,e){this.overrideTexture(c_+t,e)}clearEmittedObjects(){for(const t of this.particleEmitters)t.clear();for(const t of this.particleEmitters2)t.clear();for(const t of this.ribbonEmitters)t.clear();for(const t of this.eventObjectEmitters)t.clear()}initNode(t,e,n,i){Ze(e.pivot,n.pivot),-1===n.parentId?e.parent=this:e.parent=t[n.parentId],e.dontInheritTranslation=n.dontInheritTranslation,e.dontInheritRotation=n.dontInheritRotation,e.dontInheritScaling=n.dontInheritScaling,n.billboarded?e.billboarded=!0:n.billboardedX?e.billboardedX=!0:n.billboardedY?e.billboardedY=!0:n.billboardedZ&&(e.billboardedZ=!0),i&&(e.object=i)}hide(){super.hide(),this.resetAttachments()}updateNodes(t,e){const n=this.sequence,i=this.frame,r=this.counter,s=this.sortedNodes,a=this.model.sortedGenericObjects;for(let o=0,l=s.length;o<l;o++){const l=a[o],h=s[o],u=h.parent;let c=e||u.wasDirty||l.anyBillboarding;const d=l.variants;(e||d.generic[n])&&(c=!0,(e||d.translation[n])&&l.getTranslation(h.localLocation,n,i,r),(e||d.rotation[n])&&l.getRotation(h.localRotation,n,i,r),(e||d.scale[n])&&l.getScale(h.localScale,n,i,r)),h.wasDirty=c,c&&h.recalculateTransformation(this),h.object&&(l.getVisibility(_g,n,i,r),_g[0]>0&&h.object.update(t));for(const e of h.children)c&&e.recalculateTransformation(),e.update(t)}}recalculateTransformation(){super.recalculateTransformation(),this.forced=!0}updateBatches(t){const e=this.sequence,n=this.frame,i=this.counter,r=this.model,s=r.geosets,a=r.layers,o=this.geosetColors,l=this.layerAlphas,h=this.layerTextures,u=this.uvAnims;for(let r=0,a=s.length;r<a;r++){const a=s[r].geosetAnimation,l=o[r];a?((t||a.variants.color[e])&&(a.getColor(wg,e,n,i),l[0]=wg[0],l[1]=wg[1],l[2]=wg[2]),(t||a.variants.alpha[e])&&(a.getAlpha(Ag,e,n,i),l[3]=Ag[0])):t&&(l[0]=1,l[1]=1,l[2]=1,l[3]=1)}for(let r=0,s=a.length;r<s;r++){const s=a[r],o=s.textureAnimation,c=u[r];(t||s.variants.alpha[e])&&(s.getAlpha(Ag,e,n,i),l[r]=Ag[0]),(t||s.variants.textureId[e])&&(s.getTextureId(yg,e,n,i),h[r]=yg[0]),o?((t||o.variants.translation[e])&&(o.getTranslation(gg,e,n,i),c[0]=gg[0],c[1]=gg[1]),(t||o.variants.rotation[e])&&(o.getRotation(vg,e,n,i),c[2]=vg[2],c[3]=vg[3]),(t||o.variants.scale[e])&&(o.getScale(bg,e,n,i),c[4]=bg[0])):t&&(c[0]=0,c[1]=0,c[2]=0,c[3]=1,c[4]=1)}}updateBoneTexture(){this.boneTexture&&this.boneTexture.bindAndUpdate(this.worldMatrices)}renderOpaque(){const t=this.model;for(const e of t.opaqueGroups)e.render(this)}renderTranslucent(){const t=this.model;for(const e of t.translucentGroups)e.render(this)}updateAnimations(t){const e=this.model,n=this.sequence;if(-1!==n){const i=e.sequences[n],r=i.interval,s=1e3*t;this.frame+=s,this.counter+=s,this.allowParticleSpawn=!0,this.frame>=r[1]?(2===this.sequenceLoopMode||0===this.sequenceLoopMode&&0===i.nonLooping?(this.frame=r[0],this.resetEventEmitters()):(this.frame=r[1],this.counter-=s,this.allowParticleSpawn=!1),this.sequenceEnded=!0):this.sequenceEnded=!1}const i=this.forced;(-1!==n||i)&&(this.updateNodes(t,i),this.updateBoneTexture(),this.updateBatches(i)),this.forced=!1}setTeamColor(t){return this.teamColor=t,this}setVertexColor(t){return this.vertexColor.set(t),this}setSequence(t){const e=this.model.sequences;return this.sequence=t,t<0||t>e.length-1?(this.sequence=-1,this.frame=0,this.allowParticleSpawn=!1):this.frame=e[t].interval[0],this.resetEventEmitters(),this.resetAttachments(),this.forced=!0,this}getBounds(){const t=this.model;if(-1===this.sequence)return t.bounds;const e=t.sequences[this.sequence].bounds;return 0===e.r?t.bounds:e}setSequenceLoopMode(t){return this.sequenceLoopMode=t,this}getAttachment(t){const e=this.model.attachments[t];if(e)return this.nodes[e.index]}resetEventEmitters(){for(const t of this.eventObjectEmitters)t.lastValue=0}resetAttachments(){for(const t of this.attachments)t.internalInstance.hide()}}const Tg="\n#ifdef SKIN\nattribute vec4 a_bones;\nattribute vec4 a_weights;\n\nvoid transformSkin(inout vec3 position, inout vec3 normal, inout vec3 tangent, inout vec3 binormal) {\n  mat4 bone;\n\n  bone += fetchMatrix(a_bones[0], 0.0) * a_weights[0];\n  bone += fetchMatrix(a_bones[1], 0.0) * a_weights[1];\n  bone += fetchMatrix(a_bones[2], 0.0) * a_weights[2];\n  bone += fetchMatrix(a_bones[3], 0.0) * a_weights[3];\n\n  mat3 rotation = mat3(bone);\n\n  position = vec3(bone * vec4(position, 1.0));\n  normal = rotation * normal;\n  tangent = rotation * tangent;\n  binormal = rotation * binormal;\n}\n#else\nattribute vec4 a_bones;\n#ifdef EXTENDED_BONES\nattribute vec4 a_extendedBones;\n#endif\nattribute float a_boneNumber;\n\nmat4 getVertexGroupMatrix() {\n  mat4 bone;\n\n  // For the broken models out there, since the game supports this.\n  if (a_boneNumber > 0.0) {\n    for (int i = 0; i < 4; i++) {\n      if (a_bones[i] > 0.0) {\n        bone += fetchMatrix(a_bones[i] - 1.0, 0.0);\n      }\n    }\n\n    #ifdef EXTENDED_BONES\n      for (int i = 0; i < 4; i++) {\n        if (a_extendedBones[i] > 0.0) {\n          bone += fetchMatrix(a_extendedBones[i] - 1.0, 0.0);\n        }\n      }\n    #endif\n  }\n\n  return bone / a_boneNumber;\n}\n\nvoid transformVertexGroups(inout vec3 position, inout vec3 normal) {\n  mat4 bone = getVertexGroupMatrix();\n  mat3 rotation = mat3(bone);\n\n  position = vec3(bone * vec4(position, 1.0));\n  normal = normalize(rotation * normal);\n}\n\nvoid transformVertexGroupsHD(inout vec3 position, inout vec3 normal, inout vec3 tangent, inout vec3 binormal) {\n  mat4 bone = getVertexGroupMatrix();\n  mat3 rotation = mat3(bone);\n\n  position = vec3(bone * vec4(position, 1.0));\n  normal = normalize(rotation * normal);\n  tangent = normalize(rotation * tangent);\n  binormal = normalize(rotation * binormal);\n}\n#endif\n",Lg=`\nuniform mat4 u_VP;\nuniform vec3 u_lightPos;\nuniform vec4 u_vertexColor;\nuniform vec4 u_geosetColor;\nuniform float u_layerAlpha;\nuniform vec2 u_uvTrans;\nuniform vec2 u_uvRot;\nuniform float u_uvScale;\nuniform bool u_hasBones;\n\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_uv;\n\nvarying vec2 v_uv;\nvarying vec3 v_normal;\nvarying vec4 v_color;\nvarying vec4 v_uvTransRot;\nvarying float v_uvScale;\nvarying vec3 v_lightDir;\n\n${Tm}\n${Tg}\n\nvoid main() {\n  vec3 position = a_position;\n  vec3 normal = a_normal;\n\n  if (u_hasBones) {\n    transformVertexGroups(position, normal);\n  }\n\n  v_uv = a_uv;\n  v_normal = normal;\n  v_color = u_vertexColor * u_geosetColor.bgra * vec4(1.0, 1.0, 1.0, u_layerAlpha);\n  v_uvTransRot = vec4(u_uvTrans, u_uvRot);\n  v_uvScale = u_uvScale;\n  v_lightDir = normalize(u_lightPos - position);\n\n  gl_Position = u_VP * vec4(position, 1.0);\n}\n`,Eg=`\n${Em}\n\n\n// A 2D quaternion*vector.\n// q is the zw components of the original quaternion.\nvec2 quat_transform(vec2 q, vec2 v) {\n  vec2 uv = vec2(-q.x * v.y, q.x * v.x);\n  vec2 uuv = vec2(-q.x * uv.y, q.x * uv.x);\n\n  return v + 2.0 * (uv * q.y + uuv);\n}\n\n\nuniform sampler2D u_texture;\nuniform float u_filterMode;\nuniform bool u_unshaded;\n\nvarying vec2 v_uv;\nvarying vec3 v_normal;\nvarying vec4 v_color;\nvarying vec4 v_uvTransRot;\nvarying float v_uvScale;\nvarying vec3 v_lightDir;\n\nvec4 getDiffuseColor() {\n  vec2 uv = v_uv;\n\n  // Translation animation\n  uv += v_uvTransRot.xy;\n\n  // Rotation animation\n  uv = quat_transform(v_uvTransRot.zw, uv - 0.5) + 0.5;\n\n  // Scale animation\n  uv = v_uvScale * (uv - 0.5) + 0.5;\n\n  vec4 texel = texture2D(u_texture, uv);\n  vec4 color = texel * v_color;\n\n  // 1bit Alpha\n  if (u_filterMode == 1.0 && color.a < 0.75) {\n    discard;\n  }\n\n  // "Close to 0 alpha"\n  if (u_filterMode >= 5.0 && color.a < 0.02) {\n    discard;\n  }\n\n  return color;\n}\n\nvoid onlyTexCoords() {\n  gl_FragColor = vec4(v_uv, 0.0, 1.0);\n}\n\nvoid onlyNormals() {\n  gl_FragColor = vec4(v_normal, 1.0);\n}\n\nvoid onlyDiffuse() {\n  gl_FragColor = getDiffuseColor();\n}\n\nvoid lambert() {\n  vec4 color = getDiffuseColor();\n\n  if (!u_unshaded) {\n    float lambertFactor = clamp(dot(v_normal, v_lightDir), 0.0, 1.0);\n    lambertFactor = clamp(lambertFactor + 0.7, 0.0, 1.0);\n\n    color.rgb *= lambertFactor;\n  }\n\n  gl_FragColor = color;\n}\n\nvoid main() {\n  #if defined(ONLY_DIFFUSE)\n  onlyDiffuse();\n  #elif defined(ONLY_TEXCOORDS)\n  onlyTexCoords();\n  #elif defined(ONLY_NORMALS)\n  onlyNormals();\n  #else\n  lambert();\n  #endif\n}\n`,Sg=`\nuniform mat4 u_VP;\nuniform mat4 u_MV;\nuniform vec3 u_eyePos;\nuniform vec3 u_lightPos;\nuniform float u_layerAlpha;\nuniform bool u_hasBones;\n\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_uv;\nattribute vec4 a_tangent;\n\nvarying vec2 v_uv;\nvarying float v_layerAlpha;\nvarying vec3 v_lightDir;\nvarying vec3 v_eyeVec;\nvarying vec3 v_normal;\n// varying vec3 v_lightDirWorld;\n\n#if defined(ONLY_TANGENTS)\nvarying vec3 v_tangent;\n#endif\n\n${Tm}\n${Tg}\n\nvec3 TBN(vec3 vector, vec3 tangent, vec3 binormal, vec3 normal) {\n  return vec3(dot(vector, tangent), dot(vector, binormal), dot(vector, normal));\n}\n\nvoid main() {\n  vec3 position = a_position;\n  vec3 normal = a_normal;\n  vec3 tangent = a_tangent.xyz;\n\n  // Re-orthogonalize the tangent in case it wasnt normalized.\n  // See "One last thing" at https://learnopengl.com/Advanced-Lighting/Normal-Mapping\n  tangent = normalize(tangent - dot(tangent, normal) * normal);\n\n  vec3 binormal = cross(normal, tangent) * a_tangent.w;\n\n  if (u_hasBones) {\n    #ifdef SKIN\n      transformSkin(position, normal, tangent, binormal);\n    #else\n      transformVertexGroupsHD(position, normal, tangent, binormal);\n    #endif\n  }\n\n  vec3 position_mv = vec3(u_MV * vec4(position, 1));\n\n  mat3 mv = mat3(u_MV);\n  vec3 t = normalize(mv * tangent);\n  vec3 b = normalize(mv * binormal);\n  vec3 n = normalize(mv * normal);\n\n  v_eyeVec = normalize(u_eyePos - position_mv);\n\n  vec3 lightDir = normalize(u_lightPos - position_mv);\n  v_lightDir = normalize(TBN(lightDir, t, b, n));\n  \n  v_uv = a_uv;\n  v_layerAlpha = u_layerAlpha;\n\n  v_normal = normal;\n  // v_lightDirWorld = normalize(lightDir);\n\n  #if defined(ONLY_TANGENTS)\n  v_tangent = tangent;\n  #endif\n\n  gl_Position = u_VP * vec4(position, 1.0);\n}\n`,Mg=`\n${Em}\n\nuniform sampler2D u_diffuseMap;\nuniform sampler2D u_normalsMap;\nuniform sampler2D u_ormMap;\nuniform sampler2D u_emissiveMap;\nuniform sampler2D u_teamColorMap;\nuniform sampler2D u_environmentMap;\nuniform float u_filterMode;\n\n// uniform sampler2D u_lutMap;\n// uniform sampler2D u_envDiffuseMap;\n// uniform sampler2D u_envSpecularMap;\n\nvarying vec2 v_uv;\nvarying float v_layerAlpha;\nvarying vec3 v_lightDir;\nvarying vec3 v_eyeVec;\nvarying vec3 v_normal;\n// varying vec3 v_lightDirWorld;\n\n#if defined(ONLY_TANGENTS)\nvarying vec3 v_tangent;\n#endif\n\nvec3 decodeNormal() {\n  vec2 xy = texture2D(u_normalsMap, v_uv).xy * 2.0 - 1.0;\n  \n  return vec3(xy, sqrt(1.0 - dot(xy, xy)));\n}\n\nconst vec2 invAtan = vec2(0.1591, 0.3183);\nvec2 sampleEnvironmentMap(vec3 normal) {\n  vec2 uv = vec2(atan(normal.x, normal.y), -asin(normal.z));\n  uv *= invAtan;\n  uv += 0.5;\n  return uv;\n}\n\nvec4 getDiffuseColor() {\n  vec4 color = texture2D(u_diffuseMap, v_uv);\n\n  // 1bit Alpha\n  if (u_filterMode == 1.0 && color.a < 0.75) {\n    discard;\n  }\n\n  return color;\n}\n\nvec4 getOrmColor() {\n  return texture2D(u_ormMap, v_uv);\n}\n\nvec3 getEmissiveColor() {\n  return texture2D(u_emissiveMap, v_uv).rgb;\n}\n\nvec3 getTeamColor() {\n  return texture2D(u_teamColorMap, v_uv).rgb;\n}\n\n// const float PI = 3.14159265359;\n// const float RECIPROCAL_PI = 0.31830988618;\n// const float RECIPROCAL_PI2 = 0.15915494;\n// const float LN2 = 0.6931472;\n// const float ENV_LODS = 6.0;\n// vec4 SRGBtoLinear(vec4 srgb) {\n//     vec3 linOut = pow(srgb.xyz, vec3(2.2));\n//     return vec4(linOut, srgb.w);;\n// }\n// vec4 RGBMToLinear(in vec4 value) {\n//     float maxRange = 6.0;\n//     return vec4(value.xyz * value.w * maxRange, 1.0);\n// }\n// vec3 linearToSRGB(vec3 color) {\n//     return pow(color, vec3(1.0 / 2.2));\n// }\n// // vec3 getNormal() {\n// //     vec3 pos_dx = dFdx(vMPos.xyz);\n// //     vec3 pos_dy = dFdy(vMPos.xyz);\n// //     vec2 tex_dx = dFdx(vUv);\n// //     vec2 tex_dy = dFdy(vUv);\n// //     vec3 t = normalize(pos_dx * tex_dy.t - pos_dy * tex_dx.t);\n// //     vec3 b = normalize(-pos_dx * tex_dy.s + pos_dy * tex_dx.s);\n// //     mat3 tbn = mat3(t, b, normalize(vNormal));\n// //     vec3 n = texture2D(tNormal, vUv * uNormalUVScale).rgb * 2.0 - 1.0;\n// //     n.xy *= uNormalScale;\n// //     vec3 normal = normalize(tbn * n);\n// //     // Get world normal from view normal (normalMatrix * normal)\n// //     return normalize((vec4(normal, 0.0) * viewMatrix).xyz);\n// // }\n// vec3 specularReflection(vec3 specularEnvR0, vec3 specularEnvR90, float VdH) {\n//     return specularEnvR0 + (specularEnvR90 - specularEnvR0) * pow(clamp(1.0 - VdH, 0.0, 1.0), 5.0);\n// }\n// float geometricOcclusion(float NdL, float NdV, float roughness) {\n//     float r = roughness;\n//     float attenuationL = 2.0 * NdL / (NdL + sqrt(r * r + (1.0 - r * r) * (NdL * NdL)));\n//     float attenuationV = 2.0 * NdV / (NdV + sqrt(r * r + (1.0 - r * r) * (NdV * NdV)));\n//     return attenuationL * attenuationV;\n// }\n// float microfacetDistribution(float roughness, float NdH) {\n//     float roughnessSq = roughness * roughness;\n//     float f = (NdH * roughnessSq - NdH) * NdH + 1.0;\n//     return roughnessSq / (PI * f * f);\n// }\n// vec2 cartesianToPolar(vec3 n) {\n//     vec2 uv;\n//     uv.x = atan(n.z, n.x) * RECIPROCAL_PI2 + 0.5;\n//     uv.y = asin(n.y) * RECIPROCAL_PI + 0.5;\n//     return uv;\n// }\n// void getIBLContribution(inout vec3 diffuse, inout vec3 specular, float NdV, float roughness, vec3 n, vec3 reflection, vec3 diffuseColor, vec3 specularColor) {\n//   vec3 brdf = SRGBtoLinear(texture2D(u_lutMap, vec2(NdV, roughness))).rgb;\n//   vec3 diffuseLight = RGBMToLinear(texture2D(u_envDiffuseMap, sampleEnvironmentMap(n))).rgb;\n//   // Sample 2 levels and mix between to get smoother degradation\n//   float blend = roughness * ENV_LODS;\n//   float level0 = floor(blend);\n//   float level1 = min(ENV_LODS, level0 + 1.0);\n//   blend -= level0;\n  \n//   // Sample the specular env map atlas depending on the roughness value\n//   vec2 uvSpec = sampleEnvironmentMap(reflection);\n//   uvSpec.y /= 2.0;\n//   vec2 uv0 = uvSpec;\n//   vec2 uv1 = uvSpec;\n//   uv0 /= pow(2.0, level0);\n//   uv0.y += 1.0 - exp(-LN2 * level0);\n//   uv1 /= pow(2.0, level1);\n//   uv1.y += 1.0 - exp(-LN2 * level1);\n//   vec3 specular0 = RGBMToLinear(texture2D(u_envSpecularMap, uv0)).rgb;\n//   vec3 specular1 = RGBMToLinear(texture2D(u_envSpecularMap, uv1)).rgb;\n//   vec3 specularLight = mix(specular0, specular1, blend);\n//   diffuse = diffuseLight * diffuseColor;\n  \n//   // Bit of extra reflection for smooth materials\n//   float reflectivity = pow((1.0 - roughness), 2.0) * 0.05;\n//   specular = specularLight * (specularColor * brdf.x + brdf.y + reflectivity);\n//   // specular *= uEnvSpecular;\n// }\n\n// void PBR() {\n//   vec4 baseDiffuseColor = getDiffuseColor();\n//   vec3 baseColor = baseDiffuseColor.rgb;\n//   vec4 orm = getOrmColor();\n//   vec3 tc = getTeamColor();\n//   float tcFactor = getOrmColor().a;\n\n//   if (tcFactor > 0.1) {\n//     baseColor *= tc * tcFactor;\n//   }\n\n//   float roughness = clamp(orm.g, 0.04, 1.0);\n//   float metallic = clamp(orm.b, 0.04, 1.0);\n\n//   vec3 f0 = vec3(0.04);\n//   vec3 diffuseColor = baseColor * (vec3(1.0) - f0) * (1.0 - metallic);\n//   vec3 specularColor = mix(f0, baseColor, metallic);\n//   vec3 specularEnvR0 = specularColor;\n//   vec3 specularEnvR90 = vec3(clamp(max(max(specularColor.r, specularColor.g), specularColor.b) * 25.0, 0.0, 1.0));\n\n//   vec3 N = v_normal;\n//   vec3 V = normalize(v_eyeVec);\n//   vec3 L = normalize(v_lightDirWorld);\n//   vec3 H = normalize(L + V);\n//   vec3 reflection = normalize(reflect(-V, N));\n\n//   float NdL = clamp(dot(N, L), 0.001, 1.0);\n//   float NdV = clamp(abs(dot(N, V)), 0.001, 1.0);\n//   float NdH = clamp(dot(N, H), 0.0, 1.0);\n//   float LdH = clamp(dot(L, H), 0.0, 1.0);\n//   float VdH = clamp(dot(V, H), 0.0, 1.0);\n\n//   vec3 F = specularReflection(specularEnvR0, specularEnvR90, VdH);\n//   float G = geometricOcclusion(NdL, NdV, roughness);\n//   float D = microfacetDistribution(roughness, NdH);\n\n//   vec3 diffuseContrib = (1.0 - F) * (diffuseColor / PI);\n//   vec3 specContrib = F * G * D / (4.0 * NdL * NdV);\n  \n//   // Shading based off lights\n//   // vec3 color = NdL * uLightColor * (diffuseContrib + specContrib);\n//   vec3 color = NdL * (diffuseContrib + specContrib);\n\n//   // Calculate IBL lighting\n//   vec3 diffuseIBL;\n//   vec3 specularIBL;\n//   getIBLContribution(diffuseIBL, specularIBL, NdV, roughness, N, reflection, diffuseColor, specularColor);\n\n//   // Add IBL on top of color\n//   color +=  specularIBL;\n\n//   color *= orm.r;\n\n//   color += getEmissiveColor();\n\n//   // Convert to sRGB to display\n//   gl_FragColor.rgb = color;\n//   gl_FragColor.a = baseDiffuseColor.a;\n// }\n\nvoid onlyDiffuse() {\n  vec4 baseColor = getDiffuseColor();\n  vec3 tc = getTeamColor();\n  float tcFactor = getOrmColor().a;\n\n  if (tcFactor > 0.1) {\n    baseColor.rgb *= tc * tcFactor;\n  }\n\n  gl_FragColor = baseColor;\n}\n\nvoid onlyNormalMap() {\n  gl_FragColor = vec4(decodeNormal(), 1.0);\n}\n\nvoid onlyOcclusion() {\n  gl_FragColor = vec4(getOrmColor().rrr, 1.0);\n}\n\nvoid onlyRoughness() {\n  gl_FragColor = vec4(getOrmColor().ggg, 1.0);\n}\n\nvoid onlyMetallic() {\n  gl_FragColor = vec4(getOrmColor().bbb, 1.0);\n}\n\nvoid onlyTeamColorFactor() {\n  gl_FragColor = vec4(getOrmColor().aaa, 1.0);\n}\n\nvoid onlyEmissiveMap() {\n  gl_FragColor = vec4(getEmissiveColor(), 1.0);\n}\n\nvoid onlyTexCoords() {\n  gl_FragColor = vec4(v_uv, 0.0, 1.0);\n}\n\nvoid onlyNormals() {\n  gl_FragColor = vec4(v_normal, 1.0);\n}\n\n#if defined(ONLY_TANGENTS)\nvoid onlyTangents() {\n  gl_FragColor = vec4(v_tangent, 1.0);\n}\n#endif\n\nvoid lambert() {\n  vec4 baseColor = getDiffuseColor();\n  vec3 normal = decodeNormal();\n  vec4 orm = getOrmColor();\n  vec3 emissive = getEmissiveColor();\n  vec3 tc = getTeamColor();\n  float aoFactor = orm.r;\n  float tcFactor = orm.a;\n  float lambertFactor = clamp(dot(normal, v_lightDir), 0.0, 1.0);\n  vec3 color = baseColor.rgb;\n\n  if (tcFactor > 0.1) {\n    color *= tc * tcFactor;\n  }\n  \n  color *= clamp(lambertFactor * aoFactor + 0.1, 0.0, 1.0);\n  color += emissive;\n\n  gl_FragColor = vec4(color, baseColor.a);\n}\n\nvoid main() {\n  #if defined(ONLY_DIFFUSE)\n  onlyDiffuse();\n  #elif defined(ONLY_NORMAL_MAP)\n  onlyNormalMap();\n  #elif defined(ONLY_OCCLUSION)\n  onlyOcclusion();\n  #elif defined(ONLY_ROUGHNESS)\n  onlyRoughness();\n  #elif defined(ONLY_METALLIC)\n  onlyMetallic();\n  #elif defined(ONLY_TC_FACTOR)\n  onlyTeamColorFactor();\n  #elif defined(ONLY_EMISSIVE)\n  onlyEmissiveMap();\n  #elif defined(ONLY_TEXCOORDS)\n  onlyTexCoords();\n  #elif defined(ONLY_NORMALS)\n  onlyNormals();\n  #elif defined(ONLY_TANGENTS)\n  onlyTangents();\n  #else\n  lambert();\n  #endif\n}\n`,kg=`\n${Em}\n\n#define EMITTER_PARTICLE2 0\n#define EMITTER_RIBBON 1\n\nuniform sampler2D u_texture;\nuniform highp int u_emitter;\nuniform float u_filterMode;\n\nvarying vec2 v_texcoord;\nvarying vec4 v_color;\n\nvoid main() {\n  vec4 texel = texture2D(u_texture, v_texcoord);\n  vec4 color = texel * v_color;\n\n  // 1bit Alpha, used by ribbon emitters.\n  if (u_emitter == EMITTER_RIBBON && u_filterMode == 1.0 && color.a < 0.75) {\n    discard;\n  }\n\n  // "Close to 0 alpha"\n  if (u_emitter == EMITTER_PARTICLE2 && (u_filterMode == 2.0 || u_filterMode == 3.0) && color.a < 0.02) {\n    discard;\n  }\n\n  // Alpha key.\n  if (u_emitter == EMITTER_PARTICLE2 && (u_filterMode == 4.0) && color.a < 0.75) {\n    discard;\n  }\n\n  gl_FragColor = color;\n}\n`,Rg=t=>new Im(t),Ig=t=>async function(t){if(km)return km.decodeAudioData(t)}(t),Ug={load(t,e,n=!1){const i=t.gl,r=t.webgl;if(!r.ensureExtension("OES_texture_float"))throw new Error("MDX: No float texture support!");if(!r.ensureExtension("ANGLE_instanced_arrays"))throw new Error("MDX: No instanced rendering support!");const s="#define EXTENDED_BONES\n"+Lg,a="#define ONLY_DIFFUSE\n"+Eg,o="#define ONLY_TEXCOORDS\n"+Eg,l="#define ONLY_NORMALS\n"+Eg,h="#define EXTENDED_BONES\n"+Sg,u="#define SKIN\n"+Sg,c="#define ONLY_DIFFUSE\n"+Mg,d="#define ONLY_NORMAL_MAP\n"+Mg,f="#define ONLY_OCCLUSION\n"+Mg,p="#define ONLY_ROUGHNESS\n"+Mg,m="#define ONLY_METALLIC\n"+Mg,_="#define ONLY_TC_FACTOR\n"+Mg,g="#define ONLY_EMISSIVE\n"+Mg,v="#define ONLY_TEXCOORDS\n"+Mg,b="#define ONLY_NORMALS\n"+Mg,w="#define ONLY_TANGENTS\n"+Mg,A=r.createShader(Lg,Eg),y=r.createShader(s,Eg),x=r.createShader(Sg,Mg),T=r.createShader(h,Mg),L=r.createShader(u,Mg),E=r.createShader("\n#define EMITTER_PARTICLE2 0\n#define EMITTER_RIBBON 1\n#define EMITTER_SPLAT 2\n#define EMITTER_UBERSPLAT 3\n#define HEAD 0.0\n\nuniform mat4 u_VP;\nuniform int u_emitter;\n\n// Shared\nuniform vec4 u_colors[3];\nuniform vec3 u_vertices[4];\nuniform vec3 u_intervals[4];\nuniform float u_lifeSpan;\nuniform float u_columns;\nuniform float u_rows;\n\n// Particle2\nuniform vec3 u_scaling;\nuniform vec3 u_cameraZ;\nuniform float u_timeMiddle;\nuniform bool u_teamColored;\n\n// Splat and Uber.\nuniform vec3 u_intervalTimes;\n\n// Vertices\nattribute float a_position;\n\n// Instances\nattribute vec3 a_p0;\nattribute vec3 a_p1;\nattribute vec3 a_p2;\nattribute vec3 a_p3;\nattribute float a_health;\nattribute vec4 a_color;\nattribute float a_tail;\nattribute vec3 a_leftRightTop;\n\nvarying vec2 v_texcoord;\nvarying vec4 v_color;\n\nfloat getCell(vec3 interval, float factor) {\n  float start = interval[0];\n  float end = interval[1];\n  float repeat = interval[2];\n  float spriteCount = end - start;\n\n  if (spriteCount > 0.0) {\n    // Repeating speeds up the sprite animation, which makes it effectively run N times in its interval.\n    // E.g. if repeat is 4, the sprite animation will be seen 4 times, and thus also run 4 times as fast.\n    // The sprite index is limited to the number of actual sprites.\n    return min(start + mod(floor(spriteCount * repeat * factor), spriteCount), u_columns * u_rows - 1.0);\n  }\n\n  return start;\n}\n\nvoid particle2() {\n  float factor = (u_lifeSpan - a_health) / u_lifeSpan;\n  int index = 0;\n\n  if (factor < u_timeMiddle) {\n    factor = factor / u_timeMiddle;\n    index = 0;\n  } else {\n    factor = (factor - u_timeMiddle) / (1.0 - u_timeMiddle);\n    index = 1;\n  }\n\n  factor = min(factor, 1.0);\n\n  float scale = mix(u_scaling[index], u_scaling[index + 1], factor);\n  vec4 color = mix(u_colors[index], u_colors[index + 1], factor);\n\n  float cell = 0.0;\n\n  if (u_teamColored) {\n    cell = a_leftRightTop[0];\n  } else {\n    vec3 interval;\n\n    if (a_tail == HEAD) {\n      interval = u_intervals[index];\n    } else {\n      interval = u_intervals[index + 2];\n    }\n\n    cell = getCell(interval, factor);\n  }\n\n  float left = floor(mod(cell, u_columns));\n  float top = floor(cell / u_columns);\n  float right = left + 1.0;\n  float bottom = top + 1.0;\n\n  left /= u_columns;\n  right /= u_columns;\n  top /= u_rows;\n  bottom /= u_rows;\n\n  if (a_position == 0.0) {\n    v_texcoord = vec2(right, top);\n  } else if (a_position == 1.0) {\n    v_texcoord = vec2(left, top);\n  } else if (a_position == 2.0) {\n    v_texcoord = vec2(left, bottom);\n  } else if (a_position == 3.0) {\n    v_texcoord = vec2(right, bottom);\n  }\n\n  v_color = color;\n  \n  if (a_tail == HEAD) {\n    vec3 v = u_vertices[int(a_position)];\n    float cs = cos(a_p1.x);\n    float sn = sin(a_p1.x);\n\n    float x = v.x * cs - v.y * sn;\n    float y = v.x * sn + v.y * cs;\n\n    vec3 fv = vec3(\n      v.x * cs - v.y * sn,\n      v.x * sn + v.y * cs,\n      v.z);\n\n    gl_Position = u_VP * vec4(a_p0 + fv * scale, 1.0);\n  } else {\n    // Get the normal to the tail in camera space.\n    // This allows to build a 2D rectangle around the 3D tail.\n    vec3 normal = cross(u_cameraZ, normalize(a_p1 - a_p0));\n    vec3 boundary = normal * scale * a_p2[0];\n    vec3 position;\n\n    if (a_position == 0.0) {\n      position = a_p0 - boundary;\n    } else if (a_position == 1.0) {\n      position = a_p1 - boundary;\n    } else if (a_position == 2.0) {\n      position = a_p1 + boundary;\n    } else if (a_position == 3.0) {\n      position = a_p0 + boundary;\n    }\n\n    gl_Position = u_VP * vec4(position, 1.0);\n  }\n}\n\nvoid ribbon() {\n  vec3 position;\n  float left = a_leftRightTop[0] / 255.0;\n  float right = a_leftRightTop[1] / 255.0;\n  float top = a_leftRightTop[2] / 255.0;\n  float bottom = top + 1.0;\n\n  if (a_position == 0.0) {\n    v_texcoord = vec2(right, top);\n    position = a_p0;\n  } else if (a_position == 1.0) {\n    v_texcoord = vec2(right, bottom);\n    position = a_p1;\n  } else if (a_position == 2.0) {\n    v_texcoord = vec2(left, bottom);\n    position = a_p2;\n  } else if (a_position == 3.0) {\n    v_texcoord = vec2(left, top);\n    position = a_p3;\n  }\n\n  v_texcoord[0] /= u_columns;\n  v_texcoord[1] /= u_rows;\n\n  v_color = a_color;\n\n  gl_Position = u_VP * vec4(position, 1.0);\n}\n\nvoid splat() {\n  float factor = u_lifeSpan - a_health;\n  int index;\n\n  if (factor < u_intervalTimes[0]) {\n    factor = factor / u_intervalTimes[0];\n    index = 0;\n  } else {\n    factor = (factor - u_intervalTimes[0]) / u_intervalTimes[1];\n    index = 1;\n  }\n\n  float cell = getCell(u_intervals[index], factor);\n  float left = floor(mod(cell, u_columns));\n  float top = floor(cell / u_columns);\n  float right = left + 1.0;\n  float bottom = top + 1.0;\n  vec3 position;\n\n  if (a_position == 0.0) {\n    v_texcoord = vec2(left, top);\n    position = a_p0;\n  } else if (a_position == 1.0) {\n    v_texcoord = vec2(left, bottom);\n    position = a_p1;\n  } else if (a_position == 2.0) {\n    v_texcoord = vec2(right, bottom);\n    position = a_p2;\n  } else if (a_position == 3.0) {\n    v_texcoord = vec2(right, top);\n    position = a_p3;\n  }\n\n  v_texcoord[0] /= u_columns;\n  v_texcoord[1] /= u_rows;\n\n  v_color = mix(u_colors[index], u_colors[index + 1], factor) / 255.0;\n\n  gl_Position = u_VP * vec4(position, 1.0);\n}\n\nvoid ubersplat() {\n  float factor = u_lifeSpan - a_health;\n  vec4 color;\n\n  if (factor < u_intervalTimes[0]) {\n    color = mix(u_colors[0], u_colors[1], factor / u_intervalTimes[0]);\n  } else if (factor < u_intervalTimes[0] + u_intervalTimes[1]) {\n    color = u_colors[1];\n  } else {\n    color = mix(u_colors[1], u_colors[2], (factor - u_intervalTimes[0] - u_intervalTimes[1]) / u_intervalTimes[2]);\n  }\n\n  vec3 position;\n\n  if (a_position == 0.0) {\n    v_texcoord = vec2(0.0, 0.0);\n    position = a_p0;\n  } else if (a_position == 1.0) {\n    v_texcoord = vec2(0.0, 1.0);\n    position = a_p1;\n  } else if (a_position == 2.0) {\n    v_texcoord = vec2(1.0, 1.0);\n    position = a_p2;\n  } else if (a_position == 3.0) {\n    v_texcoord = vec2(1.0, 0.0);\n    position = a_p3;\n  }\n\n  v_color = color / 255.0;\n\n  gl_Position = u_VP * vec4(position, 1.0);\n}\n\nvoid main() {\n  if (u_emitter == EMITTER_PARTICLE2) {\n    particle2();\n  } else if (u_emitter == EMITTER_RIBBON) {\n    ribbon();\n  } else if (u_emitter == EMITTER_SPLAT) {\n    splat();\n  } else if (u_emitter == EMITTER_UBERSPLAT) {\n    ubersplat();\n  }\n}\n",kg),S=[],M=[];let k=[];k[Np.Diffuse]=r.createShader(Lg,a),k[Np.TexCoords]=r.createShader(Lg,o),k[Np.Normals]=r.createShader(Lg,l),S[w_.VertexGroups]=k,k=[],k[Np.Diffuse]=r.createShader(s,a),k[Np.TexCoords]=r.createShader(s,o),k[Np.Normals]=r.createShader(s,l),S[w_.ExtendedVertexGroups]=k,k=[],k[Np.Diffuse]=r.createShader(Sg,c),k[Np.NormalMap]=r.createShader(Sg,d),k[Np.Occlusion]=r.createShader(Sg,f),k[Np.Roughness]=r.createShader(Sg,p),k[Np.Metallic]=r.createShader(Sg,m),k[Np.TCFactor]=r.createShader(Sg,_),k[Np.Emissive]=r.createShader(Sg,g),k[Np.TexCoords]=r.createShader(Sg,v),k[Np.Normals]=r.createShader(Sg,b),k[Np.Tangents]=r.createShader("#define ONLY_TANGENTS\n"+Sg,w),M[w_.VertexGroups]=k,k=[],k[Np.Diffuse]=r.createShader(h,c),k[Np.NormalMap]=r.createShader(h,d),k[Np.Occlusion]=r.createShader(h,f),k[Np.Roughness]=r.createShader(h,p),k[Np.Metallic]=r.createShader(h,m),k[Np.TCFactor]=r.createShader(h,_),k[Np.Emissive]=r.createShader(h,g),k[Np.TexCoords]=r.createShader(h,v),k[Np.Normals]=r.createShader(h,b),k[Np.Tangents]=r.createShader("#define ONLY_TANGENTS\n"+h,w),M[w_.ExtendedVertexGroups]=k,k=[],k[Np.Diffuse]=r.createShader(u,c),k[Np.NormalMap]=r.createShader(u,d),k[Np.Occlusion]=r.createShader(u,f),k[Np.Roughness]=r.createShader(u,p),k[Np.Metallic]=r.createShader(u,m),k[Np.TCFactor]=r.createShader(u,_),k[Np.Emissive]=r.createShader(u,g),k[Np.TexCoords]=r.createShader(u,v),k[Np.Normals]=r.createShader(u,b),k[Np.Tangents]=r.createShader("#define ONLY_TANGENTS\n"+u,w),M[w_.Skin]=k;const R=i.createBuffer();i.bindBuffer(i.ARRAY_BUFFER,R),i.bufferData(i.ARRAY_BUFFER,new Uint8Array([0,1,2,0,2,3]),i.STATIC_DRAW);const I={pathSolver:e,reforged:n,sdShader:A,sdExtendedShader:y,hdShader:x,hdExtendedShader:T,hdSkinShader:L,particlesShader:E,sdDebugShaders:S,hdDebugShaders:M,rectBuffer:R,teamColors:[],teamGlows:[],eventObjectTables:{}};t.sharedCache.set("mdx",I)},isValidSource:t=>t instanceof Ml||(El(t)||Sl(t)),resource:class extends zp{constructor(t,e){let n;if(super(e),this.reforged=!1,this.hd=!1,this.solverParams={},this.name="",this.sequences=[],this.globalSequences=[],this.materials=[],this.layers=[],this.textures=[],this.textureAnimations=[],this.geosets=[],this.geosetAnimations=[],this.bones=[],this.lights=[],this.helpers=[],this.attachments=[],this.pivotPoints=[],this.particleEmitters=[],this.particleEmitters2=[],this.ribbonEmitters=[],this.cameras=[],this.eventObjects=[],this.collisionShapes=[],this.hasLayerAnims=!1,this.hasGeosetAnims=!1,this.batches=[],this.genericObjects=[],this.sortedGenericObjects=[],this.hierarchy=[],this.opaqueGroups=[],this.translucentGroups=[],this.arrayBuffer=null,this.elementBuffer=null,this.skinDataType=0,this.bytesPerSkinElement=1,t instanceof Ml)n=t;else{n=new Ml;try{n.load(t)}catch(t){}}const i=this.viewer,r=this.pathSolver,s=this.solverParams,a=n.version>800,o=a?".dds":".blp";let l=!1;this.reforged=a,this.name=n.name;const h=n.extent;this.bounds.fromExtents(h.min,h.max);for(const t of n.sequences)this.sequences.push(new Um(t));for(const t of n.globalSequences)this.globalSequences.push(t);for(const t of n.textureAnimations)this.textureAnimations.push(new $m(this,t));let u=0;for(const t of n.materials){const e=[];for(const n of t.layers){const i=new Zm(this,n,u++,t.priorityPlane);e.push(i),this.layers.push(i)}this.materials.push(new Jm(this,t.shader,e)),""!==t.shader&&(this.hd=!0)}a&&(s.reforged=!0),this.hd&&(s.hd=!0);const c=n.textures;for(let t=0,e=c.length;t<e;t++){const e=c[t];let n=e.path;const a=e.replaceableId,h=e.wrapMode;""===n&&0!==a&&(n=`ReplaceableTextures\\${t_[a]}${o}`,1!==a&&2!==a||(l=!0));const u=new p_(a,h);i.load(n,r,s).then((t=>{t&&(u.texture=t)})),this.textures[t]=u}for(const t of n.geosetAnimations)this.geosetAnimations.push(new Qm(this,t));this.pivotPoints=n.pivotPoints;let d=0;for(const t of n.bones)this.bones.push(new n_(this,t,d++));for(const t of n.lights)this.lights.push(new i_(this,t,d++));for(const t of n.helpers)this.helpers.push(new r_(this,t,d++));for(const t of n.attachments)this.attachments.push(new s_(this,t,d++));for(const t of n.particleEmitters)this.particleEmitters.push(new a_(this,t,d++));for(const t of n.particleEmitters2){const e=new m_(this,t,d++);this.particleEmitters2.push(e),e.teamColored&&(l=!0)}for(const t of n.ribbonEmitters)this.ribbonEmitters.push(new __(this,t,d++));for(const t of n.cameras)this.cameras.push(new g_(this,t));for(const t of n.eventObjects)this.eventObjects.push(new v_(this,t,d++));for(const t of n.collisionShapes)this.collisionShapes.push(new b_(this,t,d++));this.genericObjects.push(...this.bones,...this.lights,...this.helpers,...this.attachments,...this.particleEmitters,...this.particleEmitters2,...this.ribbonEmitters,...this.eventObjects,...this.collisionShapes),function(t,e){if(e.length>0){const n=t.viewer.gl;let i=0,r=0,s=0,a=0,o=0,l=0;const h=[];for(let t=0,n=e.length;t<n;t++){const n=e[t];if(0===n.lod||-1===n.lod){const e=n.vertices.length/3;if(i+=12*e,r+=12*e,s+=n.uvSets.length*e*8,n.tangents.length&&(a+=16*e),n.skin.length)o+=8*e,h[t]=w_.Skin;else{let i=0;for(const t of n.matrixGroups)t>i&&(i=t);i>4?(o+=9*e,h[t]=w_.ExtendedVertexGroups):(o+=5*e,h[t]=w_.VertexGroups)}l+=n.faces.byteLength}}let u=0,c=u+i,d=c+r,f=d+s,p=f+a,m=0,_=Uint8Array,g=n.UNSIGNED_BYTE;t.bones.length>255&&(o*=2,_=Uint16Array,g=n.UNSIGNED_SHORT),t.skinDataType=g,t.bytesPerSkinElement=_.BYTES_PER_ELEMENT,t.arrayBuffer=n.createBuffer(),n.bindBuffer(n.ARRAY_BUFFER,t.arrayBuffer),n.bufferData(n.ARRAY_BUFFER,p+o,n.STATIC_DRAW),t.elementBuffer=n.createBuffer(),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t.elementBuffer),n.bufferData(n.ELEMENT_ARRAY_BUFFER,l,n.STATIC_DRAW);for(let i=0,r=e.length;i<r;i++){const r=e[i];if(0===r.lod||-1===r.lod){const e=r.vertices,s=r.normals,a=r.uvSets,o=r.tangents,l=r.faces;let g;const v=r.vertices.length/3,b=h[i];if(b===w_.Skin)g=r.skin;else{const t=r.matrixIndices,e=r.vertexGroups,n=[];let i=0,s=4;b===w_.ExtendedVertexGroups&&(s=8),g=new _(v*(s+1));for(const e of r.matrixGroups)n.push(t.subarray(i,i+e)),i+=e;for(let t=0;t<v;t++){const r=n[e[t]];if(i=t*(s+1),r){const t=Math.min(r.length,s);for(let e=0;e<t;e++)g[i+e]=r[e]+1;g[i+s]=t}}}const w=new y_(t,t.geosets.length,u,c,d,f,p,m,v,l.length,r.faceTypeGroups[0]);t.geosets.push(w);const A=t.materials[r.materialId];if("Shader_HD_DefaultUnit"===A.shader)t.batches.push(new A_(t.batches.length,w,A,b,!0));else for(const e of A.layers)t.batches.push(new A_(t.batches.length,w,e,b,!1));n.bufferSubData(n.ARRAY_BUFFER,u,e),u+=e.byteLength,n.bufferSubData(n.ARRAY_BUFFER,c,s),c+=s.byteLength;for(const t of a)n.bufferSubData(n.ARRAY_BUFFER,d,t),d+=t.byteLength;o.length&&(n.bufferSubData(n.ARRAY_BUFFER,f,o),f+=o.byteLength),n.bufferSubData(n.ARRAY_BUFFER,p,g),p+=g.byteLength,n.bufferSubData(n.ELEMENT_ARRAY_BUFFER,m,l),m+=l.byteLength}}}}(this,n.geosets),function(t){const e=[];let n=[];for(const i of t.batches)i.layer.filterMode<2?e.push(i):n.push(i);const i=t.opaqueGroups,r=t.translucentGroups;let s=null;for(const n of e)s&&E_(s,n)||(s=S_(t,n),i.push(s)),s.objects.push(n.index);n=n.sort(((t,e)=>t.layer.filterMode-e.layer.filterMode));const a=[...n,...t.eventObjects,...t.particleEmitters2,...t.ribbonEmitters].sort(((t,e)=>L_(t)-L_(e)));s=null;for(const e of a)(e instanceof A_||-1!==e.geometryEmitterType)&&(s&&E_(s,e)||(s=S_(t,e),r.push(s)),s.objects.push(e.index))}(this),this.setupHierarchy(-1);for(let t=0,e=this.genericObjects.length;t<e;t++)this.sortedGenericObjects[t]=this.genericObjects[this.hierarchy[t]];l&&Ug.loadTeamTextures(i)}addInstance(){return new xg(this)}setupHierarchy(t){for(let e=0,n=this.genericObjects.length;e<n;e++){const n=this.genericObjects[e];n.parentId===t&&(this.hierarchy.push(e),this.setupHierarchy(n.objectId))}}},loadTeamTextures(t){const{pathSolver:e,reforged:n,teamColors:i,teamGlows:r}=t.sharedCache.get("mdx");if(0===i.length){const s=n?28:16,a=n?"dds":"blp",o=n?{reforged:!0}:void 0;for(let n=0;n<s;n++){const s=`${`${n}`.padStart(2,"0")}.${a}`,l=new p_(1,3),h=new p_(2,3);t.load(`ReplaceableTextures\\TeamColor\\TeamColor${s}`,e,o).then((t=>l.texture=t)),t.load(`ReplaceableTextures\\TeamGlow\\TeamGlow${s}`,e,o).then((t=>h.texture=t)),i[n]=l,r[n]=h}}},getEventObjectSoundFile(t,e,n,i){if(!e||".flac"===yo(t))return t;for(let e=1,r=i.length;e<r;e++){const r=i[e].data.getRow(t);if(r){const t=r.string("Flags"),e=r.string("Filepath");if("SD_ONLY"===t){if(!n)return e}else{if("HD_ONLY"!==t)return e;if(n)return e}}}},async getEventObjectData(t,e,n,i){if("SPN"!==e&&"SPL"!==e&&"UBR"!==e&&"SND"!==e)return;const{pathSolver:r,reforged:s,eventObjectTables:a}=t.sharedCache.get("mdx"),o=s?{reforged:!0}:{},l=async(t,e)=>r?r(t,e):t;if(!a[e]){const n=[];"SPN"===e?n.push("Splats\\SpawnData.slk"):"SPL"===e?n.push("Splats\\SplatData.slk"):"UBR"===e?n.push("Splats\\UberSplatData.slk"):"SND"===e&&(n.push("UI\\SoundInfo\\AnimSounds.slk"),s?n.push("UI\\SoundInfo\\DialogueHumanBase.slk","UI\\SoundInfo\\DialogueOrcBase.slk","UI\\SoundInfo\\DialogueUndeadBase.slk","UI\\SoundInfo\\DialogueNightElfBase.slk","UI\\SoundInfo\\DialogueNagaBase.slk","UI\\SoundInfo\\DialogueDemonBase.slk","UI\\SoundInfo\\DialogueCreepsBase.slk"):n.push("UI\\SoundInfo\\AnimLookups.slk"));const i=n.map((async e=>t.loadGeneric(await l(e,o),"text",Rg))),r=await Promise.all(i);for(const t of r)if(!t)return;a[e]=r}const h=a[e],u=h[0].data;let c;const d=[];if("SND"===e){if(s)c=u.findRow("AnimationEventCode",n);else{const t=h[1].data.getRow(n);t&&(c=u.getRow(t.string("SoundLabel")))}if(c)for(const e of c.string("FileNames").split(",")){const n=this.getEventObjectSoundFile(e,s,i,h);n&&d.push(t.loadGeneric(await l(n,o),"arrayBuffer",Ig))}}else c=u.getRow(n),c&&("SPN"===e?d.push(t.load(c.string("Model").replace(".mdl",".mdx"),l,o)):"SPL"!==e&&"UBR"!==e||d.push(t.load(`ReplaceableTextures\\Splats\\${c.string("file")}${s?".dds":".blp"}`,l,o)));if(c&&d.length){const t=(await Promise.all(d)).filter((t=>t));if(t.length)return{row:c,resources:t}}},getBatchShader(t,e,n){const i=t.sharedCache.get("mdx"),r=t.debugRenderMode;if(n){if(r!==Np.None){const t=i.hdDebugShaders[e];if(t){const e=t[r];if(e)return e}}return e===w_.Skin?i.hdSkinShader:e===w_.VertexGroups?i.hdShader:i.hdExtendedShader}if(r!==Np.None){const t=i.sdDebugShaders[e];if(t){const e=t[r];if(e)return e}}return e===w_.VertexGroups?i.sdShader:i.sdExtendedShader}};const Og={isValidSource:t=>t instanceof fp||pp(t),resource:class extends Bp{constructor(t,e){let n;super(e),t instanceof fp?n=t:(n=new fp,n.load(t));const i=n.width,r=n.height,s=this.viewer.gl,a=s.createTexture();s.bindTexture(s.TEXTURE_2D,a),s.texImage2D(s.TEXTURE_2D,0,s.RGBA,s.RGBA,s.UNSIGNED_BYTE,n.data),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.LINEAR),Sa(i)&&Sa(r)?(s.generateMipmap(s.TEXTURE_2D),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.LINEAR_MIPMAP_LINEAR)):s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.LINEAR),this.webglResource=a,this.width=i,this.height=r}}},Cg=`\n${Em}\n\nuniform sampler2D u_tilesets[15];\n\nvarying vec4 v_tilesets;\nvarying vec2 v_uv[4];\nvarying vec3 v_normal;\n\nconst vec3 lightDirection = normalize(vec3(-0.3, -0.3, 0.25));\n\nvec4 sample(float tileset, vec2 uv) {\n  // 1.0 - 1.0 == 0.0 is not always true.\n  int i = int(tileset - 0.6);\n\n  if (i == 0) {\n    return texture2D(u_tilesets[0], uv);\n  } else if (i == 1) {\n    return texture2D(u_tilesets[1], uv);\n  } else if (i == 2) {\n    return texture2D(u_tilesets[2], uv);\n  } else if (i == 3) {\n    return texture2D(u_tilesets[3], uv);\n  } else if (i == 4) {\n    return texture2D(u_tilesets[4], uv);\n  } else if (i == 5) {\n    return texture2D(u_tilesets[5], uv);\n  } else if (i == 6) {\n    return texture2D(u_tilesets[6], uv);\n  } else if (i == 7) {\n    return texture2D(u_tilesets[7], uv);\n  } else if (i == 8) {\n    return texture2D(u_tilesets[8], uv);\n  } else if (i == 9) {\n    return texture2D(u_tilesets[9], uv);\n  } else if (i == 10) {\n    return texture2D(u_tilesets[10], uv);\n  } else if (i == 11) {\n    return texture2D(u_tilesets[11], uv);\n  } else if (i == 12) {\n    return texture2D(u_tilesets[12], uv);\n  } else if (i == 13) {\n    return texture2D(u_tilesets[13], uv);\n  } else if (i == 14) {\n    return texture2D(u_tilesets[14], uv);\n  }\n}\n\nvec4 blend(vec4 color, float tileset, vec2 uv) {\n  vec4 texel = sample(tileset, uv);\n\n  return mix(color, texel, texel.a);\n}\n\nvoid main() {\n  vec4 color = sample(v_tilesets[0], v_uv[0]);\n\n  if (v_tilesets[1] > 0.5) {\n    color = blend(color, v_tilesets[1], v_uv[1]);\n  }\n\n  if (v_tilesets[2] > 0.5) {\n    color = blend(color, v_tilesets[2], v_uv[2]);\n  }\n\n  if (v_tilesets[3] > 0.5) {\n    color = blend(color, v_tilesets[3], v_uv[3]);\n  }\n\n  //color *= clamp(dot(v_normal, lightDirection) + 0.45, 0.0, 1.0);\n\n  gl_FragColor = vec4(color.rgb, 1.0);\n}\n`,Bg=`\n${Em}\n\nuniform sampler2D u_waterTexture;\n\nvarying vec2 v_uv;\nvarying vec4 v_color;\n\nvoid main() {\n  gl_FragColor = texture2D(u_waterTexture, v_uv) * v_color;\n}\n`,Pg=`\n// #extension GL_OES_standard_derivatives : enable\n\n${Em}\n\nuniform sampler2D u_texture1;\nuniform sampler2D u_texture2;\n\nvarying vec3 v_normal;\nvarying vec2 v_uv;\nvarying float v_texture;\nvarying vec3 v_position;\n\n// const vec3 lightDirection = normalize(vec3(-0.3, -0.3, 0.25));\n\nvec4 sample(float texture, vec2 uv) {\n  // int(0.0) == 0 is not always true.\n  int i = int(texture + 0.1);\n\n  if (i == 0) {\n    return texture2D(u_texture1, uv);\n  } else {\n    return texture2D(u_texture2, uv);\n  }\n}\n\nvoid main() {\n  vec4 color = sample(v_texture, v_uv);\n\n  // vec3 faceNormal = cross(dFdx(v_position), dFdy(v_position));\n  // vec3 normal = normalize((faceNormal + v_normal) * 0.5);\n\n  // color *= clamp(dot(normal, lightDirection) + 0.45, 0.1, 1.0);\n\n  gl_FragColor = color;\n}\n`;function Ng(t){return t.reverse().filter(((t,e,n)=>-1===n.indexOf(t,e+1))).reverse()}const Dg={AAAB:1,AAAC:1,AABA:1,AABB:2,AABC:0,AACA:1,AACB:0,AACC:1,ABAA:1,ABAB:1,ABAC:0,ABBA:2,ABBB:1,ABBC:0,ABCA:0,ABCB:0,ABCC:0,ACAA:1,ACAB:0,ACAC:1,ACBA:0,ACBB:0,ACBC:0,ACCA:1,ACCB:0,ACCC:1,BAAA:1,BAAB:1,BAAC:0,BABA:1,BABB:1,BABC:0,BACA:0,BACB:0,BACC:0,BBAA:1,BBAB:1,BBAC:0,BBBA:1,BBCA:0,BCAA:0,BCAB:0,BCAC:0,BCBA:0,BCCA:0,CAAA:1,CAAB:0,CAAC:1,CABA:0,CABB:0,CABC:0,CACA:1,CACB:0,CACC:1,CBAA:0,CBAB:0,CBAC:0,CBBA:0,CBCA:0,CCAA:1,CCAB:0,CCAC:1,CCBA:0,CCCA:1},Fg={AAAB:2,AAAC:1,AABA:1,AABB:3,AABC:0,AACA:1,AACB:0,AACC:3,ABAA:1,ABAB:2,ABAC:0,ABBA:3,ABBB:0,ABBC:0,ABCA:0,ABCB:0,ABCC:0,ACAA:1,ACAB:0,ACAC:2,ACBA:0,ACBB:0,ACBC:0,ACCA:3,ACCB:0,ACCC:1,BAAA:1,BAAB:3,BAAC:0,BABA:2,BABB:0,BABC:0,BACA:0,BACB:0,BACC:0,BBAA:3,BBAB:1,BBAC:0,BBBA:1,BBCA:0,BCAA:0,BCAB:0,BCAC:0,BCBA:0,BCCA:0,CAAA:1,CAAB:0,CAAC:3,CABA:0,CABB:0,CABC:0,CACA:2,CACB:0,CACC:1,CBAA:0,CBAB:0,CBAC:0,CBBA:0,CBCA:0,CCAA:3,CCAB:0,CCAC:1,CCBA:0,CCCA:1};function Vg(t,e,n){return"Cliffs"===t?Math.min(n,Dg[e]):Math.min(n,Fg[e])}class Gg{constructor(t,e,n,i,r){const s=t.viewer.gl,a=t.viewer.webgl,o=a.extensions.ANGLE_instanced_arrays,l=a.extensions.OES_vertex_array_object,h=new Ml;h.load(e);const u=h.geosets[0],c=u.vertices,d=u.normals,f=u.uvSets[0],p=u.faces,m=c.byteLength,_=m+d.byteLength;let g=null;const v=r.attribs;l&&(g=l.createVertexArrayOES(),l.bindVertexArrayOES(g));const b=s.createBuffer();s.bindBuffer(s.ARRAY_BUFFER,b),s.bufferData(s.ARRAY_BUFFER,_+f.byteLength,s.STATIC_DRAW),s.bufferSubData(s.ARRAY_BUFFER,0,c),s.bufferSubData(s.ARRAY_BUFFER,m,d),s.bufferSubData(s.ARRAY_BUFFER,_,f),l&&(s.vertexAttribPointer(v.a_position,3,s.FLOAT,!1,0,0),s.enableVertexAttribArray(v.a_position),s.vertexAttribPointer(v.a_normal,3,s.FLOAT,!1,0,m),s.enableVertexAttribArray(v.a_normal),s.vertexAttribPointer(v.a_uv,2,s.FLOAT,!1,0,_),s.enableVertexAttribArray(v.a_uv));const w=4*n.length,A=s.createBuffer();s.bindBuffer(s.ARRAY_BUFFER,A),s.bufferData(s.ARRAY_BUFFER,w+i.length,s.STATIC_DRAW),s.bufferSubData(s.ARRAY_BUFFER,0,new Float32Array(n)),s.bufferSubData(s.ARRAY_BUFFER,w,new Uint8Array(i)),l&&(s.vertexAttribPointer(v.a_instancePosition,3,s.FLOAT,!1,0,0),s.enableVertexAttribArray(v.a_instancePosition),o.vertexAttribDivisorANGLE(v.a_instancePosition,1),s.vertexAttribPointer(v.a_instanceTexture,1,s.UNSIGNED_BYTE,!1,0,w),s.enableVertexAttribArray(v.a_instanceTexture),o.vertexAttribDivisorANGLE(v.a_instanceTexture,1));const y=s.createBuffer();s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,y),s.bufferData(s.ELEMENT_ARRAY_BUFFER,p,s.STATIC_DRAW),l&&l.bindVertexArrayOES(null),this.map=t,this.vertexBuffer=b,this.faceBuffer=y,this.normalsOffset=m,this.uvsOffset=_,this.elements=p.length,this.locationAndTextureBuffer=A,this.texturesOffset=w,this.instances=n.length/3,this.vao=g}render(t){const e=this.map.viewer,n=e.gl,i=e.webgl,r=i.extensions.ANGLE_instanced_arrays,s=i.extensions.OES_vertex_array_object,a=t.attribs;s?s.bindVertexArrayOES(this.vao):(n.bindBuffer(n.ARRAY_BUFFER,this.locationAndTextureBuffer),n.vertexAttribPointer(a.a_instancePosition,3,n.FLOAT,!1,0,0),n.vertexAttribPointer(a.a_instanceTexture,1,n.UNSIGNED_BYTE,!1,0,this.texturesOffset),n.bindBuffer(n.ARRAY_BUFFER,this.vertexBuffer),n.vertexAttribPointer(a.a_position,3,n.FLOAT,!1,0,0),n.vertexAttribPointer(a.a_normal,3,n.FLOAT,!1,0,this.normalsOffset),n.vertexAttribPointer(a.a_uv,2,n.FLOAT,!1,0,this.uvsOffset),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,this.faceBuffer)),r.drawElementsInstancedANGLE(n.TRIANGLES,this.elements,n.UNSIGNED_SHORT,0,this.instances),s&&s.bindVertexArrayOES(null)}}function Kg(t,e){return t.sequence.rarity-e.sequence.rarity}function jg(t){const e=function(t,e){const n=function(t,e){const n=[];for(let i=0,r=e.length;i<r;i++){const r=e[i];r.name.split("-")[0].replace(/\d/g,"").trim().toLowerCase()===t&&n.push({sequence:r,index:i})}return n}(t,e);let i,r;for(n.sort(Kg),i=0,r=n.length;i<r;i++){const t=n[i].sequence.rarity;if(0===t)break;if(10*Math.random()>t)return n[i]}const s=n.length-i;return n[i+Math.floor(Math.random()*s)]}("stand",t.model.sequences);e&&t.setSequence(e.index)}var zg;!function(t){t[t.IDLE=0]="IDLE",t[t.WALK=1]="WALK"}(zg||(zg={}));class Hg{constructor(t,e){this.state=zg.IDLE,this.instance=e.addInstance(),this.instance.setScene(t.worldScene)}update(){(this.instance.sequenceEnded||-1===this.instance.sequence)&&this.state===zg.IDLE&&jg(this.instance)}}const Xg=qe();class qg extends Hg{constructor(t,e,n,i){super(t,e);const r=this.instance;r.move(i.location),r.rotateLocal(Ui(Ri(),Qs,i.angle)),r.scale(i.scale),r.setTeamColor(i.player),r.setScene(t.worldScene),n&&(Xg[2]=n.number("moveHeight"),r.move(Xg),r.setVertexColor([n.number("red")/255,n.number("green")/255,n.number("blue")/255,1]),r.uniformScale(n.number("modelScale"))),this.instance=r,this.row=n}}class Yg extends Hg{constructor(t,e,n,i){super(t,e);const r=this.instance;r.move(i.location),r.rotateLocal(Ui(Ri(),Qs,i.angle)),r.scale(i.scale),r.setScene(t.worldScene),this.instance=r,this.row=n}}const $g=qe();class Wg{constructor(t,e,n,i){const r=t.centerOffset,s=e.addInstance();$g[0]=128*i.location[0]+r[0]+128,$g[1]=128*i.location[1]+r[1]+128,s.move($g),s.rotateLocal(Ui(Ri(),Qs,va(n.number("fixedRot")))),s.setScene(t.worldScene),this.instance=s,this.row=n}}const Zg=qe(),Jg=qe();class Qg{constructor(t,e){this.buildVersion=0,this.solverParams={tileset:"a"},this.waterIndex=0,this.waterIncreasePerFrame=0,this.waterHeightOffset=0,this.waterTextures=[],this.maxDeepColor=new Float32Array(4),this.minDeepColor=new Float32Array(4),this.maxShallowColor=new Float32Array(4),this.minShallowColor=new Float32Array(4),this.anyReady=!1,this.terrainReady=!1,this.cliffsReady=!1,this.doodads=[],this.terrainDoodads=[],this.doodadsReady=!1,this.units=[],this.unitsReady=!1,this.tilesetTextures=[],this.cliffTextures=[],this.cliffModels=[],this.corners=[],this.centerOffset=new Float32Array(2),this.mapSize=new Int32Array(2),this.tilesets=[],this.blightTextureIndex=-1,this.cliffTilesets=[],this.columns=0,this.rows=0,this.vertexBuffer=null,this.faceBuffer=null,this.instanceBuffer=null,this.textureBuffer=null,this.variationBuffer=null,this.waterBuffer=null,this.heightMap=null,this.waterHeightMap=null,this.cliffHeightMap=null,this.viewer=t,this.worldScene=t.addScene(),this.map=new pf,this.map.load(e,!0),this.loadMapInformation(),this.pathSolver=(e,n)=>{if("string"==typeof e){const i=e.replace(/\//g,"\\"),r=this.map.get(i);return r?r.arrayBuffer():t.wc3PathSolver(e,n)}return e},this.loadTerrainCliffsAndWater();const n=this.map.readModifications();this.applyModificationFile(t.doodadsData,t.doodadMetaData,n.w3d),this.applyModificationFile(t.doodadsData,t.destructableMetaData,n.w3b),this.applyModificationFile(t.unitsData,t.unitMetaData,n.w3u),this.applyModificationFile(t.unitsData,t.unitMetaData,n.w3t),this.loadDoodadsAndDestructibles(),this.loadUnitsAndItems()}die(){this.worldScene.detach()}load(t){return this.viewer.load(t,this.pathSolver,this.solverParams)}loadMapInformation(){const t=this.map.get("war3map.w3i");if(!t)return void console.warn("Attempted to load war3map.w3i but it is not there. Using default tileset A.");const e=new ff;try{e.load(t.bytes())}catch(t){console.warn("Failed to correctly parse the map information file")}this.solverParams.tileset=e.tileset.toLowerCase(),this.buildVersion=e.getBuildVersion(),this.buildVersion>131&&(this.solverParams.reforged=!0)}async loadTerrainCliffsAndWater(){const t=this.map.get("war3map.w3e");if(!t)return void console.warn("Attempted to load war3map.w3e, but it is not there.");const e=new Af;try{e.load(t.bytes())}catch(t){return void console.warn(`Failed to load war3map.w3e: ${t}`)}const n=this.viewer,i=e.centerOffset,r=e.mapSize;this.corners=e.corners,this.centerOffset.set(i),this.mapSize.set(r),this.worldScene.grid=new kp(i[0],i[1],128*r[0]-128,128*r[1]-128,2048,2048);const s=this.solverParams.reforged?".dds":".blp",a=e.tileset,o=[],l=[],h=[];for(const t of e.groundTilesets){const e=n.terrainData.getRow(t);this.tilesets.push(e),o.push(this.load(`${e.string("dir")}\\${e.string("file")}${s}`))}this.blightTextureIndex=this.tilesetTextures.length,o.push(this.load(`TerrainArt\\Blight\\${{A:"Ashen",B:"Barrens",C:"Felwood",D:"Cave",F:"Lordf",G:"Dungeon",I:"Ice",J:"DRuins",K:"Citadel",L:"Lords",N:"North",O:"Outland",Q:"VillageFall",V:"Village",W:"Lordw",X:"Village",Y:"Village",Z:"Ruins"}[a]}_Blight${s}`));for(const t of e.cliffTilesets){const e=n.cliffTypesData.getRow(t);this.cliffTilesets.push(e),l.push(this.load(`${e.string("texDir")}\\${e.string("texFile")}${s}`))}const u=n.waterData.getRow(`${a}Sha`);this.waterHeightOffset=u.number("height"),this.waterIncreasePerFrame=u.number("texRate")/60,this.waterTextures.length=0,this.maxDeepColor.set([u.number("Dmax_R"),u.number("Dmax_G"),u.number("Dmax_B"),u.number("Dmax_A")]),this.minDeepColor.set([u.number("Dmin_R"),u.number("Dmin_G"),u.number("Dmin_B"),u.number("Dmin_A")]),this.maxShallowColor.set([u.number("Smax_R"),u.number("Smax_G"),u.number("Smax_B"),u.number("Smax_A")]),this.minShallowColor.set([u.number("Smin_R"),u.number("Smin_G"),u.number("Smin_B"),u.number("Smin_A")]);for(let t=0,e=u.number("numTex");t<e;t++)h.push(this.load(`${u.string("texFile")}${t<10?"0":""}${t}${s}`));this.tilesetTextures=await Promise.all(o),this.cliffTextures=await Promise.all(l),this.waterTextures=await Promise.all(h);const c=e.corners,[d,f]=this.mapSize,p=(d-1)*(f-1),m=new Float32Array(d*f),_=new Float32Array(d*f),g=new Float32Array(d*f),v=new Uint8Array(4*p),b=new Uint8Array(4*p),w=new Uint8Array(p);let A=0;const y={};this.columns=d-1,this.rows=f-1;for(let t=0;t<f;t++)for(let e=0;e<d;e++){const n=c[t][e],r=t*d+e;if(m[r]=n.groundHeight,_[r]=n.groundHeight+n.layerHeight-2,g[r]=n.waterHeight,t<f-1&&e<d-1){if(w[A]=this.isWater(e,t),this.isCliff(e,t)){const r=n.layerHeight,s=c[t][e+1].layerHeight,a=c[t+1][e].layerHeight,o=c[t+1][e+1].layerHeight,l=Math.min(r,s,a,o),h=this.cliffFileName(r,s,a,o,l);if("AAAA"!==h){let r=n.cliffTexture;15===r&&(r=1);const s=this.cliffTilesets[r].string("cliffModelDir"),a=`Doodads\\Terrain\\${s}\\${s}${h}${Vg(s,h,n.cliffVariation)}.mdx`;y[a]||(y[a]={locations:[],textures:[]}),y[a].locations.push(128*(e+1)+i[0],128*t+i[1],128*(l-2)),y[a].textures.push(r)}}else{const i=this.cornerTexture(e,t),r=this.cornerTexture(e+1,t),s=this.cornerTexture(e,t+1),a=this.cornerTexture(e+1,t+1),o=Ng([i,r,s,a]).sort();let l=o[0];v[4*A]=l+1,b[4*A]=this.getVariation(l,n.groundVariation),o.shift();for(let t=0,e=o.length;t<e;t++){let e=0;l=o[t],r===l&&(e|=1),i===l&&(e|=2),a===l&&(e|=4),s===l&&(e|=8),v[4*A+1+t]=l+1,b[4*A+1+t]=e}}A+=1}}const x=this.viewer.gl,T=this.viewer.webgl;this.vertexBuffer=x.createBuffer(),x.bindBuffer(x.ARRAY_BUFFER,this.vertexBuffer),x.bufferData(x.ARRAY_BUFFER,new Float32Array([0,0,1,0,0,1,1,1]),x.STATIC_DRAW),this.faceBuffer=x.createBuffer(),x.bindBuffer(x.ELEMENT_ARRAY_BUFFER,this.faceBuffer),x.bufferData(x.ELEMENT_ARRAY_BUFFER,new Uint8Array([0,1,2,1,3,2]),x.STATIC_DRAW),this.cliffHeightMap=x.createTexture(),x.bindTexture(x.TEXTURE_2D,this.cliffHeightMap),T.setTextureMode(x.CLAMP_TO_EDGE,x.CLAMP_TO_EDGE,x.NEAREST,x.NEAREST),x.texImage2D(x.TEXTURE_2D,0,x.ALPHA,d,f,0,x.ALPHA,x.FLOAT,m),this.heightMap=x.createTexture(),x.bindTexture(x.TEXTURE_2D,this.heightMap),T.setTextureMode(x.CLAMP_TO_EDGE,x.CLAMP_TO_EDGE,x.NEAREST,x.NEAREST),x.texImage2D(x.TEXTURE_2D,0,x.ALPHA,d,f,0,x.ALPHA,x.FLOAT,_),this.waterHeightMap=x.createTexture(),x.bindTexture(x.TEXTURE_2D,this.waterHeightMap),T.setTextureMode(x.CLAMP_TO_EDGE,x.CLAMP_TO_EDGE,x.NEAREST,x.NEAREST),x.texImage2D(x.TEXTURE_2D,0,x.ALPHA,d,f,0,x.ALPHA,x.FLOAT,g),this.instanceBuffer=x.createBuffer(),x.bindBuffer(x.ARRAY_BUFFER,this.instanceBuffer),x.bufferData(x.ARRAY_BUFFER,new Float32Array(p).map(((t,e)=>e)),x.STATIC_DRAW),this.textureBuffer=x.createBuffer(),x.bindBuffer(x.ARRAY_BUFFER,this.textureBuffer),x.bufferData(x.ARRAY_BUFFER,v,x.STATIC_DRAW),this.variationBuffer=x.createBuffer(),x.bindBuffer(x.ARRAY_BUFFER,this.variationBuffer),x.bufferData(x.ARRAY_BUFFER,b,x.STATIC_DRAW),this.waterBuffer=x.createBuffer(),x.bindBuffer(x.ARRAY_BUFFER,this.waterBuffer),x.bufferData(x.ARRAY_BUFFER,w,x.STATIC_DRAW),this.terrainReady=!0,this.anyReady=!0;const L=n.cliffShader,E=Object.entries(y).map((async t=>{const e=t[0],{locations:i,textures:r}=t[1],s=await n.loadBaseFile(e,"arrayBuffer");if(s)return new Gg(this,s.data,i,r,L)})).filter((t=>t));this.cliffModels=await Promise.all(E),this.cliffsReady=!0}loadDoodadsAndDestructibles(){const t=this.map.get("war3map.doo");if(!t)return void console.warn("Attempted to load war3map.doo but it is not there");const e=new bf;try{e.load(t.bytes(),this.buildVersion)}catch(t){return void console.warn(`Failed to load war3map.doo: ${t}`)}for(const t of e.doodads)try{const e=this.viewer.doodadsData.getRow(t.id);if(e){let n=e.string("file");if(n){const i=e.number("numVar");n.endsWith(".mdl")&&(n=n.slice(0,-4));let r=n;n+=".mdx",i>1&&(r+=Math.min(t.variation,i-1)),r+=".mdx";const s=this.map.get(r)||this.map.get(n);let a;a=s?this.load(s.name):this.load(r),a.then((n=>{n&&this.doodads.push(new Yg(this,n,e,t))}))}else console.log("Unknown doodad ID",t.id,t)}}catch(e){console.warn(`Failed to load doodad/destructible ID ${t.id}: ${e}`)}for(const t of e.terrainDoodads)try{const e=this.viewer.doodadsData.getRow(t.id);this.load(`${e.string("file")}.mdx`).then((n=>{n&&this.terrainDoodads.push(new Wg(this,n,e,t))}))}catch(e){console.warn(`Failed to load cliff/terrain doodad ID ${t.id}: ${e}`)}this.doodadsReady=!0,this.anyReady=!0}loadUnitsAndItems(){const t=this.map.get("war3mapUnits.doo");if(!t)return void console.warn("Attempted to load war3mapUnits.doo but it is not there");const e=new Mf;try{e.load(t.bytes(),this.buildVersion)}catch(t){return void console.warn(`Failed to load war3mapUnits.doo: ${t}`)}for(const t of e.units)try{let e,n;"sloc"===t.id?n="Objects\\StartLocation\\StartLocation.mdx":(e=this.viewer.unitsData.getRow(t.id),e&&(n=e.string("file"),n&&(n.endsWith(".mdl")&&(n=n.slice(0,-4)),n+=".mdx"))),n?this.load(n).then((n=>{n&&this.units.push(new qg(this,n,e,t))})):console.log("Unknown unit ID",t.id,t)}catch(e){console.warn(`Failed to load unit/item ID ${t.id}: ${e}`)}this.unitsReady=!0,this.anyReady=!0}update(){if(this.anyReady){this.waterIndex+=this.waterIncreasePerFrame,this.waterIndex>=this.waterTextures.length&&(this.waterIndex=0);for(const t of this.doodads)t.update();for(const t of this.units)t.update()}}render(){if(this.anyReady){const t=this.worldScene;t.startFrame(),this.renderGround(),this.renderCliffs(),t.renderOpaque(),this.renderWater(),t.renderTranslucent()}}renderGround(){if(this.terrainReady){const t=this.viewer.gl,e=this.viewer.webgl,n=e.extensions.ANGLE_instanced_arrays,i=this.viewer.groundShader,r=i.uniforms,s=i.attribs,a=this.tilesetTextures,o=s.a_InstanceID,l=s.a_position,h=s.a_textures,u=s.a_variations,c=a.length;t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),e.useShader(i),t.uniformMatrix4fv(r.u_VP,!1,this.worldScene.camera.viewProjectionMatrix),t.uniform2fv(r.u_offset,this.centerOffset),t.uniform2f(r.u_size,this.columns,this.rows),t.uniform1i(r.u_heightMap,15),t.activeTexture(t.TEXTURE15),t.bindTexture(t.TEXTURE_2D,this.heightMap),t.bindBuffer(t.ARRAY_BUFFER,this.vertexBuffer),t.vertexAttribPointer(l,2,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this.instanceBuffer),t.vertexAttribPointer(o,1,t.FLOAT,!1,0,0),n.vertexAttribDivisorANGLE(o,1),t.bindBuffer(t.ARRAY_BUFFER,this.textureBuffer),t.vertexAttribPointer(h,4,t.UNSIGNED_BYTE,!1,0,0),n.vertexAttribDivisorANGLE(h,1),t.bindBuffer(t.ARRAY_BUFFER,this.variationBuffer),t.vertexAttribPointer(u,4,t.UNSIGNED_BYTE,!1,0,0),n.vertexAttribDivisorANGLE(u,1),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.faceBuffer),t.uniform1f(r.u_baseTileset,0);for(let n=0,i=Math.min(c,15);n<i;n++){const i=a[n].width>a[n].height?1:0;t.uniform1f(r[`u_extended[${n}]`],i),t.uniform1i(r[`u_tilesets[${n}]`],n),e.bindTexture(a[n],n)}if(n.drawElementsInstancedANGLE(t.TRIANGLES,6,t.UNSIGNED_BYTE,0,this.rows*this.columns),c>15){t.uniform1f(r.u_baseTileset,15);for(let n=0,i=c-15;n<i;n++){const i=a[n+15].width>a[n+15].height?1:0;t.uniform1f(r[`u_extended[${n}]`],i),e.bindTexture(a[n+15],n)}n.drawElementsInstancedANGLE(t.TRIANGLES,6,t.UNSIGNED_BYTE,0,this.rows*this.columns)}n.vertexAttribDivisorANGLE(h,0),n.vertexAttribDivisorANGLE(u,0),n.vertexAttribDivisorANGLE(o,0)}}renderWater(){if(this.terrainReady){const t=this.viewer.gl,e=this.viewer.webgl,n=e.extensions.ANGLE_instanced_arrays,i=this.viewer.waterShader,r=i.uniforms,s=i.attribs,a=s.a_InstanceID,o=s.a_position,l=s.a_isWater;t.depthMask(!1),t.enable(t.BLEND),t.blendFunc(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA),e.useShader(i),t.uniformMatrix4fv(r.u_VP,!1,this.worldScene.camera.viewProjectionMatrix),t.uniform2fv(r.u_offset,this.centerOffset),t.uniform2f(r.u_size,this.columns,this.rows),t.uniform1i(r.u_heightMap,0),t.uniform1i(r.u_waterHeightMap,1),t.uniform1i(r.u_waterTexture,2),t.uniform1f(r.u_offsetHeight,this.waterHeightOffset),t.uniform4fv(r.u_maxDeepColor,this.maxDeepColor),t.uniform4fv(r.u_minDeepColor,this.minDeepColor),t.uniform4fv(r.u_maxShallowColor,this.maxShallowColor),t.uniform4fv(r.u_minShallowColor,this.minShallowColor),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this.heightMap),t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,this.waterHeightMap),e.bindTexture(this.waterTextures[0|this.waterIndex],2),t.bindBuffer(t.ARRAY_BUFFER,this.vertexBuffer),t.vertexAttribPointer(o,2,t.FLOAT,!1,8,0),t.bindBuffer(t.ARRAY_BUFFER,this.instanceBuffer),t.vertexAttribPointer(a,1,t.FLOAT,!1,4,0),n.vertexAttribDivisorANGLE(a,1),t.bindBuffer(t.ARRAY_BUFFER,this.waterBuffer),t.vertexAttribPointer(l,1,t.UNSIGNED_BYTE,!1,1,0),n.vertexAttribDivisorANGLE(l,1),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.faceBuffer),n.drawElementsInstancedANGLE(t.TRIANGLES,6,t.UNSIGNED_BYTE,0,this.rows*this.columns),n.vertexAttribDivisorANGLE(l,0),n.vertexAttribDivisorANGLE(a,0)}}renderCliffs(){if(this.cliffsReady){const t=this.viewer.gl,e=this.viewer.webgl,n=e.extensions.ANGLE_instanced_arrays,i=e.extensions.OES_vertex_array_object,r=this.viewer.cliffShader,s=r.attribs,a=r.uniforms;t.disable(t.BLEND),r.use(),t.uniformMatrix4fv(a.u_VP,!1,this.worldScene.camera.viewProjectionMatrix),t.uniform1i(a.u_heightMap,0),t.uniform2f(a.u_pixel,1/(this.columns+1),1/(this.rows+1)),t.uniform2fv(a.u_centerOffset,this.centerOffset),t.uniform1i(a.u_texture1,1),t.uniform1i(a.u_texture2,2),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this.cliffHeightMap),t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,this.cliffTextures[0].webglResource),this.cliffTextures.length>1&&(t.activeTexture(t.TEXTURE2),t.bindTexture(t.TEXTURE_2D,this.cliffTextures[1].webglResource)),i||(n.vertexAttribDivisorANGLE(s.a_instancePosition,1),n.vertexAttribDivisorANGLE(s.a_instanceTexture,1));for(const t of this.cliffModels)t.render(r);i||(n.vertexAttribDivisorANGLE(s.a_instancePosition,0),n.vertexAttribDivisorANGLE(s.a_instanceTexture,0))}}cliffFileName(t,e,n,i,r){return String.fromCharCode(65+t-r)+String.fromCharCode(65+n-r)+String.fromCharCode(65+i-r)+String.fromCharCode(65+e-r)}getVariation(t,e){const n=this.tilesetTextures[t];return n.width>n.height?e<16?16+e:16===e?15:0:0===e?0:15}isCliff(t,e){if(t<1||t>this.columns-1||e<1||e>this.rows-1)return!1;const n=this.corners,i=n[e][t].layerHeight,r=n[e][t+1].layerHeight,s=n[e+1][t].layerHeight,a=n[e+1][t+1].layerHeight;return i!==r||i!==s||i!==a}isWater(t,e){const n=this.corners;return n[e][t].water||n[e][t+1].water||n[e+1][t].water||n[e+1][t+1].water}cliffGroundIndex(t){const e=this.cliffTilesets[t].string("groundTile"),n=this.tilesets;for(let t=0,i=n.length;t<i;t++)if(n[t].string("tileID")===e)return t;return 0}cornerTexture(t,e){const n=this.corners,i=this.columns,r=this.rows;for(let s=-1;s<1;s++)for(let a=-1;a<1;a++)if(t+a>0&&t+a<i-1&&e+s>0&&e+s<r-1&&this.isCliff(t+a,e+s)){let i=n[e+s][t+a].cliffTexture;return 15===i&&(i=1),this.cliffGroundIndex(i)}const s=n[e][t];return s.blight?this.blightTextureIndex:s.groundTexture}applyModificationFile(t,e,n){n&&(this.applyModificationTable(t,e,n.originalTable),this.applyModificationTable(t,e,n.customTable))}applyModificationTable(t,e,n){for(const i of n.objects){let n;""!==i.newId?(n=t.getRow(i.newId),n||(n=new Rm,n.map=Object.assign({},t.getRow(i.oldId).map),t.setRow(i.newId,n))):n=t.getRow(i.oldId);for(const t of i.modifications){const i=e.getRow(t.id);i?n.set(i.string("field"),t.value):console.warn("Unknown modification ID",t)}}}groundNormal(t,e,n){const i=this.centerOffset,r=this.mapSize,s=0|(e=(e-i[0])/128),a=0|(n=(n-i[1])/128);if(s>=0&&s<r[0]-1&&a>=0&&a<r[1]-1){const i=this.corners,r=i[a][s].groundHeight,o=i[a][s+1].groundHeight,l=i[a+1][s].groundHeight,h=i[a+1][s+1].groundHeight;e-s+(n-a)<1?(Je(Zg,1,0,o-r),Je(Jg,0,1,l-r)):(Je(Zg,-1,0,h-l),Je(Jg,0,1,h-o)),_n(t,vn(t,Zg,Jg))}else Je(t,0,0,1);return t}}const tv={blp:qp,dds:Yp,m3:Mm,mdx:Ug,tga:Og,War3MapViewer:class extends Dp{constructor(t,e,n){super(t),this.terrainData=new Im,this.cliffTypesData=new Im,this.waterData=new Im,this.doodadsData=new Im,this.doodadMetaData=new Im,this.destructableMetaData=new Im,this.unitsData=new Im,this.unitMetaData=new Im,this.loadedBaseFiles=!1,this.map=null;const i=this.webgl;if(!i.ensureExtension("OES_texture_float"))throw new Error("War3MapViewer: No float texture support!");i.ensureExtension("OES_vertex_array_object")||console.warn("War3MapViewer: No vertex array object support! This might reduce performance."),this.on("error",(t=>console.log(t))),this.addHandler(Ug,e,n),this.addHandler(qp),this.addHandler(Og),this.addHandler(Yp),this.wc3PathSolver=e,this.isReforged=n,this.groundShader=this.webgl.createShader("\nuniform mat4 u_VP;\nuniform sampler2D u_heightMap;\nuniform vec2 u_size;\nuniform vec2 u_offset;\nuniform bool u_extended[14];\nuniform float u_baseTileset;\n\nattribute vec2 a_position;\nattribute float a_InstanceID;\nattribute vec4 a_textures;\nattribute vec4 a_variations;\n\nvarying vec4 v_tilesets;\nvarying vec2 v_uv[4];\nvarying vec3 v_normal;\n\nvec2 getCell(float variation) {\n  if (variation < 16.0) {\n    return vec2(mod(variation, 4.0), floor(variation / 4.0));\n  } else {\n    variation -= 16.0;\n\n    return vec2(4.0 + mod(variation, 4.0), floor(variation / 4.0));\n  }\n}\n\nvec2 getUV(vec2 position, bool extended, float variation) {\n  vec2 cell = getCell(variation);\n  vec2 cellSize = vec2(extended ? 0.125 : 0.25, 0.25);\n  vec2 uv = vec2(position.x, 1.0 - position.y);\n  vec2 pixelSize = vec2(1.0 / 512.0, 1.0 / 256.0); /// Note: hardcoded to 512x256 for now.\n\n  return clamp((cell + uv) * cellSize, cell * cellSize + pixelSize, (cell + 1.0) * cellSize - pixelSize); \n}\n\nvoid main() {\n  vec4 textures = a_textures - u_baseTileset;\n  \n  if (textures[0] > 0.0 || textures[1] > 0.0 || textures[2] > 0.0 || textures[3] > 0.0) {\n    v_tilesets = textures;\n\n    v_uv[0] = getUV(a_position, u_extended[int(textures[0]) - 1], a_variations[0]);\n    v_uv[1] = getUV(a_position, u_extended[int(textures[1]) - 1], a_variations[1]);\n    v_uv[2] = getUV(a_position, u_extended[int(textures[2]) - 1], a_variations[2]);\n    v_uv[3] = getUV(a_position, u_extended[int(textures[3]) - 1], a_variations[3]);\n\n    vec2 corner = vec2(mod(a_InstanceID, u_size.x), floor(a_InstanceID / u_size.x));\n    vec2 base = corner + a_position;\n    float height = texture2D(u_heightMap, base / u_size).a;\n\n    float hL = texture2D(u_heightMap, vec2(base - vec2(1.0, 0.0)) / (u_size)).a;\n    float hR = texture2D(u_heightMap, vec2(base + vec2(1.0, 0.0)) / (u_size)).a;\n    float hD = texture2D(u_heightMap, vec2(base - vec2(0.0, 1.0)) / (u_size)).a;\n    float hU = texture2D(u_heightMap, vec2(base + vec2(0.0, 1.0)) / (u_size)).a;\n\n    v_normal = normalize(vec3(hL - hR, hD - hU, 2.0));\n\n    gl_Position = u_VP * vec4(base * 128.0 + u_offset, height * 128.0, 1.0);\n  } else {\n    v_tilesets = vec4(0.0);\n\n    v_uv[0] = vec2(0.0);\n    v_uv[1] = vec2(0.0);\n    v_uv[2] = vec2(0.0);\n    v_uv[3] = vec2(0.0);\n\n    v_normal = vec3(0.0);\n\n    gl_Position = vec4(0.0);\n  }\n}\n",Cg),this.waterShader=this.webgl.createShader("\nuniform mat4 u_VP;\nuniform sampler2D u_heightMap;\nuniform sampler2D u_waterHeightMap;\nuniform vec2 u_size;\nuniform vec2 u_offset;\nuniform float u_offsetHeight;\nuniform vec4 u_minDeepColor;\nuniform vec4 u_maxDeepColor;\nuniform vec4 u_minShallowColor;\nuniform vec4 u_maxShallowColor;\n\nattribute vec2 a_position;\nattribute float a_InstanceID;\nattribute float a_isWater;\n\nvarying vec2 v_uv;\nvarying vec4 v_color;\n\nconst float minDepth = 10.0 / 128.0;\nconst float deepLevel = 64.0 / 128.0;\nconst float maxDepth = 72.0 / 128.0;\n\nvoid main() {\n  if (a_isWater > 0.5) {\n    v_uv = a_position;\n\n    vec2 corner = vec2(mod(a_InstanceID, u_size.x), floor(a_InstanceID / u_size.x));\n    vec2 base = corner + a_position;\n    float height = texture2D(u_heightMap, base / u_size).a;\n    float waterHeight = texture2D(u_waterHeightMap, base / u_size).a + u_offsetHeight;\n    float value = clamp(waterHeight - height, 0.0, 1.0);\n\n    if (value <= deepLevel) {\n      value = max(0.0, value - minDepth) / (deepLevel - minDepth);\n      v_color = mix(u_minShallowColor, u_maxShallowColor, value) / 255.0;\n    } else {\n      value = clamp(value - deepLevel, 0.0, maxDepth - deepLevel) / (maxDepth - deepLevel);\n      v_color = mix(u_minDeepColor, u_maxDeepColor, value) / 255.0;\n    }\n\n    gl_Position = u_VP * vec4(base * 128.0 + u_offset, waterHeight * 128.0, 1.0);\n  } else {\n    v_uv = vec2(0.0);\n    v_color = vec4(0.0);\n\n    gl_Position = vec4(0.0);\n  }\n}\n",Bg),this.cliffShader=this.webgl.createShader("\nuniform mat4 u_VP;\nuniform sampler2D u_heightMap;\nuniform vec2 u_pixel;\nuniform vec2 u_centerOffset;\n\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_uv;\nattribute vec3 a_instancePosition;\nattribute float a_instanceTexture;\n\nvarying vec3 v_normal;\nvarying vec2 v_uv;\nvarying float v_texture;\nvarying vec3 v_position;\n\nvoid main() {\n  // Half of a pixel in the cliff height map.\n  vec2 halfPixel = u_pixel * 0.5;\n\n  // The bottom left corner of the map tile this vertex is on.\n  vec2 corner = floor((a_instancePosition.xy - vec2(1.0, 0.0) - u_centerOffset.xy) / 128.0);\n\n  // Get the 4 closest heights in the height map.\n  float bottomLeft = texture2D(u_heightMap, corner * u_pixel + halfPixel).a;\n  float bottomRight = texture2D(u_heightMap, (corner + vec2(1.0, 0.0)) * u_pixel + halfPixel).a;\n  float topLeft = texture2D(u_heightMap, (corner + vec2(0.0, 1.0)) * u_pixel + halfPixel).a;\n  float topRight = texture2D(u_heightMap, (corner + vec2(1.0, 1.0)) * u_pixel + halfPixel).a;\n  \n  // Do a bilinear interpolation between the heights to get the final value.\n  float bottom = mix(bottomRight, bottomLeft, -a_position.x / 128.0);\n  float top = mix(topRight, topLeft, -a_position.x / 128.0);\n  float height = mix(bottom, top, a_position.y / 128.0);\n\n  v_normal = a_normal;\n  v_uv = a_uv;\n  v_texture = a_instanceTexture;\n  v_position = a_position + vec3(a_instancePosition.xy, a_instancePosition.z + height * 128.0);\n\n  gl_Position = u_VP * vec4(v_position, 1.0);\n}\n",Pg),this.loadBaseFiles()}async loadBaseFiles(){const t=[this.loadBaseFile("TerrainArt\\Terrain.slk","text"),this.loadBaseFile("TerrainArt\\CliffTypes.slk","text"),this.loadBaseFile("TerrainArt\\Water.slk","text"),this.loadBaseFile("Doodads\\Doodads.slk","text"),this.loadBaseFile("Doodads\\DoodadMetaData.slk","text"),this.loadBaseFile("Units\\DestructableData.slk","text"),this.loadBaseFile("Units\\DestructableMetaData.slk","text"),this.loadBaseFile("Units\\UnitData.slk","text"),this.loadBaseFile("Units\\unitUI.slk","text"),this.loadBaseFile("Units\\ItemData.slk","text"),this.loadBaseFile("Units\\UnitMetaData.slk","text")];let e;this.isReforged&&(e=[this.loadBaseFile("Doodads\\doodadSkins.txt","text"),this.loadBaseFile("Units\\destructableSkin.txt","text"),this.loadBaseFile("Units\\unitSkin.txt","text"),this.loadBaseFile("Units\\itemSkin.txt","text")]);const[n,i,r,s,a,o,l,h,u,c,d]=await Promise.all(t);if(!(n&&i&&r&&s&&a&&o&&l&&h&&u&&c&&d))throw new Error("Failed to load the base files");if(this.terrainData.load(n.data),this.cliffTypesData.load(i.data),this.waterData.load(r.data),this.doodadsData.load(s.data),this.doodadMetaData.load(a.data),this.doodadsData.load(o.data),this.destructableMetaData.load(l.data),this.unitsData.load(h.data),this.unitsData.load(u.data),this.unitsData.load(c.data),this.unitMetaData.load(d.data),e){const[t,n,i,r]=await Promise.all(e);if(!(t&&n&&i&&r))throw new Error("Failed to load the base Reforged files");this.doodadsData.load(t.data),this.doodadsData.load(n.data),this.unitsData.load(i.data),this.unitsData.load(r.data)}this.loadedBaseFiles=!0,this.emit("loadedbasefiles")}loadBaseFile(t,e){return super.loadGeneric(this.wc3PathSolver(t),e)}loadMap(t){this.loadedBaseFiles&&(this.map&&this.map.die(),this.map=new Qg(this,t))}update(){this.map&&(super.update(),this.map.update())}render(){this.map&&this.map.render()}}},ev={ModelViewer:Dp,DebugRenderMode:Np,Scene:Ip,Camera:Sp,Node:Kp,Model:zp,ModelInstance:Hp,Texture:Bp,GenericResource:Op,gl:Xp,handlers:tv};n(660),n(696),n(447),n(179);class nv{constructor(){this.handleId=-1}}class iv extends nv{}class rv extends iv{constructor(t,e){super(),this.team=-1,this.startLocation=-1,this.forcedStartLocation=-1,this.color=-1,this.race=0,this.racePreference=-1,this.raceSelectable=!1,this.controller=-1,this.alliances=new Map,this.index=t,this.name=`Player ${t}`;for(let n=0;n<e;n++)n!==t&&this.alliances.set(n,{passive:!1,helpRequest:!1,helpResponse:!1,sharedXp:!1,sharedSpells:!1,sharedVision:!1,sharedControl:!1,sharedAdvancedControl:!1,rescuable:!1,sharedVisionForced:!1})}}class sv extends iv{constructor(){super(...arguments),this.health=0,this.maxHealth=0}}class av extends sv{constructor(t,e,n,i,r){super(),this.acquireRange=500,this.player=t,this.unitId=go(e),this.x=n,this.y=i,this.face=r}}class ov extends iv{constructor(){super(...arguments),this.players=new Set}}class lv extends iv{constructor(){super(...arguments),this.units=new Set}}class hv extends iv{constructor(){super(...arguments),this.events=[],this.conditions=[],this.actions=[],this.enabled=!0}}class uv extends iv{constructor(){super(...arguments),this.elapsed=0,this.timeout=0,this.periodic=!1,this.handlerFunc=-1}}class cv extends iv{constructor(t,e){super(),this.z=0,this.x=t,this.y=e}}class dv extends iv{constructor(){super(...arguments),this.rects=new Set}}class fv extends iv{constructor(t,e,n,i){super(),this.center=new Float32Array([n-t,i-e]),this.min=new Float32Array([t,e]),this.max=new Float32Array([n,i])}}class pv extends nv{constructor(t){super(),this.id=t}}class mv extends pv{}class _v extends pv{}class gv extends pv{}class vv extends pv{}class bv extends vv{}class wv extends vv{}class Av extends pv{}class yv extends pv{}class xv extends pv{}class Tv extends pv{}class Lv extends pv{}class Ev extends pv{}class Sv extends Ev{}class Mv extends Ev{}class kv extends Ev{}class Rv extends Ev{}class Iv extends Ev{}class Uv extends Ev{}class Ov extends Ev{}class Cv extends pv{}class Bv extends pv{}class Pv extends pv{}class Nv extends pv{}class Dv extends pv{}class Fv extends pv{}class Vv extends pv{}class Gv extends pv{}class Kv extends pv{}class jv extends pv{}class zv extends pv{}class Hv extends pv{}class Xv extends nv{constructor(){super(...arguments),this.targetDistance=0,this.farZ=0,this.angleOfAttack=0,this.fieldOfView=0,this.roll=0,this.rotation=0,this.zOffset=0,this.destPosition=new cv(0,0)}}class qv extends pv{}class Yv extends pv{}class $v extends pv{}class Wv extends pv{}class Zv extends pv{}class Jv extends pv{}class Qv extends pv{}class tb extends nv{constructor(t,e){super(),this.enabled=!1,this.whichRect=t,this.effectId=e}}class eb extends pv{}class nb extends pv{}class ib extends pv{}class rb extends pv{}class sb extends pv{}class ab extends pv{}class ob extends pv{}class lb extends pv{}class hb extends iv{constructor(){super(...arguments),this.table=new Map}save(t,e,n){const i=this.table;let r=i.get(t);r||(r=new Map,i.set(t,r)),r.set(e,n)}load(t,e,n){const i=this.table.get(t);if(i){const t=i.get(e);if(void 0!==t)return t}return n}have(t,e){const n=this.table.get(t);return!!n&&n.has(e)}remove(t,e){const n=this.table,i=n.get(t);i&&(i.delete(e),i.size||n.delete(t))}flush(){this.table.clear()}flushChild(t){const e=this.table.get(t);e&&e.clear()}}n(809);mp.EventEmitter;new Set(["attack","birth","cinematic","death","decay","dissipate","morph","portrait","sleep","spell","stand","walk","ready"]),new Set([1,2,11,21,31,32,33,34,35,36,37]),new Map([["KMTF","Texture ID"],["KMTA","Alpha"],["KMTE","Emissive Gain"],["KFC3","Fresnel Color"],["KFCA","Fresnel Opacity"],["KFTC","Fresnel Team Color"],["KTAT","Translation"],["KTAR","Rotation"],["KTAS","Scaling"],["KGAO","Alpha"],["KGAC","Color"],["KGTR","Translation"],["KGRT","Rotation"],["KGSC","Scaling"],["KLAS","Attenuation Start"],["KLAE","Attenuation End"],["KLAC","Color"],["KLAI","Intensity"],["KLBI","Ambient Intensity"],["KLBC","Ambient Color"],["KLAV","Visibility"],["KATV","Visibility"],["KPEE","Emission Rate"],["KPEG","Gravity"],["KPLN","Longitude"],["KPLT","Latitude"],["KPEL","Lifespan"],["KPES","Speed"],["KPEV","Visibility"],["KP2E","Emission Rate"],["KP2G","Gravity"],["KP2L","Latitude"],["KP2R","Variation"],["KP2N","Length"],["KP2W","Width"],["KP2S","Speed"],["KP2V","Visibility"],["KPPA","Alpha"],["KPPC","Color"],["KPPE","EmissionRate"],["KPPL","LifeSpan"],["KPPS","Speed"],["KPPV","Visibility"],["KRHA","Height Above"],["KRHB","Height Below"],["KRAL","Alpha"],["KRCO","Color"],["KRTX","Texture Slot"],["KRVS","Visibility"],["KCTR","Translation"],["KTTR","Rotation"],["KCRL","Target Translation"]]);function ub(t,e){return{vertices:new Float32Array([-t,e,0,-t,-e,0,t,-e,0,t,e,0]),uvs:new Float32Array([0,0,0,1,1,1,1,0]),faces:new Uint16Array([0,1,2,0,2,3]),edges:new Uint16Array([0,1,1,2,2,3,3,0]),boundingRadius:Math.hypot(t,e)}}function cb(){return ub(1,1)}function db(t,e,n){return{vertices:new Float32Array([-t,-e,-n,-t,-e,n,-t,e,-n,-t,e,n,t,e,-n,t,e,n,t,-e,-n,t,-e,n]),uvs:new Float32Array([0,0,0,1,.25,0,.25,1,.5,0,.5,1,.75,0,.75,1]),faces:new Uint16Array([0,1,2,1,3,2,2,3,4,3,5,4,4,5,6,5,7,6,6,7,0,7,1,0,0,2,4,0,4,6,1,5,3,1,7,5]),edges:new Uint16Array([0,1,2,3,4,5,6,7,0,2,2,4,4,6,6,0,1,3,3,5,5,7,7,1]),boundingRadius:Math.hypot(t,e,n)}}function fb(){return db(1,1,1)}function pb(t,e,n){const i=(e+1)*(n+1),r=new Float32Array(3*i),s=new Float32Array(2*i),a=new Uint16Array(e*n*6),o=new Uint16Array(e*n*6);for(let i=0,a=0,o=0;i<=e;i++){const l=i*Math.PI/e,h=Math.sin(l),u=Math.cos(l);for(let l=0;l<=n;l+=1,a+=3,o+=2){const c=2*l*Math.PI/n,d=Math.sin(c),f=Math.cos(c);r[a+0]=f*h*t,r[a+1]=d*h*t,r[a+2]=u*t,s[o+0]=l/n,s[o+1]=1-i/e}}for(let t=0,i=0;t<e;t++)for(let e=0;e<n;e+=1,i+=6){const r=t*(n+1)+e,s=r+n+1;a[i+0]=r,a[i+1]=s,a[i+2]=r+1,a[i+3]=s,a[i+4]=s+1,a[i+5]=r+1,o[i+0]=r,o[i+1]=s,o[i+2]=r,o[i+3]=r+1,o[i+4]=s,o[i+5]=s+1}return{vertices:r,uvs:s,faces:a,edges:o,boundingRadius:t}}function mb(t,e){return pb(1,t,e)}function _b(t,e,n){const i=2*((n=Math.max(n,3))+1)+2,r=new Float32Array(3*i),s=new Float32Array(2*i),a=new Uint16Array(12*n),o=new Uint16Array(10*n),l=2*Math.PI/n;let h=0,u=0;for(let i=0;i<n+1;i+=1,h+=6,u+=4){const a=Math.cos(l*i)*t,o=Math.sin(l*i)*t,c=i/n;r[h+0]=a,r[h+1]=o,r[h+2]=e,r[h+3]=a,r[h+4]=o,r[h+5]=-e,s[u+0]=c,s[u+1]=1,s[u+2]=c,s[u+3]=0}r[h+0]=0,r[h+1]=0,r[h+2]=e,r[h+3]=0,r[h+4]=0,r[h+5]=-e,s[u+0]=0,s[u+1]=1,s[u+2]=0,s[u+3]=0;for(let t=0,e=0,r=0;t<n;t+=1,e+=12,r+=10){const n=2*t;a[e+0]=n+0,a[e+1]=n+1,a[e+2]=(n+3)%(i-2),a[e+3]=n+0,a[e+4]=(n+3)%(i-2),a[e+5]=(n+2)%(i-2),a[e+6]=n+0,a[e+7]=(n+2)%(i-2),a[e+8]=i-2,a[e+9]=n+1,a[e+10]=(n+3)%(i-2),a[e+11]=i-1,o[r+0]=n+0,o[r+1]=n+1,o[r+2]=n+0,o[r+3]=(n+2)%(i-2),o[r+4]=n+1,o[r+5]=(n+3)%(i-2),o[r+6]=n+0,o[r+7]=i-2,o[r+8]=n+1,o[r+9]=i-1}return{vertices:r,uvs:s,faces:a,edges:o,boundingRadius:Math.hypot(t,e)}}function gb(t){return _b(1,1,t)}function vb(t,e,n,i){const r=2*Math.tan(t/2),s=r*n/2,a=n*e/2,o=r*i/2,l=i*e/2;return{vertices:new Float32Array([-a,-s,n,-a,s,n,-l,-o,i,-l,o,i,l,-o,i,l,o,i,a,-s,n,a,s,n]),uvs:new Float32Array([0,0,0,1,.25,0,.25,1,.5,0,.5,1,.75,0,.75,1]),faces:new Uint16Array([0,1,2,1,3,2,2,3,4,3,5,4,4,5,6,5,7,6,6,7,0,7,1,0,0,2,4,0,4,6,1,5,3,1,7,5]),edges:new Uint16Array([0,1,2,3,4,5,6,7,0,2,2,4,4,6,6,0,1,3,3,5,5,7,7,1]),boundingRadius:Math.hypot(l,o)}}new Set(["OperatorCompareBoolean","OperatorCompareAbilityId","OperatorCompareBuffId","OperatorCompareDestructible","OperatorCompareDestructableCode","OperatorCompareButton","OperatorCompareGameDifficulty","OperatorCompareGameSpeed","OperatorCompareHeroSkill","OperatorCompareInteger","OperatorCompareItem","OperatorCompareItemType","OperatorCompareItemCode","OperatorCompareMouseButton","OperatorCompareMeleeDifficulty","OperatorCompareOrderCode","OperatorComparePlayer","OperatorComparePlayerColor","OperatorComparePlayerControl","OperatorComparePlayerSlotStatus","OperatorCompareRace","OperatorCompareReal","OperatorCompareString","OperatorCompareTechCode","OperatorCompareTerrainType","OperatorCompareTrigger","OperatorCompareUnit","OperatorCompareUnitCode","OperatorInt","OperatorReal"]),new Set(["EnumDestructablesInRectAllMultiple","EnumDestructablesInCircleBJMultiple","EnumItemsInRectBJMultiple","ForForceMultiple","ForGroupMultiple"]);const bb=qe(),wb=qe(),Ab=Ri(),yb=new Float32Array(1);function xb(t,e){let n=e.clientX-t.clientX,i=e.clientY-t.clientY;return Math.sqrt(n*n+i*i)}class Tb{constructor(t,e={}){this.scene=t,this.canvas=t.viewer.canvas,this.camera=t.camera,this.moveSpeed=e.moveSpeed||2,this.rotationSpeed=e.rotationSpeed||Math.PI/180,this.zoomFactor=e.zoomFactor||.1,this.horizontalAngle=e.horizontalAngle||Math.PI/2,this.verticalAngle=e.verticalAngle||Math.PI/4,this.distance=e.distance||500,this.position=e.position||qe(),this.target=e.target||qe(),this.twist=e.twist||0,this.mouse={buttons:[!1,!1,!1],x:0,y:0,x2:0,y2:0},this.touchMode=-1,this.touches=[],this.instance=null,this.onManualChange=e.onManualChange||null,this.fov=e.fov||Math.PI/4,this.nearClipPlane=e.nearClipPlane||1,this.farClipPlane=e.farClipPlane||2e5,this.update(),window.addEventListener("resize",(t=>this.onResize())),setTimeout((()=>this.onResize()),0),this.canvas.addEventListener("contextmenu",(t=>t.preventDefault())),this.canvas.addEventListener("selectstart",(t=>t.preventDefault())),this.canvas.addEventListener("mousedown",(t=>{t.preventDefault(),this.mouse.buttons[t.button]=!0})),document.addEventListener("mouseup",(t=>{t.preventDefault(),this.mouse.buttons[t.button]=!1})),window.addEventListener("mousemove",(t=>{this.mouse.x2=this.mouse.x,this.mouse.y2=this.mouse.y,this.mouse.x=t.clientX,this.mouse.y=t.clientY;let e=this.mouse.x-this.mouse.x2,n=this.mouse.y-this.mouse.y2;this.mouse.buttons[0]&&this.rotate(e,n),this.mouse.buttons[2]&&this.move(-e,n)})),this.canvas.addEventListener("wheel",(t=>{t.preventDefault();let e=t.deltaY;1===t.deltaMode&&(e=e/3*100),this.zoom(e/100)})),this.canvas.addEventListener("touchstart",(t=>{t.preventDefault();let e=t.targetTouches;1===e.length?this.touchMode=0:2==e.length?this.touchMode=1:this.touchMode=-1,this.touches.length=0,this.touches.push(...e)})),this.canvas.addEventListener("touchend",(t=>{t.preventDefault(),this.touchMode=-1})),this.canvas.addEventListener("touchcancel",(t=>{t.preventDefault(),this.touchMode=-1})),this.canvas.addEventListener("touchmove",(t=>{t.preventDefault();let e=t.targetTouches;if(0===this.touchMode){let t=this.touches[0],n=e[0],i=n.clientX-t.clientX,r=n.clientY-t.clientY;this.rotate(i,r)}else if(1===this.touchMode){let t=xb(this.touches[0],this.touches[1]),n=xb(e[0],e[1]);this.zoom((t-n)/50)}this.touches.length=0,this.touches.push(...e)}))}update(){if(this.instance){let t=this.instance,e=t.model.cameras[0];e.getTranslation(bb,t.sequence,t.frame,t.counter),Qe(bb,bb,e.position),e.getTargetTranslation(wb,t.sequence,t.frame,t.counter),Qe(wb,wb,e.targetPosition),e.getRotation(yb,t.sequence,t.frame,t.counter),this.twist=yb[0],xn(bb,bb,t.worldMatrix),xn(wb,wb,t.worldMatrix),this.moveToAndFace(bb,wb)}else this.updateInternalCamera()}move(t,e){let n=this.camera.directionX,i=this.camera.directionY,r=this.canvas.width,s=this.canvas.height,a=r/s,o=t/r*this.distance*a,l=e/s*this.distance;Qe(this.target,this.target,hn(bb,_n(bb,Je(bb,n[0],n[1],0)),o)),Qe(this.target,this.target,hn(bb,_n(bb,Je(bb,i[0],i[1],0)),l)),this.manualChange()}rotate(t,e){this.horizontalAngle-=t*this.rotationSpeed,this.verticalAngle-=e*this.rotationSpeed,this.manualChange()}zoom(t){this.distance=Math.max(1,this.distance*(1+t*this.zoomFactor)),this.manualChange()}manualChange(){this.updateInternalCamera(),this.instance&&(this.instance=null,this.onManualChange&&this.onManualChange())}onResize(){let t=Math.max(this.canvas.clientWidth,1),e=Math.max(this.canvas.clientHeight,1);this.canvas.width=t,this.canvas.height=e,this.scene.viewport[2]=t,this.scene.viewport[3]=e,this.camera.perspective(this.fov,t/e,this.nearClipPlane,this.farClipPlane)}moveToAndFace(t,e){Bn(bb,t,e);let n=$e(bb),i=Math.atan2(bb[1],bb[0]),r=Math.acos(bb[2]/n);Ze(this.target,e),this.verticalAngle=r,this.horizontalAngle=i+Math.PI/2,this.distance=n,this.updateInternalCamera()}updateInternalCamera(){this.verticalAngle=Math.min(Math.max(.01,this.verticalAngle),Math.PI-.01),Ii(Ab),Di(Ab,Ab,this.horizontalAngle),Pi(Ab,Ab,this.verticalAngle),Je(this.position,0,0,1),Ln(this.position,this.position,Ab),hn(this.position,this.position,this.distance),Qe(this.position,this.position,this.target);let t=this.twist-Math.PI/2;Je(bb,0,-Math.cos(t),-Math.sin(t)),this.camera.moveToAndFace(this.position,this.target,bb)}applyInstanceCamera(t){this.instance=t,this.fov=t.model.cameras[0].fieldOfView,this.onResize(),this.update()}}const Lb=ev.handlers;let Eb=document.getElementById("canvas");Eb.width=800,Eb.height=600;let Sb=new ev.ModelViewer(Eb),Mb=Sb.addScene();!function(t,e={}){new Tb(t,e)}(Mb),Sb.on("loadstart",(t=>console.log(t))),Sb.on("load",(t=>console.log("load",t))),Sb.on("loadend",(t=>console.log("loadend",t))),Sb.on("error",(t=>console.log("error",t))),Sb.addHandler(Lb.mdx),Sb.addHandler(Lb.blp),Sb.load("SmileyGW_004.mdx",(function(t){return"resources/"+t})).then((t=>{if(t){let e=t.addInstance();e.setScene(Mb),e.setSequence(1),e.setSequenceLoopMode(2);let n=t.addInstance();n.setScene(Mb),n.setSequence(0),n.setSequenceLoopMode(2),n.move([100,100,0]),n.uniformScale(.5);let i=t.addInstance();i.setScene(Mb),i.setSequence(2),i.setSequenceLoopMode(2),i.move([-100,-100,0])}})),function t(){requestAnimationFrame(t),Sb.updateAndRender()}()})()})();
//# sourceMappingURL=example.min.js.map